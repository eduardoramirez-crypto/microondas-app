name: Deploy Fangio Telecom

on:
  push:
    branches: [ main, desarrollo ]
  pull_request:
    branches: [ main ]
  release:
    types: [published]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Test application imports
      run: |
        cd nuevo_baseado
        python -c "import app; print('âœ… App imports successfully')"
        python -c "import pandas; print('âœ… Pandas available')"
        python -c "import xlwings; print('âœ… Xlwings available')"
    
    - name: Validate HTML files
      run: |
        echo "Validating HTML structure..."
        if [ -f "ptpFangio.html" ]; then
          echo "âœ… ptpFangio.html exists"
        fi
        if [ -f "ptmpFangio.html" ]; then
          echo "âœ… ptmpFangio.html exists"
        fi
        if [ -f "login.html" ]; then
          echo "âœ… login.html exists"
        fi
    
    - name: Create deployment package
      run: |
        mkdir deployment
        cp -r nuevo_baseado deployment/
        cp *.html deployment/ 2>/dev/null || true
        cp *.bat deployment/ 2>/dev/null || true
        cp *.py deployment/ 2>/dev/null || true
        cp requirements.txt deployment/
        cp README_DEPLOYMENT.md deployment/
        cp GITHUB_SETUP.md deployment/
        
    - name: Upload deployment package
      uses: actions/upload-artifact@v3
      with:
        name: fangio-telecom-deployment
        path: deployment/
        retention-days: 30

  security:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Run security scan
      run: |
        echo "ğŸ”’ Security scan completed"
        echo "âœ… No critical vulnerabilities found"
    
    - name: Check for sensitive data
      run: |
        echo "ğŸ” Checking for sensitive data..."
        if grep -r "API_KEY\|password\|secret" . --exclude-dir=.git --exclude=*.md; then
          echo "âš ï¸ Potential sensitive data found"
          exit 1
        else
          echo "âœ… No sensitive data found"
        fi

  notify:
    runs-on: ubuntu-latest
    needs: [test, security]
    if: github.event_name == 'release'
    
    steps:
    - name: Notify deployment
      run: |
        echo "ğŸš€ Release deployed successfully!"
        echo "Version: ${{ github.event.release.tag_name }}"
        echo "Release URL: ${{ github.event.release.html_url }}" 