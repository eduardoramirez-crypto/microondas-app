<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Llenado Autom√°tico de Plantilla</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { 
      background: #0a192f; 
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      background-repeat: no-repeat;
      color: #e0e7ef; 
      font-family: 'Montserrat', Arial, sans-serif; 
      margin: 0; 
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }

    /* Overlay para mejorar la legibilidad */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(10, 25, 47, 0.7);
      z-index: -1;
    }

    /* Estrellas animadas */
    body::after {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: 
        radial-gradient(2px 2px at 20px 30px, #eee, transparent),
        radial-gradient(2px 2px at 40px 70px, rgba(255,255,255,0.8), transparent),
        radial-gradient(1px 1px at 90px 40px, #fff, transparent),
        radial-gradient(1px 1px at 130px 80px, rgba(255,255,255,0.6), transparent),
        radial-gradient(2px 2px at 160px 30px, #ddd, transparent);
      background-repeat: repeat;
      background-size: 200px 100px;
      animation: sparkle 4s linear infinite;
      z-index: -2;
    }

    @keyframes sparkle {
      from { transform: translateY(0px); }
      to { transform: translateY(-100px); }
    }
    .main-content { 
      max-width: 600px; 
      margin: 40px auto; 
    }
    .glass-card { 
      background: rgba(22, 33, 62, 0.95); 
      border-radius: 20px; 
      box-shadow: 0 20px 40px rgba(0, 195, 255, 0.2); 
      padding: 40px 35px; 
      backdrop-filter: blur(15px);
      border: 2px solid rgba(0, 195, 255, 0.1);
      position: relative;
      overflow: hidden;
    }
    
    .glass-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(0, 195, 255, 0.05) 0%, transparent 50%);
      pointer-events: none;
    }
    .logo-header { 
      text-align: center; 
      margin-bottom: 30px; 
      position: relative;
      z-index: 1;
    }
    .logo-header img { 
      width: 120px; 
      height: auto;
      margin-bottom: 15px;
      filter: drop-shadow(0 4px 8px rgba(0, 195, 255, 0.3));
    }
    .logo-header h1 { 
      color: #00c3ff; 
      margin: 10px 0 0 0; 
      font-size: 2rem;
      font-weight: 700;
      text-shadow: 0 2px 10px rgba(0, 195, 255, 0.3);
      letter-spacing: 1px;
    }
    .logo-header p { 
      color: #b5c7e6; 
      margin: 5px 0 0 0; 
      font-size: 1.1rem;
      font-weight: 400;
      opacity: 0.9;
    }
    .dropzone { 
      background: rgba(35, 53, 84, 0.8); 
      border: 2px dashed rgba(0, 195, 255, 0.6); 
      border-radius: 15px; 
      padding: 28px 20px; 
      text-align: center; 
      margin-bottom: 20px; 
      cursor: pointer; 
      transition: all 0.3s ease; 
      backdrop-filter: blur(10px);
      position: relative;
      overflow: hidden;
      min-height: 120px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .dropzone.uploading {
      border-color: #ff6b6b;
      background: rgba(255, 107, 107, 0.2);
      transform: scale(1.02);
    }

    .dropzone.success {
      border-color: #00ff88;
      background: rgba(0, 255, 136, 0.2);
      animation: successPulse 0.6s ease-in-out;
    }

    .dropzone.error {
      border-color: #ff4757;
      background: rgba(255, 71, 87, 0.2);
      animation: errorShake 0.5s ease-in-out;
    }

    @keyframes successPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    @keyframes errorShake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }

    .dropzone:hover {
      border-color: #00e6ff;
      background: rgba(0, 195, 255, 0.15);
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(0, 195, 255, 0.3);
    }

    .dropzone.dragover {
      border-color: #00ff88;
      background: rgba(0, 255, 136, 0.25);
      transform: scale(1.05);
      box-shadow: 0 15px 35px rgba(0, 255, 136, 0.4);
    }
    
    .dropzone::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(0, 195, 255, 0.05) 0%, transparent 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .dropzone:hover {
      background: rgba(26, 35, 58, 0.9);
      border-color: rgba(0, 195, 255, 0.8);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 195, 255, 0.2);
    }
    
    .dropzone:hover::before {
      opacity: 1;
    }
    
    .dropzone.dragover { 
      background: rgba(26, 35, 58, 0.95);
      border-color: #00c3ff;
      transform: scale(1.02);
      box-shadow: 0 12px 35px rgba(0, 195, 255, 0.3);
    }
    
    .dropzone i { 
      font-size: 2.5rem; 
      color: #00c3ff; 
      margin-bottom: 12px; 
      display: block;
      transition: all 0.3s ease;
    }
    
    .dropzone:hover i {
      transform: scale(1.1);
      color: #ffffff;
    }
    .neon-btn { 
      background: linear-gradient(135deg, #00c3ff 0%, #0099cc 100%); 
      color: #ffffff; 
      border: none; 
      border-radius: 12px; 
      padding: 16px 24px; 
      width: 100%; 
      font-size: 1.1rem; 
      font-weight: 600; 
      cursor: pointer; 
      margin-top: 16px; 
      margin-bottom: 12px; 
      transition: all 0.3s ease; 
      box-shadow: 0 8px 25px rgba(0, 195, 255, 0.3);
      position: relative;
      overflow: hidden;
      font-family: 'Montserrat', Arial, sans-serif;
      letter-spacing: 0.5px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .neon-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }
    
    .neon-btn:hover { 
      background: linear-gradient(135deg, #0099cc 0%, #00c3ff 100%); 
      transform: translateY(-2px);
      box-shadow: 0 12px 35px rgba(0, 195, 255, 0.5);
    }
    
    .neon-btn:hover::before {
      left: 100%;
    }
    
    .neon-btn:active {
      transform: translateY(0);
      box-shadow: 0 6px 20px rgba(0, 195, 255, 0.4);
    }

    .neon-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      background: linear-gradient(135deg, #666 0%, #999 100%);
    }

    .neon-btn.uploading {
      background: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%);
      animation: pulse 1.5s infinite;
    }

    .neon-btn.success {
      background: linear-gradient(135deg, #00ff88 0%, #00e6cc 100%);
      animation: successPulse 0.6s ease-in-out;
    }

    .neon-btn.error {
      background: linear-gradient(135deg, #ff4757 0%, #ff6b6b 100%);
      animation: errorShake 0.5s ease-in-out;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    /* Estilos para botones con estados */
    .btn-text, .btn-loading {
      transition: all 0.3s ease;
    }

    .neon-btn.uploading .btn-text {
      opacity: 0;
      transform: translateY(-10px);
    }

    .neon-btn.uploading .btn-loading {
      opacity: 1;
      transform: translateY(0);
    }

    .btn-loading {
      opacity: 0;
      transform: translateY(10px);
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
    }

    /* Mejoras para dropzones */
    .dropzone .file-info {
      margin-top: 10px;
      padding: 10px;
      background: rgba(0, 195, 255, 0.1);
      border-radius: 8px;
      border-left: 3px solid #00c3ff;
    }

    .dropzone .preview-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
    }

    .preview-img {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }

    .preview-img:hover {
      transform: scale(1.1);
      border-color: #00c3ff;
      box-shadow: 0 5px 15px rgba(0, 195, 255, 0.3);
    }

    /* Indicador de progreso para archivos */
    .file-progress {
      width: 100%;
      height: 4px;
      background: rgba(0, 195, 255, 0.2);
      border-radius: 2px;
      margin-top: 8px;
      overflow: hidden;
    }

    .file-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #00c3ff, #00e6ff);
      border-radius: 2px;
      transition: width 0.3s ease;
      width: 0%;
    }

    .file-progress-bar.uploading {
      animation: progressPulse 1.5s infinite;
    }

    @keyframes progressPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    /* Mejoras para mensajes de estado */
    .dropzone-status {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      color: white;
      font-weight: bold;
    }

    .dropzone-status.ready {
      background: #00ff88;
    }

    .dropzone-status.uploading {
      background: #ff6b6b;
      animation: pulse 1s infinite;
    }

    .dropzone-status.success {
      background: #00ff88;
    }

    .dropzone-status.error {
      background: #ff4757;
    }
    .form-step { 
      display: none; 
    }
    .form-step.active { 
      display: block; 
    }
    
    /* Botones secundarios (Anterior) */
    .btn-secondary {
      background: rgba(0, 195, 255, 0.1);
      color: #00c3ff;
      border: 2px solid rgba(0, 195, 255, 0.3);
      border-radius: 12px;
      padding: 16px 24px;
      width: 100%;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      margin-top: 16px;
      margin-bottom: 12px;
      transition: all 0.3s ease;
      font-family: 'Montserrat', Arial, sans-serif;
      letter-spacing: 0.5px;
      text-decoration: none;
      display: inline-block;
      text-align: center;
    }
    
    .btn-secondary:hover {
      background: rgba(0, 195, 255, 0.2);
      border-color: rgba(0, 195, 255, 0.5);
      transform: translateY(-2px);
      color: #00c3ff;
      text-decoration: none;
    }
    
    .btn-secondary:active {
      transform: translateY(0);
    }
    
    /* Contenedor para botones m√∫ltiples */
    .button-container {
      display: flex;
      gap: 16px;
      margin-top: 16px;
    }
    
    .button-container .neon-btn,
    .button-container .btn-secondary {
      flex: 1;
      margin: 0;
    }
    .file-info { 
      color: #7b8794; 
      font-size: 1rem; 
      margin-bottom: 8px; 
    }
    .preview-list { 
      display: flex; 
      flex-wrap: wrap; 
      gap: 8px; 
      margin-top: 8px; 
    }
    .preview-img { 
      width: 48px; 
      height: 48px; 
      object-fit: cover; 
      border-radius: 8px; 
      border: 1px solid #00c3ff44; 
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .preview-img:hover {
      transform: scale(1.2);
      border-color: #00c3ff;
      box-shadow: 0 4px 15px rgba(0, 195, 255, 0.4);
      z-index: 10;
    }
    
    /* Modal de previsualizaci√≥n */
    .preview-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      backdrop-filter: blur(5px);
    }
    
    .preview-modal.active {
      display: flex;
    }
    
    .preview-modal-content {
      background: rgba(22, 33, 62, 0.95);
      border-radius: 15px;
      padding: 20px;
      max-width: 90%;
      max-height: 90%;
      position: relative;
      border: 2px solid rgba(0, 195, 255, 0.3);
      box-shadow: 0 20px 40px rgba(0, 195, 255, 0.3);
    }
    
    .preview-modal-close {
      position: absolute;
      top: -15px;
      right: -15px;
      background: #ff4757;
      color: white;
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      cursor: pointer;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }
    
    .preview-modal-close:hover {
      background: #ff3742;
      transform: scale(1.1);
    }
    
    .preview-modal img {
      max-width: 100%;
      max-height: 70vh;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }
    
    .preview-modal .file-info {
      margin-top: 15px;
      text-align: center;
      color: #e0e7ef;
    }
    
    .preview-modal .file-name {
      font-weight: 600;
      color: #00c3ff;
      margin-bottom: 5px;
    }
    
    .preview-modal .file-size {
      font-size: 0.9rem;
      color: #8892b0;
    }
    
    /* Tooltip de previsualizaci√≥n */
    .preview-tooltip {
      position: absolute;
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.8rem;
      pointer-events: none;
      z-index: 100;
      opacity: 0;
      transition: opacity 0.3s ease;
      white-space: nowrap;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .preview-tooltip.show {
      opacity: 1;
    }
    .success-box {
      background: #e6fff2;
      border: 2px solid #00c37a;
      color: #008c4a;
      font-weight: 700;
      padding: 10px 0 10px 0;
      margin-bottom: 14px;
      border-radius: 10px;
      box-shadow: 0 2px 12px #00c3ff22;
      width: 100%;
      text-align: center;
      font-size: 1.08rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-top: 24px;
    }
    .success-box i {
      color: #00c37a;
      font-size: 1.2em;
      margin-right: 6px;
    }

    
    /* Estilos para mensajes */
    .message {
      font-family: 'Montserrat', Arial, sans-serif;
      font-weight: 500;
    }
    
    .message-content {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .message-content i {
      font-size: 1.2em;
    }
    
    /* Estilos para botones */
    .neon-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .neon-btn:disabled:hover {
      transform: none;
      box-shadow: 0 8px 25px rgba(14, 165, 233, 0.3);
    }
  </style>
</head>
<body>
  <!-- Encabezado eliminado para un dise√±o m√°s limpio -->
  <div class="main-content">
    <div class="glass-card">
      <div class="logo-header">
        <img src="/static/images/fangio-logo.svg" alt="FANGIO TELECOM" style="width: 120px; height: auto; margin-bottom: 15px;">
        <h1>FANGIO TELECOM</h1>
        <p>Base de datos de Enlaces PtP</p>
      </div>
      <!-- MENSAJE_PLANTILLA_AQUI -->
      <div id="formContainer">
        <!-- ANALISIS_AQUI -->
        <form id="autoForm" action="/procesar" method="post" enctype="multipart/form-data" autocomplete="off">
          <input type="hidden" name="template_path" value="static/plantillas/llenadoauto.xlsx">
          <input type="hidden" name="tipo" value="site_survey">
          <!-- El paso 1 de ID ha sido eliminado para mostrar solo el mensaje de plantilla cargada -->

          <!-- Paso Site Survey: Checkboxes din√°micos -->
          <div class="form-step" id="stepSiteSurveyCheckboxes">
            <h2 style="text-align:center; color:#00c3ff;">Checklist Site Survey</h2>
            <div style="margin-bottom:10px;">
              <input type="checkbox" id="chk_urbana" name="chk_urbana" value="1" {% if chk_urbana %}checked{% endif %}>
              <label for="chk_urbana">Zona urbana</label>
            </div>
            <div style="margin-bottom:10px;">
              <input type="checkbox" id="chk_suburbana" name="chk_suburbana" value="1" {% if chk_suburbana %}checked{% endif %}>
              <label for="chk_suburbana">Zona suburbana</label>
            </div>
            <div style="margin-bottom:10px;">
              <input type="checkbox" id="chk_rural" name="chk_rural" value="1" {% if chk_rural %}checked{% endif %}>
              <label for="chk_rural">Zona rural</label>
            </div>
            <div style="margin-bottom:10px;">
              <input type="checkbox" id="chk_ejidal" name="chk_ejidal" value="1" {% if chk_ejidal %}checked{% endif %}>
              <label for="chk_ejidal">Zona ejidal</label>
            </div>
            <div style="margin-bottom:10px;">
              <input type="checkbox" id="chk_pueblo_magico" name="chk_pueblo_magico" value="1" {% if chk_pueblo_magico %}checked{% endif %}>
              <label for="chk_pueblo_magico">Pueblo m√°gico</label>
            </div>
          </div>

          <!-- Paso 2: PDFs y el√©ctricas -->
          <div class="form-step" id="step2">
            <h2 style="text-align:center; color:#00c3ff;">Sube los archivos PDF y las im√°genes el√©ctricas</h2>
            <div class="dropzone" id="pdfDrop">
              <i class="fa-solid fa-file-pdf"></i>
              Arrastra o selecciona los PDF de la hoja 4. Estudio de informaci√≥n A
              <input type="file" name="pdf_file" accept="application/pdf" multiple style="display:none">
            </div>
            <div class="file-info" id="pdfInfo"></div>
            <div class="dropzone" id="imgElectricasDrop">
              <i class="fa-solid fa-bolt"></i>
              Sube las im√°genes el√©ctricas para la hoja 4. Estudio de informaci√≥n A (m√°x 6)
              <input type="file" name="imagenes_electricas" accept="image/*" multiple style="display:none">
            </div>
            <div class="preview-list" id="imgElectricasPreview"></div>
            <button type="button" class="neon-btn" onclick="nextStep(3)">Siguiente</button>
          </div>

          <!-- Paso 3: Word, KMZ, imagen KML, Excel B, imagen B -->
          <div class="form-step" id="step3">
            <h2 style="text-align:center; color:#00c3ff;">Sube Word, KMZ, imagen KML y archivos para hoja 5</h2>
            <div class="dropzone" id="wordDrop">
              <i class="fa-solid fa-file-word"></i>
              Selecciona el archivo Word para hoja 1. Analisis de Red y Frecuencia
              <input type="file" name="word_file" accept=".docx" style="display:none" required>
            </div>
            <div class="file-info" id="wordInfo"></div>
            <div class="dropzone" id="kmzDrop">
              <i class="fa-solid fa-file-archive"></i>
              Selecciona o arrastra el archivo KMZ aqu√≠ de la hoja 3. Formato KMZ
              <input type="file" name="kmz" accept=".kmz" style="display:none">
            </div>
            <div class="file-info" id="kmzInfo"></div>
            <div class="dropzone" id="kmlImgDrop">
              <i class="fa-solid fa-image"></i>
              Colocar mapa de KMZ (selecciona o arrastra la imagen) de la hoja 3. Formato KMZ
              <input type="file" name="imagen_kmz" accept="image/*" style="display:none">
            </div>
            <div class="preview-list" id="kmlImgPreview"></div>
            <div class="dropzone" id="imgB5Drop">
              <i class="fa-solid fa-image"></i>
              Imagen para hoja 5. Estudio de informaci√≥n B
              <input type="file" name="imagen_b" accept="image/*" style="display:none">
            </div>
            <div class="preview-list" id="imgB5Preview"></div>
            <div class="dropzone" id="excelB5Drop">
              <i class="fa-solid fa-file-excel"></i>
              Archivo Excel para 5. Estudio de informaci√≥n B
              <input type="file" name="archivo_excel_b" accept=".xls,.xlsx" style="display:none">
            </div>
            <div class="file-info" id="excelB5Info"></div>
            <button type="button" class="neon-btn" onclick="prevStep(2)">Anterior</button>
            <button type="button" class="neon-btn" onclick="nextStep(4)">Siguiente</button>
          </div>

          <!-- Paso 4: Im√°genes el√©ctricas adicionales -->
          <div class="form-step" id="step4">
            <h2 style="text-align:center; color:#00c3ff;">Sube im√°genes el√©ctricas adicionales</h2>
            <div class="dropzone" id="imgConsumoDrop">
              <i class="fa-solid fa-image"></i>
              Especificaciones de consumo (C14:D20)
              <input type="file" name="img_consumo" accept="image/*" style="display:none" required>
            </div>
            <div class="file-info" id="imgConsumoInfo"></div>
            <div class="dropzone" id="imgConfiguracionDrop">
              <i class="fa-solid fa-image"></i>
              Configuraci√≥n, modelo de radio y antena (E14:G20)
              <input type="file" name="img_configuracion" accept="image/*" style="display:none" required>
            </div>
            <div class="file-info" id="imgConfiguracionInfo"></div>
            <div class="dropzone" id="imgLineaVistaDrop">
              <i class="fa-solid fa-image"></i>
              L√≠nea de vista (B39:G55)
              <input type="file" name="img_linea_vista" accept="image/*" style="display:none" required>
            </div>
            <div class="file-info" id="imgLineaVistaInfo"></div>
            <button type="button" class="neon-btn" onclick="prevStep(3)">Anterior</button>
            <button type="button" class="neon-btn" onclick="nextStep(5)">Siguiente</button>
          </div>

          <!-- Paso 4.1: Im√°genes para Planos A y B -->
          <div class="form-step" id="step4_1">
            <h2 style="text-align:center; color:#00c3ff;">Sube im√°genes para Planos A y B</h2>
            <div style="margin-bottom:18px;">
              <h3 style="color:#00c3ff;">4. Planos A</h3>
              <div class="dropzone" id="planosADrop1">
                <i class="fa-solid fa-image"></i>
                Imagen 1 (C17:AK60)
                <input type="file" name="planos_a_img1" accept="image/*" style="display:none">
              </div>
              <div class="dropzone" id="planosADrop2">
                <i class="fa-solid fa-image"></i>
                Imagen 2 (C69:AK123)
                <input type="file" name="planos_a_img2" accept="image/*" style="display:none">
              </div>
              <div class="dropzone" id="planosADrop3">
                <i class="fa-solid fa-image"></i>
                Imagen 3 (C134:AK173)
                <input type="file" name="planos_a_img3" accept="image/*" style="display:none">
              </div>
              <div class="dropzone" id="planosADrop4">
                <i class="fa-solid fa-image"></i>
                Imagen 4 (C180:AK226)
                <input type="file" name="planos_a_img4" accept="image/*" style="display:none">
              </div>
              <div class="dropzone" id="planosADrop5">
                <i class="fa-solid fa-image"></i>
                Imagen 5 (C235:AK281)
                <input type="file" name="planos_a_img5" accept="image/*" style="display:none">
              </div>
              <div class="dropzone" id="planosADrop6">
                <i class="fa-solid fa-image"></i>
                Imagen 6 (C290:AK336)
                <input type="file" name="planos_a_img6" accept="image/*" style="display:none">
              </div>
            </div>
            <div style="margin-bottom:18px;">
              <h3 style="color:#00c3ff;">5. Planos B</h3>
              <div class="dropzone" id="planosBDrop1">
                <i class="fa-solid fa-image"></i>
                Imagen 1 (C17:AK60)
                <input type="file" name="planos_b_img1" accept="image/*" style="display:none">
              </div>
              <div class="dropzone" id="planosBDrop2">
                <i class="fa-solid fa-image"></i>
                Imagen 2 (C69:AK123)
                <input type="file" name="planos_b_img2" accept="image/*" style="display:none">
              </div>
              <div class="dropzone" id="planosBDrop3">
                <i class="fa-solid fa-image"></i>
                Imagen 3 (C134:AK173)
                <input type="file" name="planos_b_img3" accept="image/*" style="display:none">
              </div>
            </div>
            <button type="button" class="neon-btn" onclick="prevStep('4_1')">Anterior</button>
            <button type="button" class="neon-btn" onclick="nextStep(5)">Siguiente</button>
          </div>

          <!-- Paso 5: Im√°genes de torres para hoja 6 (A) -->
          <div class="form-step" id="step5">
            <h2 style="text-align:center; color:#00c3ff;">Sube im√°genes de torres para hoja 6 (A)</h2>
            <div class="dropzone" id="imgTorresDrop">
              <i class="fa-solid fa-broadcast-tower"></i>
              Sube las im√°genes de torres para la hoja 6. Estudio torres y antenas A (m√°x 3)
              <input type="file" name="imagenes_torres" accept="image/*" multiple style="display:none">
            </div>
            <div class="preview-list" id="imgTorresPreview"></div>
            <button type="button" class="neon-btn" onclick="prevStep(4)">Anterior</button>
            <button type="button" class="neon-btn" onclick="nextStep(6)">Siguiente</button>
          </div>

          <!-- Paso 6: Im√°genes de torres para hoja 7 (B) -->
          <div class="form-step" id="step6">
            <h2 style="text-align:center; color:#00c3ff;">Sube im√°genes de torres para hoja 7 (B)</h2>
            <div class="dropzone" id="imgTorresBDrop">
              <i class="fa-solid fa-broadcast-tower"></i>
              Sube las im√°genes de torres para la hoja 7. Estudio torres y antenas B (m√°x 3)
              <input type="file" name="imagenes_torres_b" accept="image/*" multiple style="display:none">
            </div>
            <div class="preview-list" id="imgTorresBPreview"></div>
            <button type="button" class="neon-btn" onclick="prevStep(5)">Anterior</button>
            <button type="button" class="neon-btn" onclick="nextStep(7)">Siguiente</button>
          </div>

          <!-- Paso 7: Fotos A (reporte de fotos A) -->
          <div class="form-step" id="step7">
            <h2 style="text-align:center; color:#00c3ff;">Sube las im√°genes para el reporte de fotos A</h2>
            <div class="dropzone" style="cursor:default;">
              <i class="fa-solid fa-images"></i>
              <div style="font-size:1.1rem;font-weight:700;margin-bottom:10px;">Sube las im√°genes para el reporte de fotos A (una por cada casilla)</div>
              <div style="font-size:13px;color:#7b8794;margin-bottom:18px;">Si no subes alguna imagen, se colocar√° un N/A por defecto.</div>
              <div id="fotos9Inputs" style="flex:1 1 0;display:flex;flex-direction:column;gap:10px;"></div>
            </div>
            <button type="button" class="neon-btn" onclick="prevStep(6)">Anterior</button>
            <button type="button" class="neon-btn" onclick="nextStep(8)">Siguiente</button>
          </div>

          <!-- Paso 8: Fotos B (reporte de fotos B) -->
          <div class="form-step" id="step8">
            <h2 style="text-align:center; color:#00c3ff;">Sube las im√°genes para el reporte de fotos B</h2>
            <div class="dropzone" style="cursor:default;">
              <i class="fa-solid fa-images"></i>
              <div style="font-size:1.1rem;font-weight:700;margin-bottom:10px;">Sube las im√°genes para el reporte de fotos B (una por cada casilla)</div>
              <div style="font-size:13px;color:#7b8794;margin-bottom:18px;">Si no subes alguna imagen, se colocar√° un N/A por defecto.</div>
              <div id="fotos10Inputs" style="display:flex;flex-direction:column;gap:10px;"></div>
            </div>
            <button type="button" class="neon-btn" onclick="prevStep(7)">Anterior</button>
                      <button class="neon-btn" type="submit" id="submitBtn">
                        <i class="fa-solid fa-cloud-upload-alt"></i> 
                        <span class="btn-text">Subir y Llenar</span>
                        <span class="btn-loading" style="display: none;">
                          <i class="fas fa-spinner fa-spin"></i> Procesando...
                        </span>
                      </button>
          <button class="neon-btn" type="button" id="guardarBtn" style="display:none; background: #059669;">
            <i class="fa-solid fa-save"></i> Guardar archivo
          </button>
          </div>
        </form>
      </div>
    </div>
    <div class="success-box">
        <i class="fa-solid fa-file-excel"></i> Plantilla de llenado cargada correctamente
    </div>
  </div>
  <script>
    // L√≥gica de pasos
    function showStep(step) {
      document.querySelectorAll('.form-step').forEach((el) => {
        el.classList.remove('active');
      });
      const stepElement = document.getElementById('step' + step);
      if (stepElement) {
        stepElement.classList.add('active');
      }
    }
    
    function nextStep(step) { 
      showStep(step); 
    }
    
    function prevStep(step) { 
      showStep(step); 
    }
    
    // Drag & Drop y previews
    function setupDropzone(dropId, inputName, infoId, previewId, isImage=false) {
      const drop = document.getElementById(dropId);
      if (!drop) return;
      
      const input = drop.querySelector('input[type="file"]');
      const info = infoId ? document.getElementById(infoId) : null;
      const preview = previewId ? document.getElementById(previewId) : null;
      
      drop.addEventListener('click', (e) => { 
        if (e.target === drop) input.click(); 
      });
      
      drop.addEventListener('dragover', e => { 
        e.preventDefault(); 
        drop.classList.add('dragover'); 
      });
      
      drop.addEventListener('dragleave', e => { 
        e.preventDefault(); 
        drop.classList.remove('dragover'); 
      });
      
      drop.addEventListener('drop', e => { 
        e.preventDefault(); 
        drop.classList.remove('dragover'); 
        input.files = e.dataTransfer.files; 
        input.dispatchEvent(new Event('change')); 
      });
      
      input.addEventListener('change', () => {
        // Agregar estado de √©xito al dropzone
        drop.classList.add('success');
        setTimeout(() => drop.classList.remove('success'), 2000);
        
        if (info) {
          if (input.files.length === 0) { 
            info.textContent = ''; 
          } else if (input.files.length === 1) { 
            const file = input.files[0];
            const fileSize = (file.size / 1024 / 1024).toFixed(2);
            info.innerHTML = `
              <div style="display: flex; align-items: center; gap: 10px; margin: 10px 0;">
                <i class="fas fa-check-circle" style="color: #00ff88; font-size: 1.2rem;"></i>
                <div>
                  <span style="cursor: pointer; color: #00c3ff; text-decoration: underline; font-weight: 600;" 
                        onmouseover="this.style.color='#ffffff'" 
                        onmouseout="this.style.color='#00c3ff'"
                        onclick="showPreview('${file.name}', '${file.name}')">
                    ${file.name}
                  </span>
                  <br><small style="color: #8892b0;">Tama√±o: ${fileSize} MB ‚Ä¢ Clic para previsualizar</small>
                </div>
                <button onclick="removeFile('${dropId}', '${inputName}')" 
                        style="background: #ff4757; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 0.8rem;">
                  √ó
                </button>
              </div>
            `;
          } else { 
            const totalSize = Array.from(input.files).reduce((acc, file) => acc + file.size, 0);
            const totalSizeMB = (totalSize / 1024 / 1024).toFixed(2);
            info.innerHTML = `
              <div style="display: flex; align-items: center; gap: 10px; margin: 10px 0;">
                <i class="fas fa-check-circle" style="color: #00ff88; font-size: 1.2rem;"></i>
                <div>
                  <span style="color: #00c3ff; font-weight: 600;">
                    ${input.files.length} archivos seleccionados
                  </span>
                  <br><small style="color: #8892b0;">Tama√±o total: ${totalSizeMB} MB</small>
                </div>
                <button onclick="removeFile('${dropId}', '${inputName}')" 
                        style="background: #ff4757; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 0.8rem;">
                  √ó
                </button>
              </div>
            `;
          }
        }
        
        if (preview) {
          preview.innerHTML = '';
          Array.from(input.files).forEach(file => {
            if (isImage && file.type.startsWith('image/')) {
              const img = document.createElement('img');
              img.className = 'preview-img';
              img.src = URL.createObjectURL(file);
              img.dataset.fileName = file.name;
              img.dataset.fileSize = file.size;
              img.dataset.fileType = file.type;
              
              // Agregar evento de clic para previsualizaci√≥n
              img.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                showPreview(file, file.name);
              });
              
              // Tooltip al hacer hover
              img.addEventListener('mouseenter', (e) => {
                const tooltip = document.createElement('div');
                tooltip.className = 'preview-tooltip';
                tooltip.textContent = 'Clic para previsualizar';
                tooltip.style.left = e.pageX + 10 + 'px';
                tooltip.style.top = e.pageY - 30 + 'px';
                document.body.appendChild(tooltip);
                
                setTimeout(() => tooltip.classList.add('show'), 100);
                
                img.addEventListener('mouseleave', () => {
                  tooltip.remove();
                }, { once: true });
              });
              
              preview.appendChild(img);
            }
          });
        }
      });
    }

    // Funci√≥n para remover archivos
    function removeFile(dropId, inputName) {
      const drop = document.getElementById(dropId);
      const input = drop.querySelector('input[type="file"]');
      const info = drop.parentNode.querySelector('.file-info');
      
      // Limpiar archivos
      input.value = '';
      
      // Limpiar informaci√≥n
      if (info) {
        info.innerHTML = '';
      }
      
      // Agregar estado de error temporal
      drop.classList.add('error');
      setTimeout(() => drop.classList.remove('error'), 1500);
      
      // Limpiar previews si existen
      const preview = drop.parentNode.querySelector('.preview-list');
      if (preview) {
        preview.innerHTML = '';
      }
      
      console.log(`Archivo removido de ${dropId}`);
    }

    // Funci√≥n para validar archivos
    function validateFile(file, allowedTypes, maxSize = 10) {
      const maxSizeMB = maxSize * 1024 * 1024; // Convertir a bytes
      
      if (file.size > maxSizeMB) {
        return {
          valid: false,
          error: `El archivo es demasiado grande. M√°ximo ${maxSize} MB permitido.`
        };
      }
      
      if (allowedTypes && !allowedTypes.some(type => file.type.includes(type))) {
        return {
          valid: false,
          error: `Tipo de archivo no permitido. Tipos v√°lidos: ${allowedTypes.join(', ')}`
        };
      }
      
      return { valid: true };
    }
    
    // Campos para fotos A y B
    const fotos9Campos = [
      { label: 'GPS con coordenadas de la torre', name: 'foto_a_1' },
      { label: 'Foto del sitio', name: 'foto_a_2' },
      { label: 'Foto del equipo', name: 'foto_a_3' },
      { label: 'Foto de la antena', name: 'foto_a_4' },
      { label: 'Foto de la instalaci√≥n', name: 'foto_a_5' },
      { label: 'Foto del cableado', name: 'foto_a_6' },
      { label: 'Foto del panel solar', name: 'foto_a_7' },
      { label: 'Foto del gabinete', name: 'foto_a_8' },
      { label: 'Foto general del sitio', name: 'foto_a_9' }
    ];
    
    const fotos10Campos = [
      { label: 'GPS con coordenadas de la torre', name: 'foto_b_1' },
      { label: 'Foto del sitio', name: 'foto_b_2' },
      { label: 'Foto del equipo', name: 'foto_b_3' },
      { label: 'Foto de la antena', name: 'foto_b_4' },
      { label: 'Foto de la instalaci√≥n', name: 'foto_b_5' },
      { label: 'Foto del cableado', name: 'foto_b_6' },
      { label: 'Foto del panel solar', name: 'foto_b_7' },
      { label: 'Foto del gabinete', name: 'foto_b_8' },
      { label: 'Foto de la configuraci√≥n', name: 'foto_b_9' },
      { label: 'Foto de Agregador (Site Entry)', name: 'foto_b_10' }
    ];
    
    window.addEventListener('DOMContentLoaded', function() {
      // Generar inputs para fotos A
      const fotos9InputsDiv = document.getElementById('fotos9Inputs');
      if (fotos9InputsDiv) {
        fotos9InputsDiv.innerHTML = '';
        fotos9Campos.forEach(campo => {
          const item = document.createElement('div');
          item.style.display = 'flex';
          item.style.alignItems = 'center';
          item.style.marginBottom = '10px';
          item.style.gap = '10px';
          
          const label = document.createElement('span');
          label.textContent = campo.label;
          label.style.flex = '1';
          label.style.fontSize = '1rem';
          label.style.color = '#b5c7e6';
          label.style.textAlign = 'left';
          
          const input = document.createElement('input');
          input.type = 'file';
          input.name = campo.name;
          input.accept = 'image/*';
          input.style.display = 'none';
          
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'neon-btn';
          btn.style.width = 'auto';
          btn.style.padding = '7px 14px';
          btn.style.fontSize = '1rem';
          btn.textContent = 'Seleccionar imagen';
          
          const preview = document.createElement('span');
          preview.className = 'preview-list';
          
          btn.onclick = () => input.click();
          input.onchange = () => {
            preview.innerHTML = '';
            if (input.files.length > 0) {
              const img = document.createElement('img');
              img.className = 'preview-img';
              img.style.width = '38px';
              img.style.height = '38px';
              img.src = URL.createObjectURL(input.files[0]);
              preview.appendChild(img);
            }
          };
          
          item.appendChild(label);
          item.appendChild(input);
          item.appendChild(btn);
          item.appendChild(preview);
          fotos9InputsDiv.appendChild(item);
        });
      }
      
      // Generar inputs para fotos B
      const fotos10InputsDiv = document.getElementById('fotos10Inputs');
      if (fotos10InputsDiv) {
        fotos10InputsDiv.innerHTML = '';
        fotos10Campos.forEach(campo => {
          const item = document.createElement('div');
          item.style.display = 'flex';
          item.style.alignItems = 'center';
          item.style.marginBottom = '10px';
          item.style.gap = '10px';
          
          const label = document.createElement('span');
          label.textContent = campo.label;
          label.style.flex = '1';
          label.style.fontSize = '1rem';
          label.style.color = '#b5c7e6';
          label.style.textAlign = 'left';
          
          const input = document.createElement('input');
          input.type = 'file';
          input.name = campo.name;
          input.accept = 'image/*';
          input.style.display = 'none';
          
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'neon-btn';
          btn.style.width = 'auto';
          btn.style.padding = '7px 14px';
          btn.style.fontSize = '1rem';
          btn.textContent = 'Seleccionar imagen';
          
          const preview = document.createElement('span');
          preview.className = 'preview-list';
          
          btn.onclick = () => input.click();
          input.onchange = () => {
            preview.innerHTML = '';
            if (input.files.length > 0) {
              const img = document.createElement('img');
              img.className = 'preview-img';
              img.style.width = '38px';
              img.style.height = '38px';
              img.src = URL.createObjectURL(input.files[0]);
              preview.appendChild(img);
            }
          };
          
          item.appendChild(label);
          item.appendChild(input);
          item.appendChild(btn);
          item.appendChild(preview);
          fotos10InputsDiv.appendChild(item);
        });
      }
      
      // Configurar dropzones
      setupDropzone('wordDrop', 'word_file', 'wordInfo');
      setupDropzone('pdfDrop', 'pdf_file', 'pdfInfo', null, false);
      setupDropzone('kmzDrop', 'kmz', 'kmzInfo');
      setupDropzone('kmlImgDrop', 'imagen_kmz', null, 'kmlImgPreview', true);
      setupDropzone('imgB5Drop', 'imagen_b', null, 'imgB5Preview', true);
      setupDropzone('excelB5Drop', 'archivo_excel_b', 'excelB5Info');
      setupDropzone('imgElectricasDrop', 'imagenes_electricas', null, 'imgElectricasPreview', true);
      setupDropzone('imgConsumoDrop', 'img_consumo', 'imgConsumoInfo');
      setupDropzone('imgConfiguracionDrop', 'img_configuracion', 'imgConfiguracionInfo');
      setupDropzone('imgLineaVistaDrop', 'img_linea_vista', 'imgLineaVistaInfo');
      setupDropzone('imgTorresDrop', 'imagenes_torres', null, 'imgTorresPreview', true);
      setupDropzone('imgTorresBDrop', 'imagenes_torres_b', null, 'imgTorresBPreview', true);
      
      // Configurar dropzones para Planos A y B
      setupDropzone('planosADrop1', 'planos_a_img1', null, null, true);
      setupDropzone('planosADrop2', 'planos_a_img2', null, null, true);
      setupDropzone('planosADrop3', 'planos_a_img3', null, null, true);
      setupDropzone('planosADrop4', 'planos_a_img4', null, null, true);
      setupDropzone('planosADrop5', 'planos_a_img5', null, null, true);
      setupDropzone('planosADrop6', 'planos_a_img6', null, null, true);
      setupDropzone('planosBDrop1', 'planos_b_img1', null, null, true);
      setupDropzone('planosBDrop2', 'planos_b_img2', null, null, true);
      setupDropzone('planosBDrop3', 'planos_b_img3', null, null, true);
      
      // Mostrar el primer paso al cargar
      showStep(2);
      
      // Cargar imagen de fondo de la Tierra
      const backgroundImage = new Image();
      backgroundImage.onload = function() {
        document.body.style.backgroundImage = 'url("/static/images/earth-background.jpg")';
        console.log('Imagen de fondo cargada correctamente');
      };
      backgroundImage.onerror = function() {
        console.log('Error cargando imagen de fondo, usando fallback');
        document.body.style.backgroundImage = 'url("/static/images/earth-background.jpg")';
      };
      backgroundImage.src = "/static/images/earth-background.jpg";
    });
    
    // Funcionalidad de previsualizaci√≥n
    function createPreviewModal() {
      const modal = document.createElement('div');
      modal.className = 'preview-modal';
      modal.innerHTML = `
        <div class="preview-modal-content">
          <button class="preview-modal-close">&times;</button>
          <div class="preview-content"></div>
          <div class="file-info">
            <div class="file-name"></div>
            <div class="file-size"></div>
          </div>
        </div>
      `;
      
      // Cerrar modal
      modal.querySelector('.preview-modal-close').addEventListener('click', () => {
        modal.classList.remove('active');
      });
      
      // Cerrar al hacer clic fuera del contenido
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.classList.remove('active');
        }
      });
      
      // Cerrar con ESC
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.classList.contains('active')) {
          modal.classList.remove('active');
        }
      });
      
      document.body.appendChild(modal);
      return modal;
    }
    
    // Crear modal global
    const previewModal = createPreviewModal();
    
    // Funci√≥n para mostrar previsualizaci√≥n
    function showPreview(file, fileName) {
      const content = previewModal.querySelector('.preview-content');
      const nameElement = previewModal.querySelector('.file-name');
      const sizeElement = previewModal.querySelector('.file-size');
      
      // Si file es un string (nombre del archivo), buscar el archivo real
      let actualFile = file;
      if (typeof file === 'string') {
        // Buscar el archivo en todos los inputs
        const inputs = document.querySelectorAll('input[type="file"]');
        for (let input of inputs) {
          if (input.files && input.files.length > 0) {
            for (let f of input.files) {
              if (f.name === file) {
                actualFile = f;
                break;
              }
            }
          }
        }
      }
      
      nameElement.textContent = fileName;
      sizeElement.textContent = actualFile && actualFile.size ? formatFileSize(actualFile.size) : '';
      
      content.innerHTML = '';
      
      if (actualFile && actualFile.type && actualFile.type.startsWith('image/')) {
        const img = document.createElement('img');
        img.src = URL.createObjectURL(actualFile);
        content.appendChild(img);
      } else if (actualFile && actualFile.type === 'application/pdf') {
        const pdfViewer = document.createElement('iframe');
        pdfViewer.src = URL.createObjectURL(actualFile);
        pdfViewer.style.width = '100%';
        pdfViewer.style.height = '70vh';
        pdfViewer.style.border = 'none';
        content.appendChild(pdfViewer);
      } else {
        const icon = document.createElement('div');
        icon.innerHTML = `<i class="fas fa-file" style="font-size: 4rem; color: #00c3ff;"></i>`;
        icon.style.textAlign = 'center';
        icon.style.padding = '40px';
        content.appendChild(icon);
      }
      
      previewModal.classList.add('active');
    }
    
    // Funci√≥n para formatear tama√±o de archivo
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    // Agregar eventos de previsualizaci√≥n a las im√°genes existentes
    function addPreviewEvents() {
      const previewImages = document.querySelectorAll('.preview-img');
      previewImages.forEach(img => {
        img.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          
          // Obtener el archivo del input asociado
          const input = img.closest('.preview-list').previousElementSibling;
          if (input && input.files && input.files[0]) {
            showPreview(input.files[0], input.files[0].name);
          }
        });
        
        // Tooltip al hacer hover
        img.addEventListener('mouseenter', (e) => {
          const tooltip = document.createElement('div');
          tooltip.className = 'preview-tooltip';
          tooltip.textContent = 'Clic para previsualizar';
          tooltip.style.left = e.pageX + 10 + 'px';
          tooltip.style.top = e.pageY - 30 + 'px';
          document.body.appendChild(tooltip);
          
          setTimeout(() => tooltip.classList.add('show'), 100);
          
          img.addEventListener('mouseleave', () => {
            tooltip.remove();
          }, { once: true });
        });
      });
    }
    
    // Modificar la funci√≥n setupDropzone para incluir previsualizaci√≥n
    const originalSetupDropzone = window.setupDropzone;
    window.setupDropzone = function(dropzoneId, inputName, infoId, previewId, isMultiple) {
      originalSetupDropzone(dropzoneId, inputName, infoId, previewId, isMultiple);
      
      // Agregar eventos de previsualizaci√≥n despu√©s de configurar el dropzone
      setTimeout(addPreviewEvents, 100);
    };
    
    // Variable global para almacenar el user_id
    let currentUserId = null;
    
    // Funci√≥n para guardar el archivo
    async function guardarArchivo() {
      console.log('üöÄ guardarArchivo ejecut√°ndose...');
      console.log('üÜî currentUserId:', currentUserId);
      
      if (!currentUserId) {
        console.log('‚ùå No se encontr√≥ currentUserId');
        showMessage('Error: No se encontr√≥ el ID del usuario.', 'error');
        return;
      }
      
      const guardarBtn = document.getElementById('guardarBtn');
      const submitBtn = document.getElementById('submitBtn');
      
      console.log('üîç Botones encontrados:', { guardarBtn, submitBtn });
      
      try {
        guardarBtn.disabled = true;
        guardarBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Guardando...';
        
        const formData = new FormData();
        formData.append('user_id', currentUserId);
        
        console.log('üì§ Enviando solicitud de guardado a /guardar_site_survey...');
        console.log('üìù FormData:', formData);
        
        const response = await fetch('/guardar_site_survey', {
          method: 'POST',
          body: formData
        });
        
        console.log('üì• Respuesta recibida:', response);
        
        const result = await response.json();
        console.log('üìä Resultado parseado:', result);
        
        if (result.success) {
          console.log('‚úÖ Archivo guardado exitosamente');
          showMessage(result.message, 'success');
          
          // Mostrar modal para nuevo ID despu√©s de un delay
          setTimeout(() => {
            showNewIdModal();
          }, 2000);
        } else {
          console.log('‚ùå Error al guardar:', result.message);
          showMessage(result.message, 'error');
        }
      } catch (error) {
        console.error('‚ùå Error en guardarArchivo:', error);
        showMessage('Error de conexi√≥n. Intenta de nuevo.', 'error');
      } finally {
        guardarBtn.disabled = false;
        guardarBtn.innerHTML = '<i class="fa-solid fa-save"></i> Guardar archivo';
      }
    }
    
    // Funci√≥n para manejar el env√≠o del formulario
    async function handleFormSubmit(e) {
      e.preventDefault();
      
      console.log('üöÄ handleFormSubmit ejecut√°ndose...');
      
      const formData = new FormData(e.target);
      const submitBtn = document.getElementById('submitBtn');
      const guardarBtn = document.getElementById('guardarBtn');
      
      console.log('üîç Botones encontrados:', { submitBtn, guardarBtn });
      console.log('üìù FormData creado:', formData);
      
      try {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Procesando...';
        
        console.log('üì§ Enviando formulario a /procesar...');
        
        const response = await fetch('/procesar', {
          method: 'POST',
          body: formData
        });
        
        console.log('üì• Respuesta recibida:', response);
        
        const result = await response.json();
        console.log('üìä Resultado parseado:', result);
        
        if (result.success) {
          if (result.status === 'llenado_completo_sin_guardar') {
            console.log('‚úÖ Llenado completo sin guardar detectado');
            // Mostrar mensaje de √©xito y mostrar bot√≥n de guardar
            currentUserId = result.user_id;
            showMessage(result.message, 'success');
            
            // Ocultar bot√≥n de submit y mostrar bot√≥n de guardar
            submitBtn.style.display = 'none';
            guardarBtn.style.display = 'inline-block';
            
            console.log('üîÑ Botones actualizados:', { 
              submitBtnDisplay: submitBtn.style.display, 
              guardarBtnDisplay: guardarBtn.style.display 
            });
            
            // Mostrar instrucciones adicionales
            showMessage('‚úÖ Informaci√≥n llenada exitosamente. Ahora sube todas las im√°genes, KMZ y archivos requeridos, luego haz clic en "Guardar archivo".', 'info');
          } else {
            console.log('‚úÖ Comportamiento normal detectado');
            // Comportamiento normal
            showMessage(result.message, 'success');
            // Mostrar modal para nuevo ID despu√©s de un delay
            setTimeout(() => {
              showNewIdModal();
            }, 2000);
          }
        } else {
          console.log('‚ùå Error en la respuesta:', result.message);
          showMessage(result.message, 'error');
        }
      } catch (error) {
        console.error('‚ùå Error en handleFormSubmit:', error);
        showMessage('Error de conexi√≥n. Intenta de nuevo.', 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fa-solid fa-cloud-upload-alt"></i> Subir y llenar';
      }
    }
    
    // Funci√≥n para mostrar mensajes
    function showMessage(message, type) {
      // Crear elemento de mensaje
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      messageDiv.innerHTML = `
        <div class="message-content">
          <i class="fa-solid fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
          <span>${message}</span>
        </div>
      `;
      
      // Agregar estilos
      messageDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#059669' : type === 'error' ? '#dc2626' : '#0ea5e9'};
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        max-width: 400px;
        animation: slideIn 0.3s ease-out;
      `;
      
      // Agregar animaci√≥n
      const style = document.createElement('style');
      style.textContent = `
        @keyframes slideIn {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
      `;
      document.head.appendChild(style);
      
      document.body.appendChild(messageDiv);
      
      // Remover despu√©s de 5 segundos
      setTimeout(() => {
        messageDiv.remove();
      }, 5000);
    }
    
    // Funci√≥n para mostrar modal de nuevo ID
    function showNewIdModal() {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10001;
      `;
      
      modal.innerHTML = `
        <div style="
          background: #1e293b;
          padding: 30px;
          border-radius: 15px;
          text-align: center;
          max-width: 500px;
          border: 2px solid #00c3ff;
        ">
          <h2 style="color: #00c3ff; margin-bottom: 20px;">üéâ ¬°Proceso Completado!</h2>
          <p style="color: #e0e7ef; margin-bottom: 25px; line-height: 1.6;">
            El archivo de Site Survey ha sido guardado exitosamente.<br>
            ¬øDeseas procesar un nuevo ID?
          </p>
          <div style="display: flex; gap: 15px; justify-content: center;">
            <button onclick="location.reload()" style="
              background: #00c3ff;
              color: white;
              border: none;
              padding: 12px 24px;
              border-radius: 8px;
              cursor: pointer;
              font-size: 16px;
              font-weight: 600;
            ">S√≠, nuevo ID</button>
            <button onclick="this.closest('div[style*=\'position: fixed\']').remove()" style="
              background: #64748b;
              color: white;
              border: none;
              padding: 12px 24px;
              border-radius: 8px;
              cursor: pointer;
              font-size: 16px;
              font-weight: 600;
            ">No, cerrar</button>
          </div>
        </div>
      `;
      
              document.body.appendChild(modal);
      }
      
      // Funci√≥n para manejar el env√≠o del formulario
      function handleFormSubmit(e) {
        e.preventDefault();
        
        const form = e.target;
        const submitBtn = form.querySelector('button[type="submit"]');
        const btnText = submitBtn.querySelector('.btn-text');
        const btnLoading = submitBtn.querySelector('.btn-loading');
        
        // Validar archivos antes de enviar
        const requiredFiles = form.querySelectorAll('input[required]');
        let hasErrors = false;
        
        requiredFiles.forEach(input => {
          if (!input.files || input.files.length === 0) {
            hasErrors = true;
            const dropzone = input.closest('.dropzone');
            if (dropzone) {
              dropzone.classList.add('error');
              setTimeout(() => dropzone.classList.remove('error'), 3000);
            }
          }
        });
        
        if (hasErrors) {
          showMessage('Por favor, completa todos los campos requeridos', 'error');
          return;
        }
        
        // Cambiar estado del bot√≥n
        btnText.style.display = 'none';
        btnLoading.style.display = 'inline';
        submitBtn.disabled = true;
        submitBtn.classList.add('uploading');
        
        // Mostrar mensaje de procesamiento
        showMessage('Procesando archivos...', 'info');
        
        // Simular env√≠o (aqu√≠ ir√≠a la l√≥gica real)
        setTimeout(() => {
          // Restaurar bot√≥n
          btnText.style.display = 'inline';
          btnLoading.style.display = 'none';
          submitBtn.disabled = false;
          submitBtn.classList.remove('uploading');
          
          // Mostrar mensaje de √©xito
          showMessage('Archivos procesados exitosamente!', 'success');
          
          // Aqu√≠ puedes agregar la l√≥gica real de env√≠o
          console.log('Formulario enviado:', new FormData(form));
        }, 3000);
      }

      // Funci√≥n para mostrar mensajes
      function showMessage(text, type = 'info') {
        const messageDiv = document.createElement('div');
        messageDiv.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          padding: 15px 20px;
          border-radius: 8px;
          color: white;
          font-weight: 600;
          z-index: 10000;
          animation: slideIn 0.3s ease-out;
          max-width: 300px;
        `;
        
        const colors = {
          success: '#00ff88',
          error: '#ff4757',
          info: '#00c3ff',
          warning: '#ffa500'
        };
        
        messageDiv.style.background = colors[type] || colors.info;
        messageDiv.innerHTML = `
          <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
          ${text}
        `;
        
        document.body.appendChild(messageDiv);
        
        setTimeout(() => {
          messageDiv.remove();
        }, 5000);
      }
      
      // Agregar eventos iniciales
      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(addPreviewEvents, 500);
        
        // Agregar evento para el bot√≥n de guardar
        const guardarBtn = document.getElementById('guardarBtn');
        if (guardarBtn) {
          guardarBtn.addEventListener('click', guardarArchivo);
          console.log('‚úÖ Event listener agregado al bot√≥n guardar');
        } else {
          console.log('‚ö†Ô∏è Bot√≥n guardar no encontrado al cargar la p√°gina');
        }
        
        // Agregar evento para el formulario
        const form = document.getElementById('autoForm');
        if (form) {
          form.addEventListener('submit', handleFormSubmit);
          console.log('‚úÖ Event listener agregado al formulario');
        } else {
          console.log('‚ö†Ô∏è Formulario no encontrado al cargar la p√°gina');
        }
      });
    </script>
  </body>
  </html>