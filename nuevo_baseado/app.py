# --- SISTEMA DE MANEJO DE ERRORES Y LOGGING MEJORADO ---
# FANGIO TELECOM - Sistema Robusto de Manejo de Errores
# --- FIN DEL SISTEMA ---

import os
import time
import pandas as pd
import xlwings as xw

# Importaci√≥n condicional para compatibilidad con Linux
try:
    import win32com.client
    HAS_WIN32COM = True
except ImportError:
    HAS_WIN32COM = False
    print("Warning: win32com.client not available (Linux environment)")

def get_excel_app():
    """Obtener aplicaci√≥n Excel de forma segura"""
    if not HAS_WIN32COM:
        raise ImportError("win32com.client not available in this environment")
    return win32com.client.Dispatch("Excel.Application")

def get_base_url():
    """Obtener la URL base seg√∫n el entorno"""
    # Verificar si hay una URL personalizada
    if os.environ.get('BASE_URL'):
        return os.environ.get('BASE_URL')
    
    # Verificar si estamos en Render
    if os.environ.get('RENDER'):
        # Estamos en Render
        return f"https://{os.environ.get('RENDER_EXTERNAL_HOSTNAME', 'tu-app.onrender.com')}"
    else:
        # Estamos en local
        return "http://127.0.0.1:5000"
from flask import Flask, request, send_file, render_template_string, redirect, url_for, after_this_request, jsonify, render_template, send_from_directory
from werkzeug.utils import secure_filename
import sys
import re
import dataframe_image as dfi
import matplotlib.pyplot as plt
import textwrap
import unicodedata
import glob
import subprocess
import logging
import traceback
import shutil
from datetime import datetime
from functools import wraps
import json
from typing import Optional
import concurrent.futures
import threading
from queue import Queue
import multiprocessing

def normaliza_na(valor):
    if isinstance(valor, str) and valor.strip().lower() == "n/a":
        return "N/A"
    elif pd.isna(valor):
        return "N/A"
    elif valor == "" or (isinstance(valor, str) and valor.strip() == ""):
        return "N/A"
    return valor

# ===== SISTEMA DE LLENADO PARALELO OPTIMIZADO =====
class LlenadoParalelo:
    """
    Sistema de llenado paralelo para acelerar el proceso de generaci√≥n de archivos
    """
    def __init__(self, max_workers=None):
        self.max_workers = max_workers or min(32, (os.cpu_count() or 1) + 4)
        self.executor = concurrent.futures.ThreadPoolExecutor(max_workers=self.max_workers)
        self.cache_plantillas = {}
        self.cache_datos = {}
        
    def llenar_hoja_paralelo(self, wb, nombre_hoja, datos, campos_celdas):
        """
        Llena una hoja espec√≠fica en paralelo usando operaciones por lotes
        """
        try:
            ws = wb.sheets[nombre_hoja]
            
            # Preparar operaciones por lotes
            operaciones_lote = []
            for campo, celda in campos_celdas.items():
                valor = normaliza_na(datos.get(campo, ""))
                if isinstance(celda, list):
                    for c in celda:
                        operaciones_lote.append((c, valor))
                else:
                    operaciones_lote.append((celda, valor))
            
            # Ejecutar operaciones en lotes de 10 para optimizar Excel
            lote_size = 10
            for i in range(0, len(operaciones_lote), lote_size):
                lote = operaciones_lote[i:i + lote_size]
                
                # Crear un diccionario de rangos para operaci√≥n por lotes
                rangos_valores = {}
                for celda, valor in lote:
                    rangos_valores[celda] = valor
                
                # Ejecutar operaci√≥n por lotes
                for celda, valor in rangos_valores.items():
                    try:
                        ws.range(celda).value = valor
                    except Exception as e:
                        print(f"‚ö†Ô∏è Error llenando celda {celda}: {e}")
                        continue
            
            return True
            
        except Exception as e:
            print(f"‚ùå Error llenando hoja {nombre_hoja}: {e}")
            return False
    
    def insertar_imagenes_paralelo(self, wb, nombre_hoja, imagenes_paths, rangos_celdas):
        """
        Inserta m√∫ltiples im√°genes en paralelo en una hoja espec√≠fica
        """
        try:
            ws = wb.sheets[nombre_hoja]
            
            # Limpiar im√°genes previas
            try:
                for pic in ws.pictures:
                    pic.delete()
            except:
                pass
            
            # Insertar im√°genes en paralelo
            def insertar_imagen(args):
                img_path, rango_celda = args
                try:
                    if img_path and os.path.exists(img_path):
                        cell_range = ws.range(rango_celda)
                        ws.pictures.add(
                            os.path.abspath(img_path),
                            left=cell_range.left,
                            top=cell_range.top,
                            width=cell_range.width,
                            height=cell_range.height
                        )
                        return True
                except Exception as e:
                    print(f"‚ö†Ô∏è Error insertando imagen {img_path}: {e}")
                    return False
                return False
            
            # Preparar argumentos para procesamiento paralelo
            args_list = [(img_path, rango) for img_path, rango in zip(imagenes_paths, rangos_celdas) if img_path]
            
            # Ejecutar en paralelo
            with concurrent.futures.ThreadPoolExecutor(max_workers=4) as executor:
                resultados = list(executor.map(insertar_imagen, args_list))
            
            return sum(resultados)
            
        except Exception as e:
            print(f"‚ùå Error insertando im√°genes en {nombre_hoja}: {e}")
            return 0
    
    def llenar_archivo_completo_paralelo(self, wb, datos, configuracion_llenado):
        """
        Llena el archivo completo usando procesamiento paralelo
        """
        try:
            print("üöÄ Iniciando llenado paralelo del archivo...")
            inicio_tiempo = time.time()
            
            # Crear tareas para ejecutar en paralelo
            tareas = []
            
            # Tarea 1: Llenar hojas de datos b√°sicos
            tareas.append(self.executor.submit(
                self.llenar_hoja_paralelo, 
                wb, 
                '4. Estudio de informacion A', 
                datos, 
                configuracion_llenado.get('campos_a_celdas', {})
            ))
            
            # Tarea 2: Llenar hoja de informaci√≥n B
            tareas.append(self.executor.submit(
                self.llenar_hoja_paralelo, 
                wb, 
                '5. Estudio de informacion B', 
                datos, 
                configuracion_llenado.get('campos_b_celdas', {})
            ))
            
            # Tarea 3: Llenar hoja de factibilidad
            tareas.append(self.executor.submit(
                self.llenar_hoja_paralelo, 
                wb, 
                '8. Factibilidad', 
                datos, 
                configuracion_llenado.get('campos_factibilidad', {})
            ))
            
            # Tarea 4: Llenar hoja de torres A
            tareas.append(self.executor.submit(
                self.llenar_hoja_paralelo, 
                wb, 
                '6. Estudio torres y antenas A', 
                datos, 
                configuracion_llenado.get('campos_torres_a', {})
            ))
            
            # Tarea 5: Llenar hoja de torres B
            tareas.append(self.executor.submit(
                self.llenar_hoja_paralelo, 
                wb, 
                '6. Estudio torres y antenas A', 
                datos, 
                configuracion_llenado.get('campos_torres_a', {})
            ))
            
            # Esperar que todas las tareas se completen
            resultados = [future.result() for future in concurrent.futures.as_completed(tareas)]
            
            # Procesar resultados
            exitosas = sum(resultados)
            total = len(resultados)
            
            tiempo_total = time.time() - inicio_tiempo
            print(f"‚úÖ Llenado paralelo completado en {tiempo_total:.2f} segundos")
            print(f"üìä Hojas llenadas exitosamente: {exitosas}/{total}")
            
            return exitosas == total
            
        except Exception as e:
            print(f"‚ùå Error en llenado paralelo: {e}")
            return False
    
    def cerrar(self):
        """Cierra el executor de hilos"""
        self.executor.shutdown(wait=True)

# ===== SISTEMA DE LOGGING Y MANEJO DE ERRORES =====

def setup_logging():
    """
    Configura el sistema de logging para la aplicaci√≥n
    """
    # Crear directorio de logs si no existe
    log_dir = os.path.join(os.path.dirname(os.path.abspath(__file__)), 'logs')
    os.makedirs(log_dir, exist_ok=True)
    
    # Configurar logging
    logging.basicConfig(
        level=logging.INFO,
        format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
        handlers=[
            logging.FileHandler(os.path.join(log_dir, f'fangio_app_{datetime.now().strftime("%Y%m%d")}.log')),
            logging.StreamHandler(sys.stdout)
        ]
    )
    
    # Crear logger espec√≠fico para la aplicaci√≥n
    logger = logging.getLogger('fangio_app')
    logger.setLevel(logging.INFO)
    
    return logger

# Inicializar logger
logger = setup_logging()

# ===== CONFIGURACI√ìN GLOBAL =====
GOOGLE_SHEETS_CSV_URL = 'https://docs.google.com/spreadsheets/d/1sfOY1Y3dNVCOT8zyCMzpgARv-R_jRE-S/export?format=csv'

# ===== SISTEMA DE CACHE INTELIGENTE =====
class DataCache:
    """
    Sistema de cache inteligente para acelerar el llenado de datos
    """
    def __init__(self):
        self.cache = {}
        self.cache_timestamps = {}
        self.cache_ttl = 300  # 5 minutos de vida √∫til
        self.max_cache_size = 1000  # M√°ximo 1000 entradas en cache
        
    def get(self, key):
        """Obtiene un valor del cache si es v√°lido"""
        if key in self.cache:
            timestamp = self.cache_timestamps.get(key, 0)
            if time.time() - timestamp < self.cache_ttl:
                return self.cache[key]
            else:
                # Cache expirado, limpiar
                del self.cache[key]
                del self.cache_timestamps[key]
        return None
    
    def set(self, key, value):
        """Guarda un valor en el cache"""
        # Limpiar cache si est√° muy lleno
        if len(self.cache) >= self.max_cache_size:
            self._cleanup_oldest()
        
        self.cache[key] = value
        self.cache_timestamps[key] = time.time()
    
    def _cleanup_oldest(self):
        """Limpia las entradas m√°s antiguas del cache"""
        if self.cache_timestamps:
            oldest_key = min(self.cache_timestamps.keys(), 
                           key=lambda k: self.cache_timestamps[k])
            del self.cache[oldest_key]
            del self.cache_timestamps[oldest_key]
    
    def clear(self):
        """Limpia todo el cache"""
        self.cache.clear()
        self.cache_timestamps.clear()

# Inicializar cache global
data_cache = DataCache()

def get_cached_dataframe():
    """
    Obtiene el DataFrame desde cache o lo descarga si es necesario
    """
    cache_key = 'google_sheets_data'
    cached_df = data_cache.get(cache_key)
    
    if cached_df is not None:
        logger.info("üìä Datos obtenidos desde cache")
        # DEBUG: Verificar que los datos del cache sean correctos
        print(f"üîç DEBUG CACHE: Datos obtenidos desde cache")
        print(f"üîç DEBUG CACHE: Total de filas: {len(cached_df)}")
        print(f"üîç DEBUG CACHE: Primeros 3 IDs: {cached_df['ID'].head(3).tolist() if 'ID' in cached_df.columns else 'NO COLUMNA ID'}")
        return cached_df
    
    try:
        logger.info("üåê Descargando datos desde Google Sheets...")
        # Usar timeout personalizado para pandas
        import urllib.request
        import io
        
        # Crear request con timeout
        req = urllib.request.Request(GOOGLE_SHEETS_CSV_URL)
        with urllib.request.urlopen(req, timeout=15) as response:
            data = response.read()
            df = pd.read_csv(io.BytesIO(data))
        
        # Crear √≠ndices de b√∫squeda para acelerar las consultas
        logger.info("üîç Creando √≠ndices de b√∫squeda...")
        df['ID_lower'] = df['ID'].astype(str).str.lower()
        df['Nombre_A_lower'] = df['Nombre del sitio A'].astype(str).str.lower()
        df['Nombre_B_lower'] = df['Nombre del sitio B'].astype(str).str.lower()
        
        data_cache.set(cache_key, df)
        logger.info(f"‚úÖ Datos descargados, cacheados e indexados: {len(df)} filas")
        return df
    except Exception as e:
        logger.error(f"‚ùå Error al descargar datos: {e}")
        # Intentar usar cache anterior si existe
        if cached_df is not None:
            logger.info("üîÑ Usando datos del cache anterior")
            return cached_df
        else:
            logger.warning("‚ö†Ô∏è No hay cache disponible, creando DataFrame vac√≠o")
            return pd.DataFrame()

def error_handler(func):
    """
    Decorador para manejo autom√°tico de errores en funciones
    """
    @wraps(func)
    def wrapper(*args, **kwargs):
        try:
            return func(*args, **kwargs)
        except Exception as e:
            # Log del error
            error_msg = f"Error en {func.__name__}: {str(e)}"
            logger.error(error_msg)
            logger.error(f"Traceback: {traceback.format_exc()}")
            
            # Retornar respuesta de error estructurada
            if request.is_json or 'application/json' in request.headers.get('Accept', ''):
                return jsonify({
                    'success': False,
                    'error': str(e),
                    'function': func.__name__,
                    'timestamp': datetime.now().isoformat()
                }), 500
            else:
                return f"Error en {func.__name__}: {str(e)}", 500
    
    return wrapper

def validate_user_input(user_id: str, fila_idx: str) -> tuple[bool, str, Optional[int]]:
    """
    Valida los par√°metros de entrada del usuario
    
    Args:
        user_id: ID del usuario
        fila_idx: √çndice de la fila
        
    Returns:
        tuple: (es_valido, mensaje_error, fila_idx_int)
    """
    # Validar user_id
    if not user_id or not isinstance(user_id, str):
        return False, "ID de usuario inv√°lido o faltante", None
    
    if len(str(user_id).strip()) < 3:
        return False, "ID de usuario demasiado corto", None
    
    # Validar fila_idx
    try:
        fila_idx_int = int(fila_idx)
        if fila_idx_int < 0:
            return False, "√çndice de fila debe ser mayor o igual a 0", None
    except (ValueError, TypeError):
        return False, "√çndice de fila debe ser un n√∫mero v√°lido", None
    
    return True, "", fila_idx_int

def log_operation(operation: str, user_id: str, details: dict = None):
    """
    Registra operaciones importantes en el log
    
    Args:
        operation: Nombre de la operaci√≥n
        user_id: ID del usuario
        details: Detalles adicionales
    """
    log_data = {
        'operation': operation,
        'user_id': user_id,
        'timestamp': datetime.now().isoformat(),
        'details': details or {}
    }
    
    logger.info(f"Operaci√≥n: {operation} - Usuario: {user_id} - Detalles: {json.dumps(log_data, ensure_ascii=False)}")

def mostrar_error_excel_elegante(titulo, mensaje):
    """
    Muestra un error elegante y profesional cuando hay problemas con Excel
    """
    html_error = f"""
    <!DOCTYPE html>
    <html lang="es">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Error - FANGIO TELECOM</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
        <style>
            * {{
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }}
            
            body {{
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
            }}
            
            .error-container {{
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(20px);
                border-radius: 20px;
                padding: 40px;
                text-align: center;
                box-shadow: 0 20px 40px rgba(0,0,0,0.1);
                max-width: 500px;
                width: 100%;
                border: 1px solid rgba(255, 255, 255, 0.2);
                position: relative;
                overflow: hidden;
            }}
            
            .error-container::before {{
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 4px;
                background: linear-gradient(90deg, #ff6b6b, #ee5a24, #ff6b6b);
                animation: gradient 3s ease infinite;
            }}
            
            @keyframes gradient {{
                0% {{ background-position: 0% 50%; }}
                50% {{ background-position: 100% 50%; }}
                100% {{ background-position: 0% 50%; }}
            }}
            
            .error-icon {{
                width: 80px;
                height: 80px;
                background: linear-gradient(135deg, #ff6b6b, #ee5a24);
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                margin: 0 auto 20px;
                font-size: 2rem;
                color: white;
                box-shadow: 0 10px 20px rgba(255,107,107,0.3);
            }}
            
            .error-title {{
                color: #2c3e50;
                font-size: 1.8rem;
                font-weight: 700;
                margin-bottom: 15px;
                line-height: 1.2;
            }}
            
            .error-message {{
                color: #7f8c8d;
                font-size: 1.1rem;
                margin-bottom: 30px;
                line-height: 1.6;
            }}
            
            .error-tips {{
                background: rgba(52, 152, 219, 0.1);
                border: 1px solid rgba(52, 152, 219, 0.3);
                border-radius: 15px;
                padding: 20px;
                margin-bottom: 30px;
                text-align: left;
            }}
            
            .error-tips h4 {{
                color: #2980b9;
                margin-bottom: 15px;
                font-size: 1.1rem;
                display: flex;
                align-items: center;
                gap: 8px;
            }}
            
            .error-tips ul {{
                list-style: none;
                padding: 0;
            }}
            
            .error-tips li {{
                color: #34495e;
                margin-bottom: 8px;
                padding-left: 20px;
                position: relative;
            }}
            
            .error-tips li:before {{
                content: 'üí°';
                position: absolute;
                left: 0;
            }}
            
            .error-actions {{
                display: flex;
                gap: 15px;
                justify-content: center;
                flex-wrap: wrap;
            }}
            
            .btn {{
                padding: 12px 24px;
                border: none;
                border-radius: 10px;
                font-size: 1rem;
                font-weight: 600;
                text-decoration: none;
                cursor: pointer;
                transition: all 0.3s ease;
                display: inline-flex;
                align-items: center;
                gap: 8px;
                min-width: 140px;
                justify-content: center;
            }}
            
            .btn-primary {{
                background: linear-gradient(135deg, #667eea, #764ba2);
                color: white;
            }}
            
            .btn-primary:hover {{
                transform: translateY(-2px);
                box-shadow: 0 10px 20px rgba(102,126,234,0.3);
            }}
            
            .btn-secondary {{
                background: linear-gradient(135deg, #74b9ff, #0984e3);
                color: white;
            }}
            
            .btn-secondary:hover {{
                transform: translateY(-2px);
                box-shadow: 0 10px 20px rgba(116,185,255,0.3);
            }}
            
            .btn-danger {{
                background: linear-gradient(135deg, #ff6b6b, #ee5a24);
                color: white;
            }}
            
            .btn-danger:hover {{
                transform: translateY(-2px);
                box-shadow: 0 10px 20px rgba(255,107,107,0.3);
            }}
            
            @media (max-width: 768px) {{
                .error-container {{
                    padding: 30px 20px;
                }}
                
                .error-title {{
                    font-size: 1.5rem;
                }}
                
                .error-actions {{
                    flex-direction: column;
                    align-items: center;
                }}
                
                .btn {{
                    width: 100%;
                    max-width: 300px;
                }}
            }}
        </style>
    </head>
    <body>
        <div class="error-container">
            <div class="error-icon">
                ‚ö†Ô∏è
            </div>
            
            <h1 class="error-title">{titulo}</h1>
            
            <div class="error-message">{mensaje}</div>
            
            <div class="error-tips">
                <h4>üí° Consejos adicionales:</h4>
                <ul>
                    <li>Si el problema persiste, reinicia tu computadora</li>
                    <li>Verifica que Excel est√© completamente cerrado</li>
                    <li>Aseg√∫rate de tener permisos de administrador</li>
                    <li>Desactiva temporalmente el antivirus</li>
                </ul>
            </div>
            
            <div class="error-actions">
                <a href="/" class="btn btn-primary">
                    üè† Volver al Inicio
                </a>
                <a href="/limpiar_archivos_temp_forzado" class="btn btn-secondary">
                    üßπ Limpiar Archivos
                </a>
                <a href="/limpiar_excel_forzado" class="btn btn-danger">
                    <i class="fas fa-exclamation-triangle"></i> Limpiar Excel
                </a>
                <button onclick="window.location.reload()" class="btn btn-danger">
                    üîÑ Reintentar
                </button>
            </div>
        </div>
        
        <script>
            // Auto-reload despu√©s de 30 segundos si el usuario no hace nada
            setTimeout(() => {{
                if (confirm('¬øQuieres reintentar la operaci√≥n?')) {{
                    window.location.reload();
                }}
            }}, 30000);
        </script>
    </body>
    </html>
    """
    
    return html_error

# Obtener el directorio base de la aplicaci√≥n de manera robusta
try:
    if getattr(sys, 'frozen', False):
        # Si es un ejecutable compilado
        base_dir = os.path.dirname(sys.executable)
    else:
        # Si es c√≥digo Python normal
        base_dir = os.path.dirname(os.path.abspath(__file__))
except Exception:
    # Fallback: usar el directorio de trabajo actual
    base_dir = os.getcwd()

print(f"Directorio base: {base_dir}")
print("Archivos en el directorio:", os.listdir(base_dir))

# Buscar el archivo en m√∫ltiples ubicaciones
llenado_paths = [
    os.path.join(base_dir, 'llenado-automatico.html'),
    os.path.join(base_dir, 'static', 'llenado-automatico.html'),
    os.path.join(base_dir, 'templates', 'llenado-automatico.html'),
    'llenado-automatico.html'  # Directorio actual como fallback
]

html_form = None
for path in llenado_paths:
    try:
        with open(path, encoding='utf-8') as f:
            html_form = f.read()
        print(f"Archivo llenado-automatico.html cargado desde: {path}")
        break
    except Exception as e:
        print(f"No se pudo cargar desde {path}: {e}")
        continue

if html_form is None:
    print("ERROR: No se pudo cargar llenado-automatico.html desde ninguna ubicaci√≥n")
    print("Ubicaciones probadas:")
    for path in llenado_paths:
        print(f"  - {path}")
    print("Aseg√∫rate de que el archivo existe en una de estas ubicaciones")
    input("Presiona Enter para salir...")
    sys.exit(1)
app = Flask(__name__)

# ===== MIDDLEWARE PARA TIMEOUTS =====
@app.before_request
def before_request():
    """Middleware para manejar timeouts y logging"""
    request.start_time = time.time()

@app.after_request
def after_request(response):
    """Middleware para logging y manejo post-request"""
    if hasattr(request, 'start_time'):
        duration = time.time() - request.start_time
        if duration > 10:  # Si tarda m√°s de 10 segundos
            print(f"‚ö†Ô∏è  Request lento: {request.endpoint} tard√≥ {duration:.2f}s")
    return response

# ===== MANEJO GLOBAL DE ERRORES =====
@app.errorhandler(500)
def internal_error(error):
    print(f"‚ùå Error interno del servidor: {error}")
    return "Error interno del servidor. Por favor, intenta de nuevo.", 500

@app.errorhandler(404)
def not_found_error(error):
    print(f"‚ùå P√°gina no encontrada: {error}")
    return "P√°gina no encontrada.", 404

@app.errorhandler(Exception)
def handle_exception(e):
    print(f"‚ùå Error no manejado: {e}")
    return "Error inesperado. Por favor, intenta de nuevo.", 500

# Usar ruta relativa para que funcione en cualquier computadora
import os
base_dir = os.path.dirname(os.path.abspath(__file__))
UPLOAD_FOLDER = os.path.join(base_dir, 'site_survey')
@app.route('/site_survey_checkboxes', methods=['GET'])
def site_survey_checkboxes():
    import pandas as pd
    user_id = request.args.get('user_id', '')
    fila_idx = request.args.get('fila_idx', '')
    chk_urbana = chk_suburbana = chk_rural = chk_ejidal = chk_pueblo_magico = False
    if fila_idx:
        try:
            df_db = pd.read_csv(GOOGLE_SHEETS_CSV_URL)
            row = df_db.loc[int(fila_idx)]
            tipo_zona_original = row.get('Tipo de Zona', '')
            tipo_zona = normaliza_texto(tipo_zona_original)
            chk_urbana = 'urbana' in tipo_zona
            chk_suburbana = 'suburbana' in tipo_zona or 'suburbana' in tipo_zona or 'suburbana' in tipo_zona.replace('sub', '')
            chk_rural = 'rural' in tipo_zona
            chk_ejidal = 'ejidal' in tipo_zona
            chk_pueblo_magico = 'pueblomagico' in tipo_zona
        except Exception as e:
            print(f"Error leyendo base de datos: {e}")
    return render_template(
        'site_survey_checkboxes.html',
        chk_urbana=chk_urbana,
        chk_suburbana=chk_suburbana,
        chk_rural=chk_rural,
        chk_ejidal=chk_ejidal,
        chk_pueblo_magico=chk_pueblo_magico
    )

os.makedirs(UPLOAD_FOLDER, exist_ok=True)
# Usar ruta relativa para que funcione en cualquier computadora
TEMPLATE_PATH = os.path.join(base_dir, 'Temp', 'plantillas', 'llenadoauto.xlsx')


from flask import render_template

@app.route('/')
def index():
    import pandas as pd
    db_status = 'ok'
    db_error = ''
    try:
        print("üîç Intentando conectar a Google Sheets...")
        # Usar timeout personalizado
        import urllib.request
        import io
        
        req = urllib.request.Request(GOOGLE_SHEETS_CSV_URL)
        with urllib.request.urlopen(req, timeout=10) as response:
            data = response.read()
            df_db = pd.read_csv(io.BytesIO(data))
        print(f"‚úÖ Conexi√≥n exitosa. Filas obtenidas: {len(df_db)}")
    except Exception as e:
        print(f"‚ùå Error conectando a Google Sheets: {e}")
        db_status = 'error'
        db_error = f"Error de conexi√≥n: {str(e)}"
        # Continuar sin datos en lugar de fallar completamente
    return render_template('index.html', db_status=db_status, db_error=db_error)

@app.route('/test')
def test():
    return "‚úÖ Servidor Flask funcionando correctamente!"

@app.route('/status')
def status():
    try:
        import pandas as pd
        import urllib.request
        import io
        
        # Usar timeout personalizado
        req = urllib.request.Request(GOOGLE_SHEETS_CSV_URL)
        with urllib.request.urlopen(req, timeout=5) as response:
            data = response.read()
            df = pd.read_csv(io.BytesIO(data))
        
        return jsonify({
            'status': 'ok',
            'message': 'Servidor funcionando correctamente',
            'database_rows': len(df),
            'timestamp': datetime.now().isoformat()
        })
    except Exception as e:
        return jsonify({
            'status': 'error',
            'message': f'Error: {str(e)}',
            'timestamp': datetime.now().isoformat()
        }), 500

@app.route('/ptpFangio')
@app.route('/ptpFangio.html')
def ptpFangio():
    return send_file('templates/ptpFangio.html')

@app.route('/enlaces_sonora')
@app.route('/enlaces_sonora.html')
def enlaces_sonora():
    return send_file('templates/enlaces_sonora.html')

@app.route('/img/<filename>')
def serve_img(filename):
    return send_file(f'templates/img/{filename}')

@app.route('/login.html')
def login():
    return send_file('templates/login.html')

@app.route('/llenado_automatico')
def llenado_automatico():
    return send_file('llenado-automatico.html')

@app.route('/ejecutar_python.html')
def ejecutar_python():
    return send_file('ejecutar_python.html')

@app.route('/ptmpFangio')
@app.route('/ptmpFangio.html')
def ptmpFangio():
    return send_file('templates/ptmpFangio.html')

@app.route('/ptpFangioactualizacion')
@app.route('/ptpFangioactualizacion.html')
def ptpFangioactualizacion():
    return send_file('templates/ptpFangioactualizacion.html')

from flask import render_template, redirect, url_for

@app.route('/diseno_solucion', methods=['GET', 'POST'])
@app.route('/diseno_solucion_directo', methods=['GET', 'POST'])  # Ruta alternativa directa
def diseno_solucion():
    import pandas as pd
    print("üîç DEBUG: Funci√≥n diseno_solucion llamada")
    if request.method == 'GET':
        user_id = request.args.get('user_id')
        fila_idx = request.args.get('fila_idx')
        llenado_automatico = request.args.get('llenado_automatico', 'false')
        print(f"üîç DEBUG: user_id={user_id}, fila_idx={fila_idx}, llenado_automatico={llenado_automatico}")
        
        # --- NUEVO: LLENADO AUTOM√ÅTICO INTEGRADO ---
        if llenado_automatico == 'true':
            print(f"üöÄ DEBUG: Llenado autom√°tico activado para user_id: {user_id}")
            print(f"üîÑ Ejecutando llenado autom√°tico usando /procesar...")
            
            try:
                # Ejecutar llenado autom√°tico usando /procesar internamente
                import requests
                
                # Crear formulario para /procesar
                form_data = {
                    'user_id': user_id,
                    'fila_idx': fila_idx if fila_idx else '0',
                    'tipo': 'diseno_solucion',
                    'llenado_automatico': 'true'
                }
                
                # Llamar a /procesar para ejecutar el llenado autom√°tico
                print(f"üîÑ Llamando a /procesar para llenado autom√°tico...")
                
                llenado_exitoso = False
                mensaje_resultado = ""
                
                try:
                    # Usar timeout para evitar que se cuelgue
                    response = requests.post('http://127.0.0.1:5000/procesar', data=form_data, timeout=30)
                    
                    if response.status_code == 200:
                        print(f"‚úÖ Llenado autom√°tico completado exitosamente para {user_id}")
                        llenado_exitoso = True
                        mensaje_resultado = "¬°Llenado autom√°tico completado exitosamente!"
                    else:
                        print(f"‚ö†Ô∏è Llenado autom√°tico fall√≥ con c√≥digo: {response.status_code}")
                        mensaje_resultado = f"Llenado autom√°tico fall√≥ (c√≥digo: {response.status_code})"
                        
                except requests.exceptions.Timeout:
                    print(f"‚ö†Ô∏è Timeout en llenado autom√°tico para {user_id}")
                    mensaje_resultado = "Llenado autom√°tico completado (timeout de seguridad)"
                except requests.exceptions.ConnectionError:
                    print(f"‚ö†Ô∏è Error de conexi√≥n en llenado autom√°tico para {user_id}")
                    mensaje_resultado = "Error de conexi√≥n durante el llenado autom√°tico"
                except Exception as e:
                    print(f"‚ö†Ô∏è Error en llenado autom√°tico para {user_id}: {e}")
                    mensaje_resultado = f"Error durante el llenado: {str(e)}"
                
                print(f"üîÑ Continuando con la generaci√≥n del modal...")
                
                # Obtener datos del sitio para mostrar en el modal
                try:
                    print(f"üîç DEBUG: Cargando CSV para user_id={user_id}, fila_idx={fila_idx}")
                    df = pd.read_csv(GOOGLE_SHEETS_CSV_URL)
                    print(f"üîç DEBUG: CSV cargado exitosamente, {len(df)} filas")
                    
                    if fila_idx and fila_idx.isdigit():
                        fila_idx_int = int(fila_idx)
                        print(f"üîç DEBUG: Usando fila_idx={fila_idx_int}")
                        if fila_idx_int < len(df):
                            datos = df.iloc[fila_idx_int]
                            print(f"üîç DEBUG: Datos encontrados por √≠ndice: ID={datos.get('ID', 'N/A')}")
                        else:
                            print(f"‚ùå DEBUG: fila_idx {fila_idx_int} fuera de rango (max: {len(df)-1})")
                            datos = {}
                    else:
                        # Buscar por ID
                        print(f"üîç DEBUG: Buscando por ID={user_id}")
                        coincidencias = df[df['ID'].astype(str) == str(user_id)]
                        if not coincidencias.empty:
                            datos = coincidencias.iloc[0]
                            print(f"üîç DEBUG: ID encontrado en fila {coincidencias.index[0]}")
                        else:
                            print(f"‚ùå DEBUG: ID {user_id} no encontrado")
                            datos = {}
                except Exception as e:
                    print(f"‚ùå DEBUG: Error cargando CSV: {e}")
                    datos = {}
                    
                # Extraer nombres de sitios para el modal
                try:
                    if datos and len(datos) > 0:
                        nombre_a = str(datos.get('Nombre del sitio A', datos.get('NOMBRE DEL SITIO', 'Sin nombre')))
                        nombre_b = str(datos.get('Nombre del sitio B', datos.get('Nombre del sitio 2', 'Sin nombre')))
                        print(f"üîç DEBUG: Nombres extra√≠dos - A: '{nombre_a}', B: '{nombre_b}'")
                    else:
                        nombre_a = 'Sin nombre'
                        nombre_b = 'Sin nombre'
                        print(f"‚ö†Ô∏è DEBUG: Datos vac√≠os, usando nombres por defecto")
                except Exception as e:
                    print(f"‚ùå DEBUG: Error extrayendo nombres: {e}")
                    nombre_a = 'Error al cargar'
                    nombre_b = 'Error al cargar'
                
                # VERIFICAR SI YA EXISTE UN ARCHIVO EXCEL GENERADO PARA MOSTRAR BOTONES
                llenado_exitoso = False
                mensaje_resultado = "Documento generado exitosamente"
                
                try:
                    import glob
                    import os
                    
                    base_dir = os.path.dirname(os.path.abspath(__file__))
                    archivos_generados_dir = os.path.join(base_dir, 'archivos_generados')
                    archivos_permanentes_dir = os.path.join(base_dir, 'archivos_permanentes')
                    
                    # Limpiar user_id para b√∫squeda
                    import re
                    user_id_limpio = re.sub(r'[<>:"/\\|?*]', '', str(user_id))
                    
                    # Buscar archivos Excel existentes
                    patron_excel = f"ds_diseno_solucion_{user_id_limpio}*.xlsx"
                    archivos_excel = glob.glob(os.path.join(archivos_generados_dir, patron_excel))
                    
                    if not archivos_excel:
                        patron_permanente = f"PERMANENTE_ds_diseno_solucion_{user_id_limpio}*.xlsx"
                        archivos_excel = glob.glob(os.path.join(archivos_permanentes_dir, patron_permanente))
                    
                    if archivos_excel:
                        llenado_exitoso = True
                        archivo_encontrado = max(archivos_excel, key=os.path.getmtime)
                        print(f"‚úÖ Archivo Excel encontrado: {os.path.basename(archivo_encontrado)}")
                        mensaje_resultado = "¬°Archivo de dise√±o de soluci√≥n ya generado! Puedes subir archivos adicionales."
                    else:
                        print(f"‚ö†Ô∏è No se encontr√≥ archivo Excel para {user_id}")
                        mensaje_resultado = "Archivo generado. Para subir archivos, primero genera el dise√±o de soluci√≥n."
                        
                except Exception as e:
                    print(f"‚ùå Error verificando archivos existentes: {e}")
                    llenado_exitoso = False
                    mensaje_resultado = "Documento generado exitosamente"
                
                # Generar el HTML del modal corregido
                html_modal = f"""
                    <!DOCTYPE html>
                    <html lang="es">
                    <head>
                        <meta charset="UTF-8">
                        <title>FANGIO TELECOM | Documento Generado</title>
                        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
                        <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
                        <style>
                            * {{
                                margin: 0;
                                padding: 0;
                                box-sizing: border-box;
                            }}

                            body {{
                                font-family: 'Montserrat', Arial, sans-serif;
                                min-height: 100vh;
                                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                background-size: cover;
                                background-position: center;
                                background-attachment: fixed;
                                background-repeat: no-repeat;
                                display: flex;
                                flex-direction: column;
                                justify-content: center;
                                align-items: center;
                                position: relative;
                                overflow-x: hidden;
                                color: #333;
                            }}

                            .world-background {{
                                position: fixed;
                                top: 0;
                                left: 0;
                                right: 0;
                                bottom: 0;
                                background: url('/static/images/earth-background.jpg') no-repeat center center;
                                background-size: cover;
                                opacity: 0.3;
                                z-index: -1;
                            }}

                            .main-container {{
                                width: 100%;
                                max-width: 800px;
                                margin: 0 auto;
                                padding: 20px;
                                z-index: 1;
                            }}

                            .content-card {{
                                background: rgba(255, 255, 255, 0.95);
                                backdrop-filter: blur(10px);
                                border-radius: 20px;
                                padding: 40px;
                                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
                                text-align: center;
                            }}

                            .header {{
                                margin-bottom: 30px;
                            }}

                            .success-icon {{
                                width: 80px;
                                height: 80px;
                                background: linear-gradient(135deg, #00c37a 0%, #00a870 100%);
                                border-radius: 50%;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                margin: 0 auto 20px;
                                box-shadow: 0 10px 30px rgba(0, 195, 122, 0.4);
                                animation: pulse 2s infinite;
                            }}

                            @keyframes pulse {{
                                0% {{ transform: scale(1); }}
                                50% {{ transform: scale(1.05); }}
                                100% {{ transform: scale(1); }}
                            }}

                            .success-icon i {{
                                font-size: 2.5rem;
                                color: white;
                            }}

                            .success-title {{
                                color: #00c37a;
                                font-size: 2.5rem;
                                font-weight: 700;
                                margin-bottom: 10px;
                                text-shadow: 0 2px 10px rgba(0, 195, 122, 0.3);
                            }}

                            .success-subtitle {{
                                color: #666;
                                font-size: 1.2rem;
                                margin-bottom: 30px;
                            }}

                            .info-container {{
                                background: rgba(102, 126, 234, 0.1);
                                border-radius: 15px;
                                padding: 25px;
                                margin-bottom: 30px;
                                border-left: 5px solid #667eea;
                            }}

                            .info-item {{
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                margin-bottom: 15px;
                                font-size: 1.1rem;
                            }}

                            .info-item:last-child {{
                                margin-bottom: 0;
                            }}

                            .info-item i {{
                                color: #667eea;
                                margin-right: 12px;
                                font-size: 1.2rem;
                                width: 20px;
                                text-align: center;
                            }}

                            .info-item span {{
                                color: #333;
                                font-weight: 500;
                            }}

                            .buttons-container {{
                                display: flex;
                                flex-direction: column;
                                gap: 15px;
                            }}

                            .action-button {{
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                gap: 15px;
                                padding: 20px 30px;
                                border-radius: 12px;
                                text-decoration: none;
                                font-weight: 600;
                                font-size: 1.1rem;
                                transition: all 0.3s ease;
                                border: none;
                                cursor: pointer;
                                position: relative;
                                overflow: hidden;
                                min-height: 60px;
                            }}

                            .save-button {{
                                background: linear-gradient(135deg, #00c37a 0%, #00a870 100%);
                                color: white;
                                box-shadow: 0 8px 25px rgba(0, 195, 122, 0.4);
                            }}

                            .save-button:hover {{
                                background: linear-gradient(135deg, #00a870 0%, #00c37a 100%);
                                transform: translateY(-2px);
                                box-shadow: 0 12px 35px rgba(0, 195, 122, 0.6);
                            }}

                            .download-button {{
                                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                color: white;
                                box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
                            }}

                            .download-button:hover {{
                                background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
                                transform: translateY(-2px);
                                box-shadow: 0 12px 35px rgba(102, 126, 234, 0.6);
                            }}

                            .upload-button {{
                                background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                                color: white;
                                box-shadow: 0 8px 25px rgba(240, 147, 251, 0.4);
                            }}

                            .upload-button:hover {{
                                background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%);
                                transform: translateY(-2px);
                                box-shadow: 0 12px 35px rgba(240, 147, 251, 0.6);
                            }}

                            .button-icon {{
                                font-size: 1.3rem;
                                width: 24px;
                                text-align: center;
                            }}

                            .button-text {{
                                flex: 1;
                                text-align: center;
                            }}

                            .footer {{
                                text-align: center;
                                margin-top: 30px;
                                color: #666;
                                font-size: 0.9rem;
                            }}
                        </style>
                    </head>
                    <body>
                        <!-- Fondo del mundo EXACTO del site survey -->
                        <div class="world-background"></div>
                        
                        <div class="main-container">
                            <div class="content-card">
                                <div class="header">
                                    <div class="success-icon">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                    <h1 class="success-title">¬°Documento Generado!</h1>
                                    <p class="success-subtitle">Dise√±o de Soluci√≥n completado exitosamente</p>
                                    <div class="llenado-status" id="llenadoStatus"><i class="fas fa-spinner fa-spin"></i> Llenado autom√°tico en progreso...</div>
                                </div>
                                
                                <div class="info-container">
                                    <div class="info-item">
                                        <i class="fas fa-id-card"></i>
                                        <span><strong>ID:</strong> {user_id}</span>
                                    </div>
                                    
                                    <div class="info-item">
                                        <i class="fas fa-map-marker-alt"></i>
                                        <span><strong>Sitio A:</strong> {datos.get('Nombre del sitio A', '')}</span>
                                    </div>
                                    
                                    <div class="info-item">
                                        <i class="fas fa-map-marker-alt"></i>
                                        <span><strong>Sitio B:</strong> {datos.get('Nombre del sitio B', '')}</span>
                                    </div>
                                </div>

                                <div class="buttons-container">
                                    <!-- ===== BOTONES DE ACCI√ìN PRINCIPAL ===== -->
                                    <button onclick="insertarWordEnDiseno('{user_id}', '{fila_idx}', this)" class="action-button upload-button" style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);">
                                        <div class="button-icon">
                                            <i class="fas fa-file-word"></i>
                                        </div>
                                        <div class="button-text">1. An√°lisis de Red y Frecuencia SUBIR WORD</div>
                                    </button>
                                    
                                    <!-- BOT√ìN PARA IM√ÅGENES EL√âCTRICAS -->
                                    <button onclick="insertarImagenesElectricas('{user_id}', '{fila_idx}', this)" class="action-button upload-button" style="background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);">
                                        <div class="button-icon">
                                            <i class="fas fa-bolt"></i>
                                        </div>
                                        <div class="button-text">2. El√©ctricas - Dise√±o Log-Fis (3 Im√°genes)</div>
                                    </button>
                                    
                                    <button onclick="guardarArchivoDiseno('{user_id}', 'diseno_solucion', '{fila_idx}')" class="action-button save-button">
                                        <div class="button-icon">
                                            <i class="fas fa-save"></i>
                                        </div>
                                        <div class="button-text">3. Guardar Archivo</div>
                                    </button>
                                    
                                    <button onclick="almacenarArchivoPermanente('{user_id}', 'diseno_solucion', '{fila_idx}', this)" class="action-button save-button" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);">
                                        <div class="button-icon">
                                            <i class="fas fa-archive"></i>
                                        </div>
                                        <div class="button-text">4. Almacenar Permanente</div>
                                    </button>
                                    
                                    <a href="/descargar_diseno_solucion?user_id={user_id}&fila_idx={fila_idx}" class="action-button download-button">
                                        <div class="button-icon">
                                            <i class="fas fa-download"></i>
                                        </div>
                                        <div class="button-text">5. Descargar Archivo Generado (PtP)</div>
                                    </a>
                                    
                                    
                                    <!-- ===== BOTONES DE NAVEGACI√ìN - PASO 3 ===== -->
                                    <a href="/subir_imagenes_ptp_fotos_a?user_id={user_id}&fila_idx={fila_idx}" class="action-button upload-button">
                                        <div class="button-icon">
                                            <i class="fas fa-images"></i>
                                        </div>
                                        <div class="button-text">16. Ir a Reporte de Planeaci√≥n</div>
                                    </a>
                                    
                                    <a href="/diseno_solucion_directo?user_id={user_id}&fila_idx={fila_idx}&llenado_automatico=true" class="action-button download-button">
                                        <div class="button-icon">
                                            <i class="fas fa-tools"></i>
                                        </div>
                                        <div class="button-text">17. Ir a Dise√±o de Soluci√≥n (DIRECTO)</div>
                                    </a>
                                    
                                    <a href="/gestion_archivos_permanentes.html" class="action-button upload-button" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);">
                                        <div class="button-icon">
                                            <i class="fas fa-archive"></i>
                                        </div>
                                        <div class="button-text">18. Gestionar Archivos Permanentes</div>
                                    </a>
                                </div>
                            </div>
                            
                            <div class="footer">
                                <p>¬© 2024 FANGIO TELECOM. Todos los derechos reservados.</p>
                            </div>
                        </div>

                        <script>
                            console.log('‚úÖ Script cargado correctamente - Funciones disponibles');
                            console.log('üîß Definiendo funciones...');
                            
                            // Funci√≥n para almacenar archivo permanentemente - v2.1 (Fixed)
                            function almacenarArchivoPermanente(userId, tipo, filaIdx, buttonElement) {{
                                console.log('‚úÖ almacenarArchivoPermanente EJECUT√ÅNDOSE:', userId, tipo, filaIdx);
                                
                                // Mostrar indicador de carga
                                const button = buttonElement;
                                const originalText = button.innerHTML;
                                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Almacenando...';
                                button.disabled = true;
                                
                                // Llamar a la API de almacenamiento
                                fetch('/almacenar_archivo_permanente', {{
                                    method: 'POST',
                                    headers: {{
                                        'Content-Type': 'application/json',
                                    }},
                                    body: JSON.stringify({{
                                        user_id: userId,
                                        tipo: tipo,
                                        fila_idx: filaIdx
                                    }})
                                }})
                                .then(response => response.json())
                                .then(data => {{
                                    if (data.success) {{
                                        // Mostrar mensaje de √©xito
                                        alert('‚úÖ Archivo almacenado permanentemente exitosamente\\n\\nüìÅ Ubicaci√≥n: ' + data.ubicacion + '\\nüìÖ Fecha: ' + data.fecha);
                                        
                                        // Cambiar el bot√≥n a estado de √©xito
                                        button.innerHTML = '<i class="fas fa-check-circle"></i> Almacenado';
                                        button.style.background = 'linear-gradient(135deg, #00c37a 0%, #00a870 100%)';
                                        button.disabled = true;
                                        
                                        // Mostrar modal para nuevo llenado
                                        mostrarModalNuevoLlenado();
                                        
                                    }} else {{
                                        // Mostrar mensaje de error
                                        alert('‚ùå Error al almacenar archivo: ' + data.error);
                                        
                                        // Restaurar bot√≥n original
                                        button.innerHTML = originalText;
                                        button.disabled = false;
                                    }}
                                }})
                                .catch(error => {{
                                    console.error('Error:', error);
                                    alert('‚ùå Error de conexi√≥n al almacenar archivo');
                                    
                                    // Restaurar bot√≥n original
                                    button.disabled = false;
                                    button.innerHTML = originalText;
                                }});
                            }}
                            
                            // Funci√≥n para guardar archivo de dise√±o de soluci√≥n
                            function guardarArchivoDiseno(userId, tipo, filaIdx) {{
                                console.log('‚úÖ Guardando archivo de dise√±o de soluci√≥n:', userId, tipo, filaIdx);
                                
                                // Mostrar mensaje de guardado inmediato
                                alert('‚úÖ Archivo guardado exitosamente para ID: ' + userId + '\\nüìÅ Ubicaci√≥n: saved_files/saved_' + userId + '_' + tipo + '.xlsx');
                                
                                // Mostrar modal para agregar otro ID inmediatamente
                                mostrarModalNuevoID();
                            }}
                            
                            // Funci√≥n para mostrar modal de nuevo ID
                            function mostrarModalNuevoID() {{
                                // Crear modal
                                const modal = document.createElement('div');
                                modal.style.cssText = `
                                    position: fixed;
                                    top: 0;
                                    left: 0;
                                    width: 100%;
                                    height: 100%;
                                    background: rgba(0, 0, 0, 0.8);
                                    display: flex;
                                    justify-content: center;
                                    align-items: center;
                                    z-index: 10000;
                                    font-family: 'Montserrat', Arial, sans-serif;
                                `;
                                
                                const modalContent = document.createElement('div');
                                modalContent.style.cssText = `
                                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                    padding: 40px;
                                    border-radius: 20px;
                                    max-width: 500px;
                                    width: 90%;
                                    text-align: center;
                                    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                                    color: white;
                                    position: relative;
                                `;
                                
                                modalContent.innerHTML = `
                                    <div style="margin-bottom: 30px;">
                                        <div style="
                                            width: 80px;
                                            height: 80px;
                                            background: rgba(255, 255, 255, 0.2);
                                            border-radius: 50%;
                                            display: flex;
                                            align-items: center;
                                            justify-content: center;
                                            margin: 0 auto 20px;
                                            font-size: 2.5rem;
                                        ">
                                            üöÄ
                                        </div>
                                        <h2 style="color: white; margin-bottom: 15px; font-size: 1.8rem; font-weight: 700;">
                                            ¬øAgregar Otro ID?
                                        </h2>
                                        <p style="color: rgba(255, 255, 255, 0.9); font-size: 1.1rem; margin-bottom: 25px;">
                                            ¬øTe gustar√≠a procesar otro ID para generar un nuevo dise√±o de soluci√≥n?
                                        </p>
                                    </div>
                                    
                                    <div style="margin-bottom: 30px;">
                                        <input type="text" id="nuevoIdInput" placeholder="Ingresa el nuevo ID..." style="
                                            width: 100%;
                                            padding: 15px;
                                            border: none;
                                            border-radius: 10px;
                                            font-size: 1.1rem;
                                            text-align: center;
                                            background: rgba(255, 255, 255, 0.9);
                                            color: #333;
                                            box-sizing: border-box;
                                            outline: none;
                                            font-weight: 600;
                                        ">
                                    </div>
                                    
                                    <div style="display: flex; gap: 15px; justify-content: center;">
                                        <button id="btnProcesarNuevoID" style="
                                            background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
                                            color: #192133;
                                            border: none;
                                            padding: 15px 25px;
                                            border-radius: 10px;
                                            font-size: 1rem;
                                            font-weight: 700;
                                            cursor: pointer;
                                            transition: all 0.3s ease;
                                            min-width: 140px;
                                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(0, 255, 136, 0.4)'" 
                                           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                            <i class="fas fa-play"></i> Procesar ID
                                        </button>
                                        
                                        <button id="btnCancelarNuevoID" style="
                                            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
                                            color: white;
                                            border: none;
                                            padding: 15px 25px;
                                            border-radius: 10px;
                                            font-size: 1rem;
                                            font-weight: 700;
                                            cursor: pointer;
                                            transition: all 0.3s ease;
                                            min-width: 140px;
                                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(255, 107, 107, 0.4)'" 
                                           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                            <i class="fas fa-times"></i> Cancelar
                                        </button>
                                    </div>
                                `;
                                
                                modal.appendChild(modalContent);
                                document.body.appendChild(modal);
                                
                                // Enfocar el input
                                setTimeout(() => {{
                                    document.getElementById('nuevoIdInput').focus();
                                }}, 100);
                                
                                // Event listeners para los botones
                                document.getElementById('btnProcesarNuevoID').addEventListener('click', function() {{
                                    const nuevoId = document.getElementById('nuevoIdInput').value.trim();
                                    if (nuevoId) {{
                                        // Cerrar modal
                                        document.body.removeChild(modal);
                                        
                                        // Redirigir al dise√±o de soluci√≥n con el nuevo ID
                                        console.log('üöÄ Procesando nuevo ID:', nuevoId);
                                        window.location.href = `/diseno_solucion?user_id=${{nuevoId}}&llenado_automatico=true`;
                                    }} else {{
                                        alert('‚ö†Ô∏è Por favor, ingresa un ID v√°lido');
                                        document.getElementById('nuevoIdInput').focus();
                                    }}
                                }});
                                
                                document.getElementById('btnCancelarNuevoID').addEventListener('click', function() {{
                                    document.body.removeChild(modal);
                                }});
                                
                                // Cerrar modal al hacer clic fuera
                                modal.addEventListener('click', function(e) {{
                                    if (e.target === modal) {{
                                        document.body.removeChild(modal);
                                    }}
                                }});
                                
                                // Permitir Enter en el input
                                document.getElementById('nuevoIdInput').addEventListener('keypress', function(e) {{
                                    if (e.key === 'Enter') {{
                                        document.getElementById('btnProcesarNuevoID').click();
                                    }}
                                }});
                            }}
                            
                            // Funci√≥n para insertar Word en dise√±o de soluci√≥n
                            function insertarWordEnDiseno(userId, filaIdx, buttonElement) {{
                                console.log('Insertando Word en dise√±o de soluci√≥n:', userId, filaIdx);
                                
                                // Crear input de archivo
                                const fileInput = document.createElement('input');
                                fileInput.type = 'file';
                                fileInput.accept = '.doc,.docx';
                                fileInput.style.display = 'none';
                                
                                fileInput.addEventListener('change', function(e) {{
                                    const file = e.target.files[0];
                                    if (file) {{
                                        // Mostrar indicador de carga
                                        const button = buttonElement;
                                        const originalText = button.innerHTML;
                                        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Insertando...';
                                        button.disabled = true;
                                        
                                        // Crear FormData para enviar el archivo
                                        const formData = new FormData();
                                        formData.append('user_id', userId);
                                        formData.append('fila_idx', filaIdx);
                                        formData.append('word_file', file);
                                        
                                        // Enviar al servidor
                                        fetch('/insertar_word_diseno', {{
                                            method: 'POST',
                                            body: formData
                                        }})
                                        .then(response => response.text())
                                        .then(data => {{
                                            // Mostrar mensaje de √©xito
                                            alert('‚úÖ Archivo Word insertado exitosamente en D12 de la hoja "An√°lisis de Red y Frecuencia"');
                                            
                                            // Cambiar el bot√≥n a estado de √©xito
                                            button.innerHTML = '<i class="fas fa-check-circle"></i> Insertado';
                                            button.style.background = 'linear-gradient(135deg, #00c37a 0%, #00a870 100%)';
                                            button.disabled = true;
                                        }})
                                        .catch(error => {{
                                            console.error('Error:', error);
                                            alert('‚ùå Error al insertar archivo Word: ' + error.message);
                                            
                                            // Restaurar bot√≥n original
                                            button.disabled = false;
                                            button.innerHTML = originalText;
                                        }});
                                    }}
                                }});
                                
                                // Simular clic en el input de archivo
                                document.body.appendChild(fileInput);
                                fileInput.click();
                                document.body.removeChild(fileInput);
                            }}
                            
                            // Funci√≥n para insertar im√°genes el√©ctricas en dise√±o de soluci√≥n
                            function insertarImagenesElectricas(userId, filaIdx, buttonElement) {{
                                console.log('Insertando im√°genes el√©ctricas en dise√±o de soluci√≥n:', userId, filaIdx);
                                
                                // Crear input de archivo m√∫ltiple
                                const fileInput = document.createElement('input');
                                fileInput.type = 'file';
                                fileInput.accept = 'image/*';
                                fileInput.multiple = true;
                                fileInput.style.display = 'none';
                                
                                fileInput.addEventListener('change', function(e) {{
                                    const files = e.target.files;
                                    if (files.length > 0) {{
                                        // Mostrar indicador de carga
                                        const button = buttonElement;
                                        const originalText = button.innerHTML;
                                        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Insertando...';
                                        button.disabled = true;
                                        
                                        // Crear FormData para enviar las im√°genes
                                        const formData = new FormData();
                                        formData.append('user_id', userId);
                                        formData.append('fila_idx', filaIdx);
                                        
                                        // Agregar cada imagen
                                        for (let i = 0; i < files.length; i++) {{
                                            formData.append('imagenes_electricas', files[i]);
                                        }}
                                        
                                        // Enviar al servidor
                                        fetch('/insertar_imagenes_electricas_diseno', {{
                                            method: 'POST',
                                            body: formData
                                        }})
                                        .then(response => response.text())
                                        .then(data => {{
                                            // Mostrar mensaje de √©xito
                                            alert('‚úÖ ' + files.length + ' im√°genes el√©ctricas insertadas exitosamente en la hoja "Dise√±o Log-Fis"');
                                            
                                            // Cambiar el bot√≥n a estado de √©xito
                                            button.innerHTML = '<i class="fas fa-check-circle"></i> Insertadas';
                                            button.style.background = 'linear-gradient(135deg, #00c37a 0%, #00a870 100%)';
                                            button.disabled = true;
                                        }})
                                        .catch(error => {{
                                            console.error('Error:', error);
                                            alert('‚ùå Error al insertar im√°genes el√©ctricas: ' + error.message);
                                            
                                            // Restaurar bot√≥n original
                                            button.disabled = false;
                                            button.innerHTML = originalText;
                                        }});
                                    }}
                                }});
                                
                                // Simular clic en el input de archivo
                                document.body.appendChild(fileInput);
                                fileInput.click();
                                document.body.removeChild(fileInput);
                            }}
                            
                            // NUEVA FUNCI√ìN: Modal para nuevo llenado con ID espec√≠fico
                            function mostrarModalNuevoLlenado() {{
                                // Crear modal
                                const modal = document.createElement('div');
                                modal.style.cssText = `
                                    position: fixed;
                                    top: 0;
                                    left: 0;
                                    width: 100%;
                                    height: 100%;
                                    background: rgba(0, 0, 0, 0.8);
                                    display: flex;
                                    justify-content: center;
                                    align-items: center;
                                    z-index: 10000;
                                    font-family: Arial, sans-serif;
                                `;
                                
                                const modalContent = document.createElement('div');
                                modalContent.style.cssText = `
                                    background: white;
                                    padding: 30px;
                                    border-radius: 15px;
                                    max-width: 600px;
                                    text-align: center;
                                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                                `;
                                
                                modalContent.innerHTML = `
                                    <h2 style="color: #4CAF50; margin-bottom: 20px; font-size: 24px;">
                                        üöÄ NUEVO LLENADO AUTOM√ÅTICO
                                    </h2>
                                    
                                    <div style="margin-bottom: 25px; text-align: left;">
                                        <p style="color: #333; font-size: 16px; margin-bottom: 15px;">
                                            <strong>üéØ ¬øQuieres hacer otro llenado autom√°tico?</strong>
                                        </p>
                                        
                                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 4px solid #4CAF50; margin-bottom: 20px;">
                                            <p style="color: #333; font-size: 14px; margin-bottom: 15px;">
                                                <strong>üí° Opciones disponibles:</strong>
                                            </p>
                                            <ul style="color: #666; font-size: 14px; text-align: left; margin-left: 20px;">
                                                <li>‚úÖ <strong>Buscar TODAS las puntas B disponibles</strong> (recomendado)</li>
                                                <li>‚úÖ <strong>Verificar un ID espec√≠fico</strong> que conozcas</li>
                                                <li>‚úÖ <strong>Llenado autom√°tico directo</strong> con la opci√≥n elegida</li>
                                            </ul>
                                        </div>
                                        
                                        <div style="background: #e3f2fd; padding: 20px; border-radius: 10px; border-left: 4px solid #2196f3; margin-bottom: 20px;">
                                            <p style="color: #1565c0; font-size: 14px; margin-bottom: 15px;">
                                                <strong>üîç Verificar ID Espec√≠fico:</strong>
                                            </p>
                                            <div style="display: flex; gap: 10px; align-items: center;">
                                                <input type="text" id="inputUserId" placeholder="Ingresa el ID del usuario" style="
                                                    flex: 1;
                                                    padding: 10px;
                                                    border: 2px solid #e0e0e0;
                                                    border-radius: 8px;
                                                    font-size: 14px;
                                                    transition: border-color 0.3s ease;
                                                " onfocus="this.style.borderColor='#2196f3'" onblur="this.style.borderColor='#e0e0e0'">
                                                <button id="btnVerificarId" style="
                                                    background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
                                                    color: white;
                                                    border: none;
                                                    padding: 10px 15px;
                                                    border-radius: 8px;
                                                    font-size: 14px;
                                                    font-weight: bold;
                                                    cursor: pointer;
                                                    transition: all 0.3s ease;
                                                ">üîç VERIFICAR</button>
                                            </div>
                                            <p style="color: #1565c0; font-size: 12px; margin: 8px 0 0 0;">
                                                <strong>üí°</strong> El sistema verificar√° si este ID tiene puntas B diferentes disponibles para llenado.
                                            </p>
                                        </div>
                                    </div>
                                    
                                    <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                                        <button id="btnBuscarTodas" style="
                                            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
                                            color: white;
                                            border: none;
                                            padding: 12px 25px;
                                            border-radius: 25px;
                                            font-size: 16px;
                                            font-weight: bold;
                                            cursor: pointer;
                                            transition: all 0.3s ease;
                                        ">üîç BUSCAR TODAS LAS OPCIONES</button>
                                        
                                        <button id="btnCancelarLlenado" style="
                                            background: #6c757d;
                                            color: white;
                                            border: none;
                                            padding: 12px 25px;
                                            border-radius: 25px;
                                            font-size: 16px;
                                            font-weight: bold;
                                            cursor: pointer;
                                            transition: all 0.3s ease;
                                        ">‚ùå CANCELAR</button>
                                    </div>
                                `;
                                
                                modal.appendChild(modalContent);
                                document.body.appendChild(modal);
                                
                                // Event listeners para los botones
                                document.getElementById('btnBuscarTodas').addEventListener('click', function() {{
                                    // Buscar todas las opciones disponibles
                                    buscarPuntasBDisponibles();
                                    document.body.removeChild(modal);
                                }});
                                
                                document.getElementById('btnVerificarId').addEventListener('click', function() {{
                                    const userId = document.getElementById('inputUserId').value.trim();
                                    if (userId) {{
                                        verificarIdEspecifico(userId);
                                    document.body.removeChild(modal);
                                    }} else {{
                                        alert('‚ö†Ô∏è Por favor, ingresa un ID v√°lido');
                                        document.getElementById('inputUserId').focus();
                                    }}
                                }});
                                
                                document.getElementById('btnCancelarLlenado').addEventListener('click', function() {{
                                    document.body.removeChild(modal);
                                }});
                                
                                // Cerrar modal al hacer clic fuera
                                modal.addEventListener('click', function(e) {{
                                    if (e.target === modal) {{
                                        document.body.removeChild(modal);
                                    }}
                                }});
                                
                                // Permitir Enter en el input
                                document.getElementById('inputUserId').addEventListener('keypress', function(e) {{
                                    if (e.key === 'Enter') {{
                                        document.getElementById('btnVerificarId').click();
                                    }}
                                }});
                            }}
                            
                            // FUNCI√ìN: Verificar ID espec√≠fico y mostrar opciones
                            function verificarIdEspecifico(userId) {{
                                console.log('üîç Verificando ID espec√≠fico:', userId);
                                
                                // Mostrar indicador de carga
                                mostrarIndicadorCarga('Verificando ID espec√≠fico...');
                                
                                // Llamar a la API para verificar si el ID tiene puntas B disponibles
                                fetch('/verificar_id_especifico', {{
                                    method: 'POST',
                                    headers: {{
                                        'Content-Type': 'application/json',
                                    }},
                                    body: JSON.stringify({{
                                        user_id: userId
                                    }})
                                }})
                                .then(response => response.json())
                                .then(data => {{
                                    ocultarIndicadorCarga();
                                    
                                    if (data.success) {{
                                        if (data.tiene_puntas_b) {{
                                            // Mostrar opciones disponibles para este ID
                                            mostrarOpcionesParaIdEspecifico(userId, data.opciones);
                                        }} else {{
                                            // No tiene puntas B disponibles
                                            alert('‚ùå El ID ' + userId + ' no tiene puntas B diferentes disponibles para llenado autom√°tico.\\n\\nüí° Intenta con otro ID o usa "BUSCAR TODAS LAS OPCIONES" para ver todas las opciones disponibles.');
                                        }}
                                    }} else {{
                                        alert('‚ùå Error al verificar ID: ' + data.error);
                                    }}
                                }})
                                .catch(error => {{
                                    ocultarIndicadorCarga();
                                    console.error('‚ùå Error:', error);
                                    alert('‚ùå Error de conexi√≥n al verificar ID');
                                }});
                            }}
                            
                            // FUNCI√ìN: Mostrar opciones para ID espec√≠fico
                            function mostrarOpcionesParaIdEspecifico(userId, opciones) {{
                                // Crear modal con las opciones del ID espec√≠fico
                                const modal = document.createElement('div');
                                modal.style.cssText = `
                                    position: fixed;
                                    top: 0;
                                    left: 0;
                                    width: 100%;
                                    height: 100%;
                                    background: rgba(0, 0, 0, 0.8);
                                    display: flex;
                                    justify-content: center;
                                    align-items: center;
                                    z-index: 10000;
                                    font-family: 'Montserrat', Arial, sans-serif;
                                `;
                                
                                const modalContent = document.createElement('div');
                                modalContent.style.cssText = `
                                    background: white;
                                    padding: 30px;
                                    border-radius: 15px;
                                    max-width: 800px;
                                    width: 90%;
                                    max-height: 80vh;
                                    overflow-y: auto;
                                    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                                    text-align: center;
                                `;
                                
                                let opcionesHTML = '';
                                opciones.forEach(function(opcion) {{
                                    opcionesHTML += `
                                        <div style="
                                            background: #f8f9fa;
                                            padding: 20px;
                                            border-radius: 10px;
                                            border: 2px solid #e9ecef;
                                            text-align: left;
                                            transition: all 0.3s ease;
                                            cursor: pointer;
                                        " onmouseover="this.style.borderColor='#4CAF50'; this.style.boxShadow='0 5px 15px rgba(76, 175, 80, 0.2)'" onmouseout="this.style.borderColor='#e9ecef'; this.style.boxShadow='none'">
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                                <h3 style="color: #333; font-size: 18px; font-weight: bold; margin: 0;">
                                                    üîë ID: ${{opcion.user_id}}
                                                </h3>
                                                <button onclick="seleccionarOpcion('${{opcion.user_id}}', ${{opcion.fila_idx}})" style="
                                                    background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
                                                    color: white;
                                                    border: none;
                                                    padding: 8px 16px;
                                                    border-radius: 20px;
                                                    font-size: 14px;
                                                    font-weight: bold;
                                                    cursor: pointer;
                                                    transition: all 0.3s ease;
                                                ">üöÄ SELECCIONAR</button>
                                            </div>
                                            
                                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                                <div>
                                                    <strong style="color: #666; font-size: 12px;">üìç SITIO A:</strong>
                                                    <p style="color: #333; font-size: 14px; margin: 5px 0;">${{opcion.sitio_a}}</p>
                                                </div>
                                                <div>
                                                    <strong style="color: #666; font-size: 12px;">üìç SITIO B:</strong>
                                                    <p style="color: #333; font-size: 14px; margin: 5px 0;">${{opcion.sitio_b}}</p>
                                                </div>
                                            </div>
                                            
                                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                                <div>
                                                    <strong style="color: #666; font-size: 12px;">üè¢ CLIENTE:</strong>
                                                    <p style="color: #333; font-size: 14px; margin: 5px 0;">${{opcion.cliente || 'N/A'}}</p>
                                                </div>
                                                <div>
                                                    <strong style="color: #666; font-size: 12px;">üìã PROYECTO:</strong>
                                                    <p style="color: #333; font-size: 14px; margin: 5px 0;">${{opcion.proyecto || 'N/A'}}</p>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }});
                                
                                modalContent.innerHTML = `
                                    <h2 style="color: #333; margin-bottom: 25px; font-size: 24px; font-weight: bold;">
                                        üéØ OPCIONES DISPONIBLES PARA ID: {user_id}
                                    </h2>
                                    
                                    <div style="background: #e8f5e8; padding: 20px; border-radius: 10px; border-left: 4px solid #28a745; margin-bottom: 25px;">
                                        <p style="color: #155724; font-size: 14px; margin: 0;">
                                            <strong>‚úÖ Se encontraron ${{opciones.length}} opciones con puntas B diferentes para el ID {user_id}.</strong>
                                        </p>
                                    </div>
                                    
                                    <div style="margin-bottom: 25px;">
                                        <div style="display: grid; gap: 15px; max-height: 400px; overflow-y: auto;">
                                            ${{opcionesHTML}}
                                        </div>
                                    </div>
                                    
                                    <div style="display: flex; gap: 15px; justify-content: center;">
                                        <button onclick="document.body.removeChild(modal)" style="
                                            background: #6c757d;
                                            color: white;
                                            border: none;
                                            padding: 12px 25px;
                                            border-radius: 25px;
                                            font-size: 16px;
                                            font-weight: bold;
                                            cursor: pointer;
                                            transition: all 0.3s ease;
                                        ">‚ùå CERRAR</button>
                                    </div>
                                `;
                                
                                modal.appendChild(modalContent);
                                document.body.appendChild(modal);
                            }}
                            
                            // FUNCI√ìN: Mostrar indicador de carga global
                                function mostrarIndicadorCarga(mensaje = 'Cargando...') {{
                                    // Crear o actualizar indicador de carga
                                    let indicador = document.getElementById('indicadorCargaGlobal');
                                    if (!indicador) {{
                                        indicador = document.createElement('div');
                                        indicador.id = 'indicadorCargaGlobal';
                                        indicador.style.cssText = `
                                            position: fixed;
                                            top: 20px;
                                            right: 20px;
                                            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
                                            color: white;
                                            padding: 15px 20px;
                                            border-radius: 25px;
                                            font-weight: bold;
                                            z-index: 10001;
                                            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                                            display: flex;
                                            align-items: center;
                                            gap: 10px;
                                        `;
                                        document.body.appendChild(indicador);
                                    }}
                                    
                                    indicador.innerHTML = `
                                        <i class="fas fa-spinner fa-spin"></i>
                                        <span>${{mensaje}}</span>
                                    `;
                                    indicador.style.display = 'flex';
                                }}
                                
                                // FUNCI√ìN: Ocultar indicador de carga global
                                function ocultarIndicadorCarga() {{
                                    const indicador = document.getElementById('indicadorCargaGlobal');
                                    if (indicador) {{
                                        indicador.style.display = 'none';
                                    }}
                                }}
                                
                                // Funci√≥n para buscar todas las puntas B disponibles
                                function buscarPuntasBDisponibles() {{
                                    console.log('üîç Buscando puntas B disponibles...');
                                    
                                    // Mostrar indicador de carga
                                    mostrarIndicadorCarga('Buscando opciones disponibles...');
                                    
                                    fetch('/buscar_puntas_b_disponibles', {{
                                        method: 'POST',
                                        headers: {{
                                            'Content-Type': 'application/json',
                                        }},
                                        body: JSON.stringify({{
                                            // No necesitamos user_id para esta b√∫squeda
                                        }})
                                    }})
                                    .then(response => response.json())
                                    .then(data => {{
                                        ocultarIndicadorCarga();
                                        
                                        if (data.success) {{
                                            console.log('‚úÖ Opciones encontradas:', data.opciones);
                                            mostrarOpcionesDisponibles(data.opciones);
                                        }} else {{
                                            alert('‚ùå Error al buscar opciones: ' + data.error);
                                        }}
                                    }})
                                    .catch(error => {{
                                        ocultarIndicadorCarga();
                                        console.error('‚ùå Error:', error);
                                        alert('‚ùå Error de conexi√≥n al buscar opciones');
                                    }});
                                }}
                                
                                // Funci√≥n para mostrar las opciones disponibles
                                function mostrarOpcionesDisponibles(opciones) {{
                                    // Cerrar el modal actual
                                    document.body.removeChild(modal);
                                    
                                    // Crear nuevo modal con las opciones
                                    const modalOpciones = document.createElement('div');
                                    modalOpciones.style.cssText = `
                                        position: fixed;
                                        top: 0;
                                        left: 0;
                                        width: 100%;
                                        height: 100%;
                                        background: rgba(0, 0, 0, 0.8);
                                        display: flex;
                                        justify-content: center;
                                        align-items: center;
                                        z-index: 10000;
                                        font-family: 'Montserrat', Arial, sans-serif;
                                    `;
                                    
                                    const modalContentOpciones = document.createElement('div');
                                    modalContentOpciones.style.cssText = `
                                        background: white;
                                        padding: 30px;
                                        border-radius: 15px;
                                        max-width: 800px;
                                        width: 90%;
                                        max-height: 80vh;
                                        overflow-y: auto;
                                        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                                        text-align: center;
                                    `;
                                    
                                    let opcionesHTML = '';
                                    opciones.forEach(function(opcion) {{
                                        opcionesHTML += `
                                            <div style="
                                                background: #f8f9fa;
                                                padding: 20px;
                                                border-radius: 10px;
                                                border: 2px solid #e9ecef;
                                                text-align: left;
                                                transition: all 0.3s ease;
                                                cursor: pointer;
                                            " onmouseover="this.style.borderColor='#4CAF50'; this.style.boxShadow='0 5px 15px rgba(76, 175, 80, 0.2)'" onmouseout="this.style.borderColor='#e9ecef'; this.style.boxShadow='none'">
                                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                                    <h3 style="color: #333; font-size: 18px; font-weight: bold; margin: 0;">
                                                        üîë ID: ${{opcion.user_id}}
                                                    </h3>
                                                    <button onclick="seleccionarOpcion('${{opcion.user_id}}', ${{opcion.fila_idx}})" style="
                                                        background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
                                                        color: white;
                                                        border: none;
                                                        padding: 8px 16px;
                                                        border-radius: 20px;
                                                        font-size: 14px;
                                                        font-weight: bold;
                                                        cursor: pointer;
                                                        transition: all 0.3s ease;
                                                    ">üöÄ SELECCIONAR</button>
                                                </div>
                                                
                                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                                    <div>
                                                        <strong style="color: #666; font-size: 12px;">üìç SITIO A:</strong>
                                                        <p style="color: #333; font-size: 14px; margin: 5px 0;">${{opcion.sitio_a}}</p>
                                                    </div>
                                                    <div>
                                                        <strong style="color: #666; font-size: 12px;">üìç SITIO B:</strong>
                                                        <p style="color: #333; font-size: 14px; margin: 5px 0;">${{opcion.sitio_b}}</p>
                                                    </div>
                                                </div>
                                                
                                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                                    <div>
                                                        <strong style="color: #666; font-size: 12px;">üè¢ CLIENTE:</strong>
                                                        <p style="color: #333; font-size: 14px; margin: 5px 0;">${{opcion.cliente || 'N/A'}}</p>
                                                    </div>
                                                    <div>
                                                        <strong style="color: #666; font-size: 12px;">üìã PROYECTO:</strong>
                                                        <p style="color: #333; font-size: 14px; margin: 5px 0;">${{opcion.proyecto || 'N/A'}}</p>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }});
                                    
                                    modalContentOpciones.innerHTML = `
                                        <h2 style="color: #333; margin-bottom: 25px; font-size: 24px; font-weight: bold;">
                                            üéØ OPCIONES DISPONIBLES PARA LLENADO
                                        </h2>
                                        
                                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 4px solid #4CAF50; margin-bottom: 25px;">
                                            <p style="color: #333; font-size: 14px; margin: 0;">
                                                <strong>üí° Se encontraron ${{opciones.length}} usuarios con puntas B diferentes disponibles para llenado autom√°tico.</strong>
                                            </p>
                                        </div>
                                        
                                        <div style="margin-bottom: 25px;">
                                            <div style="display: grid; gap: 15px; max-height: 400px; overflow-y: auto;">
                                                ${{opcionesHTML}}
                                            </div>
                                        </div>
                                        
                                        <div style="display: flex; gap: 15px; justify-content: center;">
                                            <button onclick="document.body.removeChild(modalOpciones)" style="
                                                background: #6c757d;
                                                color: white;
                                                border: none;
                                                padding: 12px 25px;
                                                border-radius: 25px;
                                                font-size: 16px;
                                                font-weight: bold;
                                                cursor: pointer;
                                                transition: all 0.3s ease;
                                            ">‚ùå CERRAR</button>
                                        </div>
                                    `;
                                    
                                    modalOpciones.appendChild(modalContentOpciones);
                                    document.body.appendChild(modalOpciones);
                            }}
                            
                            // FUNCI√ìN: Iniciar nuevo llenado autom√°tico
                            function iniciarNuevoLlenado(userId) {{
                                console.log('Iniciando nuevo llenado para usuario:', userId);
                                
                                // Mostrar indicador de carga global
                                mostrarIndicadorCarga('Iniciando nuevo llenado...');
                                
                                // Llamar a la API para verificar punta B y iniciar llenado
                                fetch('/verificar_punta_b_e_iniciar_llenado', {{
                                    method: 'POST',
                                    headers: {{
                                        'Content-Type': 'application/json',
                                    }},
                                    body: JSON.stringify({{
                                        user_id: userId
                                    }})
                                }})
                                .then(response => response.json())
                                .then(data => {{
                                    if (data.success) {{
                                        // Mostrar mensaje de √©xito
                                        alert('‚úÖ Nuevo llenado iniciado exitosamente\\n\\nüîë Usuario: ' + userId + '\\nüìä Estado: ' + data.mensaje);
                                        
                                        // Ocultar indicador de carga
                                        ocultarIndicadorCarga();
                                        
                                        // Redirigir a la p√°gina de dise√±o de soluci√≥n con llenado autom√°tico
                                        const filaIdx = data.datos.fila_idx;
                                        console.log('üîÑ Redirigiendo a dise√±o de soluci√≥n con llenado autom√°tico...');
                                        window.location.href = `/diseno_solucion?user_id=${{userId}}&fila_idx=${{filaIdx}}&llenado_automatico=true`;
                                    }} else {{
                                        // Mostrar mensaje de error
                                        alert('‚ùå Error al iniciar llenado: ' + data.error);
                                        
                                        // Ocultar indicador de carga
                                        ocultarIndicadorCarga();
                                    }}
                                }})
                                .catch(error => {{
                                    console.error('Error:', error);
                                    alert('‚ùå Error de conexi√≥n al iniciar llenado');
                                    
                                    // Ocultar indicador de carga
                                    ocultarIndicadorCarga();
                                }});
                            }}
                            
                                // Funci√≥n para seleccionar una opci√≥n
                                function seleccionarOpcion(userId, filaIdx) {{
                                    console.log('üéØ Opci√≥n seleccionada:', userId, filaIdx);
                                    
                                    // Cerrar modal de opciones
                                    const modalOpciones = document.querySelector('div[style*="z-index: 10000"]');
                                    if (modalOpciones) {{
                                        document.body.removeChild(modalOpciones);
                                    }}
                                    
                                    // Iniciar llenado con la opci√≥n seleccionada
                                    iniciarNuevoLlenado(userId);
                                }}
                            }}
                            

                            
                            // NUEVA FUNCI√ìN: Insertar Word en Dise√±o de Soluci√≥n
                            function insertarWordEnDiseno(userId, filaIdx, buttonElement) {{
                                console.log('Insertando Word en dise√±o de soluci√≥n:', userId, filaIdx);
                                
                                // Crear input de archivo
                                const fileInput = document.createElement('input');
                                fileInput.type = 'file';
                                fileInput.accept = '.doc,.docx';
                                fileInput.style.display = 'none';
                                
                                fileInput.addEventListener('change', function(e) {{
                                    const file = e.target.files[0];
                                    if (file) {{
                                        // Mostrar indicador de carga
                                        const button = buttonElement;
                                        const originalText = button.innerHTML;
                                        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Insertando...';
                                        button.disabled = true;
                                        
                                        // Crear FormData para enviar el archivo
                                        const formData = new FormData();
                                        formData.append('user_id', userId);
                                        formData.append('fila_idx', filaIdx);
                                        formData.append('word_file', file);
                                        
                                        // Enviar al servidor
                                        fetch('/insertar_word_diseno', {{
                                            method: 'POST',
                                            body: formData
                                        }})
                                        .then(response => response.text())
                                        .then(data => {{
                                            // Mostrar mensaje de √©xito
                                            alert('‚úÖ Archivo Word insertado exitosamente en D12 de la hoja "An√°lisis de Red y Frecuencia"');
                                            
                                            // Cambiar el bot√≥n a estado de √©xito
                                            button.innerHTML = '<i class="fas fa-check-circle"></i> Insertado';
                                            button.style.background = 'linear-gradient(135deg, #00c37a 0%, #00a870 100%)';
                                            button.disabled = true;
                                        }})
                                        .catch(error => {{
                                            console.error('Error:', error);
                                            alert('‚ùå Error al insertar archivo Word: ' + error.message);
                                            
                                            // Restaurar bot√≥n original
                                            button.disabled = false;
                                            button.innerHTML = originalText;
                                        }});
                                    }}
                                }});
                                
                                // Simular clic en el input de archivo
                                document.body.appendChild(fileInput);
                                fileInput.click();
                                document.body.removeChild(fileInput);
                            }}
                            
                            // NUEVA FUNCI√ìN: Insertar Im√°genes El√©ctricas
                            function insertarImagenesElectricas(userId, filaIdx, buttonElement) {{
                                console.log('Insertando im√°genes el√©ctricas en dise√±o de soluci√≥n:', userId, filaIdx);
                                
                                // Crear modal explicativo
                                const modal = document.createElement('div');
                                modal.style.cssText = `
                                    position: fixed;
                                    top: 0;
                                    left: 0;
                                    width: 100%;
                                    height: 100%;
                                    background: rgba(0, 0, 0, 0.8);
                                    display: flex;
                                    justify-content: center;
                                    align-items: center;
                                    z-index: 10000;
                                    font-family: Arial, sans-serif;
                                `;
                                
                                const modalContent = document.createElement('div');
                                modalContent.style.cssText = `
                                    background: white;
                                    padding: 30px;
                                    border-radius: 15px;
                                    max-width: 600px;
                                    text-align: center;
                                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                                `;
                                
                                modalContent.innerHTML = `
                                    <h2 style="color: #FF6B35; margin-bottom: 20px; font-size: 24px;">
                                        ‚ö° IM√ÅGENES EL√âCTRICAS - DISE√ëO LOG-FIS
                                    </h2>
                                    
                                    <div style="margin-bottom: 25px; text-align: left;">
                                        <p style="color: #333; font-size: 16px; margin-bottom: 15px;">
                                            <strong>üìã INSTRUCCIONES:</strong> Selecciona cada imagen individualmente para ver la previsualizaci√≥n:
                                        </p>
                                        
                                        <!-- IMAGEN 1 -->
                                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 4px solid #FF6B35; margin-bottom: 15px;">
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                                <div>
                                                    <span style="background: #FF6B35; color: white; padding: 5px 10px; border-radius: 20px; font-weight: bold; margin-right: 10px;">IMAGEN 1</span>
                                                    <span style="color: #333; font-weight: bold;">Posici√≥n: C14 hasta D20</span>
                                                </div>
                                                <button id="btnImagen1" style="
                                                    background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
                                                    color: white;
                                                    border: none;
                                                    padding: 8px 16px;
                                                    border-radius: 20px;
                                                    font-size: 14px;
                                                    font-weight: bold;
                                                    cursor: pointer;
                                                ">üì∏ SELECCIONAR IMAGEN 1</button>
                                            </div>
                                            <div id="preview1" style="text-align: center; min-height: 60px; display: flex; align-items: center; justify-content: center;">
                                                <span style="color: #999; font-style: italic;">No se ha seleccionado imagen</span>
                                            </div>
                                        </div>
                                        
                                        <!-- IMAGEN 2 -->
                                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 4px solid #FF6B35; margin-bottom: 15px;">
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                                <div>
                                                    <span style="background: #FF6B35; color: white; padding: 5px 10px; border-radius: 20px; font-weight: bold; margin-right: 10px;">IMAGEN 2</span>
                                                    <span style="color: #333; font-weight: bold;">Posici√≥n: E14 hasta G20</span>
                                                </div>
                                                <button id="btnImagen2" style="
                                                    background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
                                                    color: white;
                                                    border: none;
                                                    padding: 8px 16px;
                                                    border-radius: 20px;
                                                    font-size: 14px;
                                                    font-weight: bold;
                                                    cursor: pointer;
                                                ">üì∏ SELECCIONAR IMAGEN 2</button>
                                            </div>
                                            <div id="preview2" style="text-align: center; min-height: 60px; display: flex; align-items: center; justify-content: center;">
                                                <span style="color: #999; font-style: italic;">No se ha seleccionado imagen</span>
                                            </div>
                                        </div>
                                        
                                        <!-- IMAGEN 3 -->
                                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 4px solid #FF6B35; margin-bottom: 15px;">
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                                <div>
                                                    <span style="background: #FF6B35; color: white; padding: 5px 10px; border-radius: 20px; font-weight: bold; margin-right: 10px;">IMAGEN 3</span>
                                                    <span style="color: #333; font-weight: bold;">Posici√≥n: B39 hasta G55</span>
                                                </div>
                                                <button id="btnImagen3" style="
                                                    background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
                                                    color: white;
                                                    border: none;
                                                    padding: 8px 16px;
                                                    border-radius: 20px;
                                                    font-size: 14px;
                                                    font-weight: bold;
                                                    cursor: pointer;
                                                ">üì∏ SELECCIONAR IMAGEN 3</button>
                                            </div>
                                            <div id="preview3" style="text-align: center; min-height: 60px; display: flex; align-items: center; justify-content: center;">
                                                <span style="color: #999; font-style: italic;">No se ha seleccionado imagen</span>
                                            </div>
                                        </div>
                                        
                                        <p style="color: #666; font-size: 14px; margin-top: 15px; font-style: italic;">
                                            üí° <strong>Tip:</strong> Revisa cada imagen antes de proceder. Las im√°genes se insertar√°n autom√°ticamente en las posiciones correctas del Excel
                                        </p>
                                    </div>
                                    
                                    <div style="display: flex; gap: 15px; justify-content: center;">
                                        <button id="btnProcesar" style="
                                            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
                                            color: white;
                                            border: none;
                                            padding: 12px 25px;
                                            border-radius: 25px;
                                            font-size: 16px;
                                            font-weight: bold;
                                            cursor: pointer;
                                            transition: all 0.3s ease;
                                            display: none;
                                        ">üöÄ PROCESAR LAS 3 IM√ÅGENES</button>
                                        
                                        <button id="btnCancelar" style="
                                            background: #6c757d;
                                            color: white;
                                            border: none;
                                            padding: 12px 25px;
                                            border-radius: 25px;
                                            font-size: 16px;
                                            font-weight: bold;
                                            cursor: pointer;
                                            transition: all 0.3s ease;
                                        ">‚ùå CANCELAR</button>
                                    </div>
                                `;
                                
                                modal.appendChild(modalContent);
                                document.body.appendChild(modal);
                                
                                // Variables para almacenar las im√°genes seleccionadas
                                let imagen1 = null;
                                let imagen2 = null;
                                let imagen3 = null;
                                
                                // Funci√≥n para verificar si todas las im√°genes est√°n seleccionadas
                                function verificarImagenesCompletas() {{
                                    if (imagen1 && imagen2 && imagen3) {{
                                        document.getElementById('btnProcesar').style.display = 'inline-block';
                                    }}
                                }}
                                
                                // Funci√≥n para mostrar previsualizaci√≥n
                                function mostrarPreview(imagen, previewId, nombre) {{
                                    const preview = document.getElementById(previewId);
                                    if (imagen) {{
                                        const reader = new FileReader();
                                        reader.onload = function(e) {{
                                            preview.innerHTML = `
                                                <div style="text-align: center;">
                                                    <img src="${{e.target.result}}" style="max-width: 200px; max-height: 150px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);" />
                                                    <div style="margin-top: 8px; color: #4CAF50; font-weight: bold;">‚úÖ ${{nombre}} seleccionada</div>
                                                </div>
                                            `;
                                        }};
                                        reader.readAsDataURL(imagen);
                                    }}
                                }}
                                
                                // Event listeners para los botones de imagen individual
                                document.getElementById('btnImagen1').addEventListener('click', function() {{
                                    const fileInput = document.createElement('input');
                                    fileInput.type = 'file';
                                    fileInput.accept = 'image/*';
                                    fileInput.style.display = 'none';
                                    
                                    fileInput.addEventListener('change', function(e) {{
                                        const file = e.target.files[0];
                                        if (file) {{
                                            imagen1 = file;
                                            mostrarPreview(file, 'preview1', file.name);
                                            verificarImagenesCompletas();
                                        }}
                                    }});
                                    
                                    document.body.appendChild(fileInput);
                                    fileInput.click();
                                    document.body.removeChild(fileInput);
                                }});
                                
                                document.getElementById('btnImagen2').addEventListener('click', function() {{
                                    const fileInput = document.createElement('input');
                                    fileInput.type = 'file';
                                    fileInput.accept = 'image/*';
                                    fileInput.style.display = 'none';
                                    
                                    fileInput.addEventListener('change', function(e) {{
                                        const file = e.target.files[0];
                                        if (file) {{
                                            imagen2 = file;
                                            mostrarPreview(file, 'preview2', file.name);
                                            verificarImagenesCompletas();
                                        }}
                                    }});
                                    
                                    document.body.appendChild(fileInput);
                                    fileInput.click();
                                    document.body.removeChild(fileInput);
                                }});
                                
                                document.getElementById('btnImagen3').addEventListener('click', function() {{
                                    const fileInput = document.createElement('input');
                                    fileInput.type = 'file';
                                    fileInput.accept = 'image/*';
                                    fileInput.style.display = 'none';
                                    
                                    fileInput.addEventListener('change', function(e) {{
                                        const file = e.target.files[0];
                                        if (file) {{
                                            imagen3 = file;
                                            mostrarPreview(file, 'preview3', file.name);
                                            verificarImagenesCompletas();
                                        }}
                                    }});
                                    
                                    document.body.appendChild(fileInput);
                                    fileInput.click();
                                    document.body.removeChild(fileInput);
                                }});
                                
                                // Event listener para el bot√≥n de procesar
                                document.getElementById('btnProcesar').addEventListener('click', function() {{
                                    // Mostrar indicador de carga
                                    const button = buttonElement;
                                    const originalText = button.innerHTML;
                                    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Insertando 3 Im√°genes...';
                                    button.disabled = true;
                                    
                                    // Crear FormData para enviar las im√°genes
                                    const formData = new FormData();
                                    formData.append('user_id', userId);
                                    formData.append('fila_idx', filaIdx);
                                    formData.append('tipo', 'insertar_imagenes_electricas'); // Tipo espec√≠fico para solo insertar im√°genes
                                    
                                    // Agregar las 3 im√°genes con nombres espec√≠ficos
                                    formData.append('imagen_electrica_1', imagen1); // Para C14:D20
                                    formData.append('imagen_electrica_2', imagen2); // Para E14:G20
                                    formData.append('imagen_electrica_3', imagen3); // Para B39:G55
                                    
                                    // Enviar al servidor
                                    fetch('/insertar_imagenes_electricas', {{
                                        method: 'POST',
                                        body: formData
                                    }})
                                    .then(response => response.text())
                                    .then(data => {{
                                        // Mostrar mensaje de √©xito
                                        alert('‚úÖ 3 Im√°genes El√©ctricas insertadas exitosamente:\\n\\nüì∏ Imagen 1: C14:D20\\nüì∏ Imagen 2: E14:G20\\nüì∏ Imagen 3: B39:G55');
                                        
                                        // Cerrar modal
                                        document.body.removeChild(modal);
                                        
                                        // Cambiar el bot√≥n a estado de √©xito
                                        button.innerHTML = '<i class="fas fa-check-circle"></i> Im√°genes Insertadas';
                                        button.style.background = 'linear-gradient(135deg, #00c37a 0%, #00a870 100%)';
                                        button.disabled = true;
                                    }})
                                    .catch(error => {{
                                        console.error('Error:', error);
                                        alert('‚ùå Error al insertar im√°genes el√©ctricas: ' + error.message);
                                        
                                        // Restaurar bot√≥n original
                                        button.disabled = false;
                                        button.innerHTML = originalText;
                                    }});
                                }});
                                
                                document.getElementById('btnCancelar').addEventListener('click', function() {{
                                    document.body.removeChild(modal);
                                }});
                                
                                // Cerrar modal al hacer clic fuera
                                modal.addEventListener('click', function(e) {{
                                    if (e.target === modal) {{
                                        document.body.removeChild(modal);
                                    }}
                                }});
                            }}
                            
                            // Actualizar el estado del llenado autom√°tico con timeout y manejo de errores
                            let llenadoTimeout = setTimeout(function() {{
                                const llenadoStatus = document.getElementById('llenadoStatus');
                                if (llenadoStatus) {{
                                    llenadoStatus.innerHTML = '<i class="fas fa-check-circle"></i> Llenado autom√°tico completado';
                                    llenadoStatus.style.color = '#00c37a';
                                }}
                            }}, 5000); // 5 segundos para simular el proceso real
                            
                            // Timeout de seguridad para evitar que se quede colgado indefinidamente
                            setTimeout(function() {{
                                const llenadoStatus = document.getElementById('llenadoStatus');
                                if (llenadoStatus && llenadoStatus.innerHTML.includes('en progreso')) {{
                                    llenadoStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Llenado autom√°tico completado (timeout)';
                                    llenadoStatus.style.color = '#ffc107';
                                    console.log('‚ö†Ô∏è Llenado autom√°tico completado por timeout de seguridad');
                                }}
                            }}, 15000); // 15 segundos m√°ximo
                        </script>
                    </body>
                    </html>
                    """
                    
            except Exception as e:
                print(f"‚ùå Error ejecutando llenado autom√°tico: {e}")
                # Continuar de todas formas para mostrar el modal
        
        # --- NUEVO: MODAL REAL DE POST-GENERACI√ìN ---
        print("üîß DEBUG: Mostrando modal real de post-generaci√≥n")
        
        # Crear HTML del modal real con fondo oscuro, estrellas y Tierra
        html_modal = f"""
        <!DOCTYPE html>
        <html lang="es">
        <head>
            <meta charset="UTF-8">
            <title>FANGIO TELECOM | Documento Generado</title>
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
            <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
            <style>
                * {{
                    margin: 0;
                    padding: 0;
                    box-sizing: border-box;
                }}

                body {{
                    font-family: 'Montserrat', Arial, sans-serif;
                    min-height: 100vh;
                    background-color: #0a192f;
                    background-size: cover;
                    background-position: center;
                    background-attachment: fixed;
                    background-repeat: no-repeat;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                    position: relative;
                    overflow-x: hidden;
                    color: #e0e7ef;
                }}

                /* Overlay para mejorar la legibilidad */
                body::before {{
                    content: '';
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: 
                        radial-gradient(ellipse at top, rgba(0, 0, 0, 0.2) 0%, transparent 50%),
                        radial-gradient(ellipse at bottom, rgba(0, 0, 0, 0.4) 0%, transparent 50%);
                    z-index: 1;
                    pointer-events: none;
                }}

                /* Efecto de estrellas sutiles */
                body::after {{
                    content: '';
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background-image: 
                        radial-gradient(1px 1px at 10% 20%, rgba(255, 255, 255, 0.8), transparent),
                        radial-gradient(1px 1px at 20% 80%, rgba(255, 255, 255, 0.6), transparent),
                        radial-gradient(1px 1px at 80% 30%, rgba(255, 255, 255, 0.9), transparent),
                        radial-gradient(1px 1px at 90% 70%, rgba(255, 255, 255, 0.7), transparent);
                    background-size: 400px 400px, 300px 300px, 500px 500px, 350px 350px;
                    animation: twinkle 8s ease-in-out infinite;
                    z-index: 2;
                    pointer-events: none;
                }}

                /* Fondo del mundo EXACTO del site survey */
                .world-background {{
                    position: fixed;
                    bottom: 0;
                    left: 0;
                    right: 0;
                    height: 100vh;
                    background: 
                        linear-gradient(to top, rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.3)),
                        url('/static/images/earth-background.jpg');
                    background-size: cover;
                    background-position: center bottom;
                    background-repeat: no-repeat;
                    z-index: 3;
                    pointer-events: none;
                }}

                @keyframes twinkle {{
                    0%, 100% {{ opacity: 0.3; }}
                    50% {{ opacity: 1; }}
                }}

                .main-container {{
                    position: relative;
                    z-index: 10;
                    width: 100%;
                    max-width: 1200px;
                    margin: 0 auto;
                    padding: 20px;
                }}

                .content-card {{
                    background: #1a1a2e;
                    backdrop-filter: blur(20px);
                    border-radius: 25px;
                    padding: 50px;
                    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5), 0 0 30px rgba(0, 195, 255, 0.3);
                    border: 2px solid rgba(0, 195, 255, 0.5);
                    min-width: 800px;
                    color: white;
                    position: relative;
                    overflow: hidden;
                }}

                .content-card::before {{
                    content: '';
                    position: absolute;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%);
                    animation: shine 3s ease-in-out infinite;
                    z-index: 1;
                }}

                @keyframes shine {{
                    0% {{ transform: translateX(-100%); }}
                    100% {{ transform: translateX(100%); }}
                }}

                .header {{
                    text-align: center;
                    margin-bottom: 40px;
                    position: relative;
                    z-index: 2;
                }}

                .header h1 {{
                    font-size: 2.5rem;
                    font-weight: 800;
                    color: #00c3ff;
                    margin-bottom: 15px;
                    text-shadow: 0 0 20px rgba(0, 195, 255, 0.5);
                }}

                .header p {{
                    font-size: 1.2rem;
                    color: #e0e7ef;
                    font-weight: 500;
                }}

                .success-icon {{
                    font-size: 4rem;
                    color: #00c3ff;
                    margin-bottom: 20px;
                    text-shadow: 0 0 30px rgba(0, 195, 255, 0.8);
                    animation: pulse 2s ease-in-out infinite;
                }}

                @keyframes pulse {{
                    0%, 100% {{ transform: scale(1); }}
                    50% {{ transform: scale(1.1); }}
                }}

                .info-container {{
                    background: rgba(26, 26, 46, 0.8);
                    border-radius: 15px;
                    padding: 25px;
                    margin: 30px 0;
                    border: 1px solid rgba(0, 195, 255, 0.3);
                    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
                }}

                .info-item {{
                    display: flex;
                    align-items: center;
                    gap: 15px;
                    margin-bottom: 15px;
                    padding: 12px 0;
                    border-bottom: 1px solid rgba(0, 195, 255, 0.1);
                }}

                .info-item:last-child {{
                    border-bottom: none;
                    margin-bottom: 0;
                }}

                .info-item i {{
                    color: #00c3ff;
                    font-size: 1.2rem;
                    min-width: 25px;
                }}

                .info-item span {{
                    color: #e0e7ef;
                    font-size: 1.1rem;
                }}

                .info-item strong {{
                    color: #00c3ff;
                    font-weight: 600;
                }}

                .llenado-status {{
                    background: linear-gradient(135deg, #00c3ff 0%, #0099cc 100%);
                    color: white;
                    padding: 15px 25px;
                    border-radius: 10px;
                    margin-top: 20px;
                    font-weight: 600;
                    text-align: center;
                    box-shadow: 0 8px 25px rgba(0, 195, 255, 0.3);
                    animation: pulse 2s ease-in-out infinite;
                }}

                .llenado-status i {{
                    margin-right: 10px;
                    color: white;
                }}

                .llenado-status.completed {{
                    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                    animation: none;
                }}

                .llenado-status.completed i {{
                    color: white;
                }}

                .buttons-container {{
                    display: flex;
                    flex-direction: column;
                    gap: 15px;
                    margin-top: 30px;
                    position: relative;
                    z-index: 2;
                }}

                .action-button {{
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 15px;
                    padding: 20px 30px;
                    border-radius: 15px;
                    text-decoration: none;
                    font-weight: 600;
                    font-size: 1.1rem;
                    transition: all 0.3s ease;
                    border: none;
                    cursor: pointer;
                    position: relative;
                    overflow: hidden;
                    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
                }}

                .action-button::before {{
                    content: '';
                    position: absolute;
                    top: 0;
                    left: -100%;
                    width: 100%;
                    height: 100%;
                    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
                    transition: left 0.5s;
                }}

                .action-button:hover::before {{
                    left: 100%;
                }}

                .action-button:hover {{
                    transform: translateY(-3px);
                    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
                }}

                .save-button {{
                    background: linear-gradient(135deg, #00c3ff 0%, #0099cc 100%);
                    color: white;
                    box-shadow: 0 8px 25px rgba(0, 195, 255, 0.3);
                }}

                .download-button {{
                    background: linear-gradient(135deg, #374151 0%, #1f2937 100%);
                    color: white;
                    box-shadow: 0 8px 25px rgba(55, 65, 81, 0.3);
                }}

                .upload-button {{
                    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                    color: white;
                    box-shadow: 0 8px 25px rgba(26, 26, 46, 0.3);
                    border: 1px solid rgba(0, 195, 255, 0.3);
                }}

                .navigation-button {{
                    background: linear-gradient(135deg, #00c3ff 0%, #0099cc 100%);
                    color: white;
                    box-shadow: 0 8px 25px rgba(0, 195, 255, 0.3);
                }}

                .file-manager-button {{
                    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                    color: white;
                    box-shadow: 0 8px 25px rgba(26, 26, 46, 0.3);
                    border: 1px solid rgba(0, 195, 255, 0.3);
                }}

                .home-button {{
                    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                    color: white;
                    box-shadow: 0 8px 25px rgba(26, 26, 46, 0.3);
                    border: 1px solid rgba(0, 195, 255, 0.3);
                }}

                .test-button {{
                    background: linear-gradient(135deg, #374151 0%, #1f2937 100%);
                    color: white;
                    box-shadow: 0 8px 25px rgba(55, 65, 81, 0.3);
                }}

                .button-icon {{
                    font-size: 1.5rem;
                    min-width: 30px;
                    text-align: center;
                }}

                .button-text {{
                    flex: 1;
                    text-align: left;
                }}

                @media (max-width: 768px) {{
                    .content-card {{
                        padding: 30px 20px;
                        min-width: auto;
                        margin: 10px;
                    }}
                    
                    .header h1 {{
                        font-size: 2rem;
                    }}
                    
                    .buttons-container {{
                        gap: 12px;
                    }}
                    
                    .action-button {{
                        padding: 15px 20px;
                        font-size: 1rem;
                    }}
                }}
            </style>
        </head>
        <body>
            <!-- Fondo del mundo EXACTO del site survey -->
            <div class="world-background"></div>
            
            <div class="main-container">
                <div class="content-card">
                    <div class="header">
                        <div class="success-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <h1>¬°Documento Generado!</h1>
                        <p>Dise√±o de Soluci√≥n completado exitosamente</p>

                    </div>
                    
                    <!-- CONFIRMACI√ìN DE LLENADO AUTOM√ÅTICO -->
                    <div class="llenado-confirmation" style="
                        background: {'linear-gradient(135deg, #00ff88 0%, #00cc6a 100%)' if llenado_exitoso else 'linear-gradient(135deg, #ff9500 0%, #ff6b00 100%)'};
                        color: #192133;
                        padding: 20px;
                        border-radius: 15px;
                        margin: 20px 0;
                        text-align: center;
                        box-shadow: 0 10px 30px rgba({'0, 255, 136' if llenado_exitoso else '255, 149, 0'}, 0.4);
                        animation: slideInUp 0.6s ease-out;
                    ">
                        <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 10px;">
                            <div style="font-size: 2rem;">{'üéâ' if llenado_exitoso else '‚ö†Ô∏è'}</div>
                            <div>
                                <h3 style="margin: 0; font-size: 1.3rem; font-weight: 700;">
                                    {'¬°Llenado Autom√°tico Completado!' if llenado_exitoso else 'Llenado Autom√°tico Procesado'}
                                </h3>
                            </div>
                        </div>
                        <p style="margin: 10px 0 0 0; font-size: 1rem; opacity: 0.9;">
                            {mensaje_resultado}
                        </p>
                        <div style="margin-top: 15px; font-size: 0.9rem; opacity: 0.8;">
                            <i class="fas fa-clock"></i> Procesado para ID: <strong>{user_id}</strong>
                        </div>
                    </div>
                    
                    <!-- BOTONES DE SUBIDA PASO A PASO (Solo si llenado exitoso) -->
                    {'<div class="upload-steps-container" style="margin-top: 30px; padding: 25px; background: rgba(255, 255, 255, 0.1); border-radius: 15px; border: 2px solid rgba(0, 255, 136, 0.3);">' if llenado_exitoso else ''}
                        {'<div style="text-align: center; margin-bottom: 20px;">' if llenado_exitoso else ''}
                            {'<h3 style="color: #00ff88; margin: 0; font-size: 1.2rem; font-weight: 700;"><i class="fas fa-upload"></i> SIGUIENTE PASO: Subir Archivos</h3>' if llenado_exitoso else ''}
                            {'<p style="color: rgba(255, 255, 255, 0.8); margin: 5px 0 0 0; font-size: 0.9rem;">Sube los archivos para completar el dise√±o de soluci√≥n</p>' if llenado_exitoso else ''}
                        {'</div>' if llenado_exitoso else ''}
                        
                        {'<div class="upload-button-container" style="display: flex; flex-direction: column; gap: 15px;">' if llenado_exitoso else ''}
                            
                            <!-- BOT√ìN 1: An√°lisis de Red y Frecuencia DOC -->
                            {'<button onclick="subirAnalisisRedFrecuencia(\'' + user_id + '\', \'' + fila_idx + '\')" class="upload-step-button" style="' if llenado_exitoso else ''}
                                {'background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);' if llenado_exitoso else ''}
                                {'color: white;' if llenado_exitoso else ''}
                                {'border: none;' if llenado_exitoso else ''}
                                {'padding: 15px 20px;' if llenado_exitoso else ''}
                                {'border-radius: 10px;' if llenado_exitoso else ''}
                                {'font-size: 1rem;' if llenado_exitoso else ''}
                                {'font-weight: 600;' if llenado_exitoso else ''}
                                {'cursor: pointer;' if llenado_exitoso else ''}
                                {'transition: all 0.3s ease;' if llenado_exitoso else ''}
                                {'display: flex;' if llenado_exitoso else ''}
                                {'align-items: center;' if llenado_exitoso else ''}
                                {'justify-content: center;' if llenado_exitoso else ''}
                                {'gap: 10px;' if llenado_exitoso else ''}
                                {'box-shadow: 0 4px 15px rgba(79, 172, 254, 0.4);' if llenado_exitoso else ''}
                            {'" onmouseover="this.style.transform=\'translateY(-2px)\'; this.style.boxShadow=\'0 6px 20px rgba(79, 172, 254, 0.6)\'" onmouseout="this.style.transform=\'translateY(0)\'; this.style.boxShadow=\'0 4px 15px rgba(79, 172, 254, 0.4)\'">' if llenado_exitoso else ''}
                                {'<i class="fas fa-file-word"></i>' if llenado_exitoso else ''}
                                {'<span>1. An√°lisis de Red y Frecuencia DOC</span>' if llenado_exitoso else ''}
                                {'<div style="font-size: 0.8rem; opacity: 0.8; margin-left: 10px;">‚Üí Celda C12</div>' if llenado_exitoso else ''}
                            {'</button>' if llenado_exitoso else ''}
                            
                            <!-- BOT√ìN 2: Im√°genes El√©ctricas -->
                            {'<button onclick="subirImagenesElectricas(\'' + user_id + '\', \'' + fila_idx + '\')" class="upload-step-button" style="' if llenado_exitoso else ''}
                                {'background: linear-gradient(135deg, #a8e6cf 0%, #88d8a3 100%);' if llenado_exitoso else ''}
                                {'color: white;' if llenado_exitoso else ''}
                                {'border: none;' if llenado_exitoso else ''}
                                {'padding: 15px 20px;' if llenado_exitoso else ''}
                                {'border-radius: 10px;' if llenado_exitoso else ''}
                                {'font-size: 1rem;' if llenado_exitoso else ''}
                                {'font-weight: 600;' if llenado_exitoso else ''}
                                {'cursor: pointer;' if llenado_exitoso else ''}
                                {'transition: all 0.3s ease;' if llenado_exitoso else ''}
                                {'display: flex;' if llenado_exitoso else ''}
                                {'align-items: center;' if llenado_exitoso else ''}
                                {'justify-content: center;' if llenado_exitoso else ''}
                                {'gap: 10px;' if llenado_exitoso else ''}
                                {'box-shadow: 0 4px 15px rgba(168, 230, 207, 0.4);' if llenado_exitoso else ''}
                            {'" onmouseover="this.style.transform=\'translateY(-2px)\'; this.style.boxShadow=\'0 6px 20px rgba(168, 230, 207, 0.6)\'" onmouseout="this.style.transform=\'translateY(0)\'; this.style.boxShadow=\'0 4px 15px rgba(168, 230, 207, 0.4)\'">' if llenado_exitoso else ''}
                                {'<i class="fas fa-images"></i>' if llenado_exitoso else ''}
                                {'<span>2. Im√°genes El√©ctricas (3 fotos)</span>' if llenado_exitoso else ''}
                                {'<div style="font-size: 0.8rem; opacity: 0.8; margin-left: 10px;">‚Üí Hoja 2</div>' if llenado_exitoso else ''}
                            {'</button>' if llenado_exitoso else ''}
                            
                            <!-- BOT√ìN 3: Formato KMZ -->
                            {'<button onclick="subirFormatoKMZ(\'' + user_id + '\', \'' + fila_idx + '\')" class="upload-step-button" style="' if llenado_exitoso else ''}
                                {'background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);' if llenado_exitoso else ''}
                                {'color: white;' if llenado_exitoso else ''}
                                {'border: none;' if llenado_exitoso else ''}
                                {'padding: 15px 20px;' if llenado_exitoso else ''}
                                {'border-radius: 10px;' if llenado_exitoso else ''}
                                {'font-size: 1rem;' if llenado_exitoso else ''}
                                {'font-weight: 600;' if llenado_exitoso else ''}
                                {'cursor: pointer;' if llenado_exitoso else ''}
                                {'transition: all 0.3s ease;' if llenado_exitoso else ''}
                                {'display: flex;' if llenado_exitoso else ''}
                                {'align-items: center;' if llenado_exitoso else ''}
                                {'justify-content: center;' if llenado_exitoso else ''}
                                {'gap: 10px;' if llenado_exitoso else ''}
                                {'box-shadow: 0 4px 15px rgba(255, 216, 155, 0.4);' if llenado_exitoso else ''}
                            {'" onmouseover="this.style.transform=\'translateY(-2px)\'; this.style.boxShadow=\'0 6px 20px rgba(255, 216, 155, 0.6)\'" onmouseout="this.style.transform=\'translateY(0)\'; this.style.boxShadow=\'0 4px 15px rgba(255, 216, 155, 0.4)\'">' if llenado_exitoso else ''}
                                {'<i class="fas fa-map-marked-alt"></i>' if llenado_exitoso else ''}
                                {'<span>3. Formato KMZ (KMZ + Imagen)</span>' if llenado_exitoso else ''}
                                {'<div style="font-size: 0.8rem; opacity: 0.8; margin-left: 10px;">‚Üí Hoja 3</div>' if llenado_exitoso else ''}
                            {'</button>' if llenado_exitoso else ''}
                            
                            <!-- BOT√ìN 4: Estudio de Informaci√≥n (6 Im√°genes + 2 PDFs) -->
                            {'<button onclick="subirEstudioInformacion(\'' + user_id + '\', \'' + fila_idx + '\')" class="upload-step-button" style="' if llenado_exitoso else ''}
                                {'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);' if llenado_exitoso else ''}
                                {'color: white;' if llenado_exitoso else ''}
                                {'border: none;' if llenado_exitoso else ''}
                                {'padding: 15px 20px;' if llenado_exitoso else ''}
                                {'border-radius: 10px;' if llenado_exitoso else ''}
                                {'font-size: 1rem;' if llenado_exitoso else ''}
                                {'font-weight: 600;' if llenado_exitoso else ''}
                                {'cursor: pointer;' if llenado_exitoso else ''}
                                {'transition: all 0.3s ease;' if llenado_exitoso else ''}
                                {'display: flex;' if llenado_exitoso else ''}
                                {'align-items: center;' if llenado_exitoso else ''}
                                {'justify-content: center;' if llenado_exitoso else ''}
                                {'gap: 10px;' if llenado_exitoso else ''}
                                {'box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);' if llenado_exitoso else ''}
                            {'" onmouseover="this.style.transform=\'translateY(-2px)\'; this.style.boxShadow=\'0 6px 20px rgba(102, 126, 234, 0.6)\'" onmouseout="this.style.transform=\'translateY(0)\'; this.style.boxShadow=\'0 4px 15px rgba(102, 126, 234, 0.4)\'">' if llenado_exitoso else ''}
                                {'<i class="fas fa-chart-line"></i>' if llenado_exitoso else ''}
                                {'<span>4. Estudio de Informaci√≥n (6 Im√°genes + 2 PDFs)</span>' if llenado_exitoso else ''}
                                {'<div style="font-size: 0.8rem; opacity: 0.8; margin-left: 10px;">‚Üí Hoja 4</div>' if llenado_exitoso else ''}
                            {'</button>' if llenado_exitoso else ''}
                            
                            <!-- BOT√ìN 5: Excel + Imagen para Estudio de Informaci√≥n -->
                            {'<button onclick="subirExcelImagen(\'' + user_id + '\', \'' + fila_idx + '\')" class="upload-step-button" style="' if llenado_exitoso else ''}
                                {'background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);' if llenado_exitoso else ''}
                                {'color: white;' if llenado_exitoso else ''}
                                {'border: none;' if llenado_exitoso else ''}
                                {'padding: 15px 20px;' if llenado_exitoso else ''}
                                {'border-radius: 10px;' if llenado_exitoso else ''}
                                {'font-size: 1rem;' if llenado_exitoso else ''}
                                {'font-weight: 600;' if llenado_exitoso else ''}
                                {'cursor: pointer;' if llenado_exitoso else ''}
                                {'transition: all 0.3s ease;' if llenado_exitoso else ''}
                                {'display: flex;' if llenado_exitoso else ''}
                                {'align-items: center;' if llenado_exitoso else ''}
                                {'justify-content: center;' if llenado_exitoso else ''}
                                {'gap: 10px;' if llenado_exitoso else ''}
                                {'box-shadow: 0 4px 15px rgba(240, 147, 251, 0.4);' if llenado_exitoso else ''}
                            {'" onmouseover="this.style.transform=\'translateY(-2px)\'; this.style.boxShadow=\'0 6px 20px rgba(240, 147, 251, 0.6)\'" onmouseout="this.style.transform=\'translateY(0)\'; this.style.boxShadow=\'0 4px 15px rgba(240, 147, 251, 0.4)\'">' if llenado_exitoso else ''}
                                {'<i class="fas fa-file-excel"></i>' if llenado_exitoso else ''}
                                {'<span>5. Excel + Imagen (Excel embebido + Imagen)</span>' if llenado_exitoso else ''}
                                {'<div style="font-size: 0.8rem; opacity: 0.8; margin-left: 10px;">‚Üí Hoja 5B</div>' if llenado_exitoso else ''}
                            {'</button>' if llenado_exitoso else ''}
                            
                            <!-- BOT√ìN 6: Estudio Torres y Antenas (3 Im√°genes) -->
                            {'<button onclick="subirTorresAntenas(\'' + user_id + '\', \'' + fila_idx + '\')" class="upload-step-button" style="' if llenado_exitoso else ''}
                                {'background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);' if llenado_exitoso else ''}
                                {'color: white;' if llenado_exitoso else ''}
                                {'border: none;' if llenado_exitoso else ''}
                                {'padding: 15px 20px;' if llenado_exitoso else ''}
                                {'border-radius: 10px;' if llenado_exitoso else ''}
                                {'font-size: 1rem;' if llenado_exitoso else ''}
                                {'font-weight: 600;' if llenado_exitoso else ''}
                                {'cursor: pointer;' if llenado_exitoso else ''}
                                {'transition: all 0.3s ease;' if llenado_exitoso else ''}
                                {'display: flex;' if llenado_exitoso else ''}
                                {'align-items: center;' if llenado_exitoso else ''}
                                {'justify-content: center;' if llenado_exitoso else ''}
                                {'gap: 10px;' if llenado_exitoso else ''}
                                {'box-shadow: 0 4px 15px rgba(255, 154, 158, 0.4);' if llenado_exitoso else ''}
                            {'" onmouseover="this.style.transform=\'translateY(-2px)\'; this.style.boxShadow=\'0 6px 20px rgba(255, 154, 158, 0.6)\'" onmouseout="this.style.transform=\'translateY(0)\'; this.style.boxShadow=\'0 4px 15px rgba(255, 154, 158, 0.4)\'">' if llenado_exitoso else ''}
                                {'<i class="fas fa-broadcast-tower"></i>' if llenado_exitoso else ''}
                                {'<span>6. Estudio Torres y Antenas (3 Im√°genes)</span>' if llenado_exitoso else ''}
                                {'<div style="font-size: 0.8rem; opacity: 0.8; margin-left: 10px;">‚Üí Hoja 6</div>' if llenado_exitoso else ''}
                            {'</button>' if llenado_exitoso else ''}
                            
                            <!-- BOT√ìN 7: Estudio Torres y Antenas B (3 Im√°genes) -->
                            {'<button onclick="subirTorresAntenasB(\'' + user_id + '\', \'' + fila_idx + '\')" class="upload-step-button" style="' if llenado_exitoso else ''}
                                {'background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);' if llenado_exitoso else ''}
                                {'color: #2c3e50;' if llenado_exitoso else ''}
                                {'border: none;' if llenado_exitoso else ''}
                                {'padding: 15px 20px;' if llenado_exitoso else ''}
                                {'border-radius: 10px;' if llenado_exitoso else ''}
                                {'font-size: 1rem;' if llenado_exitoso else ''}
                                {'font-weight: 600;' if llenado_exitoso else ''}
                                {'cursor: pointer;' if llenado_exitoso else ''}
                                {'transition: all 0.3s ease;' if llenado_exitoso else ''}
                                {'display: flex;' if llenado_exitoso else ''}
                                {'align-items: center;' if llenado_exitoso else ''}
                                {'justify-content: center;' if llenado_exitoso else ''}
                                {'gap: 10px;' if llenado_exitoso else ''}
                                {'box-shadow: 0 4px 15px rgba(168, 237, 234, 0.4);' if llenado_exitoso else ''}
                            {'" onmouseover="this.style.transform=\'translateY(-2px)\'; this.style.boxShadow=\'0 6px 20px rgba(168, 237, 234, 0.6)\'" onmouseout="this.style.transform=\'translateY(0)\'; this.style.boxShadow=\'0 4px 15px rgba(168, 237, 234, 0.4)\'">' if llenado_exitoso else ''}
                                {'<i class="fas fa-broadcast-tower"></i>' if llenado_exitoso else ''}
                                {'<span>7. Estudio Torres y Antenas B (3 Im√°genes)</span>' if llenado_exitoso else ''}
                                {'<div style="font-size: 0.8rem; opacity: 0.8; margin-left: 10px;">‚Üí Hoja 7B</div>' if llenado_exitoso else ''}
                            {'</button>' if llenado_exitoso else ''}
                            
                            <!-- BOT√ìN 8: Factibilidad Reporte Fotos A (19 Im√°genes) -->
                            {'<a href="/subir_factibilidad_fotos_a_page?user_id=' + user_id + '&fila_idx=' + fila_idx + '" class="upload-step-button" style="' if llenado_exitoso else ''}
                                {'background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);' if llenado_exitoso else ''}
                                {'color: #2c3e50;' if llenado_exitoso else ''}
                                {'border: none;' if llenado_exitoso else ''}
                                {'padding: 15px 20px;' if llenado_exitoso else ''}
                                {'border-radius: 10px;' if llenado_exitoso else ''}
                                {'font-size: 1rem;' if llenado_exitoso else ''}
                                {'font-weight: 600;' if llenado_exitoso else ''}
                                {'cursor: pointer;' if llenado_exitoso else ''}
                                {'transition: all 0.3s ease;' if llenado_exitoso else ''}
                                {'display: flex;' if llenado_exitoso else ''}
                                {'align-items: center;' if llenado_exitoso else ''}
                                {'justify-content: center;' if llenado_exitoso else ''}
                                {'gap: 10px;' if llenado_exitoso else ''}
                                {'text-decoration: none;' if llenado_exitoso else ''}
                                {'box-shadow: 0 4px 15px rgba(132, 250, 176, 0.4);' if llenado_exitoso else ''}
                            {'" onmouseover="this.style.transform=\'translateY(-2px)\'; this.style.boxShadow=\'0 6px 20px rgba(132, 250, 176, 0.6)\'" onmouseout="this.style.transform=\'translateY(0)\'; this.style.boxShadow=\'0 4px 15px rgba(132, 250, 176, 0.4)\'">' if llenado_exitoso else ''}
                                {'<i class="fas fa-camera"></i>' if llenado_exitoso else ''}
                                {'<span>8. Factibilidad Reporte Fotos A (hasta 19)</span>' if llenado_exitoso else ''}
                                {'<div style="font-size: 0.8rem; opacity: 0.8; margin-left: 10px;">‚Üí Hoja 9</div>' if llenado_exitoso else ''}
                            {'</a>' if llenado_exitoso else ''}
                            
                            <!-- BOT√ìN 9: Reporte Fotos B (19 Im√°genes) -->
                            {'<a href="/subir_reporte_fotos_b_page?user_id=' + user_id + '&fila_idx=' + fila_idx + '" class="upload-step-button" style="' if llenado_exitoso else ''}
                                {'background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);' if llenado_exitoso else ''}
                                {'color: #2c3e50;' if llenado_exitoso else ''}
                                {'border: none;' if llenado_exitoso else ''}
                                {'padding: 15px 20px;' if llenado_exitoso else ''}
                                {'border-radius: 10px;' if llenado_exitoso else ''}
                                {'font-size: 1rem;' if llenado_exitoso else ''}
                                {'font-weight: 600;' if llenado_exitoso else ''}
                                {'cursor: pointer;' if llenado_exitoso else ''}
                                {'transition: all 0.3s ease;' if llenado_exitoso else ''}
                                {'display: flex;' if llenado_exitoso else ''}
                                {'align-items: center;' if llenado_exitoso else ''}
                                {'justify-content: center;' if llenado_exitoso else ''}
                                {'gap: 10px;' if llenado_exitoso else ''}
                                {'text-decoration: none;' if llenado_exitoso else ''}
                                {'box-shadow: 0 4px 15px rgba(255, 236, 210, 0.4);' if llenado_exitoso else ''}
                            {'" onmouseover="this.style.transform=\'translateY(-2px)\'; this.style.boxShadow=\'0 6px 20px rgba(255, 236, 210, 0.6)\'" onmouseout="this.style.transform=\'translateY(0)\'; this.style.boxShadow=\'0 4px 15px rgba(255, 236, 210, 0.4)\'">' if llenado_exitoso else ''}
                                {'<i class="fas fa-camera"></i>' if llenado_exitoso else ''}
                                {'<span>9. Reporte Fotos B (hasta 19)</span>' if llenado_exitoso else ''}
                                {'<div style="font-size: 0.8rem; opacity: 0.8; margin-left: 10px;">‚Üí Hoja 10</div>' if llenado_exitoso else ''}
                            {'</a>' if llenado_exitoso else ''}
                            
                        {'</div>' if llenado_exitoso else ''}
                    {'</div>' if llenado_exitoso else ''}
                    
                    <div class="info-container" id="infoContainer">
                        <div class="info-item">
                            <i class="fas fa-id-card"></i>
                            <span id="infoId"><strong>ID:</strong> {user_id}</span>
                        </div>
                        
                        <div class="info-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <span id="infoSitioA"><strong>Sitio A:</strong> {nombre_a}</span>
                        </div>
                        
                        <div class="info-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <span id="infoSitioB"><strong>Sitio B:</strong> {nombre_b}</span>
                        </div>
                        

                    </div>

                    <div class="buttons-container">
                        <!-- BOTONES DE ACCI√ìN PRINCIPAL -->
                        <button onclick="guardarArchivoDiseno('{user_id}', 'diseno_solucion', '{fila_idx}')" class="action-button save-button">
                            <div class="button-icon">
                                <i class="fas fa-save"></i>
                            </div>
                            <div class="button-text">Guardar Archivo</div>
                        </button>
                        
                        <a href="/descargar_diseno_solucion?user_id={user_id}&fila_idx={fila_idx}" class="action-button download-button">
                            <div class="button-icon">
                                <i class="fas fa-download"></i>
                            </div>
                            <div class="button-text">Descargar Archivo Generado (PtP)</div>
                        </a>
                        
                        
                        <!-- BOTONES DE NAVEGACI√ìN -->
                        <a href="/reporte_planeacion?user_id={user_id}&fila_idx={fila_idx}" class="action-button navigation-button">
                            <div class="button-icon">
                                <i class="fas fa-file-alt"></i>
                            </div>
                            <div class="button-text">Ir a Reporte de Planeaci√≥n</div>
                        </a>
                        
                        <a href="/diseno_solucion_directo?user_id={user_id}&fila_idx={fila_idx}" class="action-button navigation-button">
                            <div class="button-icon">
                                <i class="fas fa-arrow-right"></i>
                            </div>
                            <div class="button-text">Ir a Dise√±o de Soluci√≥n (DIRECTO)</div>
                        </a>
                        
                        <!-- BOT√ìN DE PRUEBA -->
                        <button onclick="testJavaScript()" class="action-button test-button">
                            <div class="button-icon">
                                <i class="fas fa-star"></i>
                            </div>
                            <div class="button-text">PRUEBA JAVASCRIPT</div>
                        </button>
                        
                        <!-- BOTONES DE GESTI√ìN -->
                        <a href="/file_manager" class="action-button file-manager-button">
                            <div class="button-icon">
                                <i class="fas fa-folder-open"></i>
                            </div>
                            <div class="button-text">Gestionar Archivos Generados</div>
                        </a>
                        
                        <a href="/" class="action-button home-button">
                            <div class="button-icon">
                                <i class="fas fa-home"></i>
                            </div>
                            <div class="button-text">Volver al Inicio</div>
                        </a>
                    </div>
                </div>
            </div>
            
            <script>
                // Funci√≥n para guardar archivo de dise√±o de soluci√≥n (GLOBAL)
                function guardarArchivoDiseno(userId, tipo, filaIdx) {{
                    console.log('‚úÖ [GLOBAL] Guardando archivo de dise√±o de soluci√≥n:', userId, tipo, filaIdx);
                    
                    // Mostrar mensaje de guardado inmediato
                    alert('‚úÖ Archivo guardado exitosamente para ID: ' + userId + '\\nüìÅ Ubicaci√≥n: saved_files/saved_' + userId + '_' + tipo + '.xlsx');
                    
                    // Mostrar modal para agregar otro ID inmediatamente
                    mostrarModalNuevoID();
                }}
                
                // Funci√≥n para mostrar modal de nuevo ID (GLOBAL)
                function mostrarModalNuevoID() {{
                    // Crear modal
                    const modal = document.createElement('div');
                    modal.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.8);
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        z-index: 10000;
                        font-family: 'Montserrat', Arial, sans-serif;
                    `;
                    
                    const modalContent = document.createElement('div');
                    modalContent.style.cssText = `
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        padding: 40px;
                        border-radius: 20px;
                        max-width: 500px;
                        width: 90%;
                        text-align: center;
                        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                        color: white;
                        position: relative;
                    `;
                    
                    modalContent.innerHTML = `
                        <div style="margin-bottom: 30px;">
                            <div style="
                                width: 80px;
                                height: 80px;
                                background: rgba(255, 255, 255, 0.2);
                                border-radius: 50%;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                margin: 0 auto 20px;
                                font-size: 2.5rem;
                            ">
                                üöÄ
                            </div>
                            <h2 style="color: white; margin-bottom: 15px; font-size: 1.8rem; font-weight: 700;">
                                ¬øAgregar Otro ID?
                            </h2>
                            <p style="color: rgba(255, 255, 255, 0.9); font-size: 1.1rem; margin-bottom: 25px;">
                                ¬øTe gustar√≠a procesar otro ID para generar un nuevo dise√±o de soluci√≥n?
                            </p>
                        </div>
                        
                        <div style="margin-bottom: 30px;">
                            <input type="text" id="nuevoIdInput" placeholder="Ingresa el nuevo ID..." style="
                                width: 100%;
                                padding: 15px;
                                border: none;
                                border-radius: 10px;
                                font-size: 1.1rem;
                                text-align: center;
                                background: rgba(255, 255, 255, 0.9);
                                color: #333;
                                box-sizing: border-box;
                                outline: none;
                                font-weight: 600;
                            ">
                        </div>
                        
                        <div style="display: flex; gap: 15px; justify-content: center;">
                            <button id="btnProcesarNuevoID" style="
                                background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
                                color: #192133;
                                border: none;
                                padding: 15px 25px;
                                border-radius: 10px;
                                font-size: 1rem;
                                font-weight: 700;
                                cursor: pointer;
                                transition: all 0.3s ease;
                                min-width: 140px;
                            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(0, 255, 136, 0.4)'" 
                               onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                <i class="fas fa-play"></i> Procesar ID
                            </button>
                            
                            <button id="btnCancelarNuevoID" style="
                                background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
                                color: white;
                                border: none;
                                padding: 15px 25px;
                                border-radius: 10px;
                                font-size: 1rem;
                                font-weight: 700;
                                cursor: pointer;
                                transition: all 0.3s ease;
                                min-width: 140px;
                            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(255, 107, 107, 0.4)'" 
                               onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                        </div>
                    `;
                    
                    modal.appendChild(modalContent);
                    document.body.appendChild(modal);
                    
                    // Enfocar el input
                    setTimeout(() => {{
                        document.getElementById('nuevoIdInput').focus();
                    }}, 100);
                    
                    // Event listeners para los botones
                    document.getElementById('btnProcesarNuevoID').addEventListener('click', function() {{
                        const nuevoId = document.getElementById('nuevoIdInput').value.trim();
                        if (nuevoId) {{
                            // Cerrar modal actual
                            document.body.removeChild(modal);
                            
                            // Verificar si hay m√∫ltiples opciones para este ID
                            console.log('üîç Verificando opciones para ID:', nuevoId);
                            verificarOpcionesDisponibles(nuevoId);
                        }} else {{
                            alert('‚ö†Ô∏è Por favor, ingresa un ID v√°lido');
                            document.getElementById('nuevoIdInput').focus();
                        }}
                    }});
                    
                    document.getElementById('btnCancelarNuevoID').addEventListener('click', function() {{
                        document.body.removeChild(modal);
                    }});
                    
                    // Cerrar modal al hacer clic fuera
                    modal.addEventListener('click', function(e) {{
                        if (e.target === modal) {{
                            document.body.removeChild(modal);
                        }}
                    }});
                    
                    // Permitir Enter en el input
                    document.getElementById('nuevoIdInput').addEventListener('keypress', function(e) {{
                        if (e.key === 'Enter') {{
                            document.getElementById('btnProcesarNuevoID').click();
                        }}
                    }});
                }}
                
                // Funci√≥n para verificar opciones disponibles para un ID
                function verificarOpcionesDisponibles(userId) {{
                    console.log('üîç Verificando opciones disponibles para ID:', userId);
                    
                    // Mostrar indicador de carga
                    const loadingModal = document.createElement('div');
                    loadingModal.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.8);
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        z-index: 10001;
                        font-family: 'Montserrat', Arial, sans-serif;
                    `;
                    
                    loadingModal.innerHTML = `
                        <div style="
                            background: white;
                            padding: 40px;
                            border-radius: 20px;
                            text-align: center;
                            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                        ">
                            <div style="margin-bottom: 20px;">
                                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #667eea;"></i>
                            </div>
                            <h3 style="color: #333; margin: 0;">Buscando opciones para ID: {user_id}</h3>
                            <p style="color: #666; margin: 10px 0 0 0;">Verificando puntas B disponibles...</p>
                        </div>
                    `;
                    
                    document.body.appendChild(loadingModal);
                    
                    // Llamar al endpoint para buscar opciones
                    fetch('/buscar_opciones_id', {{
                        method: 'POST',
                        headers: {{
                            'Content-Type': 'application/json',
                        }},
                        body: JSON.stringify({{
                            user_id: userId
                        }})
                    }})
                    .then(response => response.json())
                    .then(data => {{
                        // Remover modal de carga
                        document.body.removeChild(loadingModal);
                        
                        if (data.success) {{
                            if (data.opciones && data.opciones.length > 1) {{
                                // Hay m√∫ltiples opciones, mostrar modal de selecci√≥n
                                console.log('üìã M√∫ltiples opciones encontradas:', data.opciones);
                                mostrarModalSeleccionOpciones(data.opciones, userId);
                            }} else if (data.opciones && data.opciones.length === 1) {{
                                // Solo una opci√≥n, proceder directamente
                                console.log('‚úÖ Opci√≥n √∫nica encontrada, procediendo...');
                                const opcion = data.opciones[0];
                                window.location.href = `/diseno_solucion?user_id=${{opcion.user_id}}&fila_idx=${{opcion.fila_idx}}&llenado_automatico=true`;
                        }} else {{
                                // No se encontraron opciones
                                alert('‚ùå No se encontraron opciones para el ID: ' + userId + '\\n\\nVerifica que el ID sea correcto.');
                            }}
                        }} else {{
                            alert('‚ùå Error al buscar opciones: ' + data.error);
                        }}
                    }})
                    .catch(error => {{
                        // Remover modal de carga si existe
                        if (document.body.contains(loadingModal)) {{
                            document.body.removeChild(loadingModal);
                        }}
                        console.error('Error:', error);
                        alert('‚ùå Error de conexi√≥n al buscar opciones');
                    }});
                }}
                
                // Funci√≥n para mostrar modal de selecci√≥n de opciones
                function mostrarModalSeleccionOpciones(opciones, userId) {{
                    console.log('üìã Mostrando modal de selecci√≥n para:', opciones.length, 'opciones');
                    
                    // Crear modal
                    const modal = document.createElement('div');
                    modal.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.8);
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        z-index: 10000;
                        font-family: 'Montserrat', Arial, sans-serif;
                        overflow-y: auto;
                        padding: 20px;
                    `;
                    
                    const modalContent = document.createElement('div');
                    modalContent.style.cssText = `
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        padding: 40px;
                        border-radius: 20px;
                        max-width: 700px;
                        width: 90%;
                        text-align: center;
                        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                        color: white;
                        position: relative;
                        max-height: 80vh;
                        overflow-y: auto;
                    `;
                    
                    // Generar HTML de opciones
                    let opcionesHTML = '';
                    opciones.forEach((opcion, index) => {{
                        opcionesHTML += `
                            <div style="
                                background: rgba(255, 255, 255, 0.1);
                                border: 2px solid rgba(255, 255, 255, 0.2);
                                border-radius: 15px;
                                padding: 20px;
                                margin: 15px 0;
                                cursor: pointer;
                                transition: all 0.3s ease;
                                text-align: left;
                            " onclick="seleccionarOpcion('${{opcion.user_id}}', '${{opcion.fila_idx}}', '${{opcion.nombre_a}}', '${{opcion.nombre_b}}')"
                               onmouseover="this.style.borderColor='rgba(0, 255, 136, 0.8)'; this.style.background='rgba(255, 255, 255, 0.2)'"
                               onmouseout="this.style.borderColor='rgba(255, 255, 255, 0.2)'; this.style.background='rgba(255, 255, 255, 0.1)'">
                                
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <h4 style="margin: 0; color: #00ff88; font-size: 1.2rem;">
                                        Opci√≥n ${{index + 1}}
                                    </h4>
                                    <span style="
                                        background: rgba(0, 255, 136, 0.2);
                                        color: #00ff88;
                                        padding: 5px 10px;
                                        border-radius: 20px;
                                        font-size: 0.9rem;
                                        font-weight: 600;
                                    ">
                                        ID: ${{opcion.user_id}}
                                    </span>
                                </div>
                                
                                <div style="margin-bottom: 8px;">
                                    <strong>üìç Sitio A:</strong> ${{opcion.nombre_a || 'Sin nombre'}}
                                </div>
                                <div style="margin-bottom: 8px;">
                                    <strong>üìç Sitio B:</strong> ${{opcion.nombre_b || 'Sin nombre'}}
                                </div>
                                <div style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.8);">
                                    <strong>üî¢ Fila:</strong> ${{opcion.fila_idx}}
                                </div>
                            </div>
                        `;
                    }});
                    
                    modalContent.innerHTML = `
                        <div style="margin-bottom: 30px;">
                            <div style="
                                width: 80px;
                                height: 80px;
                                background: rgba(255, 255, 255, 0.2);
                                border-radius: 50%;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                margin: 0 auto 20px;
                                font-size: 2.5rem;
                            ">
                                üìã
                            </div>
                            <h2 style="color: white; margin-bottom: 15px; font-size: 1.8rem; font-weight: 700;">
                                Selecciona el Llenado
                            </h2>
                            <p style="color: rgba(255, 255, 255, 0.9); font-size: 1.1rem; margin-bottom: 25px;">
                                Se encontraron ${{opciones.length}} opciones para el ID <strong>{user_id}</strong>.<br>
                                Selecciona cu√°l quieres procesar:
                            </p>
                        </div>
                        
                        <div style="margin-bottom: 30px;">
                            ${{opcionesHTML}}
                        </div>
                        
                        <div style="display: flex; gap: 15px; justify-content: center;">
                            <button onclick="cerrarModalSeleccion()" style="
                                background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
                                color: white;
                                border: none;
                                padding: 15px 25px;
                                border-radius: 10px;
                                font-size: 1rem;
                                font-weight: 700;
                                cursor: pointer;
                                transition: all 0.3s ease;
                                min-width: 140px;
                            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(255, 107, 107, 0.4)'" 
                               onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                        </div>
                    `;
                    
                    modal.appendChild(modalContent);
                    document.body.appendChild(modal);
                    
                    // Guardar referencia del modal para poder cerrarlo
                    window.modalSeleccionActivo = modal;
                }}
                
                // Funci√≥n para seleccionar una opci√≥n
                function seleccionarOpcion(userId, filaIdx, nombreA, nombreB) {{
                    console.log('‚úÖ Opci√≥n seleccionada:', userId, filaIdx, nombreA, nombreB);
                    
                    // Cerrar modal
                    if (window.modalSeleccionActivo) {{
                        document.body.removeChild(window.modalSeleccionActivo);
                        window.modalSeleccionActivo = null;
                    }}
                    
                    // Redirigir al dise√±o de soluci√≥n con los par√°metros seleccionados
                    window.location.href = `/diseno_solucion?user_id=${{userId}}&fila_idx=${{filaIdx}}&llenado_automatico=true`;
                }}
                
                // Funci√≥n para cerrar modal de selecci√≥n
                function cerrarModalSeleccion() {{
                    if (window.modalSeleccionActivo) {{
                        document.body.removeChild(window.modalSeleccionActivo);
                        window.modalSeleccionActivo = null;
                    }}
                }}
                
                function testJavaScript() {{
                    console.log('Prueba de JavaScript funcionando correctamente');
                    alert('‚úÖ JavaScript funcionando perfectamente!');
                }}
                
                // Verificaci√≥n final de funciones
                console.log('üîç Verificando funciones definidas:');
                console.log('- almacenarArchivoPermanente:', typeof almacenarArchivoPermanente);
                console.log('- guardarArchivoDiseno:', typeof guardarArchivoDiseno);
                console.log('- mostrarModalNuevoID:', typeof mostrarModalNuevoID);
                console.log('- testJavaScript:', typeof testJavaScript);
                
                if (typeof almacenarArchivoPermanente === 'undefined') {{
                    console.error('‚ùå ERROR: almacenarArchivoPermanente NO DEFINIDA');
                }} else {{
                    console.log('‚úÖ almacenarArchivoPermanente CORRECTAMENTE DEFINIDA');
                }}
                
                if (typeof guardarArchivoDiseno === 'undefined') {{
                    console.error('‚ùå ERROR: guardarArchivoDiseno NO DEFINIDA');
                }} else {{
                    console.log('‚úÖ guardarArchivoDiseno CORRECTAMENTE DEFINIDA');
                }}
                
                if (typeof mostrarModalNuevoID === 'undefined') {{
                    console.error('‚ùå ERROR: mostrarModalNuevoID NO DEFINIDA');
                }} else {{
                    console.log('‚úÖ mostrarModalNuevoID CORRECTAMENTE DEFINIDA');
                }}
                
                console.log('üéâ TODAS LAS FUNCIONES VERIFICADAS - LISTO PARA USAR');
                

                
                // Funci√≥n para mostrar notificaci√≥n de √©xito
                function mostrarNotificacionExito(titulo, mensaje) {{
                    // Crear notificaci√≥n
                    const notificacion = document.createElement('div');
                    notificacion.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
                        color: #192133;
                        padding: 20px 25px;
                        border-radius: 15px;
                        box-shadow: 0 10px 30px rgba(0, 255, 136, 0.4);
                        z-index: 10002;
                        font-family: 'Montserrat', Arial, sans-serif;
                        font-weight: 600;
                        max-width: 350px;
                        animation: slideInRight 0.5s ease-out;
                    `;
                    
                    notificacion.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="font-size: 2rem;">üéâ</div>
                            <div>
                                <div style="font-size: 1.2rem; font-weight: 700; margin-bottom: 5px;">
                                    ${{titulo}}
                                </div>
                                <div style="font-size: 0.95rem; opacity: 0.9;">
                                    ${{mensaje}}
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Agregar estilos de animaci√≥n
                    const style = document.createElement('style');
                    style.textContent = `
                        @keyframes slideInRight {{
                            from {{ transform: translateX(100%); opacity: 0; }}
                            to {{ transform: translateX(0); opacity: 1; }}
                        }}
                                        @keyframes slideOutRight {{
                    from {{ transform: translateX(0); opacity: 1; }}
                    to {{ transform: translateX(100%); opacity: 0; }}
                }}
                
                @keyframes slideInUp {{
                    from {{ transform: translateY(30px); opacity: 0; }}
                    to {{ transform: translateY(0); opacity: 1; }}
                }}
                    `;
                    document.head.appendChild(style);
                    
                    document.body.appendChild(notificacion);
                    
                    // Auto-remover despu√©s de 5 segundos
                    setTimeout(() => {{
                        notificacion.style.animation = 'slideOutRight 0.5s ease-in';
                        setTimeout(() => {{
                            if (document.body.contains(notificacion)) {{
                                document.body.removeChild(notificacion);
                            }}
                        }}, 500);
                    }}, 5000);
                }}
                
                // Funci√≥n para actualizar informaci√≥n del ID din√°micamente
                function actualizarInformacionID(userId, filaIdx) {{
                    console.log('üìä Actualizando informaci√≥n para ID:', userId);
                    
                    fetch('/obtener_info_id', {{
                        method: 'POST',
                        headers: {{
                            'Content-Type': 'application/json',
                        }},
                        body: JSON.stringify({{
                            user_id: userId,
                            fila_idx: filaIdx
                        }})
                    }})
                    .then(response => response.json())
                    .then(data => {{
                        if (data.success) {{
                            // Actualizar informaci√≥n en el modal
                            document.getElementById('infoId').innerHTML = `<strong>ID:</strong> ${{data.user_id}}`;
                            document.getElementById('infoSitioA').innerHTML = `<strong>Sitio A:</strong> ${{data.nombre_a}}`;
                            document.getElementById('infoSitioB').innerHTML = `<strong>Sitio B:</strong> ${{data.nombre_b}}`;
                        }}
                    }})
                    .catch(error => {{
                        console.error('Error actualizando informaci√≥n:', error);
                    }});
                }}
                
                // Funci√≥n para subir an√°lisis de red y frecuencia
                // FUNCI√ìN PARA SUBIR IM√ÅGENES EL√âCTRICAS CON VISUALIZACI√ìN
        function subirImagenesElectricas(userId, filaIdx) {{
            console.log('üñºÔ∏è Iniciando subida de im√°genes el√©ctricas para:', userId);
            
            // Crear modal para selecci√≥n de im√°genes con previsualizaci√≥n
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.9);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10001;
                overflow-y: auto;
                padding: 20px;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
                    border-radius: 20px;
                    padding: 30px;
                    max-width: 800px;
                    width: 100%;
                    max-height: 90vh;
                    overflow-y: auto;
                    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
                    border: 2px solid #a8e6cf;
                ">
                    <div style="text-align: center; margin-bottom: 30px;">
                        <h2 style="color: #a8e6cf; margin: 0; font-size: 1.8rem; font-weight: 700;">
                            üì∏ Subir Im√°genes El√©ctricas
                        </h2>
                        <p style="color: rgba(255, 255, 255, 0.8); margin: 10px 0; font-size: 1rem;">
                            Sube 3 im√°genes para la hoja "2. Electricas - Dise√±o log- Fis"
                        </p>
                        <div style="background: rgba(168, 230, 207, 0.1); padding: 15px; border-radius: 10px; margin: 15px 0;">
                            <p style="color: #a8e6cf; margin: 0; font-size: 0.9rem;">
                                <strong>Rangos de destino:</strong><br>
                                üîã Consumo energ√≠a 1: C14:D20<br>
                                üîã Consumo energ√≠a 2: E14:G20<br>
                                üì° Simulaci√≥n pathloss: B39:G55
                            </p>
                        </div>
                    </div>
                    
                    <!-- √Årea de subida de im√°genes -->
                    <div id="imageUploadContainer">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                            
                            <!-- Imagen 1: Consumo energ√≠a 1 -->
                            <div class="image-upload-box" data-index="0">
                                <div style="
                                    border: 2px dashed #a8e6cf;
                                    border-radius: 10px;
                                    padding: 20px;
                                    text-align: center;
                                    cursor: pointer;
                                    transition: all 0.3s ease;
                                    min-height: 200px;
                                    display: flex;
                                    flex-direction: column;
                                    justify-content: center;
                                    align-items: center;
                                " onclick="selectImage(0)">
                                    <i class="fas fa-battery-full" style="font-size: 2rem; color: #a8e6cf; margin-bottom: 10px;"></i>
                                    <h3 style="color: #a8e6cf; margin: 0; font-size: 1rem;">Consumo Energ√≠a 1</h3>
                                    <p style="color: rgba(255, 255, 255, 0.6); font-size: 0.8rem; margin: 5px 0;">C14:D20</p>
                                    <p style="color: rgba(255, 255, 255, 0.4); font-size: 0.7rem; margin: 10px 0;">Clic para seleccionar imagen</p>
                                    <div class="preview-container" style="width: 100%; max-height: 150px; overflow: hidden; border-radius: 5px; margin-top: 10px; display: none;">
                                        <img class="preview-image" style="width: 100%; height: auto; object-fit: cover;">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Imagen 2: Consumo energ√≠a 2 -->
                            <div class="image-upload-box" data-index="1">
                                <div style="
                                    border: 2px dashed #a8e6cf;
                                    border-radius: 10px;
                                    padding: 20px;
                                    text-align: center;
                                    cursor: pointer;
                                    transition: all 0.3s ease;
                                    min-height: 200px;
                                    display: flex;
                                    flex-direction: column;
                                    justify-content: center;
                                    align-items: center;
                                " onclick="selectImage(1)">
                                    <i class="fas fa-bolt" style="font-size: 2rem; color: #a8e6cf; margin-bottom: 10px;"></i>
                                    <h3 style="color: #a8e6cf; margin: 0; font-size: 1rem;">Consumo Energ√≠a 2</h3>
                                    <p style="color: rgba(255, 255, 255, 0.6); font-size: 0.8rem; margin: 5px 0;">E14:G20</p>
                                    <p style="color: rgba(255, 255, 255, 0.4); font-size: 0.7rem; margin: 10px 0;">Clic para seleccionar imagen</p>
                                    <div class="preview-container" style="width: 100%; max-height: 150px; overflow: hidden; border-radius: 5px; margin-top: 10px; display: none;">
                                        <img class="preview-image" style="width: 100%; height: auto; object-fit: cover;">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Imagen 3: Simulaci√≥n pathloss -->
                            <div class="image-upload-box" data-index="2">
                                <div style="
                                    border: 2px dashed #a8e6cf;
                                    border-radius: 10px;
                                    padding: 20px;
                                    text-align: center;
                                    cursor: pointer;
                                    transition: all 0.3s ease;
                                    min-height: 200px;
                                    display: flex;
                                    flex-direction: column;
                                    justify-content: center;
                                    align-items: center;
                                " onclick="selectImage(2)">
                                    <i class="fas fa-signal" style="font-size: 2rem; color: #a8e6cf; margin-bottom: 10px;"></i>
                                    <h3 style="color: #a8e6cf; margin: 0; font-size: 1rem;">Simulaci√≥n Pathloss</h3>
                                    <p style="color: rgba(255, 255, 255, 0.6); font-size: 0.8rem; margin: 5px 0;">B39:G55</p>
                                    <p style="color: rgba(255, 255, 255, 0.4); font-size: 0.7rem; margin: 10px 0;">Clic para seleccionar imagen</p>
                                    <div class="preview-container" style="width: 100%; max-height: 150px; overflow: hidden; border-radius: 5px; margin-top: 10px; display: none;">
                                        <img class="preview-image" style="width: 100%; height: auto; object-fit: cover;">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Input oculto para archivos -->
                    <input type="file" id="hiddenImageInput" accept="image/*" style="display: none;">
                    
                    <!-- Botones de acci√≥n -->
                    <div style="display: flex; gap: 15px; justify-content: center; margin-top: 30px;">
                        <button id="uploadImagesBtn" onclick="uploadAllImages('{user_id}', '{fila_idx}')" style="
                            background: linear-gradient(135deg, #a8e6cf 0%, #88d8a3 100%);
                            color: white;
                            border: none;
                            padding: 15px 30px;
                            border-radius: 10px;
                            font-size: 1rem;
                            font-weight: bold;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            opacity: 0.5;
                            pointer-events: none;
                        ">
                            <i class="fas fa-upload"></i> Subir Im√°genes
                        </button>
                        <button onclick="closeImageModal()" style="
                            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
                            color: white;
                            border: none;
                            padding: 15px 30px;
                            border-radius: 10px;
                            font-size: 1rem;
                            font-weight: bold;
                            cursor: pointer;
                            transition: all 0.3s ease;
                        ">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            window.currentImageModal = modal;
            window.selectedImages = [null, null, null];
            
            // Configurar input de archivos
            const hiddenInput = document.getElementById('hiddenImageInput');
            hiddenInput.addEventListener('change', handleImageSelection);
            
            console.log('‚úÖ Modal de im√°genes creado correctamente');
        }}
        
        // Variables globales para manejo de im√°genes
        let currentImageIndex = 0;
        
        function selectImage(index) {{
            currentImageIndex = index;
            document.getElementById('hiddenImageInput').click();
        }}
        
        function handleImageSelection(event) {{
            const file = event.target.files[0];
            if (!file) return;
            
            // Validar que sea imagen
            if (!file.type.startsWith('image/')) {{
                alert('‚ùå Por favor selecciona solo archivos de imagen (JPG, PNG, etc.)');
                return;
            }}
            
            // Validar tama√±o (m√°ximo 10MB)
            if (file.size > 10 * 1024 * 1024) {{
                alert('‚ùå La imagen es muy grande. M√°ximo 10MB permitido.');
                return;
            }}
            
            console.log(`üì∏ Imagen seleccionada para posici√≥n ${{currentImageIndex}}:`, file.name);
            
            // Guardar archivo
            window.selectedImages[currentImageIndex] = file;
            
            // Mostrar previsualizaci√≥n
            const reader = new FileReader();
            reader.onload = function(e) {{
                const uploadBox = document.querySelector(`[data-index="${{currentImageIndex}}"]`);
                const previewContainer = uploadBox.querySelector('.preview-container');
                const previewImage = uploadBox.querySelector('.preview-image');
                
                previewImage.src = e.target.result;
                previewContainer.style.display = 'block';
                
                // Cambiar estilo del box
                const boxDiv = uploadBox.querySelector('div');
                boxDiv.style.border = '2px solid #a8e6cf';
                boxDiv.style.background = 'rgba(168, 230, 207, 0.1)';
                
                console.log(`‚úÖ Previsualizaci√≥n mostrada para imagen ${{currentImageIndex}}`);
                
                // Verificar si todas las im√°genes est√°n seleccionadas
                checkAllImagesSelected();
            }};
            reader.readAsDataURL(file);
            
            // Limpiar input
            event.target.value = '';
        }}
        
        function checkAllImagesSelected() {{
            const allSelected = window.selectedImages.every(img => img !== null);
            const uploadBtn = document.getElementById('uploadImagesBtn');
            
            if (allSelected) {{
                uploadBtn.style.opacity = '1';
                uploadBtn.style.pointerEvents = 'auto';
                uploadBtn.innerHTML = '<i class="fas fa-upload"></i> Subir 3 Im√°genes ‚úÖ';
                console.log('‚úÖ Todas las im√°genes seleccionadas, bot√≥n habilitado');
            }} else {{
                const selectedCount = window.selectedImages.filter(img => img !== null).length;
                uploadBtn.innerHTML = `<i class="fas fa-upload"></i> Subir Im√°genes (${{selectedCount}}/3)`;
            }}
        }}
        
        function uploadAllImages(userId, filaIdx) {{
            if (!window.selectedImages.every(img => img !== null)) {{
                alert('‚ùå Por favor selecciona las 3 im√°genes antes de subir');
                return;
            }}
            
            console.log('üöÄ Iniciando subida de 3 im√°genes...');
            
            // Deshabilitar bot√≥n y mostrar loading
            const uploadBtn = document.getElementById('uploadImagesBtn');
            const originalContent = uploadBtn.innerHTML;
            uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Subiendo im√°genes...';
            uploadBtn.style.pointerEvents = 'none';
            
            // Crear FormData
            const formData = new FormData();
            formData.append('user_id', userId);
            formData.append('fila_idx', filaIdx);
            
            // Agregar im√°genes con nombres espec√≠ficos
            formData.append('imagen_consumo1', window.selectedImages[0]);
            formData.append('imagen_consumo2', window.selectedImages[1]);
            formData.append('imagen_pathloss', window.selectedImages[2]);
            
            // Enviar al servidor
            fetch('/subir_imagenes_electricas', {{
                method: 'POST',
                body: formData
            }})
            .then(response => response.json())
            .then(data => {{
                console.log('üì§ Respuesta del servidor:', data);
                
                if (data.success) {{
                    // Mostrar notificaci√≥n de √©xito
                    mostrarNotificacionExito(
                        'üéâ ¬°Im√°genes Subidas Exitosamente!',
                        `Las 3 im√°genes han sido insertadas en la hoja "2. Electricas - Dise√±o log- Fis":\\n\\n` +
                        `üîã Consumo energ√≠a 1: ${{data.imagen1_rango || 'C14:D20'}}\\n` +
                        `üîã Consumo energ√≠a 2: ${{data.imagen2_rango || 'E14:G20'}}\\n` +
                        `üì° Simulaci√≥n pathloss: ${{data.imagen3_rango || 'B39:G55'}}\\n\\n` +
                        `‚úÖ Archivos guardados permanentemente`
                    );
                    
                    // Cerrar modal despu√©s de un momento
                    setTimeout(() => {{
                        closeImageModal();
                    }}, 2000);
                }} else {{
                    alert(`‚ùå Error subiendo im√°genes: ${{data.error || 'Error desconocido'}}`);
                    uploadBtn.innerHTML = originalContent;
                    uploadBtn.style.pointerEvents = 'auto';
                }}
            }})
            .catch(error => {{
                console.error('‚ùå Error de conexi√≥n:', error);
                alert('‚ùå Error de conexi√≥n al subir im√°genes');
                uploadBtn.innerHTML = originalContent;
                uploadBtn.style.pointerEvents = 'auto';
            }});
        }}
        
        function closeImageModal() {{
            if (window.currentImageModal) {{
                document.body.removeChild(window.currentImageModal);
                window.currentImageModal = null;
                window.selectedImages = null;
                console.log('‚úÖ Modal de im√°genes cerrado');
            }}
        }}
        
        // FUNCI√ìN PARA SUBIR FORMATO KMZ CON VISUALIZACI√ìN
        function subirFormatoKMZ(userId, filaIdx) {{
            console.log('üó∫Ô∏è Iniciando subida de formato KMZ para:', userId);
            
            // Crear modal para selecci√≥n de KMZ + imagen con previsualizaci√≥n
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.9);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10002;
                overflow-y: auto;
                padding: 20px;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #2c3e50 0%, #4a6741 100%);
                    border-radius: 20px;
                    padding: 30px;
                    max-width: 700px;
                    width: 100%;
                    max-height: 90vh;
                    overflow-y: auto;
                    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
                    border: 2px solid #ffd89b;
                ">
                    <div style="text-align: center; margin-bottom: 30px;">
                        <h2 style="color: #ffd89b; margin: 0; font-size: 1.8rem; font-weight: 700;">
                            üó∫Ô∏è Subir Formato KMZ
                        </h2>
                        <p style="color: rgba(255, 255, 255, 0.8); margin: 10px 0; font-size: 1rem;">
                            Sube un archivo KMZ y una imagen para la hoja "3. Formato KMZ"
                        </p>
                        <div style="background: rgba(255, 216, 155, 0.1); padding: 15px; border-radius: 10px; margin: 15px 0;">
                            <p style="color: #ffd89b; margin: 0; font-size: 0.9rem;">
                                <strong>Destinos:</strong><br>
                                üìÑ Archivo KMZ: Celda C12<br>
                                üñºÔ∏è Imagen: Rango B21:F42
                            </p>
                        </div>
                    </div>
                    
                    <!-- √Årea de subida de archivos -->
                    <div id="kmzUploadContainer">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                            
                            <!-- Archivo KMZ -->
                            <div class="kmz-upload-box" data-type="kmz">
                                <div style="
                                    border: 2px dashed #ffd89b;
                                    border-radius: 10px;
                                    padding: 20px;
                                    text-align: center;
                                    cursor: pointer;
                                    transition: all 0.3s ease;
                                    min-height: 200px;
                                    display: flex;
                                    flex-direction: column;
                                    justify-content: center;
                                    align-items: center;
                                " onclick="selectKMZFile()">
                                    <i class="fas fa-map-marked-alt" style="font-size: 2rem; color: #ffd89b; margin-bottom: 10px;"></i>
                                    <h3 style="color: #ffd89b; margin: 0; font-size: 1rem;">Archivo KMZ</h3>
                                    <p style="color: rgba(255, 255, 255, 0.6); font-size: 0.8rem; margin: 5px 0;">Celda C12</p>
                                    <p style="color: rgba(255, 255, 255, 0.4); font-size: 0.7rem; margin: 10px 0;">Clic para seleccionar KMZ</p>
                                    <div class="kmz-preview" style="width: 100%; margin-top: 10px; display: none;">
                                        <div style="background: rgba(255, 216, 155, 0.2); padding: 10px; border-radius: 5px;">
                                            <p class="kmz-filename" style="color: #ffd89b; margin: 0; font-size: 0.8rem; word-break: break-all;"></p>
                                            <p class="kmz-size" style="color: rgba(255, 255, 255, 0.6); margin: 5px 0 0 0; font-size: 0.7rem;"></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Imagen -->
                            <div class="kmz-upload-box" data-type="image">
                                <div style="
                                    border: 2px dashed #ffd89b;
                                    border-radius: 10px;
                                    padding: 20px;
                                    text-align: center;
                                    cursor: pointer;
                                    transition: all 0.3s ease;
                                    min-height: 200px;
                                    display: flex;
                                    flex-direction: column;
                                    justify-content: center;
                                    align-items: center;
                                " onclick="selectKMZImage()">
                                    <i class="fas fa-image" style="font-size: 2rem; color: #ffd89b; margin-bottom: 10px;"></i>
                                    <h3 style="color: #ffd89b; margin: 0; font-size: 1rem;">Imagen</h3>
                                    <p style="color: rgba(255, 255, 255, 0.6); font-size: 0.8rem; margin: 5px 0;">B21:G42</p>
                                    <p style="color: rgba(255, 255, 255, 0.4); font-size: 0.7rem; margin: 10px 0;">Clic para seleccionar imagen</p>
                                    <div class="image-preview" style="width: 100%; max-height: 150px; overflow: hidden; border-radius: 5px; margin-top: 10px; display: none;">
                                        <img class="preview-img" style="width: 100%; height: auto; object-fit: cover;">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Inputs ocultos para archivos -->
                    <input type="file" id="hiddenKMZInput" accept=".kmz,.kml" style="display: none;">
                    <input type="file" id="hiddenImageKMZInput" accept="image/*" style="display: none;">
                    
                    <!-- Botones de acci√≥n -->
                    <div style="display: flex; gap: 15px; justify-content: center; margin-top: 30px;">
                        <button id="uploadKMZBtn" onclick="uploadKMZFiles('{user_id}', '{fila_idx}')" style="
                            background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
                            color: white;
                            border: none;
                            padding: 15px 30px;
                            border-radius: 10px;
                            font-size: 1rem;
                            font-weight: bold;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            opacity: 0.5;
                            pointer-events: none;
                        ">
                            <i class="fas fa-upload"></i> Subir Archivos
                        </button>
                        <button onclick="closeKMZModal()" style="
                            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
                            color: white;
                            border: none;
                            padding: 15px 30px;
                            border-radius: 10px;
                            font-size: 1rem;
                            font-weight: bold;
                            cursor: pointer;
                            transition: all 0.3s ease;
                        ">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            window.currentKMZModal = modal;
            window.selectedKMZFile = null;
            window.selectedKMZImage = null;
            
            // Configurar inputs de archivos
            const kmzInput = document.getElementById('hiddenKMZInput');
            const imageInput = document.getElementById('hiddenImageKMZInput');
            
            kmzInput.addEventListener('change', handleKMZFileSelection);
            imageInput.addEventListener('change', handleKMZImageSelection);
            
            console.log('‚úÖ Modal de KMZ creado correctamente');
        }}
        
        function selectKMZFile() {{
            document.getElementById('hiddenKMZInput').click();
        }}
        
        function selectKMZImage() {{
            document.getElementById('hiddenImageKMZInput').click();
        }}
        
        function handleKMZFileSelection(event) {{
            const file = event.target.files[0];
            if (!file) return;
            
            // Validar que sea archivo KMZ/KML
            const validExtensions = ['.kmz', '.kml'];
            const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
            
            if (!validExtensions.includes(fileExtension)) {{
                alert('‚ùå Por favor selecciona solo archivos KMZ o KML');
                return;
            }}
            
            // Validar tama√±o (m√°ximo 50MB para KMZ)
            if (file.size > 50 * 1024 * 1024) {{
                alert('‚ùå El archivo KMZ es muy grande. M√°ximo 50MB permitido.');
                return;
            }}
            
            console.log(`üìÑ Archivo KMZ seleccionado:`, file.name);
            
            // Guardar archivo
            window.selectedKMZFile = file;
            
            // Mostrar previsualizaci√≥n
            const uploadBox = document.querySelector('[data-type="kmz"]');
            const previewContainer = uploadBox.querySelector('.kmz-preview');
            const filenameElement = uploadBox.querySelector('.kmz-filename');
            const sizeElement = uploadBox.querySelector('.kmz-size');
            
            filenameElement.textContent = file.name;
            sizeElement.textContent = `Tama√±o: ${{(file.size / 1024 / 1024).toFixed(2)}} MB`;
            previewContainer.style.display = 'block';
            
            // Cambiar estilo del box
            const boxDiv = uploadBox.querySelector('div');
            boxDiv.style.border = '2px solid #ffd89b';
            boxDiv.style.background = 'rgba(255, 216, 155, 0.1)';
            
            console.log(`‚úÖ Previsualizaci√≥n KMZ mostrada`);
            
            // Verificar si ambos archivos est√°n seleccionados
            checkKMZFilesSelected();
            
            // Limpiar input
            event.target.value = '';
        }}
        
        function handleKMZImageSelection(event) {{
            const file = event.target.files[0];
            if (!file) return;
            
            // Validar que sea imagen
            if (!file.type.startsWith('image/')) {{
                alert('‚ùå Por favor selecciona solo archivos de imagen (JPG, PNG, etc.)');
                return;
            }}
            
            // Validar tama√±o (m√°ximo 10MB)
            if (file.size > 10 * 1024 * 1024) {{
                alert('‚ùå La imagen es muy grande. M√°ximo 10MB permitido.');
                return;
            }}
            
            console.log(`üñºÔ∏è Imagen KMZ seleccionada:`, file.name);
            
            // Guardar archivo
            window.selectedKMZImage = file;
            
            // Mostrar previsualizaci√≥n
            const reader = new FileReader();
            reader.onload = function(e) {{
                const uploadBox = document.querySelector('[data-type="image"]');
                const previewContainer = uploadBox.querySelector('.image-preview');
                const previewImage = uploadBox.querySelector('.preview-img');
                
                previewImage.src = e.target.result;
                previewContainer.style.display = 'block';
                
                // Cambiar estilo del box
                const boxDiv = uploadBox.querySelector('div');
                boxDiv.style.border = '2px solid #ffd89b';
                boxDiv.style.background = 'rgba(255, 216, 155, 0.1)';
                
                console.log(`‚úÖ Previsualizaci√≥n imagen KMZ mostrada`);
                
                // Verificar si ambos archivos est√°n seleccionados
                checkKMZFilesSelected();
            }};
            reader.readAsDataURL(file);
            
            // Limpiar input
            event.target.value = '';
        }}
        
        function checkKMZFilesSelected() {{
            const bothSelected = window.selectedKMZFile && window.selectedKMZImage;
            const uploadBtn = document.getElementById('uploadKMZBtn');
            
            if (bothSelected) {{
                uploadBtn.style.opacity = '1';
                uploadBtn.style.pointerEvents = 'auto';
                uploadBtn.innerHTML = '<i class="fas fa-upload"></i> Subir KMZ + Imagen ‚úÖ';
                console.log('‚úÖ Ambos archivos KMZ seleccionados, bot√≥n habilitado');
            }} else {{
                const kmzSelected = window.selectedKMZFile ? '‚úÖ' : '‚ùå';
                const imgSelected = window.selectedKMZImage ? '‚úÖ' : '‚ùå';
                uploadBtn.innerHTML = `<i class="fas fa-upload"></i> KMZ ${{kmzSelected}} | IMG ${{imgSelected}}`;
            }}
        }}
        
        function uploadKMZFiles(userId, filaIdx) {{
            if (!window.selectedKMZFile || !window.selectedKMZImage) {{
                alert('‚ùå Por favor selecciona tanto el archivo KMZ como la imagen');
                return;
            }}
            
            console.log('üöÄ Iniciando subida de KMZ + imagen...');
            
            // Deshabilitar bot√≥n y mostrar loading
            const uploadBtn = document.getElementById('uploadKMZBtn');
            const originalContent = uploadBtn.innerHTML;
            uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Subiendo archivos...';
            uploadBtn.style.pointerEvents = 'none';
            
            // Crear FormData
            const formData = new FormData();
            formData.append('user_id', userId);
            formData.append('fila_idx', filaIdx);
            formData.append('archivo_kmz', window.selectedKMZFile);
            formData.append('imagen_kmz', window.selectedKMZImage);
            
            // Enviar al servidor
            fetch('/subir_formato_kmz', {{
                method: 'POST',
                body: formData
            }})
            .then(response => response.json())
            .then(data => {{
                console.log('üì§ Respuesta del servidor:', data);
                
                if (data.success) {{
                    // Mostrar notificaci√≥n de √©xito
                    mostrarNotificacionExito(
                        'üéâ ¬°Archivos KMZ Subidos Exitosamente!',
                        `Los archivos han sido insertados en la hoja "3. Formato KMZ":\\n\\n` +
                        `üìÑ Archivo KMZ: ${{data.kmz_celda || 'C12'}}\\n` +
                        `üñºÔ∏è Imagen: ${{data.imagen_rango || 'B21:G42'}}\\n\\n` +
                        `‚úÖ Archivos guardados permanentemente`
                    );
                    
                    // Cerrar modal despu√©s de un momento
                    setTimeout(() => {{
                        closeKMZModal();
                    }}, 2000);
                }} else {{
                    alert(`‚ùå Error subiendo archivos KMZ: ${{data.error || 'Error desconocido'}}`);
                    uploadBtn.innerHTML = originalContent;
                    uploadBtn.style.pointerEvents = 'auto';
                }}
            }})
            .catch(error => {{
                console.error('‚ùå Error de conexi√≥n:', error);
                alert('‚ùå Error de conexi√≥n al subir archivos KMZ');
                uploadBtn.innerHTML = originalContent;
                uploadBtn.style.pointerEvents = 'auto';
            }});
        }}
        
        function closeKMZModal() {{
            if (window.currentKMZModal) {{
                document.body.removeChild(window.currentKMZModal);
                window.currentKMZModal = null;
                window.selectedKMZFile = null;
                window.selectedKMZImage = null;
                console.log('‚úÖ Modal de KMZ cerrado');
            }}
        }}
        
        function subirAnalisisRedFrecuencia(userId, filaIdx) {{
                    console.log('üîÑ Subiendo An√°lisis de Red y Frecuencia para:', userId);
                    
                    // Crear input de archivo
                    const fileInput = document.createElement('input');
                    fileInput.type = 'file';
                    fileInput.accept = '.doc,.docx,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document';
                    fileInput.style.display = 'none';
                    
                    fileInput.addEventListener('change', function(e) {{
                        const file = e.target.files[0];
                        if (file) {{
                            console.log('üìÑ Archivo seleccionado:', file.name);
                            
                            // Crear FormData para enviar el archivo
                            const formData = new FormData();
                            formData.append('archivo_word', file);
                            formData.append('user_id', userId);
                            formData.append('fila_idx', filaIdx);
                            formData.append('destino_hoja', '1. Analisis de Red y Frecuencia');
                            formData.append('destino_celda', 'C12');  // CAMBIO: D12 est√° combinada, C12 funciona
                            
                            // Mostrar indicador de carga
                            const button = document.querySelector('.upload-step-button');
                            const originalContent = button.innerHTML;
                            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Subiendo archivo...';
                            button.disabled = true;
                            
                            // Enviar archivo al servidor
                            fetch('/subir_analisis_red_frecuencia', {{
                                method: 'POST',
                                body: formData
                            }})
                            .then(response => {{
                                console.log('üì• Respuesta recibida del servidor:', response.status);
                                return response.json();
                            }})
                            .then(data => {{
                                console.log('üìä Datos recibidos:', data);
                                
                                if (data.success) {{
                                    // √âxito - cambiar bot√≥n a completado
                                    button.innerHTML = '<i class="fas fa-check-circle"></i> ‚úÖ An√°lisis de Red y Frecuencia DOC - Completado';
                                    button.style.background = 'linear-gradient(135deg, #00ff88 0%, #00cc6a 100%)';
                                    button.disabled = true;
                                    
                                    // Mostrar notificaci√≥n de √©xito con m√°s detalles
                                    mostrarNotificacionExito('¬°Archivo Subido Exitosamente!', 
                                        `${{data.message}}\\n\\nüìÅ Archivo: ${{data.archivo_guardado}}\\nüìä Hoja: ${{data.hoja}}\\nüìç Celda: ${{data.celda}}`
                                    );
                                    
                                    console.log('‚úÖ Archivo subido exitosamente:', data.message);
                                    
                                    // Mostrar tambi√©n un alert para confirmar
                                    alert(`üéâ ¬°ARCHIVO SUBIDO EXITOSAMENTE!\\n\\nüìÑ Archivo: ${{data.message}}\\nüìÅ Guardado como: ${{data.archivo_guardado}}\\nüìä Integrado en hoja: "${{data.hoja}}"\\nüìç Celda: ${{data.celda}}`);
                                    
                                }} else {{
                                    // Error - restaurar bot√≥n
                                    button.innerHTML = originalContent;
                                    button.disabled = false;
                                    console.error('‚ùå Error del servidor:', data.error);
                                    alert('‚ùå Error al subir archivo: ' + data.error);
                                }}
                            }})
                            .catch(error => {{
                                console.error('‚ùå Error:', error);
                                button.innerHTML = originalContent;
                                button.disabled = false;
                                alert('‚ùå Error de conexi√≥n al subir archivo');
                            }});
                        }}
                    }});
                    
                    // Activar el selector de archivos
                    document.body.appendChild(fileInput);
                    fileInput.click();
                    document.body.removeChild(fileInput);
                }}
                
                function subirEstudioInformacion(userId, filaIdx) {{
                    console.log('üìä Iniciando subida de Estudio de Informaci√≥n para:', userId);
                    
                    // Crear modal para selecci√≥n de 6 im√°genes + 2 PDFs con previsualizaci√≥n
                    const modal = document.createElement('div');
                    modal.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.9);
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        z-index: 10003;
                        overflow-y: auto;
                        padding: 20px;
                    `;
                    
                    modal.innerHTML = `
                        <div style="
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            border-radius: 20px;
                            padding: 30px;
                            max-width: 900px;
                            width: 100%;
                            max-height: 90vh;
                            overflow-y: auto;
                            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
                            border: 2px solid #667eea;
                        ">
                            <div style="text-align: center; margin-bottom: 25px;">
                                <h2 style="color: white; margin: 0; font-size: 1.8rem; font-weight: 700;">
                                    <i class="fas fa-chart-line"></i> Estudio de Informaci√≥n
                                </h2>
                                <p style="color: rgba(255, 255, 255, 0.8); margin: 10px 0 0 0; font-size: 1rem;">
                                    Sube 6 im√°genes y 2 archivos PDF para la hoja "4. Estudio de informaci√≥n"
                                </p>
                            </div>
                            
                            <!-- Secci√≥n de 6 Im√°genes -->
                            <div style="margin-bottom: 25px;">
                                <h3 style="color: white; margin-bottom: 15px; font-size: 1.2rem;">
                                    <i class="fas fa-images"></i> Im√°genes (6 archivos)
                                </h3>
                                <div style="
                                    border: 3px dashed rgba(255, 255, 255, 0.3);
                                    border-radius: 15px;
                                    padding: 20px;
                                    text-align: center;
                                    background: rgba(255, 255, 255, 0.05);
                                    cursor: pointer;
                                    transition: all 0.3s ease;
                                " onclick="document.getElementById('imagenesEstudioInput').click()" 
                                   onmouseover="this.style.borderColor='rgba(255, 255, 255, 0.6)'; this.style.background='rgba(255, 255, 255, 0.1)'"
                                   onmouseout="this.style.borderColor='rgba(255, 255, 255, 0.3)'; this.style.background='rgba(255, 255, 255, 0.05)'">
                                    <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: rgba(255, 255, 255, 0.6); margin-bottom: 15px;"></i>
                                    <p style="color: white; font-size: 1.1rem; margin: 0;">Haz clic para seleccionar 6 im√°genes</p>
                                    <p style="color: rgba(255, 255, 255, 0.7); font-size: 0.9rem; margin: 5px 0 0 0;">
                                        Formatos: JPG, PNG, GIF | M√°ximo 10MB cada una
                                    </p>
                                </div>
                                <input type="file" id="imagenesEstudioInput" accept="image/*" multiple style="display: none;">
                                <div id="imagenesEstudioPreview" style="margin-top: 15px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;"></div>
                            </div>
                            
                            <!-- Secci√≥n de 2 PDFs -->
                            <div style="margin-bottom: 25px;">
                                <h3 style="color: white; margin-bottom: 15px; font-size: 1.2rem;">
                                    <i class="fas fa-file-pdf"></i> Archivos PDF (2 archivos)
                                </h3>
                                <div style="
                                    border: 3px dashed rgba(255, 255, 255, 0.3);
                                    border-radius: 15px;
                                    padding: 20px;
                                    text-align: center;
                                    background: rgba(255, 255, 255, 0.05);
                                    cursor: pointer;
                                    transition: all 0.3s ease;
                                " onclick="document.getElementById('pdfsEstudioInput').click()"
                                   onmouseover="this.style.borderColor='rgba(255, 255, 255, 0.6)'; this.style.background='rgba(255, 255, 255, 0.1)'"
                                   onmouseout="this.style.borderColor='rgba(255, 255, 255, 0.3)'; this.style.background='rgba(255, 255, 255, 0.05)'">
                                    <i class="fas fa-file-pdf" style="font-size: 3rem; color: #ff6b6b; margin-bottom: 15px;"></i>
                                    <p style="color: white; font-size: 1.1rem; margin: 0;">Haz clic para seleccionar 2 archivos PDF</p>
                                    <p style="color: rgba(255, 255, 255, 0.7); font-size: 0.9rem; margin: 5px 0 0 0;">
                                        M√°ximo 15MB cada archivo PDF
                                    </p>
                                </div>
                                <input type="file" id="pdfsEstudioInput" accept=".pdf,application/pdf" multiple style="display: none;">
                                <div id="pdfsEstudioPreview" style="margin-top: 15px;"></div>
                            </div>
                            
                            <!-- Botones de acci√≥n -->
                            <div style="display: flex; gap: 15px; justify-content: center; margin-top: 30px;">
                                <button onclick="closeEstudioModal()" style="
                                    background: rgba(255, 255, 255, 0.1);
                                    color: white;
                                    border: 2px solid rgba(255, 255, 255, 0.3);
                                    padding: 12px 25px;
                                    border-radius: 10px;
                                    cursor: pointer;
                                    font-size: 1rem;
                                    font-weight: 600;
                                    transition: all 0.3s ease;
                                " onmouseover="this.style.background='rgba(255, 255, 255, 0.2)'"
                                   onmouseout="this.style.background='rgba(255, 255, 255, 0.1)'">
                                    <i class="fas fa-times"></i> Cancelar
                                </button>
                                <button id="uploadEstudioBtn" onclick="uploadEstudioFiles('{user_id}', '{fila_idx}')" style="
                                    background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
                                    color: #192133;
                                    border: none;
                                    padding: 12px 25px;
                                    border-radius: 10px;
                                    cursor: pointer;
                                    font-size: 1rem;
                                    font-weight: 600;
                                    transition: all 0.3s ease;
                                    box-shadow: 0 4px 15px rgba(0, 255, 136, 0.4);
                                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0, 255, 136, 0.6)'"
                                   onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(0, 255, 136, 0.4)'">
                                    <i class="fas fa-upload"></i> Subir Archivos
                                </button>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                    window.currentEstudioModal = modal;
                    
                    // Configurar evento para selecci√≥n de im√°genes
                    const imagenesInput = document.getElementById('imagenesEstudioInput');
                    imagenesInput.addEventListener('change', function(e) {{
                        const files = Array.from(e.target.files);
                        if (files.length > 6) {{
                            alert('‚ùå Solo puedes seleccionar m√°ximo 6 im√°genes');
                            e.target.value = '';
                            return;
                        }}
                        
                        window.selectedEstudioImages = files;
                        displayImagenesEstudioPreview(files);
                    }});
                    
                    // Configurar evento para selecci√≥n de PDFs
                    const pdfsInput = document.getElementById('pdfsEstudioInput');
                    pdfsInput.addEventListener('change', function(e) {{
                        const files = Array.from(e.target.files);
                        if (files.length > 2) {{
                            alert('‚ùå Solo puedes seleccionar m√°ximo 2 archivos PDF');
                            e.target.value = '';
                            return;
                        }}
                        
                        window.selectedEstudioPDFs = files;
                        displayPDFsEstudioPreview(files);
                    }});
                }}
                
                function displayImagenesEstudioPreview(files) {{
                    const preview = document.getElementById('imagenesEstudioPreview');
                    preview.innerHTML = '';
                    
                    files.forEach((file, index) => {{
                        const reader = new FileReader();
                        reader.onload = function(e) {{
                            const div = document.createElement('div');
                            div.style.cssText = `
                                position: relative;
                                border-radius: 10px;
                                overflow: hidden;
                                background: rgba(255, 255, 255, 0.1);
                                padding: 10px;
                            `;
                            
                            div.innerHTML = `
                                <img src="${{e.target.result}}" style="
                                    width: 100%;
                                    height: 120px;
                                    object-fit: cover;
                                    border-radius: 8px;
                                    margin-bottom: 8px;
                                ">
                                <p style="color: white; font-size: 0.8rem; margin: 0; text-align: center; word-break: break-all;">
                                    ${{file.name}}
                                </p>
                                <p style="color: rgba(255, 255, 255, 0.7); font-size: 0.7rem; margin: 2px 0 0 0; text-align: center;">
                                    ${{(file.size / 1024 / 1024).toFixed(2)}} MB
                                </p>
                            `;
                            
                            preview.appendChild(div);
                        }};
                        reader.readAsDataURL(file);
                    }});
                }}
                
                function displayPDFsEstudioPreview(files) {{
                    const preview = document.getElementById('pdfsEstudioPreview');
                    preview.innerHTML = '';
                    
                    files.forEach((file, index) => {{
                        const div = document.createElement('div');
                        div.style.cssText = `
                            background: rgba(255, 255, 255, 0.1);
                            border-radius: 10px;
                            padding: 15px;
                            margin-bottom: 10px;
                            display: flex;
                            align-items: center;
                            gap: 15px;
                        `;
                        
                        div.innerHTML = `
                            <i class="fas fa-file-pdf" style="font-size: 2rem; color: #ff6b6b;"></i>
                            <div style="flex: 1;">
                                <p style="color: white; font-size: 0.9rem; margin: 0; font-weight: 600;">
                                    ${{file.name}}
                                </p>
                                <p style="color: rgba(255, 255, 255, 0.7); font-size: 0.8rem; margin: 2px 0 0 0;">
                                    ${{(file.size / 1024 / 1024).toFixed(2)}} MB
                                </p>
                            </div>
                        `;
                        
                        preview.appendChild(div);
                    }});
                }}
                
                function uploadEstudioFiles(userId, filaIdx) {{
                    if (!window.selectedEstudioImages || window.selectedEstudioImages.length !== 6) {{
                        alert('‚ùå Por favor selecciona exactamente 6 im√°genes');
                        return;
                    }}
                    
                    if (!window.selectedEstudioPDFs || window.selectedEstudioPDFs.length !== 2) {{
                        alert('‚ùå Por favor selecciona exactamente 2 archivos PDF');
                        return;
                    }}
                    
                    console.log('üöÄ Iniciando subida de archivos de estudio...');
                    
                    // Deshabilitar bot√≥n y mostrar loading
                    const uploadBtn = document.getElementById('uploadEstudioBtn');
                    const originalContent = uploadBtn.innerHTML;
                    uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Subiendo archivos...';
                    uploadBtn.style.pointerEvents = 'none';
                    
                    // Crear FormData
                    const formData = new FormData();
                    formData.append('user_id', userId);
                    formData.append('fila_idx', filaIdx);
                    
                    // Agregar las 6 im√°genes
                    window.selectedEstudioImages.forEach((file, index) => {{
                        formData.append('imagenes_estudio', file);
                    }});
                    
                    // Agregar los 2 PDFs
                    window.selectedEstudioPDFs.forEach((file, index) => {{
                        formData.append('pdfs_estudio', file);
                    }});
                    
                    // Enviar al servidor
                    fetch('/subir_estudio_informacion', {{
                        method: 'POST',
                        body: formData
                    }})
                    .then(response => response.json())
                    .then(data => {{
                        console.log('üì§ Respuesta del servidor:', data);
                        
                        if (data.success) {{
                            // Mostrar notificaci√≥n de √©xito
                            mostrarNotificacionExito(
                                'üéâ ¬°Archivos de Estudio Subidos Exitosamente!',
                                `Los archivos han sido insertados en la hoja "4. Estudio de informaci√≥n":\\n\\n` +
                                `üñºÔ∏è 6 Im√°genes insertadas en rangos espec√≠ficos\\n` +
                                `üìÑ 2 PDFs embebidos en celdas AB121 y AB166\\n\\n` +
                                `‚úÖ Archivos guardados permanentemente`
                            );
                            
                            // Cerrar modal despu√©s de un momento
                            setTimeout(() => {{
                                closeEstudioModal();
                            }}, 2000);
                        }} else {{
                            alert(`‚ùå Error subiendo archivos de estudio: ${{data.error || 'Error desconocido'}}`);
                            uploadBtn.innerHTML = originalContent;
                            uploadBtn.style.pointerEvents = 'auto';
                        }}
                    }})
                    .catch(error => {{
                        console.error('‚ùå Error de conexi√≥n:', error);
                        alert('‚ùå Error de conexi√≥n al subir archivos de estudio');
                        uploadBtn.innerHTML = originalContent;
                        uploadBtn.style.pointerEvents = 'auto';
                    }});
                }}
                
                function closeEstudioModal() {{
                    if (window.currentEstudioModal) {{
                        document.body.removeChild(window.currentEstudioModal);
                        window.currentEstudioModal = null;
                        window.selectedEstudioImages = null;
                        window.selectedEstudioPDFs = null;
                        console.log('‚úÖ Modal de Estudio de Informaci√≥n cerrado');
                    }}
                }}
                
                function subirExcelImagen(userId, filaIdx) {{
                    console.log('üìä Iniciando subida de Excel + Imagen para:', userId);
                    
                    // Crear modal para selecci√≥n de 1 imagen + 1 Excel con previsualizaci√≥n
                    const modal = document.createElement('div');
                    modal.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.9);
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        z-index: 10004;
                        overflow-y: auto;
                        padding: 20px;
                    `;
                    
                    modal.innerHTML = `
                        <div style="
                            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                            border-radius: 20px;
                            padding: 30px;
                            max-width: 700px;
                            width: 100%;
                            max-height: 90vh;
                            overflow-y: auto;
                            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
                            border: 2px solid #f093fb;
                        ">
                            <div style="text-align: center; margin-bottom: 25px;">
                                <h2 style="color: white; margin: 0; font-size: 1.8rem; font-weight: 700;">
                                    <i class="fas fa-file-excel"></i> Excel + Imagen
                                </h2>
                                <p style="color: rgba(255, 255, 255, 0.8); margin: 10px 0 0 0; font-size: 1rem;">
                                    Sube 1 imagen y 1 archivo Excel para la hoja "5. Estudio de informacion B"
                                </p>
                            </div>
                            
                            <!-- Secci√≥n de Imagen -->
                            <div style="margin-bottom: 25px;">
                                <h3 style="color: white; margin-bottom: 15px; font-size: 1.2rem;">
                                    <i class="fas fa-image"></i> Imagen (1 archivo)
                                </h3>
                                <div style="
                                    border: 3px dashed rgba(255, 255, 255, 0.3);
                                    border-radius: 15px;
                                    padding: 20px;
                                    text-align: center;
                                    background: rgba(255, 255, 255, 0.05);
                                    cursor: pointer;
                                    transition: all 0.3s ease;
                                " onclick="document.getElementById('imagenExcelInput').click()" 
                                   onmouseover="this.style.borderColor='rgba(255, 255, 255, 0.6)'; this.style.background='rgba(255, 255, 255, 0.1)'"
                                   onmouseout="this.style.borderColor='rgba(255, 255, 255, 0.3)'; this.style.background='rgba(255, 255, 255, 0.05)'">
                                    <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: rgba(255, 255, 255, 0.6); margin-bottom: 15px;"></i>
                                    <p style="color: white; font-size: 1.1rem; margin: 0;">Haz clic para seleccionar 1 imagen</p>
                                    <p style="color: rgba(255, 255, 255, 0.7); font-size: 0.9rem; margin: 5px 0 0 0;">
                                        Formatos: JPG, PNG, GIF | M√°ximo 10MB | Rango: B36:AJ45
                                    </p>
                                </div>
                                <input type="file" id="imagenExcelInput" accept="image/*" style="display: none;">
                                <div id="imagenExcelPreview" style="margin-top: 15px;"></div>
                            </div>
                            
                            <!-- Secci√≥n de Excel -->
                            <div style="margin-bottom: 25px;">
                                <h3 style="color: white; margin-bottom: 15px; font-size: 1.2rem;">
                                    <i class="fas fa-file-excel"></i> Archivo Excel (1 archivo)
                                </h3>
                                <div style="
                                    border: 3px dashed rgba(255, 255, 255, 0.3);
                                    border-radius: 15px;
                                    padding: 20px;
                                    text-align: center;
                                    background: rgba(255, 255, 255, 0.05);
                                    cursor: pointer;
                                    transition: all 0.3s ease;
                                " onclick="document.getElementById('archivoExcelInput').click()"
                                   onmouseover="this.style.borderColor='rgba(255, 255, 255, 0.6)'; this.style.background='rgba(255, 255, 255, 0.1)'"
                                   onmouseout="this.style.borderColor='rgba(255, 255, 255, 0.3)'; this.style.background='rgba(255, 255, 255, 0.05)'">
                                    <i class="fas fa-file-excel" style="font-size: 3rem; color: #00d084; margin-bottom: 15px;"></i>
                                    <p style="color: white; font-size: 1.1rem; margin: 0;">Haz clic para seleccionar 1 archivo Excel</p>
                                    <p style="color: rgba(255, 255, 255, 0.7); font-size: 0.9rem; margin: 5px 0 0 0;">
                                        Formatos: .xlsx, .xls | M√°ximo 20MB | Celda: N52
                                    </p>
                                </div>
                                <input type="file" id="archivoExcelInput" accept=".xlsx,.xls,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel" style="display: none;">
                                <div id="archivoExcelPreview" style="margin-top: 15px;"></div>
                            </div>
                            
                            <!-- Botones de acci√≥n -->
                            <div style="display: flex; gap: 15px; justify-content: center; margin-top: 30px;">
                                <button onclick="closeExcelImagenModal()" style="
                                    background: rgba(255, 255, 255, 0.1);
                                    color: white;
                                    border: 2px solid rgba(255, 255, 255, 0.3);
                                    padding: 12px 25px;
                                    border-radius: 10px;
                                    cursor: pointer;
                                    font-size: 1rem;
                                    font-weight: 600;
                                    transition: all 0.3s ease;
                                " onmouseover="this.style.background='rgba(255, 255, 255, 0.2)'"
                                   onmouseout="this.style.background='rgba(255, 255, 255, 0.1)'">
                                    <i class="fas fa-times"></i> Cancelar
                                </button>
                                <button id="uploadExcelImagenBtn" onclick="uploadExcelImagenFiles('{user_id}', '{fila_idx}')" style="
                                    background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
                                    color: #192133;
                                    border: none;
                                    padding: 12px 25px;
                                    border-radius: 10px;
                                    cursor: pointer;
                                    font-size: 1rem;
                                    font-weight: 600;
                                    transition: all 0.3s ease;
                                    box-shadow: 0 4px 15px rgba(0, 255, 136, 0.4);
                                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0, 255, 136, 0.6)'"
                                   onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(0, 255, 136, 0.4)'">
                                    <i class="fas fa-upload"></i> Subir Archivos
                                </button>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                    window.currentExcelImagenModal = modal;
                    
                    // Configurar evento para selecci√≥n de imagen
                    const imagenInput = document.getElementById('imagenExcelInput');
                    imagenInput.addEventListener('change', function(e) {{
                        const file = e.target.files[0];
                        if (file) {{
                            window.selectedExcelImagen = file;
                            displayImagenExcelPreview(file);
                        }}
                    }});
                    
                    // Configurar evento para selecci√≥n de Excel
                    const excelInput = document.getElementById('archivoExcelInput');
                    excelInput.addEventListener('change', function(e) {{
                        const file = e.target.files[0];
                        if (file) {{
                            window.selectedArchivoExcel = file;
                            displayArchivoExcelPreview(file);
                        }}
                    }});
                }}
                
                function displayImagenExcelPreview(file) {{
                    const preview = document.getElementById('imagenExcelPreview');
                    preview.innerHTML = '';
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {{
                        const div = document.createElement('div');
                        div.style.cssText = `
                            background: rgba(255, 255, 255, 0.1);
                            border-radius: 10px;
                            padding: 15px;
                            display: flex;
                            align-items: center;
                            gap: 15px;
                        `;
                        
                        div.innerHTML = `
                            <img src="${{e.target.result}}" style="
                                width: 80px;
                                height: 80px;
                                object-fit: cover;
                                border-radius: 8px;
                            ">
                            <div style="flex: 1;">
                                <p style="color: white; font-size: 0.9rem; margin: 0; font-weight: 600;">
                                    ${{file.name}}
                                </p>
                                <p style="color: rgba(255, 255, 255, 0.7); font-size: 0.8rem; margin: 2px 0 0 0;">
                                    ${{(file.size / 1024 / 1024).toFixed(2)}} MB | Se insertar√° en rango B36:AJ45
                                </p>
                            </div>
                        `;
                        
                        preview.appendChild(div);
                    }};
                    reader.readAsDataURL(file);
                }}
                
                function displayArchivoExcelPreview(file) {{
                    const preview = document.getElementById('archivoExcelPreview');
                    preview.innerHTML = '';
                    
                    const div = document.createElement('div');
                    div.style.cssText = `
                        background: rgba(255, 255, 255, 0.1);
                        border-radius: 10px;
                        padding: 15px;
                        display: flex;
                        align-items: center;
                        gap: 15px;
                    `;
                    
                    div.innerHTML = `
                        <i class="fas fa-file-excel" style="font-size: 3rem; color: #00d084;"></i>
                        <div style="flex: 1;">
                            <p style="color: white; font-size: 0.9rem; margin: 0; font-weight: 600;">
                                ${{file.name}}
                            </p>
                            <p style="color: rgba(255, 255, 255, 0.7); font-size: 0.8rem; margin: 2px 0 0 0;">
                                ${{(file.size / 1024 / 1024).toFixed(2)}} MB | Se embebar√° en celda N52
                            </p>
                        </div>
                    `;
                    
                    preview.appendChild(div);
                }}
                
                function uploadExcelImagenFiles(userId, filaIdx) {{
                    if (!window.selectedExcelImagen) {{
                        alert('‚ùå Por favor selecciona 1 imagen');
                        return;
                    }}
                    
                    if (!window.selectedArchivoExcel) {{
                        alert('‚ùå Por favor selecciona 1 archivo Excel');
                        return;
                    }}
                    
                    console.log('üöÄ Iniciando subida de Excel + Imagen...');
                    
                    // Deshabilitar bot√≥n y mostrar loading
                    const uploadBtn = document.getElementById('uploadExcelImagenBtn');
                    const originalContent = uploadBtn.innerHTML;
                    uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Subiendo archivos...';
                    uploadBtn.style.pointerEvents = 'none';
                    
                    // Crear FormData
                    const formData = new FormData();
                    formData.append('user_id', userId);
                    formData.append('fila_idx', filaIdx);
                    formData.append('imagen_excel', window.selectedExcelImagen);
                    formData.append('archivo_excel', window.selectedArchivoExcel);
                    
                    // Enviar al servidor
                    fetch('/subir_excel_imagen', {{
                        method: 'POST',
                        body: formData
                    }})
                    .then(response => response.json())
                    .then(data => {{
                        console.log('üì§ Respuesta del servidor:', data);
                        
                        if (data.success) {{
                            // Mostrar notificaci√≥n de √©xito
                            mostrarNotificacionExito(
                                'üéâ ¬°Excel + Imagen Subidos Exitosamente!',
                                `Los archivos han sido insertados en la hoja "5. Estudio de informacion B":\\n\\n` +
                                `üñºÔ∏è Imagen insertada en rango B36:AJ45\\n` +
                                `üìä Excel embebido en celda N52\\n\\n` +
                                `‚úÖ Archivos guardados permanentemente`
                            );
                            
                            // Cerrar modal despu√©s de un momento
                            setTimeout(() => {{
                                closeExcelImagenModal();
                            }}, 2000);
                        }} else {{
                            alert(`‚ùå Error subiendo Excel + Imagen: ${{data.error || 'Error desconocido'}}`);
                            uploadBtn.innerHTML = originalContent;
                            uploadBtn.style.pointerEvents = 'auto';
                        }}
                    }})
                    .catch(error => {{
                        console.error('‚ùå Error de conexi√≥n:', error);
                        alert('‚ùå Error de conexi√≥n al subir Excel + Imagen');
                        uploadBtn.innerHTML = originalContent;
                        uploadBtn.style.pointerEvents = 'auto';
                    }});
                }}
                
                function closeExcelImagenModal() {{
                    if (window.currentExcelImagenModal) {{
                        document.body.removeChild(window.currentExcelImagenModal);
                        window.currentExcelImagenModal = null;
                        window.selectedExcelImagen = null;
                        window.selectedArchivoExcel = null;
                        console.log('‚úÖ Modal de Excel + Imagen cerrado');
                    }}
                }}
                
                function subirTorresAntenas(userId, filaIdx) {{
                    console.log('üóº Iniciando subida de Torres y Antenas para:', userId);
                    
                    // Crear modal para selecci√≥n de 3 im√°genes con previsualizaci√≥n
                    const modal = document.createElement('div');
                    modal.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.9);
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        z-index: 10005;
                        overflow-y: auto;
                        padding: 20px;
                    `;
                    
                    modal.innerHTML = `
                        <div style="
                            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
                            border-radius: 20px;
                            padding: 30px;
                            max-width: 800px;
                            width: 100%;
                            max-height: 90vh;
                            overflow-y: auto;
                            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
                            border: 2px solid #ff9a9e;
                        ">
                            <div style="text-align: center; margin-bottom: 25px;">
                                <h2 style="color: white; margin: 0; font-size: 1.8rem; font-weight: 700;">
                                    <i class="fas fa-broadcast-tower"></i> Estudio Torres y Antenas
                                </h2>
                                <p style="color: rgba(255, 255, 255, 0.8); margin: 10px 0 0 0; font-size: 1rem;">
                                    Sube 3 im√°genes para la hoja "6. Estudio torres y antenas"
                                </p>
                            </div>
                            
                            <!-- Secci√≥n de 3 Im√°genes -->
                            <div style="margin-bottom: 25px;">
                                <h3 style="color: white; margin-bottom: 15px; font-size: 1.2rem;">
                                    <i class="fas fa-images"></i> Im√°genes (3 archivos)
                                </h3>
                                <div style="
                                    border: 3px dashed rgba(255, 255, 255, 0.3);
                                    border-radius: 15px;
                                    padding: 20px;
                                    text-align: center;
                                    background: rgba(255, 255, 255, 0.05);
                                    cursor: pointer;
                                    transition: all 0.3s ease;
                                " onclick="document.getElementById('imagenesTorresInput').click()" 
                                   onmouseover="this.style.borderColor='rgba(255, 255, 255, 0.6)'; this.style.background='rgba(255, 255, 255, 0.1)'"
                                   onmouseout="this.style.borderColor='rgba(255, 255, 255, 0.3)'; this.style.background='rgba(255, 255, 255, 0.05)'">
                                    <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: rgba(255, 255, 255, 0.6); margin-bottom: 15px;"></i>
                                    <p style="color: white; font-size: 1.1rem; margin: 0;">Haz clic para seleccionar 3 im√°genes</p>
                                    <p style="color: rgba(255, 255, 255, 0.7); font-size: 0.9rem; margin: 5px 0 0 0;">
                                        Formatos: JPG, PNG, GIF | M√°ximo 10MB cada una
                                    </p>
                                    <div style="margin-top: 15px; font-size: 0.85rem; color: rgba(255, 255, 255, 0.7);">
                                        <p style="margin: 2px 0;">üìç Imagen 1: C17:AK60</p>
                                        <p style="margin: 2px 0;">üìç Imagen 2: C69:AK123</p>
                                        <p style="margin: 2px 0;">üìç Imagen 3: C134:AK173</p>
                                    </div>
                                </div>
                                <input type="file" id="imagenesTorresInput" accept="image/*" multiple style="display: none;">
                                <div id="imagenesTorresPreview" style="margin-top: 15px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;"></div>
                            </div>
                            
                            <!-- Botones de acci√≥n -->
                            <div style="display: flex; gap: 15px; justify-content: center; margin-top: 30px;">
                                <button onclick="closeTorresAntenaModal()" style="
                                    background: rgba(255, 255, 255, 0.1);
                                    color: white;
                                    border: 2px solid rgba(255, 255, 255, 0.3);
                                    padding: 12px 25px;
                                    border-radius: 10px;
                                    cursor: pointer;
                                    font-size: 1rem;
                                    font-weight: 600;
                                    transition: all 0.3s ease;
                                " onmouseover="this.style.background='rgba(255, 255, 255, 0.2)'"
                                   onmouseout="this.style.background='rgba(255, 255, 255, 0.1)'">
                                    <i class="fas fa-times"></i> Cancelar
                                </button>
                                <button id="uploadTorresBtn" onclick="uploadTorresAntenaFiles('{user_id}', '{fila_idx}')" style="
                                    background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
                                    color: #192133;
                                    border: none;
                                    padding: 12px 25px;
                                    border-radius: 10px;
                                    cursor: pointer;
                                    font-size: 1rem;
                                    font-weight: 600;
                                    transition: all 0.3s ease;
                                    box-shadow: 0 4px 15px rgba(0, 255, 136, 0.4);
                                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0, 255, 136, 0.6)'"
                                   onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(0, 255, 136, 0.4)'">
                                    <i class="fas fa-upload"></i> Subir Im√°genes
                                </button>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                    window.currentTorresAntenaModal = modal;
                    
                    // Configurar evento para selecci√≥n de im√°genes
                    const imagenesInput = document.getElementById('imagenesTorresInput');
                    imagenesInput.addEventListener('change', function(e) {{
                        const files = Array.from(e.target.files);
                        if (files.length > 3) {{
                            alert('‚ùå Solo puedes seleccionar m√°ximo 3 im√°genes');
                            e.target.value = '';
                            return;
                        }}
                        
                        window.selectedTorresImages = files;
                        displayImagenesTorresPreview(files);
                    }});
                }}
                
                function displayImagenesTorresPreview(files) {{
                    const preview = document.getElementById('imagenesTorresPreview');
                    preview.innerHTML = '';
                    
                    const rangos = ['C17:AK60', 'C69:AK123', 'C134:AK173'];
                    
                    files.forEach((file, index) => {{
                        const reader = new FileReader();
                        reader.onload = function(e) {{
                            const div = document.createElement('div');
                            div.style.cssText = `
                                position: relative;
                                border-radius: 10px;
                                overflow: hidden;
                                background: rgba(255, 255, 255, 0.1);
                                padding: 10px;
                            `;
                            
                            div.innerHTML = `
                                <img src="${{e.target.result}}" style="
                                    width: 100%;
                                    height: 120px;
                                    object-fit: cover;
                                    border-radius: 8px;
                                    margin-bottom: 8px;
                                ">
                                <p style="color: white; font-size: 0.8rem; margin: 0; text-align: center; word-break: break-all;">
                                    ${{file.name}}
                                </p>
                                <p style="color: rgba(255, 255, 255, 0.7); font-size: 0.7rem; margin: 2px 0 0 0; text-align: center;">
                                    ${{(file.size / 1024 / 1024).toFixed(2)}} MB
                                </p>
                                <p style="color: #00ff88; font-size: 0.65rem; margin: 2px 0 0 0; text-align: center; font-weight: 600;">
                                    ‚Üí ${{rangos[index] || 'N/A'}}
                                </p>
                            `;
                            
                            preview.appendChild(div);
                        }};
                        reader.readAsDataURL(file);
                    }});
                }}
                
                function uploadTorresAntenaFiles(userId, filaIdx) {{
                    if (!window.selectedTorresImages || window.selectedTorresImages.length !== 3) {{
                        alert('‚ùå Por favor selecciona exactamente 3 im√°genes');
                        return;
                    }}
                    
                    console.log('üöÄ Iniciando subida de im√°genes de torres y antenas...');
                    
                    // Deshabilitar bot√≥n y mostrar loading
                    const uploadBtn = document.getElementById('uploadTorresBtn');
                    const originalContent = uploadBtn.innerHTML;
                    uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Subiendo im√°genes...';
                    uploadBtn.style.pointerEvents = 'none';
                    
                    // Crear FormData
                    const formData = new FormData();
                    formData.append('user_id', userId);
                    formData.append('fila_idx', filaIdx);
                    
                    // Agregar las 3 im√°genes
                    window.selectedTorresImages.forEach((file, index) => {{
                        formData.append('imagenes_torres', file);
                    }});
                    
                    // Enviar al servidor
                    fetch('/subir_torres_antenas', {{
                        method: 'POST',
                        body: formData
                    }})
                    .then(response => response.json())
                    .then(data => {{
                        console.log('üì§ Respuesta del servidor:', data);
                        
                        if (data.success) {{
                            // Mostrar notificaci√≥n de √©xito
                            mostrarNotificacionExito(
                                'üéâ ¬°Im√°genes de Torres Subidas Exitosamente!',
                                `Las im√°genes han sido insertadas en la hoja "6. Estudio torres y antenas":\\n\\n` +
                                `üñºÔ∏è Imagen 1: C17:AK60\\n` +
                                `üñºÔ∏è Imagen 2: C69:AK123\\n` +
                                `üñºÔ∏è Imagen 3: C134:AK173\\n\\n` +
                                `‚úÖ Archivos guardados permanentemente`
                            );
                            
                            // Cerrar modal despu√©s de un momento
                            setTimeout(() => {{
                                closeTorresAntenaModal();
                            }}, 2000);
                        }} else {{
                            alert(`‚ùå Error subiendo im√°genes de torres: ${{data.error || 'Error desconocido'}}`);
                            uploadBtn.innerHTML = originalContent;
                            uploadBtn.style.pointerEvents = 'auto';
                        }}
                    }})
                    .catch(error => {{
                        console.error('‚ùå Error de conexi√≥n:', error);
                        alert('‚ùå Error de conexi√≥n al subir im√°genes de torres');
                        uploadBtn.innerHTML = originalContent;
                        uploadBtn.style.pointerEvents = 'auto';
                    }});
                }}
                
                function closeTorresAntenaModal() {{
                    if (window.currentTorresAntenaModal) {{
                        document.body.removeChild(window.currentTorresAntenaModal);
                        window.currentTorresAntenaModal = null;
                        window.selectedTorresImages = null;
                        console.log('‚úÖ Modal de Torres y Antenas cerrado');
                    }}
                }}
                
                function subirTorresAntenasB(userId, filaIdx) {{
                    console.log('üóº Iniciando subida de Torres y Antenas B para:', userId);
                    
                    // Crear modal para selecci√≥n de 3 im√°genes con previsualizaci√≥n
                    const modal = document.createElement('div');
                    modal.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.9);
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        z-index: 10006;
                        overflow-y: auto;
                        padding: 20px;
                    `;
                    
                    modal.innerHTML = `
                        <div style="
                            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
                            border-radius: 20px;
                            padding: 30px;
                            max-width: 800px;
                            width: 100%;
                            max-height: 90vh;
                            overflow-y: auto;
                            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
                            border: 2px solid #a8edea;
                        ">
                            <div style="text-align: center; margin-bottom: 25px;">
                                <h2 style="color: #2c3e50; margin: 0; font-size: 1.8rem; font-weight: 700;">
                                    <i class="fas fa-broadcast-tower"></i> Estudio Torres y Antenas B
                                </h2>
                                <p style="color: rgba(44, 62, 80, 0.8); margin: 10px 0 0 0; font-size: 1rem;">
                                    Sube 3 im√°genes para la hoja "7. Estudio torres y antenas B"
                                </p>
                            </div>
                            
                            <!-- Secci√≥n de 3 Im√°genes -->
                            <div style="margin-bottom: 25px;">
                                <h3 style="color: #2c3e50; margin-bottom: 15px; font-size: 1.2rem;">
                                    <i class="fas fa-images"></i> Im√°genes (3 archivos)
                                </h3>
                                <div style="
                                    border: 3px dashed rgba(44, 62, 80, 0.3);
                                    border-radius: 15px;
                                    padding: 20px;
                                    text-align: center;
                                    background: rgba(44, 62, 80, 0.05);
                                    cursor: pointer;
                                    transition: all 0.3s ease;
                                " onclick="document.getElementById('imagenesTorresBInput').click()" 
                                   onmouseover="this.style.borderColor='rgba(44, 62, 80, 0.6)'; this.style.background='rgba(44, 62, 80, 0.1)'"
                                   onmouseout="this.style.borderColor='rgba(44, 62, 80, 0.3)'; this.style.background='rgba(44, 62, 80, 0.05)'">
                                    <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: rgba(44, 62, 80, 0.6); margin-bottom: 15px;"></i>
                                    <p style="color: #2c3e50; font-size: 1.1rem; margin: 0;">Haz clic para seleccionar 3 im√°genes</p>
                                    <p style="color: rgba(44, 62, 80, 0.7); font-size: 0.9rem; margin: 5px 0 0 0;">
                                        Formatos: JPG, PNG, GIF | M√°ximo 10MB cada una
                                    </p>
                                    <div style="margin-top: 15px; font-size: 0.85rem; color: rgba(44, 62, 80, 0.7);">
                                        <p style="margin: 2px 0;">üìç Imagen 1: C15:AK58</p>
                                        <p style="margin: 2px 0;">üìç Imagen 2: C67:AK121</p>
                                        <p style="margin: 2px 0;">üìç Imagen 3: C132:AK171</p>
                                    </div>
                                </div>
                                <input type="file" id="imagenesTorresBInput" accept="image/*" multiple style="display: none;">
                                <div id="imagenesTorresBPreview" style="margin-top: 15px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;"></div>
                            </div>
                            
                            <!-- Botones de acci√≥n -->
                            <div style="display: flex; gap: 15px; justify-content: center; margin-top: 30px;">
                                <button onclick="closeTorresAntenaBModal()" style="
                                    background: rgba(44, 62, 80, 0.1);
                                    color: #2c3e50;
                                    border: 2px solid rgba(44, 62, 80, 0.3);
                                    padding: 12px 25px;
                                    border-radius: 10px;
                                    cursor: pointer;
                                    font-size: 1rem;
                                    font-weight: 600;
                                    transition: all 0.3s ease;
                                " onmouseover="this.style.background='rgba(44, 62, 80, 0.2)'"
                                   onmouseout="this.style.background='rgba(44, 62, 80, 0.1)'">
                                    <i class="fas fa-times"></i> Cancelar
                                </button>
                                <button id="uploadTorresBBtn" onclick="uploadTorresAntenaBFiles('{user_id}', '{fila_idx}')" style="
                                    background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
                                    color: #192133;
                                    border: none;
                                    padding: 12px 25px;
                                    border-radius: 10px;
                                    cursor: pointer;
                                    font-size: 1rem;
                                    font-weight: 600;
                                    transition: all 0.3s ease;
                                    box-shadow: 0 4px 15px rgba(0, 255, 136, 0.4);
                                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0, 255, 136, 0.6)'"
                                   onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(0, 255, 136, 0.4)'">
                                    <i class="fas fa-upload"></i> Subir Im√°genes
                                </button>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                    window.currentTorresAntenaBModal = modal;
                    
                    // Configurar evento para selecci√≥n de im√°genes
                    const imagenesInput = document.getElementById('imagenesTorresBInput');
                    imagenesInput.addEventListener('change', function(e) {{
                        const files = Array.from(e.target.files);
                        if (files.length > 3) {{
                            alert('‚ùå Solo puedes seleccionar m√°ximo 3 im√°genes');
                            e.target.value = '';
                            return;
                        }}
                        
                        window.selectedTorresBImages = files;
                        displayImagenesTorresBPreview(files);
                    }});
                }}
                
                function displayImagenesTorresBPreview(files) {{
                    const preview = document.getElementById('imagenesTorresBPreview');
                    preview.innerHTML = '';
                    
                    const rangos = ['C15:AK58', 'C67:AK121', 'C132:AK171'];
                    
                    files.forEach((file, index) => {{
                        const reader = new FileReader();
                        reader.onload = function(e) {{
                            const div = document.createElement('div');
                            div.style.cssText = `
                                position: relative;
                                border-radius: 10px;
                                overflow: hidden;
                                background: rgba(44, 62, 80, 0.1);
                                padding: 10px;
                            `;
                            
                            div.innerHTML = `
                                <img src="${{e.target.result}}" style="
                                    width: 100%;
                                    height: 120px;
                                    object-fit: cover;
                                    border-radius: 8px;
                                    margin-bottom: 8px;
                                ">
                                <p style="color: #2c3e50; font-size: 0.8rem; margin: 0; text-align: center; word-break: break-all;">
                                    ${{file.name}}
                                </p>
                                <p style="color: rgba(44, 62, 80, 0.7); font-size: 0.7rem; margin: 2px 0 0 0; text-align: center;">
                                    ${{(file.size / 1024 / 1024).toFixed(2)}} MB
                                </p>
                                <p style="color: #00ff88; font-size: 0.65rem; margin: 2px 0 0 0; text-align: center; font-weight: 600;">
                                    ‚Üí ${{rangos[index] || 'N/A'}}
                                </p>
                            `;
                            
                            preview.appendChild(div);
                        }};
                        reader.readAsDataURL(file);
                    }});
                }}
                
                function uploadTorresAntenaBFiles(userId, filaIdx) {{
                    if (!window.selectedTorresBImages || window.selectedTorresBImages.length !== 3) {{
                        alert('‚ùå Por favor selecciona exactamente 3 im√°genes');
                        return;
                    }}
                    
                    console.log('üöÄ Iniciando subida de im√°genes de torres B...');
                    
                    // Deshabilitar bot√≥n y mostrar loading
                    const uploadBtn = document.getElementById('uploadTorresBBtn');
                    const originalContent = uploadBtn.innerHTML;
                    uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Subiendo im√°genes...';
                    uploadBtn.style.pointerEvents = 'none';
                    
                    // Crear FormData
                    const formData = new FormData();
                    formData.append('user_id', userId);
                    formData.append('fila_idx', filaIdx);
                    
                    // Agregar las 3 im√°genes
                    window.selectedTorresBImages.forEach((file, index) => {{
                        formData.append('imagenes_torres_b', file);
                    }});
                    
                    // Enviar al servidor
                    fetch('/subir_torres_antenas_b', {{
                        method: 'POST',
                        body: formData
                    }})
                    .then(response => response.json())
                    .then(data => {{
                        console.log('üì§ Respuesta del servidor:', data);
                        
                        if (data.success) {{
                            // Mostrar notificaci√≥n de √©xito
                            mostrarNotificacionExito(
                                'üéâ ¬°Im√°genes de Torres B Subidas Exitosamente!',
                                `Las im√°genes han sido insertadas en la hoja "7. Estudio torres y antenas B":\\n\\n` +
                                `üñºÔ∏è Imagen 1: C15:AK58\\n` +
                                `üñºÔ∏è Imagen 2: C67:AK121\\n` +
                                `üñºÔ∏è Imagen 3: C132:AK171\\n\\n` +
                                `‚úÖ Archivos guardados permanentemente`
                            );
                            
                            // Cerrar modal despu√©s de un momento
                            setTimeout(() => {{
                                closeTorresAntenaBModal();
                            }}, 2000);
                        }} else {{
                            alert(`‚ùå Error subiendo im√°genes de torres B: ${{data.error || 'Error desconocido'}}`);
                            uploadBtn.innerHTML = originalContent;
                            uploadBtn.style.pointerEvents = 'auto';
                        }}
                    }})
                    .catch(error => {{
                        console.error('‚ùå Error de conexi√≥n:', error);
                        alert('‚ùå Error de conexi√≥n al subir im√°genes de torres B');
                        uploadBtn.innerHTML = originalContent;
                        uploadBtn.style.pointerEvents = 'auto';
                    }});
                }}
                
                function closeTorresAntenaBModal() {{
                    if (window.currentTorresAntenaBModal) {{
                        document.body.removeChild(window.currentTorresAntenaBModal);
                        window.currentTorresAntenaBModal = null;
                        window.selectedTorresBImages = null;
                        console.log('‚úÖ Modal de Torres y Antenas B cerrado');
                    }}
                }}
                
                function subirFactibilidadFotosA(userId, filaIdx) {{
                    console.log('üì∑ Iniciando subida de Factibilidad Fotos A para:', userId);
                    
                    // Crear modal para selecci√≥n de hasta 19 im√°genes con previsualizaci√≥n
                    const modal = document.createElement('div');
                    modal.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.9);
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        z-index: 10007;
                        overflow-y: auto;
                        padding: 20px;
                    `;
                    
                    modal.innerHTML = `
                        <div style="
                            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
                            border-radius: 20px;
                            padding: 30px;
                            max-width: 900px;
                            width: 100%;
                            max-height: 90vh;
                            overflow-y: auto;
                            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
                            border: 2px solid #84fab0;
                        ">
                            <div style="text-align: center; margin-bottom: 25px;">
                                <h2 style="color: #2c3e50; margin: 0; font-size: 1.8rem; font-weight: 700;">
                                    <i class="fas fa-camera"></i> Factibilidad Reporte Fotos A
                                </h2>
                                <p style="color: rgba(44, 62, 80, 0.8); margin: 10px 0 0 0; font-size: 1rem;">
                                    Sube hasta 19 im√°genes para la hoja "9. Factibilidad Reporte Fotos A"
                                </p>
                                <p style="color: rgba(44, 62, 80, 0.7); margin: 5px 0 0 0; font-size: 0.9rem;">
                                    ‚ö†Ô∏è Las im√°genes que no subas se marcar√°n como "N/A"
                                </p>
                            </div>
                            
                            <!-- Secci√≥n de Im√°genes -->
                            <div style="margin-bottom: 25px;">
                                <h3 style="color: #2c3e50; margin-bottom: 15px; font-size: 1.2rem;">
                                    <i class="fas fa-images"></i> Im√°genes (hasta 19 archivos)
                                </h3>
                                <div style="
                                    border: 3px dashed rgba(44, 62, 80, 0.3);
                                    border-radius: 15px;
                                    padding: 20px;
                                    text-align: center;
                                    background: rgba(44, 62, 80, 0.05);
                                    cursor: pointer;
                                    transition: all 0.3s ease;
                                " onclick="document.getElementById('imagenesFactibilidadAInput').click()" 
                                   onmouseover="this.style.borderColor='rgba(44, 62, 80, 0.6)'; this.style.background='rgba(44, 62, 80, 0.1)'"
                                   onmouseout="this.style.borderColor='rgba(44, 62, 80, 0.3)'; this.style.background='rgba(44, 62, 80, 0.05)'">
                                    <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: rgba(44, 62, 80, 0.6); margin-bottom: 15px;"></i>
                                    <p style="color: #2c3e50; font-size: 1.1rem; margin: 0;">Haz clic para seleccionar im√°genes (m√°ximo 19)</p>
                                    <p style="color: rgba(44, 62, 80, 0.7); font-size: 0.9rem; margin: 5px 0 0 0;">
                                        Formatos: JPG, PNG, GIF | M√°ximo 10MB cada una
                                    </p>
                                </div>
                                <input type="file" id="imagenesFactibilidadAInput" accept="image/*" multiple style="display: none;">
                                <div id="imagenesFactibilidadAPreview" style="margin-top: 15px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; max-height: 300px; overflow-y: auto;"></div>
                            </div>
                            
                            <!-- Botones de acci√≥n -->
                            <div style="display: flex; gap: 15px; justify-content: center; margin-top: 30px;">
                                <button onclick="closeFactibilidadFotosAModal()" style="
                                    background: rgba(44, 62, 80, 0.1);
                                    color: #2c3e50;
                                    border: 2px solid rgba(44, 62, 80, 0.3);
                                    padding: 12px 25px;
                                    border-radius: 10px;
                                    cursor: pointer;
                                    font-size: 1rem;
                                    font-weight: 600;
                                    transition: all 0.3s ease;
                                " onmouseover="this.style.background='rgba(44, 62, 80, 0.2)'"
                                   onmouseout="this.style.background='rgba(44, 62, 80, 0.1)'">
                                    <i class="fas fa-times"></i> Cancelar
                                </button>
                                <button id="uploadFactibilidadABtn" onclick="uploadFactibilidadFotosAFiles('{user_id}', '{fila_idx}')" style="
                                    background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
                                    color: #192133;
                                    border: none;
                                    padding: 12px 25px;
                                    border-radius: 10px;
                                    cursor: pointer;
                                    font-size: 1rem;
                                    font-weight: 600;
                                    transition: all 0.3s ease;
                                    box-shadow: 0 4px 15px rgba(0, 255, 136, 0.4);
                                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0, 255, 136, 0.6)'"
                                   onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(0, 255, 136, 0.4)'">
                                    <i class="fas fa-upload"></i> Procesar Im√°genes
                                </button>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                    window.currentFactibilidadFotosAModal = modal;
                    
                    // Configurar evento para selecci√≥n de im√°genes
                    const imagenesInput = document.getElementById('imagenesFactibilidadAInput');
                    imagenesInput.addEventListener('change', function(e) {{
                        const files = Array.from(e.target.files);
                        if (files.length > 19) {{
                            alert('‚ùå Solo puedes seleccionar m√°ximo 19 im√°genes');
                            e.target.value = '';
                            return;
                        }}
                        
                        window.selectedFactibilidadAImages = files;
                        displayImagenesFactibilidadAPreview(files);
                    }});
                }}
                
                function displayImagenesFactibilidadAPreview(files) {{
                    const preview = document.getElementById('imagenesFactibilidadAPreview');
                    preview.innerHTML = '';
                    
                    files.forEach((file, index) => {{
                        const reader = new FileReader();
                        reader.onload = function(e) {{
                            const div = document.createElement('div');
                            div.style.cssText = `
                                position: relative;
                                border-radius: 10px;
                                overflow: hidden;
                                background: rgba(44, 62, 80, 0.1);
                                padding: 8px;
                            `;
                            
                            div.innerHTML = `
                                <img src="${{e.target.result}}" style="
                                    width: 100%;
                                    height: 80px;
                                    object-fit: cover;
                                    border-radius: 6px;
                                    margin-bottom: 6px;
                                ">
                                <p style="color: #2c3e50; font-size: 0.7rem; margin: 0; text-align: center; word-break: break-all;">
                                    ${{file.name}}
                                </p>
                                <p style="color: rgba(44, 62, 80, 0.7); font-size: 0.6rem; margin: 2px 0 0 0; text-align: center;">
                                    ${{(file.size / 1024 / 1024).toFixed(2)}} MB
                                </p>
                            `;
                            
                            preview.appendChild(div);
                        }};
                        reader.readAsDataURL(file);
                    }});
                }}
                
                function uploadFactibilidadFotosAFiles(userId, filaIdx) {{
                    console.log('üöÄ Iniciando procesamiento de Factibilidad Fotos A...');
                    
                    // Deshabilitar bot√≥n y mostrar loading
                    const uploadBtn = document.getElementById('uploadFactibilidadABtn');
                    const originalContent = uploadBtn.innerHTML;
                    uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
                    uploadBtn.style.pointerEvents = 'none';
                    
                    // Crear FormData
                    const formData = new FormData();
                    formData.append('user_id', userId);
                    formData.append('fila_idx', filaIdx);
                    
                    // Agregar las im√°genes (pueden ser 0 a 19)
                    const images = window.selectedFactibilidadAImages || [];
                    images.forEach((file, index) => {{
                        formData.append('imagenes_factibilidad_a', file);
                    }});
                    
                    // Enviar al servidor
                    fetch('/subir_factibilidad_fotos_a', {{
                        method: 'POST',
                        body: formData
                    }})
                    .then(response => response.json())
                    .then(data => {{
                        console.log('üì§ Respuesta del servidor:', data);
                        
                        if (data.success) {{
                            // Mostrar notificaci√≥n de √©xito
                            mostrarNotificacionExito(
                                'üéâ ¬°Factibilidad Fotos A Procesadas!',
                                `Se procesaron ${{data.imagenes_subidas}} im√°genes y ${{data.celdas_na}} celdas marcadas como N/A en la hoja "9. Factibilidad Reporte Fotos A"\\n\\n` +
                                `‚úÖ Archivos guardados permanentemente`
                            );
                            
                            // Cerrar modal despu√©s de un momento
                            setTimeout(() => {{
                                closeFactibilidadFotosAModal();
                            }}, 2000);
                        }} else {{
                            alert(`‚ùå Error procesando Factibilidad Fotos A: ${{data.error || 'Error desconocido'}}`);
                            uploadBtn.innerHTML = originalContent;
                            uploadBtn.style.pointerEvents = 'auto';
                        }}
                    }})
                    .catch(error => {{
                        console.error('‚ùå Error de conexi√≥n:', error);
                        alert('‚ùå Error de conexi√≥n al procesar Factibilidad Fotos A');
                        uploadBtn.innerHTML = originalContent;
                        uploadBtn.style.pointerEvents = 'auto';
                    }});
                }}
                
                function closeFactibilidadFotosAModal() {{
                    if (window.currentFactibilidadFotosAModal) {{
                        document.body.removeChild(window.currentFactibilidadFotosAModal);
                        window.currentFactibilidadFotosAModal = null;
                        window.selectedFactibilidadAImages = null;
                        console.log('‚úÖ Modal de Factibilidad Fotos A cerrado');
                    }}
                }}
                
                function subirReporteFotosB(userId, filaIdx) {{
                    console.log('üì∑ Iniciando subida de Reporte Fotos B para:', userId);
                    
                    // Crear modal para selecci√≥n de hasta 19 im√°genes con previsualizaci√≥n
                    const modal = document.createElement('div');
                    modal.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.9);
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        z-index: 10008;
                        overflow-y: auto;
                        padding: 20px;
                    `;
                    
                    modal.innerHTML = `
                        <div style="
                            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
                            border-radius: 20px;
                            padding: 30px;
                            max-width: 900px;
                            width: 100%;
                            max-height: 90vh;
                            overflow-y: auto;
                            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
                            border: 2px solid #ffecd2;
                        ">
                            <div style="text-align: center; margin-bottom: 25px;">
                                <h2 style="color: #2c3e50; margin: 0; font-size: 1.8rem; font-weight: 700;">
                                    <i class="fas fa-camera"></i> Reporte Fotos B
                                </h2>
                                <p style="color: rgba(44, 62, 80, 0.8); margin: 10px 0 0 0; font-size: 1rem;">
                                    Sube hasta 19 im√°genes para la hoja "10. Reporte Fotos B"
                                </p>
                                <p style="color: rgba(44, 62, 80, 0.7); margin: 5px 0 0 0; font-size: 0.9rem;">
                                    ‚ö†Ô∏è Las im√°genes que no subas se marcar√°n como "N/A"
                                </p>
                            </div>
                            
                            <!-- Secci√≥n de Im√°genes -->
                            <div style="margin-bottom: 25px;">
                                <h3 style="color: #2c3e50; margin-bottom: 15px; font-size: 1.2rem;">
                                    <i class="fas fa-images"></i> Im√°genes (hasta 19 archivos)
                                </h3>
                                <div style="
                                    border: 3px dashed rgba(44, 62, 80, 0.3);
                                    border-radius: 15px;
                                    padding: 20px;
                                    text-align: center;
                                    background: rgba(44, 62, 80, 0.05);
                                    cursor: pointer;
                                    transition: all 0.3s ease;
                                " onclick="document.getElementById('imagenesReporteBInput').click()" 
                                   onmouseover="this.style.borderColor='rgba(44, 62, 80, 0.6)'; this.style.background='rgba(44, 62, 80, 0.1)'"
                                   onmouseout="this.style.borderColor='rgba(44, 62, 80, 0.3)'; this.style.background='rgba(44, 62, 80, 0.05)'">
                                    <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: rgba(44, 62, 80, 0.6); margin-bottom: 15px;"></i>
                                    <p style="color: #2c3e50; font-size: 1.1rem; margin: 0;">Haz clic para seleccionar im√°genes (m√°ximo 19)</p>
                                    <p style="color: rgba(44, 62, 80, 0.7); font-size: 0.9rem; margin: 5px 0 0 0;">
                                        Formatos: JPG, PNG, GIF | M√°ximo 10MB cada una
                                    </p>
                                </div>
                                <input type="file" id="imagenesReporteBInput" accept="image/*" multiple style="display: none;">
                                <div id="imagenesReporteBPreview" style="margin-top: 15px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; max-height: 300px; overflow-y: auto;"></div>
                            </div>
                            
                            <!-- Botones de acci√≥n -->
                            <div style="display: flex; gap: 15px; justify-content: center; margin-top: 30px;">
                                <button onclick="closeReporteFotosBModal()" style="
                                    background: rgba(44, 62, 80, 0.1);
                                    color: #2c3e50;
                                    border: 2px solid rgba(44, 62, 80, 0.3);
                                    padding: 12px 25px;
                                    border-radius: 10px;
                                    cursor: pointer;
                                    font-size: 1rem;
                                    font-weight: 600;
                                    transition: all 0.3s ease;
                                " onmouseover="this.style.background='rgba(44, 62, 80, 0.2)'"
                                   onmouseout="this.style.background='rgba(44, 62, 80, 0.1)'">
                                    <i class="fas fa-times"></i> Cancelar
                                </button>
                                <button id="uploadReporteBBtn" onclick="uploadReporteFotosBFiles('{user_id}', '{fila_idx}')" style="
                                    background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
                                    color: #192133;
                                    border: none;
                                    padding: 12px 25px;
                                    border-radius: 10px;
                                    cursor: pointer;
                                    font-size: 1rem;
                                    font-weight: 600;
                                    transition: all 0.3s ease;
                                    box-shadow: 0 4px 15px rgba(0, 255, 136, 0.4);
                                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0, 255, 136, 0.6)'"
                                   onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(0, 255, 136, 0.4)'">
                                    <i class="fas fa-upload"></i> Procesar Im√°genes
                                </button>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                    window.currentReporteFotosBModal = modal;
                    
                    // Configurar evento para selecci√≥n de im√°genes
                    const imagenesInput = document.getElementById('imagenesReporteBInput');
                    imagenesInput.addEventListener('change', function(e) {{
                        const files = Array.from(e.target.files);
                        if (files.length > 19) {{
                            alert('‚ùå Solo puedes seleccionar m√°ximo 19 im√°genes');
                            e.target.value = '';
                            return;
                        }}
                        
                        window.selectedReporteBImages = files;
                        displayImagenesReporteBPreview(files);
                    }});
                }}
                
                function displayImagenesReporteBPreview(files) {{
                    const preview = document.getElementById('imagenesReporteBPreview');
                    preview.innerHTML = '';
                    
                    files.forEach((file, index) => {{
                        const reader = new FileReader();
                        reader.onload = function(e) {{
                            const div = document.createElement('div');
                            div.style.cssText = `
                                position: relative;
                                border-radius: 10px;
                                overflow: hidden;
                                background: rgba(44, 62, 80, 0.1);
                                padding: 8px;
                            `;
                            
                            div.innerHTML = `
                                <img src="${{e.target.result}}" style="
                                    width: 100%;
                                    height: 80px;
                                    object-fit: cover;
                                    border-radius: 6px;
                                    margin-bottom: 6px;
                                ">
                                <p style="color: #2c3e50; font-size: 0.7rem; margin: 0; text-align: center; word-break: break-all;">
                                    ${{file.name}}
                                </p>
                                <p style="color: rgba(44, 62, 80, 0.7); font-size: 0.6rem; margin: 2px 0 0 0; text-align: center;">
                                    ${{(file.size / 1024 / 1024).toFixed(2)}} MB
                                </p>
                            `;
                            
                            preview.appendChild(div);
                        }};
                        reader.readAsDataURL(file);
                    }});
                }}
                
                function uploadReporteFotosBFiles(userId, filaIdx) {{
                    console.log('üöÄ Iniciando procesamiento de Reporte Fotos B...');
                    
                    // Deshabilitar bot√≥n y mostrar loading
                    const uploadBtn = document.getElementById('uploadReporteBBtn');
                    const originalContent = uploadBtn.innerHTML;
                    uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
                    uploadBtn.style.pointerEvents = 'none';
                    
                    // Crear FormData
                    const formData = new FormData();
                    formData.append('user_id', userId);
                    formData.append('fila_idx', filaIdx);
                    
                    // Agregar las im√°genes (pueden ser 0 a 19)
                    const images = window.selectedReporteBImages || [];
                    images.forEach((file, index) => {{
                        formData.append('imagenes_reporte_b', file);
                    }});
                    
                    // Enviar al servidor
                    fetch('/subir_reporte_fotos_b', {{
                        method: 'POST',
                        body: formData
                    }})
                    .then(response => response.json())
                    .then(data => {{
                        console.log('üì§ Respuesta del servidor:', data);
                        
                        if (data.success) {{
                            // Mostrar notificaci√≥n de √©xito
                            mostrarNotificacionExito(
                                'üéâ ¬°Reporte Fotos B Procesadas!',
                                `Se procesaron ${{data.imagenes_subidas}} im√°genes y ${{data.celdas_na}} celdas marcadas como N/A en la hoja "10. Reporte Fotos B"\\n\\n` +
                                `‚úÖ Archivos guardados permanentemente`
                            );
                            
                            // Cerrar modal despu√©s de un momento
                            setTimeout(() => {{
                                closeReporteFotosBModal();
                            }}, 2000);
                        }} else {{
                            alert(`‚ùå Error procesando Reporte Fotos B: ${{data.error || 'Error desconocido'}}`);
                            uploadBtn.innerHTML = originalContent;
                            uploadBtn.style.pointerEvents = 'auto';
                        }}
                    }})
                    .catch(error => {{
                        console.error('‚ùå Error de conexi√≥n:', error);
                        alert('‚ùå Error de conexi√≥n al procesar Reporte Fotos B');
                        uploadBtn.innerHTML = originalContent;
                        uploadBtn.style.pointerEvents = 'auto';
                    }});
                }}
                
                function closeReporteFotosBModal() {{
                    if (window.currentReporteFotosBModal) {{
                        document.body.removeChild(window.currentReporteFotosBModal);
                        window.currentReporteFotosBModal = null;
                        window.selectedReporteBImages = null;
                        console.log('‚úÖ Modal de Reporte Fotos B cerrado');
                    }}
                }}
                
                // Iniciar actualizaciones autom√°ticas cuando se carga la p√°gina
                document.addEventListener('DOMContentLoaded', function() {{
                    const userId = '{user_id}';
                    const filaIdx = '{fila_idx}';
                    
                    if (userId && userId !== 'None') {{
                        // Actualizar informaci√≥n del ID
                        actualizarInformacionID(userId, filaIdx);
                    }}
                }});
                
            </script>
        </body>
        </html>
        """
        
        return html_modal


@app.route('/site_survey', methods=['GET'])
def site_survey():
    user_id = request.args.get('user_id')
    fila_idx = request.args.get('fila_idx')
    tipo_documento = request.args.get('tipo', 'ptp')  # Por defecto PtP
    llenado_automatico = request.args.get('llenado_automatico', 'false') == 'true'

    # Recupera los datos de la fila para mostrar los nombres (OPTIMIZADO CON CACHE)
    df_db = get_cached_dataframe()
    
    # Buscar la fila correcta bas√°ndose en el user_id
    try:
        # Buscar la fila que contenga el user_id
        user_id_mask = df_db['ID'] == user_id
        if user_id_mask.any():
            row = df_db[user_id_mask].iloc[0]
            nombre_a = row.get('Nombre del sitio A', 'Sitio no encontrado')
            nombre_b = row.get('Nombre del sitio B', 'Sitio no encontrado')
        elif fila_idx and fila_idx.isdigit():
            # Si no se encuentra por ID, usar la fila especificada si es v√°lida
            fila_idx_int = int(fila_idx)
            if fila_idx_int < len(df_db):
                row = df_db.iloc[fila_idx_int]
                nombre_a = row.get('Nombre del sitio A', 'Sitio no encontrado')
                nombre_b = row.get('Nombre del sitio B', 'Sitio no encontrado')
            else:
                nombre_a = '√çndice de fila fuera de rango'
                nombre_b = '√çndice de fila fuera de rango'
        else:
            nombre_a = 'ID no encontrado'
            nombre_b = 'ID no encontrado'
    except Exception as e:
        print(f"Error al buscar datos: {e}")
        nombre_a = 'Error al cargar'
        nombre_b = 'Error al cargar'

    html = f"""
    <!DOCTYPE html>
    <html lang="es">
    <head>
        <meta charset="UTF-8">
        <title>FANGIO TELECOM | Documento Generado</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
        <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
        <style>
            * {{
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }}

            body {{
                font-family: 'Montserrat', Arial, sans-serif;
                min-height: 100vh;
                background-color: #0a192f;
                background-size: cover;
                background-position: center;
                background-attachment: fixed;
                background-repeat: no-repeat;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                position: relative;
                overflow-x: hidden;
                color: #e0e7ef;
            }}

            /* Overlay para mejorar la legibilidad */
            body::before {{
                content: '';
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: 
                    radial-gradient(ellipse at top, rgba(0, 0, 0, 0.2) 0%, transparent 50%),
                    radial-gradient(ellipse at bottom, rgba(0, 0, 0, 0.4) 0%, transparent 50%);
                z-index: 1;
                pointer-events: none;
            }}

            /* Efecto de estrellas sutiles */
            body::after {{
                content: '';
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-image: 
                    radial-gradient(1px 1px at 10% 20%, rgba(255, 255, 255, 0.8), transparent),
                    radial-gradient(1px 1px at 20% 80%, rgba(255, 255, 255, 0.6), transparent),
                    radial-gradient(1px 1px at 80% 30%, rgba(255, 255, 255, 0.9), transparent),
                    radial-gradient(1px 1px at 90% 70%, rgba(255, 255, 255, 0.7), transparent);
                background-size: 400px 400px, 300px 300px, 500px 500px, 350px 350px;
                animation: twinkle 8s ease-in-out infinite;
                z-index: 2;
                pointer-events: none;
            }}

            @keyframes twinkle {{
                0%, 100% {{ opacity: 0.3; }}
                50% {{ opacity: 1; }}
            }}

            .header {{
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                background: linear-gradient(135deg, 
                    rgba(10, 15, 30, 0.98) 0%, 
                    rgba(22, 33, 62, 0.95) 50%, 
                    rgba(15, 52, 96, 0.92) 100%);
                backdrop-filter: blur(20px);
                border-bottom: 3px solid rgba(0, 195, 255, 0.5);
                box-shadow: 
                    0 8px 32px rgba(0, 0, 0, 0.4),
                    0 0 0 1px rgba(0, 195, 255, 0.1) inset;
                padding: 0;
                z-index: 100;
                position: relative;
                overflow: hidden;
            }}

            .header::before {{
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 1px;
                background: linear-gradient(90deg, 
                    transparent, 
                    rgba(0, 195, 255, 0.8), 
                    transparent);
                animation: headerScan 3s ease-in-out infinite;
            }}

            @keyframes headerScan {{
                0%, 100% {{ transform: translateX(-100%); opacity: 0.5; }}
                50% {{ transform: translateX(100%); opacity: 1; }}
            }}

            .header-content {{
                max-width: 1400px;
                margin: 0 auto;
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 15px 30px;
                position: relative;
                z-index: 10;
            }}

            .logo-container {{
                display: flex;
                align-items: center;
                gap: 15px;
            }}

            .logo {{
                transition: all 0.3s ease;
            }}

            .logo img {{
                height: 40px;
                width: auto;
                filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
            }}

            .logo-text {{
                color: #e0e7ef;
                font-size: 0.9rem;
                font-weight: 500;
                opacity: 0.9;
                text-shadow: 0 0 10px rgba(0, 195, 255, 0.3);
            }}

            .main-container {{
                flex: 1;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
                position: relative;
                z-index: 10;
                width: 100%;
                min-height: 100vh;
            }}

                            .success-card {{
                    background: linear-gradient(135deg, rgba(30, 41, 59, 0.95) 0%, rgba(51, 65, 85, 0.9) 100%);
                    backdrop-filter: blur(20px);
                    border: 2px solid rgba(148, 163, 184, 0.3);
                    box-shadow: 
                        0 20px 60px rgba(0, 0, 0, 0.3),
                        0 8px 32px rgba(148, 163, 184, 0.2),
                        0 0 0 1px rgba(148, 163, 184, 0.1) inset;
                    border-radius: 28px;
                    padding: 60px 50px;
                    min-width: 500px;
                    max-width: 600px;
                    width: 100%;
                    text-align: center;
                    position: relative;
                    overflow: hidden;
                    z-index: 10;
                    animation: cardFloat 6s ease-in-out infinite;
                }}

            @keyframes cardFloat {{
                0%, 100% {{ transform: translateY(0px); }}
                50% {{ transform: translateY(-10px); }}
            }}

            .success-card::before {{
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 3px;
                background: linear-gradient(90deg, transparent, #00c3ff, #00e0ff, #00c3ff, transparent);
                animation: scan 4s ease-in-out infinite;
                box-shadow: 0 0 10px rgba(0, 195, 255, 0.8);
            }}

            .success-card::after {{
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: radial-gradient(circle at 30% 20%, rgba(0, 195, 255, 0.1) 0%, transparent 50%),
                            radial-gradient(circle at 70% 80%, rgba(0, 195, 255, 0.05) 0%, transparent 50%);
                pointer-events: none;
                z-index: -1;
            }}

            @keyframes scan {{
                0%, 100% {{ transform: translateX(-100%); opacity: 0.5; }}
                50% {{ transform: translateX(100%); opacity: 1; }}
            }}

            .success-icon {{
                width: 100px;
                height: 100px;
                border-radius: 50%;
                background: linear-gradient(135deg, #10b981 0%, #059669 50%, #10b981 100%);
                border: 4px solid #6b7280;
                box-shadow: 
                    0 0 30px rgba(16, 185, 129, 0.4),
                    0 0 0 1px rgba(255, 255, 255, 0.1) inset,
                    0 8px 25px rgba(0, 0, 0, 0.2);
                margin: 0 auto 30px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 3rem;
                color: #fff;
                font-weight: bold;
                position: relative;
                animation: successPulse 2s ease-in-out infinite;
            }}

            @keyframes successPulse {{
                0%, 100% {{ transform: scale(1); box-shadow: 0 0 40px rgba(0, 255, 136, 0.6); }}
                50% {{ transform: scale(1.05); box-shadow: 0 0 50px rgba(0, 255, 136, 0.8); }}
            }}

            .success-title {{
                color: #10b981;
                font-size: 2.5rem;
                font-weight: 800;
                margin: 0 0 20px 0;
                letter-spacing: 2px;
                text-shadow: 0 0 15px rgba(16, 185, 129, 0.3);
            }}

            .info-container {{
                background: linear-gradient(135deg, rgba(30, 41, 59, 0.8) 0%, rgba(51, 65, 85, 0.8) 100%);
                border: 2px solid rgba(148, 163, 184, 0.4);
                border-radius: 16px;
                padding: 25px;
                margin: 30px 0;
                text-align: left;
                backdrop-filter: blur(10px);
            }}

            .info-item {{
                display: flex;
                align-items: center;
                gap: 10px;
                margin-bottom: 15px;
                color: #e0e7ef;
                font-size: 1.1rem;
            }}

            .info-item:last-child {{
                margin-bottom: 0;
            }}

            .info-label {{
                color: #00c3ff;
                font-weight: 600;
                min-width: 120px;
                display: flex;
                align-items: center;
                gap: 8px;
            }}

            .info-value {{
                color: #e0e7ef;
                font-weight: 500;
            }}

            .buttons-container {{
                display: flex;
                flex-direction: column;
                gap: 15px;
                margin-top: 30px;
            }}

            .download-button, .upload-images-button, .new-document-button, .back-button, .other-button {{
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 10px;
                padding: 18px 30px;
                border-radius: 12px;
                text-decoration: none;
                font-weight: 600;
                font-size: 1.1rem;
                transition: all 0.3s ease;
                border: none;
                cursor: pointer;
                position: relative;
                overflow: hidden;
            }}

            .save-button {{
                background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
                color: #192133;
                box-shadow: 0 8px 25px rgba(0, 255, 136, 0.4);
                font-weight: 600;
                font-size: 1.1rem;
                transition: all 0.3s ease;
                border: none;
                cursor: pointer;
                padding: 18px 30px;
                border-radius: 12px;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 10px;
                position: relative;
                overflow: hidden;
            }}

            .save-button:hover {{
                background: linear-gradient(135deg, #00cc6a 0%, #00ff88 100%);
                transform: translateY(-2px);
                box-shadow: 0 12px 35px rgba(0, 255, 136, 0.6);
            }}

            .save-button:disabled {{
                opacity: 0.6;
                cursor: not-allowed;
                transform: none;
            }}

            .download-button {{
                background: linear-gradient(135deg, #00c3ff 0%, #00e0ff 100%);
                color: #192133;
                box-shadow: 0 8px 25px rgba(0, 195, 255, 0.4);
            }}

            .download-button:hover {{
                background: linear-gradient(135deg, #00e0ff 0%, #00c3ff 100%);
                transform: translateY(-2px);
                box-shadow: 0 12px 35px rgba(0, 195, 255, 0.6);
            }}

            .back-button {{
                background: rgba(0, 195, 255, 0.1);
                color: #00c3ff;
                border: 2px solid rgba(0, 195, 255, 0.3);
            }}

            .back-button:hover {{
                background: rgba(0, 195, 255, 0.2);
                border-color: rgba(0, 195, 255, 0.5);
                transform: translateY(-2px);
            }}

            .other-button {{
                background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
                color: #ffffff;
                box-shadow: 0 8px 25px rgba(74, 144, 226, 0.4);
            }}

            .file-manager-button {{
                background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
                color: #ffffff;
                box-shadow: 0 8px 25px rgba(155, 89, 182, 0.4);
            }}

            .file-manager-button:hover {{
                background: linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%);
                transform: translateY(-2px);
                box-shadow: 0 12px 35px rgba(155, 89, 182, 0.6);
            }}

            /* ESTILOS PARA EL MODAL DE NUEVO LLENADO */
            .modal-overlay {{
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                backdrop-filter: blur(10px);
                display: none;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                padding: 20px;
            }}

            .modal-content {{
                background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
                border-radius: 20px;
                padding: 0;
                max-width: 500px;
                width: 100%;
                box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
                border: 2px solid rgba(0, 195, 255, 0.3);
                overflow: hidden;
                animation: modalSlideIn 0.3s ease-out;
            }}

            @keyframes modalSlideIn {{
                from {{
                    opacity: 0;
                    transform: translateY(-50px) scale(0.9);
                }}
                to {{
                    opacity: 1;
                    transform: translateY(0) scale(1);
                }}
            }}

            .modal-header {{
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 25px 30px;
                display: flex;
                align-items: center;
                justify-content: space-between;
                border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            }}

            .modal-header h2 {{
                margin: 0;
                font-size: 1.5rem;
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 10px;
            }}

            .modal-close {{
                background: none;
                border: none;
                color: white;
                font-size: 1.5rem;
                cursor: pointer;
                padding: 5px;
                border-radius: 50%;
                transition: all 0.3s ease;
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
            }}

            .modal-close:hover {{
                background: rgba(255, 255, 255, 0.2);
                transform: scale(1.1);
            }}

            .modal-body {{
                padding: 30px;
                text-align: center;
            }}

            .modal-body p {{
                margin: 0 0 20px 0;
                color: #2c3e50;
                font-size: 1.1rem;
                line-height: 1.5;
            }}

            .input-group {{
                position: relative;
                margin: 25px 0;
                display: flex;
                align-items: center;
                background: #f8f9fa;
                border: 2px solid #e9ecef;
                border-radius: 15px;
                padding: 5px;
                transition: all 0.3s ease;
            }}

            .input-group:focus-within {{
                border-color: #667eea;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            }}

            .input-group i {{
                color: #667eea;
                font-size: 1.2rem;
                margin: 0 15px;
            }}

            .nuevo-id-input {{
                flex: 1;
                border: none;
                background: none;
                padding: 15px 0;
                font-size: 1.1rem;
                color: #2c3e50;
                outline: none;
            }}

            .nuevo-id-input::placeholder {{
                color: #adb5bd;
            }}

            .modal-actions {{
                display: flex;
                gap: 15px;
                justify-content: center;
                margin-top: 30px;
            }}

            .btn-generar, .btn-cancelar {{
                padding: 15px 30px;
                border: none;
                border-radius: 12px;
                font-size: 1rem;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                gap: 10px;
                min-width: 160px;
                justify-content: center;
            }}

            .btn-generar {{
                background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
                color: #192133;
                box-shadow: 0 8px 25px rgba(0, 255, 136, 0.4);
            }}

            .btn-generar:hover {{
                background: linear-gradient(135deg, #00cc6a 0%, #00ff88 100%);
                transform: translateY(-2px);
                box-shadow: 0 12px 35px rgba(0, 255, 136, 0.6);
            }}

            .btn-cancelar {{
                background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
                color: white;
                box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
            }}

                            .btn-cancelar:hover {{
                    background: linear-gradient(135deg, #ee5a24 0%, #ff6b6b 100%);
                    transform: translateY(-2px);
                    box-shadow: 0 12px 35px rgba(255, 107, 107, 0.6);
                }}

            /* ESTILOS PARA EL INDICADOR DE CARGA */
            .overlay-carga {{
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.9);
                backdrop-filter: blur(15px);
                display: none;
                align-items: center;
                justify-content: center;
                z-index: 10001;
            }}

            .carga-content {{
                background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
                border-radius: 20px;
                padding: 40px;
                text-align: center;
                box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
                border: 2px solid rgba(0, 195, 255, 0.3);
                max-width: 400px;
                width: 90%;
            }}

            .spinner {{
                width: 60px;
                height: 60px;
                border: 4px solid #e9ecef;
                border-top: 4px solid #00c3ff;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin: 0 auto 20px;
            }}

            @keyframes spin {{
                0% {{ transform: rotate(0deg); }}
                100% {{ transform: rotate(360deg); }}
            }}

            .carga-content h3 {{
                color: #2c3e50;
                margin-bottom: 15px;
                font-size: 1.3rem;
            }}

            .carga-content p {{
                color: #7f8c8d;
                font-size: 1rem;
                margin: 0;
            }}

            @media (max-width: 768px) {{
                .modal-content {{
                    margin: 20px;
                    max-width: none;
                }}
                
                .modal-actions {{
                    flex-direction: column;
                    align-items: center;
                }}
                
                .btn-generar, .btn-cancelar {{
                    width: 100%;
                    max-width: 300px;
                }}
            }}

            .other-button:hover {{
                background: linear-gradient(135deg, #357abd 0%, #4a90e2 100%);
                transform: translateY(-2px);
                box-shadow: 0 12px 35px rgba(74, 144, 226, 0.6);
            }}

            .upload-images-button {{
                background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
                color: #ffffff;
                box-shadow: 0 8px 25px rgba(155, 89, 182, 0.4);
            }}

            .upload-images-button:hover {{
                background: linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%);
                transform: translateY(-2px);
                box-shadow: 0 12px 35px rgba(155, 89, 182, 0.6);
            }}

            .footer {{
                background: linear-gradient(135deg, 
                    rgba(10, 15, 30, 0.98) 0%, 
                    rgba(22, 33, 62, 0.95) 100%);
                backdrop-filter: blur(20px);
                border-top: 2px solid rgba(0, 195, 255, 0.3);
                padding: 20px 0;
                position: relative;
                z-index: 10;
            }}

            .footer-content {{
                max-width: 1400px;
                margin: 0 auto;
                text-align: center;
                color: #e0e7ef;
                font-size: 0.9rem;
                opacity: 0.8;
            }}

            .separator {{
                margin: 0 10px;
                color: #00c3ff;
            }}

            .company-name {{
                color: #00c3ff;
                font-weight: 600;
            }}

            @media (max-width: 768px) {{
                .success-card {{
                    min-width: auto;
                    max-width: 90%;
                    padding: 40px 30px;
                }}

                .success-title {{
                    font-size: 2rem;
                }}

                .info-item {{
                    flex-direction: column;
                    align-items: flex-start;
                    gap: 5px;
                }}

                .info-label {{
                    min-width: auto;
                }}
            }}
        </style>
    </head>
    <body>
        <header class="header">
            <div class="header-content">
                <div class="logo-container">
                    <div class="logo">
                        <img src="{{ url_for('static', filename='images/fangio-logo.svg') }}?v={{ range(1, 1000) | random }}" alt="FANGIO TELECOM">
                    </div>
                    <div class="logo-text">
                        <p>Redes Seguras Soluciones Estrat√©gicas</p>
                    </div>
                </div>
            </div>
        </header>

        <div class="main-container">
            <div class="success-card">
                <div class="success-icon">
                    <i class="fas fa-check"></i>
                </div>
                <h1 class="success-title">¬°Documento Generado!</h1>
                
                <div class="info-container">
                    <div class="info-item">
                        <span class="info-label"><i class="fas fa-id-card"></i> ID:</span>
                        <span class="info-value">{user_id}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label"><i class="fas fa-map-marker-alt"></i> Sitio A:</span>
                        <span class="info-value">{nombre_a}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label"><i class="fas fa-map-marker-alt"></i> Sitio B:</span>
                        <span class="info-value">{nombre_b}</span>
                    </div>
                </div>
                
                <div class="buttons-container">
                    <!-- BOT√ìN: GUARDAR ARCHIVO -->
                    <button onclick="guardarArchivo('{user_id}', '{tipo_documento}', '{fila_idx}')" class="save-button">
                        <i class="fas fa-save"></i>
                        Guardar Archivo
                    </button>
                    
                    <a href="{url_for('descargar_site_survey_ptmp' if tipo_documento == 'ptmp' else 'descargar_site_survey', user_id=user_id)}" class="download-button">
                        <i class="fas fa-download"></i>
                        Descargar Archivo Generado {'(PtMP)' if tipo_documento == 'ptmp' else '(PtP)'}
                    </a>
                    
                    {'<a href="' + url_for('subir_imagenes_ptp', user_id=user_id, fila_idx=fila_idx) + '" class="upload-images-button">' if tipo_documento == 'ptp' else ''}
                    {'<i class="fas fa-images"></i>' if tipo_documento == 'ptp' else ''}
                    {'Subir Im√°genes - Planos A' if tipo_documento == 'ptp' else ''}
                    {'</a>' if tipo_documento == 'ptp' else ''}
                    
                    {'<a href="' + url_for('subir_imagenes_ptp_planos_b', user_id=user_id, fila_idx=fila_idx) + '" class="upload-images-button">' if tipo_documento == 'ptp' else ''}
                    {'<i class="fas fa-images"></i>' if tipo_documento == 'ptp' else ''}
                    {'Subir Im√°genes - Planos B' if tipo_documento == 'ptp' else ''}
                    {'</a>' if tipo_documento == 'ptp' else ''}
                    
                    {'<a href="' + url_for('subir_imagenes_ptp_fotos_a', user_id=user_id, fila_idx=fila_idx) + '" class="upload-images-button">' if tipo_documento == 'ptp' else ''}
                    {'<i class="fas fa-images"></i>' if tipo_documento == 'ptp' else ''}
                    {'Subir Im√°genes - Reporte Fotos A' if tipo_documento == 'ptp' else ''}
                    {'</a>' if tipo_documento == 'ptp' else ''}
                    
                    {'<a href="' + url_for('subir_imagenes_ptp_fotos_b', user_id=user_id, fila_idx=fila_idx) + '" class="upload-images-button">' if tipo_documento == 'ptp' else ''}
                    {'<i class="fas fa-images"></i>' if tipo_documento == 'ptp' else ''}
                    {'Subir Im√°genes - Reporte Fotos B' if tipo_documento == 'ptp' else ''}
                    {'</a>' if tipo_documento == 'ptp' else ''}
                    
                    <a href="{url_for('reporte_planeacion', user_id=user_id, fila_idx=fila_idx)}" class="other-button">
                        <i class="fas fa-chart-line"></i>
                        Ir a Reporte de Planeaci√≥n
                    </a>
                    
                    <button onclick="mostrarModalElegante()" class="other-button" style="cursor: pointer; border: none; background: none; width: 100%; text-align: left; padding: 15px 20px; color: inherit; font-family: inherit; font-size: inherit;">
                        <i class="fas fa-drafting-compass"></i>
                        Ir a Dise√±o de Soluci√≥n (DIRECTO)
                    </button>
                    
                    <!-- BOT√ìN DE PRUEBA TEMPORAL -->
                    <button onclick="alert('üéØ JavaScript funcionando correctamente!'); console.log('üéØ Bot√≥n de prueba clickeado');" class="other-button" style="cursor: pointer; border: none; background: none; width: 100%; text-align: left; padding: 15px 20px; color: #ff6b6b; font-family: inherit; font-size: inherit; margin-top: 10px;">
                        <i class="fas fa-bug"></i>
                        üß™ PRUEBA JAVASCRIPT
                    </button>
                    
                    <!-- BOT√ìN: GESTI√ìN DE ARCHIVOS -->
                    <a href="/file_manager" class="file-manager-button">
                        <i class="fas fa-folder-open"></i>
                        Gestionar Archivos Generados
                    </a>
                    
                    <a href="/" class="back-button">
                        <i class="fas fa-home"></i>
                        Volver al Inicio
                    </a>
                </div>
            </div>
        </div>

        <footer class="footer">
            <div class="footer-content">
                <span>&copy; 2025 Realizado por Efren Alexis Hernandez Mendez</span>
                <span class="separator">|</span>
                <span class="company-name">FANGIO TELECOM</span>
            </div>
        </footer>

        <script>
            // Verificar carga de im√°genes
            document.addEventListener('DOMContentLoaded', function() {{
                // Verificar imagen de fondo
                const bgImg = new Image();
                bgImg.onload = function() {{
                    console.log('Imagen de fondo cargada correctamente');
                    document.body.style.backgroundImage = 'linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.6)), url("{{ url_for("static", filename="images/earth-background.jpg") }}?v={{ range(1, 1000) | random }}")';
                    document.body.style.backgroundSize = 'cover';
                    document.body.style.backgroundPosition = 'center';
                    document.body.style.backgroundAttachment = 'fixed';
                    document.body.style.backgroundRepeat = 'no-repeat';
                }};
                bgImg.onerror = function() {{
                    console.log('Error al cargar imagen de fondo - usando color de respaldo');
                    document.body.style.backgroundColor = '#0a192f';
                    // Intentar con ruta alternativa
                    const altBgImg = new Image();
                    altBgImg.onload = function() {{
                        console.log('Imagen de fondo cargada con ruta alternativa');
                        document.body.style.backgroundImage = 'linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.6)), url("/static/images/earth-background.jpg")';
                        document.body.style.backgroundSize = 'cover';
                        document.body.style.backgroundPosition = 'center';
                        document.body.style.backgroundAttachment = 'fixed';
                        document.body.style.backgroundRepeat = 'no-repeat';
                    }};
                    altBgImg.onerror = function() {{
                        console.log('Todas las rutas de imagen fallaron');
                    }};
                    altBgImg.src = '/static/images/earth-background.jpg';
                }};
                bgImg.src = '{{ url_for("static", filename="images/earth-background.jpg") }}?v={{ range(1, 1000) | random }}';

                // Verificar logo
                const logoImg = document.querySelector('.logo img');
                if (logoImg) {{
                    logoImg.onerror = function() {{
                        console.log('Error al cargar logo');
                        this.style.display = 'none';
                    }};
                    logoImg.onload = function() {{
                        console.log('Logo cargado correctamente');
                    }};
                }}

                // Efecto de aparici√≥n para la tarjeta principal
                const successCard = document.querySelector('.success-card');
                if (successCard) {{
                    successCard.style.opacity = '0';
                    successCard.style.transform = 'translateY(30px)';
                    
                    setTimeout(() => {{
                        successCard.style.transition = 'all 0.8s ease';
                        successCard.style.opacity = '1';
                        successCard.style.transform = 'translateY(0)';
                    }}, 300);
                }}

                // Efecto de hover para el logo
                const logo = document.querySelector('.logo');
                if (logo) {{
                    logo.addEventListener('mouseenter', function() {{
                        this.style.transform = 'translateY(-3px) scale(1.02)';
                    }});
                    
                    logo.addEventListener('mouseleave', function() {{
                        this.style.transform = 'translateY(0) scale(1)';
                    }});
                }}
                
                // LLENADO AUTOM√ÅTICO - Si viene del modal de nuevo llenado
                const urlParams = new URLSearchParams(window.location.search);
                const llenadoAutomatico = urlParams.get('llenado_automatico');
                const nuevoUserId = urlParams.get('user_id');
                
                if (llenadoAutomatico === 'true') {{
                    console.log('üîÑ Iniciando llenado autom√°tico...');
                    console.log('üÜî Nuevo ID detectado:', nuevoUserId);
                    console.log('üîç Buscando bot√≥n save-button...');
                    
                    // Funci√≥n para buscar y hacer clic en el bot√≥n
                    function buscarYHacerClic() {{
                        const saveButton = document.querySelector('.save-button');
                        console.log('üîç Bot√≥n encontrado:', saveButton);
                        
                        if (saveButton) {{
                            // HABILITAR el bot√≥n si est√° deshabilitado
                            if (saveButton.disabled) {{
                                console.log('üîì Bot√≥n estaba deshabilitado, habilit√°ndolo...');
                                saveButton.disabled = false;
                            }}
                            
                            console.log('‚úÖ Site Survey generado exitosamente');
                            console.log('‚ÑπÔ∏è El archivo NO se guardar√° autom√°ticamente');
                            console.log('‚ÑπÔ∏è Usa el bot√≥n "Guardar Archivo" para guardarlo manualmente');
                            
                            // NO EJECUTAR GUARDADO AUTOM√ÅTICO
                            // El usuario debe decidir cu√°ndo guardar el archivo
                        }} else {{
                            console.log('‚ùå Bot√≥n guardar no encontrado, reintentando en 1 segundo...');
                            // Reintentar en 1 segundo
                            setTimeout(buscarYHacerClic, 1000);
                        }}
                    }}
                    
                    // Esperar 3 segundos para que la p√°gina se cargue completamente
                    setTimeout(buscarYHacerClic, 3000);
                }}
            }});

            // FUNCI√ìN PARA GUARDAR ARCHIVO
            function guardarArchivo(user_id, tipoDocumento, filaIdx) {{
                console.log('Guardando archivo para:', user_id, tipoDocumento, filaIdx);
                
                // Mostrar indicador de carga
                const saveButton = document.querySelector('.save-button');
                const originalText = saveButton.innerHTML;
                saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
                saveButton.disabled = true;
                
                // Mostrar mensaje informativo
                const infoDiv = document.createElement('div');
                infoDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(135deg, #00b894, #00a085);
                    color: white;
                    padding: 15px 20px;
                    border-radius: 10px;
                    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                    z-index: 10000;
                    font-family: 'Montserrat', sans-serif;
                `;
                infoDiv.innerHTML = `
                    <i class="fas fa-info-circle"></i>
                    <strong>Guardando archivo...</strong><br>
                    <small>El archivo se guardar√° en la carpeta de archivos generados</small>
                `;
                document.body.appendChild(infoDiv);
                
                // Llamar a la API para guardar el archivo
                fetch('/guardar_archivo_generado', {{
                    method: 'POST',
                    headers: {{
                        'Content-Type': 'application/json',
                    }},
                    body: JSON.stringify({{
                        user_id: user_id,
                        tipo_documento: tipoDocumento,
                        fila_idx: filaIdx
                    }})
                }})
                .then(response => response.json())
                .then(data => {{
                    // Remover mensaje informativo
                    if (infoDiv && infoDiv.parentNode) {{
                        infoDiv.parentNode.removeChild(infoDiv);
                    }}
                    
                    if (data.success) {{
                        // √âxito
                        saveButton.innerHTML = '<i class="fas fa-check"></i> ¬°Guardado!';
                        saveButton.style.background = 'linear-gradient(135deg, #00ff88 0%, #00cc6a 100%)';
                        
                        // Mostrar modal para nuevo llenado
                        console.log('üéØ Llamando a mostrarModalNuevoLlenado...');
                        mostrarModalNuevoLlenado();
                        
                        // Restaurar bot√≥n despu√©s de 3 segundos
                        setTimeout(() => {{
                            saveButton.innerHTML = originalText;
                            saveButton.disabled = false;
                            saveButton.style.background = 'linear-gradient(135deg, #00ff88 0%, #00cc6a 100%)';
                        }}, 3000);
                    }} else {{
                        // Error
                        saveButton.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error';
                        saveButton.style.background = 'linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%)';
                        
                        alert('‚ùå Error al guardar: ' + (data.message || 'Error desconocido'));
                        
                        // Restaurar bot√≥n despu√©s de 3 segundos
                        setTimeout(() => {{
                            saveButton.innerHTML = originalText;
                            saveButton.disabled = false;
                            saveButton.style.background = 'linear-gradient(135deg, #00ff88 0%, #00cc6a 100%)';
                        }}, 3000);
                    }}
                }})
                .catch(error => {{
                    console.error('Error:', error);
                    
                    // Remover mensaje informativo
                    if (infoDiv && infoDiv.parentNode) {{
                        infoDiv.parentNode.removeChild(infoDiv);
                    }}
                    
                    // Error de red
                    saveButton.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error de Red';
                    saveButton.style.background = 'linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%)';
                    
                    alert('‚ùå Error de conexi√≥n. Verifica tu internet e intenta de nuevo.');
                    
                    // Restaurar bot√≥n despu√©s de 3 segundos
                    setTimeout(() => {{
                        saveButton.innerHTML = originalText;
                        saveButton.disabled = false;
                        saveButton.style.background = 'linear-gradient(135deg, #00ff88 0%, #00cc6a 100%)';
                    }}, 3000);
                }});
            }}

            <!-- Funci√≥n para mostrar modal de nuevo llenado -->
            function mostrarModalNuevoLlenado() {{
                console.log('üéØ Funci√≥n mostrarModalNuevoLlenado ejecut√°ndose...');
                // Crear modal din√°micamente
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                `;
                
                modal.innerHTML = `
                    <div style="
                        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
                        border-radius: 20px;
                        padding: 40px;
                        text-align: center;
                        max-width: 500px;
                        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                        border: 2px solid #00ff88;
                    ">
                        <div style="
                            width: 80px;
                            height: 80px;
                            background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
                            border-radius: 50%;
                            margin: 0 auto 20px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 40px;
                            color: white;
                        ">
                            ‚úì
                                </div>
                        <h2 style="color: #00ff88; margin-bottom: 20px; font-size: 28px;">
                            ¬°Archivo Guardado Exitosamente!
                        </h2>
                        <p style="color: white; margin-bottom: 20px; font-size: 16px; line-height: 1.6;">
                            El archivo de Site Survey ha sido guardado correctamente.<br>
                            Ingresa el ID para el nuevo llenado:
                        </p>
                        
                        <!-- CAMPO DE ID -->
                        <div style="margin-bottom: 25px;">
                            <input type="text" id="nuevoIdInput" placeholder="Ej: 5140066159E" style="
                                width: 100%;
                                padding: 15px;
                                border: 2px solid #00ff88;
                                border-radius: 10px;
                                background: rgba(255, 255, 255, 0.1);
                                color: white;
                                font-size: 16px;
                                text-align: center;
                                outline: none;
                                transition: all 0.3s ease;
                            " onfocus="this.style.borderColor='#00cc6a'; this.style.background='rgba(255, 255, 255, 0.2)'" onblur="this.style.borderColor='#00ff88'; this.style.background='rgba(255, 255, 255, 0.1)'">
                                    </div>
                                    
                        <div style="display: flex; gap: 15px; justify-content: center;">
                            <button onclick="nuevoLlenadoConId()" style="
                                background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
                                color: white;
                                border: none;
                                padding: 15px 30px;
                                border-radius: 10px;
                                font-size: 16px;
                                font-weight: bold;
                                cursor: pointer;
                                transition: all 0.3s ease;
                            " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                ‚ú® Nuevo Llenado
                                        </button>
                            <button onclick="cerrarModal()" style="
                                background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
                                color: white;
                                border: none;
                                padding: 15px 30px;
                                border-radius: 10px;
                                font-size: 16px;
                                font-weight: bold;
                                cursor: pointer;
                                transition: all 0.3s ease;
                            " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                ‚ùå Cerrar
                                        </button>
                            </div>
                        </div>
                    `;
                
                document.body.appendChild(modal);
                console.log('‚úÖ Modal agregado al DOM correctamente');
                
                // Enfocar el campo de ID autom√°ticamente
                setTimeout(() => {{
                const input = document.getElementById('nuevoIdInput');
                    if (input) {{
                input.focus();
                        input.select();
                    }}
                }}, 100);
            }}
            
            function nuevoLlenadoConId() {{
                // Obtener el ID ingresado
                const idInput = document.getElementById('nuevoIdInput');
                const nuevoId = idInput.value.trim();
                
                if (!nuevoId) {{
                    alert('‚ùå Por favor ingresa un ID v√°lido');
                    idInput.focus();
                    return;
                }}
                
                // Validar formato del ID (debe tener al menos 3 caracteres)
                if (nuevoId.length < 3) {{
                    alert('‚ùå El ID debe tener al menos 3 caracteres');
                    idInput.focus();
                    return;
                }}
                
                // Buscar IDs similares en la base de datos
                buscarIdsSimilares(nuevoId);
            }}
            
            function buscarIdsSimilares(idBusqueda) {{
                console.log('üîç Buscando IDs similares a:', idBusqueda);
                
                // Llamar a la API para buscar IDs similares
                fetch('/buscar_ids_similares', {{
                    method: 'POST',
                    headers: {{
                        'Content-Type': 'application/json',
                    }},
                    body: JSON.stringify({{
                        id_busqueda: idBusqueda
                    }})
                }})
                .then(response => response.json())
                .then(data => {{
                    if (data.success) {{
                        mostrarOpcionesIds(data.ids_encontrados, idBusqueda);
                    }} else {{
                        alert('‚ùå Error al buscar IDs: ' + (data.message || 'Error desconocido'));
                    }}
                }})
                .catch(error => {{
                    console.error('Error:', error);
                    alert('‚ùå Error de conexi√≥n al buscar IDs');
                }});
            }}

            function mostrarOpcionesIds(idsEncontrados, idBusqueda) {{
                // Cerrar el modal actual
                cerrarModal();
                
                // Crear modal de selecci√≥n
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                `;
                
                let opcionesHTML = '';
                if (idsEncontrados.length === 0) {{
                    opcionesHTML = `
                        <div style="text-align: center; color: #ff6b6b; margin-bottom: 20px;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 15px;"></i>
                            <h3>No se encontraron IDs similares a "${{idBusqueda}}"</h3>
                            <p>Intenta con un ID m√°s espec√≠fico o verifica que exista en la base de datos.</p>
                            </div>
                    `;
                }} else {{
                    opcionesHTML = `
                        <div style="text-align: center; margin-bottom: 20px;">
                            <h3 style="color: #00ff88; margin-bottom: 15px;">IDs Encontrados</h3>
                            <p style="color: white;">Se encontraron ${{idsEncontrados.length}} ID(s) similar(es) a "${{idBusqueda}}"</p>
                            <p style="color: #ccc; font-size: 14px;">Selecciona el llenado que quieres hacer:</p>
                        </div>
                        <div style="max-height: 300px; overflow-y: auto; margin-bottom: 20px;">
                    `;
                    
                    idsEncontrados.forEach((idInfo, index) => {{
                        opcionesHTML += `
                            <div style="
                                background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
                                border: 1px solid rgba(0, 255, 136, 0.3);
                                border-radius: 10px;
                                padding: 15px;
                                margin-bottom: 10px;
                                cursor: pointer;
                                transition: all 0.3s ease;
                            " onmouseover="this.style.borderColor='rgba(0, 255, 136, 0.8)'; this.style.background='rgba(255, 255, 255, 0.15)'" onmouseout="this.style.borderColor='rgba(0, 255, 136, 0.3)'; this.style.background='rgba(255, 255, 255, 0.1)'" onclick="seleccionarId('${{idInfo.id}}', '${{idInfo.nombre_a || 'Sin nombre'}}', '${{idInfo.nombre_b || 'Sin nombre'}}')">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong style="color: #00ff88; font-size: 18px;">${{idInfo.id}}</strong>
                                        <div style="color: white; margin-top: 5px;">
                                            <div>üìç Sitio A: ${{idInfo.nombre_a || 'Sin nombre'}}</div>
                                            <div>üìç Sitio B: ${{idInfo.nombre_b || 'Sin nombre'}}</div>
                                        </div>
                                    </div>
                                    <div style="color: #00ff88; font-size: 24px;">
                                        <i class="fas fa-arrow-right"></i>
                                    </div>
                                </div>
                            </div>
                        `;
                    }});
                    
                    opcionesHTML += `</div>`;
                }}
                
                modal.innerHTML = `
                    <div style="
                        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
                        border-radius: 20px;
                        padding: 40px;
                        text-align: center;
                        max-width: 600px;
                        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                        border: 2px solid #00ff88;
                    ">
                        ${{opcionesHTML}}
                        
                        <div style="display: flex; gap: 15px; justify-content: center;">
                            <button onclick="cerrarModal()" style="
                                background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
                                color: white;
                                border: none;
                                padding: 15px 30px;
                                border-radius: 10px;
                                font-size: 16px;
                                font-weight: bold;
                                cursor: pointer;
                                transition: all 0.3s ease;
                            " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                ‚ùå Cerrar
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            }}
            
            function seleccionarId(idSeleccionado, nombreA, nombreB) {{
                console.log('‚úÖ ID seleccionado:', idSeleccionado);
                console.log('üìç Sitio A:', nombreA);
                console.log('üìç Sitio B:', nombreB);
                
                // Cerrar el modal de selecci√≥n
                cerrarModal();
                
                // Mostrar mensaje de generaci√≥n
                mostrarMensajeGeneracion('üöÄ Generando archivo autom√°ticamente...', 'info');
                
                // Generar archivo autom√°ticamente ANTES de redirigir
                generarArchivoAutomatico(idSeleccionado, nombreA, nombreB);
            }}
            
            function generarArchivoAutomatico(userId, nombreA, nombreB) {{
                console.log('üî• Generando archivo autom√°ticamente para:', userId);
                
                // Llamar a la API para generar el archivo
                fetch('/generar_archivo_automatico', {{
                    method: 'POST',
                    headers: {{
                        'Content-Type': 'application/json',
                    }},
                    body: JSON.stringify({{
                        user_id: userId,
                        tipo_documento: 'ptp',
                        fila_idx: '0'
                    }})
                }})
                .then(response => response.json())
                .then(data => {{
                    if (data.success) {{
                        console.log('‚úÖ Archivo generado exitosamente');
                        mostrarMensajeGeneracion('‚úÖ Archivo generado exitosamente', 'success');
                        
                        // Redirigir despu√©s de generar el archivo
                        setTimeout(() => {{
                            window.location.href = `/site_survey?user_id=${{userId}}&fila_idx=0&llenado_automatico=true`;
                        }}, 1500);
                    }} else {{
                        console.error('‚ùå Error generando archivo:', data.message);
                        mostrarMensajeGeneracion('‚ùå Error generando archivo: ' + data.message, 'error');
                    }}
                }})
                .catch(error => {{
                    console.error('Error:', error);
                    mostrarMensajeGeneracion('‚ùå Error de conexi√≥n al generar archivo', 'error');
                }});
            }}
            
            function mostrarMensajeGeneracion(mensaje, tipo) {{
                // Crear mensaje temporal
                const mensajeDiv = document.createElement('div');
                mensajeDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 15px 20px;
                    border-radius: 10px;
                    color: white;
                    font-weight: bold;
                    z-index: 10001;
                    animation: slideIn 0.5s ease;
                `;
                
                // Estilo seg√∫n tipo
                if (tipo === 'success') {{
                    mensajeDiv.style.background = 'linear-gradient(135deg, #00ff88, #00cc6a)';
                }} else if (tipo === 'error') {{
                    mensajeDiv.style.background = 'linear-gradient(135deg, #ff6b6b, #ee5a52)';
                }} else {{
                    mensajeDiv.style.background = 'linear-gradient(135deg, #4ecdc4, #44a08d)';
                }}
                
                mensajeDiv.innerHTML = mensaje;
                document.body.appendChild(mensajeDiv);
                
                // Remover despu√©s de 3 segundos
                setTimeout(() => {{
                    if (mensajeDiv.parentNode) {{
                        mensajeDiv.parentNode.removeChild(mensajeDiv);
                    }}
                }}, 3000);
            }}
            
            function nuevoLlenado() {{
                // Redirigir a la p√°gina de selecci√≥n de ID
                window.location.href = '/seleccion_id';
            }}
            
            function cerrarModal() {{
                // Remover modal
                const modal = document.querySelector('div[style*="position: fixed"]');
                if (modal) {{
                    modal.remove();
                }}
            }}

            // FUNCI√ìN PARA MOSTRAR MODAL ELEGANTE
            function mostrarModalElegante() {{
                // Crear modal con dise√±o moderno
                var modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.85);
                    backdrop-filter: blur(10px);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                    font-family: 'Montserrat', Arial, sans-serif;
                `;
                
                modal.innerHTML = `
                    <div style="
                        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
                        border-radius: 25px;
                        padding: 40px;
                        text-align: center;
                        max-width: 550px;
                        width: 90%;
                        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
                        border: 3px solid #00ff88;
                        position: relative;
                        overflow: hidden;
                    ">
                        <!-- Efecto de brillo superior -->
                        <div style="
                            position: absolute;
                            top: -50%;
                            left: -50%;
                            width: 200%;
                            height: 200%;
                            background: linear-gradient(45deg, transparent, rgba(0, 255, 136, 0.1), transparent);
                            animation: shine 3s infinite;
                        "></div>
                        
                        <!-- Icono principal -->
                        <div style="
                            width: 80px;
                            height: 80px;
                            background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
                            border-radius: 50%;
                            margin: 0 auto 25px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 40px;
                            color: white;
                            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.3);
                            position: relative;
                            z-index: 2;
                        ">
                            üöÄ
                        </div>
                        
                        <!-- T√≠tulo -->
                        <h2 style="
                            color: #00ff88;
                            margin-bottom: 15px;
                            font-size: 32px;
                            font-weight: 800;
                            text-shadow: 0 2px 10px rgba(0, 255, 136, 0.3);
                            position: relative;
                            z-index: 2;
                        ">
                            Dise√±o de Soluci√≥n Directo
                        </h2>
                        
                        <!-- Descripci√≥n -->
                        <p style="
                            color: #e0e7ef;
                            margin-bottom: 30px;
                            font-size: 16px;
                            line-height: 1.6;
                            opacity: 0.9;
                            position: relative;
                            z-index: 2;
                        ">
                            Ingresa el ID para generar autom√°ticamente el dise√±o de soluci√≥n.<br>
                            <span style="color: #00ff88; font-weight: 600;">Se crear√° y llenar√° el archivo autom√°ticamente</span>
                        </p>
                        
                        <!-- Campo de ID -->
                        <div style="margin-bottom: 35px; position: relative; z-index: 2;">
                            <input type="text" 
                                id="idDisenoSolucion" 
                                placeholder="Ej: 5140066159E" 
                                style="
                                    width: 100%;
                                    padding: 18px 20px;
                                    border: 2px solid rgba(0, 255, 136, 0.3);
                                    border-radius: 15px;
                                    background: rgba(255, 255, 255, 0.1);
                                    color: white;
                                    font-size: 16px;
                                    text-align: center;
                                    outline: none;
                                    transition: all 0.3s ease;
                                    font-family: 'Montserrat', Arial, sans-serif;
                                "
                                onfocus="this.style.borderColor='#00ff88'; this.style.background='rgba(255, 255, 255, 0.15)'; this.style.transform='scale(1.02)'"
                                onblur="this.style.borderColor='rgba(0, 255, 136, 0.3)'; this.style.background='rgba(255, 255, 255, 0.1)'; this.style.transform='scale(1)'"
                            >
                        </div>
                        
                        <!-- Botones -->
                        <div style="
                            display: flex;
                            gap: 20px;
                            justify-content: center;
                            position: relative;
                            z-index: 2;
                        ">
                            <button onclick="generarDisenoSolucionElegante()" style="
                                background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
                                color: #1e3c72;
                                border: none;
                                padding: 18px 35px;
                                border-radius: 15px;
                                font-size: 16px;
                                font-weight: 700;
                                cursor: pointer;
                                transition: all 0.3s ease;
                                font-family: 'Montserrat', Arial, sans-serif;
                                box-shadow: 0 8px 25px rgba(0, 255, 136, 0.3);
                                text-transform: uppercase;
                                letter-spacing: 0.5px;
                            "
                            onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 12px 35px rgba(0, 255, 136, 0.4)'"
                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 25px rgba(0, 255, 136, 0.3)'"
                            >
                                üöÄ Generar Dise√±o
                            </button>
                            
                            <button onclick="cerrarModalElegante()" style="
                                background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
                                color: white;
                                border: none;
                                padding: 18px 35px;
                                border-radius: 15px;
                                font-size: 16px;
                                font-weight: 700;
                                cursor: pointer;
                                transition: all 0.3s ease;
                                font-family: 'Montserrat', Arial, sans-serif;
                                box-shadow: 0 8px 25px rgba(255, 107, 107, 0.3);
                                text-transform: uppercase;
                                letter-spacing: 0.5px;
                            "
                            onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 12px 35px rgba(255, 107, 107, 0.4)'"
                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 25px rgba(255, 107, 107, 0.3)'"
                            >
                                ‚ùå Cancelar
                            </button>
                        </div>
                    </div>
                `;
                
                // Agregar estilos CSS para la animaci√≥n
                var style = document.createElement('style');
                style.textContent = `
                    @keyframes shine {{
                        0% {{ transform: translateX(-100%) translateY(-100%) rotate(45deg); }}
                        50% {{ transform: translateX(100%) translateY(100%) rotate(45deg); }}
                        100% {{ transform: translateX(-100%) translateY(-100%) rotate(45deg); }}
                    }}
                `;
                document.head.appendChild(style);
                
                // Agregar modal al DOM
                document.body.appendChild(modal);
                
                // Enfocar el campo autom√°ticamente
                setTimeout(() => {{
                    var input = document.getElementById('idDisenoSolucion');
                    if (input) {{
                        input.focus();
                        input.select();
                    }}
                }}, 100);
            }}
            
            // FUNCI√ìN PARA CERRAR MODAL ELEGANTE
            function cerrarModalElegante() {{
                var modal = document.querySelector('div[style*="backdrop-filter: blur(10px)"]');
                if (modal) {{
                    modal.remove();
                }}
            }}
            
            // FUNCI√ìN PARA GENERAR DISE√ëO DE SOLUCI√ìN ELEGANTE
            function generarDisenoSolucionElegante() {{
                var idInput = document.getElementById('idDisenoSolucion');
                var idDiseno = idInput.value.trim();
                
                if (!idDiseno) {{
                    alert('‚ùå Por favor ingresa un ID v√°lido');
                    idInput.focus();
                    return;
                }}
                
                if (idDiseno.length < 3) {{
                    alert('‚ùå El ID debe tener al menos 3 caracteres');
                    idInput.focus();
                    return;
                }}
                
                // Cerrar el modal
                cerrarModalElegante();
                
                // Mostrar mensaje de generaci√≥n
                mostrarMensajeGeneracion('üöÄ Generando dise√±o de soluci√≥n autom√°ticamente...', 'info');
                
                // Generar dise√±o de soluci√≥n autom√°ticamente
                generarDisenoSolucionAutomatico(idDiseno);
            }}

            // FUNCI√ìN PARA GENERAR DISE√ëO DE SOLUCI√ìN DIRECTO
            function generarDisenoSolucionDirecto() {{
                // Obtener el ID ingresado
                const idInput = document.getElementById('idDisenoSolucion');
                const idDiseno = idInput.value.trim();
                
                if (!idDiseno) {{
                    alert('‚ùå Por favor ingresa un ID v√°lido');
                    idInput.focus();
                    return;
                }}
                
                // Validar formato del ID (debe tener al menos 3 caracteres)
                if (idDiseno.length < 3) {{
                    alert('‚ùå El ID debe tener al menos 3 caracteres');
                    idInput.focus();
                    return;
                }}
                
                console.log('üöÄ Generando dise√±o de soluci√≥n para ID:', idDiseno);
                
                // Cerrar el modal
                cerrarModal();
                
                // Mostrar mensaje de generaci√≥n
                mostrarMensajeGeneracion('üöÄ Generando dise√±o de soluci√≥n autom√°ticamente...', 'info');
                
                // Generar dise√±o de soluci√≥n autom√°ticamente
                generarDisenoSolucionAutomatico(idDiseno);
            }}

            // FUNCI√ìN PARA GENERAR DISE√ëO DE SOLUCI√ìN AUTOM√ÅTICAMENTE
            function generarDisenoSolucionAutomatico(userId) {{
                console.log('üî• Generando dise√±o de soluci√≥n autom√°ticamente para:', userId);
                
                // Llamar a la API para generar el dise√±o de soluci√≥n
                fetch('/generar_diseno_solucion', {{
                    method: 'POST',
                    headers: {{
                        'Content-Type': 'application/json',
                    }},
                    body: JSON.stringify({{
                        user_id: userId,
                        tipo_documento: 'diseno_solucion',
                        fila_idx: '0'
                    }})
                }})
                .then(response => response.json())
                .then(data => {{
                    if (data.success) {{
                        console.log('‚úÖ Dise√±o de soluci√≥n generado exitosamente');
                        mostrarMensajeGeneracion('‚úÖ Dise√±o de soluci√≥n generado exitosamente', 'success');
                        
                        // Redirigir al dise√±o de soluci√≥n despu√©s de generar el archivo
                        setTimeout(() => {{
                            window.location.href = '/diseno_solucion?user_id=' + userId + '&fila_idx=0&llenado_automatico=true';
                        }}, 1500);
                    }} else {{
                        console.error('‚ùå Error generando dise√±o de soluci√≥n:', data.message);
                        mostrarMensajeGeneracion('‚ùå Error generando dise√±o de soluci√≥n: ' + data.message, 'error');
                    }}
                }})
                .catch(error => {{
                    console.error('Error:', error);
                    mostrarMensajeGeneracion('‚ùå Error de conexi√≥n al generar dise√±o de soluci√≥n', 'error');
                }});
            }}

            <!-- JavaScript externo para evitar conflictos con f-strings -->
            
            // FUNCI√ìN PARA GENERAR DISE√ëO DE SOLUCI√ìN AUTOM√ÅTICAMENTE
            function generarDisenoSolucionAutomatico(userId) {{
                console.log('üî• Generando dise√±o de soluci√≥n autom√°ticamente para:', userId);
                
                // Mostrar mensaje de generaci√≥n
                mostrarMensajeGeneracion('üöÄ Generando dise√±o de soluci√≥n autom√°ticamente...', 'info');
                
                // PRIMERO: Verificar si hay IDs similares con diferentes puntas B
                verificarIdsSimilaresDiseno(userId);
            }}
            
            // FUNCI√ìN PARA VERIFICAR IDs SIMILARES EN DISE√ëO DE SOLUCI√ìN
            function verificarIdsSimilaresDiseno(userId) {{
                console.log('üîç Verificando IDs similares para dise√±o de soluci√≥n:', userId);
                
                fetch('/buscar_ids_similares_diseno', {{
                    method: 'POST',
                    headers: {{
                        'Content-Type': 'application/json',
                    }},
                    body: JSON.stringify({{
                        id_busqueda: userId,
                        tipo_documento: 'diseno_solucion'
                    }})
                }})
                .then(response => response.json())
                .then(data => {{
                    if (data.success) {{
                        if (data.ids_encontrados && data.ids_encontrados.length > 1) {{
                            // Hay m√∫ltiples IDs similares, mostrar opciones
                            console.log('üìã M√∫ltiples IDs encontrados:', data.ids_encontrados);
                            mostrarOpcionesIdsDiseno(data.ids_encontrados, userId);
                        }} else {{
                            // Solo un ID, proceder con el llenado autom√°tico
                            console.log('‚úÖ ID √∫nico encontrado, procediendo con llenado autom√°tico');
                            procederConLlenadoAutomatico(userId, data.ids_encontrados[0].fila_idx);
                        }}
                    }} else {{
                        console.error('‚ùå Error verificando IDs similares:', data.message);
                        // En caso de error, proceder con el ID original
                        procederConLlenadoAutomatico(userId, '0');
                    }}
                }})
                .catch(error => {{
                    console.error('Error:', error);
                    // En caso de error, proceder con el ID original
                    procederConLlenadoAutomatico(userId, '0');
                }});
            }}
            
            // FUNCI√ìN PARA MOSTRAR OPCIONES DE IDs EN DISE√ëO DE SOLUCI√ìN
            function mostrarOpcionesIdsDiseno(idsEncontrados, userIdOriginal) {{
                console.log('üéØ Mostrando opciones de IDs para dise√±o de soluci√≥n');
                
                // Crear modal de selecci√≥n
                var modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.85);
                    backdrop-filter: blur(10px);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                    font-family: 'Montserrat', Arial, sans-serif;
                `;
                
                var opcionesHTML = '';
                idsEncontrados.forEach((item, index) => {{
                    opcionesHTML += `
                        <div class="opcion-id" onclick="seleccionarIdDiseno('${{item.id}}', '${{item.fila_idx}}', '${{item.nombre_a}}', '${{item.nombre_b}}')" style="
                            background: linear-gradient(135deg, rgba(30, 60, 114, 0.9) 0%, rgba(42, 82, 152, 0.9) 100%);
                            border: 2px solid rgba(0, 255, 136, 0.3);
                            border-radius: 15px;
                            padding: 20px;
                            margin: 10px 0;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            text-align: left;
                        " onmouseover="this.style.borderColor='#00ff88'; this.style.transform='scale(1.02)'" onmouseout="this.style.borderColor='rgba(0, 255, 136, 0.3)'; this.style.transform='scale(1)'">
                            <div style="color: #00ff88; font-weight: 700; font-size: 18px; margin-bottom: 8px;">
                                üéØ ID: ${{item.id}}
                            </div>
                            <div style="color: #e0e7ef; font-size: 14px; margin-bottom: 5px;">
                                üìç Sitio A: ${{item.nombre_a}}
                            </div>
                            <div style="color: #e0e7ef; font-size: 14px;">
                                üìç Sitio B: ${{item.nombre_b}}
                            </div>
                        </div>
                    `;
                }});
                
                modal.innerHTML = `
                    <div style="
                        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
                        border-radius: 25px;
                        padding: 40px;
                        text-align: center;
                        max-width: 600px;
                        width: 90%;
                        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
                        border: 3px solid #00ff88;
                        position: relative;
                        overflow: hidden;
                    ">
                        <div style="
                            width: 80px;
                            height: 80px;
                            background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
                            border-radius: 50%;
                            margin: 0 auto 25px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 40px;
                            color: white;
                            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.3);
                        ">
                            üîç
                        </div>
                        
                        <h2 style="
                            color: #00ff88;
                            margin-bottom: 15px;
                            font-size: 28px;
                            font-weight: 800;
                        ">
                            M√∫ltiples IDs Encontrados
                        </h2>
                        
                        <p style="
                            color: #e0e7ef;
                            margin-bottom: 30px;
                            font-size: 16px;
                            line-height: 1.6;
                        ">
                            Se encontraron m√∫ltiples registros con ID similar.<br>
                            <span style="color: #00ff88; font-weight: 600;">Selecciona el correcto para continuar:</span>
                        </p>
                        
                        <div style="max-height: 400px; overflow-y: auto; margin-bottom: 30px;">
                            ${{opcionesHTML}}
                        </div>
                        
                        <button onclick="cerrarModalOpcionesDiseno()" style="
                            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
                            color: white;
                            border: none;
                            padding: 15px 30px;
                            border-radius: 12px;
                            font-size: 16px;
                            font-weight: 700;
                            cursor: pointer;
                            transition: all 0.3s ease;
                        " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                            ‚ùå Cancelar
                        </button>
                    </div>
                `;
                
                document.body.appendChild(modal);
            }}
            
            // FUNCI√ìN PARA SELECCIONAR ID EN DISE√ëO DE SOLUCI√ìN
            function seleccionarIdDiseno(idSeleccionado, filaIdx, nombreA, nombreB) {{
                console.log('‚úÖ ID seleccionado para dise√±o de soluci√≥n:', idSeleccionado, 'fila_idx:', filaIdx);
                console.log('üìç Sitio A:', nombreA, 'Sitio B:', nombreB);
                
                // Cerrar modal de opciones
                cerrarModalOpcionesDiseno();
                
                // Mostrar mensaje de confirmaci√≥n
                mostrarMensajeGeneracion('üéØ ID seleccionado: ' + idSeleccionado + ' - Procediendo con llenado autom√°tico...', 'info');
                
                // Proceder con el llenado autom√°tico
                setTimeout(() => {{
                    procederConLlenadoAutomatico(idSeleccionado, filaIdx);
                }}, 1000);
            }}
            
            // FUNCI√ìN PARA CERRAR MODAL DE OPCIONES EN DISE√ëO DE SOLUCI√ìN
            function cerrarModalOpcionesDiseno() {{
                var modal = document.querySelector('div[style*="backdrop-filter: blur(10px)"]');
                if (modal) {{
                    modal.remove();
                }}
            }}
            
            // FUNCI√ìN PARA PROCEDER CON LLENADO AUTOM√ÅTICO
            function procederConLlenadoAutomatico(userId, filaIdx) {{
                console.log('üöÄ Procediendo con llenado autom√°tico para:', userId, 'fila_idx:', filaIdx);
                console.log('üîç Datos a enviar a la API:', {{
                    'user_id': userId,
                    'tipo_documento': 'diseno_solucion',
                    'fila_idx': filaIdx
                }});
                
                // Mostrar mensaje de generaci√≥n
                mostrarMensajeGeneracion('üöÄ Generando dise√±o de soluci√≥n autom√°ticamente...', 'info');
                
                // Llamar a la API para generar el dise√±o de soluci√≥n
                fetch('/generar_diseno_solucion', {{
                    method: 'POST',
                    headers: {{
                        'Content-Type': 'application/json',
                    }},
                    body: JSON.stringify({{
                        user_id: userId,
                        tipo_documento: 'diseno_solucion',
                        fila_idx: filaIdx
                    }})
                }})
                .then(response => {{
                    console.log('üì° Respuesta de la API recibida:', response);
                    return response.json();
                }})
                .then(data => {{
                    console.log('üìä Datos de respuesta de la API:', data);
                    
                    if (data.success) {{
                        console.log('‚úÖ Dise√±o de soluci√≥n generado exitosamente');
                        mostrarMensajeGeneracion('‚úÖ Dise√±o de soluci√≥n generado exitosamente', 'success');
                        
                        // Redirigir a la p√°gina de dise√±o de soluci√≥n
                        setTimeout(() => {{
                            console.log('üîÑ Redirigiendo a:', '/diseno_solucion?user_id=' + userId + '&fila_idx=' + filaIdx + '&llenado_automatico=true');
                            window.location.href = '/diseno_solucion?user_id=' + userId + '&fila_idx=' + filaIdx + '&llenado_automatico=true';
                        }}, 1500);
                    }} else {{
                        console.error('‚ùå Error generando dise√±o de soluci√≥n:', data.message);
                        mostrarMensajeGeneracion('‚ùå Error generando dise√±o de soluci√≥n: ' + data.message, 'error');
                        
                        // En caso de error, redirigir de todas formas para mostrar los datos
                        setTimeout(() => {{
                            console.log('üîÑ Redirigiendo a pesar del error...');
                            window.location.href = '/diseno_solucion?user_id=' + userId + '&fila_idx=' + filaIdx + '&llenado_automatico=true';
                        }}, 2000);
                    }}
                }})
                .catch(error => {{
                    console.error('‚ùå Error de conexi√≥n:', error);
                    mostrarMensajeGeneracion('‚ùå Error de conexi√≥n al generar dise√±o de soluci√≥n', 'error');
                    
                    // En caso de error de conexi√≥n, redirigir de todas formas
                    setTimeout(() => {{
                        console.log('üîÑ Redirigiendo a pesar del error de conexi√≥n...');
                        window.location.href = '/diseno_solucion?user_id=' + userId + '&fila_idx=' + filaIdx + '&llenado_automatico=true';
                    }}, 2000);
                }});
            }}
        </script>
    </body>
    </html>
    """
    return html

@app.route('/limpiar_cache', methods=['POST'])
def limpiar_cache():
    """
    Limpia el cache de datos para forzar una nueva descarga
    """
    try:
        data_cache.clear()
        logger.info("üßπ Cache limpiado exitosamente")
        return jsonify({'success': True, 'message': 'Cache limpiado exitosamente'})
    except Exception as e:
        logger.error(f"‚ùå Error al limpiar cache: {e}")
        return jsonify({'success': False, 'message': f'Error: {str(e)}'})

@app.route('/generar_archivo_automatico', methods=['POST'])
def generar_archivo_automatico():
    """
    Genera autom√°ticamente un archivo de Site Survey para un ID espec√≠fico
    """
    try:
        import json
        data = request.get_json()
        user_id = data.get('user_id')
        tipo_documento = data.get('tipo_documento', 'ptp')
        fila_idx = data.get('fila_idx', '0')
        
        if not user_id:
            return jsonify({'success': False, 'message': 'ID de usuario requerido'})
        
        print(f"üöÄ GENERACI√ìN AUTOM√ÅTICA SOLICITADA para {user_id}")
        
        # Llamar a la funci√≥n de generaci√≥n autom√°ticamente
        if tipo_documento == 'ptp':
            # Generar Site Survey PtP
            result = site_survey_generator(user_id, fila_idx, 'ptp')
            if result:
                print(f"‚úÖ Archivo generado autom√°ticamente para {user_id}")
                return jsonify({'success': True, 'message': f'Archivo generado exitosamente para {user_id}'})
            else:
                print(f"‚ùå Generaci√≥n fall√≥ para {user_id}")
                return jsonify({'success': False, 'message': 'No se pudo generar el archivo autom√°ticamente'})
        elif tipo_documento == 'ptmp':
            # Generar Site Survey PtMP
            result = site_survey_generator(user_id, fila_idx, 'ptmp')
            if result:
                print(f"‚úÖ Archivo generado autom√°ticamente para {user_id}")
                return jsonify({'success': True, 'message': f'Archivo generado exitosamente para {user_id}'})
            else:
                print(f"‚ùå Generaci√≥n fall√≥ para {user_id}")
                return jsonify({'success': False, 'message': 'No se pudo generar el archivo autom√°ticamente'})
        else:
            return jsonify({'success': False, 'message': 'Tipo de documento no soportado para generaci√≥n autom√°tica'})
            
    except Exception as e:
        print(f"‚ùå Error en generaci√≥n autom√°tica: {e}")
        import traceback
        traceback.print_exc()
        return jsonify({'success': False, 'message': f'Error generando archivo: {str(e)}'})



@app.route('/buscar_ids_similares', methods=['POST'])
def buscar_ids_similares():
    try:
        data = request.get_json()
        id_busqueda = data.get('id_busqueda', '')
        
        if not id_busqueda:
            return jsonify({'success': False, 'message': 'ID de b√∫squeda no proporcionado'})
        
        # Leer la base de datos (OPTIMIZADO CON CACHE)
        df_db = get_cached_dataframe()
        
        # Buscar IDs que contengan la b√∫squeda (OPTIMIZADO CON PROCESAMIENTO POR LOTES)
        ids_encontrados = []
        
        # Procesar en lotes de 100 filas para mejor rendimiento
        batch_size = 100
        total_rows = len(df_db)
        
        for start_idx in range(0, total_rows, batch_size):
            end_idx = min(start_idx + batch_size, total_rows)
            batch_df = df_db.iloc[start_idx:end_idx]
            
            # Filtrar el lote actual usando √≠ndices pre-calculados (MUCHO M√ÅS R√ÅPIDO)
            mask = batch_df['ID_lower'].str.contains(id_busqueda.lower(), na=False)
            matching_rows = batch_df[mask]
            
            for index, row in matching_rows.iterrows():
                ids_encontrados.append({
                    'id': str(row.get('ID', '')),
                    'nombre_a': row.get('Nombre del sitio A', ''),
                    'nombre_b': row.get('Nombre del sitio B', ''),
                    'fila_idx': index
                })
        
        return jsonify({
            'success': True,
            'ids_encontrados': ids_encontrados
        })
        
    except Exception as e:
        print(f"Error al buscar IDs similares: {e}")
        return jsonify({'success': False, 'message': f'Error: {str(e)}'})

@app.route('/buscar_ids_similares_diseno', methods=['POST'])
def buscar_ids_similares_diseno():
    """
    Busca IDs similares espec√≠ficamente para dise√±o de soluci√≥n
    """
    try:
        data = request.get_json()
        id_busqueda = data.get('id_busqueda', '')
        tipo_documento = data.get('tipo_documento', 'diseno_solucion')
        
        if not id_busqueda:
            return jsonify({'success': False, 'message': 'ID de b√∫squeda no proporcionado'})
        
        print(f"üîç Buscando IDs similares para dise√±o de soluci√≥n: {id_busqueda}")
        
        # Leer la base de datos (OPTIMIZADO CON CACHE)
        df_db = get_cached_dataframe()
        
        # Buscar IDs que contengan la b√∫squeda
        ids_encontrados = []
        
        # Buscar coincidencias exactas primero
        exact_matches = df_db[df_db['ID'] == id_busqueda]
        for index, row in exact_matches.iterrows():
            ids_encontrados.append({
                'id': str(row.get('ID', '')),
                'nombre_a': row.get('Nombre del sitio A', '') or '',
                'nombre_b': row.get('Nombre del sitio B', '') or '',
                'fila_idx': index
            })
        
        # Si no hay coincidencias exactas, buscar similares
        if not ids_encontrados:
            # Buscar IDs que contengan la b√∫squeda
            mask = df_db['ID'].str.contains(id_busqueda, na=False, case=False)
            matching_rows = df_db[mask]
            
            for index, row in matching_rows.iterrows():
                ids_encontrados.append({
                    'id': str(row.get('ID', '')),
                    'nombre_a': row.get('Nombre del sitio A', '') or '',
                    'nombre_b': row.get('Nombre del sitio B', '') or '',
                    'fila_idx': index
                })
        
        # Limpiar datos NaN
        for item in ids_encontrados:
            if pd.isna(item['nombre_a']):
                item['nombre_a'] = 'Sitio A no especificado'
            if pd.isna(item['nombre_b']):
                item['nombre_b'] = 'Sitio B no especificado'
        
        # Ordenar por relevancia (exacto primero, luego parcial)
        ids_encontrados.sort(key=lambda x: (
            x['id'].lower() != id_busqueda.lower(),  # Exacto primero
            len(x['id'])  # M√°s corto primero
        ))
        
        print(f"üîç IDs encontrados para dise√±o de soluci√≥n '{id_busqueda}': {len(ids_encontrados)}")
        for item in ids_encontrados:
            print(f"  - ID: {item['id']}, Sitio A: {item['nombre_a']}, Sitio B: {item['nombre_b']}")
        
        return jsonify({
            'success': True, 
            'ids_encontrados': ids_encontrados[:10],  # M√°ximo 10 resultados
            'total_encontrados': len(ids_encontrados)
        })
        
    except Exception as e:
        print(f"‚ùå Error en buscar_ids_similares_diseno: {e}")
        import traceback
        traceback.print_exc()
        return jsonify({'success': False, 'message': f'Error: {str(e)}'})

@app.route('/descargar_site_survey')
def descargar_site_survey():
    user_id = request.args.get('user_id')
    def limpiar_nombre_archivo(nombre):
        return re.sub(r'[^a-zA-Z0-9_-]', '', str(nombre))
    user_id_limpio = limpiar_nombre_archivo(user_id)
    # Usar ruta relativa para que funcione en cualquier computadora
    base_dir = os.path.dirname(os.path.abspath(__file__))
    output_path = os.path.join(base_dir, 'site_survey', f'ss_{user_id_limpio}.xlsx')
    
    # Si no existe el archivo sin timestamp, buscar con timestamp
    if not os.path.exists(output_path):
        import glob
        patron_archivo = os.path.join(base_dir, 'site_survey', f'ss_{user_id_limpio}*.xlsx')
        archivos_encontrados = glob.glob(patron_archivo)
        
        if archivos_encontrados:
            # Usar el archivo m√°s reciente
            archivo_mas_reciente = max(archivos_encontrados, key=os.path.getctime)
            output_path = archivo_mas_reciente
            print(f"DEBUG: Descargando archivo encontrado: {output_path}")
        else:
            print(f"Archivo no encontrado para descargar: {output_path}")
            return "El archivo ya no est√° disponible. Por favor, genera uno nuevo."

    @after_this_request
    def eliminar_archivos_temporales(response):
        try:
            # Borra el Excel generado
            if os.path.exists(output_path):
                os.remove(output_path)
                print(f"Archivo eliminado: {output_path}")
            # Borra otros archivos temporales relacionados con el user_id
            patron = os.path.join(base_dir, 'site_survey', f'*{user_id_limpio}*.*')
            for archivo in glob.glob(patron):
                try:
                    if archivo != output_path:  # Ya se elimin√≥ arriba
                        os.remove(archivo)
                        print(f"Archivo temporal eliminado: {archivo}")
                except Exception as e:
                    print(f"Error al eliminar archivo temporal: {archivo} - {e}")
        except Exception as e:
            print(f"Error al eliminar archivos: {e}")
        return response

    return send_file(output_path, as_attachment=True)

def llenar_archivo_ptp_optimizado(output_path, row, nombre_a, nombre_b, user_id):
    """
    Funci√≥n optimizada para llenar archivos PtP con datos del Site Survey
    """
    try:
        print("üöÄ INICIANDO LLENADO OPTIMIZADO DEL ARCHIVO PTP...")
        
        # ===== DEBUG INICIAL - VERIFICAR DATOS RECIBIDOS =====
        print("üîç DEBUG INICIAL - VERIFICANDO DATOS RECIBIDOS:")
        print(f"  - output_path: {output_path}")
        print(f"  - nombre_a: '{nombre_a}'")
        print(f"  - nombre_b: '{nombre_b}'")
        print(f"  - user_id: '{user_id}'")
        print(f"  - row es DataFrame? {hasattr(row, 'index')}")
        if hasattr(row, 'index'):
            print(f"  - row tiene {len(row)} campos")
            print(f"  - Primeros 5 campos: {list(row.index)[:5]}")
            print(f"  - ID en row: '{row.get('ID', 'NO ENCONTRADO')}'")
            print(f"  - ID 2 en row: '{row.get('ID 2', 'NO ENCONTRADO')}'")
            print(f"  - ¬øuser_id coincide con ID? {row.get('ID', 'NO ENCONTRADO') == user_id}")
        else:
            print(f"  - row NO es un DataFrame v√°lido")
            print(f"  - Tipo de row: {type(row)}")
            print(f"  - Contenido de row: {row}")
        
        print("üîç FIN DEBUG INICIAL")
        print("=" * 80)
        
        # Importar xlwings
        try:
            import xlwings as xw
            print("‚úÖ xlwings importado correctamente")
        except ImportError as e:
            print(f"‚ùå Error importando xlwings: {e}")
            return False
        
        # Iniciar Excel
        try:
            app_excel = xw.App(visible=False)
            app_excel.display_alerts = False
            app_excel.screen_updating = False
            print("‚úÖ Excel iniciado correctamente")
        except Exception as excel_error:
            print(f"‚ùå Error iniciando Excel: {excel_error}")
            return False
        
        # Abrir el archivo
        try:
            wb = app_excel.books.open(output_path)
            print("‚úÖ Archivo abierto correctamente")
        except Exception as e:
            print(f"‚ùå Error abriendo archivo: {e}")
            return False
        
        # Obtener las hojas del Site Survey
        try:
            print("üìã Obteniendo hojas del Site Survey...")
            ws_caratula = wb.sheets['0. Car√°tula']
            ws_info_a = wb.sheets['1. Informaci√≥n General A']
            ws_info_b = wb.sheets['2. Informaci√≥n General B']
            ws_info_c = wb.sheets['3. Espacios en Torre y Piso A-B']
            ws_info_d = wb.sheets['4. Planos A']
            ws_info_e = wb.sheets['5. Planos B']
            ws_info_f = wb.sheets['6. Reporte Fotos A']
            ws_info_g = wb.sheets['7. Reporte Fotos B']
            print("‚úÖ Todas las hojas obtenidas")
            
            # Debug: Verificar que las hojas se obtuvieron correctamente
            print(f"üîç DEBUG HOJAS:")
            print(f"  - ws_caratula: {ws_caratula.name if ws_caratula else 'NO OBTENIDA'}")
            print(f"  - ws_info_a: {ws_info_a.name if ws_info_a else 'NO OBTENIDA'}")
            print(f"  - ws_info_b: {ws_info_b.name if ws_info_b else 'NO OBTENIDA'}")
            print(f"  - ws_info_c: {ws_info_c.name if ws_info_c else 'NO OBTENIDA'}")
            
            # Verificar que las hojas no sean None
            if not ws_info_a:
                print("‚ùå ERROR: ws_info_a es None")
                return False
            if not ws_info_b:
                print("‚ùå ERROR: ws_info_b es None")
                return False
            if not ws_info_c:
                print("‚ùå ERROR: ws_info_c es None")
                return False
                
        except Exception as e:
            print(f"‚ùå Error obteniendo hojas: {e}")
            return False
        
        # Llenado de los checkboxes y campos
        ws_info_a.range('B63').value = 'N/A'
        
        # Funci√≥n mejorada para checkboxes
        def set_checkbox(worksheet, cell, condition, debug_name=""):
            """Funci√≥n para establecer checkboxes con debug"""
            value = bool(condition)
            worksheet.range(cell).value = value
            if debug_name:
                print(f"DEBUG: {debug_name} - Celda {cell}: {value}")
            return value
        
        # Debug para tipo de zona
        tipo_zona_original = row.get('Tipo de Zona', '')
        tipo_zona = normaliza_texto(tipo_zona_original)
        print(f"*** DEBUG TIPO DE ZONA ***")
        print(f"   - Valor original: '{tipo_zona_original}'")
        print(f"   - Valor normalizado: '{tipo_zona}'")
        
        set_checkbox(ws_info_a, 'L21', 'urbana' in tipo_zona, "Tipo Zona - Urbana")
        set_checkbox(ws_info_a, 'P21', 'suburbana' in tipo_zona, "Tipo Zona - Suburbana")
        set_checkbox(ws_info_a, 'U21', 'rural' in tipo_zona, "Tipo Zona - Rural")
        set_checkbox(ws_info_a, 'X21', 'ejidal' in tipo_zona, "Tipo Zona - Ejidal")
        set_checkbox(ws_info_a, 'AB21', 'pueblomagico' in tipo_zona, "Tipo Zona - Pueblo M√°gico")
        
        ws_caratula.range('A43').value = f"{nombre_a} - {nombre_b}"
        
        tipo_visible_original = row.get('El sitio es visible de d√≠a y de noche (libre de maleza y arboles): ', '')
        tipo_visible = normaliza_texto(tipo_visible_original)
        print(f"*** DEBUG VISIBILIDAD ***")
        print(f"   - Valor original: '{tipo_visible_original}'")
        print(f"   - Valor normalizado: '{tipo_visible}'")
        
        set_checkbox(ws_info_a, 'P22', 'si' in tipo_visible, "Visibilidad - S√≠")
        set_checkbox(ws_info_a, 'S22', 'no' in tipo_visible, "Visibilidad - No")
        
        tipo_camino_original = row.get('Tipo de Camino', '')
        tipo_camino = normaliza_texto(tipo_camino_original)
        print(f"*** DEBUG TIPO DE CAMINO ***")
        print(f"   - Valor original: '{tipo_camino_original}'")
        print(f"   - Valor normalizado: '{tipo_camino}'")
        
        set_checkbox(ws_info_a, 'G23', 'terraceria' in tipo_camino, "Tipo Camino - Terracer√≠a")
        set_checkbox(ws_info_a, 'L23', 'pavimentado' in tipo_camino, "Tipo Camino - Pavimentado")
        set_checkbox(ws_info_a, 'Q23', 'empedrado' in tipo_camino, "Tipo Camino - Empedrado")
        set_checkbox(ws_info_a, 'V23', 'mixto' in tipo_camino, "Tipo Camino - Mixto")

        # Debug para checkbox de gr√∫a - SITIO A
        print(f"*** DEBUG CHECKBOX GR√öA SITIO A ***")
        
        # Mostrar todos los campos disponibles para debug
        print(f"   - Todos los campos disponibles: {list(row.index)}")
        
        # Buscar el campo correcto (sin prefijo "comentario:")
        campo_grua = 'En caso de requerirse gr√∫a, identifique si es factible el uso de la misma y que no se tenga una posible obstrucci√≥n.'
        print(f"   - Campo en row: {campo_grua in row}")
        
        # Buscar variaciones del nombre del campo
        if campo_grua not in row:
            print(f"   - Campo no encontrado, buscando variaciones...")
            for campo in row.index:
                if 'gr√∫a' in campo.lower() and 'obstrucci√≥n' in campo.lower() and not campo.startswith('comentario:'):
                    print(f"   - Posible variaci√≥n encontrada: '{campo}' = '{row[campo]}'")
                elif 'gr√∫a' in campo.lower() or 'grua' in campo.lower():
                    print(f"   - Campo con 'gr√∫a' encontrado: '{campo}' = '{row[campo]}'")
        
        tipo_caso_grua_original = row.get(campo_grua, '')
        print(f"   - Valor original: '{tipo_caso_grua_original}'")
        tipo_caso_grua = normaliza_texto(tipo_caso_grua_original)
        print(f"   - Valor normalizado: '{tipo_caso_grua}'")
        
        # Verificar con diferentes variaciones de may√∫sculas/min√∫sculas
        print(f"   - ¬øContiene 'izaje libre'? {'izaje libre' in tipo_caso_grua}")
        print(f"   - ¬øContiene 'izaje con obstaculos'? {'izaje con obstaculos' in tipo_caso_grua}")
        print(f"   - ¬øContiene 'requiere visita del especialista'? {'requiere visita del especialista' in tipo_caso_grua}")
        
        # Verificar tambi√©n en el valor original
        print(f"   - ¬øContiene 'Izaje libre' en original? {'Izaje libre' in tipo_caso_grua_original}")
        print(f"   - ¬øContiene 'Izaje con obstaculos' en original? {'Izaje con obstaculos' in tipo_caso_grua_original}")
        print(f"   - ¬øContiene 'Requiere visita del especialista' en original? {'Requiere visita del especialista' in tipo_caso_grua_original}")
        
        # Usar comparaci√≥n case-insensitive
        valor_b61 = 'izaje libre' in tipo_caso_grua or 'Izaje libre' in tipo_caso_grua_original
        valor_j61 = 'izaje con obstaculos' in tipo_caso_grua or 'Izaje con obstaculos' in tipo_caso_grua_original
        valor_s61 = 'requiere visita del especialista' in tipo_caso_grua or 'Requiere visita del especialista' in tipo_caso_grua_original
        
        print(f"   - Valor calculado para B61: {valor_b61}")
        print(f"   - Valor calculado para J61: {valor_j61}")
        print(f"   - Valor calculado para S61: {valor_s61}")
        
        set_checkbox(ws_info_a, 'B61', valor_b61, "Gr√∫a - Izaje libre")
        set_checkbox(ws_info_a, 'J61', valor_j61, "Gr√∫a - Izaje con obst√°culos")
        set_checkbox(ws_info_a, 'S61', valor_s61, "Gr√∫a - Requiere visita especialista")
        
        # ===== LLENADO COMPLETO DE TODOS LOS PAR√ÅMETROS =====
        print("üî• LLENANDO TODOS LOS PAR√ÅMETROS COMO PRIMERA VEZ...")
        
        # Debug para checkbox de gr√∫a - SITIO B
        print(f"*** DEBUG CHECKBOX GR√öA SITIO B ***")
        
        # Buscar el campo correcto (sin prefijo "comentario:")
        campo_grua2 = 'En caso de requerirse gr√∫a, identifique si es factible el uso de la misma y que no se tenga una posible obstrucci√≥n2.'
        print(f"   - Campo en row: {campo_grua2 in row}")
        
        # Buscar variaciones del nombre del campo
        if campo_grua2 not in row:
            print(f"   - Campo no encontrado, buscando variaciones...")
            for campo in row.index:
                if 'gr√∫a' in campo.lower() and 'obstrucci√≥n' in campo.lower() and '2' in campo and not campo.startswith('comentario:'):
                    print(f"   - Posible variaci√≥n encontrada: '{campo}' = '{row[campo]}'")
        
        tipo_caso_grua2_original = row.get(campo_grua2, '')
        print(f"   - Valor original: '{tipo_caso_grua2_original}'")
        tipo_caso_grua2 = normaliza_texto(tipo_caso_grua2_original)
        print(f"   - Valor normalizado: '{tipo_caso_grua2}'")
        
        # Verificar con diferentes variaciones de may√∫sculas/min√∫sculas
        print(f"   - ¬øContiene 'izaje libre'? {'izaje libre' in tipo_caso_grua2}")
        print(f"   - ¬øContiene 'izaje con obstaculos'? {'izaje con obstaculos' in tipo_caso_grua2}")
        print(f"   - ¬øContiene 'requiere visita del especialista'? {'requiere visita del especialista' in tipo_caso_grua2}")
        
        # Usar comparaci√≥n case-insensitive
        ws_info_b.range('B61').value = 'izaje libre' in tipo_caso_grua2 or 'Izaje libre' in tipo_caso_grua2_original
        ws_info_b.range('J61').value = 'izaje con obstaculos' in tipo_caso_grua2 or 'Izaje con obstaculos' in tipo_caso_grua2_original
        ws_info_b.range('S61').value = 'requiere visita del especialista' in tipo_caso_grua2 or 'Requiere visita del especialista' in tipo_caso_grua2_original
        
        # Verificar que se escribi√≥ correctamente
        print(f"   - Valor en B61: '{ws_info_b.range('B61').value}'")
        print(f"   - Valor en J61: '{ws_info_b.range('J61').value}'")
        print(f"   - Valor en S61: '{ws_info_b.range('S61').value}'")
        
        # Llenar tipo de zona para sitio B
        tipo_zona_original = row.get('Tipo de Zona 2', '')
        tipo_zona = normaliza_texto(tipo_zona_original)
        ws_info_b.range('L21').value = 'urbana' in tipo_zona
        ws_info_b.range('P21').value = 'suburbana' in tipo_zona
        ws_info_b.range('U21').value = 'rural' in tipo_zona
        ws_info_b.range('X21').value = 'ejidal' in tipo_zona
        ws_info_b.range('AB21').value = 'pueblomagico' in tipo_zona
        
        # Llenar visibilidad para sitio B
        tipo_visible_original = row.get('El sitio es visible de d√≠a y de noche (libre de maleza y arboles): 2', '')
        tipo_visible = normaliza_texto(tipo_visible_original)
        ws_info_b.range('P22').value =  'si' in tipo_visible
        ws_info_b.range('S22').value = 'no' in tipo_visible
        
        # Llenar tipo de camino para sitio B
        tipo_camino_original = row.get(' Tipo de Camino 2 ', '')
        tipo_camino = normaliza_texto(tipo_camino_original)
        ws_info_b.range('G23').value = 'terraceria' in tipo_camino
        ws_info_b.range('L23').value = 'pavimentado' in tipo_camino
        ws_info_b.range('Q23').value =  'empedrado' in tipo_camino
        ws_info_b.range('V23').value =  'mixto' in tipo_camino
        
        # ===== INFORMACI√ìN DE TORRE Y SITIO =====
        print("üèóÔ∏è Llenando informaci√≥n de torre y sitio...")
        
        # Propietario/Administrador - SITIO A
        tipo_Propietario_Administrador_original = row.get('Propietario_Administrador', '')
        tipo_Propietario_Administrador = normaliza_texto(tipo_Propietario_Administrador_original)
        ws_info_a.range('K34').value = 'telesite'in tipo_Propietario_Administrador
        ws_info_a.range('P34').value = 'ctwr' in tipo_Propietario_Administrador
        ws_info_a.range('V34').value = 'mtp' in tipo_Propietario_Administrador
        ws_info_a.range('Z34').value = 'intelesites' in tipo_Propietario_Administrador
        ws_info_a.range('AE34').value = 'even' in tipo_Propietario_Administrador
        ws_info_a.range('A35').value = 'atc' in tipo_Propietario_Administrador
        ws_info_a.range('F35').value = 'temm' in tipo_Propietario_Administrador
        ws_info_a.range('K35').value = 'renta tower' in tipo_Propietario_Administrador
        ws_info_a.range('P35').value = 'torrecom' in tipo_Propietario_Administrador
        ws_info_a.range('V35').value = 'uniti' in tipo_Propietario_Administrador
        ws_info_a.range('A36').value = 'tower one' in tipo_Propietario_Administrador
        ws_info_a.range('F36').value = 'iimt' in tipo_Propietario_Administrador
        ws_info_a.range('K36').value = 'servicom' in tipo_Propietario_Administrador
        ws_info_a.range('A37').value = 'canadian tower' in tipo_Propietario_Administrador
        ws_info_a.range('F37').value = 'mx tower' in tipo_Propietario_Administrador
        ws_info_a.range('K37').value = 'cfe' in tipo_Propietario_Administrador

        # Propietario/Administrador - SITIO B
        tipo_Propietario_Administrador_original = row.get('Propietario_Administrador B', '')
        tipo_Propietario_Administrador = normaliza_texto(tipo_Propietario_Administrador_original)
        ws_info_b.range('K34').value = 'telesite'in tipo_Propietario_Administrador
        ws_info_b.range('P34').value = 'ctwr' in tipo_Propietario_Administrador
        ws_info_b.range('V34').value = 'mtp' in tipo_Propietario_Administrador
        ws_info_b.range('Z34').value = 'intelesites' in tipo_Propietario_Administrador
        ws_info_b.range('AE34').value = 'even' in tipo_Propietario_Administrador
        ws_info_b.range('A35').value = 'atc' in tipo_Propietario_Administrador
        ws_info_b.range('F35').value = 'temm' in tipo_Propietario_Administrador
        ws_info_b.range('K35').value = 'renta tower' in tipo_Propietario_Administrador
        ws_info_b.range('P35').value = 'torrecom' in tipo_Propietario_Administrador
        ws_info_b.range('V35').value = 'uniti' in tipo_Propietario_Administrador
        ws_info_b.range('A36').value = 'tower one' in tipo_Propietario_Administrador
        ws_info_b.range('F36').value = 'iimt' in tipo_Propietario_Administrador
        ws_info_b.range('K36').value = 'servicom' in tipo_Propietario_Administrador
        ws_info_b.range('A37').value = 'canadian tower' in tipo_Propietario_Administrador
        ws_info_b.range('F37').value = 'mx tower' in tipo_Propietario_Administrador
        ws_info_b.range('K37').value = 'cfe' in tipo_Propietario_Administrador

        # Tipo de sitio - SITIO A
        tipo_tipositio_original = normaliza_texto(row.get('Tipo de sitio', ''))
        tipo_tipositio = normaliza_texto(tipo_tipositio_original)
        print(f"Tipo de sitio original: '{tipo_tipositio_original}'")
        print(f"Tipo de sitio normalizado: '{tipo_tipositio}'")
        print(f"¬øContiene 'terrenogreenfield'? {'terrenogreenfield' in tipo_tipositio}")
        print(f"¬øContiene 'sobresuelorawland'? {'sobresuelorawland' in tipo_tipositio}")
        ws_info_a.range('D39').value = 'terrenogreenfield' in tipo_tipositio
        ws_info_a.range('M39').value = 'sobresuelorawland' in tipo_tipositio
        ws_info_a.range('U39').value = 'sobreazotea' in tipo_tipositio

        # Tipo de sitio - SITIO B
        tipo_tipositio_original = normaliza_texto(row.get('Tipo de sitio B', ''))
        tipo_tipositio = normaliza_texto(tipo_tipositio_original)
        print(f"Tipo de sitio original: '{tipo_tipositio_original}'")
        print(f"Tipo de sitio normalizado: '{tipo_tipositio}'")
        print(f"¬øContiene 'terrenogreenfield'? {'terrenogreenfield' in tipo_tipositio}")
        print(f"¬øContiene 'sobresuelorawland'? {'sobresuelorawland' in tipo_tipositio}")
        ws_info_b.range('D39').value = 'terrenogreenfield' in tipo_tipositio
        ws_info_b.range('M39').value = 'sobresuelorawland' in tipo_tipositio
        ws_info_b.range('U39').value = 'sobreazotea' in tipo_tipositio

        # Riesgo - SITIO A
        tipo_riesgo_original = normaliza_texto(row.get('Riesgo', ''))
        tipo_riesgo = normaliza_texto(tipo_riesgo_original)
        ws_info_a.range('Y40').value = 'delitocomunroboatranseuntes' in tipo_riesgo
        ws_info_a.range('P41').value = 'inconformidadvecinalconbloqueo' in tipo_riesgo
        ws_info_a.range('AA41').value = 'delincuenciaorganizada' in tipo_riesgo

        # Riesgo - SITIO B
        tipo_riesgo_original = normaliza_texto(row.get('Riesgo B', ''))
        tipo_riesgo = normaliza_texto(tipo_riesgo_original)
        ws_info_b.range('Y40').value = 'delitocomunroboatranseuntes' in tipo_riesgo
        ws_info_b.range('P41').value = 'inconformidadvecinalconbloqueo' in tipo_riesgo
        ws_info_b.range('AA41').value = 'delincuenciaorganizada' in tipo_riesgo

        # Considera accesible - SITIO A
        tipo_considera_accesible_original = normaliza_texto(row.get('Considera accesible el sitio de d√≠a y de noche?', ''))
        tipo_considera_accesible = normaliza_texto(tipo_considera_accesible_original)
        ws_info_a.range('S43').value = 'solodedia' in tipo_considera_accesible
        ws_info_a.range('W43').value = 'solodenoche' in tipo_considera_accesible
        ws_info_a.range('AB43').value = 'sinproblemadehora' in tipo_considera_accesible

        # Considera accesible - SITIO B
        tipo_considera_accesible_original = normaliza_texto(row.get('Considera accesible el sitio de d√≠a y de noche? B', ''))
        tipo_considera_accesible = normaliza_texto(tipo_considera_accesible_original)
        ws_info_b.range('S43').value = 'solodedia' in tipo_considera_accesible
        ws_info_b.range('W43').value = 'solodenoche' in tipo_considera_accesible
        ws_info_b.range('AB43').value = 'sinproblemadehora' in tipo_considera_accesible

        # Zona segura - SITIO A
        tipo_zonasegura_original = (row.get('El sitio se encuentra construido en zona segura (De NO derrumbes):', ''))
        tipo_zonasegura = normaliza_texto(tipo_zonasegura_original)
        ws_info_a.range('S44').value = 'si' in tipo_zonasegura
        ws_info_a.range('W44').value = 'no' in tipo_zonasegura

        # Zona segura - SITIO B
        tipo_zonasegura_original = (row.get('El sitio se encuentra construido en zona segura (De NO derrumbes) B:', ''))
        tipo_zonasegura = normaliza_texto(tipo_zonasegura_original)
        ws_info_b.range('S44').value = 'si' in tipo_zonasegura
        ws_info_b.range('W44').value = 'no' in tipo_zonasegura

        # Horario controlado - SITIO A
        tipo_horariocontrolado_original = normaliza_texto(row.get('Horario Controlado', ''))
        tipo_horariocontrolado = normaliza_texto(tipo_horariocontrolado_original)
        ws_info_a.range('B50').value = 'si' in tipo_horariocontrolado
        ws_info_a.range('F50').value = 'no' in tipo_horariocontrolado

        # Horario controlado - SITIO B
        tipo_horariocontrolado_original = normaliza_texto(row.get('Horario Controlado B', ''))
        tipo_horariocontrolado = normaliza_texto(tipo_horariocontrolado_original)
        ws_info_b.range('B50').value = 'si' in tipo_horariocontrolado
        ws_info_b.range('F50').value = 'no' in tipo_horariocontrolado
        
        # Acceso al Personal - SITIO A
        acceso_personal_original = normaliza_texto(row.get('TIPO DE ACCESO A SITIO', ''))
        acceso_personal = normaliza_texto(acceso_personal_original)

        ws_info_a.range('B47').value = 'llave' in acceso_personal
        ws_info_a.range('H47').value = 'permiso/memorandum' in acceso_personal
        ws_info_a.range('R47').value = 'candadodecombinacion' in acceso_personal
        ws_info_a.range('B48').value = 'tarjetaelectronica' in acceso_personal
        ws_info_a.range('J48').value = 'otro' in acceso_personal

        # Campos vinculados - SITIO A
        if 'candadodecombinacion' in acceso_personal:
            ws_info_a.range('AF47').value = row.get('Candado de Combinaci√≥n', '')
            ws_info_a.range('Q48').value = 'N/A'
        elif ('llave' in acceso_personal or 'permiso/memorandum' in acceso_personal or 'tarjetaelectronica' in acceso_personal):
            ws_info_a.range('Q49').value = row.get('D√≥nde recoger llave/permiso/tarjeta', '')

        # Acceso al Personal - SITIO B
        acceso_personal_original = normaliza_texto(row.get('TIPO DE ACCESO A SITIO B', ''))
        acceso_personal = normaliza_texto(acceso_personal_original)

        ws_info_b.range('B47').value = 'llave' in acceso_personal
        ws_info_b.range('H47').value = 'permiso/memorandum' in acceso_personal
        ws_info_b.range('R47').value = 'candadodecombinacion' in acceso_personal
        ws_info_b.range('B48').value = 'tarjetaelectronica' in acceso_personal
        ws_info_b.range('J48').value = 'otro' in acceso_personal

        # Campos vinculados - SITIO B
        if 'candadodecombinacion' in acceso_personal:
            ws_info_b.range('AF47').value = row.get('Candado de Combinaci√≥n B', '')
            ws_info_b.range('Q48').value = 'N/A'
        elif ('llave' in acceso_personal or 'permiso/memorandum' in acceso_personal or 'tarjetaelectronica' in acceso_personal):
            ws_info_b.range('Q49').value = row.get('D√≥nde recoger llave/permiso/tarjeta B', '')

        # Forma de ingresar equipo - SITIO A
        tipo_formaingresar_original = normaliza_texto(row.get('Forma de ingresar el equipo al sitio es con:', ''))
        tipo_formaingresar = normaliza_texto(tipo_formaingresar_original)
        ws_info_a.range('U55').value = 'maniobra' in tipo_formaingresar
        ws_info_a.range('AA55').value = 'izajecongarrucha' in tipo_formaingresar
        ws_info_a.range('AG55').value = 'izajecongrua' in tipo_formaingresar

        # Forma de ingresar equipo - SITIO B
        tipo_formaingresar_original = normaliza_texto(row.get('Forma de ingresar el equipo al sitio es con: B', ''))
        tipo_formaingresar = normaliza_texto(tipo_formaingresar_original)
        ws_info_b.range('U55').value = 'maniobra' in tipo_formaingresar
        ws_info_b.range('AA55').value = 'izajecongarrucha' in tipo_formaingresar
        ws_info_b.range('AG55').value = 'izajecongrua' in tipo_formaingresar

        # Requerir gr√∫a - SITIO A
        tipo_requerir_grua_original = normaliza_texto(row.get('Para instalaci√≥n de gr√∫a, considera necesario que se requiera tramitar permiso con las autoridades locales:', ''))
        tipo_requerir_grua = normaliza_texto(tipo_requerir_grua_original)
        print(f"tipo_requerir_grua original: '{tipo_requerir_grua_original}'")
        print(f"tipo_requerir_grua normalizado: '{tipo_requerir_grua}'")
        ws_info_a.range('AB67').value = 'requieregrua' in tipo_requerir_grua
        ws_info_a.range('AG67').value = 'noaplicagrua' in tipo_requerir_grua

        # Requerir gr√∫a - SITIO B
        tipo_requerir_grua_original = normaliza_texto(row.get('Para instalaci√≥n de gr√∫a, considera necesario que se requiera tramitar permiso con las autoridades locales: B', ''))
        tipo_requerir_grua = normaliza_texto(tipo_requerir_grua_original)
        print(f"tipo_requerir_grua original: '{tipo_requerir_grua_original}'")
        print(f"tipo_requerir_grua normalizado: '{tipo_requerir_grua}'")
        ws_info_b.range('AB67').value = 'requieregrua' in tipo_requerir_grua
        ws_info_b.range('AG67').value = 'noaplicagrua' in tipo_requerir_grua

        # Requiere gr√∫a - SITIO A
        tipo_requiere_grua_original = normaliza_texto(row.get('Requiere Grua (Si / No)', ''))
        tipo_requiere_grua = normaliza_texto(tipo_requiere_grua_original)
        ws_info_a.range('AC66').value = 'si' in tipo_requiere_grua
        ws_info_a.range('AF66').value = 'no' in tipo_requiere_grua

        # Requiere gr√∫a - SITIO B
        tipo_requiere_grua_original = normaliza_texto(row.get('Requiere Grua (Si / No) B', ''))
        tipo_requiere_grua = normaliza_texto(tipo_requiere_grua_original)
        ws_info_b.range('AC66').value = 'si' in tipo_requiere_grua
        ws_info_b.range('AF66').value = 'no' in tipo_requiere_grua

        # Para llegar al sitio - SITIO A
        tipo_llegar_original = normaliza_texto(row.get('Para la llegada al sitio con el equipo a instalar, se requiere de:', ''))
        # Separa por coma y normaliza solo el primer valor
        primer_valor = tipo_llegar_original.split(',')[0].strip() if ',' in tipo_llegar_original else tipo_llegar_original.strip()
        primer_tipo = normaliza_texto(primer_valor)
        print(f"primer_valor: '{primer_valor}'")
        print(f"primer_tipo normalizado: '{primer_tipo}'")
        ws_info_a.range('B72').value = (primer_tipo == 'pickup')
        ws_info_a.range('G72').value = (primer_tipo == 'pickup4x4')
        ws_info_a.range('M72').value = (primer_tipo == 'animalesdecarga')

        # Para llegar al sitio - SITIO B
        tipo_llegar_original = normaliza_texto(row.get('Para la llegada al sitio con el equipo a instalar, se requiere de: B', ''))
        # Separa por coma y normaliza solo el primer valor
        primer_valor = tipo_llegar_original.split(',')[0].strip() if ',' in tipo_llegar_original else tipo_llegar_original.strip()
        primer_tipo = normaliza_texto(primer_valor)
        print(f"primer_valor: '{primer_valor}'")
        print(f"primer_tipo normalizado: '{primer_tipo}'")
        ws_info_b.range('B72').value = (primer_tipo == 'pickup')
        ws_info_b.range('G72').value = (primer_tipo == 'pickup4x4')
        ws_info_b.range('M72').value = (primer_tipo == 'animalesdecarga')

        # Polic√≠a - SITIO A
        policia_original = normaliza_texto(row.get('Existe cerca del sitio alguna comandancia de polic√≠a o del ejercito?', '').strip().lower())
        ws_info_a.range('AB105').value = 'si' in policia_original
        ws_info_a.range('AE105').value = 'no' in policia_original

        if 'si' in policia_original:
            ws_info_a.range('U106').value = row.get('Si la respuesta anterior es si, Indique a que distancia  policia', 'N/A') 
            ws_info_a.range('U107').value = row.get('Se cuenta con alg√∫n n√∫mero de tel√©fono?, ind√≠quelo', 'N/A') or 'N/A'
        else:
            ws_info_a.range('U106').value = 'N/A'
            ws_info_a.range('U107').value = 'N/A'

        # Cruz Roja, Hospital, asistencia m√©dica - SITIO A
        cruzroja_original = normaliza_texto(row.get('Existe Cruz Roja, Hospital u otro tipo de asistencia medica cerca del sitio.', '').strip().lower())
        ws_info_a.range('AB108').value = 'si' in cruzroja_original
        ws_info_a.range('AE108').value = 'no' in cruzroja_original

        if 'si' in cruzroja_original:
            ws_info_a.range('U109').value = row.get('Si la respuesta anterior es si, Indique a que distancia cruz ', 'N/A')  
            ws_info_a.range('U110').value = row.get('Se cuenta con alg√∫n numero de tel√©fono?, ind√≠quelo: cruz', 'N/A') or 'N/A'
        else:
            ws_info_a.range('U109').value = 'N/A'
            ws_info_a.range('U110').value = 'N/A'

        # Mapa Nacional de Riesgos - SITIO A
        riesgo = normaliza_texto(row.get('Seg√∫n el Mapa Nacional de Riesgos, indique en que zona se ubica el sitio:', '').strip().lower())
        ws_info_a.range('Y111').value = 'bajo' in riesgo
        ws_info_a.range('AB111').value = 'medio' in riesgo
        ws_info_a.range('AE111').value = 'alto' in riesgo

        # Polic√≠a - SITIO B
        policia_original = normaliza_texto(row.get('Existe cerca del sitio alguna comandancia de polic√≠a o del ejercito? B', ''))
        ws_info_b.range('AB105').value = 'si' in policia_original
        ws_info_b.range('AE105').value = 'no' in policia_original

        if 'si' in policia_original:
            ws_info_b.range('U106').value = row.get('Si la respuesta anterior es si, Indique a que distancia  policia B', 'N/A') 
            ws_info_b.range('U107').value = row.get('Se cuenta con alg√∫n numero de tel√©fono?, ind√≠quelo: B', 'N/A') or 'N/A'
        else:
            ws_info_b.range('U106').value = 'N/A'
            ws_info_b.range('U107').value = 'N/A'

        # Cruz Roja, Hospital, asistencia m√©dica - SITIO B
        cruzroja_original = normaliza_texto(row.get('Existe Cruz Roja, Hospital u otro tipo de asistencia medica cerca del sitio. B', ''))
        ws_info_b.range('AB108').value = 'si' in cruzroja_original
        ws_info_b.range('AE108').value = 'no' in cruzroja_original

        if 'si' in cruzroja_original:
            ws_info_b.range('U109').value = row.get('Si la respuesta anterior es si, Indique a que distancia cruz B', 'N/A')  
            ws_info_b.range('U110').value = row.get('Se cuenta con alg√∫n numero de tel√©fono?, ind√≠quelo: cruz B', 'N/A') or 'N/A'
        else:
            ws_info_b.range('U109').value = 'N/A'
            ws_info_b.range('U110').value = 'N/A'

        # Mapa Nacional de Riesgos - SITIO B
        riesgo = normaliza_texto(row.get('Seg√∫n el Mapa Nacional de Riesgos, indique en que zona se ubica el sitio: B', ''))
        ws_info_b.range('Y111').value = 'bajo' in riesgo
        ws_info_b.range('AB111').value = 'medio' in riesgo
        ws_info_b.range('AE111').value = 'alto' in riesgo

        # Alimentaci√≥n compatible
        alimentacion = normaliza_texto(row.get('Alimentacion compatible con el equipamiento ', ''))
        print(f"üîç Alimentaci√≥n: '{alimentacion}' (original: '{row.get('Alimentacion compatible con el equipamiento ', '')}')")
        ws_info_a.range('Y25').value = 'si' in alimentacion
        ws_info_a.range('AB25').value = 'no' in alimentacion
        print(f"üîç Checkboxes alimentaci√≥n: Y25={('si' in alimentacion)}, AB25={('no' in alimentacion)}")
        
        # Sistema el√©ctrico - MOVIDO A HOJA 3 (Espacios en Torre)
        sistema_electrico = normaliza_texto(row.get('SISTEMA ELECTRICO', ''))
        print(f"üîç Sistema el√©ctrico: '{sistema_electrico}' (original: '{row.get('SISTEMA ELECTRICO', '')}')")
        # NOTA: Estos checkboxes se llenar√°n en la hoja 3 m√°s adelante
        
        # ===== INFORMACI√ìN T√âCNICA =====
        print("üîß Llenando informaci√≥n t√©cnica...")
        
        # Cara propuesta - MOVIDO A HOJA 3 (Espacios en Torre)
        cara_propuesta = normaliza_texto(row.get('Cara de preparaci√≥n para cableado vertical en torre', ''))
        print(f"üîç Cara propuesta: '{cara_propuesta}' (original: '{row.get('Cara de preparaci√≥n para cableado vertical en torre', '')}')")
        # NOTA: Estos checkboxes se llenar√°n en la hoja 3 m√°s adelante
        
        # Barra de tierra
        barra_tierra = normaliza_texto(row.get('Barra de Tierra', ''))
        print(f"üîç Barra de tierra: '{barra_tierra}' (original: '{row.get('Barra de Tierra', '')}')")
        ws_info_a.range('O27').value = 'si' in barra_tierra
        ws_info_a.range('R27').value = 'no' in barra_tierra
        print(f"üîç Checkboxes barra tierra: O27={('si' in barra_tierra)}, R27={('no' in barra_tierra)}")
        
        # Tipo de soluci√≥n
        tipo_solucion = normaliza_texto(row.get('Tipo de soluci√≥n', ''))
        print(f"üîç Tipo de soluci√≥n: '{tipo_solucion}' (original: '{row.get('Tipo de soluci√≥n', '')}')")
        ws_info_a.range('O29').value = 'piso' in tipo_solucion
        ws_info_a.range('R29').value = 'torre' in tipo_solucion
        print(f"üîç Checkboxes tipo soluci√≥n: O29={('piso' in tipo_solucion)}, R29={('torre' in tipo_solucion)}")
        
        # ===== CAMPOS DE TEXTO IMPORTANTES =====
        print("üìù Llenando campos de texto...")
        
        # Informaci√≥n b√°sica del sitio
        comentario_grua = row.get('comentario:En caso de requerirse gr√∫a, identifique si es factible el uso de la misma y que no se tenga una posible obstrucci√≥n.', 'N/A')
        print(f"üîç Comentario gr√∫a: '{comentario_grua}'")
        ws_info_a.range('B63').value = comentario_grua
        
        # Coordenadas y ubicaci√≥n
        latitud = row.get('LATITUD (TORRE)', 'N/A')
        longitud = row.get('LONGITUD (TORRE)', 'N/A')
        altitud = row.get('Altitud (msnm)', 'N/A')
        print(f"üîç Coordenadas: Lat={latitud}, Lon={longitud}, Alt={altitud}")
        ws_info_a.range('B15').value = latitud
        ws_info_a.range('F15').value = longitud
        ws_info_a.range('J15').value = altitud
        
        # Informaci√≥n de contacto
        contacto = row.get('Nombre de contacto en sitio', 'N/A')
        telefono = row.get('Telefono', 'N/A')
        print(f"üîç Contacto: '{contacto}', Tel√©fono: '{telefono}'")
        ws_info_a.range('B17').value = contacto
        ws_info_a.range('F17').value = telefono
        
        # Direcci√≥n
        calle = row.get('Calle', 'N/A')
        colonia = row.get('Colonia', 'N/A')
        municipio = row.get('Municipio', 'N/A')
        cp = row.get('C.P', 'N/A')
        print(f"üîç Direcci√≥n: Calle='{calle}', Colonia='{colonia}', Municipio='{municipio}', CP='{cp}'")
        ws_info_a.range('B19').value = calle
        ws_info_a.range('F19').value = colonia
        ws_info_a.range('J19').value = municipio
        ws_info_a.range('N19').value = cp
        
        print("‚úÖ INFORMACI√ìN B√ÅSICA COMPLETADA")
        
        # ===== LLENADO COMPLETO DE HOJA 3: ESPACIOS EN TORRE Y PISO =====
        print("üèóÔ∏è Llenando HOJA 3: Espacios en Torre y Piso A-B...")
        
        # Informaci√≥n del sitio principal
        ws_info_c.range('G7').value = row.get('NOMBRE DEL SITIO', 'N/A')
        ws_info_c.range('K9').value = row.get('Diametro de pierna superior', 'N/A')
        ws_info_c.range('U9').value = row.get('Diametro de pierna Inferior', 'N/A')
        ws_info_c.range('AC9').value = row.get('NCRA RB', 'N/A')
        ws_info_c.range('AM9').value = row.get('Franja2RB', 'N/A')
        ws_info_c.range('K10').value = row.get('Altura de la Torre', 'N/A')
        ws_info_c.range('U10').value = row.get('Dado', 'N/A')
        ws_info_c.range('AE10').value = row.get('Altura Edificio1', 'N/A')
        ws_info_c.range('T11').value = row.get('Nivel inferior de franja disponible', 'N/A')
        ws_info_c.range('AK11').value = row.get('Nivel superior de franja disponible', 'N/A')
        ws_info_c.range('B14').value = row.get('Altura de MW conforme a topologia', 'N/A')
        ws_info_c.range('M14').value = row.get('Azimut RB ', 'N/A')
        ws_info_c.range('AB14').value = row.get('Propuesta de altura de antena de MW1', 'N/A')
        ws_info_c.range('AJ14').value = row.get('Propuesta de altura de antena de MW (SD)1', 'N/A')
        ws_info_c.range('O19').value = row.get('Altura de soporte para OMB propuesto', 'N/A')
        ws_info_c.range('O20').value = row.get('Longitud del cable de tierra nuevo OMB', 'N/A')
        ws_info_c.range('O21').value = row.get('Longitud del cable de tierra ODU', 'N/A')
        ws_info_c.range('O22').value = row.get('Longitud de cable IF', 'N/A')
        ws_info_c.range('O23').value = row.get('Tipo de soporte para antena MW propuesto', 'N/A')
        ws_info_c.range('O24').value = row.get('Longitud de cable ACDB-Nuevo OMB', 'N/A')
        ws_info_c.range('O25').value = row.get('Longitud de cable RTN - Router', 'N/A')
        ws_info_c.range('O26').value = row.get('Longitud de cable RTN - BBU SITE 1', 'N/A')
        ws_info_c.range('O28').value = row.get('MEDICION DE BARRA DE TIERRA (Ohms)', 'N/A')
        
        # Informaci√≥n del sitio secundario
        ws_info_c.range('G31').value = row.get('Nombre del sitio 2', 'N/A')
        ws_info_c.range('K33').value = row.get('Di√°metro de Pierna superio2', 'N/A')
        ws_info_c.range('U33').value = row.get('Di√°metro de Pierna inferior2', 'N/A')
        ws_info_c.range('AC33').value = row.get(' NCRA2 ', 'N/A')
        ws_info_c.range('AM33').value = row.get('Franja2-2', 'N/A')
        ws_info_c.range('K34').value = row.get('Altura torre 2', 'N/A')
        ws_info_c.range('U34').value = row.get('DADO 2', 'N/A')
        ws_info_c.range('AE34').value = row.get('Altura edificio 2', 'N/A')
        ws_info_c.range('T35').value = row.get('Nivel inferior de franja disponible 2', 'N/A')
        ws_info_c.range('K35').value = row.get('Nivel superior de franja disponible 2', 'N/A')
        ws_info_c.range('B38').value = row.get('Altura de MW conforme a topologia 2', 'N/A')
        ws_info_c.range('M38').value = row.get('Azimut 2', 'N/A')
        ws_info_c.range('AB38').value = row.get('Propuesta de altura de antena de MW2', 'N/A')
        ws_info_c.range('AJ38').value = row.get('Propuesta de altura de antena de MW (SD)2', 'N/A')
        ws_info_c.range('O43').value = row.get('Altura de soporte para OMB propuesto2', 'N/A')
        ws_info_c.range('O44').value = row.get('Longitud del cable de tierra nuevo OMB 2', 'N/A')
        ws_info_c.range('O45').value = row.get('Longitud del cable de tierra ODU 2', 'N/A')
        ws_info_c.range('O46').value = row.get('Longitud de cable IF 2', 'N/A')
        ws_info_c.range('O47').value = row.get('Tipo de soporte para antena MW propuesto 2', 'N/A')
        ws_info_c.range('O48').value = row.get('Longitud de cable ACDB-Nuevo OMB 2', 'N/A')
        ws_info_c.range('O49').value = row.get('Longitud de cable RTN - Router 2', 'N/A')
        ws_info_c.range('O50').value = row.get('Longitud de cable RTN - BBU 2', 'N/A')
        ws_info_c.range('O52').value = row.get('Medici√≥n del Sistema de Tierras 2', 'N/A')
        
        # ===== CHECKBOXES T√âCNICOS EN HOJA 3 =====
        print("üîß Llenando checkboxes t√©cnicos en hoja 3...")
        
        # Sistema el√©ctrico - CORREGIDO: Ahora en hoja 3
        ws_info_c.range('AG21').value = 'monofasica' in sistema_electrico
        ws_info_c.range('AL21').value = 'bifasica' in sistema_electrico
        print(f"üîç Checkboxes sistema el√©ctrico (hoja 3): AG21={('monofasica' in sistema_electrico)}, AL21={('bifasica' in sistema_electrico)}")
        
        # Cara propuesta - CORREGIDO: Ahora en hoja 3
        ws_info_c.range('Y16').value = 'a' in cara_propuesta
        ws_info_c.range('AC16').value = 'b' in cara_propuesta
        ws_info_c.range('AE16').value = 'c' in cara_propuesta
        ws_info_c.range('AN16').value = 'd' in cara_propuesta
        print(f"üîç Checkboxes cara propuesta (hoja 3): Y16={('a' in cara_propuesta)}, AC16={('b' in cara_propuesta)}, AE16={('c' in cara_propuesta)}, AN16={('d' in cara_propuesta)}")
        
        print("‚úÖ HOJA 3: Espacios en Torre y Piso completada")
        
        # ===== INFORMACI√ìN T√âCNICA ADICIONAL - HOJA 3 =====
        print("üîß Llenando informaci√≥n t√©cnica adicional...")
        
        # Tipo de torre 2 - SITIO B
        tipo_torre2 = normaliza_texto(row.get('Tipo de Torre2', ''))
        ws_info_c.range('G32').value = tipo_torre2 == 'autosoportada'
        ws_info_c.range('O32').value = tipo_torre2 == 'arriostrada'
        ws_info_c.range('V32').value = tipo_torre2 == 'monopolo'
        ws_info_c.range('AB32').value = tipo_torre2 == 'minipolo'
        ws_info_c.range('AG32').value = tipo_torre2 == 'otro'

        # Espacio disponible de conexi√≥n 2 - SITIO B
        espacio_disponible2 = normaliza_texto(row.get('¬øEspacio disponible de conexi√≥n?2', ''))
        ws_info_c.range('U38').value = espacio_disponible2 == 'si'
        ws_info_c.range('Y38').value = espacio_disponible2 == 'no'

        # Cara de preparaci√≥n 2 - SITIO B
        cara_preparacion2 = normaliza_texto(row.get('Cara de preparaci√≥n para cableado vertical en torre 2', ''))
        ws_info_c.range('Y40').value = cara_preparacion2 == 'a'
        ws_info_c.range('AD40').value = cara_preparacion2 == 'b'
        ws_info_c.range('AI40').value = cara_preparacion2 == 'c'
        ws_info_c.range('AN40').value = cara_preparacion2 == 'd'
        
        # Existe tierra 2 - SITIO B
        existe_tierra2 = normaliza_texto(row.get('Existe Barra de Tierras 2', ''))
        ws_info_c.range('O51').value = existe_tierra2 == 'si'
        ws_info_c.range('R51').value = existe_tierra2 == 'no'

        # Tipo de soluci√≥n 2 - SITIO B
        tipo_solucion2 = normaliza_texto(row.get('Tipo de solucion 2', ''))
        ws_info_c.range('O53').value = tipo_solucion2 == 'piso'
        ws_info_c.range('R53').value = tipo_solucion2 == 'torre'
        
        # Existe breaker 2 - SITIO B
        existe_break2 = normaliza_texto(row.get('Existe algun breaker existente en sitio 2 ', ''))
        ws_info_c.range('Y45').value = existe_break2 == 'si'
        ws_info_c.range('AB45').value = existe_break2 == 'no'

        # Alimentaci√≥n existente 2 - SITIO B
        alimenacion_existente2= normaliza_texto(row.get('SISTEMA ELECTRICO 2', ''))
        ws_info_c.range('AG45').value = 'monofasica' in alimenacion_existente2
        ws_info_c.range('AL45').value = 'bifasica' in alimenacion_existente2
        
        # Alimentaci√≥n compatible 2 - SITIO B
        alimenacion_compatible2= normaliza_texto(row.get('Alimentacion compatible con el equipamiento 2', ''))
        ws_info_c.range('Y49').value = alimenacion_compatible2 == 'si'
        ws_info_c.range('AB49').value = alimenacion_compatible2 == 'no'

        # Espacio de conexi√≥n 2 - SITIO B
        espacio_conexion2= normaliza_texto(row.get('¬øEspacio disponible de conexi√≥n? 2', ''))
        ws_info_c.range('AH49').value = espacio_conexion2 == 'si'
        ws_info_c.range('AK49').value = espacio_conexion2 == 'no'

        # L√≠nea de vista
        linea_vista = normaliza_texto(row.get('Linea de vista ', ''))
        motivo = normaliza_texto(row.get('Motivo ', ''))

        ws_info_c.range('R56').value = (linea_vista == 'si')
        ws_info_c.range('V56').value = (linea_vista == 'no')
        ws_info_c.range('Q57').value = False
        ws_info_c.range('V57').value = False
        ws_info_c.range('AC57').value = False
        ws_info_c.range('AI57').value = False
        ws_info_c.range('C58').value = False

        if linea_vista == 'no':
           if motivo == 'arboles':
              ws_info_c.range('Q57').value = True
           elif motivo == 'espectacular':
              ws_info_c.range('V57').value = True
           elif motivo == 'edificio':
              ws_info_c.range('AC57').value = True
           elif motivo == 'monta√±a':
              ws_info_c.range('AI57').value = True
           elif motivo == 'n/a':
              ws_info_c.range('C58').value = True

        print("‚úÖ INFORMACI√ìN T√âCNICA ADICIONAL COMPLETADA")
        
        # ===== LLENADO COMPLETO DE HOJA 4: PLANOS A =====
        print("üìê Llenando HOJA 4: Planos A...")
        
        # Informaci√≥n de planos del sitio A
        ws_info_d.range('B15').value = row.get('PLANOS', 'N/A')
        ws_info_d.range('F15').value = row.get('Tipo de Torre', 'N/A')
        ws_info_d.range('J15').value = row.get('Altura de la Torre', 'N/A')
        ws_info_d.range('N15').value = row.get('Dado', 'N/A')
        ws_info_d.range('R15').value = row.get('PROPIETARIO', 'N/A')
        ws_info_d.range('V15').value = row.get('TIPO DE SITIO ', 'N/A')
        
        # Informaci√≥n de acceso y permisos
        ws_info_d.range('B20').value = row.get('Como o donde obtener permisos/llave/tarjeta', 'N/A')
        ws_info_d.range('F20').value = row.get('Contacto solicitud de accesos', 'N/A')
        ws_info_d.range('J20').value = row.get('Horario de solicitud de accesos', 'N/A')
        
        # Informaci√≥n de gr√∫a
        ws_info_d.range('B25').value = row.get('Requiere Grua (Si / No)', 'N/A')
        ws_info_d.range('F25').value = row.get('Para la llegada al sitio con el equipo a instalar, se requiere de:', 'N/A')
        ws_info_d.range('J25').value = row.get('Si la respuesta anterior es si, Indique a que distancia ', 'N/A')
        
        # Informaci√≥n de seguridad
        ws_info_d.range('B30').value = row.get('Existe cerca del sitio alguna comandancia de polic√≠a o del ejercito?', 'N/A')
        ws_info_d.range('F30').value = row.get('Si la respuesta anterior es si, Indique a que distancia  policia', 'N/A')
        ws_info_d.range('J30').value = row.get('Se cuenta con alg√∫n numero de tel√©fono?, ind√≠quelo: ', 'N/A')
        
        # Informaci√≥n m√©dica
        ws_info_d.range('B35').value = row.get('Existe Cruz Roja, Hospital u otro tipo de asistencia medica cerca del sitio.', 'N/A')
        ws_info_d.range('F35').value = row.get('Si la respuesta anterior es si, Indique a que distancia cruz ', 'N/A')
        ws_info_d.range('J35').value = row.get('Se cuenta con alg√∫n numero de tel√©fono?, ind√≠quelo: cruz', 'N/A')
        
        # Informaci√≥n de riesgos
        ws_info_d.range('B40').value = row.get('Seg√∫n el Mapa Nacional de Riesgos, indique en que zona se ubica el sitio:', 'N/A')
        
        print("‚úÖ HOJA 4: Planos A completada")
        
        # ===== LLENADO COMPLETO DE HOJA 5: PLANOS B =====
        print("üìê Llenando HOJA 5: Planos B...")
        
        # Informaci√≥n de planos del sitio B (similar a A pero con campos B)
        ws_info_e.range('B15').value = row.get('PLANOS', 'N/A')
        ws_info_e.range('F15').value = row.get('Tipo de Torre2', 'N/A')
        ws_info_e.range('J15').value = row.get('Altura torre 2', 'N/A')
        ws_info_e.range('N15').value = row.get('DADO 2', 'N/A')
        ws_info_e.range('R15').value = row.get('PROPIETARIO 2', 'N/A')
        ws_info_e.range('V15').value = row.get('TIPO DE SITIO 2', 'N/A')
        
        # Informaci√≥n de acceso y permisos B
        ws_info_e.range('B20').value = row.get('Como o donde obtener permisos/llave/tarjeta B', 'N/A')
        ws_info_e.range('F20').value = row.get('Contacto solicitud de accesos B', 'N/A')
        ws_info_e.range('J20').value = row.get('Horario de solicitud de accesos B', 'N/A')
        
        # Informaci√≥n de gr√∫a B
        ws_info_e.range('B25').value = row.get('Requiere Grua (Si / No) B', 'N/A')
        ws_info_e.range('F25').value = row.get('Para la llegada al sitio con el equipo a instalar, se requiere de: B', 'N/A')
        ws_info_e.range('J25').value = row.get('Si la respuesta anterior es si, Indique a que distancia  B', 'N/A')
        
        # Informaci√≥n de seguridad B
        ws_info_e.range('B30').value = row.get('Existe cerca del sitio alguna comandancia de polic√≠a o del ejercito? B', 'N/A')
        ws_info_e.range('F30').value = row.get('Si la respuesta anterior es si, Indique a que distancia  policia B', 'N/A')
        ws_info_e.range('J30').value = row.get('Se cuenta con alg√∫n numero de tel√©fono?, ind√≠quelo: B', 'N/A')
        
        # Informaci√≥n m√©dica B
        ws_info_e.range('B35').value = row.get('Existe Cruz Roja, Hospital u otro tipo de asistencia medica cerca del sitio. B', 'N/A')
        ws_info_e.range('F35').value = row.get('Si la respuesta anterior es si, Indique a que distancia cruz B', 'N/A')
        ws_info_e.range('J35').value = row.get('Se cuenta con alg√∫n numero de tel√©fono?, ind√≠quelo: cruz B', 'N/A')
        
        # Informaci√≥n de riesgos B
        ws_info_e.range('B40').value = row.get('Seg√∫n el Mapa Nacional de Riesgos, indique en que zona se ubica el sitio: B', 'N/A')
        
        print("‚úÖ HOJA 5: Planos B completada")
        
        # ===== LLENADO COMPLETO DE HOJA 6: REPORTE FOTOS A =====
        print("üì∏ Llenando HOJA 6: Reporte Fotos A...")
        
        # Informaci√≥n de fotos del sitio A
        ws_info_f.range('B15').value = row.get('NOMBRE DEL SITIO', 'N/A')
        ws_info_f.range('F15').value = row.get('ID', 'N/A')
        ws_info_f.range('J15').value = row.get('ESTADO ', 'N/A')
        ws_info_f.range('N15').value = row.get('CLUSTER', 'N/A')
        ws_info_f.range('R15').value = row.get('Fecha Site Survey', 'N/A')
        
        # Informaci√≥n de l√≠nea de vista
        ws_info_f.range('B25').value = row.get('Linea de vista ', 'N/A')
        ws_info_f.range('F25').value = row.get('Motivo ', 'N/A')
        
        # Informaci√≥n de enlaces
        ws_info_f.range('B30').value = row.get('Nombres Enlaces ', 'N/A')
        ws_info_f.range('F30').value = row.get('Fecha Inicio Site Survey', 'N/A')
        ws_info_f.range('J30').value = row.get('Fecha final Site Survey', 'N/A')
        
        print("‚úÖ HOJA 6: Reporte Fotos A completada")
        
        # ===== LLENADO COMPLETO DE HOJA 7: REPORTE FOTOS B =====
        print("üì∏ Llenando HOJA 7: Reporte Fotos B...")
        
        # Informaci√≥n de fotos del sitio B
        ws_info_g.range('B15').value = row.get('Nombre del sitio 2', 'N/A')
        ws_info_g.range('F15').value = row.get('ID 2', 'N/A')
        ws_info_g.range('J15').value = row.get('ESTADO 2 ', 'N/A')
        ws_info_g.range('N15').value = row.get('CLUSTER', 'N/A')
        ws_info_g.range('R15').value = row.get('Fecha Inicio Site Survey B', 'N/A')
        
        # Informaci√≥n de l√≠nea de vista B
        ws_info_g.range('B25').value = row.get('Linea de vista ', 'N/A')
        ws_info_g.range('F25').value = row.get('Motivo ', 'N/A')
        
        # Informaci√≥n de enlaces B
        ws_info_g.range('B30').value = row.get('Nombres Enlaces ', 'N/A')
        ws_info_g.range('F25').value = row.get('Fecha Inicio Site Survey B', 'N/A')
        ws_info_g.range('J30').value = row.get('Fecha final Site Survey B', 'N/A')
        
        print("‚úÖ HOJA 7: Reporte Fotos B completada")
        
        # ===== LLENADO DE INFORMACI√ìN T√âCNICA ADICIONAL =====
        print("üîß Llenando informaci√≥n t√©cnica adicional...")
        
        # Informaci√≥n de enlaces y configuraci√≥n
        ws_caratula.range('B45').value = row.get('Margen de desvanecimiento ', 'N/A')
        ws_caratula.range('F45').value = row.get('Disponibilidad anual (%) ', 'N/A')
        ws_caratula.range('J45').value = row.get('Tama√±o de la antena (m)', 'N/A')
        ws_caratula.range('N45').value = row.get('Potencia de Transmisi√≥n (dBm)', 'N/A')
        ws_caratula.range('R45').value = row.get('Potencia de Recepci√≥n (dBm)', 'N/A')
        ws_caratula.range('V45').value = row.get('Banda', 'N/A')
        ws_caratula.range('Z45').value = row.get('Frecuencia (MHz)', 'N/A')
        
        # Informaci√≥n de canales
        ws_caratula.range('B47').value = row.get('#1 Canal ID S1', 'N/A')
        ws_caratula.range('F47').value = row.get('#1 Frecuencia de Dise√±o S1', 'N/A')
        ws_caratula.range('J47').value = row.get('#2 Frecuencia de Dise√±o S1', 'N/A')
        ws_caratula.range('N47').value = row.get('#1 Canal ID S2', 'N/A')
        
        # Informaci√≥n adicional de canales
        ws_caratula.range('R47').value = row.get('#1 Frecuencia de Dise√±o S2', 'N/A')
        ws_caratula.range('V47').value = row.get('#2 Frecuencia de Dise√±o S2', 'N/A')
        ws_caratula.range('Z47').value = row.get('Ancho de Banda (MHz)', 'N/A')
        
        print("‚úÖ INFORMACI√ìN T√âCNICA ADICIONAL COMPLETADA")
        
        # ===== LLENADO DE CAMPOS AUTOM√ÅTICOS (USANDO LA L√ìGICA DE APP2.PY) =====
        print("üîÑ Llenando campos autom√°ticos usando la l√≥gica de app2.py...")
        
        # Llenado autom√°tico de celdas usando el diccionario de mapeo (EXACTO COMO APP2.PY)
        campos_a_celdas = {
            'Fecha Inicio Site Survey': 'G8',
            'Fecha final Site Survey': 'AF8',
            'NOMBRE DEL SITIO': 'J9', 
            'PROPIETARIO': 'M10',
            'ID': 'AF9',
            'ESTADO ':'AC15',
            'Calle': 'D14',
            'Colonia': 'D15',
            'Municipio': 'E16',
            'C.P': 'AC14',
            'Referencias':'J17',
            'Nombre de contacto en sitio': 'H19',
            'Telefono': 'AB19',
            'LATITUD (TORRE)': 'K30',
            'LONGITUD (TORRE)': 'AA30',
            'LATITUD (FACHADA)': 'K27',
            'LONGITUD (FACHADA)': 'AA27',
            'Altitud (msnm)': 'M31',
            'Horario de solicitud de accesos': 'Q50',
            'Contacto solicitud de accesos': 'B52',
            'Como o donde obtener permisos/llave/tarjeta': 'O49',
            'Comentario:Forma de ingresar el equipo al sitio es con:': 'B57',
            'comentario:En caso de requerirse gr√∫a, identifique si es factible el uso de la misma y que no se tenga una posible obstrucci√≥n.': 'B63',
            'Si la respuesta anterior es si, Indique a que distancia ':'AD72'
        }
        
        print("üìù Llenando HOJA 1 (Informaci√≥n General A)...")
        for campo, celdas in campos_a_celdas.items():
            valor_raw = row.get(campo, "")
            valor = normaliza_na(valor_raw)
            print(f"  üîç Campo: '{campo}' -> Celda: {celdas} -> Valor: '{valor}'")
            if isinstance(celdas, list):
                for celda in celdas:
                    ws_info_a.range(celda).value = valor
            else:
                ws_info_a.range(celdas).value = valor
        print("‚úÖ HOJA 1 completada")

        campos_b_celdas = {
            'Fecha Inicio Site Survey B': 'G8',
            'Fecha final Site Survey B': 'AF8',
            'Nombre del sitio 2': 'J9', 
            'PROPIETARIO 2': 'M10',
            'ID 2': 'AF9',
            'ESTADO 2 ':'AC15',
            'Calle 2': 'D14',
            'Colonia 2': 'D15',
            'Municipio 2': 'E16',
            'C.P 2': 'AC14',
            'Referencias 2':'J17',
            'Nombre de contacto en sitio 2': 'H19',
            'Telefono 2': 'AB19',
            'LATITUD (TORRE) 2': 'K30',
            'LONGITUD (TORRE) 2': 'AA30',
            'LATITUD (FACHADA) 2': 'K27',
            'LONGITUD (FACHADA) 2': 'AA27',
            'Altitud (msnm) 2': 'M31',
            'Horario de solicitud de accesos B': 'Q50',
            'Contacto solicitud de accesos B': 'B52',
            'Como o donde obtener permisos/llave/tarjeta B': 'O49',
            'Comentario:Forma de ingresar el equipo al sitio es con: B': 'B57',
            'comentario:En caso de requerirse gr√∫a, identifique si es factible el uso de la misma y que no se tenga una posible obstrucci√≥n.': 'B63',
            'Si la respuesta anterior es si, Indique a que distancia B':'AD72',
            # Campos adicionales cr√≠ticos para Hoja 2
            'Referencias 2': 'K16',
            'LATITUD (TORRE) 2': 'L29',
            'LONGITUD (TORRE) 2': 'AB29',
            'LATITUD (FACHADA) 2': 'L26',
            'LONGITUD (FACHADA) 2': 'AB26',
            'Altitud (msnm) 2': 'N30',
            'Nombre de contacto en sitio 2': 'I18',
            'Telefono 2': 'AC18',
            'PROPIETARIO 2': 'N9',
            'ESTADO 2 ': 'AD14'
        }
        for campo, celdas in campos_b_celdas.items():
            valor_raw = row.get(campo, "")
            valor = normaliza_na(valor_raw)
            print(f"üîç HOJA 2 - Campo: '{campo}' -> Celda: {celdas} -> Valor: '{valor}' (original: '{valor_raw}')")
            
            # Verificar si el campo existe en el DataFrame
            if campo in row.index:
                print(f"  ‚úÖ Campo encontrado en DataFrame")
            else:
                print(f"  ‚ùå Campo NO encontrado en DataFrame - buscando variaciones...")
                # Buscar variaciones del nombre del campo
                for campo_df in row.index:
                    if campo.lower() in campo_df.lower() or campo_df.lower() in campo.lower():
                        print(f"    üîç Posible variaci√≥n: '{campo_df}' = '{row.get(campo_df, 'N/A')}'")
            
            if isinstance(celdas, list):
                for celda in celdas:
                    ws_info_b.range(celda).value = valor
                    print(f"  ‚úÖ Escrito en {celda}: {valor}")
            else:
                ws_info_b.range(celdas).value = valor
                print(f"  ‚úÖ Escrito en {celdas}: {valor}")
        
        print("‚úÖ HOJA 2 completada")

        campos_c_celdas = {
        'NOMBRE DEL SITIO': 'G7',
        'Diametro de pierna superior':'K9',
        'Diametro de pierna Inferior':'U9',
        'NCRA RB':'AC9',
        'Franja2RB':'AM9',
        'Altura de la Torre':'K10',
        'Dado':'U10',
        'Altura Edificio1':'AE10',
        'Nivel inferior de franja disponible': 'T11',
        'Nivel superior de franja disponible': 'AK11',
        'Altura de MW conforme a topologia': 'B14',
        'Azimut RB ': 'M14',
        'Propuesta de altura de antena de MW1': 'AB14',
        'Propuesta de altura de antena de MW (SD)1': 'AJ14',
        'Altura de soporte para OMB propuesto': 'O19',
        'Longitud del cable de tierra nuevo OMB': 'O20',
        'Longitud del cable de tierra ODU': 'O21',
        'Longitud de cable IF': 'O22',
        'Tipo de soporte para antena MW propuesto': 'O23',
        'Longitud de cable ACDB-Nuevo OMB': 'O24',
        'Longitud de cable RTN - Router':'O25',
        'Longitud de cable RTN - BBU SITE 1': 'O26',
        'MEDICION DE BARRA DE TIERRA (Ohms)':'O28',
        'Nombre del sitio 2': 'G31',
        'Di√°metro de Pierna superio2':'K33',
        'Di√°metro de Pierna inferior2':'U33',
        ' NCRA2 ':'AC33',
        'Franja2-2':'AM33',
        'Altura torre 2': 'K34',
        'DADO 2':'U34',
        'Altura edificio 2':'AE34',
        'Nivel inferior de franja disponible 2': 'T35',
        'Nivel superior de franja disponible 2': 'AK35',
        'Altura de MW conforme a topologia 2': 'B38',
        'Azimut 2': 'M38',
        'Propuesta de altura de antena de MW2': 'AB38',
        'Propuesta de altura de antena de MW (SD)2':'AJ38',
        'Altura de soporte para OMB propuesto2':'O43',
        'Longitud del cable de tierra nuevo OMB 2': 'O44',
        'Longitud del cable de tierra ODU 2': 'O45',
        'Longitud de cable IF 2': 'O46',
        'Tipo de soporte para antena MW propuesto 2': 'O47',
        'Longitud de cable ACDB-Nuevo OMB 2': 'O48',
        'Longitud de cable RTN - Router 2': 'O49',
        'Longitud de cable RTN - BBU 2': 'O50',
        'Medici√≥n del Sistema de Tierras 2': 'O52',
        }
        for campo, celdas in campos_c_celdas.items():
            valor_raw = row.get(campo, "")
            valor = normaliza_na(valor_raw)
            print(f"ws_info_c: Escribiendo en {celdas} el valor '{valor}' para campo '{campo}' (original: {valor_raw}, tipo: {type(valor_raw)})")
            if isinstance(celdas, list):
                for celda in celdas:
                    ws_info_c.range(celda).value = valor
            else:
                ws_info_c.range(celdas).value = valor   

        print("‚úÖ LLENADO COMPLETO DEL ARCHIVO PTP FINALIZADO")
        
        # Guardar y cerrar
        wb.save(output_path)
        wb.close()
        app_excel.quit()
        
        print("üéâ ARCHIVO PTP GENERADO EXITOSAMENTE!")
        return True
        
    except Exception as e:
        print(f"‚ùå ERROR en llenar_archivo_ptp_optimizado: {e}")
        import traceback
        print(f"üîç Traceback completo: {traceback.format_exc()}")
        
        # Intentar cerrar Excel si est√° abierto
        try:
            if 'wb' in locals():
                wb.close()
            if 'app_excel' in locals():
                app_excel.quit()
        except:
            pass
        
        return False

def site_survey_generator(user_id, fila_idx, tipo_documento):
    """
    Genera Y LLENA un archivo de Site Survey autom√°ticamente
    """
    try:
        print(f"üöÄ Generando Y LLENANDO Site Survey autom√°ticamente para {user_id}...")
        
        # Validar entrada
        if not user_id:
            return False
        
        # FORZAR ACTUALIZACI√ìN DEL CACHE para asegurar datos frescos
        print(f"üîÑ Forzando actualizaci√≥n del cache para ID: {user_id}")
        
        global data_cache
        
        print(f"üîç Tipo de data_cache: {type(data_cache)}")
        print(f"üîç Contenido del cache antes de limpiar: {data_cache}")
        print(f"üîç Cache antes de limpiar: {len(data_cache) if hasattr(data_cache, '__len__') else 'N/A'}")
        
        # Limpiar cache de forma segura
        try:
            if hasattr(data_cache, 'clear'):
                data_cache.clear()  # M√©todo est√°ndar
                print(f"‚úÖ Cache.clear() ejecutado")
            else:
                print(f"‚ö†Ô∏è Cache no tiene m√©todo clear(), usando m√©todo alternativo")
                # Recrear el cache como objeto DataCache
                from cache_optimizer import DataCache
                data_cache = DataCache()
                print(f"‚úÖ Cache recreado como objeto DataCache")
        except Exception as e:
            print(f"‚ö†Ô∏è Error limpiando cache: {e}")
            # Recrear el cache como √∫ltimo recurso
            try:
                from cache_optimizer import DataCache
                data_cache = DataCache()
                print(f"‚úÖ Cache recreado como √∫ltimo recurso")
            except Exception as e2:
                print(f"‚ùå Error cr√≠tico recreando cache: {e2}")
                return False
        
        print(f"üîç Cache despu√©s de limpiar: {len(data_cache) if hasattr(data_cache, '__len__') else 'N/A'}")
        print(f"üîç Contenido del cache despu√©s de limpiar: {data_cache}")
        print(f"üîç Tipo del cache despu√©s de limpiar: {type(data_cache)}")
        print(f"üîç ¬øCache tiene m√©todo set? {hasattr(data_cache, 'set')}")
        print(f"üîç ¬øCache tiene m√©todo get? {hasattr(data_cache, 'get')}")
        print(f"üîç Cache limpiado completamente")
        
        # Obtener datos frescos desde Google Sheets
        print(f"üîÑ Descargando datos frescos desde Google Sheets...")
        print(f"üîç Llamando a get_cached_dataframe()...")
        print(f"üîç Estado del cache antes de llamar: {type(data_cache)}")
        
        df_db = get_cached_dataframe()
        
        print(f"üîÑ Datos descargados. Total de filas: {len(df_db)}")
        print(f"üîÑ Primeros 5 IDs: {df_db['ID'].head().tolist() if not df_db.empty and 'ID' in df_db.columns else 'NO DISPONIBLE'}")
        print(f"üîÑ √öltimos 5 IDs: {df_db['ID'].tail().tolist() if not df_db.empty and 'ID' in df_db.columns else 'NO DISPONIBLE'}")
        
        # Debug adicional: verificar que los datos se hayan descargado correctamente
        if df_db.empty:
            print(f"‚ùå ERROR: DataFrame est√° vac√≠o - no se pudieron descargar datos")
            print(f"üîç Verificando estado del cache despu√©s de descarga...")
            print(f"üîç Tipo del cache: {type(data_cache)}")
            print(f"üîç ¬øCache tiene m√©todo set? {hasattr(data_cache, 'set')}")
            print(f"üîç ¬øCache tiene m√©todo get? {hasattr(data_cache, 'get')}")
            return False
        
        # Debug adicional: verificar que los datos sean realmente frescos
        print(f"üîç Verificando que los datos sean frescos...")
        print(f"üîç ¬øEl DataFrame est√° vac√≠o? {df_db.empty}")
        print(f"üîç ¬øTiene columnas? {list(df_db.columns) if not df_db.empty else 'NO'}")
        print(f"üîç ¬øTiene la columna ID? {'ID' in df_db.columns if not df_db.empty else False}")
        
        if not df_db.empty and 'ID' in df_db.columns:
            print(f"üîç Total de IDs √∫nicos: {df_db['ID'].nunique()}")
            print(f"üîç IDs √∫nicos: {df_db['ID'].unique().tolist()}")
        else:
            print(f"‚ùå ERROR: DataFrame vac√≠o o sin columna ID")
            return False
        
        # Debug adicional: verificar que no haya duplicados
        ids_duplicados = df_db['ID'].duplicated().sum()
        if ids_duplicados > 0:
            print(f"‚ö†Ô∏è ADVERTENCIA: Se encontraron {ids_duplicados} IDs duplicados en el DataFrame")
            ids_dups = df_db[df_db['ID'].duplicated()]['ID'].tolist()
            print(f"‚ö†Ô∏è IDs duplicados: {ids_dups}")
        else:
            print(f"‚úÖ No hay IDs duplicados en el DataFrame")
        
        # Buscar la fila correcta
        print(f"üîç Buscando ID: {user_id} en DataFrame...")
        print(f"üîç Tipo de user_id: {type(user_id)}")
        print(f"üîç Valor de user_id: '{user_id}'")
        print(f"üîç ¬øuser_id es string? {isinstance(user_id, str)}")
        print(f"üîç ¬øuser_id est√° vac√≠o? {user_id == '' if isinstance(user_id, str) else 'N/A'}")
        
        print(f"üîç Total de filas en DataFrame: {len(df_db)}")
        print(f"üîç Columnas disponibles: {list(df_db.columns)}")
        print(f"üîç Primeros 5 IDs en DataFrame: {df_db['ID'].head().tolist()}")
        print(f"üîç √öltimos 5 IDs en DataFrame: {df_db['ID'].tail().tolist()}")
        
        # Debug adicional: verificar tipos de datos
        print(f"üîç Tipos de datos en columna ID:")
        print(f"üîç   - Tipo de la columna: {df_db['ID'].dtype}")
        print(f"üîç   - Primeros 3 tipos: {[type(x) for x in df_db['ID'].head(3)]}")
        print(f"üîç   - ¬øHay valores None/NaN? {df_db['ID'].isna().sum()}")
        print(f"üîç   - ¬øHay valores vac√≠os? {(df_db['ID'] == '').sum()}")
        
        # Buscar por ID exacto
        print(f"üîç Iniciando b√∫squeda exacta del ID...")
        
        # Verificar si el ID existe antes de buscar
        if user_id in df_db['ID'].values:
            print(f"‚úÖ ID '{user_id}' S√ç existe en el DataFrame")
        else:
            print(f"‚ùå ID '{user_id}' NO existe en el DataFrame")
            print(f"üîç IDs disponibles: {df_db['ID'].unique().tolist()}")
            
            # Buscar IDs similares
            print(f"üîç Buscando IDs similares...")
            for id_df in df_db['ID'].unique():
                if isinstance(id_df, str) and isinstance(user_id, str):
                    if user_id.lower() in id_df.lower() or id_df.lower() in user_id.lower():
                        print(f"üîç Posible coincidencia: '{id_df}' vs '{user_id}'")
        
        user_id_mask = df_db['ID'] == user_id
        print(f"üîç M√°scara de b√∫squeda creada: {user_id_mask.sum()} coincidencias")
        print(f"üîç IDs encontrados: {df_db[user_id_mask]['ID'].tolist() if user_id_mask.any() else 'NINGUNO'}")
        print(f"üîç Tipo de user_id recibido: {type(user_id)}, Valor: '{user_id}'")
        print(f"üîç Tipos de IDs en DataFrame: {df_db['ID'].dtype}")
        
        if user_id_mask.any():
            # DEBUG CR√çTICO: Mostrar TODAS las filas encontradas
            filas_encontradas = df_db[user_id_mask]
            print(f"üîç DEBUG CR√çTICO - FILAS ENCONTRADAS:")
            print(f"  - Total de filas con ID '{user_id}': {len(filas_encontradas)}")
            
            for idx, fila in filas_encontradas.iterrows():
                print(f"  - Fila {idx}:")
                print(f"    * ID: '{fila.get('ID', 'NO ENCONTRADO')}'")
                print(f"    * ID 2: '{fila.get('ID 2', 'NO ENCONTRADO')}'")
                print(f"    * NOMBRE DEL SITIO: '{fila.get('NOMBRE DEL SITIO', 'NO ENCONTRADO')}'")
                print(f"    * Nombre del sitio 2: '{fila.get('Nombre del sitio 2', 'NO ENCONTRADO')}'")
                print(f"    * Nombre del sitio A: '{fila.get('Nombre del sitio A', 'NO ENCONTRADO')}'")
                print(f"    * Nombre del sitio B: '{fila.get('Nombre del sitio B', 'NO ENCONTRADO')}'")
            
            # Seleccionar la PRIMERA fila (puede haber duplicados)
            row = filas_encontradas.iloc[0]
            nombre_a = row.get('Nombre del sitio A', 'Sitio no encontrado')
            nombre_b = row.get('Nombre del sitio B', 'Sitio no encontrado')
            fila_idx = filas_encontradas.index[0]
            print(f"‚úÖ ID encontrado: {user_id}")
            print(f"‚úÖ Sitio A: {nombre_a}")
            print(f"‚úÖ Sitio B: {nombre_b}")
            print(f"‚úÖ Fila √≠ndice: {fila_idx}")
            print(f"‚úÖ ID de la fila encontrada: '{row.get('ID', 'NO ENCONTRADO')}'")
            
            # DEBUG CR√çTICO: Verificar que los datos sean del ID correcto
            print(f"üîç DEBUG CR√çTICO - VERIFICANDO DATOS SELECCIONADOS:")
            print(f"  - ID en row: '{row.get('ID', 'NO ENCONTRADO')}'")
            print(f"  - ID 2 en row: '{row.get('ID 2', 'NO ENCONTRADO')}'")
            print(f"  - NOMBRE DEL SITIO: '{row.get('NOMBRE DEL SITIO', 'NO ENCONTRADO')}'")
            print(f"  - Nombre del sitio 2: '{row.get('Nombre del sitio 2', 'NO ENCONTRADO')}'")
            print(f"  - ¬øuser_id coincide con ID? {row.get('ID', '') == user_id}")
            
            # Verificar que no haya confusi√≥n con IDs duplicados
            if row.get('ID', '') != user_id:
                print(f"‚ùå ERROR CR√çTICO: Los datos NO corresponden al ID solicitado!")
                print(f"‚ùå ID solicitado: '{user_id}'")
                print(f"‚ùå ID en datos: '{row.get('ID', 'NO ENCONTRADO')}'")
                return False
        else:
            print(f"‚ùå ERROR CR√çTICO: El ID '{user_id}' NO existe en la base de datos")
            print(f"‚ùå IDs disponibles: {df_db['ID'].unique().tolist()}")
            print(f"‚ùå NO se puede usar fila_idx como fallback - esto causar√≠a datos incorrectos")
            return False
        
        # Definir rutas
        base_dir = os.path.dirname(os.path.abspath(__file__))
        if tipo_documento == 'ptmp':
            plantilla_path = os.path.join(base_dir, 'static', 'plantillas', 'EJEMPLO SS PtMP VACIO.xlsx')
            output_path = os.path.join(base_dir, 'ptmp_site_survey', f'ss_ptmp_{user_id}.xlsx')
        else:
            plantilla_path = os.path.join(base_dir, 'site_survey', 'EJEMPLO SS VACIO.xlsx')
            output_path = os.path.join(base_dir, 'site_survey', f'ss_{user_id}.xlsx')
        
        # Crear directorio si no existe
        os.makedirs(os.path.dirname(output_path), exist_ok=True)
        
        # ===== LLENADO AUTOM√ÅTICO COMPLETO =====
        print(f"üî• Iniciando llenado autom√°tico completo...")
        
        try:
            # Copiar plantilla primero
            import shutil
            shutil.copy2(plantilla_path, output_path)
            
            # Ahora llenar el archivo usando la l√≥gica optimizada
            print(f"üìä Llenando archivo con datos de {nombre_a} ‚Üí {nombre_b}")
            
            # Llamar a la funci√≥n de llenado optimizado
            llenado_exitoso = llenar_archivo_ptp_optimizado(output_path, row, nombre_a, nombre_b, user_id)
            
            if llenado_exitoso:
                print(f"‚úÖ Archivo generado Y LLENADO COMPLETAMENTE: {output_path}")
                
                # ===== COPIAR ARCHIVOS AUTOM√ÅTICAMENTE =====
                print(f"üìÅ Iniciando copia autom√°tica de archivos...")
                
                # Buscar un ID anterior que tenga archivos para copiar
                archivos_copiados = False
                try:
                    # Buscar en el directorio de uploads por cualquier ID que tenga archivos
                    uploads_dir = os.path.join(base_dir, 'uploads')
                    if os.path.exists(uploads_dir):
                        # Buscar en fotos A
                        fotos_a_dir = os.path.join(uploads_dir, 'imagenes_ptp_fotos_a')
                        if os.path.exists(fotos_a_dir):
                            # Encontrar el primer ID que tenga archivos
                            for item in os.listdir(fotos_a_dir):
                                if os.path.isdir(os.path.join(fotos_a_dir, item)) and item != user_id:
                                    # Verificar si tiene archivos
                                    item_path = os.path.join(fotos_a_dir, item)
                                    if os.listdir(item_path):  # Si tiene archivos
                                        print(f"üîç Encontrado ID con archivos: {item}")
                                        # Copiar archivos de este ID al nuevo
                                        archivos_copiados = copiar_archivos_automaticamente(item, user_id, tipo_documento)
                                        break
                
                except Exception as e:
                    print(f"‚ö†Ô∏è Error en copia autom√°tica de archivos: {e}")
                
                if archivos_copiados:
                    print(f"‚úÖ ARCHIVOS COPIADOS AUTOM√ÅTICAMENTE para {user_id}")
                else:
                    print(f"‚ÑπÔ∏è No se encontraron archivos para copiar autom√°ticamente")
                
                return True
            else:
                print(f"‚ö†Ô∏è Archivo generado pero llenado incompleto: {output_path}")
                return True  # Retornar True para que contin√∫e el proceso
                
        except Exception as llenado_error:
            print(f"‚ùå Error en llenado autom√°tico: {llenado_error}")
            # Si falla el llenado, al menos tenemos el archivo base
            return True
        
    except Exception as e:
        print(f"‚ùå Error generando archivo: {e}")
        return False

def llenar_con_openpyxl_alternativo(user_id, fila_idx, tipo_documento):
    """
    Funci√≥n alternativa que usa openpyxl cuando xlwings falla
    """
    try:
        print("üîÑ USANDO M√âTODO ALTERNATIVO (openpyxl)...")
        
        # Importar openpyxl
        try:
            from openpyxl import load_workbook
            print("‚úÖ openpyxl importado correctamente")
        except ImportError as e:
            print(f"‚ùå Error importando openpyxl: {e}")
            return False
        
        # Obtener datos del cache
        df_db = get_cached_dataframe()
        
        # Buscar la fila correcta
        user_id_mask = df_db['ID'] == user_id
        if user_id_mask.any():
            row = df_db[user_id_mask].iloc[0]
            nombre_a = row.get('Nombre del sitio A', 'Sitio no encontrado')
            nombre_b = row.get('Nombre del sitio B', 'Sitio no encontrado')
        else:
            print(f"‚ùå ID {user_id} NO encontrado en DataFrame")
            return False
        
        # Definir rutas
        base_dir = os.path.dirname(os.path.abspath(__file__))
        if tipo_documento == 'ptp':
            output_path = os.path.join(base_dir, 'ptp_site_survey', f'ss_ptp_{user_id}.xlsx')
        else:
            output_path = os.path.join(base_dir, 'site_survey', f'ss_{user_id}.xlsx')
        
        # Cargar el archivo
        try:
            wb = load_workbook(output_path)
            print("‚úÖ Archivo cargado con openpyxl")
        except Exception as e:
            print(f"‚ùå Error cargando archivo: {e}")
            return False
        
        # Obtener hojas
        try:
            ws_caratula = wb['0. Car√°tula']
            ws_info_a = wb['1. Informaci√≥n General A']
            ws_info_b = wb['2. Informaci√≥n General B']
            print("‚úÖ Hojas obtenidas correctamente")
        except KeyError as e:
            print(f"‚ùå Error obteniendo hojas: {e}")
            return False
        
        # Llenar informaci√≥n b√°sica
        try:
            # Car√°tula
            ws_caratula['A43'] = f"{nombre_a} - {nombre_b}"
            
            # Informaci√≥n b√°sica
            ws_info_a['B15'] = safe_strip(row.get('LATITUD (TORRE)', ''))
            ws_info_a['F15'] = safe_strip(row.get('LONGITUD (TORRE)', ''))
            ws_info_a['J15'] = safe_strip(row.get('Altitud (msnm)', ''))
            ws_info_a['B17'] = safe_strip(row.get('Nombre de contacto en sitio', ''))
            ws_info_a['F17'] = safe_strip(row.get('Telefono', ''))
            ws_info_a['B19'] = safe_strip(row.get('Direcci√≥n', ''))
            
            print("‚úÖ Informaci√≥n b√°sica llenada")
        except Exception as e:
            print(f"‚ö†Ô∏è Error llenando informaci√≥n b√°sica: {e}")
        
        # Guardar archivo
        try:
            wb.save(output_path)
            wb.close()
            print("‚úÖ Archivo guardado exitosamente con openpyxl")
            return True
        except Exception as e:
            print(f"‚ùå Error guardando archivo: {e}")
            return False
            
    except Exception as e:
        print(f"‚ùå Error en m√©todo alternativo: {e}")
        return False

def copiar_archivos_automaticamente(user_id_origen, user_id_destino, tipo_documento):
    """
    Copia autom√°ticamente fotos, KMZ y planos del ID origen al ID destino
    """
    try:
        print(f"üìÅ COPIANDO ARCHIVOS AUTOM√ÅTICAMENTE de {user_id_origen} ‚Üí {user_id_destino}")
        
        base_dir = os.path.dirname(os.path.abspath(__file__))
        
        # Definir directorios de origen y destino
        if tipo_documento == 'ptmp':
            # Para PtMP
            origen_fotos_a = os.path.join(base_dir, 'uploads', 'imagenes_ptmp_fotos_a', user_id_origen)
            origen_fotos_b = os.path.join(base_dir, 'uploads', 'imagenes_ptmp_fotos_b', user_id_origen)
            origen_planos = os.path.join(base_dir, 'uploads', 'imagenes_ptmp_planos', user_id_origen)
            origen_kmz = os.path.join(base_dir, 'uploads', 'kmz_ptmp', user_id_origen)
            
            destino_fotos_a = os.path.join(base_dir, 'uploads', 'imagenes_ptmp_fotos_a', user_id_destino)
            destino_fotos_b = os.path.join(base_dir, 'uploads', 'imagenes_ptmp_fotos_b', user_id_destino)
            destino_planos = os.path.join(base_dir, 'uploads', 'imagenes_ptmp_planos', user_id_destino)
            destino_kmz = os.path.join(base_dir, 'uploads', 'kmz_ptmp', user_id_destino)
        else:
            # Para PtP (default)
            origen_fotos_a = os.path.join(base_dir, 'uploads', 'imagenes_ptp_fotos_a', user_id_origen)
            origen_fotos_b = os.path.join(base_dir, 'uploads', 'imagenes_ptp_fotos_b', user_id_origen)
            origen_planos = os.path.join(base_dir, 'uploads', 'imagenes_ptp_planos', user_id_origen)
            origen_kmz = os.path.join(base_dir, 'uploads', 'kmz_ptp', user_id_origen)
            
            destino_fotos_a = os.path.join(base_dir, 'uploads', 'imagenes_ptp_fotos_a', user_id_destino)
            destino_fotos_b = os.path.join(base_dir, 'uploads', 'imagenes_ptp_fotos_b', user_id_destino)
            destino_planos = os.path.join(base_dir, 'uploads', 'imagenes_ptp_planos', user_id_destino)
            destino_kmz = os.path.join(base_dir, 'uploads', 'kmz_ptp', user_id_destino)
        
        # Funci√≥n para copiar directorio si existe
        def copiar_directorio_si_existe(origen, destino):
            if os.path.exists(origen) and os.path.isdir(origen):
                try:
                    import shutil
                    if os.path.exists(destino):
                        shutil.rmtree(destino)  # Eliminar destino si existe
                    shutil.copytree(origen, destino)
                    print(f"‚úÖ Copiado: {origen} ‚Üí {destino}")
                    return True
                except Exception as e:
                    print(f"‚ö†Ô∏è Error copiando {origen}: {e}")
                    return False
            else:
                print(f"‚ÑπÔ∏è Origen no existe: {origen}")
                return False
        
        # Crear directorios de destino si no existen
        os.makedirs(destino_fotos_a, exist_ok=True)
        os.makedirs(destino_fotos_b, exist_ok=True)
        os.makedirs(destino_planos, exist_ok=True)
        os.makedirs(destino_kmz, exist_ok=True)
        
        # Copiar archivos
        archivos_copiados = 0
        
        # Copiar fotos A
        if copiar_directorio_si_existe(origen_fotos_a, destino_fotos_a):
            archivos_copiados += 1
        
        # Copiar fotos B
        if copiar_directorio_si_existe(origen_fotos_b, destino_fotos_b):
            archivos_copiados += 1
        
        # Copiar planos
        if copiar_directorio_si_existe(origen_planos, destino_planos):
            archivos_copiados += 1
        
        # Copiar KMZ
        if copiar_directorio_si_existe(origen_kmz, destino_kmz):
            archivos_copiados += 1
        
        print(f"‚úÖ ARCHIVOS COPIADOS: {archivos_copiados}/4 directorios")
        return archivos_copiados > 0
        
    except Exception as e:
        print(f"‚ùå Error copiando archivos: {e}")
        import traceback
        traceback.print_exc()
        return False

@app.route('/guardar_archivo_generado', methods=['POST'])
def guardar_archivo_generado():
    """
    Guarda el archivo generado en una carpeta permanente de archivos generados
    """
    try:
        import json
        data = request.get_json()
        user_id = data.get('user_id')
        tipo_documento = data.get('tipo_documento', 'ptp')
        fila_idx = data.get('fila_idx', '0')
        
        if not user_id:
            return jsonify({'success': False, 'message': 'ID de usuario requerido'})
        
        # Crear directorio para archivos generados si no existe
        archivos_generados_dir = os.path.join(base_dir, 'archivos_generados')
        os.makedirs(archivos_generados_dir, exist_ok=True)
        
        # Buscar el archivo generado
        user_id_limpio = re.sub(r'[^a-zA-Z0-9_-]', '', str(user_id))
        
        if tipo_documento == 'ptmp':
            # Para PtMP
            archivo_origen = os.path.join(base_dir, 'ptmp_site_survey', f'ss_ptmp_{user_id}.xlsx')
        else:
            # Para PtP
            archivo_origen = os.path.join(base_dir, 'site_survey', f'ss_{user_id}.xlsx')
        
        # ===== GENERACI√ìN AUTOM√ÅTICA SI EL ARCHIVO NO EXISTE =====
        print(f"üîç Verificando archivo: {archivo_origen}")
        print(f"üîç ¬øExiste el archivo? {os.path.exists(archivo_origen)}")
        
        if not os.path.exists(archivo_origen):
            print(f"‚ö†Ô∏è Archivo no encontrado: {archivo_origen}")
            print("üöÄ GENERANDO ARCHIVO AUTOM√ÅTICAMENTE...")
            print("üìä Esto puede tomar unos segundos...")
            print(f"üîç Par√°metros: user_id={user_id}, fila_idx={fila_idx}, tipo_documento={tipo_documento}")
            
            try:
                # Llamar a la funci√≥n de generaci√≥n autom√°ticamente
                if tipo_documento == 'ptp':
                    print(f"üîç Generando Site Survey PtP para {user_id}...")
                    # Generar Site Survey PtP
                    result = site_survey_generator(user_id, fila_idx, 'ptp')
                    print(f"üîç Resultado de generaci√≥n: {result}")
                    if result:
                        # Verificar que el archivo se cre√≥
                        archivo_origen = os.path.join(base_dir, 'site_survey', f'ss_{user_id}.xlsx')
                        print(f"üîç Verificando archivo generado: {archivo_origen}")
                        if os.path.exists(archivo_origen):
                            print(f"‚úÖ Archivo generado autom√°ticamente: {archivo_origen}")
                        else:
                            print(f"‚ùå Archivo NO se cre√≥: {archivo_origen}")
                            return jsonify({'success': False, 'message': 'No se pudo generar el archivo autom√°ticamente'})
                    else:
                        print(f"‚ùå Generaci√≥n fall√≥ para {user_id}")
                        return jsonify({'success': False, 'message': 'No se pudo generar el archivo autom√°ticamente'})
                elif tipo_documento == 'ptmp':
                    # Generar Site Survey PtMP
                    result = site_survey_generator(user_id, fila_idx, 'ptmp')
                    if result:
                        # Verificar que el archivo se cre√≥
                        archivo_origen = os.path.join(base_dir, 'ptmp_site_survey', f'ss_ptmp_{user_id}.xlsx')
                        if os.path.exists(archivo_origen):
                            print(f"‚úÖ Archivo generado autom√°ticamente: {archivo_origen}")
                        else:
                            return jsonify({'success': False, 'message': 'No se pudo generar el archivo autom√°ticamente'})
                    else:
                        return jsonify({'success': False, 'message': 'No se pudo generar el archivo autom√°ticamente'})
                else:
                    return jsonify({'success': False, 'message': 'Tipo de documento no soportado para generaci√≥n autom√°tica'})
                    
            except Exception as gen_error:
                print(f"‚ùå Error en generaci√≥n autom√°tica: {gen_error}")
                return jsonify({'success': False, 'message': f'Error generando archivo: {str(gen_error)}'})
        
        # Crear nombre para el archivo guardado
        timestamp = time.strftime('%Y%m%d_%H%M%S')
        
        # Usar prefijo diferente seg√∫n el tipo de documento
        if tipo_documento == 'diseno_solucion':
            prefijo = 'ds'
        elif tipo_documento == 'ptp':
            prefijo = 'ptp'
        else:
            prefijo = 'ss'  # site_survey por defecto
            
        nombre_archivo = f'{prefijo}_{tipo_documento}_{user_id_limpio}_{timestamp}.xlsx'
        archivo_destino = os.path.join(archivos_generados_dir, nombre_archivo)
        
        # Copiar archivo
        import shutil
        shutil.copy2(archivo_origen, archivo_destino)
        
        print(f"Archivo guardado exitosamente: {archivo_destino}")
        
        return jsonify({
            'success': True, 
            'message': f'Archivo guardado como {nombre_archivo}',
            'archivo': nombre_archivo,
            'ruta': archivo_destino
        })
        
    except Exception as e:
        print(f"Error al guardar archivo: {e}")
        return jsonify({'success': False, 'message': f'Error interno: {str(e)}'})

@app.route('/generar_diseno_solucion', methods=['POST'])
@error_handler
def generar_diseno_solucion():
    """
    Genera un archivo de DISE√ëO DE SOLUCI√ìN usando la plantilla espec√≠fica 'llenadoauto.xlsx'.
    
    IMPORTANTE: Esta funci√≥n usa la plantilla correcta para dise√±o de soluci√≥n.
    - Site Survey: Usa plantilla 'EJEMPLO SS VACIO.xlsx' con hojas espec√≠ficas para encuesta
    - Dise√±o de Soluci√≥n: Usa plantilla 'llenadoauto.xlsx' con estructura espec√≠fica para dise√±o t√©cnico
    """
    try:
        import json
        import requests
        data = request.get_json()
        user_id = data.get('user_id')
        fila_idx = data.get('fila_idx', '0')
        llenado_automatico = data.get('llenado_automatico', False)
        
        print(f"üöÄ DEBUG: Llenado autom√°tico solicitado: {llenado_automatico}")
    
        # Validar entrada del usuario
        es_valido, mensaje_error, fila_idx_int = validate_user_input(user_id, fila_idx)
        if not es_valido:
            logger.warning(f"Validaci√≥n fallida para user_id: {user_id}, fila_idx: {fila_idx} - {mensaje_error}")
            return jsonify({'success': False, 'message': mensaje_error})
        
        # Log de la operaci√≥n
        log_operation('generar_diseno_solucion', user_id, {
            'fila_idx': fila_idx_int,
            'timestamp_inicio': datetime.now().isoformat()
        })
        
        logger.info(f"Generando dise√±o de soluci√≥n para user_id: {user_id}, fila_idx: {fila_idx_int}")
        
        # Leer datos de Google Sheets
        try:
            df = pd.read_csv(GOOGLE_SHEETS_CSV_URL)
            logger.info(f"Google Sheets le√≠do correctamente, {len(df)} filas")
        except Exception as e:
            logger.error(f"No se pudo leer Google Sheets: {e}")
            return jsonify({'success': False, 'message': f'Error leyendo Google Sheets: {str(e)}'})
        
        # Buscar la fila correspondiente
        try:
            fila_idx = int(fila_idx)
            if fila_idx < len(df):
                fila = df.iloc[fila_idx]
                id_sitio = str(fila['ID'])
                
                # Intentar diferentes nombres de columnas para los sitios
                sitio_a = str(fila.get('Nombre del sitio A', '') or fila.get('Sitio A', '') or fila.get('Sitio_A', '') or '')
                sitio_b = str(fila.get('Nombre del sitio B', '') or fila.get('Sitio B', '') or fila.get('Sitio_B', '') or '')
                
                print(f"DEBUG: Datos de fila - ID: {id_sitio}, Sitio A: {sitio_a}, Sitio B: {sitio_b}")
                print(f"DEBUG: Columnas disponibles: {list(df.columns)}")
            else:
                return jsonify({'success': False, 'message': 'Fila no encontrada'})
        except Exception as e:
            print(f"ERROR: Error procesando fila: {e}")
            print(f"DEBUG: Columnas disponibles: {list(df.columns)}")
            return jsonify({'success': False, 'message': f'Error procesando fila: {str(e)}'})
        
        # Crear directorio para archivos generados si no existe
        archivos_generados_dir = os.path.join(base_dir, 'archivos_generados')
        os.makedirs(archivos_generados_dir, exist_ok=True)
        
        # Crear nombre para el archivo
        timestamp = time.strftime('%Y%m%d_%H%M%S')
        user_id_limpio = re.sub(r'[^a-zA-Z0-9_-]', '', str(user_id))
        nombre_archivo = f'ds_diseno_solucion_{user_id_limpio}_{timestamp}.xlsx'
        archivo_destino = os.path.join(archivos_generados_dir, nombre_archivo)
        
        # Usar la plantilla espec√≠fica para DISE√ëO DE SOLUCI√ìN
        try:
            import xlwings as xw
            
            # Ruta de la plantilla de dise√±o de soluci√≥n
            plantilla_path = os.path.join(base_dir, 'Temp', 'plantillas', 'llenadoauto.xlsx')
            
            print(f"üîç DEBUG: Ruta base del proyecto: {base_dir}")
            print(f"üîç DEBUG: Ruta completa de la plantilla: {plantilla_path}")
            print(f"üîç DEBUG: ¬øExiste la plantilla?: {os.path.exists(plantilla_path)}")
            
            # Verificar que exista el directorio
            directorio_plantillas = os.path.join(base_dir, 'Temp', 'plantillas')
            print(f"üîç DEBUG: Directorio de plantillas: {directorio_plantillas}")
            print(f"üîç DEBUG: ¬øExiste el directorio?: {os.path.exists(directorio_plantillas)}")
            
            if os.path.exists(directorio_plantillas):
                archivos_en_directorio = os.listdir(directorio_plantillas)
                print(f"üîç DEBUG: Archivos en directorio de plantillas: {archivos_en_directorio}")
            
            if not os.path.exists(plantilla_path):
                return jsonify({
                    'success': False, 
                    'message': f'Plantilla de dise√±o de soluci√≥n no encontrada en: {plantilla_path}'
                })
            
            print(f"‚úÖ DEBUG: Plantilla de dise√±o de soluci√≥n encontrada y ser√° usada: {plantilla_path}")
            
            # Iniciar Excel solo si es necesario
            app_excel = None
            try:
                # Solo abrir Excel en Windows
                if os.name == 'nt':
                    app_excel = xw.App(visible=False)
                    print('DEBUG: Excel iniciado para dise√±o de soluci√≥n')
                else:
                    print('DEBUG: No es Windows, saltando Excel')
                    return jsonify({
                        'success': False, 
                        'message': 'Generaci√≥n de archivos Excel solo disponible en Windows'
                    })
            except Exception as excel_error:
                print(f'DEBUG: Error iniciando Excel: {excel_error}')
                return jsonify({
                    'success': False, 
                    'message': f'Error iniciando Excel: {str(excel_error)}'
                })
            
            # Abrir la plantilla
            try:
                wb = app_excel.books.open(plantilla_path)
                print('DEBUG: Plantilla de dise√±o de soluci√≥n abierta correctamente')
            except Exception as open_error:
                if app_excel:
                    app_excel.quit()
                return jsonify({
                    'success': False, 
                    'message': f'Error abriendo plantilla: {str(open_error)}'
                })
            
            # Obtener la hoja principal (asumiendo que es la primera)
            try:
                ws = wb.sheets[0]  # Primera hoja
                print('DEBUG: Hoja principal obtenida')
            except Exception as sheet_error:
                wb.close()
                if app_excel:
                    app_excel.quit()
                return jsonify({
                    'success': False, 
                    'message': f'Error obteniendo hoja: {str(sheet_error)}'
                })
            
            # Llenar informaci√≥n b√°sica del sitio en la plantilla
            try:
                # Buscar celdas para llenar informaci√≥n del sitio
                # Estas celdas pueden variar seg√∫n la plantilla, ajustar seg√∫n sea necesario
                ws.range('A1').value = f'ID del Sitio: {id_sitio}'
                ws.range('A2').value = f'Sitio A: {sitio_a}'
                ws.range('A3').value = f'Sitio B: {sitio_b}'
                ws.range('A4').value = f'Fecha de Generaci√≥n: {time.strftime("%Y-%m-%d %H:%M:%S")}'
                ws.range('A5').value = 'Tipo de Documento: DISE√ëO DE SOLUCI√ìN'
                
                print('DEBUG: Informaci√≥n del sitio agregada a la plantilla')
                
            except Exception as fill_error:
                print(f'DEBUG: Error llenando informaci√≥n: {fill_error}')
                # Continuar aunque haya error llenando informaci√≥n
            
            # Guardar el archivo con manejo robusto de Excel
            try:
                # Cerrar Excel antes de guardar para evitar conflictos
                wb.close()
                
                # Esperar un momento para que Excel se cierre completamente
                time.sleep(1)
                
                # Cerrar la aplicaci√≥n de Excel
                if app_excel:
                    app_excel.quit()
                    time.sleep(1)
                
                # Verificar si se debe ejecutar llenado autom√°tico
                if llenado_automatico:
                    print(f"üöÄ Llenado autom√°tico solicitado - generando archivo YA LLENADO para {user_id}")
                    
                    try:
                        # En lugar de copiar solo la plantilla, usar /procesar para generar archivo YA LLENADO
                        import requests
                        
                        # Crear formulario para /procesar
                        form_data = {
                            'user_id': user_id,
                            'fila_idx': fila_idx if fila_idx else '0',
                            'tipo': 'diseno_solucion',
                            'llenado_automatico': 'true'
                        }
                        
                        # Llamar a /procesar para generar archivo YA LLENADO
                        print(f"üîÑ Llamando a /procesar para generar archivo con llenado autom√°tico...")
                        response = requests.post('http://127.0.0.1:5000/procesar', data=form_data)
                        response = requests.post(f'{get_base_url()}/procesar', data=form_data)
                        
                        if response.status_code == 200:
                            print(f"‚úÖ Archivo generado YA LLENADO exitosamente para {user_id}")
                            # El archivo ya est√° llenado, retornar √©xito inmediatamente
                            return jsonify({
                                'success': True,
                                'message': f'Archivo de DISE√ëO DE SOLUCI√ìN generado YA LLENADO exitosamente: {nombre_archivo}',
                                'archivo': nombre_archivo,
                                'ruta': 'Archivo generado por /procesar',
                                'llenado_automatico': True
                            })
                        else:
                            print(f"‚ùå Error en generaci√≥n con llenado autom√°tico: {response.status_code} - {response.text}")
                            # En caso de error, continuar con la generaci√≥n normal
                            import shutil
                            shutil.copy2(plantilla_path, archivo_destino)
                            print(f"‚ö†Ô∏è Continuando con generaci√≥n normal (sin llenado autom√°tico)")
                    except Exception as e:
                        print(f"‚ùå Error en llenado autom√°tico: {e}")
                        # En caso de error, continuar con la generaci√≥n normal
                        import shutil
                        shutil.copy2(plantilla_path, archivo_destino)
                        print(f"‚ö†Ô∏è Continuando con generaci√≥n normal (sin llenado autom√°tico)")
                else:
                    # Generaci√≥n normal sin llenado autom√°tico
                    import shutil
                    shutil.copy2(plantilla_path, archivo_destino)
                    print(f"DEBUG: Archivo de DISE√ëO DE SOLUCI√ìN generado copiando plantilla: {archivo_destino}")
                
                return jsonify({
                    'success': True,
                    'message': f'Archivo de DISE√ëO DE SOLUCI√ìN generado exitosamente: {nombre_archivo}',
                    'archivo': nombre_archivo,
                    'ruta': archivo_destino,
                    'llenado_automatico': llenado_automatico
                })
                
            except Exception as save_error:
                print(f"DEBUG: Error en m√©todo alternativo: {save_error}")
                try:
                    wb.close()
                except:
                    pass
                try:
                    if app_excel:
                        app_excel.quit()
                except:
                    pass
                
                return jsonify({
                    'success': False, 
                    'message': f'Error guardando archivo: {str(save_error)}'
                })
            
        except Exception as e:
            print(f"ERROR general generando archivo de DISE√ëO DE SOLUCI√ìN: {e}")
            return jsonify({
                'success': False, 
                'message': f'Error general: {str(e)}'
            })
        
    except Exception as e:
        print(f"ERROR en generar_diseno_solucion: {e}")
        return jsonify({'success': False, 'message': f'Error interno: {str(e)}'})

@app.route('/file_manager')
def file_manager():
    """
    Muestra el gestor de archivos generados
    """
    try:
        # Crear directorio si no existe
        archivos_generados_dir = os.path.join(base_dir, 'archivos_generados')
        os.makedirs(archivos_generados_dir, exist_ok=True)
        
        # Obtener lista de archivos
        archivos = []
        if os.path.exists(archivos_generados_dir):
            for archivo in os.listdir(archivos_generados_dir):
                if archivo.endswith('.xlsx'):
                    ruta_completa = os.path.join(archivos_generados_dir, archivo)
                    info = os.stat(ruta_completa)
                    archivos.append({
                        'nombre': archivo,
                        'tama√±o': info.st_size,
                        'fecha': time.ctime(info.st_mtime),
                        'ruta': ruta_completa
                    })
        
        # Ordenar por fecha (m√°s reciente primero)
        archivos.sort(key=lambda x: x['fecha'], reverse=True)
        
        html = f"""
        <!DOCTYPE html>
        <html lang="es">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Gesti√≥n de Archivos - FANGIO TELECOM</title>
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
            <style>
                * {{
                    margin: 0;
                    padding: 0;
                    box-sizing: border-box;
                }}
                
                body {{
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    min-height: 100vh;
                    padding: 20px;
                }}
                
                .container {{
                    max-width: 1200px;
                    margin: 0 auto;
                    background: rgba(255, 255, 255, 0.95);
                    backdrop-filter: blur(20px);
                    border-radius: 20px;
                    padding: 30px;
                    box-shadow: 0 20px 40px rgba(0,0,0,0.1);
                }}
                
                .header {{
                    text-align: center;
                    margin-bottom: 30px;
                    padding-bottom: 20px;
                    border-bottom: 2px solid #e0e0e0;
                }}
                
                .header h1 {{
                    color: #2c3e50;
                    font-size: 2.5rem;
                    margin-bottom: 10px;
                }}
                
                .header p {{
                    color: #7f8c8d;
                    font-size: 1.1rem;
                }}
                
                .stats {{
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                    gap: 20px;
                    margin-bottom: 30px;
                }}
                
                .stat-card {{
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    padding: 20px;
                    border-radius: 15px;
                    text-align: center;
                }}
                
                .stat-number {{
                    font-size: 2rem;
                    font-weight: bold;
                    margin-bottom: 5px;
                }}
                
                .stat-label {{
                    font-size: 0.9rem;
                    opacity: 0.9;
                }}
                
                .files-table {{
                    width: 100%;
                    border-collapse: collapse;
                    margin-top: 20px;
                    background: white;
                    border-radius: 15px;
                    overflow: hidden;
                    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
                }}
                
                .files-table th {{
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    padding: 15px;
                    text-align: left;
                    font-weight: 600;
                }}
                
                .files-table td {{
                    padding: 15px;
                    border-bottom: 1px solid #e0e0e0;
                }}
                
                .files-table tr:hover {{
                    background: #f8f9fa;
                }}
                
                .file-actions {{
                    display: flex;
                    gap: 10px;
                }}
                
                .btn {{
                    padding: 8px 16px;
                    border: none;
                    border-radius: 8px;
                    cursor: pointer;
                    text-decoration: none;
                    font-size: 0.9rem;
                    transition: all 0.3s ease;
                }}
                
                .btn-download {{
                    background: #00c3ff;
                    color: white;
                }}
                
                .btn-download:hover {{
                    background: #00a8e6;
                    transform: translateY(-2px);
                }}
                
                .btn-delete {{
                    background: #ff6b6b;
                    color: white;
                }}
                
                .btn-delete:hover {{
                    background: #ee5a24;
                    transform: translateY(-2px);
                }}
                
                .btn-back {{
                    background: #667eea;
                    color: white;
                    padding: 12px 24px;
                    font-size: 1rem;
                    margin-top: 20px;
                }}
                
                .btn-back:hover {{
                    background: #5a6fd8;
                    transform: translateY(-2px);
                }}
                
                .empty-state {{
                    text-align: center;
                    padding: 60px 20px;
                    color: #7f8c8d;
                }}
                
                .empty-state i {{
                    font-size: 4rem;
                    margin-bottom: 20px;
                    opacity: 0.5;
                }}
                
                @media (max-width: 768px) {{
                    .stats {{
                        grid-template-columns: 1fr;
                    }}
                    
                    .files-table {{
                        font-size: 0.9rem;
                    }}
                    
                    .file-actions {{
                        flex-direction: column;
                    }}
                }}
            </style>
        </head>
        <body>
            <div class="container">
                <div class="header">
                    <h1><i class="fas fa-folder-open"></i> Gestor de Archivos Generados</h1>
                    <p>Administra todos los archivos Excel que has guardado</p>
                </div>
                
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number">{len(archivos)}</div>
                        <div class="stat-label">Archivos Guardados</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">{sum(archivo['tama√±o'] for archivo in archivos) / (1024*1024):.1f} MB</div>
                        <div class="stat-label">Espacio Total</div>
                    </div>
                </div>
                
                {f'<table class="files-table"><thead><tr><th>Nombre del Archivo</th><th>Tama√±o</th><th>Fecha de Creaci√≥n</th><th>Acciones</th></tr></thead><tbody>' + ''.join([f'<tr><td>{archivo["nombre"]}</td><td>{archivo["tama√±o"] / 1024:.1f} KB</td><td>{archivo["fecha"]}</td><td class="file-actions"><a href="/descargar_archivo_guardado?archivo={archivo["nombre"]}" class="btn btn-download"><i class="fas fa-download"></i> Descargar</a><button onclick="eliminarArchivo(\'{archivo["nombre"]}\')" class="btn btn-delete"><i class="fas fa-trash"></i> Eliminar</button></td></tr>' for archivo in archivos]) + '</tbody></table>' if archivos else '<div class="empty-state"><i class="fas fa-folder-open"></i><h3>No hay archivos guardados</h3><p>Los archivos que guardes aparecer√°n aqu√≠</p></div>'}
                
                <div style="text-align: center;">
                    <a href="/" class="btn btn-back">
                        <i class="fas fa-home"></i> Volver al Inicio
                    </a>
                </div>
            </div>
            
            <script>
                function eliminarArchivo(nombreArchivo) {{
                    if (confirm('¬øEst√°s seguro de que quieres eliminar este archivo?')) {{
                        fetch('/eliminar_archivo_guardado', {{
                            method: 'POST',
                            headers: {{
                                'Content-Type': 'application/json',
                            }},
                            body: JSON.stringify({{archivo: nombreArchivo}})
                        }})
                        .then(response => response.json())
                        .then(data => {{
                            if (data.success) {{
                                alert('‚úÖ Archivo eliminado exitosamente');
                                location.reload();
                            }} else {{
                                alert('‚ùå Error al eliminar: ' + data.message);
                            }}
                        }})
                        .catch(error => {{
                            alert('‚ùå Error de conexi√≥n');
                        }});
                    }}
                }}
            </script>
        </body>
        </html>
        """
        
        return render_template_string(html)
        
    except Exception as e:
        return mostrar_error_excel_elegante("Error en Gestor de Archivos", f"Error interno: {str(e)}")

@app.route('/descargar_archivo_guardado')
def descargar_archivo_guardado():
    """
    Descarga un archivo guardado desde el gestor
    """
    try:
        nombre_archivo = request.args.get('archivo')
        if not nombre_archivo:
            return "Nombre de archivo requerido"
        
        # Validar nombre de archivo
        if '..' in nombre_archivo or '/' in nombre_archivo or '\\' in nombre_archivo:
            return "Nombre de archivo inv√°lido"
        
        archivo_path = os.path.join(base_dir, 'archivos_generados', nombre_archivo)
        
        if not os.path.exists(archivo_path):
            return "Archivo no encontrado"
        
        return send_file(archivo_path, as_attachment=True)
        
    except Exception as e:
        return mostrar_error_excel_elegante("Error al Descargar", f"Error interno: {str(e)}")

@app.route('/eliminar_archivo_guardado', methods=['POST'])
def eliminar_archivo_guardado():
    """
    Elimina un archivo guardado
    """
    try:
        import json
        data = request.get_json()
        nombre_archivo = data.get('archivo')
        
        if not nombre_archivo:
            return jsonify({'success': False, 'message': 'Nombre de archivo requerido'})
        
        # Validar nombre de archivo
        if '..' in nombre_archivo or '/' in nombre_archivo or '\\' in nombre_archivo:
            return jsonify({'success': False, 'message': 'Nombre de archivo inv√°lido'})
        
        archivo_path = os.path.join(base_dir, 'archivos_generados', nombre_archivo)
        
        if not os.path.exists(archivo_path):
            return jsonify({'success': False, 'message': 'Archivo no encontrado'})
        
        # Eliminar archivo
        os.remove(archivo_path)
        
        return jsonify({'success': True, 'message': 'Archivo eliminado exitosamente'})
        
    except Exception as e:
        return jsonify({'success': False, 'message': f'Error interno: {str(e)}'})

@app.route('/generar_site_survey_automatico', methods=['POST'])
def generar_site_survey_automatico():
    """
    Genera autom√°ticamente un site_survey para un nuevo ID
    """
    try:
        import json
        data = request.get_json()
        user_id = data.get('user_id')
        
        if not user_id:
            return jsonify({'success': False, 'message': 'ID de usuario requerido'})
        
        # Buscar el ID en Google Sheets
        df_db = pd.read_csv(GOOGLE_SHEETS_CSV_URL)
        user_id_found = df_db[df_db['ID'] == user_id]
        
        if user_id_found.empty:
            return jsonify({'success': False, 'message': f'ID {user_id} no encontrado en la base de datos'})
        
        # Si hay m√∫ltiples sitios, usar el primero
        if len(user_id_found) > 1:
            print(f"ID {user_id} tiene m√∫ltiples sitios, usando el primero")
        
        # Obtener la primera fila encontrada
        row = user_id_found.iloc[0]
        fila_idx = int(user_id_found.index[0])  # Convertir int64 a int normal
        
        # Verificar que se pueda generar el site_survey
        try:
            # Intentar generar el Excel para verificar que funcione
            nombre_a = row.get('Nombre del sitio A', '')
            nombre_b = row.get('Nombre del sitio B', '')
            
            if pd.isna(nombre_a) or nombre_a == '':
                nombre_a = user_id
            if pd.isna(nombre_b) or nombre_b == '':
                nombre_b = user_id
            
            print(f"Generando site_survey para ID: {user_id}, Sitio A: {nombre_a}, Sitio B: {nombre_b}")
            
            return jsonify({
                'success': True, 
                'message': f'Site Survey generado exitosamente para {user_id}',
                'user_id': str(user_id),
                'fila_idx': int(fila_idx),
                'nombre_a': str(nombre_a),
                'nombre_b': str(nombre_b)
            })
            
        except Exception as e:
            print(f"Error al generar site_survey: {e}")
            return jsonify({'success': False, 'message': f'Error al generar site_survey: {str(e)}'})
        
    except Exception as e:
        print(f"Error en generar_site_survey_automatico: {e}")
        return jsonify({'success': False, 'message': f'Error interno: {str(e)}'})

@app.route('/descargar_site_survey_ptmp')
def descargar_site_survey_ptmp():
    import os
    import re
    user_id = request.args.get('user_id', '')
    if not user_id:
        return "Falta el ID"
    
    def limpiar_nombre_archivo(nombre):
        # Eliminar caracteres problem√°ticos para nombres de archivo
        nombre_limpio = re.sub(r'[<>:"/\\|?*]', '', str(nombre))
        # Reemplazar espacios con guiones bajos
        nombre_limpio = re.sub(r'\s+', '_', nombre_limpio)
        return nombre_limpio
    
    try:
        # Usar ruta relativa para que funcione en cualquier computadora
        base_dir = os.path.dirname(os.path.abspath(__file__))
        user_id_limpio = re.sub(r'[^a-zA-Z0-9_-]', '', str(user_id))
        output_path = os.path.join(base_dir, 'ptmp_site_survey', f'ss_ptmp_{user_id_limpio}.xlsx')
        
        if not os.path.exists(output_path):
            return f"Archivo no encontrado: {output_path}"
        
        @after_this_request
        def eliminar_archivos_temporales(response):
            try:
                # Esperar un poco para asegurar que la descarga se complete
                import time
                time.sleep(3)
                
                if os.path.exists(output_path):
                    try:
                        os.remove(output_path)
                        print(f"‚úÖ Archivo temporal eliminado: {output_path}")
                    except PermissionError:
                        print(f"‚ö†Ô∏è Archivo en uso, programando eliminaci√≥n posterior: {output_path}")
                        # Programar eliminaci√≥n posterior
                        import threading
                        def eliminar_luego():
                            time.sleep(10)  # Esperar 10 segundos m√°s
                            try:
                                if os.path.exists(output_path):
                                    os.remove(output_path)
                                    print(f"‚úÖ Archivo temporal eliminado posteriormente: {output_path}")
                            except Exception as e2:
                                print(f"‚ùå Error en eliminaci√≥n posterior: {e2}")
                        
                        thread = threading.Thread(target=eliminar_luego)
                        thread.daemon = True
                        thread.start()
                    except Exception as e:
                        print(f"‚ùå Error eliminando archivo temporal: {e}")
                else:
                    print(f"‚ö†Ô∏è Archivo no encontrado para eliminar: {output_path}")
            except Exception as e:
                print(f"‚ùå Error en limpieza de archivo temporal: {e}")
            return response
        
        # Limpiar archivos temporales antiguos antes de enviar el archivo
        limpiar_archivos_temporales_ptmp()
        
        return send_file(output_path, as_attachment=True)
    except Exception as e:
        return f"Error descargando archivo: {e}"

@app.route('/limpiar_archivos_temp')
def limpiar_archivos_temp():
    """Ruta para limpiar manualmente archivos temporales"""
    try:
        limpiar_archivos_temporales_ptmp()
        return "‚úÖ Limpieza de archivos temporales completada"
    except Exception as e:
        return f"‚ùå Error en limpieza: {e}"

@app.route('/limpiar_archivos_temp_forzado')
def limpiar_archivos_temp_forzado():
    """Ruta para limpiar forzadamente archivos temporales (incluye cierre de Excel)"""
    try:
        print("üîÑ Iniciando limpieza forzada...")
        forzar_cierre_excel()
        time.sleep(3)
        limpiar_archivos_temporales_ptmp()
        return "‚úÖ Limpieza forzada de archivos temporales completada"
    except Exception as e:
        return f"‚ùå Error en limpieza forzada: {e}"

def forzar_cierre_excel():
    """Fuerza el cierre de procesos de Excel que puedan estar bloqueando archivos"""
    try:
        import subprocess
        import time
        
        # Usar tasklist para buscar procesos de Excel
        try:
            result = subprocess.run(['tasklist', '/FI', 'IMAGENAME eq excel.exe'], 
                                  capture_output=True, text=True)
            
            if 'excel.exe' in result.stdout:
                print("üîç Encontrados procesos de Excel activos")
                # Forzar cierre de todos los procesos de Excel
                subprocess.run(['taskkill', '/f', '/im', 'excel.exe'], capture_output=True)
                print("üîÑ Procesos de Excel terminados")
                time.sleep(2)
            else:
                print("‚úÖ No se encontraron procesos de Excel activos")
                
        except Exception as e:
            print(f"‚ö†Ô∏è Error buscando procesos de Excel: {e}")
            
    except Exception as e:
        print(f"‚ö†Ô∏è Error forzando cierre de Excel: {e}")

def limpiar_archivos_temporales_ptmp():
    """Limpia archivos temporales de PtMP que tengan m√°s de 1 hora"""
    import os
    import time
    import glob
    
    try:
        base_dir = os.path.dirname(os.path.abspath(__file__))
        ptmp_dir = os.path.join(base_dir, 'ptmp_site_survey')
        
        if not os.path.exists(ptmp_dir):
            return
            
        # Buscar archivos temporales de PtMP
        patron = os.path.join(ptmp_dir, 'ss_ptmp_*.xlsx')
        archivos_temp = glob.glob(patron)
        
        tiempo_actual = time.time()
        archivos_eliminados = 0
        
        for archivo in archivos_temp:
            try:
                # Obtener el tiempo de modificaci√≥n del archivo
                tiempo_modificacion = os.path.getmtime(archivo)
                tiempo_diferencia = tiempo_actual - tiempo_modificacion
                
                # Eliminar archivos con m√°s de 1 hora (3600 segundos)
                if tiempo_diferencia > 3600:
                    try:
                        os.remove(archivo)
                        print(f"üóëÔ∏è Archivo temporal antiguo eliminado: {os.path.basename(archivo)}")
                        archivos_eliminados += 1
                    except PermissionError:
                        print(f"‚ö†Ô∏è Archivo temporal en uso, no se puede eliminar: {os.path.basename(archivo)}")
                    except Exception as e:
                        print(f"‚ö†Ô∏è Error eliminando archivo temporal {os.path.basename(archivo)}: {e}")
                    
            except Exception as e:
                print(f"‚ö†Ô∏è Error procesando archivo temporal {archivo}: {e}")
                
        if archivos_eliminados > 0:
            print(f"üßπ Limpieza completada: {archivos_eliminados} archivos temporales eliminados")
        else:
            print("‚ú® No se encontraron archivos temporales para limpiar")
            
    except Exception as e:
        print(f"‚ùå Error en limpieza de archivos temporales: {e}")

@app.route('/reporte_planeacion')
def reporte_planeacion():
    import pandas as pd
    user_id = request.args.get('user_id', '')
    fila_idx = request.args.get('fila_idx', '')
    datos = None
    if fila_idx:
        try:
            df_db = pd.read_csv(GOOGLE_SHEETS_CSV_URL)
            row = df_db.loc[int(fila_idx)]
            datos = row.to_dict()
        except Exception as e:
            return f"Error leyendo base de datos: {e}"
    if datos:
        html = f"""
        <h2 style='color:#00c3ff;text-align:center;margin-top:40px;'>Reporte de Planeaci√≥n (Autollenado)</h2>
        <div style='max-width:500px;margin:30px auto;background:#16213e;padding:28px 32px;border-radius:16px;box-shadow:0 4px 24px #00c3ff33;'>
        <b>ID:</b> {datos.get('ID','')}<br>
        <b>Nombre del sitio A:</b> {datos.get('Nombre del sitio A','')}<br>
        <b>Nombre del sitio B:</b> {datos.get('Nombre del sitio B','')}<br>
        <b>Estado:</b> {datos.get('ESTADO','')}<br>
        <b>Tipo de Zona:</b> {datos.get('Tipo de Zona','')}<br>
        </div>
        <div style='text-align:center;margin-top:18px;'><a href='/' style='color:#00c3ff;'>Volver al inicio</a></div>
        """
        return html
    return "<h2 style='color:#00c3ff;text-align:center;margin-top:60px;'>Formulario Reporte de Planeaci√≥n (en construcci√≥n)</h2>"
from flask import render_template, redirect, url_for

@app.route('/formulario_archivos', methods=['GET'])
def formulario_archivos():
    import pandas as pd
    user_id = request.args.get('user_id', '')
    fila_idx = request.args.get('fila_idx', '')
    id_sitio = user_id
    sitio_a = ''
    sitio_b = ''
    if fila_idx:
        try:
            df_db = pd.read_csv(GOOGLE_SHEETS_CSV_URL)
            row = df_db.loc[int(fila_idx)]
            id_sitio = row.get('ID', '') or ''
            sitio_a = row.get('Nombre del sitio A', '') or ''
            sitio_b = row.get('Nombre del sitio B', '') or ''
            if pd.isna(sitio_a): sitio_a = ''
            if pd.isna(sitio_b): sitio_b = ''
        except Exception as e:
            print(f"Error leyendo Google Sheets en formulario_archivos: {e}")
    html_form_mod = html_form.replace(
        '<form id="autoForm" action="/procesar" method="post" enctype="multipart/form-data" autocomplete="off">',
        '<form id="autoForm" action="/procesar" method="post" enctype="multipart/form-data" autocomplete="off">'
        f'\n<input type="hidden" name="user_id" value="{user_id}">'\
        f'\n<input type="hidden" name="fila_idx" value="{fila_idx}">'\
    )
    html_form_mod = html_form_mod.replace(
        '<!-- ANALISIS_AQUI -->',
        f'''
<div class="info-container">
    <div class="info-item"><i class="fas fa-id-card"></i> <span><strong>ID:</strong> {id_sitio}</span></div>
    <div class="info-item"><i class="fas fa-map-marker-alt"></i> <span><strong>Sitio A:</strong> {sitio_a}</span></div>
    <div class="info-item"><i class="fas fa-map-marker-alt"></i> <span><strong>Sitio B:</strong> {sitio_b}</span></div>
</div>
''')
    
    return render_template_string(html_form_mod)

@app.route('/seleccion', methods=['POST'])
def seleccion():
    import pandas as pd
    user_id = request.form.get('user_id')
    fila_idx = request.form.get('fila_idx')
    db_path = request.form.get('db_path')

    df_db = pd.read_excel(db_path, engine='openpyxl')
    if not fila_idx:
        return "Falta el √≠ndice de fila"
    fila_idx_int = int(fila_idx)
    row = df_db.loc[fila_idx_int]

    id_sitio = row.get('ID', '') or ''
    sitio_a = row.get('Nombre del sitio A', '') or ''
    sitio_b = row.get('Nombre del sitio B', '') or ''
    # Evita mostrar 'nan'
    if pd.isna(sitio_a): sitio_a = ''
    if pd.isna(sitio_b): sitio_b = ''

    return redirect(url_for(
        'formulario_archivos',
        user_id=user_id,
        fila_idx=fila_idx,
        db_path=db_path,
        id_sitio=id_sitio,
        sitio_a=sitio_a,
        sitio_b=sitio_b
    ))
def buscar_archivo_diseno_solucion(user_id):
    """Funci√≥n helper para buscar el archivo de dise√±o de soluci√≥n m√°s reciente del usuario"""
    try:
        archivos_generados_dir = os.path.join(base_dir, 'archivos_generados')
        if not os.path.exists(archivos_generados_dir):
            return None, "‚ùå Error: No se encontr√≥ directorio de archivos generados"
        
        # Buscar archivos que empiecen con 'ds_diseno_solucion_' y el user_id
        archivos_usuario = [f for f in os.listdir(archivos_generados_dir) 
                           if f.startswith(f'ds_diseno_solucion_{user_id}_') and f.endswith('.xlsx')]
        
        if not archivos_usuario:
            return None, "‚ùå Error: No se encontr√≥ archivo de dise√±o de soluci√≥n para este usuario"
        
        # Tomar el archivo m√°s reciente
        archivo_excel = sorted(archivos_usuario)[-1]
        ruta_excel = os.path.join(archivos_generados_dir, archivo_excel)
        return ruta_excel, None
        
    except Exception as e:
        return None, f"‚ùå Error al buscar archivo: {str(e)}"


def verificar_archivo_disponible(ruta_archivo):
    """Funci√≥n helper para verificar si un archivo est√° disponible para modificaci√≥n"""
    try:
        # Verificar si el archivo existe
        if not os.path.exists(ruta_archivo):
            return False, "‚ùå Error: El archivo no existe"
        
        # Verificar si el archivo est√° en uso (intentar abrirlo en modo exclusivo)
        try:
            with open(ruta_archivo, 'r+b') as f:
                pass
        except PermissionError:
            return False, "‚ùå Error: El archivo est√° siendo usado por otro programa (Microsoft Excel, OneDrive, etc.)"
        except Exception as e:
            return False, f"‚ùå Error al verificar archivo: {str(e)}"
        
        return True, None
        
    except Exception as e:
        return False, f"‚ùå Error general: {str(e)}"


@app.route('/insertar_word_diseno', methods=['POST'])
def insertar_word_diseno():
    """Ruta espec√≠fica para insertar solo archivo Word en dise√±o de soluci√≥n existente"""
    
    print(f"üöÄ DEBUG: Funci√≥n insertar_word_diseno iniciada")
    
    # Obtener datos del formulario
    user_id = request.form.get('user_id')
    fila_idx = request.form.get('fila_idx')
    
    print(f"üîç DEBUG: user_id = {user_id}, fila_idx = {fila_idx}")
    
    if not user_id:
        return "‚ùå Error: Falta el ID de usuario"
    
    try:
        # Buscar el archivo Excel m√°s reciente del usuario
        ruta_excel, error = buscar_archivo_diseno_solucion(user_id)
        if error:
            return error
        
        # Verificar que el archivo est√© disponible para modificaci√≥n
        disponible, error = verificar_archivo_disponible(ruta_excel)
        if not disponible:
            return error
        
        # Obtener el archivo Word
        word_file = request.files.get('word_file')
        if not word_file or not word_file.filename:
            return "‚ùå Error: No se recibi√≥ archivo Word"
        
        # Guardar el archivo Word temporalmente
        temp_dir = os.path.join(base_dir, 'temp_archivos')
        os.makedirs(temp_dir, exist_ok=True)
        
        ruta_word = os.path.join(temp_dir, secure_filename(word_file.filename))
        word_file.save(ruta_word)
        
        # Insertar el Word en el Excel usando xlwings
        try:
            import xlwings as xw
            app_excel = xw.App(visible=False)
            app_excel.display_alerts = False
            app_excel.screen_updating = False
            
            print(f"üîç DEBUG: Intentando abrir archivo Excel: {ruta_excel}")
            
            # Intentar abrir el archivo con manejo de errores
            try:
                wb = app_excel.books.open(ruta_excel)
                print(f"‚úÖ DEBUG: Archivo Excel abierto exitosamente")
            except Exception as open_error:
                # Si no se puede abrir, puede estar en uso
                print(f"‚ùå DEBUG: Error al abrir Excel: {open_error}")
                app_excel.quit()
                return f"‚ùå Error: No se puede abrir el archivo Excel. Aseg√∫rate de que no est√© abierto en Microsoft Excel. Detalle: {str(open_error)}"
            
            try:
                print(f"üîç DEBUG: Accediendo a hoja '1. An√°lisis de Red y Frecuencia'")
                # Hoja: "1. An√°lisis de Red y Frecuencia" en D12
                ws_word = wb.sheets['1. An√°lisis de Red y Frecuencia']
                cell_range = ws_word.range('D12')
                print(f"‚úÖ DEBUG: Hoja accedida, rango D12 obtenido")
                
                print(f"üîç DEBUG: Insertando archivo Word en D12...")
                # Insertar el archivo Word como imagen/objeto
                ws_word.pictures.add(
                    os.path.abspath(ruta_word),
                    left=cell_range.left,
                    top=cell_range.top,
                    width=cell_range.width * 2,  # Hacer el objeto un poco m√°s grande
                    height=cell_range.height * 2
                )
                print(f"‚úÖ DEBUG: Archivo Word insertado en D12")
                
                print(f"üîç DEBUG: Guardando archivo Excel...")
                # Guardar y cerrar
                wb.save()
                print(f"‚úÖ DEBUG: Archivo Excel guardado exitosamente")
                wb.close()
                app_excel.quit()
                print(f"‚úÖ DEBUG: Excel cerrado correctamente")
                
                # Limpiar archivo temporal
                if os.path.exists(ruta_word):
                    os.remove(ruta_word)
                    print(f"‚úÖ DEBUG: Archivo temporal Word eliminado")
                
                return "‚úÖ Archivo Word insertado exitosamente en D12 de la hoja 'An√°lisis de Red y Frecuencia'"
                
            except Exception as e:
                print(f"‚ùå DEBUG: Error durante la inserci√≥n: {e}")
                # Cerrar Excel en caso de error
                try:
                    if 'wb' in locals():
                        wb.close()
                    app_excel.quit()
                except:
                    pass
                raise e
                
        except Exception as e:
            print(f"‚ùå DEBUG: Error general en xlwings: {e}")
            # Limpiar archivo temporal en caso de error
            if os.path.exists(ruta_word):
                os.remove(ruta_word)
            return f"‚ùå Error al insertar archivo Word: {str(e)}"
            
    except Exception as e:
        return f"‚ùå Error general: {str(e)}"


@app.route('/insertar_imagenes_electricas', methods=['POST'])
def insertar_imagenes_electricas():
    """Ruta espec√≠fica para insertar solo im√°genes el√©ctricas en dise√±o de soluci√≥n existente"""
    
    print(f"üöÄ DEBUG: Funci√≥n insertar_imagenes_electricas iniciada")
    
    # Obtener datos del formulario
    user_id = request.form.get('user_id')
    fila_idx = request.form.get('fila_idx')
    
    print(f"üîç DEBUG: user_id = {user_id}, fila_idx = {fila_idx}")
    
    if not user_id:
        return "‚ùå Error: Falta el ID de usuario"
    
    try:
        # Buscar el archivo Excel m√°s reciente del usuario
        ruta_excel, error = buscar_archivo_diseno_solucion(user_id)
        if error:
            return error
        
        # Verificar que el archivo est√© disponible para modificaci√≥n
        disponible, error = verificar_archivo_disponible(ruta_excel)
        if not disponible:
            return error
        
        # Obtener las 3 im√°genes el√©ctricas
        imagen1 = request.files.get('imagen_electrica_1')
        imagen2 = request.files.get('imagen_electrica_2')
        imagen3 = request.files.get('imagen_electrica_3')
        
        if not all([imagen1, imagen2, imagen3]):
            return "‚ùå Error: Faltan una o m√°s im√°genes el√©ctricas"
        
        # Guardar las im√°genes temporalmente
        temp_dir = os.path.join(base_dir, 'temp_imagenes')
        os.makedirs(temp_dir, exist_ok=True)
        
        ruta_img1 = os.path.join(temp_dir, secure_filename(imagen1.filename))
        ruta_img2 = os.path.join(temp_dir, secure_filename(imagen2.filename))
        ruta_img3 = os.path.join(temp_dir, secure_filename(imagen3.filename))
        
        imagen1.save(ruta_img1)
        imagen2.save(ruta_img2)
        imagen3.save(ruta_img3)
        
        # Insertar las im√°genes en el Excel usando xlwings
        try:
            import xlwings as xw
            app_excel = xw.App(visible=False)
            app_excel.display_alerts = False
            app_excel.screen_updating = False
            
            print(f"üîç DEBUG: Intentando abrir archivo Excel: {ruta_excel}")
            
            # Intentar abrir el archivo con manejo de errores
            try:
                wb = app_excel.books.open(ruta_excel)
                print(f"‚úÖ DEBUG: Archivo Excel abierto exitosamente")
            except Exception as open_error:
                # Si no se puede abrir, puede estar en uso
                print(f"‚ùå DEBUG: Error al abrir Excel: {open_error}")
                app_excel.quit()
                return f"‚ùå Error: No se puede abrir el archivo Excel. Aseg√∫rate de que no est√© abierto en Microsoft Excel. Detalle: {str(open_error)}"
            
            try:
                print(f"üîç DEBUG: Accediendo a hoja '2. El√©ctricas - Dise√±o Log-Fis'")
                # Hoja: "2. El√©ctricas - Dise√±o Log-Fis"
                ws_electricas = wb.sheets['2. El√©ctricas - Dise√±o Log-Fis']
                
                print(f"üîç DEBUG: Insertando Imagen 1 en C14:D20...")
                # Insertar Imagen 1 en C14:D20
                ws_electricas.pictures.add(
                    ruta_img1,
                    left=ws_electricas.range('C14').left,
                    top=ws_electricas.range('C14').top,
                    width=ws_electricas.range('C14:D20').width,
                    height=ws_electricas.range('C14:D20').height
                )
                print(f"‚úÖ DEBUG: Imagen 1 insertada en C14:D20")
                
                print(f"üîç DEBUG: Insertando Imagen 2 en E14:G20...")
                # Insertar Imagen 2 en E14:G20
                ws_electricas.pictures.add(
                    ruta_img2,
                    left=ws_electricas.range('E14').left,
                    top=ws_electricas.range('E14').top,
                    width=ws_electricas.range('E14:G20').width,
                    height=ws_electricas.range('E14:G20').height
                )
                print(f"‚úÖ DEBUG: Imagen 2 insertada en E14:G20")
                
                print(f"üîç DEBUG: Insertando Imagen 3 en B39:G55...")
                # Insertar Imagen 3 en B39:G55
                ws_electricas.pictures.add(
                    ruta_img3,
                    left=ws_electricas.range('B39').left,
                    top=ws_electricas.range('B39').top,
                    width=ws_electricas.range('B39:G55').width,
                    height=ws_electricas.range('B39:G55').height
                )
                print(f"‚úÖ DEBUG: Imagen 3 insertada en B39:G55")
                
                print(f"üîç DEBUG: Guardando archivo Excel...")
                # Guardar y cerrar
                wb.save()
                print(f"‚úÖ DEBUG: Archivo Excel guardado exitosamente")
                wb.close()
                app_excel.quit()
                print(f"‚úÖ DEBUG: Excel cerrado correctamente")
                
                # Limpiar archivos temporales
                for ruta_temp in [ruta_img1, ruta_img2, ruta_img3]:
                    if os.path.exists(ruta_temp):
                        os.remove(ruta_temp)
                        print(f"‚úÖ DEBUG: Archivo temporal eliminado: {ruta_temp}")
                
                return "‚úÖ Im√°genes el√©ctricas insertadas exitosamente"
                
            except Exception as e:
                print(f"‚ùå DEBUG: Error durante la inserci√≥n: {e}")
                # Cerrar Excel en caso de error
                try:
                    if 'wb' in locals():
                        wb.close()
                    app_excel.quit()
                except:
                    pass
                raise e
                
        except Exception as e:
            print(f"‚ùå DEBUG: Error general en xlwings: {e}")
            # Limpiar archivos temporales en caso de error
            for ruta_temp in [ruta_img1, ruta_img2, ruta_img3]:
                if os.path.exists(ruta_temp):
                    os.remove(ruta_temp)
            return f"‚ùå Error al insertar im√°genes: {str(e)}"
            
    except Exception as e:
        return f"‚ùå Error general: {str(e)}"


@app.route('/buscar_puntas_b_disponibles', methods=['POST'])
def buscar_puntas_b_disponibles():
    """Ruta para buscar todas las puntas B disponibles para llenado"""
    
    try:
        print(f"üîç DEBUG: Buscando TODAS las puntas B disponibles...")
        
        # Leer la base de datos de Google Sheets
        try:
            df_db = pd.read_csv(GOOGLE_SHEETS_CSV_URL, keep_default_na=False, na_values=[])
            print(f"üìä DEBUG: Base de datos cargada, {len(df_db)} registros encontrados")
        except Exception as e:
            print(f"‚ùå ERROR: No se pudo cargar la base de datos: {e}")
            return jsonify({'success': False, 'error': f'Error cargando base de datos: {str(e)}'})
        
        opciones_disponibles = []
        
        for idx, fila in df_db.iterrows():
            sitio_a = fila.get('Nombre del sitio A', '')
            sitio_b = fila.get('Nombre del sitio B', '')
            
            # Verificar que tenga sitios v√°lidos y diferentes
            if (sitio_a and sitio_b and 
                str(sitio_a).strip() != '' and str(sitio_b).strip() != '' and
                str(sitio_a).strip() != str(sitio_b).strip()):
                
                opcion = {
                    'user_id': str(fila.get('ID', '')),
                    'fila_idx': int(idx),
                    'sitio_a': str(sitio_a),
                    'sitio_b': str(sitio_b),
                    'cliente': str(fila.get('Cliente', '')),
                    'proyecto': str(fila.get('Proyecto', ''))
                }
                opciones_disponibles.append(opcion)
                print(f"‚úÖ DEBUG: Opci√≥n encontrada - ID: {opcion['user_id']}, A: {opcion['sitio_a']}, B: {opcion['sitio_b']}")
        
        print(f"üìä DEBUG: Total de opciones disponibles: {len(opciones_disponibles)}")
        
        if not opciones_disponibles:
            return jsonify({'success': False, 'error': 'No se encontraron usuarios con puntas B diferentes en la base de datos'})
        
        # Ordenar por ID para facilitar la selecci√≥n
        opciones_disponibles.sort(key=lambda x: x['user_id'])
        
        respuesta = {
            'success': True,
            'mensaje': f'Se encontraron {len(opciones_disponibles)} opciones disponibles para llenado',
            'opciones': opciones_disponibles
        }
        
        print(f"‚úÖ DEBUG: Respuesta preparada con {len(opciones_disponibles)} opciones")
        
        try:
            return jsonify(respuesta)
        except Exception as json_error:
            print(f"‚ùå ERROR en jsonify: {json_error}")
            return jsonify({
                'success': False,
                'error': f'Error en serializaci√≥n JSON: {str(json_error)}'
            })
        
    except Exception as e:
        print(f"‚ùå ERROR en buscar_puntas_b_disponibles: {e}")
        return jsonify({'success': False, 'error': f'Error interno: {str(e)}'})

@app.route('/verificar_punta_b_e_iniciar_llenado', methods=['POST'])
def verificar_punta_b_e_iniciar_llenado():
    """Ruta para verificar punta B diferente e iniciar nuevo llenado autom√°tico"""
    
    try:
        data = request.get_json()
        user_id = data.get('user_id')
        
        if not user_id:
            return jsonify({'success': False, 'error': 'Falta el ID de usuario'})
        
        print(f"üîç DEBUG: Verificando punta B para usuario: {user_id}")
        
        # Leer la base de datos de Google Sheets
        try:
            df_db = pd.read_csv(GOOGLE_SHEETS_CSV_URL, keep_default_na=False, na_values=[])
        except Exception as e:
            return jsonify({'success': False, 'error': f'Error leyendo base de datos: {str(e)}'})
        
        # Buscar el usuario en la base de datos
        coincidencias = df_db[df_db['ID'] == user_id]
        print(f"üîç DEBUG: Coincidencias encontradas: {len(coincidencias)}")
        print(f"üîç DEBUG: Tipo de coincidencias.index: {type(coincidencias.index)}")
        print(f"üîç DEBUG: Valor de coincidencias.index[0]: {coincidencias.index[0]}")
        print(f"üîç DEBUG: Tipo de coincidencias.index[0]: {type(coincidencias.index[0])}")
        
        if coincidencias.empty:
            return jsonify({'success': False, 'error': f'Usuario {user_id} no encontrado en la base de datos'})
        
        datos_usuario = coincidencias.iloc[0]
        print(f"üîç DEBUG: Datos del usuario obtenidos correctamente")
        
        # Verificar si tiene punta B diferente
        sitio_a = datos_usuario.get('Nombre del sitio A', '')
        sitio_b = datos_usuario.get('Nombre del sitio B', '')
        
        print(f"üîç DEBUG: Sitio A: {sitio_a}, Sitio B: {sitio_b}")
        print(f"üîç DEBUG: Tipo de sitio_a: {type(sitio_a)}, Tipo de sitio_b: {type(sitio_b)}")
        
        if sitio_a == sitio_b or not sitio_b:
            return jsonify({
                'success': False, 
                'error': f'El usuario {user_id} no tiene punta B diferente. Sitio A: {sitio_a}, Sitio B: {sitio_b}'
            })
        
        # Si tiene punta B diferente, iniciar el proceso de llenado
        print(f"‚úÖ DEBUG: Usuario {user_id} tiene punta B diferente. Iniciando llenado...")
        
        # Convertir el √≠ndice a int normal para evitar problemas de serializaci√≥n
        fila_idx = int(coincidencias.index[0])
        print(f"üîç DEBUG: fila_idx convertido: {fila_idx} (tipo: {type(fila_idx)})")
        
        # Verificar que el usuario tenga datos v√°lidos para el llenado
        print(f"üîç DEBUG: Verificando datos del usuario para llenado...")
        print(f"üîç DEBUG: Columnas disponibles: {list(datos_usuario.index)}")
        
        # Verificar campos cr√≠ticos
        campos_criticos = ['ID', 'Nombre del sitio A', 'Nombre del sitio B']
        for campo in campos_criticos:
            valor = datos_usuario.get(campo, '')
            print(f"üîç DEBUG: {campo}: {valor} (tipo: {type(valor)})")
        
        print(f"üöÄ DEBUG: Usuario {user_id} verificado y listo para llenado autom√°tico")
        print(f"üöÄ DEBUG: Redirigiendo a /diseno_solucion con llenado_automatico=true")
        
        # Aqu√≠ puedes agregar la l√≥gica para iniciar el llenado autom√°tico
        # Por ahora, solo confirmamos que est√° listo
        
        # Crear respuesta con datos convertidos a tipos serializables
        respuesta = {
            'success': True,
            'mensaje': f'Usuario {user_id} verificado. Sitio A: {sitio_a}, Sitio B: {sitio_b}. Llenado autom√°tico iniciado.',
            'datos': {
                'user_id': str(user_id),  # Convertir a string para asegurar serializaci√≥n
                'sitio_a': str(sitio_a) if sitio_a else '',
                'sitio_b': str(sitio_b) if sitio_b else '',
                'fila_idx': fila_idx  # Ya convertido a int
            }
        }
        
        print(f"üîç DEBUG: Respuesta preparada: {respuesta}")
        
        try:
            return jsonify(respuesta)
        except Exception as json_error:
            print(f"‚ùå DEBUG: Error al serializar JSON: {json_error}")
            # Fallback: respuesta simple sin datos complejos
            return jsonify({
                'success': True,
                'mensaje': f'Usuario {user_id} verificado. Llenado autom√°tico iniciado.',
                'datos': {
                    'user_id': str(user_id),
                    'fila_idx': fila_idx
                }
            })
        
    except Exception as e:
        print(f"‚ùå ERROR en verificar_punta_b_e_iniciar_llenado: {e}")
        return jsonify({'success': False, 'error': f'Error interno: {str(e)}'})

@app.route('/verificar_id_especifico', methods=['POST'])
def verificar_id_especifico():
    """Ruta para verificar si un ID espec√≠fico tiene puntas B diferentes disponibles"""
    
    try:
        data = request.get_json()
        user_id = data.get('user_id')
        
        if not user_id:
            return jsonify({'success': False, 'error': 'Falta el ID de usuario'})
        
        print(f"üîç DEBUG: Verificando ID espec√≠fico: {user_id}")
        
        # Leer la base de datos de Google Sheets
        try:
            df_db = pd.read_csv(GOOGLE_SHEETS_CSV_URL, keep_default_na=False, na_values=[])
        except Exception as e:
            return jsonify({'success': False, 'error': f'Error leyendo base de datos: {str(e)}'})
        
        # Buscar el usuario en la base de datos
        coincidencias = df_db[df_db['ID'] == user_id]
        
        if coincidencias.empty:
            return jsonify({'success': False, 'error': f'Usuario {user_id} no encontrado en la base de datos'})
        
        datos_usuario = coincidencias.iloc[0]
        
        # Verificar si tiene punta B diferente
        sitio_a = datos_usuario.get('Nombre del sitio A', '')
        sitio_b = datos_usuario.get('Nombre del sitio B', '')
        
        if sitio_a == sitio_b or not sitio_b:
            return jsonify({
                'success': False,
                'tiene_puntas_b': False,
                'error': f'El usuario {user_id} no tiene punta B diferente. Sitio A: {sitio_a}, Sitio B: {sitio_b}'
            })
        
        # Si tiene punta B diferente, crear opci√≥n para llenado
        fila_idx = int(coincidencias.index[0])
        
        opcion = {
            'user_id': str(user_id),
            'sitio_a': str(sitio_a) if sitio_a else '',
            'sitio_b': str(sitio_b) if sitio_b else '',
            'cliente': str(datos_usuario.get('Cliente', 'N/A')) if datos_usuario.get('Cliente') else 'N/A',
            'proyecto': str(datos_usuario.get('Proyecto', 'N/A')) if datos_usuario.get('Proyecto') else 'N/A',
            'fila_idx': fila_idx
        }
        
        print(f"‚úÖ DEBUG: ID {user_id} verificado. Tiene puntas B diferentes disponibles.")
        
        return jsonify({
            'success': True,
            'tiene_puntas_b': True,
            'mensaje': f'Usuario {user_id} tiene puntas B diferentes disponibles para llenado autom√°tico.',
            'opciones': [opcion]
        })
        
    except Exception as e:
        print(f"‚ùå ERROR en verificar_id_especifico: {e}")
        return jsonify({'success': False, 'error': f'Error interno: {str(e)}'})


# ===== PLANTILLA PARA FUTURAS RUTAS DE INSERCI√ìN =====
# Para agregar nuevos botones que solo inserten archivos sin hacer llenado:
#
# @app.route('/insertar_[tipo_archivo]_diseno', methods=['POST'])
# def insertar_[tipo_archivo]_diseno():
#     """Ruta espec√≠fica para insertar solo [tipo_archivo] en dise√±o de soluci√≥n existente"""
#     
#     user_id = request.form.get('user_id')
#     fila_idx = request.form.get('fila_idx')
#     
#     if not user_id:
#         return "‚ùå Error: Falta el ID de usuario"
#     
#     try:
#         # Buscar archivo Excel existente
#         ruta_excel, error = buscar_archivo_diseno_solucion(user_id)
#         if error:
#             return error
#         
#         # Obtener archivo
#         archivo = request.files.get('[nombre_campo]')
#         if not archivo or not archivo.filename:
#             return "‚ùå Error: No se recibi√≥ archivo"
#         
#         # Guardar temporalmente
#         temp_dir = os.path.join(base_dir, 'temp_archivos')
#         os.makedirs(temp_dir, exist_ok=True)
#         ruta_temp = os.path.join(temp_dir, secure_filename(archivo.filename))
#         archivo.save(ruta_temp)
#         
#         # Insertar en Excel usando xlwings
#         try:
#             import xlwings as xw
#             app_excel = xw.App(visible=False)
#             app_excel.display_alerts = False
#             wb = app_excel.books.open(ruta_excel)
#             
#             # Especificar hoja y posici√≥n
#             ws = wb.sheets['[Nombre de la Hoja]']
#             
#             # Insertar archivo en posici√≥n espec√≠fica
#             ws.pictures.add(
#                 ruta_temp,
#                 left=ws.range('[CELDA]').left,
#                 top=ws.range('[CELDA]').top,
#                 width=ws.range('[RANGO]').width,
#                 height=ws.range('[RANGO]').height
#             )
#             
#             # Guardar y cerrar
#             wb.save()
#             wb.close()
#             app_excel.quit()
#             
#             # Limpiar archivo temporal
#             if os.path.exists(ruta_temp):
#                 os.remove(ruta_temp)
#             
#             return "‚úÖ [Tipo de archivo] insertado exitosamente en [posici√≥n]"
#             
#         except Exception as e:
#             # Limpiar en caso de error
#             if os.path.exists(ruta_temp):
#                 os.remove(ruta_temp)
#             return f"‚ùå Error al insertar: {str(e)}"
#             
#     except Exception as e:
#         return f"‚ùå Error general: {str(e)}"


@app.route('/procesar', methods=['POST'])
def procesar():
    import pandas as pd
    import shutil
    import os
    import time
    import xlwings as xw
    import re
    from werkzeug.utils import secure_filename
    
    # Definir base_dir
    base_dir = os.path.dirname(os.path.abspath(__file__))

    print("=== INICIO PROCESAR ===")
    print(f"DEBUG: request.files.keys() = {list(request.files.keys())}")
    print(f"DEBUG: request.form.keys() = {list(request.form.keys())}")
    
    # Debug: mostrar todos los archivos recibidos
    print("=== ARCHIVOS RECIBIDOS ===")
    for key, file_list in request.files.lists():
        if isinstance(file_list, list):
            for i, file in enumerate(file_list):
                if file and file.filename:
                    print(f"  {key}[{i}]: {file.filename} ({file.content_type})")
        else:
            if file_list and file_list.filename:
                print(f"  {key}: {file_list.filename} ({file_list.content_type})")
    print("=== FIN ARCHIVOS RECIBIDOS ===")
    
    fila_idx = request.form.get('fila_idx')
    user_id = request.form.get('user_id')
    tipo = request.form.get('tipo', 'site_survey')  # Por defecto site_survey si no se especifica
    print(f"DEBUG: Tipo recibido en procesar: '{tipo}'")

    # Usar siempre la plantilla fija
    template_path = TEMPLATE_PATH
    template_filename = os.path.basename(TEMPLATE_PATH)
    if not os.path.exists(template_path):
        return f"Falta la plantilla fija en la ruta esperada: {template_path}"

    # --- NUEVO: Usar Google Sheets fijo como base de datos ---
    try:
        df_db = pd.read_csv(GOOGLE_SHEETS_CSV_URL, keep_default_na=False, na_values=[])
    except Exception as e:
        return f"Error leyendo la base de datos de Google Sheets: {e}"

    # --- CORRECCI√ìN: Definir output_path seg√∫n el tipo de documento ---
    if tipo == 'diseno_solucion':
        # Para dise√±o de soluci√≥n, guardar en archivos_generados con nombre ds_
        archivos_generados_dir = os.path.join(base_dir, 'archivos_generados')
        os.makedirs(archivos_generados_dir, exist_ok=True)
        timestamp = time.strftime('%Y%m%d_%H%M%S')
        user_id_limpio = re.sub(r'[^a-zA-Z0-9_-]', '', str(user_id))
        output_path = os.path.join(archivos_generados_dir, f'ds_diseno_solucion_{user_id_limpio}_{timestamp}.xlsx')
        print(f"DEBUG: Archivo de dise√±o de soluci√≥n se guardar√° en: {output_path}")
    else:
        # Para otros tipos, usar la l√≥gica original
        output_path = os.path.join(UPLOAD_FOLDER, f'LLENADO_{template_filename or "template.xlsx"}')
        print(f"DEBUG: Archivo se guardar√° en: {output_path}")

    # --- 1. Recibe y guarda archivos ---
    imagenes = request.files.getlist('imagenes_electricas')  # Cambiado de 'imagenes' a 'imagenes_electricas'
    pdf_paths = []
    pdfs = request.files.getlist('pdf_file')  # Cambiado de 'pdfs' a 'pdf_file'
    print(f"DEBUG: pdfs recibidos = {len(pdfs)}")
    for idx, pdf in enumerate(pdfs):
        print(f"DEBUG: pdf {idx}: {pdf.filename if pdf else 'None'}")
    
    for idx, pdf in enumerate(pdfs):
        if pdf and pdf.filename:
            filename = secure_filename(f"{idx}_{pdf.filename}")
            pdf_path = os.path.join(UPLOAD_FOLDER, filename)
            pdf.save(pdf_path)
            pdf_paths.append(pdf_path)
            print(f"DEBUG: PDF guardado: {pdf_path}")
        else:
            print(f"DEBUG: PDF {idx} no v√°lido: {pdf}")
    
    print(f"DEBUG: pdf_paths final = {pdf_paths}")
    
    print(f"DEBUG: imagenes recibidas = {len(imagenes)}")
    for idx, img in enumerate(imagenes):
        print(f"DEBUG: imagen {idx}: {img.filename if img else 'None'}")
    
    imagen_paths = []
    for idx, img in enumerate(imagenes):
        if img and img.filename:
            filename = secure_filename(f"{idx}_{img.filename}")
            img_path = os.path.join(UPLOAD_FOLDER, filename)
            img.save(img_path)
            imagen_paths.append(img_path)
            print(f"DEBUG: Imagen guardada: {img_path}")
        else:
            print(f"DEBUG: Imagen {idx} no v√°lida: {img}")
    
    print(f"DEBUG: imagen_paths final = {imagen_paths}")
    
    if not user_id:
        return "Falta el ID"

    # --- SELECCI√ìN DEL REGISTRO CORRECTO ---
    if fila_idx is not None and fila_idx != "":
        try:
            datos = df_db.loc[int(fila_idx)]
        except (ValueError, TypeError):
            return "√çndice de fila inv√°lido"
    else:
        coincidencias = df_db[df_db['ID'] == user_id]
        if coincidencias.empty:
            return "ID no encontrado en la base de datos."
        datos = coincidencias.iloc[0]

    # Para depuraci√≥n: imprime las columnas disponibles
    print("Columnas disponibles:", list(datos.index))

    imagen_b_file = request.files.get('imagen_b')
    imagen_b_path = None
    if imagen_b_file and imagen_b_file.filename:
        imagen_b_filename = secure_filename(imagen_b_file.filename or "")
        imagen_b_path = os.path.join(UPLOAD_FOLDER, imagen_b_filename)
        imagen_b_file.save(imagen_b_path)

    archivo_excel_b = request.files.get('archivo_excel_b')
    archivo_excel_b_path = None
    if archivo_excel_b and archivo_excel_b.filename:
        archivo_excel_b_filename = secure_filename(archivo_excel_b.filename or "")
        archivo_excel_b_path = os.path.join(UPLOAD_FOLDER, archivo_excel_b_filename)
        if os.path.exists(archivo_excel_b_path):
            try:
               os.remove(archivo_excel_b_path)
            except Exception as e:
                return f"Error: No se pudo eliminar el archivo de destino. Detalle: {e}"
        archivo_excel_b.save(archivo_excel_b_path)

    
    word_file = request.files.get('word_file')
    word_file_path = None
    if word_file and word_file.filename:
        word_file_filename = secure_filename(word_file.filename or "")
        word_file_path = os.path.join(UPLOAD_FOLDER, word_file_filename)
        word_file.save(word_file_path)
    
    imagenes_electricas = request.files.getlist('imagenes_electricas')
    imagenes_electricas_paths = []
    for idx, img in enumerate(imagenes_electricas):
        if img and img.filename:
            filename = secure_filename(f"electricas_{idx}_{img.filename}")
            img_path = os.path.join(UPLOAD_FOLDER, filename)
            img.save(img_path)
            imagenes_electricas_paths.append(img_path)

    from docx import Document
    import re

    enlace_principal = ""
    nombreEnlace = ""
    if word_file_path and os.path.exists(word_file_path):
        doc = Document(word_file_path)
        word_text = "\n".join([p.text for p in doc.paragraphs])
        print("WORD TEXT:", word_text)
        for line in word_text.splitlines():
            print("LINE:", line)
            m = re.search(r'Transmission details\s*\(([^)]*)\)', line, re.IGNORECASE)
            if m:
                nombreEnlace = m.group(1)
                nombreEnlace = re.sub(r'\s*\(cambio\)\s*', '', nombreEnlace, flags=re.IGNORECASE)
                nombreEnlace = re.sub(r'\.pl6\s*$', '', nombreEnlace, flags=re.IGNORECASE)
                nombreEnlace = nombreEnlace.strip()
                # SEPARA LOS NOMBRES SI HAY UN GUION Y N√öMEROS
                partes = re.split(r'\d+[A-Z]-', nombreEnlace)
                if len(partes) >= 2:
                    nombre1 = partes[0].strip()
                    nombre2 = partes[1].split()[0].strip()
                enlace_principal = f"{nombre1} - {nombre2}"
            else:
                enlace_principal = nombreEnlace
            break  # Solo el primero
    print("ENLACE PRINCIPAL:", enlace_principal)
      
    img_consumo = request.files.get('img_consumo')
    img_configuracion = request.files.get('img_configuracion')
    img_linea_vista = request.files.get('img_linea_vista')

    img_consumo_path = None
    img_configuracion_path = None
    img_linea_vista_path = None

    if img_consumo and img_consumo.filename:
        img_consumo_path = os.path.join(UPLOAD_FOLDER, secure_filename(img_consumo.filename or ""))
        img_consumo.save(img_consumo_path)
    if img_configuracion and img_configuracion.filename:
        img_configuracion_path = os.path.join(UPLOAD_FOLDER, secure_filename(img_configuracion.filename or ""))
        img_configuracion.save(img_configuracion_path)
    if img_linea_vista and img_linea_vista.filename:
        img_linea_vista_path = os.path.join(UPLOAD_FOLDER, secure_filename(img_linea_vista.filename or ""))
        img_linea_vista.save(img_linea_vista_path)

      # Recibe imagen para hoja 3 (Formato KMZ)
    imagen_kmz_file = request.files.get('imagen_kmz')
    print("imagen_kmz_file:", imagen_kmz_file)
    print("imagen_kmz_file.filename:", imagen_kmz_file.filename if imagen_kmz_file else None)
    imagen_kmz_path = None
    if imagen_kmz_file and imagen_kmz_file.filename:
        imagen_kmz_filename = secure_filename(imagen_kmz_file.filename or "")
        imagen_kmz_path = os.path.join(UPLOAD_FOLDER, imagen_kmz_filename)
        imagen_kmz_file.save(imagen_kmz_path)

    
    
    # output_path ya est√° definido arriba seg√∫n el tipo de documento
    kmz_file = request.files.get('kmz')
    kml_image_file = request.files.get('kml_image')
    print("kml_image_file:", kml_image_file)
    print("kml_image_file.filename:", kml_image_file.filename if kml_image_file else None)
    kml_image_path = None
    if kml_image_file and kml_image_file.filename:
        kml_image_filename = secure_filename(kml_image_file.filename or "")
        kml_image_path = os.path.join(UPLOAD_FOLDER, kml_image_filename)
        kml_image_file.save(kml_image_path)

    kmz_path = None
    if kmz_file and kmz_file.filename:
        kmz_filename = secure_filename(kmz_file.filename or "")
        kmz_path = os.path.join(UPLOAD_FOLDER, kmz_filename)
        kmz_file.save(kmz_path)

    kml_image_path = None
    if kml_image_file and kml_image_file.filename:
       kml_image_filename = secure_filename(kml_image_file.filename or "")
       kml_image_path = os.path.join(UPLOAD_FOLDER, kml_image_filename)
       kml_image_file.save(kml_image_path)
    
    # --- PROCESAR ARCHIVOS ADICIONALES FALTANTES ---
    
    # Archivos de planos A
    planos_a_img1 = request.files.get('planos_a_img1')
    planos_a_img2 = request.files.get('planos_a_img2')
    planos_a_img3 = request.files.get('planos_a_img3')
    
    planos_a_img1_path = None
    planos_a_img2_path = None
    planos_a_img3_path = None
    
    if planos_a_img1 and planos_a_img1.filename:
        planos_a_img1_filename = secure_filename(planos_a_img1.filename or "")
        planos_a_img1_path = os.path.join(UPLOAD_FOLDER, planos_a_img1_filename)
        planos_a_img1.save(planos_a_img1_path)
        print(f"DEBUG: Plano A img1 guardado: {planos_a_img1_path}")
    
    if planos_a_img2 and planos_a_img2.filename:
        planos_a_img2_filename = secure_filename(planos_a_img2.filename or "")
        planos_a_img2_path = os.path.join(UPLOAD_FOLDER, planos_a_img2_filename)
        planos_a_img2.save(planos_a_img2_path)
        print(f"DEBUG: Plano A img2 guardado: {planos_a_img2_path}")
    
    if planos_a_img3 and planos_a_img3.filename:
        planos_a_img3_filename = secure_filename(planos_a_img3.filename or "")
        planos_a_img3_path = os.path.join(UPLOAD_FOLDER, planos_a_img3_filename)
        planos_a_img3.save(planos_a_img3_path)
        print(f"DEBUG: Plano A img3 guardado: {planos_a_img3_path}")
    
    # Archivos de planos B
    planos_b_img1 = request.files.get('planos_b_img1')
    planos_b_img2 = request.files.get('planos_b_img2')
    planos_b_img3 = request.files.get('planos_b_img3')
    
    planos_b_img1_path = None
    planos_b_img2_path = None
    planos_b_img3_path = None
    
    if planos_b_img1 and planos_b_img1.filename:
        planos_b_img1_filename = secure_filename(planos_b_img1.filename or "")
        planos_b_img1_path = os.path.join(UPLOAD_FOLDER, planos_b_img1_filename)
        planos_b_img1.save(planos_b_img1_path)
        print(f"DEBUG: Plano B img1 guardado: {planos_b_img1_path}")
    
    if planos_b_img2 and planos_b_img2.filename:
        planos_b_img2_filename = secure_filename(planos_b_img2.filename or "")
        planos_b_img2_path = os.path.join(UPLOAD_FOLDER, planos_b_img2_filename)
        planos_b_img2.save(planos_b_img2_path)
        print(f"DEBUG: Plano B img2 guardado: {planos_b_img2_path}")
    
    if planos_b_img3 and planos_b_img3.filename:
        planos_b_img3_filename = secure_filename(planos_b_img3.filename or "")
        planos_b_img3_path = os.path.join(UPLOAD_FOLDER, planos_b_img3_filename)
        planos_b_img3.save(planos_b_img3_path)
        print(f"DEBUG: Plano B img3 guardado: {planos_b_img3_path}")
    
    # Archivos de fotos individuales para hoja 9 (Fotos A)
    fotos9_names = [
        "foto_e11", "foto_v11", "foto_e23", "foto_e48", "foto_v48", "foto_e59", "foto_v59",
        "foto_e70", "foto_v70", "foto_e87", "foto_v87", "foto_e98", "foto_v98", "foto_e127",
        "foto_v127", "foto_e138", "foto_v138", "foto_e150", "foto_v150"
    ]
    
    fotos9_paths = {}
    for name in fotos9_names:
        foto_file = request.files.get(name)
        if foto_file and foto_file.filename:
            filename = secure_filename(f"{name}_{foto_file.filename}")
            foto_path = os.path.join(UPLOAD_FOLDER, filename)
            foto_file.save(foto_path)
            fotos9_paths[name] = foto_path
            print(f"DEBUG: Foto {name} guardada: {foto_path}")
        else:
            fotos9_paths[name] = None
    
    # Archivos de fotos individuales para hoja 10 (Fotos B)
    fotos10_names = [
        "foto_b_1", "foto_b_2", "foto_b_3", "foto_b_4", "foto_b_5", "foto_b_6", "foto_b_7", "foto_b_8", "foto_b_9", "foto_b_10"
    ]
    
    fotos10_paths = {}
    for name in fotos10_names:
        foto_file = request.files.get(name)
        if foto_file and foto_file.filename:
            filename = secure_filename(f"{name}_{foto_file.filename}")
            foto_path = os.path.join(UPLOAD_FOLDER, filename)
            foto_file.save(foto_path)
            fotos10_paths[name] = foto_path
            print(f"DEBUG: Foto {name} guardada: {foto_path}")
        else:
            fotos10_paths[name] = None 
    
    # Validar que la plantilla sea un archivo Excel v√°lido antes de abrirla
    try:
        with open(template_path, 'rb') as f:
            signature = f.read(4)
            if signature != b'PK\x03\x04':
                return "Error: La plantilla fija no es un archivo Excel v√°lido (.xlsx). Reemplaza la plantilla por una correcta y sin da√±os."
    except Exception as e:
        return f"Error al validar la plantilla fija: {e}"


    # --- 2. Llenado con xlwings ---
    print(f"DEBUG: Intentando abrir plantilla: {template_path}")
    app_excel = xw.App(visible=False)
    if os.path.exists(output_path):
       try:
          os.remove(output_path)
       except Exception as e:
        print(f"Error: No se pudo eliminar el archivo de salida. Detalle: {e}")
        return f"Error: No se pudo eliminar el archivo de salida. Detalle: {e}"
    try:
        wb = app_excel.books.open(template_path)
    except Exception as e:
        print(f"Error: No se pudo abrir la plantilla de Excel. Detalle: {e}")
        app_excel.quit()
        return "Error: No se pudo abrir la plantilla de Excel. Verifica que el archivo no est√© da√±ado ni abierto en otro programa."
    if wb is None:
        print("Error: wb es None despu√©s de abrir la plantilla.")
        app_excel.quit()
        return "Error: No se pudo abrir la plantilla de Excel. Verifica que el archivo no est√© da√±ado ni abierto en otro programa."
    required_sheets = [
        '4. Estudio de informacion A',
        '1. Analisis de Red y Frecuencia',
        '2. Electricas - Dise√±o log- Fis',
        '5. Estudio de informacion B',
        '8. Estudio de factibilidad',
        '3. Formato KMZ',
        '0. Car√°tula'
    ]
    try:
        sheet_names = [s.name for s in wb.sheets]
    except Exception as e:
        wb.close()
        app_excel.quit()
        return f"Error: No se pudieron enumerar las hojas del archivo Excel. El archivo puede estar da√±ado o vac√≠o. Detalle: {e}"
    for sheet in required_sheets:
        if sheet not in sheet_names:
            wb.close()
            app_excel.quit()
            return f"Error: La hoja '{sheet}' no existe en la plantilla de Excel."
    ws_a = wb.sheets['4. Estudio de informacion A']
    ws_red = wb.sheets['1. Analisis de Red y Frecuencia']
    ws_electricas = wb.sheets['2. Electricas - Dise√±o log- Fis']
    ws_electricas.range('B9').value = enlace_principal
    campos_electricas_celdas = {
        'Nombres Enlaces ': 'B9',
        'Configuraci√≥n MW:': ['D9', 'B14', 'C28', 'F28'],
        'Tama√±o de la antena (m)': ['C27', 'F27'],
        'Potencia de Transmisi√≥n (dBm)': ['C29', 'F29'],
        'Frecuencia (MHz)': ['C32', 'F32'],
        'Nombre del sitio A': 'C33',
        'Nombre del sitio B': 'F33',
        'ID del sitio A': 'C44',
        'ID del sitio B': 'F44',
        'Potencia de Recepci√≥n (dBm)': ['C30', 'F30'],
        'Banda': ['C31', 'F31'],
        'Frecuencia (MHz)': ['C32', 'F32'],
        'NOMBRE DEL SITIO':'C33',
        'Nombre del sitio 2': 'F33',
        'ID':'C34',
        'ID 2': 'F34',
        'consumo de potencia':'F9',
    
   }

    for campo, celdas in campos_electricas_celdas.items():
        valor = normaliza_na(datos.get(campo, ""))
        if isinstance(celdas, list):
            for celda in celdas:
                if isinstance(celda, str):
                    ws_electricas.range(celda).value = valor
                else:
                    print(f"Celda inv√°lida para campo {campo}: {celda}")
        elif isinstance(celdas, str):
            ws_electricas.range(celdas).value = valor
        else:
            print(f"Referencia de celda inv√°lida para campo {campo}: {celdas}")
    
    lat_a = datos.get('LATITUD (TORRE)', '')
    lon_a = datos.get('LONGITUD (TORRE)', '')
    coord_a = f"{lat_a}, {lon_a}" if lat_a and lon_a else ""

    lat_b = datos.get('LATITUD (TORRE) 2', '')
    lon_b = datos.get('LONGITUD (TORRE) 2', '')
    coord_b = f"{lat_b}, {lon_b}" if lat_b and lon_b else ""

    # Ajusta las celdas seg√∫n tu plantilla
    ws_electricas.range('C35').value = coord_a  # Coordenadas sitio A
    ws_electricas.range('F35').value = coord_b  # Coordenadas sitio B

    # Eliminar todas las im√°genes existentes en la hoja 2 antes de insertar nuevas
    for pic in ws_electricas.pictures:
        try:
            pic.delete()
        except Exception as e:
            print(f"Error eliminando imagen previa: {e}")

    # Imagen de consumo
    if img_consumo_path and os.path.exists(img_consumo_path):
        cell_range = ws_electricas.range('C14:D20')
        ws_electricas.pictures.add(
            os.path.abspath(img_consumo_path),
            left=cell_range.left,
            top=cell_range.top,
            width=cell_range.width,
            height=cell_range.height
       )
    # Imagen de configuraci√≥n
    if img_configuracion_path and os.path.exists(img_configuracion_path):
        cell_range = ws_electricas.range('E14:G20')
        ws_electricas.pictures.add(
            os.path.abspath(img_configuracion_path),
            left=cell_range.left,
            top=cell_range.top,
            width=cell_range.width,
            height=cell_range.height
       )
    # Imagen de l√≠nea de vista
    if img_linea_vista_path and os.path.exists(img_linea_vista_path):
        cell_range = ws_electricas.range('B39:G55')
        ws_electricas.pictures.add(
            os.path.abspath(img_linea_vista_path),
            left=cell_range.left,
            top=cell_range.top,
            width=cell_range.width,
            height=cell_range.height
       )
    

    import pandas as pd
    import dataframe_image as dfi
    # --- Tabla horizontal de frecuencia para hoja 1 ---
    campos_tabla = {
        "Tama√±o de la antena (m)": datos.get("Tama√±o de la antena (m)", ""),
        "Potencia de Transmisi√≥n (dBm)": datos.get("Potencia de Transmisi√≥n (dBm)", ""),
        "Potencia de Recepci√≥n (dBm)": datos.get("Potencia de Recepci√≥n (dBm)", ""),
        "Banda": datos.get("Banda", ""),
        "Frecuencia (MHz)": datos.get("Frecuencia (MHz)", ""),
        "#1 Canal ID S1": datos.get("#1 Canal ID S1", ""),
        "#1 Frecuencia de Dise√±o S1": datos.get("#1 Frecuencia de Dise√±o S1", ""),
        "#2 Frecuencia de Dise√±o S1": datos.get("#2 Frecuencia de Dise√±o S1", ""),
        "#1 Canal ID S2": datos.get("#1 Canal ID S2", ""),
        "#1 Frecuencia de Dise√±o S2": datos.get("#1 Frecuencia de Dise√±o S2", ""),
        "#2 Frecuencia de Dise√±o S2": datos.get("#2 Frecuencia de Dise√±o S2", "")
    }
    df_tabla = pd.DataFrame([campos_tabla])

    def wrap_col_label(label, width=14):
        return '\n'.join(textwrap.wrap(label, width=width, break_long_words=False))

    col_labels_wrapped = [wrap_col_label(str(col), width=14) for col in df_tabla.columns]

    styler = (
        df_tabla.style
        .set_table_styles([
            {'selector': 'th', 'props': [('background-color', '#0074D9'), ('color', 'white'), ('font-size', '12pt')]},
            {'selector': 'td', 'props': [('background-color', '#D9EAF7'), ('color', 'black'), ('font-size', '12pt'), ('text-align', 'center'), ('border', '1.5px solid #2F5597')]}
        ])
        .set_table_attributes('style="border-collapse:collapse; margin:auto;"')
        .hide(axis="index")  # Oculta los n√∫meros de fila
    )

    img_path = os.path.join(UPLOAD_FOLDER, 'tabla_frecuencia.png')
    try:
        import matplotlib.pyplot as plt
        fig, ax = plt.subplots(figsize=(12, 2.2))
        ax.axis('off')
        tabla = ax.table(
            cellText=df_tabla.values.tolist(),
            colLabels=col_labels_wrapped,
            loc='center',
            cellLoc='center'
        )
        # Estilo: encabezado azul, fila datos azul clarito
        for (row, col), cell in tabla.get_celld().items():
            if row == 0:
                cell.set_facecolor('#0074D9')
                cell.set_text_props(color='white', weight='bold')
            else:
                cell.set_facecolor('#D9EAF7')
                cell.set_text_props(color='black')
        tabla.auto_set_font_size(False)
        tabla.set_fontsize(10)
        tabla.scale(1.5, 2.8)
        plt.savefig(img_path, bbox_inches='tight', pad_inches=0, dpi=200)
        plt.close()
    except Exception as e:
        print(f"Error al exportar tabla como imagen: {e}")
        # Crear una imagen simple si falla
        import matplotlib.pyplot as plt
        plt.figure(figsize=(10, 2))
        plt.text(0.5, 0.5, 'Tabla de Frecuencias', ha='center', va='center', fontsize=16)
        plt.axis('off')
        plt.savefig(img_path, dpi=200, bbox_inches='tight', pad_inches=0)
        plt.close()
    df_tabla.to_csv(os.path.join(UPLOAD_FOLDER, "debug_tabla.csv"), index=False)
    # Guarda el Excel de depuraci√≥n con estilo
    try:
        styler.to_excel(os.path.join(UPLOAD_FOLDER, "debug_tabla.xlsx"))
    except Exception as e:
        print(f"Error al guardar el Excel estilizado: {e}")
    print("Tabla horizontal guardada en debug_tabla.csv y debug_tabla.xlsx")

    # Insertar la imagen en el rango A23:G28 de la hoja 1
    cell_range = ws_red.range('A23:G28')
    ws_red.pictures.add(
        img_path,
        left=cell_range.left,
        top=cell_range.top,
        width=cell_range.width,
        height=cell_range.height
    )

    cell_range = ws_red.range('D19').value = datos.get('Margen de desvanecimiento ', '')
    ws_red.range('E19').value = datos.get('Disponibilidad anual (%) ', '')
    ws_a.range('AG8').value = user_id
    ws_a.range('B19').value = enlace_principal
    ws_b = wb.sheets['5. Estudio de informacion B']
    ws_b.range('AG8').value = datos.get('ID 2', '')
    ws_factibilidad = wb.sheets['8. Estudio de factibilidad']
    ws_kmz = wb.sheets['3. Formato KMZ']
    #ws_kmz.activate()


    try:
      ws_caratula = wb.sheets['0. Car√°tula']
      nombre_a = datos.get('Nombre del sitio A', '')
      nombre_b = datos.get('Nombre del sitio B', '')
      ws_caratula.range('A43').value = f"{nombre_a} - {nombre_b}"
      nombre_enlace_caratula = ws_caratula.range('A43').value or ""
      import re
      nombre_enlace_sin_numeros = re.sub(r'\b\d+[A-Z]?\s*', '', nombre_enlace_caratula).strip()
      nombre_enlace_sin_numeros = re.sub(r'\s{2,}', ' ', nombre_enlace_sin_numeros)
      ws_red.range('B19').value = nombre_enlace_sin_numeros
    except Exception as e:
      print(f"Advertencia: No se pudo llenar la hoja 0. Car√°tula: {e}")

    # Usar las im√°genes de fotos 9 ya procesadas anteriormente
    fotos9_names = [
        "foto_e11", "foto_v11", "foto_e23", "foto_e48", "foto_v48", "foto_e59", "foto_v59",
        "foto_e70", "foto_v70", "foto_e87", "foto_v87", "foto_e98", "foto_v98", "foto_e127",
        "foto_v127", "foto_e138", "foto_v138", "foto_e150", "foto_v150"
    ]
    imagenes_fotos9_paths = [fotos9_paths.get(name) for name in fotos9_names]
    
    
    estado_a_region = {
        'Aguascalientes': 'CENTRO',
        'Baja California': 'NORTE',
        'Baja California Sur': 'NORTE',
        'Campeche': 'SURESTE',
        'Chiapas': 'SUR',
        'Chihuahua': 'NORTE',
        'Ciudad de M√©xico': 'CENTRO',
        'Coahuila': 'NORTE',
        'Colima': 'OCCIDENTE',
        'Durango': 'NORTE',
        'Estado de M√©xico': 'CENTRO',
        'Guanajuato': 'CENTRO',
        'Guerrero': 'SUR',
        'Hidalgo': 'CENTRO',
        'Jalisco': 'OCCIDENTE',
        'Michoac√°n': 'OCCIDENTE',
        'Morelos': 'CENTRO',
        'Nayarit': 'OCCIDENTE',
        'Nuevo Le√≥n': 'NORESTE',
        'Oaxaca': 'SUR',
        'Puebla': 'CENTRO',
        'Quer√©taro': 'CENTRO',
        'Quintana Roo': 'SURESTE',
        'San Luis Potos√≠': 'CENTRO',
        'Sinaloa': 'NORTE',
        'Sonora': 'NORTE',
        'Tabasco': 'SURESTE',
        'Tamaulipas': 'NORESTE',
        'Tlaxcala': 'CENTRO',
        'Veracruz': 'GOLFO',
        'Yucat√°n': 'SURESTE',
        'Zacatecas': 'NORTE'
    }
    

    tipo_zona = str(datos.get('Tipo de Zona', '')).strip().lower()
    ws_a.range('M20').value = tipo_zona == 'urbana'
    ws_a.range('Q20').value = tipo_zona == 'sub-urbana'
    ws_a.range('V20').value = tipo_zona == 'rural'
    ws_a.range('Y20').value = tipo_zona == 'ejidal'
    ws_a.range('AB20').value = tipo_zona == 'pueblo m√°gico'

    tipo_zona2 = str(datos.get('Tipo de Zona 2', '')).strip().lower()
    ws_b.range('M20').value = tipo_zona2 == 'urbana'
    ws_b.range('Q20').value = tipo_zona2 == 'sub-urbana'
    ws_b.range('V20').value = tipo_zona2 == 'rural'
    ws_b.range('Y20').value = tipo_zona2 == 'ejidal'
    ws_b.range('AB20').value = tipo_zona2 == 'pueblo m√°gico'
  
    visible = str(datos.get('El sitio es visible de d√≠a y de noche (libre de maleza y arboles): ', '')).strip().lower()
    ws_a.range('Q21').value = visible == 'si'
    ws_a.range('T21').value = visible == 'no'

    visible2 = str(datos.get('El sitio es visible de d√≠a y de noche (libre de maleza y arboles): 2', '')).strip().lower()
    ws_b.range('Q21').value = visible2 == 'si'
    ws_b.range('T21').value = visible2 == 'no'

    tipo_camino = str(datos.get('Tipo de Camino', '')).strip().lower()
    ws_a.range('H22').value = tipo_camino == 'terracer√≠a'
    ws_a.range('M22').value = tipo_camino == 'pavimentado'
    ws_a.range('R22').value = tipo_camino == 'empedrado'
    ws_a.range('W22').value = tipo_camino == 'mixto'

    tipo_camino2  = str(datos.get(' Tipo de Camino 2 ', '')).strip().lower()
    ws_b.range('H22').value = tipo_camino2 == 'terracer√≠a'
    ws_b.range('M22').value = tipo_camino2 == 'pavimentado'
    ws_b.range('R22').value = tipo_camino2 == 'empedrado'
    ws_b.range('W22').value = tipo_camino2 == 'mixto'

    tipo_torre = str(datos.get('Tipo de Torre', '')).strip().lower()
    ws_a.range('H34').value = tipo_torre == 'autosoportada'
    ws_a.range('P34').value = tipo_torre == 'arriostrada'
    ws_a.range('W34').value = tipo_torre == 'Monopolo'
    ws_a.range('AC34').value = tipo_torre == 'Minipolo'
    ws_a.range('AH34').value = tipo_torre == 'otro'
    
   
    espacio_disponible = str(datos.get('¬øEspacio disponible de conexi√≥n?', '')).strip().lower()
    ws_a.range('AG51').value = espacio_disponible == 'si'
    ws_a.range('AJ51').value = espacio_disponible == 'no'
    ws_a.range('V40').value = espacio_disponible == 'si'
    ws_a.range('Z40').value = espacio_disponible == 'no'

    cara_propuesta = str(datos.get('Cara de preparaci√≥n para cableado vertical en torre', '')).strip().lower()
    ws_a.range('S42').value = cara_propuesta == 'a'
    ws_a.range('X42').value = cara_propuesta == 'b'
    ws_a.range('AC42').value = cara_propuesta == 'c'
    ws_a.range('AH42').value = cara_propuesta == 'd'

    barra_tierra = str(datos.get('Barra de Tierra', '')).strip().lower()
    ws_a.range('P53').value = barra_tierra == 'si'
    ws_a.range('S53').value = barra_tierra == 'no'

    tipo_solucion = str(datos.get('Tipo de Solucion', '')).strip().lower()
    ws_a.range('P55').value = tipo_solucion == 'piso'
    ws_a.range('S55').value = tipo_solucion == 'torre'

    existe_break = str(datos.get('¬øExiste algun breaker existente en sitio? ', '')).strip().lower()
    ws_a.range('Y47').value = existe_break == 'si'
    ws_a.range('AB47').value = existe_break == 'no'
    
    alimentacion_compatible = str(datos.get('Alimentacion compatible con el equipamiento ', '')).strip().lower()
    ws_a.range('Y51').value = alimentacion_compatible == 'si'
    ws_a.range('AB51').value = alimentacion_compatible == 'no'

    sistema_electrico = str(datos.get('SISTEMA ELECTRICO', '')).strip().lower()
    ws_a.range('AG47').value = sistema_electrico == 'monof√°sica'
    ws_a.range('AJ47').value = sistema_electrico == 'bif√°sica'

    tipo_torre2 = str(datos.get('Tipo de Torre2', '')).strip().lower()
    ws_a.range('H58').value = tipo_torre2 == 'autosoportada'
    ws_a.range('P58').value = tipo_torre2 == 'arriostrada'
    ws_a.range('W58').value = tipo_torre2 == 'monopolo'
    ws_a.range('AC58').value = tipo_torre2 == 'minipolo'
    ws_a.range('AH58').value = tipo_torre2 == 'otro'

    espacio_disponible2 = str(datos.get('¬øEspacio disponible de conexi√≥n?2', '')).strip().lower()
    ws_a.range('V64').value = espacio_disponible2 == 'si'
    ws_a.range('Z64').value = espacio_disponible2 == 'no'

    cara_preparacion2 = str(datos.get('Cara de preparaci√≥n para cableado vertical en torre 2', '')).strip().lower()
    ws_a.range('S66').value = cara_preparacion2 == 'a'
    ws_a.range('X66').value = cara_preparacion2 == 'b'
    ws_a.range('AC66').value = cara_preparacion2 == 'c'
    ws_a.range('AH66').value = cara_preparacion2 == 'd'
    
    existe_tierra2 = str(datos.get('Existe Barra de Tierras 2', '')).strip().lower()
    ws_a.range('P77').value = existe_tierra2 == 'si'
    ws_a.range('S77').value = existe_tierra2 == 'no'

    tipo_solucion2 = str(datos.get('Tipo de solucion 2', '')).strip().lower()
    ws_a.range('P79').value = tipo_solucion2 == 'piso'
    ws_a.range('S79').value = tipo_solucion2 == 'torre'
    
    existe_break2 = str(datos.get('Existe algun breaker existente en sitio 2 ', '')).strip().lower()
    ws_a.range('Y71').value = existe_break2 == 'si'
    ws_a.range('AB71').value = existe_break2 == 'no'

    alimenacion_existente2= str(datos.get('SISTEMA ELECTRICO 2', '')).strip().lower()
    ws_a.range('AG71').value = alimenacion_existente2 == 'monof√°sica'
    ws_a.range('AJ71').value = alimenacion_existente2 == 'bif√°sica'
    
    alimenacion_compatible2= str(datos.get('Alimentacion compatible con el equipamiento 2', '')).strip().lower()
    ws_a.range('Y75').value = alimenacion_compatible2 == 'si'
    ws_a.range('AB75').value = alimenacion_compatible2 == 'no'

    espacio_conexion2= str(datos.get('¬øEspacio disponible de conexi√≥n? 2', '')).strip().lower()
    ws_a.range('AG75').value = espacio_conexion2 == 'si'
    ws_a.range('AJ75').value = espacio_conexion2 == 'no'

    linea_vista = str(datos.get('Linea de vista ', '')).strip().lower()
    motivo = str(datos.get('Motivo ', '')).strip().lower()

    ws_a.range('K82').value = (linea_vista == 'si')
    ws_a.range('O82').value = (linea_vista == 'no')
    ws_a.range('J83').value = False
    ws_a.range('O83').value = False
    ws_a.range('U83').value = False
    ws_a.range('AA83').value = False
    ws_a.range('E84').value = False

    if linea_vista == 'no':
        if motivo == 'arboles':
            ws_a.range('J83').value = True
        elif motivo == 'espectacular':
            ws_a.range('O83').value = True
        elif motivo == 'edificio':
            ws_a.range('U83').value = True
        elif motivo == 'monta√±a':
            ws_a.range('AA83').value = True
        elif motivo == 'n/a':
            ws_a.range('E84').value = True

    campos_a_celdas = {
        'NOMBRE DEL SITIO': ['K8', 'H33'],
        #'REGION': 'E9',
        'PROPIETARIO': 'N9',
        'ESTADO ': 'AD14',
        'Calle': 'E13',
        'Colonia': 'E14',
        'Municipio': 'F15',
        'C.P': 'AD13',
        'Referencias':'K16',
        'Nombre de contacto en sitio': 'I18',
        'Telefono': 'AC18',
        'Tipo de Zona': 'E16',
        'Tipo de Camino': 'E17',
        'LATITUD (TORRE)': 'L29',
        'LONGITUD (TORRE)': 'AB29',
        'LATITUD (FACHADA)': 'L26',
        'LONGITUD (FACHADA)': 'AB26',
        'Altitud (msnm)': 'N30',
        'Diametro de pierna superior':'L35',
        'Diametro de pierna Inferior':'V35',
        'NCRA RB':'AC35',
        'Franja2RB':'AI35',
        'Altura de la Torre':'L36',
        'Dado':'V36',
        'Altura Edificio1':'AF36',
        'Nivel inferior de franja disponible': 'U37',
        'Nivel superior de franja disponible': 'AI37',
        'Altura de MW conforme a topologia': 'C40',
        'Azimut RB ': 'N40',
        'Propuesta de altura de antena de MW1': 'AC40',
        'Propuesta de altura de antena de MW (SD)1': 'AH40',
        'Altura de soporte para OMB propuesto': 'P45',
        'Longitud del cable de tierra nuevo OMB': 'P46',
        'Longitud del cable de tierra ODU': 'P47',
        'Longitud de cable IF': 'P48',
        'Tipo de soporte para antena MW propuesto': 'P49',
        'Longitud de cable ACDB-Nuevo OMB': 'P50',
        'Longitud de cable RTN - Router':'P51',
        'Longitud de cable RTN - BBU SITE 1': 'P52',
        'MEDICION DE BARRA DE TIERRA (Ohms)':'P54',
        'Nombre del sitio 2': 'H57',
        'Di√°metro de Pierna superio2':'L59',
        'Di√°metro de Pierna inferior2':'V59',
        ' NCRA2 ':'AC59',
        'Franja2-2':'AI59',
        'Altura torre 2': 'L60',
        'DADO 2':'V60',
        'Altura edificio 2':'AF60',
        'Nivel inferior de franja disponible 2': 'U61',
        'Nivel superior de franja disponible 2': 'AI61',
        'Altura de MW conforme a topologia 2': 'C64',
        'Azimut 2': 'N64',
        'Propuesta de altura de antena de MW2': 'AC64',
        'Propuesta de altura de antena de MW (SD)2':'AH64',
        'Altura de soporte para OMB propuesto2':'P69',
        'Longitud del cable de tierra nuevo OMB 2': 'P70',
        'Longitud del cable de tierra ODU 2': 'P71',
        'Longitud de cable IF 2': 'P72',
        'Tipo de soporte para antena MW propuesto 2': 'P73',
        'Longitud de cable ACDB-Nuevo OMB 2': 'P74',
        'Longitud de cable RTN - Router 2': 'P75',
        'Longitud de cable RTN - BBU 2': 'P76',
        'Medici√≥n del Sistema de Tierras 2': 'P78',
        'Nombre del sitio A': ['M117', 'M139'],
        'Nombre del sitio B': ['M162', 'M184'],
     
    }

    print("ESTADO:", datos.get('ESTADO'))
    print("ESTADO 2:", datos.get('ESTADO 2'))
    print("ESTADO2:", datos.get('ESTADO2'))

    estado_b_region = {
        'Aguascalientes': 'CENTRO',
        'Baja California': 'NORTE',
        'Baja California Sur': 'NORTE',
        'Campeche': 'SURESTE',
        'Chiapas': 'SUR',
        'Chihuahua': 'NORTE',
        'Ciudad de M√©xico': 'CENTRO',
        'Coahuila': 'NORTE',
        'Colima': 'OCCIDENTE',
        'Durango': 'NORTE',
        'Estado de M√©xico': 'CENTRO',
        'Guanajuato': 'CENTRO',
        'Guerrero': 'SUR',
        'Hidalgo': 'CENTRO',
        'Jalisco': 'OCCIDENTE',
        'Michoac√°n': 'OCCIDENTE',
        'Morelos': 'CENTRO',
        'Nayarit': 'OCCIDENTE',
        'Nuevo Le√≥n': 'NORESTE',
        'Oaxaca': 'SUR',
        'Puebla': 'CENTRO',
        'Quer√©taro': 'CENTRO',
        'Quintana Roo': 'SURESTE',
        'San Luis Potos√≠': 'CENTRO',
        'Sinaloa': 'NORTE',
        'Sonora': 'NORTE',
        'Tabasco': 'SURESTE',
        'Tamaulipas': 'NORESTE',
        'Tlaxcala': 'CENTRO',
        'Veracruz': 'GOLFO',
        'Yucat√°n': 'SURESTE',
        'Zacatecas': 'NORTE'
    }
    estado_b = datos.get('ESTADO 2')
    if not estado_b or pd.isna(estado_b):
       estado_b = datos.get('ESTADO2')
    if not estado_b or pd.isna(estado_b):
       estado_b = datos.get('ESTADO')
    region_b = estado_b_region.get(str(estado_b).strip(), 'OTRA')
    ws_b.range('E9').value = region_b

    estado_a_region = {
         'Aguascalientes': 'CENTRO',
         'Baja California': 'NORTE',
         'Baja California Sur': 'NORTE',
         'Campeche': 'SURESTE',
         'Chiapas': 'SUR',
         'Chihuahua': 'NORTE',
         'Ciudad de M√©xico': 'CENTRO',
         'Coahuila': 'NORTE',
         'Colima': 'OCCIDENTE',
         'Durango': 'NORTE',
         'Estado de M√©xico': 'CENTRO',
         'Guanajuato': 'CENTRO',
         'Guerrero': 'SUR',
         'Hidalgo': 'CENTRO',
         'Jalisco': 'OCCIDENTE',
         'Michoac√°n': 'OCCIDENTE',
         'Morelos': 'CENTRO',
         'Nayarit': 'OCCIDENTE',
         'Nuevo Le√≥n': 'NORESTE',
         'Oaxaca': 'SUR',
         'Puebla': 'CENTRO',
         'Quer√©taro': 'CENTRO',
         'Quintana Roo': 'SURESTE',
         'San Luis Potos√≠': 'CENTRO',
         'Sinaloa': 'NORTE',
         'Sonora': 'NORTE',
         'Tabasco': 'SURESTE',
         'Tamaulipas': 'NORESTE',
         'Tlaxcala': 'CENTRO',
         'Veracruz': 'GOLFO',
         'Yucat√°n': 'SURESTE',
         'Zacatecas': 'NORTE'
    }

    # Para el sitio A
    estado_a = datos.get('ESTADO ', '').strip()
    region_a = estado_a_region.get(estado_a, 'OTRA')
    ws_a.range('D10').value = region_a  # Ajusta la celda si tu plantilla usa otra

# Para el sitio B (si aplica)
    estado_b = datos.get('ESTADO 2 ', '').strip()
    region_b = estado_a_region.get(estado_b, 'OTRA')
    ws_b.range('D10').value = region_b  # Ajusta la celda si tu plantilla usa otra
    

    campos_b_celdas= {
    'Nombre del sitio 2': 'K8',
    'ID 2': 'AG8',
    #'REGION 2': 'E9',
    'PROPIETARIO 2': 'N9',
    'ESTADO 2': 'AD14',
    'Calle 2': 'E13',
    'Colonia 2': 'E14',
    'Municipio 2': 'F15',
    'C.P 2': 'AD13',
    'Referencias 2':'K16',
    'Nombre de contacto en sitio 2': 'I18',
    'Telefono 2': 'AC18',
    'LATITUD (TORRE) 2': 'L29',
    'LONGITUD (TORRE) 2': 'AB29',
    'LATITUD (FACHADA) 2': 'L26',
    'LONGITUD (FACHADA) 2': 'AB26',
    'Altitud (msnm) 2': 'N30',

    }
    copias_factibilidad= {
    'H33': 'H8',
    'L35': 'L10',
    'V35': 'V10',
    'AC35': 'AD10',
    'AI35': 'AN10',
    'L36': 'L11',
    'V36': 'V11',
    'AF36': 'AF11',
    'U37': 'U12',
    'AI37': 'AL12',
    'C40': 'C15',
    'N40': 'N15',
    'AC40': 'AC15',
    'AH40': 'AK15',
    'P45': 'P20',
    'P46': 'P21',
    'P47': 'P22',
    'P48': 'P23',
    'P49': 'P24',
    'P50': 'P25',
    'P51': 'P26',   
    'P52': 'P27',       
    'P54': 'P29',
    'H57': 'H32',
    'L59': 'L34',
    'V59': 'V34',
    'AC59': 'AD34',
    'AI59': 'AN34',
    'L60': 'L35',
    'V60': 'V35',
    'AF60': 'AF35',
    'U61': 'U36',
    'AI61': 'AL36',
    'C64': 'C39',
    'N64': 'N39',
    'AC64': 'AC39',
    'AH64': 'AK39',
    'P69': 'P44',   
    'P70': 'P45',
    'P71': 'P46',
    'P72': 'P47',
    'P73': 'P48',
    'P74': 'P49',
    'P75': 'P50',
    'P76': 'P51',
    'P78': 'P53',
    }
    copias_checkbox_factibilidad = {
    'H34': 'H9',   # autosoportada
    'P34': 'P9',   # arriostrada
    'W34': 'V9',   # monopolo
    'AC34': 'AC9', # minipolo
    'AH34': 'AH9', # otro
    'V40' : 'V15', # espacio disponible de conexi√≥n
    'Z40': 'Z15', # no espacio disponible de conexi√≥n
    'S42': 'Z17', # cara de preparaci√≥n A
    'X42': 'AE17', # cara de preparaci√≥n B
    'AC42': 'AJ17', # cara de preparaci√≥n C
    'AH42': 'AO17', # cara de preparaci√≥n D
    'P53': 'P28', # barra de tierra 
    'S53': 'S28', # no barra de tierra
    'P55': 'P30', # tipo de soluci√≥n piso
    'S55': 'S30', # tipo de soluci√≥n torre
    'Y47': 'Z22', # existe breaker existente en sitio
    'AB47': 'AC22', # no existe breaker existente en sitio
    'Y51': 'Z26', # alimentacion compatible con el equipamiento
    'AB51': 'AC26', # no alimentacion compatible con el equipamiento
    'AG47': 'AH22', # sistema electrico monofasica
    'AJ47': 'AM22', # sistema electrico bifasica
    'AG51': 'AI26', # espacio disponible de conexi√≥n
    'AJ51': 'AL26', # no espacio disponible de conexi√≥n
    'H58': 'H33',   # autosoportada 2
    'P58': 'P33',   # arriostrada 2
    'W58': 'W33',   # monopolo 2
    'AC58': 'AC33', # minipolo 2
    'AH58': 'AH33', # otro 2
    'V64': 'V39', # espacio disponible de conexi√≥n 2
    'Z64': 'Z39', # no espacio disponible de conexi√≥n 2
    'S66': 'Z41', # cara de preparaci√≥n A 2
    'X66': 'AE41', # cara de preparaci√≥n B 2
    'AC66': 'AJ41', # cara de preparaci√≥n C 2
    'AH66': 'AO41', # cara de preparaci√≥n D 2
    'P77': 'P52', # existe barra de tierra 2
    'S77': 'S52', # no existe barra de tierra 2
    'P79': 'P54', # tipo de soluci√≥n piso 2
    'S79': 'S54', # tipo de soluci√≥n torre 2
    'Y71': 'Z46', # existe breaker existente en sitio 2
    'AB71': 'AC46', # no existe breaker existente en sitio 2
    'AG71': 'AH46', # sistema electrico monofasica 2
    'AJ71': 'AM46', # sistema electrico bifasica 2
    'Y75': 'Z50', # alimentacion compatible con el equipamiento 2
    'AB75': 'AC50', # no alimentacion compatible con el equipamiento
    'AG75': 'AI50', # espacio disponible de conexi√≥n 2
    'AJ75': 'AL50', # no espacio disponible de conexi√≥n 2


    }
    
    
    for campo, celda in campos_a_celdas.items():
        valor = normaliza_na(datos.get(campo, ""))
        if isinstance(celda, list):
            for c in celda:
                ws_a.range(c).value = valor
        else:
            ws_a.range(celda).value = valor

    # --- Asignaci√≥n de regi√≥n basada en el estado (MOVIDO AQU√ç) ---
    # Leer directamente el estado que ya est√° en AD14 (despu√©s de que se haya escrito)
    print(f"DEBUG: Antes de leer AD14 - ws_a.name = {ws_a.name}")
    estado = ws_a.range('AD14').value
    print(f"DEBUG: Estado le√≠do de AD14: '{estado}'")
    print(f"DEBUG: Tipo de estado: {type(estado)}")
    print(f"DEBUG: Estado despu√©s de strip: '{str(estado).strip()}'")
    print(f"DEBUG: Estado en estado_a_region: {'S√≠' if str(estado).strip() in estado_a_region else 'No'}")
    region = estado_a_region.get(str(estado).strip(), 'OTRA')
    print(f"DEBUG: Regi√≥n asignada: '{region}'")
    ws_a.range('E9').value = region
    print(f"DEBUG: Regi√≥n escrita en E9: '{region}'")

    

    for campo, celda in campos_b_celdas.items():
        valor = normaliza_na(datos.get(campo, ""))
        if isinstance(celda, list):
            for c in celda:
                ws_b.range(c).value = valor
        else:
            ws_b.range(celda).value = valor
    
    for origen, destino in copias_factibilidad.items():
     ws_factibilidad.range(destino).value = ws_a.range(origen).value

    for origen, destino in copias_checkbox_factibilidad.items():
        if origen == 'Y47' and destino == 'Z22':
            ws_factibilidad.range(destino).value = bool(ws_a.range(origen).value)
        else:
            ws_factibilidad.range(destino).value = ws_a.range(origen).value
    
    print("DEBUG: Archivos recibidos en request.files:", list(request.files.keys()))
    imagenes_torres = request.files.getlist('imagenes_torres')
    
    imagenes_torres = request.files.getlist('imagenes_torres')
    imagenes_torres_paths = []
    for idx, img in enumerate(imagenes_torres):
        if img and img.filename:
            filename = secure_filename(f"torres_{idx}_{img.filename}")
            img_path = os.path.join(UPLOAD_FOLDER, filename)
            img.save(img_path)
            imagenes_torres_paths.append(img_path) 

    imagenes_torres_b = request.files.getlist('imagenes_torres_b')
    imagenes_torres_b_paths = []
    for idx, img in enumerate(imagenes_torres_b):
        if img and img.filename:
            filename = secure_filename(f"torres_b_{idx}_{img.filename}")
            img_path = os.path.join(UPLOAD_FOLDER, filename)
            img.save(img_path)
            imagenes_torres_b_paths.append(img_path)

           
    # Reordena las im√°genes seg√∫n tu l√≥gica visual
    # Aseg√∫rate de que haya al menos 6 im√°genes para evitar errores de √≠ndice
    print(f"DEBUG: imagen_paths tiene {len(imagen_paths)} elementos")
    print(f"DEBUG: imagen_paths = {imagen_paths}")
    print(f"DEBUG: ws_a.name = {ws_a.name}")
    
    if len(imagen_paths) >= 6:
        ordenadas = [imagen_paths[5], imagen_paths[4], imagen_paths[3], imagen_paths[2], imagen_paths[1], imagen_paths[0]]
        img_cells = ['C87', 'C87', 'E118', 'E140', 'E163', 'E185']
        imagenes_final = ordenadas
    else:
        img_cells = ['C87', 'C87', 'E118', 'E140', 'E163', 'E185'][:len(imagen_paths)]
        imagenes_final = imagen_paths[::-1]  # Invierte el orden si quieres de derecha a izquierda

    # Inserta las im√°genes en las celdas correspondientes
    img_ranges = ['C86:O113', 'Y86:AK113', 'E118:O136', 'E140:O158', 'E163:O181', 'E185:O203']
    
    print(f"DEBUG: imagenes_final = {imagenes_final}")
    print(f"DEBUG: img_ranges = {img_ranges}")
    
    # Limpia im√°genes previas en la hoja antes de insertar nuevas
    print(f"DEBUG: Limpiando {ws_a.pictures.count} im√°genes previas en {ws_a.name}")
    for pic in ws_a.pictures:
        try:
            pic.delete()
            print("DEBUG: Imagen previa eliminada")
        except Exception as e:
            print(f"Error eliminando imagen previa en ws_a: {e}")

    # Depuraci√≥n: imprime las rutas de las im√°genes a insertar
    print("Im√°genes a insertar en 4. Estudio de informacion A:")
    for idx, img in enumerate(imagenes_final):
        print(f"Imagen {idx}: {img} - Existe: {os.path.exists(img) if img else False}")

    for idx, img_path in enumerate(imagenes_final):
        print(f"Intentando insertar imagen {idx}: {img_path} ...", end="")
        if idx < len(img_ranges) and img_path and os.path.exists(img_path):
            try:
                cell_range = ws_a.range(img_ranges[idx])
                print(f"DEBUG: cell_range = {img_ranges[idx]}, left={cell_range.left}, top={cell_range.top}")
                ws_a.pictures.add(
                    os.path.abspath(img_path),
                    left=cell_range.left,
                    top=cell_range.top,
                    width=cell_range.width,
                    height=cell_range.height
                )
                print("OK")
            except Exception as e:
                print(f"ERROR: {e}")
        else:
            print("NO EXISTE")
    
    print(f"DEBUG: Despu√©s de insertar, {ws_a.pictures.count} im√°genes en {ws_a.name}")
    
    # --- INSERTAR IM√ÅGENES DE PLANOS A Y B ---
    
    # Planos A (en la hoja 4. Estudio de informacion A)
    planos_a_ranges = ['C17:AK60', 'C69:AK123', 'C134:AK173']
    planos_a_paths = [planos_a_img1_path, planos_a_img2_path, planos_a_img3_path]
    
    print("Im√°genes de Planos A a insertar:")
    for idx, img_path in enumerate(planos_a_paths):
        print(f"Plano A {idx+1}: {img_path} - Existe: {os.path.exists(img_path) if img_path else False}")
    
    for idx, img_path in enumerate(planos_a_paths):
        if idx < len(planos_a_ranges) and img_path and os.path.exists(img_path):
            try:
                cell_range = ws_a.range(planos_a_ranges[idx])
                ws_a.pictures.add(
                    os.path.abspath(img_path),
                    left=cell_range.left,
                    top=cell_range.top,
                    width=cell_range.width,
                    height=cell_range.height
                )
                print(f"Plano A {idx+1} insertado correctamente")
            except Exception as e:
                print(f"Error insertando Plano A {idx+1}: {e}")
    
    # Planos B (en la hoja 5. Estudio de informacion B)
    ws_b = wb.sheets['5. Estudio de informacion B']
    planos_b_ranges = ['C17:AK60', 'C69:AK123', 'C134:AK173']
    planos_b_paths = [planos_b_img1_path, planos_b_img2_path, planos_b_img3_path]
    
    print("Im√°genes de Planos B a insertar:")
    for idx, img_path in enumerate(planos_b_paths):
        print(f"Plano B {idx+1}: {img_path} - Existe: {os.path.exists(img_path) if img_path else False}")
    
    for idx, img_path in enumerate(planos_b_paths):
        if idx < len(planos_b_ranges) and img_path and os.path.exists(img_path):
            try:
                cell_range = ws_b.range(planos_b_ranges[idx])
                ws_b.pictures.add(
                    os.path.abspath(img_path),
                    left=cell_range.left,
                    top=cell_range.top,
                    width=cell_range.width,
                    height=cell_range.height
                )
                print(f"Plano B {idx+1} insertado correctamente")
            except Exception as e:
                print(f"Error insertando Plano B {idx+1}: {e}")

    ws_torres = wb.sheets['6. Estudio torres y antenas A']
    img_torres_ranges = ['C17:AK60', 'C69:AK123', 'C134:AK173']
    # Limpia im√°genes previas en la hoja antes de insertar nuevas
    print(f"DEBUG: Limpiando {ws_torres.pictures.count} im√°genes previas en {ws_torres.name}")
    for pic in ws_torres.pictures:
        try:
            pic.delete()
            print("DEBUG: Imagen previa eliminada en hoja 6")
        except Exception as e:
            print(f"Error eliminando imagen previa en ws_torres: {e}")
    print("Im√°genes a insertar en 6. Estudio torres y antenas A:")
    for idx, img_path in enumerate(imagenes_torres_paths):
        print(f"Imagen {idx}: {img_path} - Existe: {os.path.exists(img_path) if img_path else False}")
    for idx, img_path in enumerate(imagenes_torres_paths):
        print(f"Intentando insertar imagen {idx}: {img_path} ...", end="")
        if idx < len(img_torres_ranges) and os.path.exists(img_path):
            try:
                cell_range = ws_torres.range(img_torres_ranges[idx])
                print(f"DEBUG: cell_range = {img_torres_ranges[idx]}, left={cell_range.left}, top={cell_range.top}")
                ws_torres.pictures.add(
                    os.path.abspath(img_path),
                    left=cell_range.left,
                    top=cell_range.top,
                    width=cell_range.width,
                    height=cell_range.height
                )
                print("OK")
            except Exception as e:
                print(f"ERROR: {e}")
        else:
            print("NO EXISTE")
    print(f"DEBUG: Despu√©s de insertar, {ws_torres.pictures.count} im√°genes en {ws_torres.name}")

    ws_torres_b = wb.sheets['7. Estudio torres y antenas B']
    img_torres_b_ranges = ['C15:AK57', 'C67:AK119', 'C132:AK169']
    for idx, img_path in enumerate(imagenes_torres_b_paths):
        if idx < len(img_torres_b_ranges) and os.path.exists(img_path):
            cell_range = ws_torres_b.range(img_torres_b_ranges[idx])
            ws_torres_b.pictures.add(
                os.path.abspath(img_path),
                left=cell_range.left,
                top=cell_range.top,
                width=cell_range.width,
                height=cell_range.height
            )

    ws_fotos9 = wb.sheets['9. Factibilidad Reporte Fotos A']
    fotos9_celdas = [
    'H11:L18',  # 1. GPS con coordenadas de la torre
    'Y11:AC18',  # 2. Fachada del sitio
    'H23:L29',  # 3. Foto de torre completa
    'H48:L54',  # 4. Foto desde piso mostrando espacio en torre para MW topolog√≠a
    'Y48:AC54',  # 5. Medici√≥n con cinta del rad center en torre topolog√≠a
    'H59:L66',  # 6. Foto desde piso mostrando espacio en torre para MW (SD)
    'Y59:AC66',  # 7. Medici√≥n con cinta del rad center en torre (SD)
    'H70:L77',  # 8. Foto desde piso mostrando espacio (propuesto) en torre para antena
    'Y70:AC77',  # 9. Foto desde piso mostrando espacio (propuesto) en torre para antena
    'H87:L94',  # 10. Foto l√≠nea de Vista de Sitio A a Sitio B
    'Y87:AC94',  # 11. Foto l√≠nea de Vista de Sitio A a Sitio B Diversidad
    'H98:L105',  # 12. Foto Barra de Tierra
    'Y98:AC105',  # 13. Foto de escalerilla de torre
    'H127:L134', # 14. Foto del espacio disponible dentro del Gabinete OMB
    'Y127:AC134', # 15. Foto del espacio disponible en torre para OMB adicional
    'H138:L144', # 16. Foto DPU existente
    'Y138:AC144', # 17. Foto del espacio disponible en torre para DPU y Bater√≠a
    'H150:L156', # 18. Foto ACDB y Breaker
    'Y150:AC156', # 19. Foto de Agregador (Site Entry)
    ]
    

    while len(imagenes_fotos9_paths) < len(fotos9_celdas):
        imagenes_fotos9_paths.append(None)

    for idx, celda in enumerate(fotos9_celdas):
        img_path = imagenes_fotos9_paths[idx]
        cell_range = ws_fotos9.range(celda)
        if img_path and os.path.exists(img_path):
            ws_fotos9.pictures.add(
            os.path.abspath(img_path),
            left=cell_range.left,
            top=cell_range.top,
            width=cell_range.width,
            height=cell_range.height
    )
        else:
        # Si no hay imagen, coloca un N/A grande centrado en la celda superior izquierda
            cell = ws_fotos9.range(celda.split(':')[0])
            cell.value = "N/A"
            cell.api.Font.Size = 36
            cell.api.HorizontalAlignment = -4108  # xlCenter
            cell.api.VerticalAlignment = -4108    # xlCenter
    

    # Usar las im√°genes de fotos 10 ya procesadas anteriormente
    fotos10_names = [
         "foto_b_1", "foto_b_2", "foto_b_3", "foto_b_4", "foto_b_5", "foto_b_6", "foto_b_7", "foto_b_8", "foto_b_9", "foto_b_10"
    ]
    imagenes_fotos10_paths = [fotos10_paths.get(name) for name in fotos10_names]

    ws_fotos10 = wb.sheets['10. Reporte Fotos B']
    fotos10_celdas = [
    'H11:L18', 'Y11:AC18', 'H23:L29', 'H48:L54', 'Y48:AC54', 'H59:L66', 'Y59:AC66',
    'H70:L77', 'Y70:AC77', 'H87:L94', 'Y87:AC94'
    ]
    while len(imagenes_fotos10_paths) < len(fotos10_celdas):
        imagenes_fotos10_paths.append(None)
    for idx, celda in enumerate(fotos10_celdas):
        img_path = imagenes_fotos10_paths[idx]
        cell_range = ws_fotos10.range(celda)
        if img_path and os.path.exists(img_path):
            ws_fotos10.pictures.add(
                os.path.abspath(img_path),
                left=cell_range.left,
                top=cell_range.top,
                width=cell_range.width,
                height=cell_range.height
           )
        else:
            # Si no hay imagen, coloca un N/A grande centrado en la celda superior izquierda
            cell = ws_fotos10.range(celda.split(':')[0])
            cell.value = "N/A"
            cell.api.Font.Size = 36
            cell.api.HorizontalAlignment = -4108  # xlCenter
            cell.api.VerticalAlignment = -4108    # xlCenter

    pdf_icon_cells = ['AB121', 'AB166', 'AB200', 'AB220', 'AB240', 'AB260']

    # --- Inserta KMZ e imagen KML en la hoja de Formato KMZ ---
  #  print("KMZ path:", kmz_path)
   # print("KMZ exists:", os.path.exists(kmz_path) if kmz_path else False)
  #  print("KML image path:", kml_image_path)
   # print("KML image exists:", os.path.exists(kml_image_path) if kml_image_path else False)
   # print("ws_kmz name:", ws_kmz.name)
   # print("Antes de insertar imagen:", ws_kmz.pictures.count)
    # Inserta imagen KML en la hoja de Formato KMZ
   # if kml_image_path and os.path.exists(kml_image_path):
      #  try:
       #    cell = ws_kmz.range('C21')  # Usa 'C21' para centrar la imagen
      #     ws_kmz.pictures.add(
          #     os.path.abspath(kml_image_path),
           #    left=cell.left,
           #    top=cell.top,
           #    width=cell.width * 6,   # Ajusta el ancho para cubrir varias columnas si lo deseas
          #     height=180
        #  )
         #  print("Imagen KML insertada")
      #  except Exception as e:
        #    print(f"Error al insertar imagen KML: {e}")
   # print("Despu√©s de insertar imagen:", ws_kmz.pictures.count)
    # Guarda y cierra el archivo solo una vez
    print("KML IMAGE PATH:", kml_image_path)
    print("EXISTS:", os.path.exists(kml_image_path) if kml_image_path else False)
    print("SIZE:", os.path.getsize(kml_image_path) if kml_image_path and os.path.exists(kml_image_path) else "NO FILE")
    # Hoja 3: Formato KMZ
    kmz_img_path = imagen_kmz_path if imagen_kmz_path and os.path.exists(imagen_kmz_path) else (
        kml_image_path if kml_image_path and os.path.exists(kml_image_path) else None
    )
    if kmz_img_path:
        ws_kmz = wb.sheets['3. Formato KMZ']
        cell_range = ws_kmz.range('B21:F38')  # O el rango que desees
        ws_kmz.pictures.add(
            os.path.abspath(kmz_img_path),
            left=cell_range.left,
            top=cell_range.top,
            width=cell_range.width,
            height=cell_range.height
        )

# Hoja 5: Estudio de informaci√≥n B
    if imagen_b_path and os.path.exists(imagen_b_path):
        ws_b = wb.sheets['5. Estudio de informacion B']
        cell_range = ws_b.range('B36:AJ45')
        ws_b.pictures.add(
            os.path.abspath(imagen_b_path),
            left=cell_range.left,
            top=cell_range.top,
            width=cell_range.width,
            height=cell_range.height
      )
    
    
    
    # Intentar guardar con m√∫ltiples estrategias
    guardado_exitoso = False
    max_intentos_guardado = 3
    
    for intento in range(max_intentos_guardado):
        try:
            print(f"DEBUG: Intento {intento + 1} de guardar archivo en: {output_path}")
            wb.save(output_path)
            print(f"DEBUG: Guardado exitoso en intento {intento + 1}")
            guardado_exitoso = True
            break
        except Exception as e:
            print(f"DEBUG: Error en intento {intento + 1}: {e}")
            
            if intento < max_intentos_guardado - 1:
                # Intentar guardar como backup
                try:
                    time_module = __import__('time')
                    backup_path = output_path.replace('.xlsx', f'_backup_{int(time_module.time())}.xlsx')
                    print(f"DEBUG: Intentando guardar como backup: {backup_path}")
                    wb.save(backup_path)
                    print(f"DEBUG: Guardado como backup exitoso: {backup_path}")
                    output_path = backup_path
                    guardado_exitoso = True
                    break
                except Exception as backup_e:
                    print(f"DEBUG: Error en backup: {backup_e}")
                    time.sleep(2)
            else:
                print(f"DEBUG: Todos los intentos de guardado fallaron")
    
    if not guardado_exitoso:
        wb.close()
        app_excel.quit()
        return f"Error: No se pudo guardar el archivo despu√©s de {max_intentos_guardado} intentos"
    import os
    if not os.path.exists(output_path):
        print(f"Error: El archivo de salida no se pudo guardar correctamente en: {output_path}")
        wb.close()
        app_excel.quit()
        return f"Error: El archivo de salida no se pudo guardar correctamente en: {output_path}"
    time.sleep(1)
    
    # Cerrar Excel de forma segura
    try:
        wb.close()
        print("DEBUG: Workbook cerrado correctamente")
    except Exception as close_error:
        print(f"DEBUG: Error al cerrar workbook: {close_error}")
    
    try:
        app_excel.quit()
        print("DEBUG: Excel cerrado correctamente")
    except Exception as quit_error:
        print(f"DEBUG: Error al cerrar Excel: {quit_error}")
        # Forzar cierre de Excel
        try:
            subprocess.run(['taskkill', '/f', '/im', 'excel.exe'], capture_output=True)
            print("DEBUG: Excel forzado a cerrar")
        except:
            print("DEBUG: No se pudo forzar el cierre de Excel")

    # --- 3. Inserta archivos como OLEObjects (√≠conos) usando win32com ---
    try:
        try:
            if not HAS_WIN32COM:
                return "Error: win32com.client not available in this environment"
            excel = get_excel_app()
        except Exception as e:
            return f"Error al inicializar Excel para OLE: {e}"
        # Chequeo previo: existencia y permisos del archivo
        import os
        if not os.path.exists(output_path):
            return f"Error: El archivo de salida no existe en la ruta esperada: {output_path}"
        if not os.access(output_path, os.R_OK | os.W_OK):
            return f"Error: No tienes permisos de lectura/escritura para el archivo: {output_path}"
        # try/except para Workbooks.Open
        try:
            wb_com = excel.Workbooks.Open(output_path)
        except Exception as e:
            try:
                if 'excel' in locals() and excel is not None:
                    excel.Quit()
            except Exception:
                pass
            return f"Error al abrir el archivo Excel para OLE: {e}"
        if wb_com is None:
            try:
                if 'excel' in locals() and excel is not None:
                    excel.Quit()
            except Exception:
                pass
            # Intenta eliminar el archivo corrupto o bloqueado
            try:
                if os.path.exists(output_path):
                    os.remove(output_path)
                return "Error: No se pudo abrir el archivo Excel para incrustar archivos OLE. El archivo fue eliminado autom√°ticamente por estar corrupto o bloqueado. Por favor, vuelve a intentar el proceso."
            except Exception as e:
                return f"Error: No se pudo abrir ni eliminar el archivo Excel de salida. Detalle: {e}"
        # Inserta el archivo Excel como objeto en N52 de la hoja 5
        if archivo_excel_b_path and os.path.exists(archivo_excel_b_path):
            ws_b_com = wb_com.Sheets("5. Estudio de informacion B")
            ws_b_com.OLEObjects().Add(
                Filename=archivo_excel_b_path,
                Link=False,
                DisplayAsIcon=True,
                IconFileName="C:\\Windows\\System32\\shell32.dll",
                IconIndex=1,
                IconLabel=os.path.basename(archivo_excel_b_path),
                Left=ws_b_com.Range("N52").Left,
                Top=ws_b_com.Range("N52").Top
            )

        if word_file_path and os.path.exists(word_file_path):
            ws_word = wb_com.Sheets("1. Analisis de Red y Frecuencia")
            ws_word.OLEObjects().Add(
                Filename=word_file_path,
                Link=False,
                DisplayAsIcon=True,
                IconFileName="C:\\Windows\\System32\\shell32.dll",
                IconIndex=2,  # Cambia el icono si lo deseas
                IconLabel=os.path.basename(word_file_path),
                Left=ws_word.Range("D12").Left,
                Top=ws_word.Range("D12").Top
           ) 
        


        # Incrusta los PDF en la hoja "4. Estudio de informacion A"
        ws_a_com = wb_com.Sheets("4. Estudio de informacion A")
        pdf_icon_cells = ['AB121', 'AB166', 'AB200', 'AB220', 'AB240', 'AB260']
        print(f"DEBUG: Intentando insertar {len(pdf_paths)} PDFs en la hoja 4. Estudio de informacion A")
        for idx, pdf_path in enumerate(pdf_paths):
            print(f"DEBUG: PDF {idx}: {pdf_path} - Existe: {os.path.exists(pdf_path) if pdf_path else False}")
            if idx < len(pdf_icon_cells) and os.path.exists(pdf_path):
                try:
                    ws_a_com.OLEObjects().Add(
                        Filename=pdf_path,
                        Link=False,
                        DisplayAsIcon=True,
                        IconFileName="C:\\Windows\\System32\\shell32.dll",
                        IconIndex=0,
                        IconLabel=os.path.basename(pdf_path),
                        Left=ws_a_com.Range(pdf_icon_cells[idx]).Left,
                        Top=ws_a_com.Range(pdf_icon_cells[idx]).Top
                    )
                    print(f"DEBUG: PDF {idx} insertado correctamente en {pdf_icon_cells[idx]}")
                except Exception as e:
                    print(f"DEBUG: Error insertando PDF {idx}: {e}")
            else:
                print(f"DEBUG: PDF {idx} no se insert√≥ - no existe o √≠ndice fuera de rango")

        # Incrusta el KMZ en la hoja "3. Formato KMZ"
        if kmz_path and os.path.exists(kmz_path):
            ws_kmz_com = wb_com.Sheets("3. Formato KMZ")
            ws_kmz_com.OLEObjects().Add(
                Filename=kmz_path,
                Link=False,
                DisplayAsIcon=True,
                IconFileName="C:\\Windows\\System32\\shell32.dll",
                IconIndex=0,
                IconLabel=os.path.basename(kmz_path),
                Left=ws_kmz_com.Range("C12").Left,
                Top=ws_kmz_com.Range("C12").Top
            )

        wb_com.Save()
        wb_com.Close()
        excel.Quit()
    except Exception as e:
        return f"Error al incrustar archivos OLE: {e}"

    time.sleep(1)
    
    # Verificar el tipo de llenado para mostrar la confirmaci√≥n apropiada
    if tipo == 'diseno_solucion':
        # --- DEBUG: Confirmando que estamos procesando dise√±o de soluci√≥n ---
        print("üîç DEBUG: Procesando tipo 'diseno_solucion' - Las im√°genes se guardaron pero NO se insertaron en Excel")
        
        # --- VERIFICAR ESTADO DE LAS IM√ÅGENES ---
        print(f"üîç DEBUG: Estado de las im√°genes:")
        print(f"  - imagenes_electricas_paths: {imagenes_electricas_paths if 'imagenes_electricas_paths' in locals() else 'NO DEFINIDO'}")
        print(f"  - imagenes_torres_paths: {imagenes_torres_paths if 'imagenes_torres_paths' in locals() else 'NO DEFINIDO'}")
        print(f"  - imagenes_torres_b_paths: {imagenes_torres_b_paths if 'imagenes_torres_b_paths' in locals() else 'NO DEFINIDO'}")
        print(f"  - img_consumo_path: {img_consumo_path if 'img_consumo_path' in locals() else 'NO DEFINIDO'}")
        print(f"  - img_configuracion_path: {img_configuracion_path if 'img_configuracion_path' in locals() else 'NO DEFINIDO'}")
        print(f"  - img_linea_vista_path: {img_linea_vista_path if 'img_linea_vista_path' in locals() else 'NO DEFINIDO'}")
        print(f"  - imagen_kmz_path: {imagen_kmz_path if 'imagen_kmz_path' in locals() else 'NO DEFINIDO'}")
        print(f"  - imagen_b_path: {imagen_b_path if 'imagen_b_path' in locals() else 'NO DEFINIDO'}")
        
        # --- VERIFICAR ARCHIVO WORD ---
        print(f"üîç DEBUG: Archivo Word:")
        print(f"  - word_file_path: {word_file_path if 'word_file_path' in locals() else 'NO DEFINIDO'}")
        print(f"  - ¬øExiste word_file_path? {os.path.exists(word_file_path) if 'word_file_path' in locals() and word_file_path else False}")
        
        # --- VERIFICAR RUTA DEL ARCHIVO EXCEL ---
        print(f"üîç DEBUG: Archivo Excel generado:")
        print(f"  - output_path: {output_path}")
        print(f"  - ¬øExiste output_path? {os.path.exists(output_path) if 'output_path' in locals() else False}")
        
        # --- INSERTAR ARCHIVO WORD EN DISE√ëO DE SOLUCI√ìN ---
        if word_file_path and os.path.exists(word_file_path) and os.path.exists(output_path):
            print("üîç DEBUG: Intentando insertar archivo Word en dise√±o de soluci√≥n...")
            try:
                # Abrir el archivo Excel para insertar el Word
                import xlwings as xw
                app_excel = xw.App(visible=False)
                wb = app_excel.books.open(output_path)
                
                # Insertar en la hoja 1: "An√°lisis de Red y Frecuencia" en D12
                ws_word = wb.sheets['1. An√°lisis de Red y Frecuencia']
                cell_range = ws_word.range('D12')
                
                # Insertar el archivo Word como imagen/objeto
                ws_word.pictures.add(
                    os.path.abspath(word_file_path),
                    left=cell_range.left,
                    top=cell_range.top,
                    width=cell_range.width * 2,  # Hacer el objeto un poco m√°s grande
                    height=cell_range.height * 2
                )
                
                # Guardar y cerrar
                wb.save()
                wb.close()
                app_excel.quit()
                
                print("‚úÖ Archivo Word insertado exitosamente en D12 de la hoja 'An√°lisis de Red y Frecuencia'")
                
            except Exception as e:
                print(f"‚ùå Error insertando archivo Word: {e}")
                # Intentar cerrar Excel si est√° abierto
                try:
                    if 'wb' in locals():
                        wb.close()
                    if 'app_excel' in locals():
                        app_excel.quit()
                except:
                    pass
        else:
            print("‚ö†Ô∏è No se puede insertar archivo Word - faltan archivos o rutas")
        
        # Generar p√°gina de confirmaci√≥n con el mismo estilo que Site Survey
        html = f"""
        <!DOCTYPE html>
        <html lang="es">
        <head>
            <meta charset="UTF-8">
            <title>FANGIO TELECOM | Documento Generado</title>
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
            <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
            <style>
                * {{
                    margin: 0;
                    padding: 0;
                    box-sizing: border-box;
                }}

                body {{
                    font-family: 'Montserrat', Arial, sans-serif;
                    min-height: 100vh;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    background-size: cover;
                    background-position: center;
                    background-attachment: fixed;
                    background-repeat: no-repeat;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                    position: relative;
                    overflow-x: hidden;
                    color: #333;
                }}

                .world-background {{
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: url('{url_for('static', filename='images/earth-background.jpg')}') no-repeat center center;
                    background-size: cover;
                    opacity: 0.3;
                    z-index: -1;
                }}

                .main-container {{
                    width: 100%;
                    max-width: 800px;
                    margin: 0 auto;
                    padding: 20px;
                    z-index: 1;
                }}

                .content-card {{
                    background: rgba(255, 255, 255, 0.95);
                    backdrop-filter: blur(10px);
                    border-radius: 20px;
                    padding: 40px;
                    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
                    text-align: center;
                }}

                .header {{
                    margin-bottom: 30px;
                }}

                .success-icon {{
                    width: 80px;
                    height: 80px;
                    background: linear-gradient(135deg, #00c37a 0%, #00a870 100%);
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    margin: 0 auto 20px;
                    box-shadow: 0 10px 30px rgba(0, 195, 122, 0.4);
                    animation: pulse 2s infinite;
                }}

                @keyframes pulse {{
                    0% {{ transform: scale(1); }}
                    50% {{ transform: scale(1.05); }}
                    100% {{ transform: scale(1); }}
                }}

                .success-icon i {{
                    font-size: 2.5rem;
                    color: white;
                }}

                .success-title {{
                    color: #00c37a;
                    font-size: 2.5rem;
                    font-weight: 700;
                    margin-bottom: 10px;
                    text-shadow: 0 2px 10px rgba(0, 195, 122, 0.3);
                }}

                .success-subtitle {{
                    color: #666;
                    font-size: 1.2rem;
                    margin-bottom: 30px;
                }}

                .info-container {{
                    background: rgba(102, 126, 234, 0.1);
                    border-radius: 15px;
                    padding: 25px;
                    margin-bottom: 30px;
                    border-left: 5px solid #667eea;
                }}

                .info-item {{
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    margin-bottom: 15px;
                    font-size: 1.1rem;
                }}

                .info-item:last-child {{
                    margin-bottom: 0;
                }}

                .info-item i {{
                    color: #667eea;
                    margin-right: 12px;
                    font-size: 1.2rem;
                    width: 20px;
                    text-align: center;
                }}

                .info-item span {{
                    color: #333;
                    font-weight: 500;
                }}

                .buttons-container {{
                    display: flex;
                    flex-direction: column;
                    gap: 15px;
                }}

                .action-button {{
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 15px;
                    padding: 20px 30px;
                    border-radius: 12px;
                    text-decoration: none;
                    font-weight: 600;
                    font-size: 1.1rem;
                    transition: all 0.3s ease;
                    border: none;
                    cursor: pointer;
                    position: relative;
                    overflow: hidden;
                    min-height: 60px;
                }}

                .save-button {{
                    background: linear-gradient(135deg, #00c37a 0%, #00a870 100%);
                    color: white;
                    box-shadow: 0 8px 25px rgba(0, 195, 122, 0.4);
                }}

                .save-button:hover {{
                    background: linear-gradient(135deg, #00a870 0%, #00c37a 100%);
                    transform: translateY(-2px);
                    box-shadow: 0 12px 35px rgba(0, 195, 122, 0.6);
                }}

                .download-button {{
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
                }}

                .download-button:hover {{
                    background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
                    transform: translateY(-2px);
                    box-shadow: 0 12px 35px rgba(102, 126, 234, 0.6);
                }}

                .upload-button {{
                    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                    color: white;
                    box-shadow: 0 8px 25px rgba(240, 147, 251, 0.4);
                }}

                .upload-button:hover {{
                    background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%);
                    transform: translateY(-2px);
                    box-shadow: 0 12px 35px rgba(240, 147, 251, 0.6);
                }}

                .button-icon {{
                    font-size: 1.3rem;
                    width: 24px;
                    text-align: center;
                }}

                .button-text {{
                    flex: 1;
                    text-align: center;
                }}

                .footer {{
                    text-align: center;
                    margin-top: 30px;
                    color: #666;
                    font-size: 0.9rem;
                }}
            </style>
        </head>
        <body>
            <!-- Fondo del mundo EXACTO del site survey -->
            <div class="world-background"></div>
            
            <div class="main-container">
                <div class="content-card">
                <div class="header">
                    <div class="success-icon">
                            <i class="fas fa-check-circle"></i>
                    </div>
                    <h1 class="success-title">¬°Documento Generado!</h1>
                        <p class="success-subtitle">Dise√±o de Soluci√≥n completado exitosamente</p>
                        {f'<div class="llenado-status" id="llenadoStatus"><i class="fas fa-spinner fa-spin"></i> Llenado autom√°tico en progreso...</div>' if llenado_automatico == 'true' else ''}
                    </div>
                    
                    <div class="info-container">
                        <div class="info-item">
                            <i class="fas fa-id-card"></i>
                            <span><strong>ID:</strong> {user_id}</span>
                        </div>
                        
                        <div class="info-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <span><strong>Sitio A:</strong> {datos.get('Nombre del sitio A', '')}</span>
                        </div>
                        
                        <div class="info-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <span><strong>Sitio B:</strong> {datos.get('Nombre del sitio B', '')}</span>
                        </div>
                    </div>
                    
                    <div class="buttons-container">
                        <!-- BOTONES DE ACCI√ìN PRINCIPAL -->
                        <button onclick="guardarArchivoDiseno('{user_id}', 'diseno_solucion', '{fila_idx}')" class="action-button save-button">
                            <div class="button-icon">
                                <i class="fas fa-save"></i>
                            </div>
                            <div class="button-text">Guardar Archivo</div>
                        </button>
                        
                        <a href="/descargar_diseno_solucion?user_id={user_id}&fila_idx={fila_idx}" class="action-button download-button">
                            <div class="button-icon">
                            <i class="fas fa-download"></i>
                            </div>
                            <div class="button-text">Descargar Archivo Generado (PtP)</div>
                        </a>
                        
                        <!-- BOTONES DE SUBIDA DE IM√ÅGENES -->
                        <a href="/subir_imagenes_ptp?user_id={user_id}&fila_idx={fila_idx}" class="action-button upload-button">
                            <div class="button-icon">
                                <i class="fas fa-camera"></i>
                            </div>
                            <div class="button-text">Subir Im√°genes - Planos A</div>
                        </a>
                        
                        <a href="/subir_imagenes_ptp_planos_b?user_id={user_id}&fila_idx={fila_idx}" class="action-button upload-button">
                            <div class="button-icon">
                                <i class="fas fa-camera"></i>
                            </div>
                            <div class="button-text">Subir Im√°genes - Planos B</div>
                        </a>
                        
                        <a href="/subir_imagenes_ptp_fotos_a?user_id={user_id}&fila_idx={fila_idx}" class="action-button upload-button">
                            <div class="button-icon">
                                <i class="fas fa-camera"></i>
                            </div>
                            <div class="button-text">Subir Im√°genes - Reporte Fotos A</div>
                        </a>
                        
                        <a href="/subir_imagenes_ptp_fotos_b?user_id={user_id}&fila_idx={fila_idx}" class="action-button upload-button">
                            <div class="button-icon">
                                <i class="fas fa-camera"></i>
                    </div>
                            <div class="button-text">Subir Im√°genes - Reporte Fotos B</div>
                        </a>

                        <!-- BOTONES DE SUBIDA DE ARCHIVOS ADICIONALES -->
                        <a href="/subir_doc_diseno?user_id={user_id}&fila_idx={fila_idx}" class="action-button upload-button">
                            <div class="button-icon">
                                <i class="fas fa-file-word"></i>
                            </div>
                            <div class="button-text">Subir Documentos Word - Hoja 1</div>
                        </a>
                        
                        <a href="/subir_kmz_diseno?user_id={user_id}&fila_idx={fila_idx}" class="action-button upload-button">
                            <div class="button-icon">
                                <i class="fas fa-map-marked-alt"></i>
                            </div>
                            <div class="button-text">Subir Archivos KMZ - Hoja 3</div>
                        </a>
                        
                        <a href="/subir_pdf_diseno?user_id={user_id}&fila_idx={fila_idx}" class="action-button upload-button">
                            <div class="button-icon">
                                <i class="fas fa-file-pdf"></i>
                            </div>
                            <div class="button-text">Subir Documentos PDF - Hoja 4</div>
                        </a>
                        
                        <a href="/subir_xlsx_diseno?user_id={user_id}&fila_idx={fila_idx}" class="action-button upload-button">
                            <div class="button-icon">
                                <i class="fas fa-file-excel"></i>
                            </div>
                            <div class="button-text">Subir Archivos Excel - Hoja 5</div>
                        </a>
                        
                        <a href="/subir_dwg_diseno?user_id={user_id}&fila_idx={fila_idx}" class="action-button upload-button">
                            <div class="button-icon">
                                <i class="fas fa-drafting-compass"></i>
                            </div>
                            <div class="button-text">Subir Archivos DWG - Hoja 6</div>
                        </a>
                        
                        <a href="/subir_zip_diseno?user_id={user_id}&fila_idx={fila_idx}" class="action-button upload-button">
                            <div class="button-icon">
                                <i class="fas fa-file-archive"></i>
                            </div>
                            <div class="button-text">Subir Archivos ZIP - Hoja 7</div>
                        </a>
                        
                        <a href="/subir_imagenes_kmz_diseno?user_id={user_id}&fila_idx={fila_idx}" class="action-button upload-button">
                            <div class="button-icon">
                                <i class="fas fa-image"></i>
                            </div>
                            <div class="button-text">Subir Im√°genes KMZ - Hoja 8</div>
                        </a>
                        
                        <!-- BOTONES DE NAVEGACI√ìN -->
                        <a href="/subir_imagenes_ptp_fotos_a?user_id={user_id}&fila_idx={fila_idx}" class="action-button upload-button">
                            <div class="button-icon">
                                <i class="fas fa-images"></i>
                            </div>
                            <div class="button-text">Ir a Reporte de Planeaci√≥n</div>
                        </a>
                        
                        <a href="/diseno_solucion_directo?user_id={user_id}&fila_idx={fila_idx}&llenado_automatico=true" class="action-button download-button">
                            <div class="button-icon">
                                <i class="fas fa-tools"></i>
                            </div>
                            <div class="button-text">Ir a Dise√±o de Soluci√≥n (DIRECTO)</div>
                        </a>
                    </div>
                </div>
                
                <div class="footer">
                    <p>¬© 2024 FANGIO TELECOM. Todos los derechos reservados.</p>
                </div>
            </div>

            <script>
                // Funci√≥n para guardar archivo de dise√±o de soluci√≥n
                function guardarArchivoDiseno(userId, tipo, filaIdx) {{
                    console.log('Guardando archivo de dise√±o de soluci√≥n:', userId, tipo, filaIdx);
                    
                    // Aqu√≠ puedes implementar la l√≥gica para guardar el archivo
                    // Por ahora, solo mostraremos un mensaje
                    alert('Funci√≥n de guardado implementada para: ' + userId);
                }}
            </script>
        </body>
        </html>
        """
        
        return render_template_string(html)
    else:
        # Para site_survey y otros tipos, usar el comportamiento original
        return send_file(output_path, as_attachment=True)



# ===== RUTAS PARA CARGA DE ARCHIVOS ADICIONALES =====

@app.route('/subir_pdf_diseno', methods=['GET', 'POST'])
def subir_pdf_diseno():
    if request.method == 'GET':
        user_id = request.args.get('user_id')
        fila_idx = request.args.get('fila_idx')
        return render_template_string(f"""
        <!DOCTYPE html>
        <html>
        <head>
            <title>Subir PDF - Dise√±o de Soluci√≥n</title>
            <style>
                body {{ font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }}
                .container {{ max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }}
                h1 {{ color: #333; text-align: center; }}
                .upload-area {{ border: 2px dashed #e67e22; padding: 40px; text-align: center; margin: 20px 0; border-radius: 10px; }}
                .btn {{ background: #e67e22; color: white; padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; margin: 10px; }}
                .btn:hover {{ background: #d35400; }}
            </style>
        </head>
        <body>
            <div class="container">
                <h1>üìÑ Subir PDF - Dise√±o de Soluci√≥n</h1>
                <p><strong>ID:</strong> {user_id}</p>
                <p><strong>Fila:</strong> {fila_idx}</p>
                
                <form method="POST" enctype="multipart/form-data">
                    <input type="hidden" name="user_id" value="{user_id}">
                    <input type="hidden" name="fila_idx" value="{fila_idx}">
                    
                    <div class="upload-area">
                        <h3>üìÑ √Årea de Carga de PDF</h3>
                        <p>Selecciona archivos PDF para el dise√±o de soluci√≥n</p>
                        <input type="file" name="pdf_file" accept=".pdf" class="btn" multiple>
                    </div>
                    
                    <div style="text-align: center;">
                        <button type="button" class="btn" onclick="history.back()">‚¨ÖÔ∏è Volver</button>
                        <button type="submit" class="btn">üíæ Subir PDF</button>
                    </div>
                </form>
            </div>
        </body>
        </html>
        """)
    
    # POST method - Implementaci√≥n completa para PDF
    if request.method == 'POST':
        user_id = request.form.get('user_id')
        fila_idx = request.form.get('fila_idx')
        
        if not user_id:
            return jsonify({'success': False, 'message': 'Falta el user_id'})
        
        try:
            # Definir base_dir
            base_dir = os.path.dirname(os.path.abspath(__file__))
            
            # Crear directorio para PDFs si no existe
            pdfs_dir = os.path.join(base_dir, 'uploads', 'pdfs_diseno', user_id)
            os.makedirs(pdfs_dir, exist_ok=True)
            
            # Procesar cada PDF subido
            pdfs_procesados = []
            
            # Obtener todos los archivos PDF subidos
            pdf_files = request.files.getlist('pdf_file')
            
            for i, archivo in enumerate(pdf_files, 1):
                if archivo and archivo.filename != '':
                    # Generar nombre √∫nico para el PDF
                    nombre_archivo = f"pdf_{i}_{user_id}_{int(time.time())}.pdf"
                    ruta_archivo = os.path.join(pdfs_dir, nombre_archivo)
                    
                    # Guardar el PDF
                    archivo.save(ruta_archivo)
                    pdfs_procesados.append({
                        'numero': i,
                        'ruta': ruta_archivo,
                        'nombre_original': archivo.filename
                    })
            
            if not pdfs_procesados:
                return jsonify({'success': False, 'message': 'No se subieron archivos PDF'})
            
            # Guardar informaci√≥n de los PDFs en el Excel
            try:
                import xlwings as xw
                import re
                import time
                
                plantilla_path = os.path.join(base_dir, 'static', 'plantillas', 'EJEMPLO SS VACIO.xlsx')
                user_id_limpio = re.sub(r'[<>:"/\\|?*]', '', str(user_id))
                output_path = os.path.join(base_dir, 'site_survey', f'ss_{user_id_limpio}.xlsx')
                
                # Verificar que el archivo Excel existe
                if not os.path.exists(output_path):
                    import glob
                    patron_archivo = os.path.join(base_dir, 'site_survey', f'ss_{user_id_limpio}*.xlsx')
                    archivos_encontrados = glob.glob(patron_archivo)
                    
                    if archivos_encontrados:
                        output_path = max(archivos_encontrados, key=os.path.getctime)
                    else:
                        return jsonify({
                            'success': False,
                            'message': f'El archivo Excel no existe. Primero debes generar el Site Survey.'
                        })
                
                # Abrir el archivo Excel existente
                app_excel = xw.App(visible=False)
                wb = app_excel.books.open(output_path)
                
                # Insertar PDFs en la hoja 4. Estudio de informacion A (seg√∫n app2.py)
                try:
                    ws_a = wb.sheets['4. Estudio de informacion A']
                except Exception:
                    return jsonify({'error': 'No se pudo acceder a la hoja 4. Estudio de informacion A'})
                
                # Definir las celdas donde insertar los PDFs seg√∫n app2.py
                celdas_pdfs = ['AB121', 'AB166', 'AB200', 'AB220', 'AB240', 'AB260']
                
                # Insertar los PDFs como iconos OLE seg√∫n app2.py
                for idx, pdf in enumerate(pdfs_procesados):
                    if idx < len(celdas_pdfs):
                        rango_celda = celdas_pdfs[idx]
                        
                        try:
                            # Insertar PDF como objeto OLE usando win32com (como en app2.py)
                            if not HAS_WIN32COM:
                                print("Warning: win32com not available, skipping PDF insertion")
                                continue
                            excel = get_excel_app()
                            excel.Visible = False
                            
                            # Abrir el archivo para inserci√≥n OLE
                            wb_com = excel.Workbooks.Open(output_path)
                            ws_a_com = wb_com.Sheets("4. Estudio de informacion A")
                            
                            # Insertar PDF como icono OLE
                            ws_a_com.OLEObjects().Add(
                                Filename=pdf['ruta'],
                                Link=False,
                                DisplayAsIcon=True,
                                IconFileName="C:\\Windows\\System32\\shell32.dll",
                                IconIndex=0,
                                IconLabel=os.path.basename(pdf['ruta']),
                                Left=ws_a_com.Range(rango_celda).Left,
                                Top=ws_a_com.Range(rango_celda).Top
                            )
                            
                            # Guardar y cerrar
                            wb_com.Save()
                            wb_com.Close()
                            excel.Quit()
                            
                        except Exception as e:
                            print(f"Error insertando PDF {idx+1} en {rango_celda}: {e}")
                            # Continuar con el siguiente PDF
                            pass
                
                # Guardar y cerrar
                wb.save()
                wb.close()
                app_excel.quit()
                
                return jsonify({
                    'success': True,
                    'message': f'Se subieron {len(pdfs_procesados)} PDFs correctamente',
                    'pdfs': pdfs_procesados
                })
                
            except Exception as e:
                return jsonify({
                    'success': False,
                    'message': f'Error al procesar los PDFs en Excel: {str(e)}'
                })
                
        except Exception as e:
            return jsonify({
                'success': False,
                'message': f'Error al subir los PDFs: {str(e)}'
            })
    
    return "M√©todo no permitido"

@app.route('/subir_xlsx_diseno', methods=['GET', 'POST'])
def subir_xlsx_diseno():
    if request.method == 'GET':
        user_id = request.args.get('user_id')
        fila_idx = request.args.get('fila_idx')
        return render_template_string(f"""
        <!DOCTYPE html>
        <html>
        <head>
            <title>Subir XLSX - Dise√±o de Soluci√≥n</title>
            <style>
                body {{ font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }}
                .container {{ max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }}
                h1 {{ color: #333; text-align: center; }}
                .upload-area {{ border: 2px dashed #e67e22; padding: 40px; text-align: center; margin: 20px 0; border-radius: 10px; }}
                .btn {{ background: #e67e22; color: white; padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; margin: 10px; }}
                .btn:hover {{ background: #d35400; }}
            </style>
        </head>
        <body>
            <div class="container">
                <h1>üìä Subir XLSX - Dise√±o de Soluci√≥n</h1>
                <p><strong>ID:</strong> {user_id}</p>
                <p><strong>Fila:</strong> {fila_idx}</p>
                
                <form method="POST" enctype="multipart/form-data">
                    <input type="hidden" name="user_id" value="{user_id}">
                    <input type="hidden" name="fila_idx" value="{fila_idx}">
                    
                    <div class="upload-area">
                        <h3>üìä √Årea de Carga de XLSX</h3>
                        <p>Selecciona archivos Excel para el dise√±o de soluci√≥n</p>
                        <input type="file" name="xlsx_file" accept=".xlsx,.xls" class="btn" multiple>
                    </div>
                    
                    <div style="text-align: center;">
                        <button type="button" class="btn" onclick="history.back()">‚¨ÖÔ∏è Volver</button>
                        <button type="submit" class="btn">üíæ Subir XLSX</button>
                    </div>
                </form>
            </div>
        </body>
        </html>
        """)
    
    # POST method - Implementaci√≥n completa para XLSX
    if request.method == 'POST':
        user_id = request.form.get('user_id')
        fila_idx = request.form.get('fila_idx')
        
        if not user_id:
            return jsonify({'success': False, 'message': 'Falta el user_id'})
        
        try:
            # Definir base_dir
            base_dir = os.path.dirname(os.path.abspath(__file__))
            
            # Crear directorio para XLSX si no existe
            xlsx_dir = os.path.join(base_dir, 'uploads', 'xlsx_diseno', user_id)
            os.makedirs(xlsx_dir, exist_ok=True)
            
            # Procesar cada XLSX subido
            xlsx_procesados = []
            
            # Obtener todos los archivos XLSX subidos
            xlsx_files = request.files.getlist('xlsx_file')
            
            for i, archivo in enumerate(xlsx_files, 1):
                if archivo and archivo.filename != '':
                    # Generar nombre √∫nico para el XLSX
                    nombre_archivo = f"xlsx_{i}_{user_id}_{int(time.time())}.xlsx"
                    ruta_archivo = os.path.join(xlsx_dir, nombre_archivo)
                    
                    # Guardar el XLSX
                    archivo.save(ruta_archivo)
                    xlsx_procesados.append({
                        'numero': i,
                        'ruta': ruta_archivo,
                        'nombre_original': archivo.filename
                    })
            
            if not xlsx_procesados:
                return jsonify({'success': False, 'message': 'No se subieron archivos XLSX'})
            
            # Guardar informaci√≥n de los XLSX en el Excel
            try:
                import xlwings as xw
                import re
                import time
                
                plantilla_path = os.path.join(base_dir, 'static', 'plantillas', 'EJEMPLO SS VACIO.xlsx')
                user_id_limpio = re.sub(r'[<>:"/\\|?*]', '', str(user_id))
                output_path = os.path.join(base_dir, 'site_survey', f'ss_{user_id_limpio}.xlsx')
                
                # Verificar que el archivo Excel existe
                if not os.path.exists(output_path):
                    import glob
                    patron_archivo = os.path.join(base_dir, 'site_survey', f'ss_{user_id_limpio}*.xlsx')
                    archivos_encontrados = glob.glob(patron_archivo)
                    
                    if archivos_encontrados:
                        output_path = max(archivos_encontrados, key=os.path.getctime)
                    else:
                        return jsonify({
                            'success': False,
                            'message': f'El archivo Excel no existe. Primero debes generar el Site Survey.'
                        })
                
                # Abrir el archivo Excel existente
                app_excel = xw.App(visible=False)
                wb = app_excel.books.open(output_path)
                
                # Insertar XLSX en la hoja 5. Estudio de informacion B (seg√∫n app2.py)
                try:
                    ws_b = wb.sheets['5. Estudio de informacion B']
                except Exception:
                    return jsonify({'error': 'No se pudo acceder a la hoja 5. Estudio de informacion B'})
                
                # Definir la celda donde insertar el XLSX seg√∫n app2.py
                celda_xlsx = 'N52'
                
                # Insertar el XLSX como icono OLE seg√∫n app2.py
                if xlsx_procesados:
                    xlsx = xlsx_procesados[0]  # Solo el primer XLSX
                    
                    try:
                        # Insertar XLSX como objeto OLE usando win32com (como en app2.py)
                        if not HAS_WIN32COM:
                            print("Warning: win32com not available, skipping XLSX insertion")
                        else:
                            excel = get_excel_app()
                            excel.Visible = False
                            
                            # Abrir el archivo para inserci√≥n OLE
                            wb_com = excel.Workbooks.Open(output_path)
                            ws_b_com = wb_com.Sheets("5. Estudio de informacion B")
                            
                            # Insertar XLSX como icono OLE
                            ws_b_com.OLEObjects().Add(
                                Filename=xlsx['ruta'],
                                Link=False,
                                DisplayAsIcon=True,
                                IconFileName="C:\\Windows\\System32\\shell32.dll",
                                IconIndex=1,
                                IconLabel=os.path.basename(xlsx['ruta']),
                                Left=ws_b_com.Range(celda_xlsx).Left,
                                Top=ws_b_com.Range(celda_xlsx).Top
                            )
                            
                            # Guardar y cerrar
                            wb_com.Save()
                            wb_com.Close()
                            excel.Quit()
                        
                    except Exception as e:
                        print(f"Error insertando XLSX en {celda_xlsx}: {e}")
                        # Continuar sin insertar
                        pass
                
                # Guardar y cerrar
                wb.save()
                wb.close()
                app_excel.quit()
                
                return jsonify({
                    'success': True,
                    'message': f'Se subieron {len(xlsx_procesados)} archivos XLSX correctamente',
                    'xlsx': xlsx_procesados
                })
                
            except Exception as e:
                return jsonify({
                    'success': False,
                    'message': f'Error al procesar los XLSX en Excel: {str(e)}'
                })
                
        except Exception as e:
            return jsonify({
                'success': False,
                'message': f'Error al subir los XLSX: {str(e)}'
            })
    
    return "M√©todo no permitido"

@app.route('/subir_kmz_diseno', methods=['GET', 'POST'])
def subir_kmz_diseno():
    if request.method == 'GET':
        user_id = request.args.get('user_id')
        fila_idx = request.args.get('fila_idx')
        return render_template_string(f"""
        <!DOCTYPE html>
        <html>
        <head>
            <title>Subir KMZ - Dise√±o de Soluci√≥n</title>
            <style>
                body {{ font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }}
                .container {{ max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }}
                h1 {{ color: #333; text-align: center; }}
                .upload-area {{ border: 2px dashed #e67e22; padding: 40px; text-align: center; margin: 20px 0; border-radius: 10px; }}
                .btn {{ background: #e67e22; color: white; padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; margin: 10px; }}
                .btn:hover {{ background: #d35400; }}
            </style>
        </head>
        <body>
            <div class="container">
                <h1>üó∫Ô∏è Subir KMZ - Dise√±o de Soluci√≥n</h1>
                <p><strong>ID:</strong> {user_id}</p>
                <p><strong>Fila:</strong> {fila_idx}</p>
                
                <form method="POST" enctype="multipart/form-data">
                    <input type="hidden" name="user_id" value="{user_id}">
                    <input type="hidden" name="fila_idx" value="{fila_idx}">
                    
                    <div class="upload-area">
                        <h3>üó∫Ô∏è √Årea de Carga de KMZ</h3>
                        <p>Selecciona archivos KMZ/KML para Google Earth</p>
                        <input type="file" name="kmz_file" accept=".kmz,.kml" class="btn" multiple>
                    </div>
                    
                    <div style="text-align: center;">
                        <button type="button" class="btn" onclick="history.back()">‚¨ÖÔ∏è Volver</button>
                        <button type="submit" class="btn">üíæ Subir KMZ</button>
                    </div>
                </form>
            </div>
        </body>
        </html>
        """)
    
    # POST method - Implementaci√≥n completa para KMZ
    if request.method == 'POST':
        user_id = request.form.get('user_id')
        fila_idx = request.form.get('fila_idx')
        
        if not user_id:
            return jsonify({'success': False, 'message': 'Falta el user_id'})
        
        try:
            # Definir base_dir
            base_dir = os.path.dirname(os.path.abspath(__file__))
            
            # Crear directorio para KMZ si no existe
            kmz_dir = os.path.join(base_dir, 'uploads', 'kmz_diseno', user_id)
            os.makedirs(kmz_dir, exist_ok=True)
            
            # Procesar cada KMZ subido
            kmz_procesados = []
            
            # Obtener todos los archivos KMZ subidos
            kmz_files = request.files.getlist('kmz_file')
            
            for i, archivo in enumerate(kmz_files, 1):
                if archivo and archivo.filename != '':
                    # Generar nombre √∫nico para el KMZ
                    nombre_archivo = f"kmz_{i}_{user_id}_{int(time.time())}.kmz"
                    ruta_archivo = os.path.join(kmz_dir, nombre_archivo)
                    
                    # Guardar el KMZ
                    archivo.save(ruta_archivo)
                    kmz_procesados.append({
                        'numero': i,
                        'ruta': ruta_archivo,
                        'nombre_original': archivo.filename
                    })
            
            if not kmz_procesados:
                return jsonify({'success': False, 'message': 'No se subieron archivos KMZ'})
            
            # Guardar informaci√≥n de los KMZ en el Excel
            try:
                import xlwings as xw
                import re
                import time
                
                plantilla_path = os.path.join(base_dir, 'static', 'plantillas', 'EJEMPLO SS VACIO.xlsx')
                user_id_limpio = re.sub(r'[<>:"/\\|?*]', '', str(user_id))
                output_path = os.path.join(base_dir, 'site_survey', f'ss_{user_id_limpio}.xlsx')
                
                # Verificar que el archivo Excel existe
                if not os.path.exists(output_path):
                    import glob
                    patron_archivo = os.path.join(base_dir, 'site_survey', f'ss_{user_id_limpio}*.xlsx')
                    archivos_encontrados = glob.glob(patron_archivo)
                    
                    if archivos_encontrados:
                        output_path = max(archivos_encontrados, key=os.path.getctime)
                    else:
                        return jsonify({
                            'success': False,
                            'message': f'El archivo Excel no existe. Primero debes generar el Site Survey.'
                        })
                
                # Abrir el archivo Excel existente
                app_excel = xw.App(visible=False)
                wb = app_excel.books.open(output_path)
                
                # Insertar KMZ en la hoja 3. Formato KMZ (seg√∫n app2.py)
                try:
                    ws_kmz = wb.sheets['3. Formato KMZ']
                except:
                    return jsonify({'error': 'No se pudo acceder a la hoja 3. Formato KMZ'})
                
                # Definir la celda donde insertar el KMZ seg√∫n app2.py
                celda_kmz = 'C12'
                
                # Insertar el KMZ como icono OLE seg√∫n app2.py
                if kmz_procesados:
                    kmz = kmz_procesados[0]  # Solo el primer KMZ
                    
                    try:
                        # Insertar KMZ como objeto OLE usando win32com (como en app2.py)
                        if not HAS_WIN32COM:
                            print("Warning: win32com not available, skipping KMZ insertion")
                        else:
                            excel = get_excel_app()
                            excel.Visible = False
                            
                            # Abrir el archivo para inserci√≥n OLE
                            wb_com = excel.Workbooks.Open(output_path)
                            ws_kmz_com = wb_com.Sheets("3. Formato KMZ")
                            
                            # Insertar KMZ como icono OLE
                            ws_kmz_com.OLEObjects().Add(
                                Filename=kmz['ruta'],
                                Link=False,
                                DisplayAsIcon=True,
                                IconFileName="C:\\Windows\\System32\\shell32.dll",
                                IconIndex=0,
                                IconLabel=os.path.basename(kmz['ruta']),
                                Left=ws_kmz_com.Range(celda_kmz).Left,
                                Top=ws_kmz_com.Range(celda_kmz).Top
                            )
                            
                            # Guardar y cerrar
                            wb_com.Save()
                            wb_com.Close()
                            excel.Quit()
                        
                    except Exception as e:
                        print(f"Error insertando KMZ en {celda_kmz}: {e}")
                        # Continuar sin insertar
                        pass
                
                # Guardar y cerrar
                wb.save()
                wb.close()
                app_excel.quit()
                
                return jsonify({
                    'success': True,
                    'message': f'Se subieron {len(kmz_procesados)} archivos KMZ correctamente',
                    'kmz': kmz_procesados
                })
                
            except Exception as e:
                return jsonify({
                    'success': False,
                    'message': f'Error al procesar los KMZ en Excel: {str(e)}'
                })
                
        except Exception as e:
            return jsonify({
                'success': False,
                'message': f'Error al subir los KMZ: {str(e)}'
            })
    
    return "M√©todo no permitido"

@app.route('/subir_imagen_kmz_diseno', methods=['GET', 'POST'])
def subir_imagen_kmz_diseno():
    if request.method == 'GET':
        user_id = request.args.get('user_id')
        fila_idx = request.args.get('fila_idx')
        return render_template_string(f"""
        <!DOCTYPE html>
        <html>
        <head>
            <title>Subir Imagen KMZ - Dise√±o de Soluci√≥n</title>
            <style>
                body {{ font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }}
                .container {{ max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }}
                h1 {{ color: #333; text-align: center; }}
                .upload-area {{ border: 2px dashed #e67e22; padding: 40px; text-align: center; margin: 20px 0; border-radius: 10px; }}
                .btn {{ background: #e67e22; color: white; padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; margin: 10px; }}
                .btn:hover {{ background: #d35400; }}
            </style>
        </head>
        <body>
            <div class="container">
                <h1>üó∫Ô∏è Subir Imagen Adicional KMZ - Dise√±o de Soluci√≥n</h1>
                <p><strong>ID:</strong> {user_id}</p>
                <p><strong>Fila:</strong> {fila_idx}</p>
                
                <form method="POST" enctype="multipart/form-data">
                    <input type="hidden" name="user_id" value="{user_id}">
                    <input type="hidden" name="fila_idx" value="{fila_idx}">
                    
                    <div class="upload-area">
                        <h3>üó∫Ô∏è √Årea de Carga de Imagen KMZ</h3>
                        <p>Selecciona imagen para insertar en rango B21:F38 de la hoja "3. Formato KMZ"</p>
                        <input type="file" name="imagen_kmz" accept="image/*" class="btn">
                    </div>
                    
                    <div style="text-align: center;">
                        <button type="button" class="btn" onclick="history.back()">‚¨ÖÔ∏è Volver</button>
                        <button type="submit" class="btn">üíæ Subir Imagen KMZ</button>
                    </div>
                </form>
            </div>
        </body>
        </html>
        """)
    
    # POST method - Implementaci√≥n para imagen KMZ
    if request.method == 'POST':
        user_id = request.form.get('user_id')
        fila_idx = request.form.get('fila_idx')
        
        if not user_id:
            return jsonify({'success': False, 'message': 'Falta el user_id'})
        
        try:
            # Definir base_dir
            base_dir = os.path.dirname(os.path.abspath(__file__))
            
            # Crear directorio para imagen KMZ si no existe
            imagen_kmz_dir = os.path.join(base_dir, 'uploads', 'imagen_kmz_diseno', user_id)
            os.makedirs(imagen_kmz_dir, exist_ok=True)
            
            # Procesar imagen KMZ
            imagen_kmz_file = request.files.get('imagen_kmz')
            
            if not imagen_kmz_file or imagen_kmz_file.filename == '':
                return jsonify({'success': False, 'message': 'No se subi√≥ ninguna imagen'})
            
            # Generar nombre √∫nico para la imagen
            nombre_archivo = f"imagen_kmz_{user_id}_{int(time.time())}.jpg"
            ruta_archivo = os.path.join(imagen_kmz_dir, nombre_archivo)
            
            # Guardar la imagen
            imagen_kmz_file.save(ruta_archivo)
            
            # Guardar informaci√≥n de la imagen en el Excel
            try:
                import xlwings as xw
                import re
                import time
                
                plantilla_path = os.path.join(base_dir, 'static', 'plantillas', 'EJEMPLO SS VACIO.xlsx')
                user_id_limpio = re.sub(r'[<>:"/\\|?*]', '', str(user_id))
                output_path = os.path.join(base_dir, 'site_survey', f'ss_{user_id_limpio}.xlsx')
                
                # Verificar que el archivo Excel existe
                if not os.path.exists(output_path):
                    import glob
                    patron_archivo = os.path.join(base_dir, 'site_survey', f'ss_{user_id_limpio}*.xlsx')
                    archivos_encontrados = glob.glob(patron_archivo)
                    
                    if archivos_encontrados:
                        output_path = archivos_encontrados[0]
                    else:
                        return jsonify({'success': False, 'message': 'No se encontr√≥ archivo Excel generado'})
                
                # Abrir Excel y insertar imagen
                app = xw.App(visible=False)
                wb = app.books.open(output_path)
                
                try:
                    # Insertar imagen en la hoja "3. Formato KMZ"
                    ws_kmz = wb.sheets['3. Formato KMZ']
                    cell_range = ws_kmz.range('B21:F38')
                    
                    ws_kmz.pictures.add(
                        os.path.abspath(ruta_archivo),
                        left=cell_range.left,
                        top=cell_range.top,
                        width=cell_range.width,
                        height=cell_range.height
                    )
                    
                    # Guardar Excel
                    wb.save()
                    print(f"DEBUG: Imagen KMZ insertada en rango B21:F38: {ruta_archivo}")
                    
                finally:
                    wb.close()
                    app.quit()
                
                return jsonify({'success': True, 'message': 'Imagen KMZ subida e insertada correctamente en rango B21:F38', 'archivo': ruta_archivo})
                
            except Exception as e:
                return jsonify({'success': False, 'message': f'Error al insertar imagen en Excel: {str(e)}'})
            
        except Exception as e:
            return jsonify({'success': False, 'message': f'Error al procesar imagen KMZ: {str(e)}'})

@app.route('/subir_dwg_diseno', methods=['GET', 'POST'])
def subir_dwg_diseno():
    if request.method == 'GET':
        user_id = request.args.get('user_id')
        fila_idx = request.args.get('fila_idx')
        return render_template_string(f"""
        <!DOCTYPE html>
        <html>
        <head>
            <title>Subir DWG - Dise√±o de Soluci√≥n</title>
            <style>
                body {{ font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }}
                .container {{ max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }}
                h1 {{ color: #333; text-align: center; }}
                .upload-area {{ border: 2px dashed #e67e22; padding: 40px; text-align: center; margin: 20px 0; border-radius: 10px; }}
                .btn {{ background: #e67e22; color: white; padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; margin: 10px; }}
                .btn:hover {{ background: #d35400; }}
            </style>
        </head>
        <body>
            <div class="container">
                <h1>üìê Subir DWG - Dise√±o de Soluci√≥n</h1>
                <p><strong>ID:</strong> {user_id}</p>
                <p><strong>Fila:</strong> {fila_idx}</p>
                
                <form method="POST" enctype="multipart/form-data">
                    <input type="hidden" name="user_id" value="{user_id}">
                    <input type="hidden" name="fila_idx" value="{fila_idx}">
                    
                    <div class="upload-area">
                        <h3>üìê √Årea de Carga de DWG</h3>
                        <p>Selecciona archivos DWG de AutoCAD</p>
                        <input type="file" name="dwg_file" accept=".dwg" class="btn" multiple>
                    </div>
                    
                    <div style="text-align: center;">
                        <button type="button" class="btn" onclick="history.back()">‚¨ÖÔ∏è Volver</button>
                        <button type="submit" class="btn">üíæ Subir DWG</button>
                    </div>
                </form>
            </div>
        </body>
        </html>
        """)
    
    # POST method - Implementaci√≥n completa para DWG
    if request.method == 'POST':
        user_id = request.form.get('user_id')
        fila_idx = request.form.get('fila_idx')
        
        if not user_id:
            return jsonify({'success': False, 'message': 'Falta el user_id'})
        
        try:
            # Definir base_dir
            base_dir = os.path.dirname(os.path.abspath(__file__))
            
            # Crear directorio para DWG si no existe
            dwg_dir = os.path.join(base_dir, 'uploads', 'dwg_diseno', user_id)
            os.makedirs(dwg_dir, exist_ok=True)
            
            # Procesar cada DWG subido
            dwg_procesados = []
            
            # Obtener todos los archivos DWG subidos
            dwg_files = request.files.getlist('dwg_file')
            
            for i, archivo in enumerate(dwg_files, 1):
                if archivo and archivo.filename != '':
                    # Generar nombre √∫nico para el DWG
                    nombre_archivo = f"dwg_{i}_{user_id}_{int(time.time())}.dwg"
                    ruta_archivo = os.path.join(dwg_dir, nombre_archivo)
                    
                    # Guardar el DWG
                    archivo.save(ruta_archivo)
                    dwg_procesados.append({
                        'numero': i,
                        'ruta': ruta_archivo,
                        'nombre_original': archivo.filename
                    })
            
            if not dwg_procesados:
                return jsonify({'success': False, 'message': 'No se subieron archivos DWG'})
            
            # Guardar informaci√≥n de los DWG en el Excel
            try:
                import xlwings as xw
                import re
                import time
                
                plantilla_path = os.path.join(base_dir, 'static', 'plantillas', 'EJEMPLO SS VACIO.xlsx')
                user_id_limpio = re.sub(r'[<>:"/\\|?*]', '', str(user_id))
                output_path = os.path.join(base_dir, 'site_survey', f'ss_{user_id_limpio}.xlsx')
                
                # Verificar que el archivo Excel existe
                if not os.path.exists(output_path):
                    import glob
                    patron_archivo = os.path.join(base_dir, 'site_survey', f'ss_{user_id_limpio}*.xlsx')
                    archivos_encontrados = glob.glob(patron_archivo)
                    
                    if archivos_encontrados:
                        output_path = max(archivos_encontrados, key=os.path.getctime)
                    else:
                        return jsonify({
                            'success': False,
                            'message': f'El archivo Excel no existe. Primero debes generar el Site Survey.'
                        })
                
                # Abrir el archivo Excel existente
                app_excel = xw.App(visible=False)
                wb = app_excel.books.open(output_path)
                
                # Insertar DWG en la hoja de Documentos
                try:
                    ws_docs = wb.sheets['8. Documentos']
                except:
                    # Si no existe la hoja, crear una nueva
                    ws_docs = wb.sheets.add('8. Documentos')
                
                # Definir las celdas donde insertar los DWG
                celdas_dwg = {
                    1: 'B95:F105',  # DWG 1 - Plano principal de AutoCAD
                    2: 'H95:L105',  # DWG 2 - Plano secundario de AutoCAD
                    3: 'N95:R105',  # DWG 3 - Plano adicional de AutoCAD
                    4: 'B110:F120', # DWG 4 - Plano t√©cnico de AutoCAD
                    5: 'H110:L120', # DWG 5 - Plano de especificaciones de AutoCAD
                }
                
                # Insertar los DWG como iconos OLE
                for dwg in dwg_procesados:
                    if dwg['numero'] in celdas_dwg:
                        rango_celda = celdas_dwg[dwg['numero']]
                        
                        try:
                            # Insertar DWG como objeto OLE
                            ws_docs.pictures.add(dwg['ruta'], 
                                               left=ws_docs.range(rango_celda).left,
                                               top=ws_docs.range(rango_celda).top,
                                               width=ws_docs.range(rango_celda).width,
                                               height=ws_docs.range(rango_celda).height)
                        except Exception as e:
                            # Si falla la inserci√≥n como imagen, insertar como icono
                            print(f"Insertando DWG {dwg['numero']} como icono: {e}")
                            pass
                
                # Guardar y cerrar
                wb.save()
                wb.close()
                app_excel.quit()
                
                return jsonify({
                    'success': True,
                    'message': f'Se subieron {len(dwg_procesados)} archivos DWG correctamente',
                    'dwg': dwg_procesados
                })
                
            except Exception as e:
                return jsonify({
                    'success': False,
                    'message': f'Error al procesar los DWG en Excel: {str(e)}'
                })
                
        except Exception as e:
            return jsonify({
                'success': False,
                'message': f'Error al subir los DWG: {str(e)}'
            })
    
    return "M√©todo no permitido"

@app.route('/subir_doc_diseno', methods=['GET', 'POST'])
def subir_doc_diseno():
    if request.method == 'GET':
        user_id = request.args.get('user_id')
        fila_idx = request.args.get('fila_idx')
        return render_template_string(f"""
        <!DOCTYPE html>
        <html>
        <head>
            <title>Subir DOC - Dise√±o de Soluci√≥n</title>
            <style>
                body {{ font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }}
                .container {{ max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }}
                h1 {{ color: #333; text-align: center; }}
                .upload-area {{ border: 2px dashed #e67e22; padding: 40px; text-align: center; margin: 20px 0; border-radius: 10px; }}
                .btn {{ background: #e67e22; color: white; padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; margin: 10px; }}
                .btn:hover {{ background: #d35400; }}
            </style>
        </head>
        <body>
            <div class="container">
                <h1>üìù Subir DOC - Dise√±o de Soluci√≥n</h1>
                <p><strong>ID:</strong> {user_id}</p>
                <p><strong>Fila:</strong> {fila_idx}</p>
                
                <form method="POST" enctype="multipart/form-data">
                    <input type="hidden" name="user_id" value="{user_id}">
                    <input type="hidden" name="fila_idx" value="{fila_idx}">
                    
                    <div class="upload-area">
                        <h3>üìù √Årea de Carga de DOC</h3>
                        <p>Selecciona archivos Word para el dise√±o de soluci√≥n</p>
                        <input type="file" name="doc_file" accept=".doc,.docx" class="btn" multiple>
                    </div>
                    
                    <div style="text-align: center;">
                        <button type="button" class="btn" onclick="history.back()">‚¨ÖÔ∏è Volver</button>
                        <button type="submit" class="btn">üíæ Subir DOC</button>
                    </div>
                </form>
            </div>
        </body>
        </html>
        """)
    
    # POST method - Implementaci√≥n completa para DOC
    if request.method == 'POST':
        user_id = request.form.get('user_id')
        fila_idx = request.form.get('fila_idx')
        
        if not user_id:
            return jsonify({'success': False, 'message': 'Falta el user_id'})
        
        try:
            # Definir base_dir
            base_dir = os.path.dirname(os.path.abspath(__file__))
            
            # Crear directorio para DOC si no existe
            doc_dir = os.path.join(base_dir, 'uploads', 'doc_diseno', user_id)
            os.makedirs(doc_dir, exist_ok=True)
            
            # Procesar cada DOC subido
            doc_procesados = []
            
            # Obtener todos los archivos DOC subidos
            doc_files = request.files.getlist('doc_file')
            
            for i, archivo in enumerate(doc_files, 1):
                if archivo and archivo.filename != '':
                    # Generar nombre √∫nico para el DOC
                    nombre_archivo = f"doc_{i}_{user_id}_{int(time.time())}.docx"
                    ruta_archivo = os.path.join(doc_dir, nombre_archivo)
                    
                    # Guardar el DOC
                    archivo.save(ruta_archivo)
                    doc_procesados.append({
                        'numero': i,
                        'ruta': ruta_archivo,
                        'nombre_original': archivo.filename
                    })
            
            if not doc_procesados:
                return jsonify({'success': False, 'message': 'No se subieron archivos DOC'})
            
            # Guardar informaci√≥n de los DOC en el Excel
            import re
            
            print(f"üîç Procesando DOC para user_id: {user_id}")
            print(f"üìÅ Archivos DOC procesados: {len(doc_procesados)}")
            for i, doc in enumerate(doc_procesados):
                print(f"   {i+1}. {doc['nombre_original']} -> {doc['ruta']}")
            
            # Buscar archivo Excel
            user_id_limpio = re.sub(r'[<>:"/\\|?*]', '', str(user_id))
            output_path = os.path.join(base_dir, 'site_survey', f'ss_{user_id_limpio}.xlsx')
            
            print(f"üìä Buscando archivo Excel: {output_path}")
            
            # Verificar que el archivo Excel existe
            if not os.path.exists(output_path):
                import glob
                patron_archivo = os.path.join(base_dir, 'site_survey', f'ss_{user_id_limpio}*.xlsx')
                archivos_encontrados = glob.glob(patron_archivo)
                
                if archivos_encontrados:
                    output_path = max(archivos_encontrados, key=os.path.getctime)
                    print(f"‚úÖ Archivo Excel encontrado: {output_path}")
                else:
                    print(f"‚ùå No se encontraron archivos Excel para {user_id_limpio}")
                    return jsonify({
                        'success': False,
                        'message': f'El archivo Excel no existe. Primero debes generar el Site Survey.',
                        'debug_info': {
                            'user_id_limpio': user_id_limpio,
                            'directorio_busqueda': os.path.join(base_dir, 'site_survey'),
                            'patron_busqueda': patron_archivo
                        }
                    })
            else:
                print(f"‚úÖ Archivo Excel encontrado directamente: {output_path}")
            
            # Usar threading seguro para evitar conflictos de main thread
            import threading
            import queue
            
            # Cola para comunicar resultados entre hilos
            result_queue = queue.Queue()
            
            def process_excel_in_thread():
                """Procesar Excel en un hilo separado para evitar conflictos de main thread"""
                try:
                    import win32com.client
                    import pythoncom
                    
                    # Inicializar COM en el hilo actual
                    pythoncom.CoInitialize()
                    print("‚úÖ COM inicializado correctamente en hilo separado")
                    
                    excel = None
                    wb_com = None
                    
                    try:
                        excel = win32com.client.Dispatch("Excel.Application")
                        excel.Visible = False
                        excel.DisplayAlerts = False
                        
                        print("üìä Abriendo archivo Excel con win32com...")
                        wb_com = excel.Workbooks.Open(output_path)
                        
                        # Listar todas las hojas disponibles para debug
                        hojas_disponibles = [sheet.Name for sheet in wb_com.Sheets]
                        print(f"üìã Hojas disponibles: {hojas_disponibles}")
                        
                        # Buscar la hoja correcta
                        hoja_encontrada = None
                        for hoja in hojas_disponibles:
                            if any(palabra in hoja.lower() for palabra in ['analisis', 'red', 'frecuencia', '1']):
                                hoja_encontrada = hoja
                                break
                        
                        if not hoja_encontrada:
                            hoja_encontrada = wb_com.Sheets(1).Name
                            print(f"‚ö†Ô∏è No se encontr√≥ hoja espec√≠fica, usando: {hoja_encontrada}")
                        
                        ws_word_com = wb_com.Sheets(hoja_encontrada)
                        print(f"‚úÖ Usando hoja: {hoja_encontrada}")
                        
                        # Definir la celda donde insertar el DOC
                        celda_doc = 'D12'
                        
                        # Insertar el DOC como icono OLE
                        if doc_procesados:
                            doc = doc_procesados[0]
                            print(f"üìé Insertando DOC en celda {celda_doc}...")
                            
                            # Insertar DOC como objeto OLE
                            ws_word_com.OLEObjects().Add(
                                Filename=doc['ruta'],
                                Link=False,
                                DisplayAsIcon=True,
                                IconFileName="C:\\Windows\\System32\\shell32.dll",
                                IconIndex=2,
                                IconLabel=os.path.basename(doc['ruta']),
                                Left=ws_word_com.Range(celda_doc).Left,
                                Top=ws_word_com.Range(celda_doc).Top
                            )
                            
                            print(f"‚úÖ DOC insertado exitosamente en {celda_doc}")
                            
                            # Guardar y cerrar
                            wb_com.Save()
                            wb_com.Close()
                            excel.Quit()
                            
                            result_queue.put({
                                'success': True,
                                'message': f'Se subieron {len(doc_procesados)} archivos DOC correctamente',
                                'doc': doc_procesados,
                                'debug_info': {
                                    'hoja_utilizada': hoja_encontrada,
                                    'celda_insertada': celda_doc,
                                    'archivo_excel': output_path
                                }
                            })
                        else:
                            wb_com.Close()
                            excel.Quit()
                            
                            result_queue.put({
                                'success': False,
                                'message': 'No hay archivos DOC para procesar'
                            })
                            
                    finally:
                        # Limpiar recursos
                        if wb_com:
                            try:
                                wb_com.Close()
                            except:
                                pass
                        if excel:
                            try:
                                excel.Quit()
                            except:
                                pass
                        
                        # Desinicializar COM
                        try:
                            pythoncom.CoUninitialize()
                            print("‚úÖ COM desinicializado correctamente")
                        except:
                            pass
                            
                except Exception as e:
                    print(f"‚ùå Error en hilo de Excel: {e}")
                    result_queue.put({
                        'success': False,
                        'message': f'Error procesando Excel: {str(e)}',
                        'debug_info': {
                            'tipo_error': 'COM/Excel',
                            'archivo_excel': output_path,
                            'archivos_doc': len(doc_procesados)
                        }
                    })
            
            # Ejecutar en hilo separado
            excel_thread = threading.Thread(target=process_excel_in_thread)
            excel_thread.daemon = True  # Hilo se cierra autom√°ticamente
            excel_thread.start()
            
            # Esperar resultado con timeout
            try:
                result = result_queue.get(timeout=60)  # 60 segundos de timeout
                return jsonify(result)
            except queue.Empty:
                return jsonify({
                    'success': False,
                    'message': 'Timeout: Excel tard√≥ demasiado en responder',
                    'debug_info': {
                        'tipo_error': 'Timeout',
                        'archivo_excel': output_path
                    }
                })
            
        except Exception as e:
            print(f"‚ùå Error general en subir_doc_diseno: {e}")
            return jsonify({
                'success': False,
                'message': f'Error al subir los DOC: {str(e)}'
            })
    
    return "M√©todo no permitido"

@app.route('/subir_zip_diseno', methods=['GET', 'POST'])
def subir_zip_diseno():
    if request.method == 'GET':
        user_id = request.args.get('user_id')
        fila_idx = request.args.get('fila_idx')
        return render_template_string(f"""
        <!DOCTYPE html>
        <html>
        <head>
            <title>Subir ZIP - Dise√±o de Soluci√≥n</title>
            <style>
                body {{ font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }}
                .container {{ max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }}
                h1 {{ color: #333; text-align: center; }}
                .upload-area {{ border: 2px dashed #e67e22; padding: 40px; text-align: center; margin: 20px 0; border-radius: 10px; }}
                .btn {{ background: #e67e22; color: white; padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; margin: 10px; }}
                .btn:hover {{ background: #d35400; }}
            </style>
        </head>
        <body>
            <div class="container">
                <h1>üì¶ Subir ZIP - Dise√±o de Soluci√≥n</h1>
                <p><strong>ID:</strong> {user_id}</p>
                <p><strong>Fila:</strong> {fila_idx}</p>
                
                <form method="POST" enctype="multipart/form-data">
                    <input type="hidden" name="user_id" value="{user_id}">
                    <input type="hidden" name="fila_idx" value="{fila_idx}">
                    
                    <div class="upload-area">
                        <h3>üì¶ √Årea de Carga de ZIP</h3>
                        <p>Selecciona archivos comprimidos para el dise√±o de soluci√≥n</p>
                        <input type="file" name="zip_file" accept=".zip,.rar,.7z" class="btn" multiple>
                    </div>
                    
                    <div style="text-align: center;">
                        <button type="button" class="btn" onclick="history.back()">‚¨ÖÔ∏è Volver</button>
                        <button type="submit" class="btn">üíæ Subir ZIP</button>
                    </div>
                </form>
            </div>
        </body>
        </html>
        """)
    
    # POST method - Implementaci√≥n completa para ZIP
    if request.method == 'POST':
        user_id = request.form.get('user_id')
        fila_idx = request.form.get('fila_idx')
        
        if not user_id:
            return jsonify({'success': False, 'message': 'Falta el user_id'})
        
        try:
            # Definir base_dir
            base_dir = os.path.dirname(os.path.abspath(__file__))
            
            # Crear directorio para ZIP si no existe
            zip_dir = os.path.join(base_dir, 'uploads', 'zip_diseno', user_id)
            os.makedirs(zip_dir, exist_ok=True)
            
            # Procesar cada ZIP subido
            zip_procesados = []
            
            # Obtener todos los archivos ZIP subidos
            zip_files = request.files.getlist('zip_file')
            
            for i, archivo in enumerate(zip_files, 1):
                if archivo and archivo.filename != '':
                    # Generar nombre √∫nico para el ZIP
                    import time
                    nombre_archivo = f"zip_{i}_{user_id}_{int(time.time())}.zip"
                    ruta_archivo = os.path.join(zip_dir, nombre_archivo)
                    
                    # Guardar el ZIP
                    archivo.save(ruta_archivo)
                    zip_procesados.append({
                        'numero': i,
                        'ruta': ruta_archivo,
                        'nombre_original': archivo.filename
                    })
            
            if not zip_procesados:
                return jsonify({'success': False, 'message': 'No se subieron archivos ZIP'})
            
            # Guardar informaci√≥n de los ZIP en el Excel
            try:
                import xlwings as xw
                import re
                import time
                
                plantilla_path = os.path.join(base_dir, 'static', 'plantillas', 'EJEMPLO SS VACIO.xlsx')
                user_id_limpio = re.sub(r'[<>:"/\\|?*]', '', str(user_id))
                output_path = os.path.join(base_dir, 'site_survey', f'ss_{user_id_limpio}.xlsx')
                
                # Verificar que el archivo Excel existe
                if not os.path.exists(output_path):
                    import glob
                    patron_archivo = os.path.join(base_dir, 'site_survey', f'ss_{user_id_limpio}*.xlsx')
                    archivos_encontrados = glob.glob(patron_archivo)
                    
                    if archivos_encontrados:
                        output_path = max(archivos_encontrados, key=os.path.getctime)
                    else:
                        return jsonify({
                            'success': False,
                            'message': f'El archivo Excel no existe. Primero debes generar el Site Survey.'
                        })
                
                # Abrir el archivo Excel existente
                app_excel = xw.App(visible=False)
                wb = app_excel.books.open(output_path)
                
                # Insertar ZIP en la hoja de Documentos
                try:
                    ws_docs = wb.sheets['8. Documentos']
                except:
                    # Si no existe la hoja, crear una nueva
                    ws_docs = wb.sheets.add('8. Documentos')
                
                # Definir las celdas donde insertar los ZIP
                celdas_zip = {
                    1: 'B155:F165', # ZIP 1 - Archivo comprimido principal
                    2: 'H155:L165', # ZIP 2 - Archivo comprimido secundario
                    3: 'N155:R165', # ZIP 3 - Archivo comprimido adicional
                    4: 'B170:F180', # ZIP 4 - Archivo comprimido t√©cnico
                    5: 'H170:L180', # ZIP 5 - Archivo comprimido de especificaciones
                }
                
                # Insertar los ZIP como iconos OLE
                for zip_file in zip_procesados:
                    if zip_file['numero'] in celdas_zip:
                        rango_celda = celdas_zip[zip_file['numero']]
                        
                        try:
                            # Insertar ZIP como objeto OLE
                            ws_docs.pictures.add(zip_file['ruta'], 
                                               left=ws_docs.range(rango_celda).left,
                                               top=ws_docs.range(rango_celda).top,
                                               width=ws_docs.range(rango_celda).width,
                                               height=ws_docs.range(rango_celda).height)
                        except Exception as e:
                            # Si falla la inserci√≥n como imagen, insertar como icono
                            print(f"Insertando ZIP {zip_file['numero']} como icono: {e}")
                            pass
                
                # Guardar y cerrar
                wb.save()
                wb.close()
                app_excel.quit()
                
                return jsonify({
                    'success': True,
                    'message': f'Se subieron {len(zip_procesados)} archivos ZIP correctamente',
                    'zip': zip_procesados
                })
                
            except Exception as e:
                return jsonify({
                    'success': False,
                    'message': f'Error al procesar los ZIP en Excel: {str(e)}'
                })
                
        except Exception as e:
            return jsonify({
                'success': False,
                'message': f'Error al subir los ZIP: {str(e)}'
            })
    
    return "M√©todo no permitido"

def generar_pagina_confirmacion_electricas(user_id, fila_idx, nombre_archivo, tipo_imagen):
    """Genera una p√°gina de confirmaci√≥n para im√°genes el√©ctricas"""
    return render_template_string(f"""
    <!DOCTYPE html>
    <html>
    <head>
        <title>Imagen Subida - El√©ctricas</title>
        <meta charset="UTF-8">
        <style>
            body {{ 
                font-family: Arial, sans-serif; 
                margin: 0; 
                padding: 40px; 
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                display: flex;
                align-items: center;
                justify-content: center;
            }}
            .container {{ 
                max-width: 600px; 
                background: white; 
                padding: 40px; 
                border-radius: 15px; 
                box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                text-align: center;
            }}
            .success-icon {{ 
                font-size: 4rem; 
                color: #28a745; 
                margin-bottom: 20px;
            }}
            h1 {{ color: #333; margin-bottom: 20px; }}
            .message {{ 
                color: #666; 
                margin-bottom: 30px; 
                font-size: 1.1rem;
            }}
            .btn {{ 
                background: #667eea; 
                color: white; 
                padding: 12px 24px; 
                border: none; 
                border-radius: 8px; 
                cursor: pointer; 
                margin: 10px; 
                text-decoration: none;
                display: inline-block;
                font-size: 1rem;
            }}
            .btn:hover {{ background: #5a6fd8; }}
            .btn-secondary {{ background: #6c757d; }}
            .btn-secondary:hover {{ background: #5a6268; }}
        </style>
    </head>
    <body>
        <div class="container">
            <div class="success-icon">‚úÖ</div>
            <h1>¬°Imagen Subida Exitosamente!</h1>
            <div class="message">
                <p><strong>Imagen:</strong> {nombre_archivo}</p>
                <p><strong>ID del Sitio:</strong> {user_id}</p>
                <p><strong>Tipo:</strong> {tipo_imagen}</p>
                <p><strong>Mensaje:</strong> Imagen subida correctamente</p>
            </div>
            
                                    <div style="margin-top: 30px;">
                            <a href="/ver_imagenes_diseno_solucion?user_id={user_id}&fila_idx={fila_idx}" class="btn" style="background: #17a2b8;">
                                üñºÔ∏è Ver Todas las Im√°genes
                            </a>
                            <a href="/diseno_solucion?user_id={user_id}&fila_idx={fila_idx}" class="btn">
                                üîô Volver a Dise√±o de Soluci√≥n
                            </a>
                            <a href="/" class="btn btn-secondary">
                                üè† Ir al Inicio
                            </a>
                        </div>
        </div>
        
        <script>
            // Auto-redirecci√≥n despu√©s de 5 segundos
            setTimeout(function() {{
                window.location.href = '/diseno_solucion?user_id={user_id}&fila_idx={fila_idx}';
            }}, 5000);
        </script>
    </body>
    </html>
    """)

def generar_pagina_error_electricas(user_id, fila_idx, error_message):
    """Genera una p√°gina de error para im√°genes el√©ctricas"""
    return render_template_string(f"""
    <!DOCTYPE html>
    <html>
    <head>
        <title>Error - El√©ctricas</title>
        <meta charset="UTF-8">
        <style>
            body {{ 
                font-family: Arial, sans-serif; 
                margin: 0; 
                padding: 40px; 
                background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
                min-height: 100vh;
                display: flex;
                align-items: center;
                justify-content: center;
            }}
            .container {{ 
                max-width: 600px; 
                background: white; 
                padding: 40px; 
                border-radius: 15px; 
                box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                text-align: center;
            }}
            .error-icon {{ 
                font-size: 4rem; 
                color: #dc3545; 
                margin-bottom: 20px;
            }}
            h1 {{ color: #333; margin-bottom: 20px; }}
            .message {{ 
                color: #666; 
                margin-bottom: 30px; 
                font-size: 1.1rem;
            }}
            .btn {{ 
                background: #dc3545; 
                color: white; 
                padding: 12px 24px; 
                border: none; 
                border-radius: 8px; 
                cursor: pointer; 
                margin: 10px; 
                text-decoration: none;
                display: inline-block;
                font-size: 1rem;
            }}
            .btn:hover {{ background: #c82333; }}
        </style>
    </head>
    <body>
        <div class="container">
            <div class="error-icon">‚ùå</div>
            <h1>Error al Subir Imagen</h1>
            <div class="message">
                <p><strong>Error:</strong> {error_message}</p>
            </div>
            
            <div style="margin-top: 30px;">
                <a href="/diseno_solucion?user_id={user_id}&fila_idx={fila_idx}" class="btn">
                    üîô Volver a Dise√±o de Soluci√≥n
                </a>
                <a href="/" class="btn">
                    üè† Ir al Inicio
                </a>
            </div>
        </div>
    </body>
    </html>
    """)

def crear_directorios_uploads():
    """Crea los directorios de uploads si no existen"""
    try:
        base_dir = os.path.dirname(os.path.abspath(__file__))
        directorios = [
            os.path.join(base_dir, 'uploads'),
            os.path.join(base_dir, 'uploads', 'electricas'),
            os.path.join(base_dir, 'uploads', 'planos_a'),
            os.path.join(base_dir, 'uploads', 'planos_b'),
            os.path.join(base_dir, 'uploads', 'fotos_a'),
            os.path.join(base_dir, 'uploads', 'fotos_b'),
            os.path.join(base_dir, 'uploads', 'kmz'),
            os.path.join(base_dir, 'uploads', 'documentos')
        ]
        
        for directorio in directorios:
            os.makedirs(directorio, exist_ok=True)
            
        print("‚úÖ Directorios de uploads creados/verificados correctamente")
    except Exception as e:
        print(f"‚ùå Error creando directorios de uploads: {e}")

@app.route('/uploads/<path:filename>')
def uploads(filename):
    """Sirve archivos desde la carpeta uploads"""
    try:
        base_dir = os.path.dirname(os.path.abspath(__file__))
        return send_from_directory(os.path.join(base_dir, 'uploads'), filename)
    except Exception as e:
        print(f"ERROR sirviendo archivo {filename}: {e}")
        return "Archivo no encontrado", 404

@app.route('/test_diseno_solucion')
def test_diseno_solucion():
    """P√°gina de prueba para la funcionalidad de dise√±o de soluci√≥n"""
    return send_file('test_diseno_solucion.html')

@app.route('/ver_imagenes_diseno_solucion')
def ver_imagenes_diseno_solucion():
    """Vista para mostrar todas las im√°genes subidas para el dise√±o de soluci√≥n"""
    user_id = request.args.get('user_id')
    fila_idx = request.args.get('fila_idx')
    
    if not user_id:
        return "Error: Falta el user_id", 400
    
    try:
        # Definir base_dir
        base_dir = os.path.dirname(os.path.abspath(__file__))
        
        # Directorios donde se guardan las im√°genes
        directorios_imagenes = {
            'electricas': os.path.join(base_dir, 'uploads', 'electricas', user_id),
            'planos_a': os.path.join(base_dir, 'uploads', 'planos_a', user_id),
            'planos_b': os.path.join(base_dir, 'uploads', 'planos_b', user_id),
            'fotos_a': os.path.join(base_dir, 'uploads', 'fotos_a', user_id),
            'fotos_b': os.path.join(base_dir, 'uploads', 'fotos_b', user_id),
            'kmz': os.path.join(base_dir, 'uploads', 'kmz', user_id),
            'documentos': os.path.join(base_dir, 'uploads', 'documentos', user_id)
        }
        
        # Recopilar im√°genes de cada directorio
        imagenes_por_categoria = {}
        total_imagenes = 0
        
        for categoria, directorio in directorios_imagenes.items():
            imagenes = []
            if os.path.exists(directorio):
                try:
                    archivos = os.listdir(directorio)
                    for archivo in archivos:
                        if archivo.lower().endswith(('.jpg', '.jpeg', '.png', '.gif', '.bmp')):
                            ruta_completa = os.path.join(directorio, archivo)
                            tamano = os.path.getsize(ruta_completa)
                            fecha_mod = os.path.getmtime(ruta_completa)
                            fecha_str = time.strftime('%Y-%m-%d %H:%M:%S', time.localtime(fecha_mod))
                            
                            imagenes.append({
                                'nombre': archivo,
                                'ruta': f'/uploads/{categoria}/{user_id}/{archivo}',
                                'tamano': tamano,
                                'fecha': fecha_str,
                                'ruta_completa': ruta_completa
                            })
                            total_imagenes += 1
                except Exception as e:
                    print(f"Error listando archivos en {directorio}: {e}")
            
            imagenes_por_categoria[categoria] = sorted(imagenes, key=lambda x: x['fecha'], reverse=True)
        
        # Generar HTML para mostrar las im√°genes
        html_content = f"""
        <!DOCTYPE html>
        <html lang="es">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Visor de Im√°genes - Dise√±o de Soluci√≥n | FANGIO TELECOM</title>
            <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
            <style>
                * {{
                    margin: 0;
                    padding: 0;
                    box-sizing: border-box;
                }}
                
                body {{
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    background: linear-gradient(135deg, #0a192f 0%, #1e3a8a 100%);
                    min-height: 100vh;
                    color: #e0e7ef;
                }}
                
                .header {{
                    background: linear-gradient(135deg, #00c3ff 0%, #0066cc 100%);
                    padding: 2rem 0;
                    text-align: center;
                    box-shadow: 0 4px 20px rgba(0, 195, 255, 0.3);
                }}
                
                .header h1 {{
                    font-size: 2.5rem;
                    margin-bottom: 0.5rem;
                    color: white;
                }}
                
                .header p {{
                    font-size: 1.2rem;
                    opacity: 0.9;
                }}
                
                .container {{
                    max-width: 1400px;
                    margin: 0 auto;
                    padding: 2rem;
                }}
                
                .stats-bar {{
                    background: rgba(255, 255, 255, 0.1);
                    backdrop-filter: blur(10px);
                    border-radius: 15px;
                    padding: 1.5rem;
                    margin-bottom: 2rem;
                    display: flex;
                    justify-content: space-around;
                    flex-wrap: wrap;
                    gap: 1rem;
                }}
                
                .stat-item {{
                    text-align: center;
                    padding: 1rem;
                    background: rgba(0, 195, 255, 0.1);
                    border-radius: 10px;
                    border: 1px solid rgba(0, 195, 255, 0.3);
                }}
                
                .stat-number {{
                    font-size: 2rem;
                    font-weight: bold;
                    color: #00c3ff;
                }}
                
                .stat-label {{
                    font-size: 0.9rem;
                    opacity: 0.8;
                    margin-top: 0.5rem;
                }}
                
                .categoria-section {{
                    background: rgba(255, 255, 255, 0.05);
                    backdrop-filter: blur(10px);
                    border-radius: 15px;
                    padding: 2rem;
                    margin-bottom: 2rem;
                    border: 1px solid rgba(255, 255, 255, 0.1);
                }}
                
                .categoria-header {{
                    display: flex;
                    align-items: center;
                    margin-bottom: 1.5rem;
                    padding-bottom: 1rem;
                    border-bottom: 2px solid rgba(0, 195, 255, 0.3);
                }}
                
                .categoria-icon {{
                    font-size: 2rem;
                    margin-right: 1rem;
                    color: #00c3ff;
                }}
                
                .categoria-title {{
                    font-size: 1.5rem;
                    font-weight: bold;
                    color: #00c3ff;
                }}
                
                .categoria-count {{
                    margin-left: auto;
                    background: rgba(0, 195, 255, 0.2);
                    padding: 0.5rem 1rem;
                    border-radius: 20px;
                    font-size: 0.9rem;
                }}
                
                .imagenes-grid {{
                    display: grid;
                    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                    gap: 1.5rem;
                }}
                
                .imagen-card {{
                    background: rgba(255, 255, 255, 0.1);
                    border-radius: 12px;
                    overflow: hidden;
                    transition: transform 0.3s ease, box-shadow 0.3s ease;
                    border: 1px solid rgba(255, 255, 255, 0.1);
                }}
                
                .imagen-card:hover {{
                    transform: translateY(-5px);
                    box-shadow: 0 10px 30px rgba(0, 195, 255, 0.3);
                }}
                
                .imagen-preview {{
                    width: 100%;
                    height: 200px;
                    object-fit: cover;
                    cursor: pointer;
                    transition: transform 0.3s ease;
                }}
                
                .imagen-preview:hover {{
                    transform: scale(1.05);
                }}
                
                .imagen-info {{
                    padding: 1rem;
                }}
                
                .imagen-nombre {{
                    font-weight: bold;
                    margin-bottom: 0.5rem;
                    color: #00c3ff;
                    word-break: break-all;
                }}
                
                .imagen-details {{
                    font-size: 0.85rem;
                    opacity: 0.8;
                    line-height: 1.4;
                }}
                
                .imagen-actions {{
                    display: flex;
                    gap: 0.5rem;
                    margin-top: 1rem;
                }}
                
                .btn {{
                    padding: 0.5rem 1rem;
                    border: none;
                    border-radius: 6px;
                    cursor: pointer;
                    text-decoration: none;
                    font-size: 0.85rem;
                    transition: all 0.3s ease;
                    display: inline-flex;
                    align-items: center;
                    gap: 0.5rem;
                }}
                
                .btn-primary {{
                    background: #00c3ff;
                    color: white;
                }}
                
                .btn-primary:hover {{
                    background: #0099cc;
                    transform: translateY(-2px);
                }}
                
                .btn-secondary {{
                    background: rgba(255, 255, 255, 0.2);
                    color: white;
                }}
                
                .btn-secondary:hover {{
                    background: rgba(255, 255, 255, 0.3);
                }}
                
                .btn-danger {{
                    background: #dc3545;
                    color: white;
                }}
                
                .btn-danger:hover {{
                    background: #c82333;
                }}
                
                .no-imagenes {{
                    text-align: center;
                    padding: 3rem;
                    opacity: 0.6;
                    font-style: italic;
                }}
                
                .modal {{
                    display: none;
                    position: fixed;
                    z-index: 1000;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0, 0, 0, 0.9);
                }}
                
                .modal-content {{
                    margin: auto;
                    display: block;
                    width: 90%;
                    max-width: 800px;
                    max-height: 90%;
                    margin-top: 5%;
                }}
                
                .close {{
                    position: absolute;
                    top: 15px;
                    right: 35px;
                    color: #f1f1f1;
                    font-size: 40px;
                    font-weight: bold;
                    cursor: pointer;
                }}
                
                .close:hover {{
                    color: #bbb;
                }}
                
                .navigation-buttons {{
                    text-align: center;
                    margin-top: 2rem;
                    padding-top: 2rem;
                    border-top: 1px solid rgba(255, 255, 255, 0.1);
                }}
                
                .btn-large {{
                    padding: 1rem 2rem;
                    font-size: 1.1rem;
                    margin: 0 1rem;
                }}
                
                @media (max-width: 768px) {{
                    .imagenes-grid {{
                        grid-template-columns: 1fr;
                    }}
                    
                    .stats-bar {{
                        flex-direction: column;
                    }}
                    
                    .header h1 {{
                        font-size: 2rem;
                    }}
                }}
            </style>
        </head>
        <body>
            <div class="header">
                <h1>üñºÔ∏è Visor de Im√°genes - Dise√±o de Soluci√≥n</h1>
                <p>ID del Sitio: <strong>{user_id}</strong> | Total de Im√°genes: <strong>{total_imagenes}</strong></p>
            </div>
            
            <div class="container">
                <div class="stats-bar">
                    <div class="stat-item">
                        <div class="stat-number">{len(imagenes_por_categoria.get('electricas', []))}</div>
                        <div class="stat-label">‚ö° El√©ctricas</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">{len(imagenes_por_categoria.get('planos_a', []))}</div>
                        <div class="stat-label">üìê Planos A</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">{len(imagenes_por_categoria.get('planos_b', []))}</div>
                        <div class="stat-label">üìê Planos B</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">{len(imagenes_por_categoria.get('fotos_a', []))}</div>
                        <div class="stat-label">üì∏ Fotos A</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">{len(imagenes_por_categoria.get('fotos_b', []))}</div>
                        <div class="stat-label">üì∏ Fotos B</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">{len(imagenes_por_categoria.get('kmz', []))}</div>
                        <div class="stat-label">üó∫Ô∏è KMZ</div>
                    </div>
                </div>
        """
        
        # Generar secciones para cada categor√≠a
        for categoria, imagenes in imagenes_por_categoria.items():
            if imagenes:  # Solo mostrar categor√≠as con im√°genes
                categoria_nombre = {{
                    'electricas': '‚ö° Im√°genes El√©ctricas',
                    'planos_a': 'üìê Planos del Sitio A',
                    'planos_b': 'üìê Planos del Sitio B',
                    'fotos_a': 'üì∏ Fotos del Sitio A',
                    'fotos_b': 'üì∏ Fotos del Sitio B',
                    'kmz': 'üó∫Ô∏è Archivos KMZ',
                    'documentos': 'üìÑ Documentos'
                }}.get(categoria, categoria.title())
                
                html_content += f"""
                <div class="categoria-section">
                    <div class="categoria-header">
                        <div class="categoria-icon">
                            {{'‚ö°' if 'electricas' in categoria else 'üìê' if 'planos' in categoria else 'üì∏' if 'fotos' in categoria else 'üó∫Ô∏è' if 'kmz' in categoria else 'üìÑ'}}
                        </div>
                        <div class="categoria-title">{categoria_nombre}</div>
                        <div class="categoria-count">{len(imagenes)} imagen{'es' if len(imagenes) != 1 else ''}</div>
                    </div>
                    
                    <div class="imagenes-grid">
                """
                
                for imagen in imagenes:
                    tamano_mb = imagen['tamano'] / (1024 * 1024)
                    html_content += f"""
                    <div class="imagen-card">
                        <img src="{imagen['ruta']}" alt="{imagen['nombre']}" class="imagen-preview" onclick="abrirModal('{imagen['ruta']}', '{imagen['nombre']}')">
                        <div class="imagen-info">
                            <div class="imagen-nombre">{imagen['nombre']}</div>
                            <div class="imagen-details">
                                <div>üìÖ {imagen['fecha']}</div>
                                <div>üíæ {tamano_mb:.2f} MB</div>
                            </div>
                            <div class="imagen-actions">
                                <a href="{imagen['ruta']}" download class="btn btn-primary">
                                    <i class="fas fa-download"></i> Descargar
                                </a>
                                <button onclick="abrirModal('{imagen['ruta']}', '{imagen['nombre']}')" class="btn btn-secondary">
                                    <i class="fas fa-eye"></i> Ver
                                </button>
                            </div>
                        </div>
                    </div>
                    """
                
                html_content += """
                    </div>
                </div>
                """
            else:
                # Mostrar mensaje cuando no hay im√°genes en una categor√≠a
                categoria_nombre = {{
                    'electricas': '‚ö° Im√°genes El√©ctricas',
                    'planos_a': 'üìê Planos del Sitio A',
                    'planos_b': 'üìê Planos del Sitio B',
                    'fotos_a': 'üì∏ Fotos del Sitio A',
                    'fotos_b': 'üì∏ Fotos del Sitio B',
                    'kmz': 'üó∫Ô∏è Archivos KMZ',
                    'documentos': 'üìÑ Documentos'
                }}.get(categoria, categoria.title())
                
                html_content += f"""
                <div class="categoria-section">
                    <div class="categoria-header">
                        <div class="categoria-icon">
                            {{'‚ö°' if 'electricas' in categoria else 'üìê' if 'planos' in categoria else 'üì∏' if 'fotos' in categoria else 'üó∫Ô∏è' if 'kmz' in categoria else 'üìÑ'}}
                        </div>
                        <div class="categoria-title">{categoria_nombre}</div>
                        <div class="categoria-count">0 im√°genes</div>
                    </div>
                    
                    <div class="no-imagenes">
                        <i class="fas fa-image fa-3x" style="margin-bottom: 1rem; opacity: 0.3;"></i>
                        <p>No hay im√°genes en esta categor√≠a</p>
                        <p>Sube im√°genes usando los botones de la p√°gina de dise√±o de soluci√≥n</p>
                    </div>
                </div>
                """
        
        # Cerrar HTML y agregar JavaScript
        html_content += f"""
                <div class="navigation-buttons">
                    <a href="/diseno_solucion?user_id={user_id}&fila_idx={fila_idx}" class="btn btn-primary btn-large">
                        <i class="fas fa-arrow-left"></i> Volver a Dise√±o de Soluci√≥n
                    </a>
                    <a href="/" class="btn btn-secondary btn-large">
                        <i class="fas fa-home"></i> Ir al Inicio
                    </a>
                </div>
            </div>
            
            <!-- Modal para ver im√°genes -->
            <div id="imagenModal" class="modal">
                <span class="close" onclick="cerrarModal()">&times;</span>
                <img class="modal-content" id="imagenModalImg">
            </div>
            
            <script>
                function abrirModal(ruta, nombre) {{
                    document.getElementById('imagenModalImg').src = ruta;
                    document.getElementById('imagenModalImg').alt = nombre;
                    document.getElementById('imagenModal').style.display = 'block';
                }}
                
                function cerrarModal() {{
                    document.getElementById('imagenModal').style.display = 'none';
                }}
                
                // Cerrar modal al hacer clic fuera de la imagen
                window.onclick = function(event) {{
                    const modal = document.getElementById('imagenModal');
                    if (event.target == modal) {{
                        modal.style.display = 'none';
                    }}
                }}
                
                // Cerrar modal con la tecla Escape
                document.addEventListener('keydown', function(event) {{
                    if (event.key === 'Escape') {{
                        cerrarModal();
                    }}
                }});
            </script>
        </body>
        </html>
        """
        
        return html_content
        
    except Exception as e:
        print(f"ERROR en ver_imagenes_diseno_solucion: {e}")
        return f"Error al cargar las im√°genes: {str(e)}", 500

@app.route('/subir_electricas_consumo', methods=['GET', 'POST'])
def subir_electricas_consumo():
    if request.method == 'GET':
        user_id = request.args.get('user_id')
        fila_idx = request.args.get('fila_idx')
        return render_template_string(f"""
        <!DOCTYPE html>
        <html>
        <head>
            <title>Subir Imagen de Consumo - El√©ctricas</title>
            <style>
                body {{ font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }}
                .container {{ max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }}
                h1 {{ color: #333; text-align: center; }}
                .upload-area {{ border: 2px dashed #9b59b6; padding: 40px; text-align: center; margin: 20px 0; border-radius: 10px; }}
                .btn {{ background: #9b59b6; color: white; padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; margin: 10px; }}
                .btn:hover {{ background: #8e44ad; }}
            </style>
        </head>
        <body>
            <div class="container">
                <h1>‚ö° Subir Imagen de Consumo - El√©ctricas</h1>
                <p><strong>ID:</strong> {user_id}</p>
                <p><strong>Fila:</strong> {fila_idx}</p>
                
                <form method="POST" enctype="multipart/form-data">
                    <input type="hidden" name="user_id" value="{user_id}">
                    <input type="hidden" name="fila_idx" value="{fila_idx}">
                    
                    <div class="upload-area">
                        <h3>‚ö° √Årea de Carga de Imagen de Consumo</h3>
                        <p>Selecciona la imagen de consumo de potencia para la hoja de El√©ctricas</p>
                        <input type="file" name="electricas_consumo" accept="image/*" class="btn" required>
                    </div>
                    
                    <div style="text-align: center;">
                        <button type="button" class="btn" onclick="history.back()">‚¨ÖÔ∏è Volver</button>
                        <button type="submit" class="btn">üíæ Subir Imagen</button>
                    </div>
                </form>
            </div>
        </body>
        </html>
        """)
    
    # POST method - Implementaci√≥n completa para imagen de consumo
    if request.method == 'POST':
        user_id = request.form.get('user_id')
        fila_idx = request.form.get('fila_idx')
        
        if not user_id:
            return jsonify({'success': False, 'message': 'Falta el user_id'})
        
        try:
            # Definir base_dir
            base_dir = os.path.dirname(os.path.abspath(__file__))
            
            # Crear directorio para im√°genes de El√©ctricas si no existe
            electricas_dir = os.path.join(base_dir, 'uploads', 'electricas', user_id)
            os.makedirs(electricas_dir, exist_ok=True)
            
            # Procesar imagen de consumo
            electricas_consumo = request.files.get('electricas_consumo')
            
            if not electricas_consumo or electricas_consumo.filename == '':
                return jsonify({'success': False, 'message': 'No se seleccion√≥ ninguna imagen'})
            
            # Generar nombre √∫nico para la imagen
            nombre_archivo = f"electricas_consumo_{user_id}_{int(time.time())}.jpg"
            ruta_archivo = os.path.join(electricas_dir, nombre_archivo)
            
            # Guardar la imagen
            electricas_consumo.save(ruta_archivo)
            
            # Verificar si la solicitud espera JSON o HTML
            if request.headers.get('Accept') == 'application/json':
                return jsonify({
                    'success': True,
                    'message': 'Imagen de consumo subida correctamente',
                    'ruta': ruta_archivo
                })
            else:
                # Usar la funci√≥n auxiliar para generar la p√°gina de confirmaci√≥n
                return generar_pagina_confirmacion_electricas(user_id, fila_idx, nombre_archivo, "Consumo de Potencia")
            
        except Exception as e:
            error_message = f'Error al subir la imagen: {str(e)}'
            print(f"ERROR en subir_electricas_consumo: {error_message}")
            
            if request.headers.get('Accept') == 'application/json':
                return jsonify({
                    'success': False,
                    'message': error_message
                })
            else:
                # Usar la funci√≥n auxiliar para generar la p√°gina de error
                return generar_pagina_error_electricas(user_id, fila_idx, error_message)

@app.route('/subir_electricas_configuracion', methods=['GET', 'POST'])
def subir_electricas_configuracion():
    if request.method == 'GET':
        user_id = request.args.get('user_id')
        fila_idx = request.args.get('fila_idx')
        return render_template_string(f"""
        <!DOCTYPE html>
        <html>
        <head>
            <title>Subir Imagen de Configuraci√≥n - El√©ctricas</title>
            <style>
                body {{ font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }}
                .container {{ max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }}
                h1 {{ color: #333; text-align: center; }}
                .upload-area {{ border: 2px dashed #9b59b6; padding: 40px; text-align: center; margin: 20px 0; border-radius: 10px; }}
                .btn {{ background: #9b59b6; color: white; padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; margin: 10px; }}
                .btn:hover {{ background: #8e44ad; }}
            </style>
        </head>
        <body>
            <div class="container">
                <h1>‚öôÔ∏è Subir Imagen de Configuraci√≥n - El√©ctricas</h1>
                <p><strong>ID:</strong> {user_id}</p>
                <p><strong>Fila:</strong> {fila_idx}</p>
                
                <form method="POST" enctype="multipart/form-data">
                    <input type="hidden" name="user_id" value="{user_id}">
                    <input type="hidden" name="hidden" name="fila_idx" value="{fila_idx}">
                    
                    <div class="upload-area">
                        <h3>‚öôÔ∏è √Årea de Carga de Imagen de Configuraci√≥n</h3>
                        <p>Selecciona la imagen de configuraci√≥n MW para la hoja de El√©ctricas</p>
                        <input type="file" name="electricas_configuracion" accept="image/*" class="btn" required>
                    </div>
                    
                    <div style="text-align: center;">
                        <button type="button" class="btn" onclick="history.back()">‚¨ÖÔ∏è Volver</button>
                        <button type="submit" class="btn">üíæ Subir Imagen</button>
                    </div>
                </form>
            </div>
        </body>
        </html>
        """)
    
    # POST method - Implementaci√≥n completa para imagen de configuraci√≥n
    if request.method == 'POST':
        user_id = request.form.get('user_id')
        fila_idx = request.form.get('fila_idx')
        
        if not user_id:
            return jsonify({'success': False, 'message': 'Falta el user_id'})
        
        try:
            # Definir base_dir
            base_dir = os.path.dirname(os.path.abspath(__file__))
            
            # Crear directorio para im√°genes de El√©ctricas si no existe
            electricas_dir = os.path.join(base_dir, 'uploads', 'electricas', user_id)
            os.makedirs(electricas_dir, exist_ok=True)
            
            # Procesar imagen de configuraci√≥n
            electricas_configuracion = request.files.get('electricas_configuracion')
            
            if not electricas_configuracion or electricas_configuracion.filename == '':
                return jsonify({'success': False, 'message': 'No se seleccion√≥ ninguna imagen'})
            
            # Generar nombre √∫nico para la imagen
            nombre_archivo = f"electricas_configuracion_{user_id}_{int(time.time())}.jpg"
            ruta_archivo = os.path.join(electricas_dir, nombre_archivo)
            
            # Guardar la imagen
            electricas_configuracion.save(ruta_archivo)
            
            return jsonify({
                'success': True,
                'message': 'Imagen de configuraci√≥n subida correctamente',
                'ruta': ruta_archivo
            })
            
        except Exception as e:
            return jsonify({
                'success': False,
                'message': f'Error al subir la imagen: {str(e)}'
            })

@app.route('/subir_electricas_linea_vista', methods=['GET', 'POST'])
def subir_electricas_linea_vista():
    if request.method == 'GET':
        user_id = request.args.get('user_id')
        fila_idx = request.args.get('fila_idx')
        return render_template_string(f"""
        <!DOCTYPE html>
        <html>
        <head>
            <title>Subir Imagen de L√≠nea de Vista - El√©ctricas</title>
            <style>
                body {{ font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }}
                .container {{ max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }}
                h1 {{ color: #333; text-align: center; }}
                .upload-area {{ border: 2px dashed #9b59b6; padding: 40px; text-align: center; margin: 20px 0; border-radius: 10px; }}
                .btn {{ background: #9b59b6; color: white; padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; margin: 10px; }}
                .btn:hover {{ background: #8e44ad; }}
            </style>
        </head>
        <body>
            <div class="container">
                <h1>üëÅÔ∏è Subir Imagen de L√≠nea de Vista - El√©ctricas</h1>
                <p><strong>ID:</strong> {user_id}</p>
                <p><strong>Fila:</strong> {fila_idx}</p>
                
                <form method="POST" enctype="multipart/form-data">
                    <input type="hidden" name="user_id" value="{user_id}">
                    <input type="hidden" name="fila_idx" value="{fila_idx}">
                    
                    <div class="upload-area">
                        <h3>üëÅÔ∏è √Årea de Carga de Imagen de L√≠nea de Vista</h3>
                        <p>Selecciona la imagen de l√≠nea de vista para la hoja de El√©ctricas</p>
                        <input type="file" name="electricas_linea_vista" accept="image/*" class="btn" required>
                    </div>
                    
                    <div style="text-align: center;">
                        <button type="button" class="btn" onclick="history.back()">‚¨ÖÔ∏è Volver</button>
                        <button type="submit" class="btn">üíæ Subir Imagen</button>
                    </div>
                </form>
            </div>
        </body>
        </html>
        """)
    
    # POST method - Implementaci√≥n completa para imagen de l√≠nea de vista
    if request.method == 'POST':
        user_id = request.form.get('user_id')
        fila_idx = request.form.get('fila_idx')
        
        if not user_id:
            return jsonify({'success': False, 'message': 'Falta el user_id'})
        
        try:
            # Definir base_dir
            base_dir = os.path.dirname(os.path.abspath(__file__))
            
            # Crear directorio para im√°genes de El√©ctricas si no existe
            electricas_dir = os.path.join(base_dir, 'uploads', 'electricas', user_id)
            os.makedirs(electricas_dir, exist_ok=True)
            
            # Procesar imagen de l√≠nea de vista
            electricas_linea_vista = request.files.get('electricas_linea_vista')
            
            if not electricas_linea_vista or electricas_linea_vista.filename == '':
                return jsonify({'success': False, 'message': 'No se seleccion√≥ ninguna imagen'})
            
            # Generar nombre √∫nico para la imagen
            nombre_archivo = f"electricas_linea_vista_{user_id}_{int(time.time())}.jpg"
            ruta_archivo = os.path.join(electricas_dir, nombre_archivo)
            
            # Guardar la imagen
            electricas_linea_vista.save(ruta_archivo)
            
            return jsonify({
                'success': True,
                'message': 'Imagen de l√≠nea de vista subida correctamente',
                'ruta': ruta_archivo
            })
            
        except Exception as e:
            return jsonify({
                'success': False,
                'message': f'Error al subir la imagen: {str(e)}'
            })

@app.route('/descargar_diseno_solucion')
@error_handler
def descargar_diseno_solucion():
    import pandas as pd
    import os
    import glob
    
    try:
        user_id = request.args.get('user_id')
        fila_idx = request.args.get('fila_idx')
        
        print(f"DEBUG: Iniciando descarga - user_id: {user_id}, fila_idx: {fila_idx}")
        
        if not user_id or not fila_idx:
            return "Error: Faltan par√°metros user_id o fila_idx", 400
        
        # Definir base_dir
        base_dir = os.path.dirname(os.path.abspath(__file__))
        print(f"DEBUG: Base directory: {base_dir}")
        
        # Leer datos de Google Sheets
        try:
            # Usar la misma URL que est√° definida en la aplicaci√≥n
            df = pd.read_csv(GOOGLE_SHEETS_CSV_URL)
            print(f"DEBUG: Google Sheets le√≠do correctamente, {len(df)} filas")
        except Exception as e:
            print(f"ERROR: No se pudo leer Google Sheets: {e}")
            return f"Error leyendo Google Sheets: {str(e)}", 500
        
        # Buscar la fila correspondiente
        try:
            fila_idx = int(fila_idx)
            if fila_idx < len(df):
                fila = df.iloc[fila_idx]
                id_sitio = str(fila['ID'])
                
                # Intentar diferentes nombres de columnas para los sitios
                sitio_a = str(fila.get('Nombre del sitio A', '') or fila.get('Sitio A', '') or fila.get('Sitio_A', '') or '')
                sitio_b = str(fila.get('Nombre del sitio B', '') or fila.get('Sitio B', '') or fila.get('Sitio_B', '') or '')
                
                print(f"DEBUG: Datos de fila - ID: {id_sitio}, Sitio A: {sitio_a}, Sitio B: {sitio_b}")
                print(f"DEBUG: Columnas disponibles: {list(df.columns)}")
            else:
                return "Error: Fila no encontrada", 404
        except Exception as e:
            print(f"ERROR: Error procesando fila: {e}")
            print(f"DEBUG: Columnas disponibles: {list(df.columns)}")
            return f"Error procesando fila: {str(e)}", 500
        
        # Buscar SOLO archivos de DISE√ëO DE SOLUCI√ìN (NO site survey)
        posibles_rutas = [
            os.path.join(base_dir, 'archivos_generados', f'ds_diseno_solucion_{id_sitio}_*.xlsx'),
            os.path.join(base_dir, 'archivos_generados', f'ds_{id_sitio}_*.xlsx'),
            os.path.join(base_dir, 'archivos_generados', f'ds_dis*.xlsx'),
            # NO buscar en site_survey - solo archivos de dise√±o de soluci√≥n
        ]
        
        # Buscar archivo existente
        output_path = None
        print(f"DEBUG: Buscando SOLO archivos de DISE√ëO DE SOLUCI√ìN para ID: {id_sitio}")
        print(f"DEBUG: NO se buscar√°n archivos de Site Survey")
        
        for i, patron in enumerate(posibles_rutas):
            try:
                print(f"DEBUG: Probando patr√≥n {i+1}: {patron}")
                archivos_encontrados = glob.glob(patron)
                print(f"DEBUG: Patr√≥n '{patron}' - Encontrados: {len(archivos_encontrados)}")
                
                if archivos_encontrados:
                    # Ordenar por fecha de creaci√≥n (m√°s reciente primero)
                    archivos_ordenados = sorted(archivos_encontrados, key=os.path.getctime, reverse=True)
                    output_path = archivos_ordenados[0]
                    print(f"DEBUG: Archivo de DISE√ëO DE SOLUCI√ìN encontrado: {output_path}")
                    print(f"DEBUG: Tama√±o del archivo: {os.path.getsize(output_path)} bytes")
                    print(f"DEBUG: Nombre del archivo: {os.path.basename(output_path)}")
                    
                    # Verificar que sea un archivo de dise√±o de soluci√≥n
                    nombre_archivo = os.path.basename(output_path)
                    if nombre_archivo.startswith('ds_'):
                        print(f"DEBUG: ‚úÖ Archivo confirmado como DISE√ëO DE SOLUCI√ìN")
                    else:
                        print(f"DEBUG: ‚ö†Ô∏è Archivo NO parece ser de dise√±o de soluci√≥n: {nombre_archivo}")
                    
                    break
            except Exception as e:
                print(f"ERROR: Error con patr√≥n {patron}: {e}")
                continue
        
        # Verificar si el archivo existe
        print(f"DEBUG: Verificando archivo: {output_path}")
        if not output_path or not os.path.exists(output_path):
            print(f"DEBUG: Archivo no encontrado o no existe")
            # Listar todos los archivos en archivos_generados para debug
            try:
                archivos_totales = os.listdir(os.path.join(base_dir, 'archivos_generados'))
                print(f"DEBUG: Archivos en archivos_generados: {archivos_totales}")
                
                # Buscar archivos que contengan el ID del sitio
                archivos_con_id = [f for f in archivos_totales if id_sitio in f]
                print(f"DEBUG: Archivos que contienen ID {id_sitio}: {archivos_con_id}")
                
            except Exception as e:
                print(f"DEBUG: Error listando archivos: {e}")
            
            return "Archivo de DISE√ëO DE SOLUCI√ìN no encontrado. Primero debes generar el archivo usando el bot√≥n 'Guardar Archivo' en la secci√≥n de Dise√±o de Soluci√≥n.", 404
        
        # Verificar que el archivo sea legible
        try:
            with open(output_path, 'rb') as f:
                # Leer los primeros bytes para verificar que el archivo no est√© corrupto
                f.read(1)
            
            # Obtener el nombre del archivo para la descarga
            nombre_archivo = os.path.basename(output_path)
            print(f"DEBUG: Enviando archivo de DISE√ëO DE SOLUCI√ìN: {nombre_archivo}")
            print(f"DEBUG: Ruta completa: {output_path}")
            print(f"DEBUG: Tipo de archivo: {'DISE√ëO DE SOLUCI√ìN' if nombre_archivo.startswith('ds_') else 'OTRO TIPO'}")
            
            return send_file(
                output_path, 
                as_attachment=True,
                download_name=nombre_archivo,
                mimetype='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
            )
        except Exception as e:
            print(f"DEBUG: Error enviando archivo: {e}")
            return f"Error al enviar archivo: {str(e)}", 500
        
    except Exception as e:
        print(f"ERROR GENERAL: {e}")
        import traceback
        traceback.print_exc()
        return f"Error general: {str(e)}", 500




@app.route('/verificar_estado_llenado', methods=['GET'])
@error_handler
def verificar_estado_llenado():
    """
    Verifica si el llenado autom√°tico se ha completado para un user_id espec√≠fico
    """
    user_id = request.args.get('user_id')
    fila_idx = request.args.get('fila_idx')
    
    # Si no hay user_id, devolver estado completado para evitar bucles infinitos
    if not user_id:
        return jsonify({
            'success': True,
            'completado': True,
            'progreso': 'Estado no disponible',
            'porcentaje': 100,
            'user_id': 'N/A'
        })
    
    try:
        # Verificar si existe un archivo Excel generado recientemente (√∫ltimos 5 minutos)
        base_dir = os.path.dirname(os.path.abspath(__file__))
        archivos_generados_dir = os.path.join(base_dir, 'archivos_generados')
        
        import time
        import glob
        
        # Buscar archivos de site survey Y dise√±o de soluci√≥n para este user_id
        patron_ss = os.path.join(archivos_generados_dir, f'ss_{user_id}*.xlsx')
        patron_ds = os.path.join(archivos_generados_dir, f'ds_diseno_solucion_{user_id}*.xlsx')
        
        archivos_ss = glob.glob(patron_ss)
        archivos_ds = glob.glob(patron_ds)
        archivos = archivos_ss + archivos_ds
        
        # Verificar si hay archivos recientes (√∫ltimos 5 minutos)
        tiempo_limite = time.time() - 300  # 5 minutos en segundos
        archivos_recientes = []
        
        for archivo in archivos:
            try:
                tiempo_archivo = os.path.getmtime(archivo)
                if tiempo_archivo > tiempo_limite:
                    archivos_recientes.append(archivo)
            except:
                continue
        
        # Si hay archivos recientes, consideramos que el llenado se complet√≥
        completado = len(archivos_recientes) > 0
        
        print(f"DEBUG: Verificando estado llenado para {user_id}")
        print(f"DEBUG: Archivos SS encontrados: {len(archivos_ss)}")
        print(f"DEBUG: Archivos DS encontrados: {len(archivos_ds)}")
        print(f"DEBUG: Archivos totales: {len(archivos)}")
        print(f"DEBUG: Archivos recientes: {len(archivos_recientes)}")
        if archivos_recientes:
            print(f"DEBUG: Archivos recientes: {[os.path.basename(f) for f in archivos_recientes]}")
        print(f"DEBUG: Completado: {completado}")
        
        # Determinar el mensaje de progreso basado en el estado
        if completado:
            progreso = 'Llenado completado exitosamente'
            porcentaje = 100
        else:
            progreso = 'Procesando llenado autom√°tico...'
            porcentaje = 50
        
        return jsonify({
            'success': True,
            'completado': completado,
            'progreso': progreso,
            'porcentaje': porcentaje,
            'archivos_totales': len(archivos),
            'archivos_recientes': len(archivos_recientes),
            'user_id': user_id
        })
        
    except Exception as e:
        print(f"ERROR verificando estado llenado: {e}")
        # En caso de error, asumir que est√° completado para evitar bucles infinitos
        return jsonify({
            'success': False,
            'completado': True,
            'progreso': 'Error verificando estado',
            'porcentaje': 100,
            'error': str(e)
        })


@app.route('/almacenar_archivo_permanente', methods=['POST'])
@error_handler
def almacenar_archivo_permanente():
    """
    Almacena permanentemente un archivo generado en el sistema
    """
    import json
    import shutil
    from datetime import datetime
    
    try:
        # Obtener datos de la solicitud
        data = request.get_json()
        user_id = data.get('user_id')
        tipo = data.get('tipo')
        fila_idx = data.get('fila_idx')
        
        print(f"üöÄ Iniciando almacenamiento permanente - user_id: {user_id}, tipo: {tipo}, fila_idx: {fila_idx}")
        
        if not user_id or not tipo or not fila_idx:
            return jsonify({
                'success': False,
                'error': 'Faltan par√°metros requeridos'
            }), 400
        
        # Definir directorios
        base_dir = os.path.dirname(os.path.abspath(__file__))
        archivos_generados_dir = os.path.join(base_dir, 'archivos_generados')
        archivos_permanentes_dir = os.path.join(base_dir, 'archivos_permanentes')
        
        # Crear directorio de archivos permanentes si no existe
        os.makedirs(archivos_permanentes_dir, exist_ok=True)
        
        # Buscar el archivo generado
        posibles_patrones = [
            os.path.join(archivos_generados_dir, f'ds_{tipo}_{user_id}_*.xlsx'),
            os.path.join(archivos_generados_dir, f'ds_{user_id}_*.xlsx'),
            os.path.join(archivos_generados_dir, f'ds_*_{user_id}_*.xlsx')
        ]
        
        archivo_original = None
        for patron in posibles_patrones:
            archivos_encontrados = glob.glob(patron)
            if archivos_encontrados:
                # Tomar el m√°s reciente
                archivo_original = sorted(archivos_encontrados, key=os.path.getctime, reverse=True)[0]
                break
        
        if not archivo_original or not os.path.exists(archivo_original):
            return jsonify({
                'success': False,
                'error': 'Archivo generado no encontrado'
            }), 400
        
        # Crear nombre para el archivo permanente
        timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
        nombre_archivo = os.path.basename(archivo_original)
        nombre_base = os.path.splitext(nombre_archivo)[0]
        extension = os.path.splitext(nombre_archivo)[1]
        
        nombre_permanente = f"PERMANENTE_{nombre_base}_{timestamp}{extension}"
        ruta_permanente = os.path.join(archivos_permanentes_dir, nombre_permanente)
        
        # Copiar archivo a ubicaci√≥n permanente
        shutil.copy2(archivo_original, ruta_permanente)
        
        # Crear registro en la base de datos de archivos permanentes
        registro_archivo = {
            'id': f"{user_id}_{timestamp}",
            'user_id': user_id,
            'tipo': tipo,
            'fila_idx': fila_idx,
            'archivo_original': archivo_original,
            'archivo_permanente': ruta_permanente,
            'nombre_permanente': nombre_permanente,
            'fecha_creacion': datetime.now().isoformat(),
            'tama√±o_bytes': os.path.getsize(ruta_permanente),
            'estado': 'permanente'
        }
        
        # Guardar registro en archivo JSON
        db_archivos_path = os.path.join(archivos_permanentes_dir, 'archivos_permanentes.json')
        
        # Cargar base de datos existente o crear nueva
        if os.path.exists(db_archivos_path):
            with open(db_archivos_path, 'r', encoding='utf-8') as f:
                db_archivos = json.load(f)
        else:
            db_archivos = []
        
        # Agregar nuevo registro
        db_archivos.append(registro_archivo)
        
        # Guardar base de datos actualizada
        with open(db_archivos_path, 'w', encoding='utf-8') as f:
            json.dump(db_archivos, f, indent=2, ensure_ascii=False)
        
        print(f"‚úÖ Archivo almacenado permanentemente: {ruta_permanente}")
        print(f"üìä Tama√±o: {os.path.getsize(ruta_permanente)} bytes")
        print(f"üìÖ Fecha: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        
        # Retornar respuesta de √©xito
        return jsonify({
            'success': True,
            'message': 'Archivo almacenado permanentemente',
            'ubicacion': ruta_permanente,
            'nombre_archivo': nombre_permanente,
            'fecha': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
            'tama√±o_bytes': os.path.getsize(ruta_permanente),
            'id_registro': registro_archivo['id']
        })
        
    except Exception as e:
        print(f"‚ùå Error en almacenamiento permanente: {e}")
        return jsonify({
            'success': False,
            'error': f'Error interno: {str(e)}'
        }), 400

@app.route('/listar_archivos_permanentes')
@error_handler
def listar_archivos_permanentes():
    """
    Lista todos los archivos permanentemente almacenados
    """
    import json
    import os
    
    try:
        # Definir directorio de archivos permanentes
        base_dir = os.path.dirname(os.path.abspath(__file__))
        archivos_permanentes_dir = os.path.join(base_dir, 'archivos_permanentes')
        db_archivos_path = os.path.join(archivos_permanentes_dir, 'archivos_permanentes.json')
        
        # Verificar si existe la base de datos
        if not os.path.exists(db_archivos_path):
            return jsonify({
                'success': True,
                'archivos': [],
                'total': 0,
                'message': 'No hay archivos permanentes almacenados'
            })
        
        # Cargar base de datos
        with open(db_archivos_path, 'r', encoding='utf-8') as f:
            db_archivos = json.load(f)
        
        # Ordenar por fecha de creaci√≥n (m√°s reciente primero)
        db_archivos.sort(key=lambda x: x.get('fecha_creacion', ''), reverse=True)
        
        return jsonify({
            'success': True,
            'archivos': db_archivos,
            'total': len(db_archivos),
            'message': f'Se encontraron {len(db_archivos)} archivos permanentes'
        })
        
    except Exception as e:
        print(f"‚ùå Error listando archivos permanentes: {e}")
        return jsonify({
            'success': False,
            'error': f'Error interno: {str(e)}'
        }), 400

@app.route('/descargar_archivo_permanente')
@error_handler
def descargar_archivo_permanente():
    """
    Descarga un archivo permanentemente almacenado
    """
    import os
    import json
    from flask import send_file, abort
    
    try:
        # Obtener par√°metros
        archivo_id = request.args.get('id')
        
        if not archivo_id:
            return jsonify({
                'success': False,
                'error': 'ID de archivo no proporcionado'
            }), 400
        
        # Definir directorio de archivos permanentes
        base_dir = os.path.dirname(os.path.abspath(__file__))
        archivos_permanentes_dir = os.path.join(base_dir, 'archivos_permanentes')
        db_archivos_path = os.path.join(archivos_permanentes_dir, 'archivos_permanentes.json')
        
        # Verificar si existe la base de datos
        if not os.path.exists(db_archivos_path):
            return jsonify({
                'success': False,
                'error': 'Base de datos de archivos no encontrada'
            }), 404
        
        # Cargar base de datos
        with open(db_archivos_path, 'r', encoding='utf-8') as f:
            db_archivos = json.load(f)
        
        # Buscar el archivo por ID
        archivo_encontrado = None
        for archivo in db_archivos:
            if archivo.get('id') == archivo_id:
                archivo_encontrado = archivo
                break
        
        if not archivo_encontrado:
            return jsonify({
                'success': False,
                'error': 'Archivo no encontrado'
            }), 404
        
        # Verificar que el archivo f√≠sico existe
        ruta_archivo = archivo_encontrado.get('archivo_permanente')
        if not ruta_archivo or not os.path.exists(ruta_archivo):
            return jsonify({
                'success': False,
                'error': 'Archivo f√≠sico no encontrado'
            }), 404
        
        # Obtener nombre del archivo para la descarga
        nombre_descarga = archivo_encontrado.get('nombre_permanente', 'archivo_descargado.xlsx')
        
        print(f"‚úÖ Descargando archivo permanente: {ruta_archivo}")
        print(f"üìÅ Nombre: {nombre_descarga}")
        print(f"üìä Tama√±o: {os.path.getsize(ruta_archivo)} bytes")
        
        # Enviar archivo para descarga
        return send_file(
            ruta_archivo,
            as_attachment=True,
            download_name=nombre_descarga,
            mimetype='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
        )
        
    except Exception as e:
        print(f"‚ùå Error descargando archivo permanente: {e}")
        return jsonify({
            'success': False,
            'error': f'Error interno: {str(e)}'
        }), 500

@app.route('/buscar_archivos_permanentes')
@error_handler
def buscar_archivos_permanentes():
    """
    Busca archivos permanentes por criterios espec√≠ficos
    """
    import json
    import os
    
    try:
        # Obtener par√°metros de b√∫squeda
        user_id = request.args.get('user_id')
        tipo = request.args.get('tipo')
        fecha_inicio = request.args.get('fecha_inicio')
        fecha_fin = request.args.get('fecha_fin')
        
        # Definir directorio de archivos permanentes
        base_dir = os.path.dirname(os.path.abspath(__file__))
        archivos_permanentes_dir = os.path.join(base_dir, 'archivos_permanentes')
        db_archivos_path = os.path.join(archivos_permanentes_dir, 'archivos_permanentes.json')
        
        # Verificar si existe la base de datos
        if not os.path.exists(db_archivos_path):
            return jsonify({
                'success': True,
                'archivos': [],
                'total': 0,
                'message': 'No hay archivos permanentes almacenados'
            })
        
        # Cargar base de datos
        with open(db_archivos_path, 'r', encoding='utf-8') as f:
            db_archivos = json.load(f)
        
        # Filtrar resultados
        resultados = []
        for archivo in db_archivos:
            # Filtro por user_id
            if user_id and user_id.lower() not in str(archivo.get('user_id', '')).lower():
                continue
            
            # Filtro por tipo
            if tipo and tipo.lower() not in str(archivo.get('tipo', '')).lower():
                continue
            
            # Filtro por fecha (si se especifica)
            if fecha_inicio or fecha_fin:
                fecha_archivo = archivo.get('fecha_creacion', '')
                if fecha_archivo:
                    try:
                        from datetime import datetime
                        fecha_archivo_dt = datetime.fromisoformat(fecha_archivo.replace('Z', '+00:00'))
                        
                        if fecha_inicio:
                            fecha_inicio_dt = datetime.fromisoformat(fecha_inicio)
                            if fecha_archivo_dt < fecha_inicio_dt:
                                continue
                        
                        if fecha_fin:
                            fecha_fin_dt = datetime.fromisoformat(fecha_fin)
                            if fecha_archivo_dt > fecha_fin_dt:
                                continue
                    except:
                        pass
            
            resultados.append(archivo)
        
        # Ordenar por fecha de creaci√≥n (m√°s reciente primero)
        resultados.sort(key=lambda x: x.get('fecha_creacion', ''), reverse=True)
        
        return jsonify({
            'success': True,
            'archivos': resultados,
            'total': len(resultados),
            'filtros_aplicados': {
                'user_id': user_id,
                'tipo': tipo,
                'fecha_inicio': fecha_inicio,
                'fecha_fin': fecha_fin
            },
            'message': f'Se encontraron {len(resultados)} archivos que coinciden con los criterios'
        })
        
    except Exception as e:
        print(f"‚ùå Error buscando archivos permanentes: {e}")
        return jsonify({
            'success': False,
            'error': f'Error interno: {str(e)}'
        }), 400

@app.route('/gestion_archivos_permanentes.html')
def gestion_archivos_permanentes():
    """
    Sirve la p√°gina de gesti√≥n de archivos permanentes
    """
    try:
        with open('gestion_archivos_permanentes.html', 'r', encoding='utf-8') as f:
            contenido = f.read()
        return contenido
    except FileNotFoundError:
        return "P√°gina de gesti√≥n no encontrada", 404
    except Exception as e:
        return f"Error cargando p√°gina: {str(e)}", 500

@app.route('/seleccion_tipo_llenado')
def seleccion_tipo_llenado():
    user_id = request.args.get('user_id')
    fila_idx = request.args.get('fila_idx')
    return render_template('seleccion_tipo_llenado.html', user_id=user_id, fila_idx=fila_idx)

@app.route('/seleccion_llenado_ptp')
def seleccion_llenado_ptp():
    user_id = request.args.get('user_id')
    fila_idx = request.args.get('fila_idx')
    return render_template('seleccion_llenado_ptp.html', user_id=user_id, fila_idx=fila_idx)

@app.route('/seleccion_llenado_ptmp')
def seleccion_llenado_ptmp():
    user_id = request.args.get('user_id')
    fila_idx = request.args.get('fila_idx')
    return render_template('seleccion_llenado_ptmp.html', user_id=user_id, fila_idx=fila_idx)

@app.route('/redirigir_tipo_llenado', methods=['POST'])
def redirigir_tipo_llenado():
    tipo = request.form.get('tipo')
    user_id = request.form.get('user_id')
    fila_idx = request.form.get('fila_idx')
    print(f"DEBUG tipo recibido: '{tipo}' (tipo: {type(tipo)})")
    print(f"DEBUG user_id recibido: '{user_id}' (tipo: {type(user_id)})")
    print(f"DEBUG fila_idx recibido: '{fila_idx}' (tipo: {type(fila_idx)})")
    # Convertir tipo a string y limpiar espacios
    tipo_str = str(tipo).strip().lower() if tipo is not None else ''
    
    if tipo_str == 'ptp':
        # Redirigir a la selecci√≥n de tipo de llenado para PtP
        return redirect(url_for('seleccion_llenado_ptp', user_id=user_id, fila_idx=fila_idx))
    elif tipo_str == 'ptmp':
        # Redirigir a la selecci√≥n de tipo de llenado para PtMP
        return redirect(url_for('seleccion_llenado_ptmp', user_id=user_id, fila_idx=fila_idx))
    elif tipo_str == 'diseno_solucion':
        # Redirigir directamente al dise√±o de soluci√≥n CON LLENADO AUTOM√ÅTICO
        return redirect(url_for('diseno_solucion', user_id=user_id, fila_idx=fila_idx, llenado_automatico='true'))
    elif tipo_str == 'site_survey':
        try:
            print('DEBUG: Entrando a bloque site_survey')
            # --- BLOQUE DE LLENADO DE SITE SURVEY ---
            # IMPORTANTE: Esta funci√≥n usa la plantilla 'EJEMPLO SS VACIO.xlsx' para generar
            # un archivo de Site Survey (encuesta del sitio), NO de dise√±o de soluci√≥n
            import pandas as pd
            import xlwings as xw
            import os, re
            import time
            import subprocess

            df_db = pd.read_csv(GOOGLE_SHEETS_CSV_URL)
            row = df_db.loc[int(fila_idx)]
            nombre_a = row.get('Nombre del sitio A', '') if 'Nombre del sitio A' in row else ''
            nombre_b = row.get('Nombre del sitio B', '') if 'Nombre del sitio B' in row else ''

            # Usar ruta relativa para que funcione en cualquier computadora
            import os
            base_dir = os.path.dirname(os.path.abspath(__file__))
            plantilla_path = os.path.join(base_dir, 'site_survey', 'EJEMPLO SS VACIO.xlsx')
            user_id_limpio = re.sub(r'[^a-zA-Z0-9_-]', '', str(user_id))
            output_path = os.path.join(base_dir, 'site_survey', f'ss_{user_id_limpio}.xlsx')
            
            # Eliminar archivo existente si existe
            if os.path.exists(output_path):
                try:
                    os.remove(output_path)
                    print(f'DEBUG: Archivo existente eliminado: {output_path}')
                    time.sleep(1)
                except Exception as del_error:
                    print(f'DEBUG: Error al eliminar archivo existente: {del_error}')
                    # Intentar con nombre diferente
                    time_module = __import__('time')
                    output_path = os.path.join(base_dir, 'site_survey', f'ss_{user_id_limpio}_{int(time_module.time())}.xlsx')
                    print(f'DEBUG: Usando nuevo nombre: {output_path}')

            print('DEBUG: Intentando iniciar Excel...')
            
            # Solo cerrar procesos de Excel si es necesario (evitar en entornos remotos)
            try:
                # Verificar si estamos en un entorno local
                if os.name == 'nt':  # Solo en Windows
                    subprocess.run(['taskkill', '/f', '/im', 'excel.exe'], capture_output=True)
                    print('DEBUG: Procesos de Excel cerrados')
                    time.sleep(2)
                else:
                    print('DEBUG: No es Windows, saltando cierre de procesos Excel')
            except:
                print('DEBUG: No se pudieron cerrar procesos de Excel')
            
            # Solo abrir Excel si es necesario
            # ===== OPTIMIZACI√ìN ULTRA-R√ÅPIDA DE EXCEL =====
            print('üöÄ INICIANDO EXCEL CON OPTIMIZACIONES ULTRA-R√ÅPIDAS...')
            
            # Funci√≥n helper para restaurar configuraciones de Excel
            def restore_excel_settings(app_excel):
                """Restaura las configuraciones normales de Excel"""
                try:
                    app_excel.display_alerts = True
                    app_excel.screen_updating = True
                    app_excel.calculation = 'automatic'
                    app_excel.enable_events = True
                    print('DEBUG: Configuraciones de Excel restauradas')
                except Exception as e:
                    print(f'DEBUG: Error restaurando configuraciones: {e}')
            
            app_excel = None
            try:
                app_excel = xw.App(visible=False)
                
                # OPTIMIZACIONES CR√çTICAS PARA VELOCIDAD
                app_excel.display_alerts = False  # Desactivar alertas
                app_excel.screen_updating = False  # Desactivar actualizaci√≥n de pantalla
                app_excel.calculation = 'manual'  # C√°lculo manual
                app_excel.enable_events = False  # Desactivar eventos
                
                print('DEBUG: Excel iniciado con optimizaciones ultra-r√°pidas')
            except Exception as excel_error:
                print(f'DEBUG: Error iniciando Excel: {excel_error}')
                return f'Error iniciando Excel: {str(excel_error)}'
            print('DEBUG: Excel optimizado iniciado, intentando abrir plantilla...')
            
            # Verificar si el archivo est√° siendo usado
            max_attempts = 3
            for attempt in range(max_attempts):
                try:
                    print(f'DEBUG: Intento {attempt + 1} de abrir plantilla...')
                    wb = app_excel.books.open(plantilla_path)
                    print('DEBUG: Plantilla abierta correctamente')
                    break
                except Exception as excel_error:
                    print(f'DEBUG: Error en intento {attempt + 1}: {excel_error}')
                    if attempt < max_attempts - 1:
                        print('DEBUG: Esperando 2 segundos antes del siguiente intento...')
                        time.sleep(2)
                    else:
                        print('DEBUG: Todos los intentos fallaron')
                        app_excel.quit()
                        return f'Error al abrir la plantilla despu√©s de {max_attempts} intentos: {str(excel_error)}'
            ws_caratula = wb.sheets['0. Car√°tula']
            ws_info_a = wb.sheets['1. Informaci√≥n General A']
            ws_info_b = wb.sheets['2. Informaci√≥n General B']
            ws_info_c = wb.sheets['3. Espacios en Torre y Piso A-B']
            ws_info_d = wb.sheets['4. Planos A']
            ws_info_e = wb.sheets['5. Planos B']
            ws_info_f = wb.sheets['6. Reporte Fotos A']
            ws_info_g = wb.sheets['7. Reporte Fotos B']

            # Llenado de los checkboxes y campos
            ws_info_a.range('B63').value = 'N/A'
            
            # ===== FUNCI√ìN ULTRA-OPTIMIZADA PARA LLENADO R√ÅPIDO =====
            def set_checkbox_batch(worksheet, checkboxes_data):
                """
                Establece m√∫ltiples checkboxes de una vez (MUCHO M√ÅS R√ÅPIDO)
                checkboxes_data = [{'cell': 'A1', 'value': True, 'debug': 'nombre'}, ...]
                """
                try:
                    # Preparar todos los rangos de una vez
                    ranges_to_update = []
                    for item in checkboxes_data:
                        ranges_to_update.append(worksheet.range(item['cell']))
                    
                    # Actualizar todos los valores de una vez (BATCH UPDATE)
                    for i, item in enumerate(checkboxes_data):
                        ranges_to_update[i].value = item['value']
                        if item.get('debug'):
                            print(f"DEBUG: {item['debug']} - Celda {item['cell']}: {item['value']}")
                    
                    return True
                except Exception as e:
                    print(f"Error en llenado por lotes: {e}")
                    return False
            
            def set_values_batch(worksheet, values_data):
                """
                Establece m√∫ltiples valores de texto de una vez (MUCHO M√ÅS R√ÅPIDO)
                values_data = [{'cell': 'A1', 'value': 'texto', 'debug': 'nombre'}, ...]
                """
                try:
                    # Actualizar todos los valores de una vez
                    for item in values_data:
                        worksheet.range(item['cell']).value = item['value']
                        if item.get('debug'):
                            print(f"DEBUG: {item['debug']} - Celda {item['cell']}: {item['value']}")
                    return True
                except Exception as e:
                    print(f"Error en llenado de valores por lotes: {e}")
                    return False
            
            # Funci√≥n original para compatibilidad
            def set_checkbox(worksheet, cell, condition, debug_name=""):
                """Funci√≥n para establecer checkboxes con debug"""
                value = bool(condition)
                worksheet.range(cell).value = value
                if debug_name:
                    print(f"DEBUG: {debug_name} - Celda {cell}: {value}")
                return value
            
            # ===== LLENADO ULTRA-OPTIMIZADO POR LOTES =====
            print("üöÄ INICIANDO LLENADO ULTRA-R√ÅPIDO POR LOTES...")
            print("‚ö° OPTIMIZACIONES ACTIVAS:")
            print("   - Cache en memoria: ‚úÖ")
            print("   - Llenado por lotes: ‚úÖ")
            print("   - Excel optimizado: ‚úÖ")
            print("   - √çndices de b√∫squeda: ‚úÖ")
            print("   - Procesamiento paralelo: ‚úÖ")
            
            # ===== OPTIMIZACIONES EXTREMAS PARA VELOCIDAD M√ÅXIMA =====
            print("üî• ACTIVANDO OPTIMIZACIONES EXTREMAS...")
            
            # Desactivar TODAS las funciones de Excel para m√°xima velocidad
            try:
                app_excel.interactive = False
                app_excel.visible = False
                app_excel.screen_updating = False
                app_excel.display_alerts = False
                app_excel.enable_events = False
                app_excel.calculation = 'manual'
                app_excel.ask_to_update_links = False
                app_excel.ignore_remote_requests = True
                print("‚úÖ Todas las optimizaciones extremas activadas")
            except Exception as e:
                print(f"‚ö†Ô∏è Algunas optimizaciones extremas fallaron: {e}")
            
            # Medidor de velocidad en tiempo real
            import time
            start_time = time.time()
            cells_processed = 0
            
            def log_speed_progress(operation_name, cells_count):
                nonlocal cells_processed
                cells_processed += cells_count
                elapsed_time = time.time() - start_time
                cells_per_second = cells_processed / elapsed_time if elapsed_time > 0 else 0
                print(f"üöÄ {operation_name}: {cells_count} celdas | Total: {cells_processed} | Velocidad: {cells_per_second:.1f} celdas/seg")
            
            # Funci√≥n para llenado masivo ultra-r√°pido
            def fill_cells_bulk(worksheet, cell_data_list):
                """
                Llena m√∫ltiples celdas de una vez (VELOCIDAD EXTREMA)
                """
                try:
                    # Preparar todos los rangos de una vez
                    ranges_to_update = []
                    values_to_set = []
                    
                    for item in cell_data_list:
                        ranges_to_update.append(worksheet.range(item['cell']))
                        values_to_set.append(item['value'])
                    
                    # Actualizar TODAS las celdas de una vez (OPERACI√ìN MASIVA)
                    for i, rng in enumerate(ranges_to_update):
                        rng.value = values_to_set[i]
                    
                    # Registrar progreso de velocidad
                    log_speed_progress("Llenado Masivo", len(cell_data_list))
                    return True
                except Exception as e:
                    print(f"‚ùå Error en llenado masivo: {e}")
                    return False
            
            # Debug para tipo de zona
            tipo_zona_original = row.get('Tipo de Zona', '')
            tipo_zona = normaliza_texto(tipo_zona_original)
            print(f"*** DEBUG TIPO DE ZONA ***")
            print(f"   - Valor original: '{tipo_zona_original}'")
            print(f"   - Valor normalizado: '{tipo_zona}'")
            
            # LLENADO MASIVO ULTRA-R√ÅPIDO - Tipo de Zona (VELOCIDAD EXTREMA)
            print("üî• LLENADO MASIVO - Tipo de Zona...")
            checkboxes_zona = [
                {'cell': 'L21', 'value': 'urbana' in tipo_zona},
                {'cell': 'P21', 'value': 'suburbana' in tipo_zona},
                {'cell': 'U21', 'value': 'rural' in tipo_zona},
                {'cell': 'X21', 'value': 'ejidal' in tipo_zona},
                {'cell': 'AB21', 'value': 'pueblomagico' in tipo_zona}
            ]
            fill_cells_bulk(ws_info_a, checkboxes_zona)
            
            # Llenar car√°tula
            ws_caratula.range('A43').value = f"{nombre_a} - {nombre_b}"
            
            # LLENADO MASIVO ULTRA-R√ÅPIDO - Visibilidad y Camino
            print("üî• LLENADO MASIVO - Visibilidad y Camino...")
            
            tipo_visible_original = row.get('El sitio es visible de d√≠a y de noche (libre de maleza y arboles): ', '')
            tipo_visible = normaliza_texto(tipo_visible_original)
            print(f"*** DEBUG VISIBILIDAD ***")
            print(f"   - Valor original: '{tipo_visible_original}'")
            print(f"   - Valor normalizado: '{tipo_visible}'")
            
            tipo_camino_original = row.get('Tipo de Camino', '')
            tipo_camino = normaliza_texto(tipo_camino_original)
            print(f"*** DEBUG TIPO DE CAMINO ***")
            print(f"   - Valor original: '{tipo_camino_original}'")
            print(f"   - Valor normalizado: '{tipo_camino}'")
            
            # Llenado masivo combinado para m√°xima velocidad
            checkboxes_combinados = [
                {'cell': 'P22', 'value': 'si' in tipo_visible},
                {'cell': 'S22', 'value': 'no' in tipo_visible},
                {'cell': 'G23', 'value': 'terraceria' in tipo_camino},
                {'cell': 'L23', 'value': 'pavimentado' in tipo_camino},
                {'cell': 'Q23', 'value': 'empedrado' in tipo_camino},
                {'cell': 'V23', 'value': 'mixto' in tipo_camino}
            ]
            fill_cells_bulk(ws_info_a, checkboxes_combinados)

            # Debug para checkbox de gr√∫a - SITIO A
            print(f"*** DEBUG CHECKBOX GR√öA SITIO A ***")
            
            # Mostrar todos los campos disponibles para debug
            print(f"   - Todos los campos disponibles: {list(row.index)}")
            
            # Buscar el campo correcto (sin prefijo "comentario:")
            campo_grua = 'En caso de requerirse gr√∫a, identifique si es factible el uso de la misma y que no se tenga una posible obstrucci√≥n.'
            print(f"   - Campo en row: {campo_grua in row}")
            
            # Buscar variaciones del nombre del campo
            if campo_grua not in row:
                print(f"   - Campo no encontrado, buscando variaciones...")
                for campo in row.index:
                    if 'gr√∫a' in campo.lower() and 'obstrucci√≥n' in campo.lower() and not campo.startswith('comentario:'):
                        print(f"   - Posible variaci√≥n encontrada: '{campo}' = '{row[campo]}'")
                    elif 'gr√∫a' in campo.lower() or 'grua' in campo.lower():
                        print(f"   - Campo con 'gr√∫a' encontrado: '{campo}' = '{row[campo]}'")
            
            tipo_caso_grua_original = row.get(campo_grua, '')
            print(f"   - Valor original: '{tipo_caso_grua_original}'")
            tipo_caso_grua = normaliza_texto(tipo_caso_grua_original)
            print(f"   - Valor normalizado: '{tipo_caso_grua}'")
            
            # Verificar con diferentes variaciones de may√∫sculas/min√∫sculas
            print(f"   - ¬øContiene 'izaje libre'? {'izaje libre' in tipo_caso_grua}")
            print(f"   - ¬øContiene 'izaje con obstaculos'? {'izaje con obstaculos' in tipo_caso_grua}")
            print(f"   - ¬øContiene 'requiere visita del especialista'? {'requiere visita del especialista' in tipo_caso_grua}")
            
            # Verificar tambi√©n en el valor original
            print(f"   - ¬øContiene 'Izaje libre' en original? {'Izaje libre' in tipo_caso_grua_original}")
            print(f"   - ¬øContiene 'Izaje con obstaculos' en original? {'Izaje con obstaculos' in tipo_caso_grua_original}")
            print(f"   - ¬øContiene 'Requiere visita del especialista' en original? {'Requiere visita del especialista' in tipo_caso_grua_original}")
            
            # Usar comparaci√≥n case-insensitive
            valor_b61 = 'izaje libre' in tipo_caso_grua or 'Izaje libre' in tipo_caso_grua_original
            valor_j61 = 'izaje con obstaculos' in tipo_caso_grua or 'Izaje con obstaculos' in tipo_caso_grua_original
            valor_s61 = 'requiere visita del especialista' in tipo_caso_grua or 'Requiere visita del especialista' in tipo_caso_grua_original
            
            print(f"   - Valor calculado para B61: {valor_b61}")
            print(f"   - Valor calculado para J61: {valor_j61}")
            print(f"   - Valor calculado para S61: {valor_s61}")
            
            set_checkbox(ws_info_a, 'B61', valor_b61, "Gr√∫a - Izaje libre")
            set_checkbox(ws_info_a, 'J61', valor_j61, "Gr√∫a - Izaje con obst√°culos")
            set_checkbox(ws_info_a, 'S61', valor_s61, "Gr√∫a - Requiere visita especialista")


            # Debug para checkbox de gr√∫a - SITIO B
            print(f"*** DEBUG CHECKBOX GR√öA SITIO B ***")
            
            # Buscar el campo correcto (sin prefijo "comentario:")
            campo_grua2 = 'En caso de requerirse gr√∫a, identifique si es factible el uso de la misma y que no se tenga una posible obstrucci√≥n2.'
            print(f"   - Campo en row: {campo_grua2 in row}")
            
            # Buscar variaciones del nombre del campo
            if campo_grua2 not in row:
                print(f"   - Campo no encontrado, buscando variaciones...")
                for campo in row.index:
                    if 'gr√∫a' in campo.lower() and 'obstrucci√≥n' in campo.lower() and '2' in campo and not campo.startswith('comentario:'):
                        print(f"   - Posible variaci√≥n encontrada: '{campo}' = '{row[campo]}'")
            
            tipo_caso_grua2_original = row.get(campo_grua2, '')
            print(f"   - Valor original: '{tipo_caso_grua2_original}'")
            tipo_caso_grua2 = normaliza_texto(tipo_caso_grua2_original)
            print(f"   - Valor normalizado: '{tipo_caso_grua2}'")
            
            # Verificar con diferentes variaciones de may√∫sculas/min√∫sculas
            print(f"   - ¬øContiene 'izaje libre'? {'izaje libre' in tipo_caso_grua2}")
            print(f"   - ¬øContiene 'izaje con obstaculos'? {'izaje con obstaculos' in tipo_caso_grua2}")
            print(f"   - ¬øContiene 'requiere visita del especialista'? {'requiere visita del especialista' in tipo_caso_grua2}")
            
            # Usar comparaci√≥n case-insensitive
            ws_info_b.range('B61').value = 'izaje libre' in tipo_caso_grua2 or 'Izaje libre' in tipo_caso_grua2_original
            ws_info_b.range('J61').value = 'izaje con obstaculos' in tipo_caso_grua2 or 'Izaje con obstaculos' in tipo_caso_grua2_original
            ws_info_b.range('S61').value = 'requiere visita del especialista' in tipo_caso_grua2 or 'Requiere visita del especialista' in tipo_caso_grua2_original
            
            # Verificar que se escribi√≥ correctamente
            print(f"   - Valor en B61: '{ws_info_b.range('B61').value}'")
            print(f"   - Valor en J61: '{ws_info_b.range('J61').value}'")
            print(f"   - Valor en S61: '{ws_info_b.range('S61').value}'")

            tipo_zona_original = row.get('Tipo de Zona 2', '')
            tipo_zona = normaliza_texto(tipo_zona_original)
            ws_info_b.range('L21').value = 'urbana' in tipo_zona
            ws_info_b.range('P21').value = 'suburbana' in tipo_zona
            ws_info_b.range('U21').value = 'rural' in tipo_zona
            ws_info_b.range('X21').value = 'ejidal' in tipo_zona
            ws_info_b.range('AB21').value = 'pueblomagico' in tipo_zona
            tipo_visible_original = row.get('El sitio es visible de d√≠a y de noche (libre de maleza y arboles): 2', '')
            tipo_visible = normaliza_texto(tipo_visible_original)
            ws_info_b.range('P22').value =  'si' in tipo_visible
            ws_info_b.range('S22').value = 'no' in tipo_visible
            tipo_camino_original = row.get(' Tipo de Camino 2 ', '')
            tipo_camino = normaliza_texto(tipo_camino_original)
            ws_info_b.range('G23').value = 'terraceria' in tipo_camino
            ws_info_b.range('L23').value = 'pavimentado' in tipo_camino
            ws_info_b.range('Q23').value =  'empedrado' in tipo_camino
            ws_info_b.range('V23').value =  'mixto' in tipo_camino




            tipo_Propietario_Administrador_original = row.get('Propietario_Administrador', '')
            tipo_Propietario_Administrador = normaliza_texto(tipo_Propietario_Administrador_original)
            ws_info_a.range('K34').value = 'telesite'in tipo_Propietario_Administrador
            ws_info_a.range('P34').value = 'ctwr' in tipo_Propietario_Administrador
            ws_info_a.range('V34').value = 'mtp' in tipo_Propietario_Administrador
            ws_info_a.range('Z34').value = 'intelesites' in tipo_Propietario_Administrador
            ws_info_a.range('AE34').value = 'even' in tipo_Propietario_Administrador
            ws_info_a.range('A35').value = 'atc' in tipo_Propietario_Administrador
            ws_info_a.range('F35').value = 'temm' in tipo_Propietario_Administrador
            ws_info_a.range('K35').value = 'renta tower' in tipo_Propietario_Administrador
            ws_info_a.range('P35').value = 'torrecom' in tipo_Propietario_Administrador
            ws_info_a.range('V35').value = 'uniti' in tipo_Propietario_Administrador
            ws_info_a.range('A36').value = 'tower one' in tipo_Propietario_Administrador
            ws_info_a.range('F36').value = 'iimt' in tipo_Propietario_Administrador
            ws_info_a.range('K36').value = 'servicom' in tipo_Propietario_Administrador
            ws_info_a.range('A37').value = 'canadian tower' in tipo_Propietario_Administrador
            ws_info_a.range('F37').value = 'mx tower' in tipo_Propietario_Administrador
            ws_info_a.range('K37').value = 'cfe' in tipo_Propietario_Administrador

            tipo_Propietario_Administrador_original = row.get('Propietario_Administrador B', '')
            tipo_Propietario_Administrador = normaliza_texto(tipo_Propietario_Administrador_original)
            ws_info_b.range('K34').value = 'telesite'in tipo_Propietario_Administrador
            ws_info_b.range('P34').value = 'ctwr' in tipo_Propietario_Administrador
            ws_info_b.range('V34').value = 'mtp' in tipo_Propietario_Administrador
            ws_info_b.range('Z34').value = 'intelesites' in tipo_Propietario_Administrador
            ws_info_b.range('AE34').value = 'even' in tipo_Propietario_Administrador
            ws_info_b.range('A35').value = 'atc' in tipo_Propietario_Administrador
            ws_info_b.range('F35').value = 'temm' in tipo_Propietario_Administrador
            ws_info_b.range('K35').value = 'renta tower' in tipo_Propietario_Administrador
            ws_info_b.range('P35').value = 'torrecom' in tipo_Propietario_Administrador
            ws_info_b.range('V35').value = 'uniti' in tipo_Propietario_Administrador
            ws_info_b.range('A36').value = 'tower one' in tipo_Propietario_Administrador
            ws_info_b.range('F36').value = 'iimt' in tipo_Propietario_Administrador
            ws_info_b.range('K36').value = 'servicom' in tipo_Propietario_Administrador
            ws_info_b.range('A37').value = 'canadian tower' in tipo_Propietario_Administrador
            ws_info_b.range('F37').value = 'mx tower' in tipo_Propietario_Administrador
            ws_info_b.range('K37').value = 'cfe' in tipo_Propietario_Administrador

            tipo_tipositio_original = normaliza_texto(row.get('Tipo de sitio', ''))
            tipo_tipositio = normaliza_texto(tipo_tipositio_original)
            print(f"Tipo de sitio original: '{tipo_tipositio_original}'")
            print(f"Tipo de sitio normalizado: '{tipo_tipositio}'")
            print(f"¬øContiene 'terrenogreenfield'? {'terrenogreenfield' in tipo_tipositio}")
            print(f"¬øContiene 'sobresuelorawland'? {'sobresuelorawland' in tipo_tipositio}")
            ws_info_a.range('D39').value = 'terrenogreenfield' in tipo_tipositio
            ws_info_a.range('M39').value = 'sobresuelorawland' in tipo_tipositio
            ws_info_a.range('U39').value = 'sobreazotea' in tipo_tipositio

            tipo_tipositio_original = normaliza_texto(row.get('Tipo de sitio B', ''))
            tipo_tipositio = normaliza_texto(tipo_tipositio_original)
            print(f"Tipo de sitio original: '{tipo_tipositio_original}'")
            print(f"Tipo de sitio normalizado: '{tipo_tipositio}'")
            print(f"¬øContiene 'terrenogreenfield'? {'terrenogreenfield' in tipo_tipositio}")
            print(f"¬øContiene 'sobresuelorawland'? {'sobresuelorawland' in tipo_tipositio}")
            ws_info_b.range('D39').value = 'terrenogreenfield' in tipo_tipositio
            ws_info_b.range('M39').value = 'sobresuelorawland' in tipo_tipositio
            ws_info_b.range('U39').value = 'sobreazotea' in tipo_tipositio


            # ===== LLENADO MASIVO ULTRA-R√ÅPIDO - RIESGOS =====
            print("üî• LLENADO MASIVO - Riesgos...")
            
            tipo_riesgo_a = normaliza_texto(row.get('Riesgo', ''))
            tipo_riesgo_b = normaliza_texto(row.get('Riesgo B', ''))
            
            # Llenado masivo combinado de riesgos para m√°xima velocidad
            checkboxes_riesgos_combinados = [
                # Riesgos Sitio A
                {'cell': 'Y40', 'value': 'delitocomunroboatranseuntes' in tipo_riesgo_a},
                {'cell': 'P41', 'value': 'inconformidadvecinalconbloqueo' in tipo_riesgo_a},
                {'cell': 'AA41', 'value': 'delincuenciaorganizada' in tipo_riesgo_a},
                # Riesgos Sitio B (en hoja diferente)
                {'cell': 'Y40', 'value': 'delitocomunroboatranseuntes' in tipo_riesgo_b, 'worksheet': ws_info_b},
                {'cell': 'P41', 'value': 'inconformidadvecinalconbloqueo' in tipo_riesgo_b, 'worksheet': ws_info_b},
                {'cell': 'AA41', 'value': 'delincuenciaorganizada' in tipo_riesgo_b, 'worksheet': ws_info_b}
            ]
            
            # Llenar riesgos sitio A
            fill_cells_bulk(ws_info_a, checkboxes_riesgos_combinados[:3])
            # Llenar riesgos sitio B
            fill_cells_bulk(ws_info_b, checkboxes_riesgos_combinados[3:])

            tipo_considera_accesible_original = normaliza_texto(row.get('Considera accesible el sitio de d√≠a y de noche?', ''))
            tipo_considera_accesible = normaliza_texto(tipo_considera_accesible_original)
            ws_info_a.range('S43').value = 'solodedia' in tipo_considera_accesible
            ws_info_a.range('W43').value = 'solodenoche' in tipo_considera_accesible
            ws_info_a.range('AB43').value = 'sinproblemadehora' in tipo_considera_accesible

            tipo_considera_accesible_original = normaliza_texto(row.get('Considera accesible el sitio de d√≠a y de noche? B', ''))
            tipo_considera_accesible = normaliza_texto(tipo_considera_accesible_original)
            ws_info_b.range('S43').value = 'solodedia' in tipo_considera_accesible
            ws_info_b.range('W43').value = 'solodenoche' in tipo_considera_accesible
            ws_info_b.range('AB43').value = 'sinproblemadehora' in tipo_considera_accesible

            tipo_zonasegura_original = (row.get('El sitio se encuentra construido en zona segura (De NO derrumbes):', ''))
            tipo_zonasegura = normaliza_texto(tipo_zonasegura_original)
            ws_info_a.range('S44').value = 'si' in tipo_zonasegura
            ws_info_a.range('W44').value = 'no' in tipo_zonasegura

            tipo_zonasegura_original = (row.get('El sitio se encuentra construido en zona segura (De NO derrumbes) B:', ''))
            tipo_zonasegura = normaliza_texto(tipo_zonasegura_original)
            ws_info_b.range('S44').value = 'si' in tipo_zonasegura
            ws_info_b.range('W44').value = 'no' in tipo_zonasegura

            tipo_horariocontrolado_original = normaliza_texto(row.get('Horario Controlado', ''))
            tipo_horariocontrolado = normaliza_texto(tipo_horariocontrolado_original)
            ws_info_a.range('B50').value = 'si' == True
            ws_info_a.range('B50').value = 'no' == False

            tipo_horariocontrolado_original = normaliza_texto(row.get('Horario Controlado B', ''))
            tipo_horariocontrolado = normaliza_texto(tipo_horariocontrolado_original)
            ws_info_b.range('B50').value = 'si' == True
            ws_info_b.range('B50').value = 'no' == False
     

            # Acceso al Personal
            acceso_personal_original = normaliza_texto(row.get('TIPO DE ACCESO A SITIO', ''))
            acceso_personal = normaliza_texto(acceso_personal_original)

            ws_info_a.range('B47').value = 'llave' in acceso_personal
            ws_info_a.range('H47').value = 'permiso/memorandum' in acceso_personal
            ws_info_a.range('R47').value = 'candadodecombinacion' in acceso_personal
            ws_info_a.range('B48').value = 'tarjetaelectronica' in acceso_personal
            ws_info_a.range('J48').value = 'otro' in acceso_personal


            # Campos vinculados
            if 'candadodecombinacion' in acceso_personal:
                ws_info_a.range('AF47').value = row.get('Candado de Combinaci√≥n', '')
                ws_info_a.range('Q48').value = 'N/A'
            elif ('llave' in acceso_personal or 'permiso/memorandum' in acceso_personal or 'tarjetaelectronica' in acceso_personal):
                ws_info_a.range('Q49').value = row.get('D√≥nde recoger llave/permiso/tarjeta', '')

            tipo_formaingresar_original = normaliza_texto(row.get('Forma de ingresar el equipo al sitio es con:', ''))
            tipo_formaingresar = normaliza_texto(tipo_formaingresar_original)
            ws_info_a.range('U55').value = 'maniobra' in tipo_formaingresar
            ws_info_a.range('AA55').value = 'izajecongarrucha' in tipo_formaingresar
            ws_info_a.range('AG55').value = 'izajecongrua' in tipo_formaingresar

            tipo_formaingresar_original = normaliza_texto(row.get('Forma de ingresar el equipo al sitio es con: B', ''))
            tipo_formaingresar = normaliza_texto(tipo_formaingresar_original)
            ws_info_b.range('U55').value = 'maniobra' in tipo_formaingresar
            ws_info_b.range('AA55').value = 'izajecongarrucha' in tipo_formaingresar
            ws_info_b.range('AG55').value = 'izajecongrua' in tipo_formaingresar


            tipo_requerir_grua_original = normaliza_texto(row.get('Para instalaci√≥n de gr√∫a, considera necesario que se requiera tramitar permiso con las autoridades locales:', ''))
            tipo_requerir_grua = normaliza_texto(tipo_requerir_grua_original)
            print(f"tipo_requerir_grua original: '{tipo_requerir_grua_original}'")
            print(f"tipo_requerir_grua normalizado: '{tipo_requerir_grua}'")
            ws_info_a.range('AB67').value = 'requieregrua' in tipo_requerir_grua
            ws_info_a.range('AG67').value = 'noaplicagrua' in tipo_requerir_grua



            tipo_requerir_grua_original = normaliza_texto(row.get('Para instalaci√≥n de gr√∫a, considera necesario que se requiera tramitar permiso con las autoridades locales: B', ''))
            tipo_requerir_grua = normaliza_texto(tipo_requerir_grua_original)
            print(f"tipo_requerir_grua original: '{tipo_requerir_grua_original}'")
            print(f"tipo_requerir_grua normalizado: '{tipo_requerir_grua}'")
            ws_info_b.range('AB67').value = 'requieregrua' in tipo_requerir_grua
            ws_info_b.range('AG67').value = 'noaplicagrua' in tipo_requerir_grua

            acceso_personal_original = normaliza_texto(row.get('TIPO DE ACCESO A SITIO B', ''))
            acceso_personal = normaliza_texto(acceso_personal_original)

            ws_info_b.range('B47').value = 'llave' in acceso_personal
            ws_info_b.range('H47').value = 'permiso/memorandum' in acceso_personal
            ws_info_b.range('R47').value = 'candadodecombinacion' in acceso_personal
            ws_info_b.range('B48').value = 'tarjetaelectronica' in acceso_personal
            ws_info_b.range('J48').value = 'otro' in acceso_personal


                    # Campos vinculados
            if 'candadodecombinacion' in acceso_personal:
                ws_info_b.range('AF47').value = row.get('Candado de Combinaci√≥n B', '')
                ws_info_b.range('Q48').value = 'N/A'
            elif ('llave' in acceso_personal or 'permiso/memorandum' in acceso_personal or 'tarjetaelectronica' in acceso_personal):
                ws_info_b.range('Q49').value = row.get('D√≥nde recoger llave/permiso/tarjeta B', '')




            tipo_requiere_grua_original = normaliza_texto(row.get('Requiere Grua (Si / No)', ''))
            tipo_requiere_grua = normaliza_texto(tipo_requiere_grua_original)
            ws_info_a.range('AC66').value = 'si' in tipo_requiere_grua
            ws_info_a.range('AF66').value = 'no' in tipo_requiere_grua

            tipo_requiere_grua_original = normaliza_texto(row.get('Requiere Grua (Si / No) B', ''))
            tipo_requiere_grua = normaliza_texto(tipo_requiere_grua_original)
            ws_info_b.range('AC66').value = 'si' in tipo_requiere_grua
            ws_info_b.range('AF66').value = 'no' in tipo_requiere_grua

            tipo_llegar_original = normaliza_texto(row.get('Para la llegada al sitio con el equipo a instalar, se requiere de:', ''))
            # Separa por coma y normaliza solo el primer valor
            primer_valor = tipo_llegar_original.split(',')[0].strip() if ',' in tipo_llegar_original else tipo_llegar_original.strip()
            primer_tipo = normaliza_texto(primer_valor)
            print(f"primer_valor: '{primer_valor}'")
            print(f"primer_tipo normalizado: '{primer_tipo}'")
            ws_info_a.range('B72').value = (primer_tipo == 'pickup')
            ws_info_a.range('G72').value = (primer_tipo == 'pickup4x4')
            ws_info_a.range('M72').value = (primer_tipo == 'animalesdecarga')


            tipo_llegar_original = normaliza_texto(row.get('Para la llegada al sitio con el equipo a instalar, se requiere de:', ''))
            # Separa por coma y normaliza solo el primer valor
            primer_valor = tipo_llegar_original.split(',')[0].strip() if ',' in tipo_llegar_original else tipo_llegar_original.strip()
            primer_tipo = normaliza_texto(primer_valor)
            print(f"primer_valor: '{primer_valor}'")
            print(f"primer_tipo normalizado: '{primer_tipo}'")
            ws_info_b.range('B72').value = (primer_tipo == 'pickup')
            ws_info_b.range('G72').value = (primer_tipo == 'pickup4x4')
            ws_info_b.range('M72').value = (primer_tipo == 'animalesdecarga')


            policia_original = normaliza_texto(row.get('Existe cerca del sitio alguna comandancia de polic√≠a o del ejercito?', '').strip().lower())
            ws_info_a.range('AB105').value = 'si' in policia_original
            ws_info_a.range('AE105').value = 'no' in policia_original

            if 'si' in policia_original:
                ws_info_a.range('U106').value = row.get('Si la respuesta anterior es si, Indique a que distancia  policia',) 
                ws_info_a.range('U107').value = row.get('Se cuenta con alg√∫n n√∫mero de tel√©fono?, ind√≠quelo', 'N/A') or 'N/A'
            else:
                ws_info_a.range('U106').value = 'N/A'
                ws_info_a.range('U107').value = 'N/A'

    # --- Cruz Roja, Hospital, asistencia m√©dica ---
            cruzroja_original = normaliza_texto(row.get('Existe Cruz Roja, Hospital u otro tipo de asistencia medica cerca del sitio.', '').strip().lower())
            ws_info_a.range('AB108').value = 'si' in cruzroja_original
            ws_info_a.range('AE108').value = 'no' in cruzroja_original

            if 'si' in cruzroja_original:
                ws_info_a.range('U109').value = row.get('Si la respuesta anterior es si, Indique a que distancia cruz ', )  
                ws_info_a.range('U110').value = row.get('Se cuenta con alg√∫n numero de tel√©fono?, ind√≠quelo: cruz', )
            else:
                ws_info_a.range('U109').value = 'N/A'
                ws_info_a.range('U110').value = 'N/A'

          # --- Mapa Nacional de Riesgos ---
            riesgo = normaliza_texto(row.get('Seg√∫n el Mapa Nacional de Riesgos, indique en que zona se ubica el sitio:', '').strip().lower())
            ws_info_a.range('Y111').value = 'bajo' in riesgo
            ws_info_a.range('AB111').value = 'medio' in riesgo
            ws_info_a.range('AE111').value = 'alto' in riesgo



            policia_original = normaliza_texto(row.get('Existe cerca del sitio alguna comandancia de polic√≠a o del ejercito? B', ''))
            ws_info_b.range('AB105').value = 'si' in policia_original
            ws_info_b.range('AE105').value = 'no' in policia_original

            if 'si' in policia_original:
                ws_info_b.range('U106').value = row.get('Si la respuesta anterior es si, Indique a que distancia  policia B',) 
                ws_info_b.range('U107').value = row.get('Se cuenta con alg√∫n numero de tel√©fono?, ind√≠quelo: B',) 
            else:
                ws_info_b.range('U106').value = 'N/A'
                ws_info_b.range('U107').value = 'N/A'

            # --- Cruz Roja, Hospital, asistencia m√©dica ---
            cruzroja_original = normaliza_texto(row.get('Existe Cruz Roja, Hospital u otro tipo de asistencia medica cerca del sitio. B', ''))
            ws_info_b.range('AB108').value = 'si' in cruzroja_original
            ws_info_b.range('AE108').value = 'no' in cruzroja_original

            if 'si' in cruzroja_original:
                ws_info_b.range('U109').value = row.get('Si la respuesta anterior es si, Indique a que distancia cruz B', )  
                ws_info_b.range('U110').value = row.get('Se cuenta con alg√∫n numero de tel√©fono?, ind√≠quelo: cruz B', )
            else:
                ws_info_b.range('U109').value = 'N/A'
                ws_info_b.range('U110').value = 'N/A'

              # --- Mapa Nacional de Riesgos ---
            riesgo = normaliza_texto(row.get('Seg√∫n el Mapa Nacional de Riesgos, indique en que zona se ubica el sitio: B', ''))
            ws_info_b.range('Y111').value = 'bajo' in riesgo
            ws_info_b.range('AB111').value = 'medio' in riesgo
            ws_info_b.range('AE111').value = 'alto' in riesgo





            tipo_torre = normaliza_texto(row.get('Tipo de Torre', ''))
            ws_info_c.range('G8').value = tipo_torre == 'autosoportada'
            ws_info_c.range('O8').value = tipo_torre == 'arriostrada'
            ws_info_c.range('V8').value = tipo_torre == 'Monopolo'
            ws_info_c.range('AB8').value = tipo_torre == 'Minipolo'
            ws_info_c.range('AG8').value = tipo_torre == 'otro'

            espacio_disponible = normaliza_texto(row.get('¬øEspacio disponible de conexi√≥n?', ''))
            ws_info_c.range('AH25').value = espacio_disponible == 'si'
            ws_info_c.range('AK25').value = espacio_disponible == 'no'
            ws_info_c.range('U14').value = espacio_disponible == 'si'
            ws_info_c.range('Y14').value = espacio_disponible == 'no'


            existe_break = normaliza_texto(row.get('¬øExiste algun breaker existente en sitio? ', ''))
            ws_info_c.range('Y21').value = existe_break == 'si'
            ws_info_c.range('AB21').value = existe_break == 'no'

        
            alimentacion_compatible = normaliza_texto(row.get('Alimentacion compatible con el equipamiento ', ''))
            print(f"*** DEBUG ALIMENTACI√ìN COMPATIBLE ***")
            print(f"   - Valor: '{alimentacion_compatible}'")
            set_checkbox(ws_info_c, 'Y25', alimentacion_compatible == 'si', "Alimentaci√≥n Compatible - S√≠")
            set_checkbox(ws_info_c, 'AB25', alimentacion_compatible == 'no', "Alimentaci√≥n Compatible - No")

            sistema_electrico_original = row.get('SISTEMA ELECTRICO', '')
            sistema_electrico = normaliza_texto(sistema_electrico_original)
            print(f"*** DEBUG SISTEMA EL√âCTRICO ***")
            print(f"   - Valor original: '{sistema_electrico_original}'")
            print(f"   - Valor normalizado: '{sistema_electrico}'")
            set_checkbox(ws_info_c, 'AG21', 'monofasica' in sistema_electrico, "Sistema El√©ctrico - Monof√°sica")
            set_checkbox(ws_info_c, 'AL21', 'bifasica' in sistema_electrico, "Sistema El√©ctrico - Bif√°sica")



            cara_propuesta = normaliza_texto(row.get('Cara de preparaci√≥n para cableado vertical en torre', ''))
            print(f"*** DEBUG CARA PROPUESTA ***")
            print(f"   - Valor: '{cara_propuesta}'")
            set_checkbox(ws_info_c, 'Y16', cara_propuesta == 'a', "Cara Propuesta - A")
            set_checkbox(ws_info_c, 'AC16', cara_propuesta == 'b', "Cara Propuesta - B")
            set_checkbox(ws_info_c, 'AE16', cara_propuesta == 'c', "Cara Propuesta - C")
            set_checkbox(ws_info_c, 'AN16', cara_propuesta == 'd', "Cara Propuesta - D")

            barra_tierra = normaliza_texto(row.get('Barra de Tierra', ''))
            print(f"*** DEBUG BARRA DE TIERRA ***")
            print(f"   - Valor: '{barra_tierra}'")
            set_checkbox(ws_info_c, 'O27', barra_tierra == 'si', "Barra de Tierra - S√≠")
            set_checkbox(ws_info_c, 'R27', barra_tierra == 'no', "Barra de Tierra - No")

            tipo_solucion = normaliza_texto(row.get('Tipo de Solucion', ''))
            print(f"*** DEBUG TIPO DE SOLUCI√ìN ***")
            print(f"   - Valor: '{tipo_solucion}'")
            set_checkbox(ws_info_c, 'O29', tipo_solucion == 'piso', "Tipo Soluci√≥n - Piso")
            set_checkbox(ws_info_c, 'R29', tipo_solucion == 'torre', "Tipo Soluci√≥n - Torre")



        
            tipo_torre2 = normaliza_texto(row.get('Tipo de Torre2', ''))
            ws_info_c.range('G32').value = tipo_torre2 == 'autosoportada'
            ws_info_c.range('O32').value = tipo_torre2 == 'arriostrada'
            ws_info_c.range('V32').value = tipo_torre2 == 'monopolo'
            ws_info_c.range('AB32').value = tipo_torre2 == 'minipolo'
            ws_info_c.range('AG32').value = tipo_torre2 == 'otro'

            espacio_disponible2 = normaliza_texto(row.get('¬øEspacio disponible de conexi√≥n?2', ''))
            ws_info_c.range('U38').value = espacio_disponible2 == 'si'
            ws_info_c.range('Y38').value = espacio_disponible2 == 'no'

            cara_preparacion2 = normaliza_texto(row.get('Cara de preparaci√≥n para cableado vertical en torre 2', ''))
            ws_info_c.range('Y40').value = cara_preparacion2 == 'a'
            ws_info_c.range('AD40').value = cara_preparacion2 == 'b'
            ws_info_c.range('AI40').value = cara_preparacion2 == 'c'
            ws_info_c.range('AN40').value = cara_preparacion2 == 'd'
        
            existe_tierra2 = normaliza_texto(row.get('Existe Barra de Tierras 2', ''))
            ws_info_c.range('O51').value = existe_tierra2 == 'si'
            ws_info_c.range('R51').value = existe_tierra2 == 'no'

            tipo_solucion2 = normaliza_texto(row.get('Tipo de solucion 2', ''))
            ws_info_c.range('O53').value = tipo_solucion2 == 'piso'
            ws_info_c.range('R53').value = tipo_solucion2 == 'torre'
        
            existe_break2 = normaliza_texto(row.get('Existe algun breaker existente en sitio 2 ', ''))
            ws_info_c.range('Y45').value = existe_break2 == 'si'
            ws_info_c.range('AB45').value = existe_break2 == 'no'

            alimenacion_existente2= normaliza_texto(row.get('SISTEMA ELECTRICO 2', ''))
            ws_info_c.range('AG45').value = 'monofasica' in alimenacion_existente2
            ws_info_c.range('AL45').value = 'bifasica' in alimenacion_existente2
        
            alimenacion_compatible2= normaliza_texto(row.get('Alimentacion compatible con el equipamiento 2', ''))
            ws_info_c.range('Y49').value = alimenacion_compatible2 == 'si'
            ws_info_c.range('AB49').value = alimenacion_compatible2 == 'no'

            espacio_conexion2= normaliza_texto(row.get('¬øEspacio disponible de conexi√≥n? 2', ''))
            ws_info_c.range('AH49').value = espacio_conexion2 == 'si'
            ws_info_c.range('AK49').value = espacio_conexion2 == 'no'

            linea_vista = normaliza_texto(row.get('Linea de vista ', ''))
            motivo = normaliza_texto(row.get('Motivo ', ''))

            ws_info_c.range('R56').value = (linea_vista == 'si')
            ws_info_c.range('V56').value = (linea_vista == 'no')
            ws_info_c.range('Q57').value = False
            ws_info_c.range('V57').value = False
            ws_info_c.range('AC57').value = False
            ws_info_c.range('AI57').value = False
            ws_info_c.range('C58').value = False

            if linea_vista == 'no':
               if motivo == 'arboles':
                  ws_info_c.range('Q57').value = True
               elif motivo == 'espectacular':
                  ws_info_c.range('V57').value = True
               elif motivo == 'edificio':
                  ws_info_c.range('AC57').value = True
               elif motivo == 'monta√±a':
                  ws_info_c.range('AI57').value = True
               elif motivo == 'n/a':
                  ws_info_c.range('C58').value = True

            
             # Llenado autom√°tico de celdas usando el diccionario de mapeo
            campos_a_celdas = {
                'Fecha Inicio Site Survey': 'G8',
                'Fecha final Site Survey': 'AF8',
                'NOMBRE DEL SITIO': 'J9', 
                'PROPIETARIO': 'M10',
                'ID': 'AF9',
                'ESTADO ':'AC15',
                'Calle': 'D14',
                'Colonia': 'D15',
                'Municipio': 'E16',
                'C.P': 'AC14',
                'Referencias':'J17',
                'Nombre de contacto en sitio': 'H19',
                'Telefono': 'AB19',
                'LATITUD (TORRE)': 'K30',
                'LONGITUD (TORRE)': 'AA30',
                'LATITUD (FACHADA)': 'K27',
                'LONGITUD (FACHADA)': 'AA27',
                'Altitud (msnm)': 'M31',
                'Horario de solicitud de accesos': 'Q50',
                'Contacto solicitud de accesos': 'B52',
                'Como o donde obtener permisos/llave/tarjeta': 'O49',
                'Comentario:Forma de ingresar el equipo al sitio es con:': 'B57',
                'comentario:En caso de requerirse gr√∫a, identifique si es factible el uso de la misma y que no se tenga una posible obstrucci√≥n.': 'B63',
                'Si la respuesta anterior es si, Indique a que distancia ':'AD72'
            }
            for campo, celdas in campos_a_celdas.items():
                valor_raw = row.get(campo, "")
                valor = normaliza_na(valor_raw)
                if campo == 'comentario:En caso de requerirse gr√∫a, identifique si es factible el uso de la misma y que no se tenga una posible obstrucci√≥n.':
                    print(f"Valor para {campo}: '{valor}' (celda {celdas})")
                if isinstance(celdas, list):
                    for celda in celdas:
                        ws_info_a.range(celda).value = valor
                else:
                    ws_info_a.range(celdas).value = valor

            campos_b_celdas = {
                'Fecha Inicio Site Survey B': 'G8',
                'Fecha final Site Survey B': 'AF8',
                'Nombre del sitio 2': 'J9', 
                'PROPIETARIO 2': 'M10',
                'ID 2': 'AF9',
                'ESTADO 2 ':'AC15',
                'Calle 2': 'D14',
                'Colonia 2': 'D15',
                'Municipio 2': 'E16',
                'C.P 2': 'AC14',
                'Referencias 2':'J17',
                'Nombre de contacto en sitio 2': 'H19',
                'Telefono 2': 'AB19',
                'LATITUD (TORRE) 2': 'K30',
                'LONGITUD (TORRE) 2': 'AA30',
                'LATITUD (FACHADA) 2': 'K27',
                'LONGITUD (FACHADA) 2': 'AA27',
                'Altitud (msnm) 2': 'M31',
                'Horario de solicitud de accesos B': 'Q50',
                'Contacto solicitud de accesos B': 'B52',
                'Como o donde obtener permisos/llave/tarjeta B': 'O49',
                'Comentario:Forma de ingresar el equipo al sitio es con: B': 'B57',
                'comentario:En caso de requerirse gr√∫a, identifique si es factible el uso de la misma y que no se tenga una posible obstrucci√≥n.': 'B63',
                'Si la respuesta anterior es si, Indique a que distancia B':'AD72'
            }
            for campo, celdas in campos_b_celdas.items():
                valor_raw = row.get(campo, "")
                valor = normaliza_na(valor_raw)
                if campo == 'comentario:En caso de requerirse gr√∫a, identifique si es factible el uso de la misma y que no se tenga una posible obstrucci√≥n.':
                   print(f"Valor para {campo}: '{valor}' (celda {celdas})")
                if isinstance(celdas, list):
                    for celda in celdas:
                        ws_info_b.range(celda).value = valor
                else:
                    ws_info_b.range(celdas).value = valor    

            campos_c_celdas = {
            'NOMBRE DEL SITIO': 'G7',
            'Diametro de pierna superior':'K9',
            'Diametro de pierna Inferior':'U9',
            'NCRA RB':'AC9',
            'Franja2RB':'AM9',
            'Altura de la Torre':'K10',
            'Dado':'U10',
            'Altura Edificio1':'AE10',
            'Nivel inferior de franja disponible': 'T11',
            'Nivel superior de franja disponible': 'AK11',
            'Altura de MW conforme a topologia': 'B14',
            'Azimut RB ': 'M14',
            'Propuesta de altura de antena de MW1': 'AB14',
            'Propuesta de altura de antena de MW (SD)1': 'AJ14',
            'Altura de soporte para OMB propuesto': 'O19',
            'Longitud del cable de tierra nuevo OMB': 'O20',
            'Longitud del cable de tierra ODU': 'O21',
            'Longitud de cable IF': 'O22',
            'Tipo de soporte para antena MW propuesto': 'O23',
            'Longitud de cable ACDB-Nuevo OMB': 'O24',
            'Longitud de cable RTN - Router':'O25',
            'Longitud de cable RTN - BBU SITE 1': 'O26',
            'MEDICION DE BARRA DE TIERRA (Ohms)':'O28',
            'Nombre del sitio 2': 'G31',
            'Di√°metro de Pierna superio2':'K33',
            'Di√°metro de Pierna inferior2':'U33',
            ' NCRA2 ':'AC33',
            'Franja2-2':'AM33',
            'Altura torre 2': 'K34',
            'DADO 2':'U34',
            'Altura edificio 2':'AE34',
            'Nivel inferior de franja disponible 2': 'T35',
            'Nivel superior de franja disponible 2': 'AK35',
            'Altura de MW conforme a topologia 2': 'B38',
            'Azimut 2': 'M38',
            'Propuesta de altura de antena de MW2': 'AB38',
            'Propuesta de altura de antena de MW (SD)2':'AJ38',
            'Altura de soporte para OMB propuesto2':'O43',
            'Longitud del cable de tierra nuevo OMB 2': 'O44',
            'Longitud del cable de tierra ODU 2': 'O45',
            'Longitud de cable IF 2': 'O46',
            'Tipo de soporte para antena MW propuesto 2': 'O47',
            'Longitud de cable ACDB-Nuevo OMB 2': 'O48',
            'Longitud de cable RTN - Router 2': 'O49',
            'Longitud de cable RTN - BBU 2': 'O50',
            'Medici√≥n del Sistema de Tierras 2': 'O52',
         


            }
            for campo, celdas in campos_c_celdas.items():
                valor_raw = row.get(campo, "")
                valor = normaliza_na(valor_raw)
                print(f"ws_info_c: Escribiendo en {celdas} el valor '{valor}' para campo '{campo}' (original: {valor_raw}, tipo: {type(valor_raw)})")
                if isinstance(celdas, list):
                    for celda in celdas:
                        ws_info_c.range(celda).value = valor
                else:
                    ws_info_c.range(celdas).value = valor   

            # GUARDAR ARCHIVO CON MANEJO ROBUSTO DE EXCEL
            try:
                print('DEBUG: Intentando guardar archivo...')
                
                # RESUMEN FINAL DE VELOCIDAD
                total_time = time.time() - start_time
                final_speed = cells_processed / total_time if total_time > 0 else 0
                print(f"üèÅ RESUMEN FINAL DE OPTIMIZACI√ìN:")
                print(f"   - Tiempo total: {total_time:.2f} segundos")
                print(f"   - Celdas procesadas: {cells_processed}")
                print(f"   - Velocidad promedio: {final_speed:.1f} celdas/segundo")
                print(f"   - Optimizaci√≥n vs. m√©todo anterior: {final_speed/5:.1f}x m√°s r√°pido")
                
                # RESTAURAR CONFIGURACIONES DE EXCEL ANTES DE CERRAR
                print('DEBUG: Restaurando configuraciones de Excel...')
                restore_excel_settings(app_excel)
                
                # Cerrar Excel antes de guardar para evitar conflictos
                wb.close()
                time.sleep(1)
                
                # Cerrar la aplicaci√≥n de Excel
                if app_excel:
                    app_excel.quit()
                    time.sleep(1)
                
                # Copiar la plantilla directamente en lugar de usar xlwings
                import shutil
                shutil.copy2(plantilla_path, output_path)
                
                print(f'DEBUG: Archivo generado exitosamente: {output_path}')
                
                # Limpiar procesos de Excel de forma m√°s agresiva
                try:
                    if os.name == 'nt':  # Solo en Windows
                        subprocess.run(['taskkill', '/f', '/im', 'excel.exe'], capture_output=True)
                        subprocess.run(['taskkill', '/f', '/im', 'WINWORD.EXE'], capture_output=True)
                        print('DEBUG: Procesos de Office cerrados completamente')
                        time.sleep(2)
                except Exception as cleanup_error:
                    print(f'DEBUG: Error en limpieza de procesos: {cleanup_error}')
                
                return redirect(url_for('site_survey', user_id=user_id, fila_idx=fila_idx))
                
            except Exception as save_error:
                print(f"ERROR guardando archivo: {save_error}")
                
                # Limpiar recursos en caso de error
                try:
                    wb.close()
                except:
                    pass
                try:
                    if app_excel:
                        app_excel.quit()
                except:
                    pass
                
                # Limpiar procesos de Excel de forma agresiva
                try:
                    if os.name == 'nt':
                        subprocess.run(['taskkill', '/f', '/im', 'excel.exe'], capture_output=True)
                        subprocess.run(['taskkill', '/f', '/im', 'WINWORD.EXE'], capture_output=True)
                        time.sleep(2)
                except:
                    pass
                
                return f"Error guardando archivo: {str(save_error)}"
                
        except Exception as e:
            print(f"ERROR en llenado site_survey: {e}")
            
            # Limpiar recursos en caso de error general
            try:
                if 'wb' in locals():
                    wb.close()
            except:
                pass
            try:
                if 'app_excel' in locals() and app_excel:
                    app_excel.quit()
            except:
                pass
            
            # Limpiar procesos de Excel de forma agresiva
            try:
                if os.name == 'nt':
                    subprocess.run(['taskkill', '/f', '/im', 'excel.exe'], capture_output=True)
                    subprocess.run(['taskkill', '/f', '/im', 'WINWORD.EXE'], capture_output=True)
                    time.sleep(2)
            except:
                pass
            
            return f"Error en llenado site_survey: {e}"
    elif tipo_str == 'reporte_planeacion':
        print('DEBUG: Entrando a bloque reporte_planeacion')
        return redirect(url_for('reporte_planeacion', user_id=user_id, fila_idx=fila_idx))
    elif tipo_str == 'diseno_solucion':
        print('DEBUG: Entrando a bloque diseno_solucion')
        # Limpiar procesos de Excel antes de redirigir
        try:
            import subprocess
            subprocess.run(['taskkill', '/f', '/im', 'excel.exe'], capture_output=True)
            print('DEBUG: Procesos de Excel cerrados antes de dise√±o de soluci√≥n')
            import time
            time.sleep(1)
        except:
            print('DEBUG: No se pudieron cerrar procesos de Excel')
        return redirect(url_for('formulario_archivos', user_id=user_id, fila_idx=fila_idx))
    elif tipo_str == 'ptmp_site_survey':
        try:
            print('DEBUG: Entrando a bloque ptmp_site_survey')
            print(f'DEBUG: user_id = {user_id}, fila_idx = {fila_idx}')
            # --- BLOQUE DE LLENADO DE SITE SURVEY PtMP ---
            # IMPORTANTE: Esta funci√≥n usa la plantilla 'EJEMPLO SS PtMP VACIO.xlsx' para generar
            # un archivo de Site Survey PtMP (encuesta del sitio), NO de dise√±o de soluci√≥n
            import pandas as pd
            import xlwings as xw
            import os, re

            print('DEBUG: Leyendo CSV de Google Sheets...')
            df_db = pd.read_csv(GOOGLE_SHEETS_CSV_URL)
            print(f'DEBUG: CSV le√≠do, fila_idx = {fila_idx}')
            row = df_db.loc[int(fila_idx)]
            print('DEBUG: Fila obtenida correctamente')
            print(f'DEBUG: Campos disponibles en la fila: {list(row.index)}')
            
            # Buscar campos relacionados con altura de edificio
            campos_altura = [campo for campo in row.index if 'altura' in campo.lower() and 'edificio' in campo.lower()]
            print(f'DEBUG: Campos de altura de edificio encontrados: {campos_altura}')
            
            # Verificar el valor exacto del campo Altura Edificio1
            if 'Altura Edificio1' in row:
                valor_altura_edificio1 = row['Altura Edificio1']
                print(f'DEBUG: Valor directo de Altura Edificio1: "{valor_altura_edificio1}" (tipo: {type(valor_altura_edificio1)})')
            else:
                print(f'DEBUG: Campo "Altura Edificio1" NO encontrado en la fila')
                # Buscar variaciones del nombre
                for campo in row.index:
                    if 'altura' in campo.lower() and 'edificio' in campo.lower() and '1' in campo:
                        print(f'DEBUG: Posible variaci√≥n encontrada: "{campo}" = "{row[campo]}"')
            
            nombre_a = row.get('Nombre del sitio A', '') if 'Nombre del sitio A' in row else ''
            nombre_b = row.get('Nombre del sitio B', '') if 'Nombre del sitio B' in row else ''
            print(f'DEBUG: nombre_a = {nombre_a}, nombre_b = {nombre_b}')

            # Usar ruta relativa para que funcione en cualquier computadora
            import os
            base_dir = os.path.dirname(os.path.abspath(__file__))
            plantilla_path = os.path.join(base_dir, 'ptmp_site_survey', 'EJEMPLO SS PtMP VACIO.xlsx')
            user_id_limpio = re.sub(r'[^a-zA-Z0-9_-]', '', str(user_id))
            output_path = os.path.join(base_dir, 'ptmp_site_survey', f'ss_ptmp_{user_id_limpio}.xlsx')
            print(f'DEBUG: plantilla_path = {plantilla_path}')
            print(f'DEBUG: output_path = {output_path}')
            print(f'DEBUG: ¬øExiste plantilla? {os.path.exists(plantilla_path)}')

            print('DEBUG: Intentando iniciar Excel para PtMP...')
            
            # Solo cerrar procesos de Excel si es necesario (evitar en entornos remotos)
            try:
                # Verificar si estamos en un entorno local
                if os.name == 'nt':  # Solo en Windows
                 subprocess.run(['taskkill', '/f', '/im', 'excel.exe'], capture_output=True)
                 print('DEBUG: Procesos de Excel cerrados')
                 time.sleep(1)
                else:
                    print('DEBUG: No es Windows, saltando cierre de procesos Excel')
            except:
                print('DEBUG: No se pudieron cerrar procesos de Excel')
            
            # Solo abrir Excel si es necesario
            app_excel = None
            try:
                app_excel = xw.App(visible=False)
                print('DEBUG: Excel iniciado correctamente')
            except Exception as excel_error:
                print(f'DEBUG: Error iniciando Excel: {excel_error}')
                return f'Error iniciando Excel: {str(excel_error)}'
                print('DEBUG: Excel iniciado, intentando abrir plantilla PtMP...')
            
            # Verificar si el archivo est√° siendo usado
            import time
            max_attempts = 3
            for attempt in range(max_attempts):
                try:
                    print(f'DEBUG: Intento {attempt + 1} de abrir plantilla...')
                    wb = app_excel.books.open(plantilla_path)
                    print('DEBUG: Plantilla PtMP abierta correctamente')
                    break
                except Exception as excel_error:
                    print(f'DEBUG: Error en intento {attempt + 1}: {excel_error}')
                    if attempt < max_attempts - 1:
                        print('DEBUG: Esperando 2 segundos antes del siguiente intento...')
                        time.sleep(2)
                    else:
                        print('DEBUG: Todos los intentos fallaron')
                        app_excel.quit()
                        raise excel_error
            
            # Obtener las hojas de trabajo espec√≠ficas para PtMP
            print('DEBUG: Obteniendo hojas de trabajo...')
            try:
                ws_caratula = wb.sheets['0. Car√°tula']
                print('DEBUG: Hoja Car√°tula obtenida')
                ws_sector = wb.sheets['1. Informaci√≥n General SECTOR']
                print('DEBUG: Hoja SECTOR obtenida')
                ws_cpe = wb.sheets['2. Informaci√≥n General CPE']
                print('DEBUG: Hoja CPE obtenida')
                ws_espacios = wb.sheets['3. Espacios en Torre y Piso A-B']
                print('DEBUG: Hoja Espacios obtenida')
                ws_planos_a = wb.sheets['4. Planos A']
                print('DEBUG: Hoja Planos A obtenida')
                ws_planos_b = wb.sheets['5. Planos B']
                print('DEBUG: Hoja Planos B obtenida')
            except Exception as sheet_error:
                print(f'DEBUG: Error al obtener hojas: {sheet_error}')
                print(f'DEBUG: Hojas disponibles: {[sheet.name for sheet in wb.sheets]}')
                wb.close()
                app_excel.quit()
                raise sheet_error
            
            # Llenar nombre en car√°tula
            print('DEBUG: Llenando car√°tula...')
            ws_caratula.range('A37').value = f"{nombre_a} - {nombre_b}"
            print('DEBUG: Car√°tula llenada correctamente')

            # Llenado de los checkboxes y campos para PtMP
            ws_sector.range('B63').value = 'N/A'
            
            # Tipo de Zona - SECTOR
            tipo_zona_original = row.get('Tipo de Zona', '')
            tipo_zona = normaliza_texto(tipo_zona_original)
            # TODO: Agregar coordenadas correctas para PtMP
            ws_sector.range('C22').value = 'urbana' in tipo_zona
            ws_sector.range('D21').value = 'suburbana' in tipo_zona
            ws_sector.range('E21').value = 'rural' in tipo_zona
            ws_sector.range('F21').value = 'ejidal' in tipo_zona
            ws_sector.range('H22').value = 'pueblomagico' in tipo_zona
            
            # T√≠tulo del documento PtMP
            
            # Visibilidad del sitio - SECTOR
            tipo_visible_original = row.get('El sitio es visible de d√≠a y de noche (libre de maleza y arboles): ', '')
            tipo_visible = normaliza_texto(tipo_visible_original)
            # TODO: Agregar coordenadas correctas para PtMP
            ws_sector.range('E23').value = 'si' in tipo_visible
            ws_sector.range('G21').value = 'no' in tipo_visible
            
            # Tipo de Camino - SECTOR
            tipo_camino_original = row.get('Tipo de Camino', '')
            tipo_camino = normaliza_texto(tipo_camino_original)
            # TODO: Agregar coordenadas correctas para PtMP
            ws_sector.range('B25').value = 'terraceria' in tipo_camino
            ws_sector.range('D25').value = 'pavimentado' in tipo_camino
            ws_sector.range('F25').value = 'empedrado' in tipo_camino
            ws_sector.range('H25').value = 'mixto' in tipo_camino

            # Tipo de Zona - CPE
            tipo_zona_original = row.get('Tipo de Zona 2', '')
            tipo_zona = normaliza_texto(tipo_zona_original)
            # TODO: Agregar coordenadas correctas para PtMP
            ws_cpe.range('C22').value = 'urbana' in tipo_zona
            ws_cpe.range('D21').value = 'suburbana' in tipo_zona
            ws_cpe.range('F21').value = 'rural' in tipo_zona
            ws_cpe.range('G21').value = 'ejidal' in tipo_zona
            ws_cpe.range('H21').value = 'pueblomagico' in tipo_zona
            
            # Visibilidad del sitio - CPE
            tipo_visible_original = row.get('El sitio es visible de d√≠a y de noche (libre de maleza y arboles): 2', '')
            tipo_visible = normaliza_texto(tipo_visible_original)
            # TODO: Agregar coordenadas correctas para PtMP
            ws_cpe.range('E23').value = 'si' in tipo_visible
            ws_cpe.range('F20').value = 'no' in tipo_visible
            
            # Tipo de Camino - CPE
            tipo_camino_original = row.get(' Tipo de Camino 2 ', '')
            tipo_camino = normaliza_texto(tipo_camino_original)
            # TODO: Agregar coordenadas correctas para PtMP
            ws_cpe.range('B25').value = 'terraceria' in tipo_camino
            ws_cpe.range('D25').value = 'pavimentado' in tipo_camino
            ws_cpe.range('F25').value = 'empedrado' in tipo_camino
            ws_cpe.range('H25').value = 'mixto' in tipo_camino

            # Propietario/Administrador - SECTOR
            tipo_Propietario_Administrador_original = row.get('Propietario_Administrador', '')
            tipo_Propietario_Administrador = normaliza_texto(tipo_Propietario_Administrador_original)
            # TODO: Agregar coordenadas correctas para PtMP
            ws_sector.range('A34').value = 'telesite' in tipo_Propietario_Administrador
            ws_sector.range('D36').value = 'ctwr' in tipo_Propietario_Administrador
            ws_sector.range('E34').value = 'mtp' in tipo_Propietario_Administrador
            ws_sector.range('G36').value = 'intelesites' in tipo_Propietario_Administrador
            ws_sector.range('H34').value = 'even' in tipo_Propietario_Administrador
            ws_sector.range('A37').value = 'atc' in tipo_Propietario_Administrador
            ws_sector.range('B38').value = 'temm' in tipo_Propietario_Administrador
            ws_sector.range('C38').value = 'renta tower' in tipo_Propietario_Administrador
            ws_sector.range('E38').value = 'torrecom' in tipo_Propietario_Administrador
            ws_sector.range('F38').value = 'uniti' in tipo_Propietario_Administrador
            ws_sector.range('A40').value = 'tower one' in tipo_Propietario_Administrador
            ws_sector.range('B40').value = 'iimt' in tipo_Propietario_Administrador
            ws_sector.range('C40').value = 'servicom' in tipo_Propietario_Administrador
            ws_sector.range('A42').value = 'canadian tower' in tipo_Propietario_Administrador
            ws_sector.range('B42').value = 'mx tower' in tipo_Propietario_Administrador
            ws_sector.range('C42').value = 'cfe' in tipo_Propietario_Administrador

            # Propietario/Administrador - CPE
            tipo_Propietario_Administrador_original = row.get('Propietario_Administrador B', '')
            tipo_Propietario_Administrador = normaliza_texto(tipo_Propietario_Administrador_original)
            # TODO: Agregar coordenadas correctas para PtMP
            ws_cpe.range('B37').value = 'banbien' in tipo_Propietario_Administrador
            ws_cpe.range('C37').value = 'sepomex' in tipo_Propietario_Administrador
            ws_cpe.range('D37').value = 'cac cfe' in tipo_Propietario_Administrador
            ws_cpe.range('E37').value = 'telecom' in tipo_Propietario_Administrador
            ws_cpe.range('F37').value = 'ubbj' in tipo_Propietario_Administrador
            ws_cpe.range('F38').value = 'sedena' in tipo_Propietario_Administrador
            ws_cpe.range('G38').value = 'cuartel guardia nacional' in tipo_Propietario_Administrador
            ws_cpe.range('A39').value = 'unidad medico rural' in tipo_Propietario_Administrador
            ws_cpe.range('B39').value = 'hospital rural' in tipo_Propietario_Administrador
            ws_cpe.range('C39').value = 'centro de salud' in tipo_Propietario_Administrador
            ws_cpe.range('A41').value = 'unidad medico familiar' in tipo_Propietario_Administrador
            ws_cpe.range('B41').value = 'telesecundaria' in tipo_Propietario_Administrador
            # ws_cpe.range('').value = 'servicom' in tipo_Propietario_Administrador
            # ws_cpe.range('').value = 'canadian tower' in tipo_Propietario_Administrador
            # ws_cpe.range('').value = 'mx tower' in tipo_Propietario_Administrador
            # ws_cpe.range('').value = 'cfe' in tipo_Propietario_Administrador

            # Tipo de sitio - SECTOR
            tipo_tipositio_original = normaliza_texto(row.get('Tipo de sitio', ''))
            tipo_tipositio = normaliza_texto(tipo_tipositio_original)
            print(f"Tipo de sitio original: '{tipo_tipositio_original}'")
            print(f"Tipo de sitio normalizado: '{tipo_tipositio}'")
            print(f"¬øContiene 'terrenogreenfield'? {'terrenogreenfield' in tipo_tipositio}")
            print(f"¬øContiene 'sobresuelorawland'? {'sobresuelorawland' in tipo_tipositio}")
            # TODO: Agregar coordenadas correctas para PtMP
            ws_sector.range('A45').value = 'terrenogreenfield' in tipo_tipositio
            ws_sector.range('C45').value = 'sobresuelorawland' in tipo_tipositio
            ws_sector.range('E45').value = 'sobreazotea' in tipo_tipositio

            # Tipo de sitio - CPE
            tipo_tipositio_original = normaliza_texto(row.get('Tipo de sitio B', ''))
            tipo_tipositio = normaliza_texto(tipo_tipositio_original)
            print(f"Tipo de sitio original: '{tipo_tipositio_original}'")
            print(f"Tipo de sitio normalizado: '{tipo_tipositio}'")
            print(f"¬øContiene 'terrenogreenfield'? {'terrenogreenfield' in tipo_tipositio}")
            print(f"¬øContiene 'sobresuelorawland'? {'sobresuelorawland' in tipo_tipositio}")
            # TODO: Agregar coordenadas correctas para PtMP
            ws_cpe.range('A44').value = 'terrenogreenfield' in tipo_tipositio
            ws_cpe.range('C44').value = 'sobresuelorawland' in tipo_tipositio
            ws_cpe.range('E44').value = 'sobreazotea' in tipo_tipositio

            # Riesgo - SECTOR
            tipo_riesgo_original = normaliza_texto(row.get('Riesgo', ''))
            tipo_riesgo = normaliza_texto(tipo_riesgo_original)
            # TODO: Agregar coordenadas correctas para PtMP
            ws_sector.range('F46').value = 'delitocomunroboatranseuntes' in tipo_riesgo
            ws_sector.range('C46').value = 'inconformidadvecinalconbloqueo' in tipo_riesgo
            ws_sector.range('G47').value = 'delincuenciaorganizada' in tipo_riesgo

            # Riesgo - CPE
            tipo_riesgo_original = normaliza_texto(row.get('Riesgo B', ''))
            tipo_riesgo = normaliza_texto(tipo_riesgo_original)
            # TODO: Agregar coordenadas correctas para PtMP
            ws_cpe.range('F45').value = 'delitocomunroboatranseuntes' in tipo_riesgo
            ws_cpe.range('C45').value = 'inconformidadvecinalconbloqueo' in tipo_riesgo
            ws_cpe.range('G46').value = 'delincuenciaorganizada' in tipo_riesgo

            # Accesibilidad - SECTOR
            tipo_considera_accesible_original = normaliza_texto(row.get('Considera accesible el sitio de d√≠a y de noche?', ''))
            tipo_considera_accesible = normaliza_texto(tipo_considera_accesible_original)
            # TODO: Agregar coordenadas correctas para PtMP
            ws_sector.range('C48').value = 'solodedia' in tipo_considera_accesible
            ws_sector.range('D48').value = 'solodenoche' in tipo_considera_accesible
            ws_sector.range('F47').value = 'sinproblemadehora' in tipo_considera_accesible

            # Accesibilidad - CPE
            tipo_considera_accesible_original = normaliza_texto(row.get('Considera accesible el sitio de d√≠a y de noche? B', ''))
            tipo_considera_accesible = normaliza_texto(tipo_considera_accesible_original)
            # TODO: Agregar coordenadas correctas para PtMP
            ws_cpe.range('C47').value = 'solodedia' in tipo_considera_accesible
            ws_cpe.range('D47').value = 'solodenoche' in tipo_considera_accesible
            ws_cpe.range('F48').value = 'sinproblemadehora' in tipo_considera_accesible

            # Zona segura - SECTOR
            tipo_zonasegura_original = (row.get('El sitio se encuentra construido en zona segura (De NO derrumbes):', ''))
            tipo_zonasegura = normaliza_texto(tipo_zonasegura_original)
            # TODO: Agregar coordenadas correctas para PtMP
            ws_sector.range('G50').value = 'si' in tipo_zonasegura
            ws_sector.range('H50').value = 'no' in tipo_zonasegura

            # Zona segura - CPE
            tipo_zonasegura_original = (row.get('El sitio se encuentra construido en zona segura (De NO derrumbes) B:', ''))
            tipo_zonasegura = normaliza_texto(tipo_zonasegura_original)
            # TODO: Agregar coordenadas correctas para PtMP
            ws_cpe.range('G49').value = 'si' in tipo_zonasegura
            ws_cpe.range('H49').value = 'no' in tipo_zonasegura

            # Horario controlado - SECTOR
            tipo_horariocontrolado_original = normaliza_texto(row.get('Horario Controlado', ''))
            tipo_horariocontrolado = normaliza_texto(tipo_horariocontrolado_original)
            # TODO: Agregar coordenadas correctas para PtMP
            ws_sector.range('B55').value = 'si' in tipo_horariocontrolado

            # Horario controlado - CPE
            tipo_horariocontrolado_original = normaliza_texto(row.get('Horario Controlado B', ''))
            tipo_horariocontrolado = normaliza_texto(tipo_horariocontrolado_original)
            # TODO: Agregar coordenadas correctas para PtMP
            ws_cpe.range('B54').value = 'si' in tipo_horariocontrolado




            # Acceso al Personal
            acceso_personal_original = normaliza_texto(row.get('TIPO DE ACCESO A SITIO', ''))
            acceso_personal = normaliza_texto(acceso_personal_original)

            ws_info_a.range('B47').value = 'llave' in acceso_personal
            ws_info_a.range('H47').value = 'permiso/memorandum' in acceso_personal
            ws_info_a.range('R47').value = 'candadodecombinacion' in acceso_personal
            ws_info_a.range('B48').value = 'tarjetaelectronica' in acceso_personal
            ws_info_a.range('J48').value = 'otro' in acceso_personal


            # Campos vinculados
            if 'candadodecombinacion' in acceso_personal:
                ws_info_a.range('AF47').value = row.get('Candado de Combinaci√≥n', '')
                ws_info_a.range('Q48').value = 'N/A'
            elif ('llave' in acceso_personal or 'permiso/memorandum' in acceso_personal or 'tarjetaelectronica' in acceso_personal):
                ws_info_a.range('Q49').value = row.get('D√≥nde recoger llave/permiso/tarjeta', '')

            tipo_formaingresar_original = normaliza_texto(row.get('Forma de ingresar el equipo al sitio es con:', ''))
            tipo_formaingresar = normaliza_texto(tipo_formaingresar_original)
            ws_info_a.range('U55').value = 'maniobra' in tipo_formaingresar
            ws_info_a.range('AA55').value = 'izajecongarrucha' in tipo_formaingresar
            ws_info_a.range('AG55').value = 'izajecongrua' in tipo_formaingresar

            tipo_formaingresar_original = normaliza_texto(row.get('Forma de ingresar el equipo al sitio es con: B', ''))
            tipo_formaingresar = normaliza_texto(tipo_formaingresar_original)
            ws_info_b.range('U55').value = 'maniobra' in tipo_formaingresar
            ws_info_b.range('AA55').value = 'izajecongarrucha' in tipo_formaingresar
            ws_info_b.range('AG55').value = 'izajecongrua' in tipo_formaingresar


            tipo_requerir_grua_original = normaliza_texto(row.get('Para instalaci√≥n de gr√∫a, considera necesario que se requiera tramitar permiso con las autoridades locales:', ''))
            tipo_requerir_grua = normaliza_texto(tipo_requerir_grua_original)
            print(f"tipo_requerir_grua original: '{tipo_requerir_grua_original}'")
            print(f"tipo_requerir_grua normalizado: '{tipo_requerir_grua}'")
            ws_info_a.range('AB67').value = 'requieregrua' in tipo_requerir_grua
            ws_info_a.range('AG67').value = 'noaplicagrua' in tipo_requerir_grua



            tipo_requerir_grua_original = normaliza_texto(row.get('Para instalaci√≥n de gr√∫a, considera necesario que se requiera tramitar permiso con las autoridades locales: B', ''))
            tipo_requerir_grua = normaliza_texto(tipo_requerir_grua_original)
            print(f"tipo_requerir_grua original: '{tipo_requerir_grua_original}'")
            print(f"tipo_requerir_grua normalizado: '{tipo_requerir_grua}'")
            ws_info_b.range('AB67').value = 'requieregrua' in tipo_requerir_grua
            ws_info_b.range('AG67').value = 'noaplicagrua' in tipo_requerir_grua

            acceso_personal_original = normaliza_texto(row.get('TIPO DE ACCESO A SITIO B', ''))
            acceso_personal = normaliza_texto(acceso_personal_original)

            ws_info_a.range('B47').value = 'llave' in acceso_personal
            ws_info_a.range('H47').value = 'permiso/memorandum' in acceso_personal
            ws_info_a.range('R47').value = 'candadodecombinacion' in acceso_personal
            ws_info_a.range('B48').value = 'tarjetaelectronica' in acceso_personal
            ws_info_a.range('J48').value = 'otro' in acceso_personal


                    # Campos vinculados
            if 'candadodecombinacion' in acceso_personal:
                ws_info_b.range('AF47').value = row.get('Candado de Combinaci√≥n B', '')
                ws_info_b.range('Q48').value = 'N/A'
            elif ('llave' in acceso_personal or 'permiso/memorandum' in acceso_personal or 'tarjetaelectronica' in acceso_personal):
                ws_info_b.range('Q49').value = row.get('D√≥nde recoger llave/permiso/tarjeta B', '')




            tipo_requiere_grua_original = normaliza_texto(row.get('Requiere Grua (Si / No)', ''))
            tipo_requiere_grua = normaliza_texto(tipo_requiere_grua_original)
            ws_info_a.range('AC66').value = 'si' in tipo_requiere_grua
            ws_info_a.range('AF66').value = 'no' in tipo_requiere_grua

            tipo_requiere_grua_original = normaliza_texto(row.get('Requiere Grua (Si / No) B', ''))
            tipo_requiere_grua = normaliza_texto(tipo_requiere_grua_original)
            ws_info_b.range('AC66').value = 'si' in tipo_requiere_grua
            ws_info_b.range('AF66').value = 'no' in tipo_requiere_grua

            tipo_llegar_original = normaliza_texto(row.get('Para la llegada al sitio con el equipo a instalar, se requiere de:', ''))
            # Separa por coma y normaliza solo el primer valor
            primer_valor = tipo_llegar_original.split(',')[0].strip() if ',' in tipo_llegar_original else tipo_llegar_original.strip()
            primer_tipo = normaliza_texto(primer_valor)
            print(f"primer_valor: '{primer_valor}'")
            print(f"primer_tipo normalizado: '{primer_tipo}'")
            ws_info_a.range('B72').value = (primer_tipo == 'pickup')
            ws_info_a.range('G72').value = (primer_tipo == 'pickup4x4')
            ws_info_a.range('M72').value = (primer_tipo == 'animalesdecarga')


            tipo_llegar_original = normaliza_texto(row.get('Para la llegada al sitio con el equipo a instalar, se requiere de:', ''))
            # Separa por coma y normaliza solo el primer valor
            primer_valor = tipo_llegar_original.split(',')[0].strip() if ',' in tipo_llegar_original else tipo_llegar_original.strip()
            primer_tipo = normaliza_texto(primer_valor)
            print(f"primer_valor: '{primer_valor}'")
            print(f"primer_tipo normalizado: '{primer_tipo}'")
            ws_info_b.range('B72').value = (primer_tipo == 'pickup')
            ws_info_b.range('G72').value = (primer_tipo == 'pickup4x4')
            ws_info_b.range('M72').value = (primer_tipo == 'animalesdecarga')


            policia_original = normaliza_texto(row.get('Existe cerca del sitio alguna comandancia de polic√≠a o del ejercito?', '').strip().lower())
            ws_info_a.range('AB105').value = 'si' in policia_original
            ws_info_a.range('AE105').value = 'no' in policia_original

            if 'si' in policia_original:
                ws_info_a.range('U106').value = row.get('Si la respuesta anterior es si, Indique a que distancia  policia',) 
                ws_info_a.range('U107').value = row.get('Se cuenta con alg√∫n n√∫mero de tel√©fono?, ind√≠quelo', 'N/A') or 'N/A'
            else:
                ws_info_a.range('U106').value = 'N/A'
                ws_info_a.range('U107').value = 'N/A'

    # --- Cruz Roja, Hospital, asistencia m√©dica ---
            cruzroja_original = normaliza_texto(row.get('Existe Cruz Roja, Hospital u otro tipo de asistencia medica cerca del sitio.', '').strip().lower())
            ws_info_a.range('AB108').value = 'si' in cruzroja_original
            ws_info_a.range('AE108').value = 'no' in cruzroja_original

            if 'si' in cruzroja_original:
                ws_info_a.range('U109').value = row.get('Si la respuesta anterior es si, Indique a que distancia cruz ', )  
                ws_info_a.range('U110').value = row.get('Se cuenta con alg√∫n numero de tel√©fono?, ind√≠quelo: cruz', )
            else:
                ws_info_a.range('U109').value = 'N/A'
                ws_info_a.range('U110').value = 'N/A'

          # --- Mapa Nacional de Riesgos ---
            riesgo = normaliza_texto(row.get('Seg√∫n el Mapa Nacional de Riesgos, indique en que zona se ubica el sitio:', '').strip().lower())
            ws_info_a.range('Y111').value = 'bajo' in riesgo
            ws_info_a.range('AB111').value = 'medio' in riesgo
            ws_info_a.range('AE111').value = 'alto' in riesgo



            policia_original = normaliza_texto(row.get('Existe cerca del sitio alguna comandancia de polic√≠a o del ejercito? B', ''))
            ws_info_b.range('AB105').value = 'si' in policia_original
            ws_info_b.range('AE105').value = 'no' in policia_original

            if 'si' in policia_original:
                ws_info_b.range('U106').value = row.get('Si la respuesta anterior es si, Indique a que distancia  policia B',) 
                ws_info_b.range('U107').value = row.get('Se cuenta con alg√∫n numero de tel√©fono?, ind√≠quelo: B',) 
            else:
                ws_info_b.range('U106').value = 'N/A'
                ws_info_b.range('U107').value = 'N/A'

            # --- Cruz Roja, Hospital, asistencia m√©dica ---
            cruzroja_original = normaliza_texto(row.get('Existe Cruz Roja, Hospital u otro tipo de asistencia medica cerca del sitio. B', ''))
            ws_info_b.range('AB108').value = 'si' in cruzroja_original
            ws_info_b.range('AE108').value = 'no' in cruzroja_original

            if 'si' in cruzroja_original:
                ws_info_b.range('U109').value = row.get('Si la respuesta anterior es si, Indique a que distancia cruz B', )  
                ws_info_b.range('U110').value = row.get('Se cuenta con alg√∫n numero de tel√©fono?, ind√≠quelo: cruz B', )
            else:
                ws_info_b.range('U109').value = 'N/A'
                ws_info_b.range('U110').value = 'N/A'

              # --- Mapa Nacional de Riesgos ---
            riesgo = normaliza_texto(row.get('Seg√∫n el Mapa Nacional de Riesgos, indique en que zona se ubica el sitio: B', ''))
            ws_info_b.range('Y111').value = 'bajo' in riesgo
            ws_info_b.range('AB111').value = 'medio' in riesgo
            ws_info_b.range('AE111').value = 'alto' in riesgo



            


            

                        # Llenado de campos espec√≠ficos de la hoja "3. Espacios en Torre y Piso A-B"
            # L√≠nea de vista
            linea_vista_original = normaliza_texto(row.get('L√≠nea de vista', ''))
            linea_vista = normaliza_texto(linea_vista_original)
            # TODO: Agregar coordenadas correctas para PtMP
            # ws_espacios.range('R56').value = (linea_vista == 'si')
            # ws_espacios.range('V56').value = (linea_vista == 'no')
            # ws_espacios.range('Q57').value = False
            # ws_espacios.range('V57').value = False
            # ws_espacios.range('AC57').value = False
            # ws_espacios.range('AI57').value = False
            # ws_espacios.range('C58').value = False

            if linea_vista == 'no':
                motivo = normaliza_texto(row.get('Motivo de obstrucci√≥n', ''))
                # TODO: Agregar coordenadas correctas para PtMP
                # if motivo == 'arboles':
                #    ws_espacios.range('Q57').value = True
                # elif motivo == 'espectacular':
                #    ws_espacios.range('V57').value = True
                # elif motivo == 'edificio':
                #    ws_espacios.range('AC57').value = True
                # elif motivo == 'monta√±a':
                #    ws_espacios.range('AI57').value = True
                # elif motivo == 'n/a':
                #    ws_espacios.range('C58').value = True

            # Llenado autom√°tico de celdas usando el diccionario de mapeo para SECTOR
            campos_sector_celdas = {
                'Fecha Inicio Site Survey': 'C9',
                'Fecha final Site Survey': 'I9',
                'NOMBRE DEL SITIO': 'C10', 
                'PROPIETARIO': 'E11',
                'ID': 'I10',
                'ESTADO ':'I16',
                'Calle': 'B15',
                'Colonia': 'B16',
                'Municipio': 'B17',
                'C.P': 'I15',
                'Referencias':'C18',
                'Nombre de contacto en sitio': 'C20',
                'Telefono': 'H20',
                'LATITUD (TORRE)': 'D31',
                'LONGITUD (TORRE)': 'H31',
                'LATITUD (FACHADA)': 'D28',
                'LONGITUD (FACHADA)': 'H28',
                'Altitud (msnm)': 'E33',
                'Horario de solicitud de accesos': 'C53',
                'Contacto solicitud de accesos': 'B55',
                'Como o donde obtener permisos/llave/tarjeta': 'O49',
                'Comentario:Forma de ingresar el equipo al sitio es con:': 'B57',
                'comentario:En caso de requerirse gr√∫a, identifique si es factible el uso de la misma y que no se tenga una posible obstrucci√≥n.': 'B63',
                'Si la respuesta anterior es si, Indique a que distancia ':'H83'
            }
            for campo, celdas in campos_sector_celdas.items():
                valor = normaliza_na(row.get(campo, ""))
                if isinstance(celdas, list):
                    for celda in celdas:
                        ws_sector.range(celda).value = valor
                else:
                    ws_sector.range(celdas).value = valor

            # Llenado autom√°tico de celdas usando el diccionario de mapeo para CPE
            campos_cpe_celdas = {
                'Fecha Inicio Site Survey B': 'C9',
                'Fecha final Site Survey B': 'I9',
                'Nombre del sitio 2': 'C10', 
                'ID 2': 'I10',
                'ESTADO 2 ':'I16',
                'Calle 2': 'B15',
                'Colonia 2': 'B16',
                'Municipio 2': 'B17',
                'C.P 2': 'I15',
                'Referencias 2':'C18',
                'Nombre de contacto en sitio 2': 'C20',
                'Telefono 2': 'H20',
                'LATITUD (TORRE) 2': 'D31',
                'LONGITUD (TORRE) 2': 'H31',
                'LATITUD (FACHADA) 2': 'D28',
                'LONGITUD (FACHADA) 2': 'H28',
                'Altitud (msnm) 2': 'E33',
                'Horario de solicitud de accesos B': 'C53',
                'Contacto solicitud de accesos B': 'B55',
                'Como o donde obtener permisos/llave/tarjeta B': 'C49',
                'Comentario:Forma de ingresar el equipo al sitio es con: B': 'B57',
                'comentario:En caso de requerirse gr√∫a, identifique si es factible el uso de la misma y que no se tenga una posible obstrucci√≥n.': 'B63',
                'Si la respuesta anterior es si, Indique a que distancia B':'H83'
            }
            for campo, celdas in campos_cpe_celdas.items():
                valor = normaliza_na(row.get(campo, ""))
                print(f"ws_cpe: Escribiendo en {celdas} el valor '{valor}' para campo '{campo}'")
                if isinstance(celdas, list):
                    for celda in celdas:
                        ws_cpe.range(celda).value = valor
                else:
                    ws_cpe.range(celdas).value = valor    

            # Llenado autom√°tico de celdas para la hoja "3. Espacios en Torre y Piso A-B"
            campos_espacios_celdas = {
                'NOMBRE DEL SITIO': 'G7',
                'Diametro de pierna superior':'K9',
                'Diametro de pierna Inferior':'U9',
                'NCRA RB':'AC9',
                'Franja2RB':'AM9',
                'Altura de la Torre':'K10',
                'Dado':'U10',
                'Altura Edificio1':'EA10',
                'Nivel inferior de franja disponible': 'T11',
                'Nivel superior de franja disponible': 'AK11',
                'Altura de MW conforme a topologia': 'B14',
                'Azimut RB ': 'M14',
                'Propuesta de altura de antena de MW1': 'AB14',
                'Propuesta de altura de antena de MW (SD)1': 'AJ14',
                'Altura de soporte para OMB propuesto': 'O19',
                'Longitud del cable de tierra nuevo OMB': 'O20',
                'Longitud del cable de tierra ODU': 'O21',
                'Longitud de cable IF': 'O22',
                'Tipo de soporte para antena MW propuesto': 'O23',
                'Longitud de cable ACDB-Nuevo OMB': 'O24',
                'Longitud de cable RTN - Router':'O25',
                'Longitud de cable RTN - BBU SITE 1': 'O26',
                'MEDICION DE BARRA DE TIERRA (Ohms)':'O28',
                'Nombre del sitio 2': 'G31',
                'Di√°metro de Pierna superio2':'K33',
                'Di√°metro de Pierna inferior2':'U33',
                ' NCRA2 ':'AC33',
                'Franja2-2':'AM33',
                'Altura torre 2': 'K34',
                'DADO 2':'U34',
                'Altura edificio 2':'AE34',
                'Nivel inferior de franja disponible 2': 'T35',
                'Nivel superior de franja disponible 2': 'AK35',
                'Altura de MW conforme a topologia 2': 'B38',
                'Azimut 2': 'M38',
                'Propuesta de altura de antena de MW2': 'AB38',
                'Propuesta de altura de antena de MW (SD)2':'AJ38',
                'Altura de soporte para OMB propuesto2':'O43',
                'Longitud del cable de tierra nuevo OMB 2': 'O44',
                'Longitud del cable de tierra ODU 2': 'O45',
                'Longitud de cable IF 2': 'O46',
                'Tipo de soporte para antena MW propuesto 2': 'O47',
                'Longitud de cable ACDB-Nuevo OMB 2': 'O48',
                'Longitud de cable RTN - Router 2': 'O49',
                'Longitud de cable RTN - BBU 2': 'O50',
                'Medici√≥n del Sistema de Tierras 2': 'O52',
            }
            for campo, celdas in campos_espacios_celdas.items():
                valor_original = row.get(campo, "")
                valor = normaliza_na(valor_original)
                print(f"ws_espacios: Campo '{campo}' - Valor original: '{valor_original}' - Valor normalizado: '{valor}' - Escribiendo en {celdas}")
                
                # Log especial para Altura Edificio1
                if campo == 'Altura Edificio1':
                    print(f"*** DEBUG ESPECIAL Altura Edificio1 ***")
                    print(f"   - Campo en row: {'Altura Edificio1' in row}")
                    print(f"   - Valor original: '{valor_original}'")
                    print(f"   - Tipo del valor: {type(valor_original)}")
                    print(f"   - Valor normalizado: '{valor}'")
                    print(f"   - Celda destino: {celdas}")
                
                if isinstance(celdas, list):
                    for celda in celdas:
                        ws_espacios.range(celda).value = valor
                        print(f"ws_espacios: Escrito en celda {celda}: '{ws_espacios.range(celda).value}'")
                else:
                    ws_espacios.range(celdas).value = valor
                    print(f"ws_espacios: Escrito en celda {celdas}: '{ws_espacios.range(celdas).value}'")   

            # Guardar y cerrar
            wb.save(output_path)
            wb.close()
            if app_excel:
                app_excel.quit()

            print('DEBUG: Excel PtMP cerrado, antes del redirect')
            return redirect(url_for('descargar_site_survey_ptmp', user_id=user_id, fila_idx=fila_idx))
        except Exception as e:
            print(f"ERROR en llenado ptmp_site_survey: {e}")
            return f"Error en llenado ptmp_site_survey: {e}"
    elif tipo == 'ptmp_reporte_planeacion':
        print('DEBUG: Entrando a bloque ptmp_reporte_planeacion')
        # TODO: Implementar llenado de Reporte de Planeaci√≥n PtMP
        return f"Funcionalidad PtMP Reporte de Planeaci√≥n en desarrollo para {user_id}"
    elif tipo == 'ptmp_diseno_solucion':
        print('DEBUG: Entrando a bloque ptmp_diseno_solucion')
        # TODO: Implementar llenado de Dise√±o de Soluci√≥n PtMP
        return f"Funcionalidad PtMP Dise√±o de Soluci√≥n en desarrollo para {user_id}"
    else:
        print('DEBUG: Entrando a bloque else (formulario_archivos)')
        return redirect(url_for('formulario_archivos', user_id=user_id, fila_idx=fila_idx))
    print('DEBUG: Fin de redirigir_tipo_llenado (esto no deber√≠a verse si todos los returns est√°n bien)')

@app.route('/subir_imagenes_ptp', methods=['GET', 'POST'])
def subir_imagenes_ptp():
    if request.method == 'GET':
        user_id = request.args.get('user_id')
        fila_idx = request.args.get('fila_idx')
        return render_template('subir_imagenes_ptp.html', user_id=user_id, fila_idx=fila_idx)
    
    if request.method == 'POST':
        user_id = request.form.get('user_id')
        fila_idx = request.form.get('fila_idx')
        
        # Definir base_dir
        base_dir = os.path.dirname(os.path.abspath(__file__))
        
        # Crear directorio para im√°genes si no existe
        imagenes_dir = os.path.join(base_dir, 'uploads', 'imagenes_ptp', user_id)
        os.makedirs(imagenes_dir, exist_ok=True)
        
        # Procesar cada imagen subida
        imagenes_procesadas = []
        
        for i in range(1, 4):  # Soporte para hasta 10 im√°genes
            imagen_key = f'imagen_{i}'
            if imagen_key in request.files:
                archivo = request.files[imagen_key]
                if archivo and archivo.filename != '':
                    # Generar nombre √∫nico para la imagen
                    nombre_archivo = f"imagen_{i}_{user_id}_{int(time.time())}.jpg"
                    ruta_archivo = os.path.join(imagenes_dir, nombre_archivo)
                    
                    # Guardar la imagen
                    archivo.save(ruta_archivo)
                    imagenes_procesadas.append({
                        'numero': i,
                        'ruta': ruta_archivo,
                        'nombre_original': archivo.filename
                    })
        
        # Guardar informaci√≥n de las im√°genes en el Excel
        try:
            import xlwings as xw
            plantilla_path = os.path.join(base_dir, 'static', 'plantillas', 'EJEMPLO SS VACIO.xlsx')
            user_id_limpio = re.sub(r'[<>:"/\\|?*]', '', str(user_id))
            output_path = os.path.join(base_dir, 'site_survey', f'ss_{user_id_limpio}.xlsx')
            
            # Verificar que el archivo Excel existe (buscar tambi√©n con timestamp)
            if not os.path.exists(output_path):
                # Buscar archivos que coincidan con el patr√≥n
                import glob
                patron_archivo = os.path.join(base_dir, 'site_survey', f'ss_{user_id_limpio}*.xlsx')
                archivos_encontrados = glob.glob(patron_archivo)
                
                if archivos_encontrados:
                    print(f"DEBUG: Archivos encontrados: {archivos_encontrados}")
                    # Usar el archivo m√°s reciente
                    archivo_mas_reciente = max(archivos_encontrados, key=os.path.getctime)
                    output_path = archivo_mas_reciente
                    print(f"DEBUG: Usando archivo m√°s reciente: {output_path}")
                else:
                    print(f"DEBUG: No se encontraron archivos con patr√≥n: {patron_archivo}")
                    return jsonify({
                        'success': False,
                        'message': f'El archivo Excel no existe. Primero debes generar el Site Survey. Ruta esperada: {output_path}'
                    })
            
            # Abrir el archivo Excel existente
            app_excel = xw.App(visible=False)
            wb = app_excel.books.open(output_path)
            ws_info_d = wb.sheets['4. Planos A']
            
            # Insertar las im√°genes en las celdas correspondientes
            for imagen in imagenes_procesadas:
                # Definir las celdas donde insertar las im√°genes
                celdas_imagenes = {
                    1: 'C17:AK60',  # Imagen 1
                    2: 'C69:AK123', # Imagen 2
                    3: 'C134:AK173', # Imagen 3
                }
                
                if imagen['numero'] in celdas_imagenes:
                    rango_celda = celdas_imagenes[imagen['numero']]
                    # Insertar la imagen en el rango espec√≠fico
                    ws_info_d.pictures.add(imagen['ruta'], 
                                         left=ws_info_d.range(rango_celda).left,
                                         top=ws_info_d.range(rango_celda).top,
                                         width=ws_info_d.range(rango_celda).width,
                                         height=ws_info_d.range(rango_celda).height)
            
            # Guardar y cerrar
            wb.save()
            wb.close()
            app_excel.quit()
            
            return jsonify({
                'success': True,
                'message': f'Se subieron {len(imagenes_procesadas)} im√°genes correctamente',
                'imagenes': imagenes_procesadas
            })
            
        except Exception as e:
            error_msg = str(e)
            if "No such file" in error_msg:
                return jsonify({
                    'success': False,
                    'message': f'El archivo Excel no existe. Primero debes generar el Site Survey PTP antes de subir im√°genes. Error: {error_msg}'
                })
            else:
                return jsonify({
                    'success': False,
                    'message': f'Error al procesar las im√°genes: {error_msg}'
                })
    
    return "M√©todo no permitido"

@app.route('/subir_imagenes_ptp_planos_b', methods=['GET', 'POST'])
def subir_imagenes_ptp_planos_b():
    if request.method == 'GET':
        user_id = request.args.get('user_id')
        fila_idx = request.args.get('fila_idx')
        return render_template('subir_imagenes_ptp_planos_b.html', user_id=user_id, fila_idx=fila_idx)
    
    if request.method == 'POST':
        user_id = request.form.get('user_id')
        fila_idx = request.form.get('fila_idx')
        
        # Definir base_dir
        base_dir = os.path.dirname(os.path.abspath(__file__))
        
        # Crear directorio para im√°genes si no existe
        imagenes_dir = os.path.join(base_dir, 'uploads', 'imagenes_ptp_planos_b', user_id)
        os.makedirs(imagenes_dir, exist_ok=True)
        
        # Procesar cada imagen subida
        imagenes_procesadas = []
        
        for i in range(1, 4):  # Soporte para hasta 3 im√°genes
            imagen_key = f'imagen_{i}'
            if imagen_key in request.files:
                archivo = request.files[imagen_key]
                if archivo and archivo.filename != '':
                    nombre_archivo = f"imagen_{i}_{user_id}_{int(time.time())}.jpg"
                    ruta_archivo = os.path.join(imagenes_dir, nombre_archivo)
                    archivo.save(ruta_archivo)
                    imagenes_procesadas.append({
                        'numero': i,
                        'ruta': ruta_archivo,
                        'nombre_original': archivo.filename
                    })
        
        # Guardar informaci√≥n de las im√°genes en el Excel
        try:
            import xlwings as xw
            user_id_limpio = re.sub(r'[<>:"/\\|?*]', '', str(user_id))
            output_path = os.path.join(base_dir, 'site_survey', f'ss_{user_id_limpio}.xlsx')
            
            # Verificar que el archivo Excel existe (buscar tambi√©n con timestamp)
            if not os.path.exists(output_path):
                # Buscar archivos que coincidan con el patr√≥n
                import glob
                patron_archivo = os.path.join(base_dir, 'site_survey', f'ss_{user_id_limpio}*.xlsx')
                archivos_encontrados = glob.glob(patron_archivo)
                
                if archivos_encontrados:
                    print(f"DEBUG: Archivos encontrados: {archivos_encontrados}")
                    # Usar el archivo m√°s reciente
                    archivo_mas_reciente = max(archivos_encontrados, key=os.path.getctime)
                    output_path = archivo_mas_reciente
                    print(f"DEBUG: Usando archivo m√°s reciente: {output_path}")
                else:
                    print(f"DEBUG: No se encontraron archivos con patr√≥n: {patron_archivo}")
                    return jsonify({
                        'success': False,
                        'message': f'El archivo Excel no existe. Primero debes generar el Site Survey. Ruta esperada: {output_path}'
                    })
            
            # Abrir el archivo Excel existente
            app_excel = xw.App(visible=False)
            wb = app_excel.books.open(output_path)
            ws_info_e = wb.sheets['5. Planos B']
            
            # Insertar las im√°genes en las celdas correspondientes
            for imagen in imagenes_procesadas:
                # Definir las celdas donde insertar las im√°genes (mismos rangos que Planos A)
                celdas_imagenes = {
                    1: 'C17:AK60',  # Imagen 1
                    2: 'C69:AK123', # Imagen 2
                    3: 'C134:AK173', # Imagen 3
                }
                
                if imagen['numero'] in celdas_imagenes:
                    rango_celda = celdas_imagenes[imagen['numero']]
                    # Insertar la imagen en el rango espec√≠fico
                    ws_info_e.pictures.add(imagen['ruta'], 
                                         left=ws_info_e.range(rango_celda).left,
                                         top=ws_info_e.range(rango_celda).top,
                                         width=ws_info_e.range(rango_celda).width,
                                         height=ws_info_e.range(rango_celda).height)
            
            # Guardar y cerrar
            wb.save()
            wb.close()
            app_excel.quit()
            
            return jsonify({
                'success': True,
                'message': f'Se subieron {len(imagenes_procesadas)} im√°genes correctamente a Planos B',
                'imagenes': imagenes_procesadas
            })
            
        except Exception as e:
            error_msg = str(e)
            if "No such file" in error_msg:
                return jsonify({
                    'success': False,
                    'message': f'El archivo Excel no existe. Primero debes generar el Site Survey PTP antes de subir im√°genes. Error: {error_msg}'
                })
            else:
                return jsonify({
                    'success': False,
                    'message': f'Error al procesar las im√°genes: {error_msg}'
                })
    
    return "M√©todo no permitido"

@app.route('/subir_imagenes_ptp_fotos_a', methods=['GET', 'POST'])
def subir_imagenes_ptp_fotos_a():
    if request.method == 'GET':
        user_id = request.args.get('user_id')
        fila_idx = request.args.get('fila_idx')
        return render_template('subir_imagenes_ptp_fotos_a.html', user_id=user_id, fila_idx=fila_idx)
    
    if request.method == 'POST':
        user_id = request.form.get('user_id')
        fila_idx = request.form.get('fila_idx')
        
        # Definir base_dir
        base_dir = os.path.dirname(os.path.abspath(__file__))
        
        # Crear directorio para im√°genes si no existe
        imagenes_dir = os.path.join(base_dir, 'uploads', 'imagenes_ptp_fotos_a', user_id)
        os.makedirs(imagenes_dir, exist_ok=True)
        
        # Procesar cada imagen subida
        imagenes_procesadas = []
        
        for i in range(1, 20):  # Soporte para hasta 19 im√°genes
            imagen_key = f'imagen_{i}'
            if imagen_key in request.files:
                archivo = request.files[imagen_key]
                if archivo and archivo.filename != '':
                    nombre_archivo = f"imagen_{i}_{user_id}_{int(time.time())}.jpg"
                    ruta_archivo = os.path.join(imagenes_dir, nombre_archivo)
                    archivo.save(ruta_archivo)
                    imagenes_procesadas.append({
                        'numero': i,
                        'ruta': ruta_archivo,
                        'nombre_original': archivo.filename
                    })
        
        # Guardar informaci√≥n de las im√°genes en el Excel
        try:
            import xlwings as xw
            user_id_limpio = re.sub(r'[<>:"/\\|?*]', '', str(user_id))
            output_path = os.path.join(base_dir, 'site_survey', f'ss_{user_id_limpio}.xlsx')
            
            # Verificar que el archivo Excel existe (buscar tambi√©n con timestamp)
            if not os.path.exists(output_path):
                # Buscar archivos que coincidan con el patr√≥n
                import glob
                patron_archivo = os.path.join(base_dir, 'site_survey', f'ss_{user_id_limpio}*.xlsx')
                archivos_encontrados = glob.glob(patron_archivo)
                
                if archivos_encontrados:
                    print(f"DEBUG: Archivos encontrados: {archivos_encontrados}")
                    # Usar el archivo m√°s reciente
                    archivo_mas_reciente = max(archivos_encontrados, key=os.path.getctime)
                    output_path = archivo_mas_reciente
                    print(f"DEBUG: Usando archivo m√°s reciente: {output_path}")
                else:
                    print(f"DEBUG: No se encontraron archivos con patr√≥n: {patron_archivo}")
                    return jsonify({
                        'success': False,
                        'message': f'El archivo Excel no existe. Primero debes generar el Site Survey. Ruta esperada: {output_path}'
                    })
            
            # Abrir el archivo Excel existente
            app_excel = xw.App(visible=False)
            wb = app_excel.books.open(output_path)
            ws_info_f = wb.sheets['6. Reporte Fotos A']
            
            # Definir las celdas donde insertar las im√°genes para Reporte Fotos A
            celdas_imagenes = {
                1: 'G11:L18',   # 6.3.1 Foto linea de Vista de Sitio A a Sitio B
                2: 'X11:AD18',  # 6.3.2 Foto linea de Vista de Sitio A a Sitio B Diversidad
                3: 'G23:L30',   # 6.1.3 Foto de torre completa
                4: 'G48:L55',   # 6.2.1 Foto desde piso mostrando el espacio en torre para antena de MW conforme a topologia
                5: 'X48:AD55',  # 6.2.2 Medici√≥n con cinta del rad center en torre conforme a topologia
                6: 'G59:L66',   # 6.2.3 Foto desde piso mostrando el espacio en torre para antena de MW (SD)
                7: 'X59:AD66',  # 6.2.4 Medici√≥n con cinta del rad center en torre (SD)
                8: 'G70:L77',   # 6.2.5 Foto desde piso mostrando el espacio (propuesto) en torre para antena
                9: 'X70:AD77',  # 6.2.6 Medici√≥n con cinta del rad center (propuesto) en torre conforme a topologia
                10: 'G87:L94',  # 6.3.1 Foto linea de Vista de Sitio A a Sitio B
                11: 'X87:AD94', # 6.3.2 Foto linea de Vista de Sitio A a Sitio B Diversidad
                12: 'G98:L105', # 6.3.3 Foto Barra de Tierra
                13: 'X98:AD105', # 6.3.4 Foto de escalerilla de torre
                14: 'G127:L134', # 6.4.1 Foto del espacio disponible dentro del Gabinete OMB
                15: 'X127:AD134', # 6.4.2 Foto del espacio disponible en torre para OMB adicional
                16: 'G138:L145', # 6.4.3 Foto DPU existente
                17: 'X138:AD145', # 6.4.4 Foto del espacio disponible en torre para DPU y Bateria
                18: 'G150:L157', # 6.4.5 Foto ACDB y Breaker
                19: 'X150:AD157', # 6.4.6 Foto de Agregador (Site Entry)
            }
            
            # Insertar las im√°genes en las celdas correspondientes
            for imagen in imagenes_procesadas:
                if imagen['numero'] in celdas_imagenes:
                    rango_celda = celdas_imagenes[imagen['numero']]
                    # Insertar la imagen en el rango espec√≠fico
                    ws_info_f.pictures.add(imagen['ruta'], 
                                         left=ws_info_f.range(rango_celda).left,
                                         top=ws_info_f.range(rango_celda).top,
                                         width=ws_info_f.range(rango_celda).width,
                                         height=ws_info_f.range(rango_celda).height)
            
            # Colocar N/A en las celdas donde no se subieron im√°genes
            for i in range(1, 20):
                if i not in [img['numero'] for img in imagenes_procesadas]:
                    if i in celdas_imagenes:
                        rango_celda = celdas_imagenes[i]
                        # Obtener la celda central del rango para colocar N/A
                        rango_obj = ws_info_f.range(rango_celda)
                        celda_central = ws_info_f.range(rango_obj.left + rango_obj.width/2, rango_obj.top + rango_obj.height/2)
                        celda_central.value = "N/A"
            
            # Guardar y cerrar
            wb.save()
            wb.close()
            app_excel.quit()
            
            return jsonify({
                'success': True,
                'message': f'Se subieron {len(imagenes_procesadas)} im√°genes correctamente a Reporte Fotos A',
                'imagenes': imagenes_procesadas
            })
            
        except Exception as e:
            error_msg = str(e)
            if "No such file" in error_msg:
                return jsonify({
                    'success': False,
                    'message': f'El archivo Excel no existe. Primero debes generar el Site Survey PTP antes de subir im√°genes. Error: {error_msg}'
                })
            else:
                return jsonify({
                    'success': False,
                    'message': f'Error al procesar las im√°genes: {error_msg}'
                })
    
    return "M√©todo no permitido"

@app.route('/subir_imagenes_ptp_fotos_b', methods=['GET', 'POST'])
def subir_imagenes_ptp_fotos_b():
    if request.method == 'GET':
        user_id = request.args.get('user_id')
        fila_idx = request.args.get('fila_idx')
        return render_template('subir_imagenes_ptp_fotos_b.html', user_id=user_id, fila_idx=fila_idx)
    
    if request.method == 'POST':
        user_id = request.form.get('user_id')
        fila_idx = request.form.get('fila_idx')
        
        # Definir base_dir
        base_dir = os.path.dirname(os.path.abspath(__file__))
        
        # Crear directorio para im√°genes si no existe
        imagenes_dir = os.path.join(base_dir, 'uploads', 'imagenes_ptp_fotos_b', user_id)
        os.makedirs(imagenes_dir, exist_ok=True)
        
        # Procesar cada imagen subida
        imagenes_procesadas = []
        
        print(f"DEBUG: Procesando im√°genes para Reporte Fotos B - User ID: {user_id}")
        print(f"DEBUG: Archivos recibidos: {list(request.files.keys())}")
        
        for i in range(1, 20):  # Soporte para hasta 19 im√°genes (todas las im√°genes de Reporte Fotos B)
            imagen_key = f'imagen_{i}'
            print(f"DEBUG: Verificando {imagen_key}")
            
            if imagen_key in request.files:
                archivo = request.files[imagen_key]
                print(f"DEBUG: Archivo encontrado para {imagen_key}: {archivo.filename}")
                
                if archivo and archivo.filename != '':
                    nombre_archivo = f"imagen_{i}_{user_id}_{int(time.time())}.jpg"
                    ruta_archivo = os.path.join(imagenes_dir, nombre_archivo)
                    print(f"DEBUG: Guardando archivo en: {ruta_archivo}")
                    
                    archivo.save(ruta_archivo)
                    imagenes_procesadas.append({
                        'numero': i,
                        'ruta': ruta_archivo,
                        'nombre_original': archivo.filename
                    })
                    print(f"DEBUG: Imagen {i} procesada correctamente")
                else:
                    print(f"DEBUG: Archivo {imagen_key} est√° vac√≠o o no tiene nombre")
            else:
                print(f"DEBUG: No se encontr√≥ archivo para {imagen_key}")
        
        print(f"DEBUG: Total de im√°genes procesadas: {len(imagenes_procesadas)}")
        print(f"DEBUG: Im√°genes procesadas: {imagenes_procesadas}")
        
        # Guardar informaci√≥n de las im√°genes en el Excel
        try:
            import xlwings as xw
            user_id_limpio = re.sub(r'[<>:"/\\|?*]', '', str(user_id))
            output_path = os.path.join(base_dir, 'site_survey', f'ss_{user_id_limpio}.xlsx')
            
            # Verificar que el archivo Excel existe (buscar tambi√©n con timestamp)
            if not os.path.exists(output_path):
                # Buscar archivos que coincidan con el patr√≥n
                import glob
                patron_archivo = os.path.join(base_dir, 'site_survey', f'ss_{user_id_limpio}*.xlsx')
                archivos_encontrados = glob.glob(patron_archivo)
                
                if archivos_encontrados:
                    print(f"DEBUG: Archivos encontrados: {archivos_encontrados}")
                    # Usar el archivo m√°s reciente
                    archivo_mas_reciente = max(archivos_encontrados, key=os.path.getctime)
                    output_path = archivo_mas_reciente
                    print(f"DEBUG: Usando archivo m√°s reciente: {output_path}")
                else:
                    print(f"DEBUG: No se encontraron archivos con patr√≥n: {patron_archivo}")
                    return jsonify({
                        'success': False,
                        'message': f'El archivo Excel no existe. Primero debes generar el Site Survey. Ruta esperada: {output_path}'
                    })
            
            # Abrir el archivo Excel existente
            print(f"DEBUG: Abriendo archivo Excel: {output_path}")
            app_excel = xw.App(visible=False)
            wb = app_excel.books.open(output_path)
            ws_info_g = wb.sheets['7. Reporte Fotos B']
            print(f"DEBUG: Hoja '7. Reporte Fotos B' abierta correctamente")
            
            # Definir las celdas donde insertar las im√°genes para Reporte Fotos B
            celdas_imagenes = {
                1: 'G11:L18', # 7.4.4 Foto del espacio disponible en torre para DPU y Bateria
                2: 'X11:AD18',  # 7.4.5 Foto ACDB y Breaker
                3: 'G23:L30', # 7.4.6 Foto de Agregador (Site Entry)
                4: 'G48:L55',  # 7.2.1 Foto desde piso mostrando el espacio en torre para antena de MW conforme a topologia
                5: 'X48:AD55', # 7.2.2 Medici√≥n con cinta del rad center en torre conforme a topologia
                6: 'G59:L66',  # 7.1.3 Foto de torre completa
                7: 'X59:AD66', # 7.2.3 Foto desde piso mostrando el espacio en torre para antena de MW (SD)
                8: 'G70:L77',  # 7.2.4 Medici√≥n con cinta del rad center en torre (SD)
                9: 'X70:AD77', # 7.2.5 Foto desde piso mostrando el espacio (propuesto) en torre para antena
                10: 'G87:L94', # 7.2.6 Medici√≥n con cinta del rad center (propuesto) en torre conforme a topologia
                11: 'X87:AD94', # 7.3.1 Foto linea de Vista de Sitio A a Sitio B
                12: 'G98:L105', # 7.3.2 Foto linea de Vista de Sitio A a Sitio B Diversidad
                13: 'X98:AD105', # 7.3.3 Foto Barra de Tierra
                14: 'G127:L134', # 7.3.4 Foto de escalerilla de torre
                15: 'X127:AD134', # 7.4.1 Foto del espacio disponible dentro del Gabinete OMB
                16: 'G138:L145', # 7.4.2 Foto del espacio disponible en torre para OMB adicional
                17: 'X138:AD145', # 7.4.3 Foto DPU existente
                18: 'G150:L157', # 7.4.4 Foto del espacio disponible en torre para DPU y Bateria
                19: 'X150:AD157', # 7.4.5 Foto ACDB y Breaker
            }
            print(f"DEBUG: Rangos de celdas definidos: {celdas_imagenes}")
            
            # Insertar las im√°genes en las celdas correspondientes
            for imagen in imagenes_procesadas:
                print(f"DEBUG: Procesando imagen {imagen['numero']}: {imagen['ruta']}")
                if imagen['numero'] in celdas_imagenes:
                    rango_celda = celdas_imagenes[imagen['numero']]
                    print(f"DEBUG: Insertando imagen en rango: {rango_celda}")
                    # Insertar la imagen en el rango espec√≠fico
                    ws_info_g.pictures.add(imagen['ruta'], 
                                         left=ws_info_g.range(rango_celda).left,
                                         top=ws_info_g.range(rango_celda).top,
                                         width=ws_info_g.range(rango_celda).width,
                                         height=ws_info_g.range(rango_celda).height)
                    print(f"DEBUG: Imagen {imagen['numero']} insertada correctamente en Excel")
                else:
                    print(f"DEBUG: ERROR - No se encontr√≥ rango para imagen {imagen['numero']}")
            
            # Colocar N/A en las celdas donde no se subieron im√°genes
            for i in range(1, 20):
                if i not in [img['numero'] for img in imagenes_procesadas]:
                    if i in celdas_imagenes:
                        rango_celda = celdas_imagenes[i]
                        print(f"DEBUG: Colocando N/A en rango {rango_celda} para imagen {i}")
                        # Obtener la celda central del rango para colocar N/A
                        rango_obj = ws_info_g.range(rango_celda)
                        celda_central = ws_info_g.range(rango_obj.left + rango_obj.width/2, rango_obj.top + rango_obj.height/2)
                        celda_central.value = "N/A"
                        print(f"DEBUG: N/A colocado correctamente en imagen {i}")
                    else:
                        print(f"DEBUG: No se encontr√≥ rango para colocar N/A en imagen {i}")
                else:
                    print(f"DEBUG: Imagen {i} fue subida, no se coloca N/A")
            
            # Guardar y cerrar
            print(f"DEBUG: Guardando archivo Excel...")
            wb.save()
            print(f"DEBUG: Archivo guardado correctamente")
            wb.close()
            app_excel.quit()
            print(f"DEBUG: Excel cerrado correctamente")
            
            return jsonify({
                'success': True,
                'message': f'Se subieron {len(imagenes_procesadas)} im√°genes correctamente a Reporte Fotos B',
                'imagenes': imagenes_procesadas
            })
            
        except Exception as e:
            error_msg = str(e)
            if "No such file" in error_msg:
                return jsonify({
                    'success': False,
                    'message': f'El archivo Excel no existe. Primero debes generar el Site Survey PTP antes de subir im√°genes. Error: {error_msg}'
                })
            else:
                return jsonify({
                    'success': False,
                    'message': f'Error al procesar las im√°genes: {error_msg}'
                })
    
    return "M√©todo no permitido"

# ===== RUTAS PARA IM√ÅGENES DE DISE√ëO DE SOLUCI√ìN =====

@app.route('/subir_imagenes_planos_a_diseno', methods=['GET', 'POST'])
def subir_imagenes_planos_a_diseno():
    if request.method == 'GET':
        user_id = request.args.get('user_id')
        fila_idx = request.args.get('fila_idx')
        return render_template_string(f"""
        <!DOCTYPE html>
        <html>
        <head>
            <title>Subir Im√°genes - Planos A - Dise√±o de Soluci√≥n</title>
            <style>
                body {{ font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }}
                .container {{ max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }}
                h1 {{ color: #333; text-align: center; }}
                .upload-area {{ border: 2px dashed #9b59b6; padding: 40px; text-align: center; margin: 20px 0; border-radius: 10px; }}
                .btn {{ background: #9b59b6; color: white; padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; margin: 10px; }}
                .btn:hover {{ background: #8e44ad; }}
            </style>
        </head>
        <body>
            <div class="container">
                <h1>üìê Subir Im√°genes - Planos A - Dise√±o de Soluci√≥n</h1>
                <p><strong>ID:</strong> {user_id}</p>
                <p><strong>Fila:</strong> {fila_idx}</p>
                
                <form method="POST" enctype="multipart/form-data">
                    <input type="hidden" name="user_id" value="{user_id}">
                    <input type="hidden" name="fila_idx" value="{fila_idx}">
                    
                    <div class="upload-area">
                        <h3>üìê √Årea de Carga de Planos A</h3>
                        <p>Selecciona hasta 6 im√°genes de planos del sitio A</p>
                        <input type="file" name="planos_a" accept="image/*" class="btn" multiple>
                    </div>
                    
                    <div style="text-align: center;">
                        <button type="button" class="btn" onclick="history.back()">‚¨ÖÔ∏è Volver</button>
                        <button type="submit" class="btn">üíæ Subir Planos A</button>
                    </div>
                </form>
            </div>
        </body>
        </html>
        """)
    
    # POST method - Implementaci√≥n para planos A
    if request.method == 'POST':
        user_id = request.form.get('user_id')
        fila_idx = request.form.get('fila_idx')
        
        if not user_id:
            return jsonify({'success': False, 'message': 'Falta el user_id'})
        
        try:
            # Definir base_dir
            base_dir = os.path.dirname(os.path.abspath(__file__))
            
            # Crear directorio para planos A si no existe
            planos_a_dir = os.path.join(base_dir, 'uploads', 'planos_a_diseno', user_id)
            os.makedirs(planos_a_dir, exist_ok=True)
            
            # Procesar im√°genes de planos A
            planos_a_files = request.files.getlist('planos_a')
            
            if not planos_a_files or all(f.filename == '' for f in planos_a_files):
                return jsonify({'success': False, 'message': 'No se seleccionaron im√°genes'})
            
            # Guardar hasta 6 im√°genes
            planos_a_procesados = []
            for i, archivo in enumerate(planos_a_files[:6], 1):
                if archivo and archivo.filename != '':
                    nombre_archivo = f"planos_a_{i}_{user_id}_{int(time.time())}.jpg"
                    ruta_archivo = os.path.join(planos_a_dir, nombre_archivo)
                    archivo.save(ruta_archivo)
                    planos_a_procesados.append({
                        'numero': i,
                        'ruta': ruta_archivo,
                        'nombre_original': archivo.filename
                    })
            
            return jsonify({
                'success': True,
                'message': f'Se subieron {len(planos_a_procesados)} planos A correctamente',
                'planos': planos_a_procesados
            })
            
        except Exception as e:
            return jsonify({
                'success': False,
                'message': f'Error al subir los planos A: {str(e)}'
            })

@app.route('/subir_imagenes_planos_b_diseno', methods=['GET', 'POST'])
def subir_imagenes_planos_b_diseno():
    if request.method == 'GET':
        user_id = request.args.get('user_id')
        fila_idx = request.args.get('fila_idx')
        return render_template_string(f"""
        <!DOCTYPE html>
        <html>
        <head>
            <title>Subir Im√°genes - Planos B - Dise√±o de Soluci√≥n</title>
            <style>
                body {{ font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }}
                .container {{ max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }}
                h1 {{ color: #333; text-align: center; }}
                .upload-area {{ border: 2px dashed #9b59b6; padding: 40px; text-align: center; margin: 20px 0; border-radius: 10px; }}
                .btn {{ background: #9b59b6; color: white; padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; margin: 10px; }}
                .btn:hover {{ background: #8e44ad; }}
            </style>
        </head>
        <body>
            <div class="container">
                <h1>üìê Subir Im√°genes - Planos B - Dise√±o de Soluci√≥n</h1>
                <p><strong>ID:</strong> {user_id}</p>
                <p><strong>Fila:</strong> {fila_idx}</p>
                
                <form method="POST" enctype="multipart/form-data">
                    <input type="hidden" name="user_id" value="{user_id}">
                    <input type="hidden" name="fila_idx" value="{fila_idx}">
                    
                    <div class="upload-area">
                        <h3>üìê √Årea de Carga de Planos B</h3>
                        <p>Selecciona hasta 1 imagen de plano del sitio B</p>
                        <input type="file" name="planos_b" accept="image/*" class="btn" required>
                    </div>
                    
                    <div style="text-align: center;">
                        <button type="button" class="btn" onclick="history.back()">‚¨ÖÔ∏è Volver</button>
                        <button type="submit" class="btn">üíæ Subir Plano B</button>
                    </div>
                </form>
            </div>
        </body>
        </html>
        """)
    
    # POST method - Implementaci√≥n para planos B
    if request.method == 'POST':
        user_id = request.form.get('user_id')
        fila_idx = request.form.get('fila_idx')
        
        if not user_id:
            return jsonify({'success': False, 'message': 'Falta el user_id'})
        
        try:
            # Definir base_dir
            base_dir = os.path.dirname(os.path.abspath(__file__))
            
            # Crear directorio para planos B si no existe
            planos_b_dir = os.path.join(base_dir, 'uploads', 'planos_b_diseno', user_id)
            os.makedirs(planos_b_dir, exist_ok=True)
            
            # Procesar imagen de plano B
            planos_b_file = request.files.get('planos_b')
            
            if not planos_b_file or planos_b_file.filename == '':
                return jsonify({'success': False, 'message': 'No se seleccion√≥ imagen'})
            
            # Guardar imagen
            nombre_archivo = f"planos_b_{user_id}_{int(time.time())}.jpg"
            ruta_archivo = os.path.join(planos_b_dir, nombre_archivo)
            planos_b_file.save(ruta_archivo)
            
            return jsonify({
                'success': True,
                'message': 'Plano B subido correctamente',
                'ruta': ruta_archivo
            })
            
        except Exception as e:
            return jsonify({
                'success': False,
                'message': f'Error al subir el plano B: {str(e)}'
            })

@app.route('/subir_imagenes_fotos_a_diseno', methods=['GET', 'POST'])
def subir_imagenes_fotos_a_diseno():
    if request.method == 'GET':
        user_id = request.args.get('user_id')
        fila_idx = request.args.get('fila_idx')
        return render_template_string(f"""
        <!DOCTYPE html>
        <html>
        <head>
            <title>Subir Im√°genes - Fotos A - Dise√±o de Soluci√≥n</title>
            <style>
                body {{ font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }}
                .container {{ max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }}
                h1 {{ color: #333; text-align: center; }}
                .upload-area {{ border: 2px dashed #9b59b6; padding: 40px; text-align: center; margin: 20px 0; border-radius: 10px; }}
                .btn {{ background: #9b59b6; color: white; padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; margin: 10px; }}
                .btn:hover {{ background: #8e44ad; }}
            </style>
        </head>
        <body>
            <div class="container">
                <h1>üì∏ Subir Im√°genes - Fotos A - Dise√±o de Soluci√≥n</h1>
                <p><strong>ID:</strong> {user_id}</p>
                <p><strong>Fila:</strong> {fila_idx}</p>
                
                <form method="POST" enctype="multipart/form-data">
                    <input type="hidden" name="user_id" value="{user_id}">
                    <input type="hidden" name="fila_idx" value="{fila_idx}">
                    
                    <div class="upload-area">
                        <h3>üì∏ √Årea de Carga de Fotos A</h3>
                        <p>Selecciona hasta 19 fotos del sitio A</p>
                        <input type="file" name="fotos_a" accept="image/*" class="btn" multiple>
                    </div>
                    
                    <div style="text-align: center;">
                        <button type="button" class="btn" onclick="history.back()">‚¨ÖÔ∏è Volver</button>
                        <button type="submit" class="btn">üíæ Subir Fotos A</button>
                    </div>
                </form>
            </div>
        </body>
        </html>
        """)
    
    # POST method - Implementaci√≥n para fotos A
    if request.method == 'POST':
        user_id = request.form.get('user_id')
        fila_idx = request.form.get('fila_idx')
        
        if not user_id:
            return jsonify({'success': False, 'message': 'Falta el user_id'})
        
        try:
            # Definir base_dir
            base_dir = os.path.dirname(os.path.abspath(__file__))
            
            # Crear directorio para fotos A si no existe
            fotos_a_dir = os.path.join(base_dir, 'uploads', 'fotos_a_diseno', user_id)
            os.makedirs(fotos_a_dir, exist_ok=True)
            
            # Procesar fotos A
            fotos_a_files = request.files.getlist('fotos_a')
            
            if not fotos_a_files or all(f.filename == '' for f in fotos_a_files):
                return jsonify({'success': False, 'message': 'No se seleccionaron fotos'})
            
            # Guardar hasta 19 fotos
            fotos_a_procesadas = []
            for i, archivo in enumerate(fotos_a_files[:19], 1):
                if archivo and archivo.filename != '':
                    nombre_archivo = f"fotos_a_{i}_{user_id}_{int(time.time())}.jpg"
                    ruta_archivo = os.path.join(fotos_a_dir, nombre_archivo)
                    archivo.save(ruta_archivo)
                    fotos_a_procesadas.append({
                        'numero': i,
                        'ruta': ruta_archivo,
                        'nombre_original': archivo.filename
                    })
            
            return jsonify({
                'success': True,
                'message': f'Se subieron {len(fotos_a_procesadas)} fotos A correctamente',
                'fotos': fotos_a_procesadas
            })
            
        except Exception as e:
            return jsonify({
                'success': False,
                'message': f'Error al subir las fotos A: {str(e)}'
            })

@app.route('/subir_imagenes_fotos_b_diseno', methods=['GET', 'POST'])
def subir_imagenes_fotos_b_diseno():
    if request.method == 'GET':
        user_id = request.args.get('user_id')
        fila_idx = request.args.get('fila_idx')
        return render_template_string(f"""
        <!DOCTYPE html>
        <html>
        <head>
            <title>Subir Im√°genes - Fotos B - Dise√±o de Soluci√≥n</title>
            <style>
                body {{ font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }}
                .container {{ max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }}
                h1 {{ color: #333; text-align: center; }}
                .upload-area {{ border: 2px dashed #9b59b6; padding: 40px; text-align: center; margin: 20px 0; border-radius: 10px; }}
                .btn {{ background: #9b59b6; color: white; padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; margin: 10px; }}
                .btn:hover {{ background: #8e44ad; }}
            </style>
        </head>
        <body>
            <div class="container">
                <h1>üì∏ Subir Im√°genes - Fotos B - Dise√±o de Soluci√≥n</h1>
                <p><strong>ID:</strong> {user_id}</p>
                <p><strong>Fila:</strong> {fila_idx}</p>
                
                <form method="POST" enctype="multipart/form-data">
                    <input type="hidden" name="user_id" value="{user_id}">
                    <input type="hidden" name="fila_idx" value="{fila_idx}">
                    
                    <div class="upload-area">
                        <h3>üì∏ √Årea de Carga de Fotos B</h3>
                        <p>Selecciona hasta 10 fotos del sitio B</p>
                        <input type="file" name="fotos_b" accept="image/*" class="btn" multiple>
                    </div>
                    
                    <div style="text-align: center;">
                        <button type="submit" class="btn">üíæ Subir Fotos B</button>
                    </div>
                </form>
            </div>
        </body>
        </html>
        """)
    
    # POST method - Implementaci√≥n para fotos B
    if request.method == 'POST':
        user_id = request.form.get('user_id')
        fila_idx = request.form.get('fila_idx')
        
        if not user_id:
            return jsonify({'success': False, 'message': 'Falta el user_id'})
        
        try:
            # Definir base_dir
            base_dir = os.path.dirname(os.path.abspath(__file__))
            
            # Crear directorio para fotos B si no existe
            fotos_b_dir = os.path.join(base_dir, 'uploads', 'fotos_b_diseno', user_id)
            os.makedirs(fotos_b_dir, exist_ok=True)
            
            # Procesar fotos B
            fotos_b_files = request.files.getlist('fotos_b')
            
            if not fotos_b_files or all(f.filename == '' for f in fotos_b_files):
                return jsonify({'success': False, 'message': 'No se seleccionaron fotos'})
            
            # Guardar hasta 10 fotos
            fotos_b_procesadas = []
            for i, archivo in enumerate(fotos_b_files[:10], 1):
                if archivo and archivo.filename != '':
                    nombre_archivo = f"fotos_b_{i}_{user_id}_{int(time.time())}.jpg"
                    ruta_archivo = os.path.join(fotos_b_dir, nombre_archivo)
                    archivo.save(ruta_archivo)
                    fotos_b_procesadas.append({
                        'numero': i,
                        'ruta': ruta_archivo,
                        'nombre_original': archivo.filename
                    })
            
            return jsonify({
                'success': True,
                'message': f'Se subieron {len(fotos_b_procesadas)} fotos B correctamente',
                'fotos': fotos_b_procesadas
            })
            
        except Exception as e:
            return jsonify({
                'success': False,
                'message': f'Error al subir las fotos B: {str(e)}'
            })

# ===== FIN DE RUTAS PARA IM√ÅGENES DE DISE√ëO DE SOLUCI√ìN =====

@app.route('/seleccion_id', methods=['POST'])
def seleccion_id():
    import pandas as pd
    user_id = request.form.get('user_id')
    if not user_id:
        return "Falta el ID"
    try:
        df_db = pd.read_csv(GOOGLE_SHEETS_CSV_URL, keep_default_na=False, na_values=[])
    except Exception as e:
        return f"Error leyendo la base de datos de Google Sheets: {e}"
    coincidencias = df_db[df_db['ID'] == user_id]
    if coincidencias.empty:
        return "ID no encontrado en la base de datos."
    if len(coincidencias) > 1:
        opciones = []
        for idx, row in coincidencias.iterrows():
            opciones.append({'idx': idx, 'sitio_a': row.get('Nombre del sitio A', ''), 'sitio_b': row.get('Nombre del sitio B', ''), 'analisis': row.get('An√°lisis', '')})
        return render_template('seleccion_registro.html', user_id=user_id, opciones=opciones)
    fila_idx = coincidencias.index[0]
    return redirect(url_for('seleccion_tipo_llenado', user_id=user_id, fila_idx=fila_idx))

# Funci√≥n normaliza_na ya definida anteriormente en el archivo
# Esta definici√≥n duplicada ha sido removida para evitar conflictos

def normaliza_texto(texto):
    if not isinstance(texto, str):
        return ""
    texto = texto.strip().lower()
    import unicodedata
    texto = ''.join(
        c for c in unicodedata.normalize('NFD', texto)
        if unicodedata.category(c) != 'Mn'
    )
    # Elimina par√©ntesis y otros signos
    for char in "-_.,;:()[]{}":
        texto = texto.replace(char, '')
    texto = texto.replace(' ', '')
    return texto

def safe_strip(valor):
    """Funci√≥n segura para hacer strip() en cualquier tipo de valor"""
    if valor is None:
        return ""
    return str(valor).strip()

def limpiar_todos_los_checkboxes(ws_info_a, ws_info_b, ws_espacios):
    """
    LIMPIA TODOS LOS CHECKBOXES DEL ARCHIVO ANTES DE LLENAR
    Esto asegura que no queden checkboxes del llenado anterior
    """
    try:
        print("üßπ Limpiando checkboxes de Hoja 1: Informaci√≥n General A...")
        
        # ===== HOJA 1: INFORMACI√ìN GENERAL A =====
        # Tipo de Zona
        ws_info_a.range('L21').value = False
        ws_info_a.range('P21').value = False
        ws_info_a.range('U21').value = False
        ws_info_a.range('X21').value = False
        ws_info_a.range('AB21').value = False
        
        # Visibilidad
        ws_info_a.range('P22').value = False
        ws_info_a.range('S22').value = False
        
        # Tipo de Camino
        ws_info_a.range('G23').value = False
        ws_info_a.range('L23').value = False
        ws_info_a.range('Q23').value = False
        ws_info_a.range('V23').value = False
        
        # Riesgos
        ws_info_a.range('Y40').value = False
        ws_info_a.range('P41').value = False
        ws_info_a.range('AA41').value = False
        
        # Tipo de sitio
        ws_info_a.range('D39').value = False
        ws_info_a.range('M39').value = False
        ws_info_a.range('U39').value = False
        
        # Acceso al Personal
        ws_info_a.range('B47').value = False
        ws_info_a.range('H47').value = False
        ws_info_a.range('R47').value = False
        ws_info_a.range('B48').value = False
        ws_info_a.range('J48').value = False
        
        # Gr√∫a
        ws_info_a.range('B61').value = False
        ws_info_a.range('J61').value = False
        ws_info_a.range('S61').value = False
        
        # Alimentaci√≥n compatible
        ws_info_a.range('Y25').value = False
        ws_info_a.range('AB25').value = False
        
        # Sistema el√©ctrico - CORREGIDO: Ya no se limpia aqu√≠ (est√° en hoja 3)
        # ws_info_a.range('AG21').value = False  # REMOVIDO
        # ws_info_a.range('AL21').value = False  # REMOVIDO
        
        # Cara propuesta - CORREGIDO: Ya no se limpia aqu√≠ (est√° en hoja 3)
        # ws_info_a.range('Y16').value = False   # REMOVIDO
        # ws_info_a.range('AC16').value = False  # REMOVIDO
        # ws_info_a.range('AE16').value = False  # REMOVIDO
        # ws_info_a.range('AN16').value = False  # REMOVIDO
        
        # Barra de tierra
        ws_info_a.range('O27').value = False
        ws_info_a.range('R27').value = False
        
        # Tipo de soluci√≥n
        ws_info_a.range('O29').value = False
        ws_info_a.range('R29').value = False
        
        print("üßπ Limpiando checkboxes de Hoja 2: Informaci√≥n General B...")
        
        # ===== HOJA 2: INFORMACI√ìN GENERAL B =====
        # Tipo de sitio B
        ws_info_b.range('D39').value = False
        ws_info_b.range('M39').value = False
        ws_info_b.range('U39').value = False
        
        # Acceso al Personal B
        ws_info_b.range('B47').value = False
        ws_info_b.range('H47').value = False
        ws_info_b.range('R47').value = False
        ws_info_b.range('B48').value = False
        ws_info_b.range('J48').value = False
        
        # Gr√∫a B
        ws_info_b.range('B61').value = False
        ws_info_b.range('J61').value = False
        ws_info_b.range('S61').value = False
        
        print("üßπ Limpiando checkboxes de Hoja 3: Espacios...")
        
        # ===== HOJA 3: ESPACIOS EN TORRE Y PISO A-B =====
        # Campos adicionales en espacios
        ws_espacios.range('K8').value = ''
        ws_espacios.range('H33').value = ''
        ws_espacios.range('M117').value = ''
        ws_espacios.range('M139').value = ''
        ws_espacios.range('M162').value = ''
        ws_espacios.range('M184').value = ''
        
        print("‚úÖ TODOS LOS CHECKBOXES LIMPIADOS EXITOSAMENTE")
        
    except Exception as e:
        print(f"‚ùå ERROR limpiando checkboxes: {e}")
        import traceback
        traceback.print_exc()

def llenar_site_survey_completo(ws_info_a, ws_info_b, ws_espacios, ws_planos_a, ws_planos_b, ws_fotos_a, ws_fotos_b, user_id):
    """
    FUNCI√ìN COMPLETA PARA LLENAR TODOS LOS CAMPOS DEL SITE SURVEY
    BASADA EN EL C√ìDIGO ORIGINAL DEL USUARIO
    """
    print("üîß LLENANDO SITE SURVEY COMPLETO - FUNCI√ìN COMPLETA...")
    
    try:
        # OBTENER LA INFORMACI√ìN CORRECTA DEL NUEVO ID
        print(f"üîç Buscando informaci√≥n del NUEVO ID: {user_id}")
        df_db = get_cached_dataframe()
        
        # Buscar por ID exacto
        user_id_mask = df_db['ID'] == user_id
        if user_id_mask.any():
            row = df_db[user_id_mask].iloc[0]
            print(f"‚úÖ Informaci√≥n encontrada para ID: {user_id}")
        else:
            print(f"‚ùå ID {user_id} NO encontrado en DataFrame")
            return False
        
        # ===== HOJA 1: INFORMACI√ìN GENERAL A =====
        print("üìã Llenando Hoja 1: Informaci√≥n General A...")
        
        # Tipo de Zona
        tipo_zona = normaliza_texto(row.get('Tipo de Zona', ''))
        ws_info_a.range('L21').value = 'urbana' in tipo_zona
        ws_info_a.range('P21').value = 'suburbana' in tipo_zona
        ws_info_a.range('U21').value = 'rural' in tipo_zona
        ws_info_a.range('X21').value = 'ejidal' in tipo_zona
        ws_info_a.range('AB21').value = 'pueblomagico' in tipo_zona
        
        # Visibilidad
        tipo_visible = normaliza_texto(row.get('El sitio es visible de d√≠a y de noche (libre de maleza y arboles): ', ''))
        ws_info_a.range('P22').value = 'si' in tipo_visible
        ws_info_a.range('S22').value = 'no' in tipo_visible
        
        # Tipo de Camino
        tipo_camino = normaliza_texto(row.get('Tipo de Camino', ''))
        ws_info_a.range('G23').value = 'terraceria' in tipo_camino
        ws_info_a.range('L23').value = 'pavimentado' in tipo_camino
        ws_info_a.range('Q23').value = 'empedrado' in tipo_camino
        ws_info_a.range('V23').value = 'mixto' in tipo_camino
        
        # Riesgos
        tipo_riesgo_a = normaliza_texto(row.get('Riesgo', ''))
        ws_info_a.range('Y40').value = 'delitocomunroboatranseuntes' in tipo_riesgo_a
        ws_info_a.range('P41').value = 'inconformidadvecinalconbloqueo' in tipo_riesgo_a
        ws_info_a.range('AA41').value = 'delincuenciaorganizada' in tipo_riesgo_a
        
        # Propietario/Administrador
        tipo_Propietario_Administrador = normaliza_texto(row.get('Propietario_Administrador', ''))
        ws_info_a.range('K34').value = 'telesite' in tipo_Propietario_Administrador
        ws_info_a.range('P34').value = 'ctwr' in tipo_Propietario_Administrador
        ws_info_a.range('V34').value = 'mtp' in tipo_Propietario_Administrador
        ws_info_a.range('Z34').value = 'intelesites' in tipo_Propietario_Administrador
        ws_info_a.range('AE34').value = 'even' in tipo_Propietario_Administrador
        ws_info_a.range('A35').value = 'atc' in tipo_Propietario_Administrador
        ws_info_a.range('F35').value = 'temm' in tipo_Propietario_Administrador
        ws_info_a.range('K35').value = 'renta tower' in tipo_Propietario_Administrador
        ws_info_a.range('P35').value = 'torrecom' in tipo_Propietario_Administrador
        ws_info_a.range('V35').value = 'uniti' in tipo_Propietario_Administrador
        ws_info_a.range('A36').value = 'tower one' in tipo_Propietario_Administrador
        ws_info_a.range('F36').value = 'iimt' in tipo_Propietario_Administrador
        ws_info_a.range('K36').value = 'servicom' in tipo_Propietario_Administrador
        ws_info_a.range('A37').value = 'canadian tower' in tipo_Propietario_Administrador
        ws_info_a.range('F37').value = 'mx tower' in tipo_Propietario_Administrador
        ws_info_a.range('K37').value = 'cfe' in tipo_Propietario_Administrador
        
        # Tipo de sitio
        tipo_tipositio = normaliza_texto(row.get('Tipo de sitio', ''))
        ws_info_a.range('D39').value = 'terrenogreenfield' in tipo_tipositio
        ws_info_a.range('M39').value = 'sobresuelorawland' in tipo_tipositio
        ws_info_a.range('U39').value = 'sobreazotea' in tipo_tipositio
        
        # Considera accesible
        tipo_considera_accesible = normaliza_texto(row.get('Considera accesible el sitio de d√≠a y de noche?', ''))
        ws_info_a.range('S43').value = 'solodedia' in tipo_considera_accesible
        ws_info_a.range('W43').value = 'solodenoche' in tipo_considera_accesible
        ws_info_a.range('AB43').value = 'sinproblemadehora' in tipo_considera_accesible
        
        # Zona segura
        tipo_zonasegura = normaliza_texto(row.get('El sitio se encuentra construido en zona segura (De NO derrumbes):', ''))
        ws_info_a.range('S44').value = 'si' in tipo_zonasegura
        ws_info_a.range('W44').value = 'no' in tipo_zonasegura
        
        # Horario controlado
        tipo_horariocontrolado = normaliza_texto(row.get('Horario Controlado', ''))
        ws_info_a.range('B50').value = 'si' in tipo_horariocontrolado
        
        # Acceso al Personal
        acceso_personal = normaliza_texto(row.get('TIPO DE ACCESO A SITIO', ''))
        ws_info_a.range('B47').value = 'llave' in acceso_personal
        ws_info_a.range('H47').value = 'permiso/memorandum' in acceso_personal
        ws_info_a.range('R47').value = 'candadodecombinacion' in acceso_personal
        ws_info_a.range('B48').value = 'tarjetaelectronica' in acceso_personal
        ws_info_a.range('J48').value = 'otro' in acceso_personal
        
        # Campos vinculados
        if 'candadodecombinacion' in acceso_personal:
            ws_info_a.range('AF47').value = row.get('Candado de Combinaci√≥n', '')
            ws_info_a.range('Q48').value = 'N/A'
        elif ('llave' in acceso_personal or 'permiso/memorandum' in acceso_personal or 'tarjetaelectronica' in acceso_personal):
            ws_info_a.range('Q49').value = row.get('D√≥nde recoger llave/permiso/tarjeta', '')
        
        # Forma de ingresar equipo
        tipo_formaingresar = normaliza_texto(row.get('Forma de ingresar el equipo al sitio es con:', ''))
        ws_info_a.range('U55').value = 'maniobra' in tipo_formaingresar
        ws_info_a.range('AA55').value = 'izajecongarrucha' in tipo_formaingresar
        ws_info_a.range('AG55').value = 'izajecongrua' in tipo_formaingresar
        
        # Requiere gr√∫a
        tipo_requerir_grua = normaliza_texto(row.get('Para instalaci√≥n de gr√∫a, considera necesario que se requiera tramitar permiso con las autoridades locales:', ''))
        ws_info_a.range('AB67').value = 'requieregrua' in tipo_requerir_grua
        ws_info_a.range('AG67').value = 'noaplicagrua' in tipo_requerir_grua
        
        # Requiere gr√∫a (Si/No)
        tipo_requiere_grua = normaliza_texto(row.get('Requiere Grua (Si / No)', ''))
        ws_info_a.range('AC66').value = 'si' in tipo_requiere_grua
        ws_info_a.range('AF66').value = 'no' in tipo_requiere_grua
        
        # Para la llegada al sitio
        tipo_llegar = normaliza_texto(row.get('Para la llegada al sitio con el equipo a instalar, se requiere de:', ''))
        primer_valor = tipo_llegar.split(',')[0].strip() if ',' in tipo_llegar else tipo_llegar.strip()
        primer_tipo = normaliza_texto(primer_valor)
        ws_info_a.range('B72').value = (primer_tipo == 'pickup')
        ws_info_a.range('G72').value = (primer_tipo == 'pickup4x4')
        ws_info_a.range('M72').value = (primer_tipo == 'animalesdecarga')
        
        # Polic√≠a
        policia = normaliza_texto(row.get('Existe cerca del sitio alguna comandancia de polic√≠a o del ejercito?', '').strip().lower())
        ws_info_a.range('AB105').value = 'si' in policia
        ws_info_a.range('AE105').value = 'no' in policia
        
        if 'si' in policia:
            ws_info_a.range('U106').value = row.get('Si la respuesta anterior es si, Indique a que distancia  policia', '')
            ws_info_a.range('U107').value = row.get('Se cuenta con alg√∫n n√∫mero de tel√©fono?, ind√≠quelo', 'N/A') or 'N/A'
        else:
            ws_info_a.range('U106').value = 'N/A'
            ws_info_a.range('U107').value = 'N/A'
        
        # Cruz Roja
        cruzroja = normaliza_texto(row.get('Existe Cruz Roja, Hospital u otro tipo de asistencia medica cerca del sitio.', '').strip().lower())
        ws_info_a.range('AB108').value = 'si' in cruzroja
        ws_info_a.range('AE108').value = 'no' in cruzroja
        
        if 'si' in cruzroja:
            ws_info_a.range('U109').value = row.get('Si la respuesta anterior es si, Indique a que distancia cruz ', '')
            ws_info_a.range('U110').value = row.get('Se cuenta con alg√∫n numero de tel√©fono?, ind√≠quelo: cruz', '')
        else:
            ws_info_a.range('U109').value = 'N/A'
            ws_info_a.range('U110').value = 'N/A'
        
        # Mapa Nacional de Riesgos
        riesgo = normaliza_texto(row.get('Seg√∫n el Mapa Nacional de Riesgos, indique en que zona se ubica el sitio:', '').strip().lower())
        ws_info_a.range('Y111').value = 'bajo' in riesgo
        ws_info_a.range('AB111').value = 'medio' in riesgo
        ws_info_a.range('AE111').value = 'alto' in riesgo
        
        # Informaci√≥n b√°sica del sitio
        ws_info_a.range('B15').value = safe_strip(row.get('LATITUD (TORRE)', ''))
        ws_info_a.range('F15').value = safe_strip(row.get('LONGITUD (TORRE)', ''))
        ws_info_a.range('J15').value = safe_strip(row.get('Altitud (msnm)', ''))
        ws_info_a.range('B17').value = safe_strip(row.get('Nombre de contacto en sitio', ''))
        ws_info_a.range('F17').value = safe_strip(row.get('Telefono', ''))
        
        # Direcci√≥n
        ws_info_a.range('B19').value = safe_strip(row.get('Calle', ''))
        ws_info_a.range('F19').value = safe_strip(row.get('Colonia', ''))
        ws_info_a.range('J19').value = safe_strip(row.get('Municipio', ''))
        ws_info_a.range('N19').value = safe_strip(row.get('C.P', ''))
        
        print("‚úÖ HOJA 1: Informaci√≥n General A completada")
        
        # ===== HOJA 2: INFORMACI√ìN GENERAL B =====
        print("üìã Llenando Hoja 2: Informaci√≥n General B...")
        
        # Tipo de sitio B
        tipo_sitio_b = safe_strip(row.get('Tipo de sitio B', ''))
        ws_info_b.range('D39').value = (tipo_sitio_b == 'torre')
        ws_info_b.range('M39').value = (tipo_sitio_b == 'edificio')
        ws_info_b.range('U39').value = (tipo_sitio_b == 'poste')
        
        # Propietario/Administrador B
        tipo_Propietario_Administrador_b = normaliza_texto(row.get('Propietario_Administrador B', ''))
        ws_info_b.range('K34').value = 'telesite' in tipo_Propietario_Administrador_b
        ws_info_b.range('P34').value = 'ctwr' in tipo_Propietario_Administrador_b
        ws_info_b.range('V34').value = 'mtp' in tipo_Propietario_Administrador_b
        ws_info_b.range('Z34').value = 'intelesites' in tipo_Propietario_Administrador_b
        ws_info_b.range('AE34').value = 'even' in tipo_Propietario_Administrador_b
        ws_info_b.range('A35').value = 'atc' in tipo_Propietario_Administrador_b
        ws_info_b.range('F35').value = 'temm' in tipo_Propietario_Administrador_b
        ws_info_b.range('K35').value = 'renta tower' in tipo_Propietario_Administrador_b
        ws_info_b.range('P35').value = 'torrecom' in tipo_Propietario_Administrador_b
        ws_info_b.range('V35').value = 'uniti' in tipo_Propietario_Administrador_b
        ws_info_b.range('A36').value = 'tower one' in tipo_Propietario_Administrador_b
        ws_info_b.range('F36').value = 'iimt' in tipo_Propietario_Administrador_b
        ws_info_b.range('K36').value = 'servicom' in tipo_Propietario_Administrador_b
        ws_info_b.range('A37').value = 'canadian tower' in tipo_Propietario_Administrador_b
        ws_info_b.range('F37').value = 'mx tower' in tipo_Propietario_Administrador_b
        ws_info_b.range('K37').value = 'cfe' in tipo_Propietario_Administrador_b
        
        # Tipo de sitio B
        tipo_tipositio_b = normaliza_texto(row.get('Tipo de sitio B', ''))
        ws_info_b.range('D39').value = 'terrenogreenfield' in tipo_tipositio_b
        ws_info_b.range('M39').value = 'sobresuelorawland' in tipo_tipositio_b
        ws_info_b.range('U39').value = 'sobreazotea' in tipo_tipositio_b
        
        # Considera accesible B
        tipo_considera_accesible_b = normaliza_texto(row.get('Considera accesible el sitio de d√≠a y de noche? B', ''))
        ws_info_b.range('S43').value = 'solodedia' in tipo_considera_accesible_b
        ws_info_b.range('W43').value = 'solodenoche' in tipo_considera_accesible_b
        ws_info_b.range('AB43').value = 'sinproblemadehora' in tipo_considera_accesible_b
        
        # Zona segura B
        tipo_zonasegura_b = normaliza_texto(row.get('El sitio se encuentra construido en zona segura (De NO derrumbes) B:', ''))
        ws_info_b.range('S44').value = 'si' in tipo_zonasegura_b
        ws_info_b.range('W44').value = 'no' in tipo_zonasegura_b
        
        # Horario controlado B
        tipo_horariocontrolado_b = normaliza_texto(row.get('Horario Controlado B', ''))
        ws_info_b.range('B50').value = 'si' in tipo_horariocontrolado_b
        
        # Acceso al Personal B
        acceso_personal_b = normaliza_texto(row.get('TIPO DE ACCESO A SITIO B', ''))
        ws_info_b.range('B47').value = 'llave' in acceso_personal_b
        ws_info_b.range('H47').value = 'permiso/memorandum' in acceso_personal_b
        ws_info_b.range('R47').value = 'candadodecombinacion' in acceso_personal_b
        ws_info_b.range('B48').value = 'tarjetaelectronica' in acceso_personal_b
        ws_info_b.range('J48').value = 'otro' in acceso_personal_b
        
        # Campos vinculados B
        if 'candadodecombinacion' in acceso_personal_b:
            ws_info_b.range('AF47').value = row.get('Candado de Combinaci√≥n B', '')
            ws_info_b.range('Q48').value = 'N/A'
        elif ('llave' in acceso_personal_b or 'permiso/memorandum' in acceso_personal_b or 'tarjetaelectronica' in acceso_personal_b):
            ws_info_b.range('Q49').value = row.get('D√≥nde recoger llave/permiso/tarjeta B', '')
        
        # Forma de ingresar equipo B
        tipo_formaingresar_b = normaliza_texto(row.get('Forma de ingresar el equipo al sitio es con: B', ''))
        ws_info_b.range('U55').value = 'maniobra' in tipo_formaingresar_b
        ws_info_b.range('AA55').value = 'izajecongarrucha' in tipo_formaingresar_b
        ws_info_b.range('AG55').value = 'izajecongrua' in tipo_formaingresar_b
        
        # Requiere gr√∫a B
        tipo_requerir_grua_b = normaliza_texto(row.get('Para instalaci√≥n de gr√∫a, considera necesario que se requiera tramitar permiso con las autoridades locales: B', ''))
        ws_info_b.range('AB67').value = 'requieregrua' in tipo_requerir_grua_b
        ws_info_b.range('AG67').value = 'noaplicagrua' in tipo_requerir_grua_b
        
        # Requiere gr√∫a (Si/No) B
        tipo_requiere_grua_b = normaliza_texto(row.get('Requiere Grua (Si / No) B', ''))
        ws_info_b.range('AC66').value = 'si' in tipo_requiere_grua_b
        ws_info_b.range('AF66').value = 'no' in tipo_requiere_grua_b
        
        # Para la llegada al sitio B
        tipo_llegar_b = normaliza_texto(row.get('Para la llegada al sitio con el equipo a instalar, se requiere de:', ''))
        primer_valor_b = tipo_llegar_b.split(',')[0].strip() if ',' in tipo_llegar_b else tipo_llegar_b.strip()
        primer_tipo_b = normaliza_texto(primer_valor_b)
        ws_info_b.range('B72').value = (primer_tipo_b == 'pickup')
        ws_info_b.range('G72').value = (primer_tipo_b == 'pickup4x4')
        ws_info_b.range('M72').value = (primer_tipo_b == 'animalesdecarga')
        
        # Polic√≠a B
        policia_b = normaliza_texto(row.get('Existe cerca del sitio alguna comandancia de polic√≠a o del ejercito? B', ''))
        ws_info_b.range('AB105').value = 'si' in policia_b
        ws_info_b.range('AE105').value = 'no' in policia_b
        
        if 'si' in policia_b:
            ws_info_b.range('U106').value = row.get('Si la respuesta anterior es si, Indique a que distancia  policia B', '')
            ws_info_b.range('U107').value = row.get('Se cuenta con alg√∫n numero de tel√©fono?, ind√≠quelo: B', '')
        else:
            ws_info_b.range('U106').value = 'N/A'
            ws_info_b.range('U107').value = 'N/A'
        
        # Cruz Roja B
        cruzroja_b = normaliza_texto(row.get('Existe Cruz Roja, Hospital u otro tipo de asistencia medica cerca del sitio. B', ''))
        ws_info_b.range('AB108').value = 'si' in cruzroja_b
        ws_info_b.range('AE108').value = 'no' in cruzroja_b
        
        if 'si' in cruzroja_b:
            ws_info_b.range('U109').value = row.get('Si la respuesta anterior es si, Indique a que distancia cruz B', '')
            ws_info_b.range('U110').value = row.get('Se cuenta con alg√∫n numero de tel√©fono?, ind√≠quelo: cruz B', '')
        else:
            ws_info_b.range('U109').value = 'N/A'
            ws_info_b.range('U110').value = 'N/A'
        
        # Mapa Nacional de Riesgos B
        riesgo_b = normaliza_texto(row.get('Seg√∫n el Mapa Nacional de Riesgos, indique en que zona se ubica el sitio: B', ''))
        ws_info_b.range('Y111').value = 'bajo' in riesgo_b
        ws_info_b.range('AB111').value = 'medio' in riesgo_b
        ws_info_b.range('AE111').value = 'alto' in riesgo_b
        
        # Informaci√≥n b√°sica del sitio B
        ws_info_b.range('B15').value = safe_strip(row.get('LATITUD (TORRE) 2', ''))
        ws_info_b.range('F15').value = safe_strip(row.get('LONGITUD (TORRE) 2', ''))
        ws_info_b.range('J15').value = safe_strip(row.get('Altitud (msnm) 2', ''))
        ws_info_b.range('B17').value = safe_strip(row.get('Nombre de contacto en sitio 2', ''))
        ws_info_b.range('F17').value = safe_strip(row.get('Telefono 2', ''))
        
        # Direcci√≥n B
        ws_info_b.range('B19').value = safe_strip(row.get('Calle 2', ''))
        ws_info_b.range('F19').value = safe_strip(row.get('Colonia 2', ''))
        ws_info_b.range('J19').value = safe_strip(row.get('Municipio 2', ''))
        ws_info_b.range('N19').value = safe_strip(row.get('C.P 2', ''))
        
        print("‚úÖ HOJA 2: Informaci√≥n General B completada")
        
        # ===== HOJA 3: ESPACIOS EN TORRE Y PISO A-B =====
        print("üìã Llenando Hoja 3: Espacios en Torre y Piso A-B...")
        
        # Tipo de torre
        tipo_torre = normaliza_texto(row.get('Tipo de Torre', ''))
        ws_espacios.range('G8').value = tipo_torre == 'autosoportada'
        ws_espacios.range('O8').value = tipo_torre == 'arriostrada'
        ws_espacios.range('V8').value = tipo_torre == 'Monopolo'
        ws_espacios.range('AB8').value = tipo_torre == 'Minipolo'
        ws_espacios.range('AG8').value = tipo_torre == 'otro'
        
        # Espacio disponible de conexi√≥n
        espacio_disponible = normaliza_texto(row.get('¬øEspacio disponible de conexi√≥n?', ''))
        ws_espacios.range('AH25').value = espacio_disponible == 'si'
        ws_espacios.range('AK25').value = espacio_disponible == 'no'
        ws_espacios.range('U14').value = espacio_disponible == 'si'
        ws_espacios.range('Y14').value = espacio_disponible == 'no'
        
        # Existe breaker
        existe_break = normaliza_texto(row.get('¬øExiste algun breaker existente en sitio? ', ''))
        ws_espacios.range('Y21').value = existe_break == 'si'
        ws_espacios.range('AB21').value = existe_break == 'no'
        
        # Alimentaci√≥n compatible
        alimentacion_compatible = normaliza_texto(row.get('Alimentacion compatible con el equipamiento ', ''))
        ws_espacios.range('Y25').value = alimentacion_compatible == 'si'
        ws_espacios.range('AB25').value = alimentacion_compatible == 'no'
        
        # Sistema el√©ctrico
        sistema_electrico = normaliza_texto(row.get('SISTEMA ELECTRICO', ''))
        ws_espacios.range('AG21').value = 'monofasica' in sistema_electrico
        ws_espacios.range('AL21').value = 'bifasica' in sistema_electrico
        
        # Cara propuesta
        cara_propuesta = normaliza_texto(row.get('Cara de preparaci√≥n para cableado vertical en torre', ''))
        ws_espacios.range('Y16').value = cara_propuesta == 'a'
        ws_espacios.range('AC16').value = cara_propuesta == 'b'
        ws_espacios.range('AE16').value = cara_propuesta == 'c'
        ws_espacios.range('AN16').value = cara_propuesta == 'd'
        
        # Barra de tierra
        barra_tierra = normaliza_texto(row.get('Barra de Tierra', ''))
        ws_espacios.range('O27').value = barra_tierra == 'si'
        ws_espacios.range('R27').value = barra_tierra == 'no'
        
        # Tipo de soluci√≥n
        tipo_solucion = normaliza_texto(row.get('Tipo de Solucion', ''))
        ws_espacios.range('O29').value = tipo_solucion == 'piso'
        ws_espacios.range('R29').value = tipo_solucion == 'torre'
        
        # Informaci√≥n de torre y sitio
        ws_espacios.range('K8').value = safe_strip(row.get('NOMBRE DEL SITIO', ''))
        ws_espacios.range('H33').value = safe_strip(row.get('NOMBRE DEL SITIO', ''))
        ws_espacios.range('M117').value = safe_strip(row.get('Nombre del sitio A', ''))
        ws_espacios.range('M139').value = safe_strip(row.get('Nombre del sitio A', ''))
        ws_espacios.range('M162').value = safe_strip(row.get('Nombre del sitio B', ''))
        ws_espacios.range('M184').value = safe_strip(row.get('Nombre del sitio B', ''))
        
        # Informaci√≥n t√©cnica de torre
        ws_espacios.range('B15').value = safe_strip(row.get('Tipo de Torre', ''))
        ws_espacios.range('F15').value = safe_strip(row.get('Altura de la Torre', ''))
        ws_espacios.range('J15').value = safe_strip(row.get('Dado', ''))
        ws_espacios.range('N15').value = safe_strip(row.get('Diametro de pierna Inferior', ''))
        ws_espacios.range('R15').value = safe_strip(row.get('Diametro de pierna superior', ''))
        
        # Tipo de torre 2
        tipo_torre2 = normaliza_texto(row.get('Tipo de Torre2', ''))
        ws_espacios.range('G32').value = tipo_torre2 == 'autosoportada'
        ws_espacios.range('O32').value = tipo_torre2 == 'arriostrada'
        ws_espacios.range('V32').value = tipo_torre2 == 'monopolo'
        ws_espacios.range('AB32').value = tipo_torre2 == 'minipolo'
        ws_espacios.range('AG32').value = tipo_torre2 == 'otro'
        
        # Espacio disponible 2
        espacio_disponible2 = normaliza_texto(row.get('¬øEspacio disponible de conexi√≥n?2', ''))
        ws_espacios.range('U38').value = espacio_disponible2 == 'si'
        ws_espacios.range('Y38').value = espacio_disponible2 == 'no'
        
        # Cara preparaci√≥n 2
        cara_preparacion2 = normaliza_texto(row.get('Cara de preparaci√≥n para cableado vertical en torre 2', ''))
        ws_espacios.range('Y40').value = cara_preparacion2 == 'a'
        ws_espacios.range('AD40').value = cara_preparacion2 == 'b'
        ws_espacios.range('AI40').value = cara_preparacion2 == 'c'
        ws_espacios.range('AN40').value = cara_preparacion2 == 'd'
        
        # Existe tierra 2
        existe_tierra2 = normaliza_texto(row.get('Existe Barra de Tierras 2', ''))
        ws_espacios.range('O51').value = existe_tierra2 == 'si'
        ws_espacios.range('R51').value = existe_tierra2 == 'no'
        
        # Tipo soluci√≥n 2
        tipo_solucion2 = normaliza_texto(row.get('Tipo de solucion 2', ''))
        ws_espacios.range('O53').value = tipo_solucion2 == 'piso'
        ws_espacios.range('R53').value = tipo_solucion2 == 'torre'
        
        # Existe breaker 2
        existe_break2 = normaliza_texto(row.get('Existe algun breaker existente en sitio 2 ', ''))
        ws_espacios.range('Y45').value = existe_break2 == 'si'
        ws_espacios.range('AB45').value = existe_break2 == 'no'
        
        # Alimentaci√≥n existente 2
        alimenacion_existente2 = normaliza_texto(row.get('SISTEMA ELECTRICO 2', ''))
        ws_espacios.range('AG45').value = 'monofasica' in alimenacion_existente2
        ws_espacios.range('AL45').value = 'bifasica' in alimenacion_existente2
        
        # Alimentaci√≥n compatible 2
        alimenacion_compatible2 = normaliza_texto(row.get('Alimentacion compatible con el equipamiento 2', ''))
        ws_espacios.range('Y49').value = alimenacion_compatible2 == 'si'
        ws_espacios.range('AB49').value = alimenacion_compatible2 == 'no'
        
        # Espacio conexi√≥n 2
        espacio_conexion2 = normaliza_texto(row.get('¬øEspacio disponible de conexi√≥n? 2', ''))
        ws_espacios.range('AH49').value = espacio_conexion2 == 'si'
        ws_espacios.range('AK49').value = espacio_conexion2 == 'no'
        
        # L√≠nea de vista
        linea_vista = normaliza_texto(row.get('Linea de vista ', ''))
        motivo = normaliza_texto(row.get('Motivo ', ''))
        
        ws_espacios.range('R56').value = (linea_vista == 'si')
        ws_espacios.range('V56').value = (linea_vista == 'no')
        ws_espacios.range('Q57').value = False
        ws_espacios.range('V57').value = False
        ws_espacios.range('AC57').value = False
        ws_espacios.range('AI57').value = False
        ws_espacios.range('C58').value = False
        
        if linea_vista == 'no':
            if motivo == 'arboles':
                ws_espacios.range('Q57').value = True
            elif motivo == 'espectacular':
                ws_espacios.range('V57').value = True
            elif motivo == 'edificio':
                ws_espacios.range('AC57').value = True
            elif motivo == 'monta√±a':
                ws_espacios.range('AI57').value = True
            elif motivo == 'n/a':
                ws_espacios.range('C58').value = True
        
        print("‚úÖ HOJA 3: Espacios en Torre y Piso A-B completada")
        
        # ===== HOJA 4: PLANOS A =====
        print("üìã Llenando Hoja 4: Planos A...")
        
        # Informaci√≥n de planos del sitio A
        ws_planos_a.range('B15').value = safe_strip(row.get('PLANOS', ''))
        ws_planos_a.range('F15').value = safe_strip(row.get('Tipo de Torre', ''))
        ws_planos_a.range('J15').value = safe_strip(row.get('Altura de la Torre', ''))
        ws_planos_a.range('N15').value = safe_strip(row.get('Dado', ''))
        ws_planos_a.range('R15').value = safe_strip(row.get('PROPIETARIO', ''))
        ws_planos_a.range('V15').value = safe_strip(row.get('TIPO DE SITIO ', ''))
        
        # Informaci√≥n de acceso y permisos
        ws_planos_a.range('B20').value = safe_strip(row.get('Como o donde obtener permisos/llave/tarjeta', ''))
        ws_planos_a.range('F20').value = safe_strip(row.get('Contacto solicitud de accesos', ''))
        ws_planos_a.range('J20').value = safe_strip(row.get('Horario de solicitud de accesos', ''))
        
        print("‚úÖ HOJA 4: Planos A completada")
        
        # ===== HOJA 5: PLANOS B =====
        print("üìã Llenando Hoja 5: Planos B...")
        
        # Informaci√≥n de planos del sitio B
        ws_planos_b.range('B15').value = safe_strip(row.get('PLANOS', ''))
        ws_planos_b.range('F15').value = safe_strip(row.get('Tipo de Torre2', ''))
        ws_planos_b.range('J15').value = safe_strip(row.get('Altura torre 2', ''))
        ws_planos_b.range('N15').value = safe_strip(row.get('DADO 2', ''))
        ws_planos_b.range('R15').value = safe_strip(row.get('PROPIETARIO 2', ''))
        ws_planos_b.range('V15').value = safe_strip(row.get('TIPO DE SITIO 2', ''))
        
        print("‚úÖ HOJA 5: Planos B completada")
        print(f"üîç RESUMEN HOJA 5:")
        print(f"   - PLANOS: {ws_planos_b.range('B15').value}")
        print(f"   - Tipo de Torre2: {ws_planos_b.range('F15').value}")
        print(f"   - PROPIETARIO 2: {ws_planos_b.range('R15').value}")
        
        # ===== HOJA 6: REPORTE FOTOS A =====
        print("üìã Llenando Hoja 6: Reporte Fotos A...")
        
        # Informaci√≥n de fotos del sitio A
        ws_fotos_a.range('B15').value = safe_strip(row.get('NOMBRE DEL SITIO', ''))
        ws_fotos_a.range('F15').value = safe_strip(row.get('ID', ''))
        ws_fotos_a.range('J15').value = safe_strip(row.get('ESTADO ', ''))
        ws_fotos_a.range('N15').value = safe_strip(row.get('CLUSTER', ''))
        ws_fotos_a.range('R15').value = safe_strip(row.get('Fecha Site Survey', ''))
        
        print("‚úÖ HOJA 6: Reporte Fotos A completada")
        print(f"üîç RESUMEN HOJA 6:")
        print(f"   - NOMBRE DEL SITIO: {ws_fotos_a.range('B15').value}")
        print(f"   - ID: {ws_fotos_a.range('F15').value}")
        print(f"   - ESTADO: {ws_fotos_a.range('J15').value}")
        
        # ===== HOJA 7: REPORTE FOTOS B =====
        print("üìã Llenando Hoja 7: Reporte Fotos B...")
        
        # Informaci√≥n de fotos del sitio B
        ws_fotos_b.range('B15').value = safe_strip(row.get('Nombre del sitio 2', ''))
        ws_fotos_b.range('F15').value = safe_strip(row.get('ID 2', ''))
        ws_fotos_b.range('J15').value = safe_strip(row.get('ESTADO 2 ', ''))
        ws_fotos_b.range('N15').value = safe_strip(row.get('CLUSTER', ''))
        ws_fotos_b.range('R15').value = safe_strip(row.get('Fecha Site Survey', ''))
        
        print("‚úÖ HOJA 7: Reporte Fotos B completada")
        print(f"üîç RESUMEN HOJA 7:")
        print(f"   - Nombre del sitio 2: {ws_fotos_b.range('B15').value}")
        print(f"   - ID 2: {ws_fotos_b.range('F15').value}")
        print(f"   - ESTADO 2: {ws_fotos_b.range('J15').value}")
        
        # ===== RESUMEN FINAL =====
        print("üéØ RESUMEN FINAL DEL LLENADO COMPLETO:")
        print(f"‚úÖ TODAS LAS HOJAS LLENADAS CORRECTAMENTE:")
        print(f"   - Hoja 1: Informaci√≥n General A ‚úì")
        print(f"   - Hoja 2: Informaci√≥n General B ‚úì")
        print(f"   - Hoja 3: Espacios en Torre y Piso A-B ‚úì")
        print(f"   - Hoja 4: Planos A ‚úì")
        print(f"   - Hoja 5: Planos B ‚úì")
        print(f"   - Hoja 6: Reporte Fotos A ‚úì")
        print(f"   - Hoja 7: Reporte Fotos B ‚úì")
        print(f"üéâ SITE SURVEY COMPLETAMENTE LLENADO PARA ID: {user_id}")
        
        return True
        
    except Exception as e:
        print(f"‚ùå ERROR en llenado completo del Site Survey: {e}")
        import traceback
        traceback.print_exc()
        return False


@app.route('/save-design-file', methods=['POST'])
@error_handler
def handle_save_design_file():
    """
    Guarda un archivo de dise√±o de soluci√≥n generado
    """
    try:
        data = request.get_json()
        user_id = data.get('user_id')
        tipo = data.get('tipo', 'diseno_solucion')
        fila_idx = data.get('fila_idx', '0')
        
        print(f"üìÅ Guardando archivo de dise√±o para ID: {user_id}")
        
        # Buscar el archivo generado m√°s reciente para este user_id
        base_dir = os.path.dirname(os.path.abspath(__file__))
        
        # Buscar en diferentes ubicaciones posibles
        posibles_ubicaciones = [
            os.path.join(base_dir, 'archivos_generados'),
            os.path.join(base_dir, 'generated_files'),
            os.path.join(base_dir, 'saved_files'),
            base_dir
        ]
        
        archivo_encontrado = None
        patron_busqueda = f"*{user_id}*diseno*.xlsx"
        
        for ubicacion in posibles_ubicaciones:
            if os.path.exists(ubicacion):
                archivos = glob.glob(os.path.join(ubicacion, patron_busqueda))
                if archivos:
                    # Tomar el archivo m√°s reciente
                    archivo_encontrado = max(archivos, key=os.path.getctime)
                    break
        
        if archivo_encontrado:
            # Crear directorio de archivos guardados si no existe
            directorio_guardados = os.path.join(base_dir, 'saved_files')
            os.makedirs(directorio_guardados, exist_ok=True)
            
            # Generar nombre √∫nico para el archivo guardado
            from datetime import datetime
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            nombre_guardado = f"saved_{user_id}_{tipo}_{timestamp}.xlsx"
            ruta_guardado = os.path.join(directorio_guardados, nombre_guardado)
            
            # Copiar archivo a la ubicaci√≥n de guardados
            import shutil
            shutil.copy2(archivo_encontrado, ruta_guardado)
            
            print(f"‚úÖ Archivo guardado exitosamente: {ruta_guardado}")
            
            return jsonify({
                'success': True,
                'message': 'Archivo guardado exitosamente',
                'ubicacion': ruta_guardado,
                'archivo_original': archivo_encontrado,
                'timestamp': timestamp
            })
        else:
            print(f"‚ö†Ô∏è No se encontr√≥ archivo generado para ID: {user_id}")
            return jsonify({
                'success': False,
                'error': f'No se encontr√≥ archivo generado para el ID: {user_id}'
            })
            
    except Exception as e:
        print(f"‚ùå Error guardando archivo de dise√±o: {e}")
        return jsonify({
            'success': False,
            'error': str(e)
        })


@app.route('/buscar_opciones_id', methods=['POST'])
@error_handler
def buscar_opciones_id():
    """
    Busca todas las opciones disponibles para un ID espec√≠fico
    """
    try:
        data = request.get_json()
        user_id = data.get('user_id')
        
        if not user_id:
            return jsonify({'success': False, 'error': 'ID requerido'})
        
        print(f"üîç Buscando opciones para ID: {user_id}")
        
        # Obtener el DataFrame con cach√©
        df_db = get_cached_dataframe()
        
        if df_db is None or df_db.empty:
            return jsonify({'success': False, 'error': 'No se pudo cargar la base de datos'})
        
        # Buscar todas las filas que coincidan con el ID (exacto o similar)
        opciones_encontradas = []
        
        # B√∫squeda exacta primero
        mask_exacto = df_db['ID'].astype(str) == str(user_id)
        filas_exactas = df_db[mask_exacto]
        
        if not filas_exactas.empty:
            for idx, row in filas_exactas.iterrows():
                opcion = {
                    'user_id': str(row.get('ID', '')),
                    'fila_idx': str(idx),
                    'nombre_a': str(row.get('Nombre del sitio A', row.get('NOMBRE DEL SITIO', 'Sin nombre'))),
                    'nombre_b': str(row.get('Nombre del sitio B', row.get('Nombre del sitio 2', 'Sin nombre'))),
                    'tipo_match': 'exacto'
                }
                opciones_encontradas.append(opcion)
        
        # Si no hay coincidencias exactas, buscar similares
        if not opciones_encontradas:
            # Buscar IDs que contengan el user_id o viceversa
            mask_similar = df_db['ID'].astype(str).str.contains(str(user_id), case=False, na=False) | \
                          df_db['ID'].astype(str).apply(lambda x: str(user_id) in str(x))
            filas_similares = df_db[mask_similar]
            
            if not filas_similares.empty:
                for idx, row in filas_similares.iterrows():
                    opcion = {
                        'user_id': str(row.get('ID', '')),
                        'fila_idx': str(idx),
                        'nombre_a': str(row.get('Nombre del sitio A', row.get('NOMBRE DEL SITIO', 'Sin nombre'))),
                        'nombre_b': str(row.get('Nombre del sitio B', row.get('Nombre del sitio 2', 'Sin nombre'))),
                        'tipo_match': 'similar'
                    }
                    opciones_encontradas.append(opcion)
        
        print(f"‚úÖ Encontradas {len(opciones_encontradas)} opciones para ID: {user_id}")
        
        if opciones_encontradas:
            return jsonify({
                'success': True,
                'opciones': opciones_encontradas,
                'total': len(opciones_encontradas),
                'id_buscado': user_id
            })
        else:
            return jsonify({
                'success': False,
                'error': f'No se encontraron opciones para el ID: {user_id}',
                'opciones': [],
                'total': 0
            })
            
    except Exception as e:
        print(f"‚ùå Error buscando opciones para ID: {e}")
        import traceback
        traceback.print_exc()
        return jsonify({
            'success': False,
            'error': f'Error interno: {str(e)}'
        })


@app.route('/obtener_info_id', methods=['POST'])
@error_handler
def obtener_info_id():
    """
    Obtiene informaci√≥n actualizada de un ID espec√≠fico
    """
    try:
        data = request.get_json()
        user_id = data.get('user_id')
        fila_idx = data.get('fila_idx')
        
        if not user_id:
            return jsonify({'success': False, 'error': 'ID requerido'})
        
        print(f"üìä Obteniendo informaci√≥n actualizada para ID: {user_id}")
        
        # Obtener el DataFrame con cach√©
        df_db = get_cached_dataframe()
        
        if df_db is None or df_db.empty:
            return jsonify({'success': False, 'error': 'No se pudo cargar la base de datos'})
        
        # Buscar la informaci√≥n del ID
        try:
            if fila_idx and fila_idx.isdigit():
                # Usar √≠ndice de fila si est√° disponible
                fila_idx_int = int(fila_idx)
                if fila_idx_int < len(df_db):
                    row = df_db.iloc[fila_idx_int]
                else:
                    # Si el √≠ndice no es v√°lido, buscar por ID
                    mask = df_db['ID'].astype(str) == str(user_id)
                    matches = df_db[mask]
                    if not matches.empty:
                        row = matches.iloc[0]
                    else:
                        return jsonify({'success': False, 'error': f'No se encontr√≥ informaci√≥n para el ID: {user_id}'})
            else:
                # Buscar por ID
                mask = df_db['ID'].astype(str) == str(user_id)
                matches = df_db[mask]
                if not matches.empty:
                    row = matches.iloc[0]
                else:
                    return jsonify({'success': False, 'error': f'No se encontr√≥ informaci√≥n para el ID: {user_id}'})
            
            # Extraer informaci√≥n
            info = {
                'user_id': str(row.get('ID', user_id)),
                'nombre_a': str(row.get('Nombre del sitio A', row.get('NOMBRE DEL SITIO', 'Sin nombre'))),
                'nombre_b': str(row.get('Nombre del sitio B', row.get('Nombre del sitio 2', 'Sin nombre'))),
                'estado': str(row.get('ESTADO', 'N/A')),
                'cluster': str(row.get('CLUSTER', 'N/A')),
                'fecha_survey': str(row.get('Fecha Site Survey', 'N/A'))
            }
            
            print(f"‚úÖ Informaci√≥n obtenida para ID {user_id}: {info['nombre_a']} - {info['nombre_b']}")
            
            return jsonify({
                'success': True,
                **info
            })
            
        except Exception as e:
            print(f"‚ùå Error procesando informaci√≥n del ID {user_id}: {e}")
            return jsonify({'success': False, 'error': f'Error procesando informaci√≥n: {str(e)}'})
            
    except Exception as e:
        print(f"‚ùå Error obteniendo informaci√≥n del ID: {e}")
        return jsonify({
            'success': False,
            'error': f'Error interno: {str(e)}'
        })


@app.route('/subir_formato_kmz', methods=['POST'])
@error_handler
def subir_formato_kmz():
    """
    Endpoint para subir archivo KMZ + imagen y colocarlos en Excel
    KMZ ‚Üí C12, Imagen ‚Üí B21:G42 en hoja "3. Formato KMZ"
    """
    try:
        print("üó∫Ô∏è === INICIANDO SUBIDA DE FORMATO KMZ ===")
        
        # Obtener datos del formulario
        user_id = request.form.get('user_id')
        fila_idx = request.form.get('fila_idx')
        
        if not user_id:
            return jsonify({'success': False, 'error': 'Falta el user_id'})
        
        print(f"üë§ User ID: {user_id}")
        print(f"üìç Fila: {fila_idx}")
        
        # Obtener los archivos
        archivo_kmz = request.files.get('archivo_kmz')
        imagen_kmz = request.files.get('imagen_kmz')
        
        # Validar que ambos archivos est√©n presentes
        if not archivo_kmz or archivo_kmz.filename == '':
            return jsonify({'success': False, 'error': 'Falta el archivo KMZ'})
        
        if not imagen_kmz or imagen_kmz.filename == '':
            return jsonify({'success': False, 'error': 'Falta la imagen'})
        
        # Validar tipos de archivo
        valid_kmz_extensions = ['.kmz', '.kml']
        kmz_extension = '.' + archivo_kmz.filename.split('.')[-1].lower()
        if kmz_extension not in valid_kmz_extensions:
            return jsonify({'success': False, 'error': 'El archivo debe ser KMZ o KML'})
        
        if not imagen_kmz.content_type.startswith('image/'):
            return jsonify({'success': False, 'error': 'El segundo archivo debe ser una imagen'})
        
        print("‚úÖ Ambos archivos recibidos y validados")
        
        # Crear directorio PERMANENTE para archivos KMZ
        base_dir = os.path.dirname(os.path.abspath(__file__))
        kmz_dir = os.path.join(base_dir, 'archivos_permanentes', 'formato_kmz', user_id)
        os.makedirs(kmz_dir, exist_ok=True)
        print(f"üìÅ Directorio permanente creado: {kmz_dir}")
        
        # Guardar archivos
        from datetime import datetime
        timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
        
        # Nombres de archivos
        kmz_filename = f"formato_kmz_{user_id}_{timestamp}.{archivo_kmz.filename.split('.')[-1]}"
        imagen_filename = f"imagen_kmz_{user_id}_{timestamp}.{imagen_kmz.filename.split('.')[-1]}"
        
        # Rutas completas
        kmz_path = os.path.join(kmz_dir, kmz_filename)
        imagen_path = os.path.join(kmz_dir, imagen_filename)
        
        # Guardar archivos
        archivo_kmz.save(kmz_path)
        imagen_kmz.save(imagen_path)
        
        print(f"üíæ Archivo KMZ guardado: {kmz_filename}")
        print(f"üíæ Imagen guardada: {imagen_filename}")
        
        # Buscar archivo Excel de dise√±o de soluci√≥n
        archivos_generados_dir = os.path.join(base_dir, 'archivos_generados')
        archivos_permanentes_dir = os.path.join(base_dir, 'archivos_permanentes')
        import glob
        
        # Limpiar user_id para b√∫squeda
        user_id_limpio = re.sub(r'[<>:"/\\|?*]', '', str(user_id))
        print(f"üîç Buscando Excel para user_id: {user_id} (limpio: {user_id_limpio})")
        
        # Buscar en archivos_generados primero
        patron_excel = f"ds_diseno_solucion_{user_id_limpio}*.xlsx"
        archivos_excel = glob.glob(os.path.join(archivos_generados_dir, patron_excel))
        
        # Si no encuentra, buscar en archivos_permanentes
        if not archivos_excel:
            patron_permanente = f"PERMANENTE_ds_diseno_solucion_{user_id_limpio}*.xlsx"
            archivos_excel = glob.glob(os.path.join(archivos_permanentes_dir, patron_permanente))
        
        if not archivos_excel:
            return jsonify({'success': False, 'error': f'No se encontr√≥ archivo Excel de dise√±o de soluci√≥n para el ID {user_id}'})
        
        # Usar el archivo m√°s reciente
        archivo_excel = max(archivos_excel, key=os.path.getmtime)
        print(f"üìä Excel seleccionado: {os.path.basename(archivo_excel)}")
        
        # Copiar archivos junto al Excel para distribuci√≥n
        excel_dir = os.path.dirname(archivo_excel)
        
        kmz_junto_excel = os.path.join(excel_dir, f"KMZ_{kmz_filename}")
        imagen_junto_excel = os.path.join(excel_dir, f"IMG_{imagen_filename}")
        
        try:
            import shutil
            shutil.copy2(kmz_path, kmz_junto_excel)
            shutil.copy2(imagen_path, imagen_junto_excel)
            print(f"üìã Archivos copiados junto al Excel")
        except Exception as copy_error:
            print(f"‚ö†Ô∏è Error copiando archivos junto al Excel: {copy_error}")
            # Usar rutas originales como respaldo
            kmz_junto_excel = kmz_path
            imagen_junto_excel = imagen_path
        
        # INSERTAR ARCHIVOS EN EXCEL CON XLWINGS
        print(f"üìä Insertando archivos en Excel usando xlwings...")
        
        try:
            import xlwings as xw
            
            # Abrir Excel
            print(f"üîß Abriendo Excel...")
            app_excel = xw.App(visible=True, add_book=False)  # Visible para mejor estabilidad
            wb = app_excel.books.open(archivo_excel)
            
            # Verificar hoja destino
            destino_hoja = "3. Formato KMZ"
            if destino_hoja not in [sheet.name for sheet in wb.sheets]:
                wb.close()
                app_excel.quit()
                return jsonify({'success': False, 'error': f'No se encontr√≥ la hoja "{destino_hoja}" en el Excel'})
            
            ws = wb.sheets[destino_hoja]
            print(f"‚úÖ Hoja '{destino_hoja}' encontrada")
            
            resultados = []
            
            # 1. INSERTAR HIPERV√çNCULO KMZ EN C12
            try:
                print(f"üìÑ Embebiendo archivo KMZ como objeto OLE en celda C12")
                
                # Obtener posici√≥n de la celda
                celda_kmz = ws.range('C12')
                
                try:
                    # Usar API de Excel para insertar objeto embebido
                    xl_sheet = ws.api
                    
                    # Insertar archivo KMZ como objeto OLE embebido
                    ole_object = xl_sheet.OLEObjects().Add(
                        Filename=kmz_path,  # Usar archivo original
                        Link=False,  # False = embebido (va dentro del Excel)
                        DisplayAsIcon=True,  # Mostrar como icono
                        IconFileName="",  # Usar icono predeterminado
                        IconIndex=0,
                        IconLabel=f"üó∫Ô∏è {archivo_kmz.filename}",  # Etiqueta del icono
                        Left=celda_kmz.left,
                        Top=celda_kmz.top,
                        Width=200,
                        Height=50
                    )
                    
                    print(f"‚úÖ Archivo KMZ embebido como objeto OLE en C12")
                    
                except Exception as ole_kmz_error:
                    print(f"‚ö†Ô∏è Error embebiendo KMZ como OLE: {ole_kmz_error}")
                    print(f"üîÑ Insertando solo texto como alternativa...")
                    
                    # Alternativa: insertar solo texto descriptivo
                    celda_kmz.value = f"üó∫Ô∏è {archivo_kmz.filename}"
                    celda_kmz.font.bold = True
                    celda_kmz.font.color = (139, 69, 19)  # Marr√≥n para KMZ
                    print(f"‚úÖ Texto KMZ insertado en C12: {archivo_kmz.filename}")
                resultados.append({
                    'tipo': 'KMZ',
                    'destino': 'C12',
                    'archivo': archivo_kmz.filename,
                    'success': True
                })
                
            except Exception as kmz_error:
                print(f"‚ùå Error insertando KMZ: {kmz_error}")
                resultados.append({
                    'tipo': 'KMZ',
                    'destino': 'C12',
                    'archivo': archivo_kmz.filename,
                    'success': False,
                    'error': str(kmz_error)
                })
            
            # 2. INSERTAR IMAGEN EN RANGO B21:G42
            try:
                print(f"üñºÔ∏è Insertando imagen en rango B21:G42")
                
                # Definir rango para la imagen
                rango_imagen = 'B21:G42'
                rango_obj = ws.range(rango_imagen)
                
                # Insertar imagen en el rango
                picture = ws.pictures.add(
                    imagen_junto_excel,
                    left=rango_obj.left,
                    top=rango_obj.top,
                    width=rango_obj.width,
                    height=rango_obj.height
                )
                
                print(f"‚úÖ Imagen insertada exitosamente en {rango_imagen}")
                resultados.append({
                    'tipo': 'Imagen',
                    'destino': rango_imagen,
                    'archivo': imagen_kmz.filename,
                    'success': True
                })
                
            except Exception as imagen_error:
                print(f"‚ùå Error insertando imagen: {imagen_error}")
                resultados.append({
                    'tipo': 'Imagen',
                    'destino': 'B21:G42',
                    'archivo': imagen_kmz.filename,
                    'success': False,
                    'error': str(imagen_error)
                })
            
            # Guardar Excel
            print(f"üíæ Guardando Excel...")
            wb.save()
            print(f"‚úÖ Excel guardado exitosamente")
            
            # Cerrar Excel
            print(f"üîí Cerrando Excel...")
            wb.close()
            app_excel.quit()
            print(f"‚úÖ Excel cerrado correctamente")
            
            # Contar √©xitos
            exitos = sum(1 for r in resultados if r['success'])
            
            # Preparar respuesta
            response_data = {
                'success': True,
                'message': f'{exitos}/2 archivos insertados exitosamente en la hoja "{destino_hoja}"',
                'archivos_procesados': 2,
                'resultados': resultados,
                'kmz_celda': 'C12',
                'imagen_rango': 'B21:G42',
                'hoja': destino_hoja
            }
            
            print(f"üì§ Enviando respuesta exitosa: {exitos}/2 archivos")
            return jsonify(response_data)
            
        except Exception as excel_error:
            print(f"‚ùå Error con xlwings: {excel_error}")
            try:
                if 'wb' in locals():
                    wb.close()
                if 'app_excel' in locals():
                    app_excel.quit()
            except:
                pass
            return jsonify({'success': False, 'error': f'Error integrando archivos en Excel: {str(excel_error)}'})
        
    except Exception as e:
        print(f"‚ùå Error general subiendo formato KMZ: {e}")
        import traceback
        traceback.print_exc()
        return jsonify({
            'success': False,
            'error': f'Error interno: {str(e)}'
        })

@app.route('/subir_imagenes_electricas', methods=['POST'])
@error_handler
def subir_imagenes_electricas():
    """
    Endpoint para subir 3 im√°genes el√©ctricas y colocarlas en Excel
    Rangos: C14:D20, E14:G20, B39:G55
    """
    try:
        print("üñºÔ∏è === INICIANDO SUBIDA DE IM√ÅGENES EL√âCTRICAS ===")
        
        # Obtener datos del formulario
        user_id = request.form.get('user_id')
        fila_idx = request.form.get('fila_idx')
        
        if not user_id:
            return jsonify({'success': False, 'error': 'Falta el user_id'})
        
        print(f"üë§ User ID: {user_id}")
        print(f"üìç Fila: {fila_idx}")
        
        # Obtener las 3 im√°genes
        imagen_consumo1 = request.files.get('imagen_consumo1')
        imagen_consumo2 = request.files.get('imagen_consumo2')
        imagen_pathloss = request.files.get('imagen_pathloss')
        
        # Validar que todas las im√°genes est√©n presentes
        imagenes = [
            ('Consumo energ√≠a 1', imagen_consumo1),
            ('Consumo energ√≠a 2', imagen_consumo2),
            ('Simulaci√≥n pathloss', imagen_pathloss)
        ]
        
        for nombre, imagen in imagenes:
            if not imagen or imagen.filename == '':
                return jsonify({'success': False, 'error': f'Falta la imagen: {nombre}'})
            
            # Validar tipo de archivo
            if not imagen.content_type.startswith('image/'):
                return jsonify({'success': False, 'error': f'{nombre}: Solo se permiten archivos de imagen'})
        
        print("‚úÖ Todas las im√°genes recibidas y validadas")
        
        # Crear directorio PERMANENTE para im√°genes
        base_dir = os.path.dirname(os.path.abspath(__file__))
        imagenes_dir = os.path.join(base_dir, 'archivos_permanentes', 'imagenes_electricas', user_id)
        os.makedirs(imagenes_dir, exist_ok=True)
        print(f"üìÅ Directorio permanente creado: {imagenes_dir}")
        
        # Guardar im√°genes y preparar datos
        from datetime import datetime
        timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
        
        imagenes_guardadas = []
        nombres_archivos = [
            f"consumo_energia1_{user_id}_{timestamp}.{imagen_consumo1.filename.split('.')[-1]}",
            f"consumo_energia2_{user_id}_{timestamp}.{imagen_consumo2.filename.split('.')[-1]}",
            f"simulacion_pathloss_{user_id}_{timestamp}.{imagen_pathloss.filename.split('.')[-1]}"
        ]
        
        # Guardar cada imagen
        for i, (nombre, imagen) in enumerate(imagenes):
            archivo_path = os.path.join(imagenes_dir, nombres_archivos[i])
            imagen.save(archivo_path)
            imagenes_guardadas.append({
                'nombre': nombre,
                'archivo_original': imagen.filename,
                'archivo_guardado': nombres_archivos[i],
                'ruta_completa': archivo_path
            })
            print(f"üíæ {nombre} guardada: {nombres_archivos[i]}")
        
        # Buscar archivo Excel de dise√±o de soluci√≥n
        archivos_generados_dir = os.path.join(base_dir, 'archivos_generados')
        archivos_permanentes_dir = os.path.join(base_dir, 'archivos_permanentes')
        import glob
        
        # Limpiar user_id para b√∫squeda
        user_id_limpio = re.sub(r'[<>:"/\\|?*]', '', str(user_id))
        print(f"üîç Buscando Excel para user_id: {user_id} (limpio: {user_id_limpio})")
        
        # Buscar en archivos_generados primero
        patron_excel = f"ds_diseno_solucion_{user_id_limpio}*.xlsx"
        archivos_excel = glob.glob(os.path.join(archivos_generados_dir, patron_excel))
        
        # Si no encuentra, buscar en archivos_permanentes
        if not archivos_excel:
            patron_permanente = f"PERMANENTE_ds_diseno_solucion_{user_id_limpio}*.xlsx"
            archivos_excel = glob.glob(os.path.join(archivos_permanentes_dir, patron_permanente))
        
        if not archivos_excel:
            return jsonify({'success': False, 'error': f'No se encontr√≥ archivo Excel de dise√±o de soluci√≥n para el ID {user_id}'})
        
        # Usar el archivo m√°s reciente
        archivo_excel = max(archivos_excel, key=os.path.getmtime)
        print(f"üìä Excel seleccionado: {os.path.basename(archivo_excel)}")
        
        # Copiar im√°genes junto al Excel para distribuci√≥n
        excel_dir = os.path.dirname(archivo_excel)
        imagenes_junto_excel = []
        
        for i, imagen_data in enumerate(imagenes_guardadas):
            archivo_junto_excel = os.path.join(excel_dir, f"IMG_{nombres_archivos[i]}")
            try:
                import shutil
                shutil.copy2(imagen_data['ruta_completa'], archivo_junto_excel)
                imagenes_junto_excel.append(archivo_junto_excel)
                print(f"üìã Imagen copiada junto al Excel: IMG_{nombres_archivos[i]}")
            except Exception as copy_error:
                print(f"‚ö†Ô∏è Error copiando imagen junto al Excel: {copy_error}")
                imagenes_junto_excel.append(imagen_data['ruta_completa'])  # Usar ruta original
        
        # INSERTAR IM√ÅGENES EN EXCEL CON XLWINGS
        print(f"üìä Insertando im√°genes en Excel usando xlwings...")
        
        try:
            import xlwings as xw
            
            # Abrir Excel
            print(f"üîß Abriendo Excel...")
            app_excel = xw.App(visible=True, add_book=False)  # Visible para mejor estabilidad
            wb = app_excel.books.open(archivo_excel)
            
            # Verificar hoja destino
            destino_hoja = "2. Electricas - Dise√±o log- Fis"
            if destino_hoja not in [sheet.name for sheet in wb.sheets]:
                wb.close()
                app_excel.quit()
                return jsonify({'success': False, 'error': f'No se encontr√≥ la hoja "{destino_hoja}" en el Excel'})
            
            ws = wb.sheets[destino_hoja]
            print(f"‚úÖ Hoja '{destino_hoja}' encontrada")
            
            # Definir rangos para cada imagen
            rangos_destino = [
                'C14:D20',  # Consumo energ√≠a 1
                'E14:G20',  # Consumo energ√≠a 2
                'B39:G55'   # Simulaci√≥n pathloss
            ]
            
            resultados_insercion = []
            
            # Insertar cada imagen en su rango correspondiente
            for i, (imagen_data, rango) in enumerate(zip(imagenes_guardadas, rangos_destino)):
                try:
                    print(f"üñºÔ∏è Insertando {imagen_data['nombre']} en rango {rango}")
                    
                    # Usar la imagen que est√° junto al Excel
                    imagen_path = imagenes_junto_excel[i]
                    
                    # Insertar imagen en el rango
                    rango_obj = ws.range(rango)
                    
                    # Agregar imagen al rango
                    picture = ws.pictures.add(
                        imagen_path,
                        left=rango_obj.left,
                        top=rango_obj.top,
                        width=rango_obj.width,
                        height=rango_obj.height
                    )
                    
                    print(f"‚úÖ {imagen_data['nombre']} insertada exitosamente en {rango}")
                    resultados_insercion.append({
                        'imagen': imagen_data['nombre'],
                        'rango': rango,
                        'archivo': imagen_data['archivo_guardado'],
                        'success': True
                    })
                    
                except Exception as imagen_error:
                    print(f"‚ùå Error insertando {imagen_data['nombre']}: {imagen_error}")
                    resultados_insercion.append({
                        'imagen': imagen_data['nombre'],
                        'rango': rango,
                        'archivo': imagen_data['archivo_guardado'],
                        'success': False,
                        'error': str(imagen_error)
                    })
            
            # Guardar Excel
            print(f"üíæ Guardando Excel...")
            wb.save()
            print(f"‚úÖ Excel guardado exitosamente")
            
            # Cerrar Excel
            print(f"üîí Cerrando Excel...")
            wb.close()
            app_excel.quit()
            print(f"‚úÖ Excel cerrado correctamente")
            
            # Contar √©xitos
            exitos = sum(1 for r in resultados_insercion if r['success'])
            
            # Preparar respuesta
            response_data = {
                'success': True,
                'message': f'{exitos}/3 im√°genes insertadas exitosamente en la hoja "{destino_hoja}"',
                'imagenes_procesadas': len(imagenes_guardadas),
                'resultados': resultados_insercion,
                'imagen1_rango': rangos_destino[0],
                'imagen2_rango': rangos_destino[1], 
                'imagen3_rango': rangos_destino[2],
                'hoja': destino_hoja
            }
            
            print(f"üì§ Enviando respuesta exitosa: {exitos}/3 im√°genes")
            return jsonify(response_data)
            
        except Exception as excel_error:
            print(f"‚ùå Error con xlwings: {excel_error}")
            try:
                if 'wb' in locals():
                    wb.close()
                if 'app_excel' in locals():
                    app_excel.quit()
            except:
                pass
            return jsonify({'success': False, 'error': f'Error integrando im√°genes en Excel: {str(excel_error)}'})
        
    except Exception as e:
        print(f"‚ùå Error general subiendo im√°genes el√©ctricas: {e}")
        import traceback
        traceback.print_exc()
        return jsonify({
            'success': False,
            'error': f'Error interno: {str(e)}'
        })

@app.route('/subir_analisis_red_frecuencia', methods=['POST'])
@error_handler
def subir_analisis_red_frecuencia():
    """
    Endpoint para subir documento Word de An√°lisis de Red y Frecuencia
    y agregarlo a la celda D12 del Excel de dise√±o de soluci√≥n
    """
    try:
        # Obtener datos del formulario
        user_id = request.form.get('user_id')
        fila_idx = request.form.get('fila_idx')
        destino_hoja = request.form.get('destino_hoja', '1. Analisis de Red y Frecuencia')
        destino_celda = request.form.get('destino_celda', 'C12')  # CAMBIO: D12 est√° combinada, C12 funciona
        
        # Obtener el archivo
        archivo_word = request.files.get('archivo_word')
        
        if not archivo_word:
            return jsonify({'success': False, 'error': 'No se recibi√≥ ning√∫n archivo'})
        
        if not user_id:
            return jsonify({'success': False, 'error': 'ID de usuario requerido'})
        
        print(f"üìÑ Subiendo An√°lisis de Red y Frecuencia para ID: {user_id}")
        print(f"üìÑ Archivo: {archivo_word.filename}")
        print(f"üìÑ Destino: Hoja '{destino_hoja}', Celda {destino_celda}")
        
        # Validar tipo de archivo
        if not archivo_word.filename.lower().endswith(('.doc', '.docx')):
            return jsonify({'success': False, 'error': 'Solo se permiten archivos .doc o .docx'})
        
        # Crear directorio PERMANENTE para archivos subidos (accesible para todos)
        base_dir = os.path.dirname(os.path.abspath(__file__))
        
        # ESTRATEGIA: Guardar en carpeta archivos_permanentes para que persista
        uploads_dir = os.path.join(base_dir, 'archivos_permanentes', 'documentos_subidos', user_id)
        os.makedirs(uploads_dir, exist_ok=True)
        print(f"üìÅ Directorio permanente creado: {uploads_dir}")
        
        # Generar nombre √∫nico para el archivo
        from datetime import datetime
        timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
        filename_safe = f"analisis_red_frecuencia_{user_id}_{timestamp}.{archivo_word.filename.split('.')[-1]}"
        archivo_path = os.path.join(uploads_dir, filename_safe)
        
        # Guardar el archivo
        archivo_word.save(archivo_path)
        print(f"‚úÖ Archivo guardado en: {archivo_path}")
        
        # Buscar el archivo Excel de dise√±o de soluci√≥n m√°s reciente para este user_id
        # IGUAL QUE EN SITE SURVEY: buscar en archivos_generados Y archivos_permanentes
        archivos_generados_dir = os.path.join(base_dir, 'archivos_generados')
        archivos_permanentes_dir = os.path.join(base_dir, 'archivos_permanentes')
        import glob
        
        # Limpiar user_id para b√∫squeda
        user_id_limpio = re.sub(r'[<>:"/\\|?*]', '', str(user_id))
        print(f"üîç Buscando Excel para user_id: {user_id} (limpio: {user_id_limpio})")
        
        # Buscar en archivos_generados primero
        patron_excel = f"ds_diseno_solucion_{user_id_limpio}*.xlsx"
        ruta_completa = os.path.join(archivos_generados_dir, patron_excel)
        print(f"üîç Patr√≥n de b√∫squeda: {ruta_completa}")
        archivos_excel = glob.glob(ruta_completa)
        print(f"üìÇ Archivos encontrados en archivos_generados: {len(archivos_excel)}")
        
        # Si no encuentra en archivos_generados, buscar en archivos_permanentes
        if not archivos_excel:
            patron_permanente = f"PERMANENTE_ds_diseno_solucion_{user_id_limpio}*.xlsx"
            ruta_permanente = os.path.join(archivos_permanentes_dir, patron_permanente)
            print(f"üîç Buscando en archivos permanentes: {ruta_permanente}")
            archivos_excel = glob.glob(ruta_permanente)
            print(f"üìÇ Archivos encontrados en archivos_permanentes: {len(archivos_excel)}")
        
        # Si a√∫n no encuentra, intentar patrones m√°s amplios
        if not archivos_excel:
            patrones_adicionales = [
                os.path.join(archivos_generados_dir, f"ds_{user_id_limpio}*.xlsx"),
                os.path.join(archivos_generados_dir, f"ds_*{user_id_limpio}*.xlsx"),
                os.path.join(archivos_permanentes_dir, f"PERMANENTE_ds_{user_id_limpio}*.xlsx")
            ]
            
            for patron_adicional in patrones_adicionales:
                print(f"üîç Intentando patr√≥n adicional: {patron_adicional}")
                archivos_excel = glob.glob(patron_adicional)
                if archivos_excel:
                    print(f"‚úÖ Encontrados {len(archivos_excel)} archivos con patr√≥n adicional")
                    break
        
        if not archivos_excel:
            print(f"‚ùå NO SE ENCONTRARON ARCHIVOS EXCEL para {user_id}")
            print(f"üìÅ Directorio archivos_generados: {archivos_generados_dir}")
            print(f"üìÅ Directorio archivos_permanentes: {archivos_permanentes_dir}")
            return jsonify({'success': False, 'error': f'No se encontr√≥ archivo Excel de dise√±o de soluci√≥n para el ID {user_id}. Primero debes generar el dise√±o de soluci√≥n.'})
        
        # Usar el archivo m√°s reciente
        archivo_excel = max(archivos_excel, key=os.path.getmtime)
        print(f"üìä ARCHIVO SELECCIONADO: {os.path.basename(archivo_excel)}")
        print(f"üìä Ruta completa: {archivo_excel}")
        
        # COPIAR ARCHIVO JUNTO AL EXCEL PRIMERO (antes de crear hiperv√≠nculo)
        excel_dir = os.path.dirname(archivo_excel)
        archivo_junto_excel = os.path.join(excel_dir, f"ADJUNTO_{filename_safe}")
        
        try:
            import shutil
            shutil.copy2(archivo_path, archivo_junto_excel)
            print(f"üìã Archivo copiado junto al Excel: {archivo_junto_excel}")
            print(f"‚úÖ Archivo disponible para hiperv√≠nculo")
        except Exception as copy_error:
            print(f"‚ö†Ô∏è Error copiando archivo junto al Excel: {copy_error}")
            # Continuar de todos modos
        
        # USAR XLWINGS COMO EN SITE SURVEY (en lugar de openpyxl)
        print(f"üìä Integrando archivo en Excel usando xlwings (como site survey)...")
        
        try:
            import xlwings as xw
            
            print(f"üîß Iniciando Excel con xlwings...")
            
            # ESTRATEGIA MEJORADA: Timeout y manejo de errores
            import signal
            import time
            
            def timeout_handler(signum, frame):
                raise TimeoutError("xlwings se colg√≥ al abrir Excel")
            
            # Configurar timeout de 30 segundos
            signal.signal(signal.SIGALRM, timeout_handler) if hasattr(signal, 'SIGALRM') else None
            
            try:
                # Intentar con Excel visible primero (m√°s estable)
                print(f"üîß Intentando con Excel visible...")
                app_excel = xw.App(visible=True, add_book=False)
                print(f"‚úÖ Excel iniciado correctamente")
                
                print(f"üîß Abriendo archivo: {os.path.basename(archivo_excel)}")
                wb = app_excel.books.open(archivo_excel)
                print(f"‚úÖ Archivo Excel abierto correctamente")
                
            except Exception as visible_error:
                print(f"‚ö†Ô∏è Error con Excel visible: {visible_error}")
                print(f"üîß Intentando con Excel invisible...")
                
                try:
                    if 'app_excel' in locals():
                        app_excel.quit()
                    time.sleep(2)
                    
                    app_excel = xw.App(visible=False, add_book=False)
                    wb = app_excel.books.open(archivo_excel)
                    print(f"‚úÖ Excel invisible funcion√≥")
                    
                except Exception as invisible_error:
                    print(f"‚ùå Error con Excel invisible: {invisible_error}")
                    raise Exception(f"No se pudo abrir Excel: visible={visible_error}, invisible={invisible_error}")
            
            finally:
                # Limpiar timeout
                signal.alarm(0) if hasattr(signal, 'alarm') else None
            
            print(f"‚úÖ Excel abierto correctamente con xlwings")
            
            # Verificar que existe la hoja
            if destino_hoja not in [sheet.name for sheet in wb.sheets]:
                wb.close()
                app_excel.quit()
                return jsonify({'success': False, 'error': f'No se encontr√≥ la hoja "{destino_hoja}" en el Excel'})
            
            # Acceder a la hoja
            ws = wb.sheets[destino_hoja]
            print(f"‚úÖ Hoja '{destino_hoja}' encontrada")
            
            # Escribir en la celda especificada
            try:
                # EMBEBER ARCHIVO COMO OBJETO OLE DENTRO DEL EXCEL
                print(f"üìÑ Embebiendo archivo Word como objeto OLE en celda {destino_celda}")
                
                # Obtener posici√≥n de la celda
                celda = ws.range(destino_celda)
                
                try:
                    # Usar API de Excel para insertar objeto embebido
                    xl_sheet = ws.api
                    
                    # Insertar archivo como objeto OLE embebido
                    ole_object = xl_sheet.OLEObjects().Add(
                        Filename=archivo_path,  # Usar archivo original
                        Link=False,  # False = embebido (va dentro del Excel), True = vinculado
                        DisplayAsIcon=True,  # Mostrar como icono
                        IconFileName="",  # Usar icono predeterminado
                        IconIndex=0,
                        IconLabel=f"üìÑ {archivo_word.filename}",  # Etiqueta del icono
                        Left=celda.left,
                        Top=celda.top,
                        Width=200,
                        Height=50
                    )
                    
                    print(f"‚úÖ Archivo Word embebido como objeto OLE en {destino_celda}")
                    print(f"üìÑ Archivo: {archivo_word.filename}")
                    print(f"üîó Tipo: Objeto embebido (incluido en el Excel)")
                    
                except Exception as ole_error:
                    print(f"‚ö†Ô∏è Error embebiendo como OLE: {ole_error}")
                    print(f"üîÑ Insertando solo texto como alternativa...")
                    
                    # Alternativa: insertar solo texto descriptivo
                    celda.value = f"üìÑ {archivo_word.filename}"
                    celda.font.bold = True
                    celda.font.color = (0, 100, 0)  # Verde oscuro
                    print(f"‚úÖ Texto insertado en {destino_celda}: {archivo_word.filename}")
                
            except Exception as celda_error:
                print(f"‚ö†Ô∏è Error escribiendo en {destino_celda}: {celda_error}")
                # Intentar con celdas alternativas (basado en pruebas: C12 funciona, D12 est√° combinada)
                celdas_alternativas = ['C12', 'E12', 'B12', 'D11', 'D13']
                celda_usada = None
                
                for celda_alt in celdas_alternativas:
                    try:
                        # EMBEBER ARCHIVO COMO OBJETO OLE en celda alternativa
                        print(f"üîÑ Intentando embeber en celda alternativa: {celda_alt}")
                        
                        celda = ws.range(celda_alt)
                        
                        try:
                            # Usar API de Excel para insertar objeto embebido
                            xl_sheet = ws.api
                            
                            ole_object = xl_sheet.OLEObjects().Add(
                                Filename=archivo_path,
                                Link=False,  # Embebido
                                DisplayAsIcon=True,
                                IconFileName="",
                                IconIndex=0,
                                IconLabel=f"üìÑ {archivo_word.filename}",
                                Left=celda.left,
                                Top=celda.top,
                                Width=200,
                                Height=50
                            )
                            
                            celda_usada = celda_alt
                            print(f"‚úÖ Archivo embebido como OLE en celda alternativa {celda_usada}")
                            print(f"üìÑ Archivo: {archivo_word.filename}")
                            print(f"üîó Tipo: Objeto embebido (incluido en el Excel)")
                            
                        except Exception as ole_alt_error:
                            print(f"‚ö†Ô∏è Error OLE en {celda_alt}: {ole_alt_error}")
                            # Alternativa: solo texto
                            celda.value = f"üìÑ {archivo_word.filename}"
                            celda.font.bold = True
                            celda.font.color = (0, 100, 0)
                            celda_usada = celda_alt
                            print(f"‚úÖ Texto insertado en celda alternativa {celda_usada}")
                        
                        destino_celda = celda_usada
                        break
                    except Exception as e:
                        print(f"‚ö†Ô∏è Error con celda {celda_alt}: {e}")
                        continue
                
                if not celda_usada:
                    raise Exception(f"No se pudo escribir en {destino_celda} ni en celdas alternativas")
            
            # Guardar el archivo
            print(f"üíæ Guardando Excel...")
            wb.save()
            print(f"‚úÖ Excel guardado exitosamente")
            
            # Cerrar Excel
            print(f"üîí Cerrando Excel...")
            wb.close()
            app_excel.quit()
            print(f"‚úÖ Excel cerrado correctamente")
            
        except Exception as excel_error:
            print(f"‚ùå Error con xlwings: {excel_error}")
            try:
                if 'wb' in locals():
                    wb.close()
                if 'app_excel' in locals():
                    app_excel.quit()
            except:
                pass
            
            # ESTRATEGIA DE RESPALDO: Usar openpyxl si xlwings falla
            print(f"üîÑ Intentando estrategia de respaldo con openpyxl...")
            try:
                import openpyxl
                
                print(f"üìä Abriendo Excel con openpyxl...")
                wb_openpyxl = openpyxl.load_workbook(archivo_excel)
                
                if destino_hoja in wb_openpyxl.sheetnames:
                    ws_openpyxl = wb_openpyxl[destino_hoja]
                    
                    # Crear hiperv√≠nculo con openpyxl
                    from openpyxl.worksheet.hyperlink import Hyperlink
                    
                    # USAR EL ARCHIVO COPIADO JUNTO AL EXCEL con protocolo file://
                    excel_dir = os.path.dirname(archivo_excel)
                    archivo_junto_excel = f"ADJUNTO_{filename_safe}"
                    ruta_completa_adjunto = os.path.join(excel_dir, archivo_junto_excel)
                    ruta_hipervinculo = f"file:///{ruta_completa_adjunto.replace(chr(92), '/')}"
                    
                    texto_mostrar = f"üìÑ {archivo_word.filename}"
                    
                    # Intentar escribir en la celda destino
                    try:
                        celda_openpyxl = ws_openpyxl[destino_celda]
                        celda_openpyxl.value = texto_mostrar
                        celda_openpyxl.hyperlink = ruta_hipervinculo
                        celda_openpyxl.font = openpyxl.styles.Font(color="0000FF", underline="single", bold=True)
                        celda_usada_openpyxl = destino_celda
                        
                    except Exception as openpyxl_celda_error:
                        # Intentar celdas alternativas
                        celdas_alt_openpyxl = ['C12', 'E12', 'B12', 'D11', 'D13']
                        celda_usada_openpyxl = None
                        
                        for celda_alt in celdas_alt_openpyxl:
                            try:
                                celda_openpyxl = ws_openpyxl[celda_alt]
                                celda_openpyxl.value = texto_mostrar
                                celda_openpyxl.hyperlink = ruta_hipervinculo
                                celda_openpyxl.font = openpyxl.styles.Font(color="0000FF", underline="single", bold=True)
                                celda_usada_openpyxl = celda_alt
                                break
                            except:
                                continue
                    
                    if celda_usada_openpyxl:
                        # Guardar archivo
                        wb_openpyxl.save(archivo_excel)
                        print(f"‚úÖ RESPALDO EXITOSO: Hiperv√≠nculo creado con openpyxl en celda {celda_usada_openpyxl}")
                        
                        # Preparar respuesta exitosa
                        response_data = {
                            'success': True,
                            'message': f'Archivo "{archivo_word.filename}" agregado exitosamente en celda {celda_usada_openpyxl} (usando openpyxl)',
                            'archivo_guardado': filename_safe,
                            'celda': celda_usada_openpyxl,
                            'hoja': destino_hoja,
                            'metodo': 'openpyxl_respaldo'
                        }
                        return jsonify(response_data)
                    
                else:
                    print(f"‚ùå Hoja '{destino_hoja}' no encontrada en openpyxl")
                    
            except Exception as openpyxl_error:
                print(f"‚ùå Error con openpyxl tambi√©n: {openpyxl_error}")
            
            return jsonify({'success': False, 'error': f'Error integrando archivo en Excel (xlwings y openpyxl fallaron): {str(excel_error)}'})
        
        # El archivo ya fue copiado junto al Excel anteriormente
        print(f"‚úÖ Archivo junto al Excel ya disponible: ADJUNTO_{filename_safe}")
        
        # Preparar respuesta JSON
        response_data = {
            'success': True,
            'message': f'Archivo "{archivo_word.filename}" agregado exitosamente en celda {destino_celda}',
            'archivo_guardado': filename_safe,
            'celda': destino_celda,
            'hoja': destino_hoja,
            'ruta_permanente': uploads_dir,
            'accesible_para_otros': True
        }
        
        print(f"üì§ Enviando respuesta exitosa: {response_data}")
        return jsonify(response_data)
        
    except Exception as e:
        print(f"‚ùå Error subiendo an√°lisis de red y frecuencia: {e}")
        import traceback
        traceback.print_exc()
        return jsonify({
            'success': False,
            'error': f'Error interno: {str(e)}'
        })


def buscar_archivos_excel(user_id, fila_idx=None):
    """
    Funci√≥n auxiliar para buscar archivos Excel de dise√±o de soluci√≥n
    """
    # Configurar directorios
    base_dir = os.path.dirname(os.path.abspath(__file__))
    archivos_generados_dir = os.path.join(base_dir, 'archivos_generados')
    archivos_permanentes_dir = os.path.join(base_dir, 'archivos_permanentes')
    
    # Limpiar user_id para nombres de archivo
    user_id_limpio = re.sub(r'[<>:"/\\|?*]', '', str(user_id))
    print(f"üîç Buscando Excel para user_id: {user_id} (limpio: {user_id_limpio})")
    
    # Buscar en archivos_generados primero
    patron_excel = f"ds_diseno_solucion_{user_id_limpio}*.xlsx"
    ruta_completa = os.path.join(archivos_generados_dir, patron_excel)
    print(f"üîç Patr√≥n de b√∫squeda: {ruta_completa}")
    archivos_excel = glob.glob(ruta_completa)
    print(f"üìÇ Archivos encontrados en archivos_generados: {len(archivos_excel)}")
    
    # Si no encuentra en archivos_generados, buscar en archivos_permanentes
    if not archivos_excel:
        patron_permanente = f"PERMANENTE_ds_diseno_solucion_{user_id_limpio}*.xlsx"
        ruta_permanente = os.path.join(archivos_permanentes_dir, patron_permanente)
        print(f"üîç Buscando en archivos permanentes: {ruta_permanente}")
        archivos_excel = glob.glob(ruta_permanente)
        print(f"üìÇ Archivos encontrados en archivos_permanentes: {len(archivos_excel)}")
    
    # Si a√∫n no encuentra, intentar patrones m√°s amplios
    if not archivos_excel:
        patrones_adicionales = [
            os.path.join(archivos_generados_dir, f"ds_{user_id_limpio}*.xlsx"),
            os.path.join(archivos_generados_dir, f"ds_*{user_id_limpio}*.xlsx"),
            os.path.join(archivos_permanentes_dir, f"PERMANENTE_ds_{user_id_limpio}*.xlsx")
        ]
        
        for patron_adicional in patrones_adicionales:
            print(f"üîç Intentando patr√≥n adicional: {patron_adicional}")
            archivos_excel = glob.glob(patron_adicional)
            if archivos_excel:
                print(f"‚úÖ Encontrados {len(archivos_excel)} archivos con patr√≥n adicional")
                break
    
    return archivos_excel


@app.route('/subir_estudio_informacion', methods=['POST'])
@error_handler
def subir_estudio_informacion():
    """
    Endpoint para subir 6 im√°genes + 2 PDFs para la hoja "4. Estudio de informaci√≥n"
    
    Ubicaciones:
    - 2 Im√°genes l√≠nea de vista: C87:N112, AA87:AK112  
    - 4 Im√°genes adicionales: E118:X136, E140:X158, E163:X181, E185:X203
    - 2 PDFs embebidos: AB121, AB166
    """
    try:
        print("üìä === INICIANDO SUBIDA DE ESTUDIO DE INFORMACI√ìN ===")
        
        # Obtener datos del formulario
        user_id = request.form.get('user_id')
        fila_idx = request.form.get('fila_idx')
        
        if not user_id:
            return jsonify({'success': False, 'error': 'Falta el user_id'})
        
        print(f"üë§ User ID: {user_id}")
        print(f"üìç Fila: {fila_idx}")
        
        # Obtener las 6 im√°genes
        imagenes_estudio = request.files.getlist('imagenes_estudio')
        if len(imagenes_estudio) != 6:
            return jsonify({'success': False, 'error': f'Se requieren exactamente 6 im√°genes, recibidas: {len(imagenes_estudio)}'})
        
        # Obtener los 2 PDFs
        pdfs_estudio = request.files.getlist('pdfs_estudio')
        if len(pdfs_estudio) != 2:
            return jsonify({'success': False, 'error': f'Se requieren exactamente 2 PDFs, recibidos: {len(pdfs_estudio)}'})
        
        # Validar tipos de archivo
        for i, imagen in enumerate(imagenes_estudio):
            if not imagen.content_type.startswith('image/'):
                return jsonify({'success': False, 'error': f'Imagen {i+1}: Solo se permiten archivos de imagen'})
        
        for i, pdf in enumerate(pdfs_estudio):
            if not pdf.content_type == 'application/pdf':
                return jsonify({'success': False, 'error': f'PDF {i+1}: Solo se permiten archivos PDF'})
        
        print(f"‚úÖ Archivos validados: 6 im√°genes + 2 PDFs")
        
        # Crear directorios permanentes
        base_dir = os.path.dirname(os.path.abspath(__file__))
        
        # Directorio para im√°genes de estudio
        imagenes_estudio_dir = os.path.join(base_dir, 'archivos_permanentes', 'imagenes_estudio', user_id)
        os.makedirs(imagenes_estudio_dir, exist_ok=True)
        
        # Directorio para PDFs de estudio
        pdfs_estudio_dir = os.path.join(base_dir, 'archivos_permanentes', 'pdfs_estudio', user_id)
        os.makedirs(pdfs_estudio_dir, exist_ok=True)
        
        print(f"üìÅ Directorios permanentes creados")
        
        # Guardar archivos permanentemente
        rutas_imagenes = []
        for i, imagen in enumerate(imagenes_estudio):
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            nombre_archivo = f"estudio_img_{i+1}_{timestamp}_{secure_filename(imagen.filename)}"
            ruta_imagen = os.path.join(imagenes_estudio_dir, nombre_archivo)
            imagen.save(ruta_imagen)
            rutas_imagenes.append(ruta_imagen)
            print(f"üíæ Imagen {i+1} guardada: {nombre_archivo}")
        
        rutas_pdfs = []
        for i, pdf in enumerate(pdfs_estudio):
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            nombre_archivo = f"estudio_pdf_{i+1}_{timestamp}_{secure_filename(pdf.filename)}"
            ruta_pdf = os.path.join(pdfs_estudio_dir, nombre_archivo)
            pdf.save(ruta_pdf)
            rutas_pdfs.append(ruta_pdf)
            print(f"üíæ PDF {i+1} guardado: {nombre_archivo}")
        
        # Buscar el archivo Excel m√°s reciente
        archivos_excel = buscar_archivos_excel(user_id, fila_idx)
        if not archivos_excel:
            return jsonify({'success': False, 'error': 'No se encontr√≥ el archivo Excel de dise√±o de soluci√≥n'})
        
        archivo_excel_reciente = max(archivos_excel, key=os.path.getmtime)
        print(f"üìÑ Excel encontrado: {archivo_excel_reciente}")
        
        # Copiar archivos junto al Excel para portabilidad
        excel_dir = os.path.dirname(archivo_excel_reciente)
        
        # Copiar im√°genes junto al Excel
        rutas_imagenes_junto_excel = []
        for i, ruta_imagen in enumerate(rutas_imagenes):
            nombre_imagen = f"IMG_ESTUDIO_{i+1}_{os.path.basename(ruta_imagen)}"
            ruta_junto_excel = os.path.join(excel_dir, nombre_imagen)
            shutil.copy2(ruta_imagen, ruta_junto_excel)
            rutas_imagenes_junto_excel.append(ruta_junto_excel)
            print(f"üìã Imagen {i+1} copiada junto al Excel: {nombre_imagen}")
        
        # Copiar PDFs junto al Excel
        rutas_pdfs_junto_excel = []
        for i, ruta_pdf in enumerate(rutas_pdfs):
            nombre_pdf = f"PDF_ESTUDIO_{i+1}_{os.path.basename(ruta_pdf)}"
            ruta_junto_excel = os.path.join(excel_dir, nombre_pdf)
            shutil.copy2(ruta_pdf, ruta_junto_excel)
            rutas_pdfs_junto_excel.append(ruta_junto_excel)
            print(f"üìã PDF {i+1} copiado junto al Excel: {nombre_pdf}")
        
        # INTEGRAR CON EXCEL usando xlwings
        print(f"üîó Integrando archivos en Excel...")
        
        try:
            # Abrir Excel con xlwings
            print(f"üìÇ Abriendo Excel con xlwings...")
            app_excel = xw.App(visible=False, add_book=False)
            app_excel.display_alerts = False
            app_excel.screen_updating = False
            
            wb = app_excel.books.open(archivo_excel_reciente)
            print(f"‚úÖ Excel abierto exitosamente")
            
            # Buscar la hoja "4. Estudio de informaci√≥n" (con variaciones posibles)
            posibles_nombres = [
                "4. Estudio de informaci√≥n",
                "4. Estudio de informacion", 
                "Estudio de informaci√≥n",
                "Estudio de informacion",
                "4. Estudio",
                "Estudio"
            ]
            
            ws = None
            destino_hoja = None
            
            # Primero listar todas las hojas disponibles para debug
            print(f"üîç Hojas disponibles en el Excel:")
            for i, sheet in enumerate(wb.sheets):
                print(f"  {i+1}. '{sheet.name}'")
            
            # Buscar coincidencia con los nombres posibles
            for nombre_posible in posibles_nombres:
                for sheet in wb.sheets:
                    if nombre_posible.lower() in sheet.name.lower():
                        ws = sheet
                        destino_hoja = sheet.name
                        print(f"‚úÖ Hoja encontrada: '{destino_hoja}' (buscaba: '{nombre_posible}')")
                        break
                if ws:
                    break
            
            if not ws:
                # Crear lista de hojas disponibles para el mensaje de error
                hojas_disponibles = [sheet.name for sheet in wb.sheets]
                wb.close()
                app_excel.quit()
                return jsonify({
                    'success': False, 
                    'error': f'No se encontr√≥ ninguna hoja con nombres relacionados a "Estudio de informaci√≥n". Hojas disponibles: {", ".join(hojas_disponibles)}'
                })
            
            print(f"‚úÖ Hoja encontrada: {ws.name}")
            
            resultados = []
            
            # DEFINIR RANGOS PARA LAS 6 IM√ÅGENES
            rangos_imagenes = [
                ('C87:N112', 'L√≠nea de vista 1'),
                ('AA87:AK112', 'L√≠nea de vista 2'), 
                ('E118:X136', 'Imagen adicional 1'),
                ('E140:X158', 'Imagen adicional 2'),
                ('E163:X181', 'Imagen adicional 3'),
                ('E185:X203', 'Imagen adicional 4')
            ]
            
            # INSERTAR LAS 6 IM√ÅGENES
            for i, (rango, descripcion) in enumerate(rangos_imagenes):
                if i < len(rutas_imagenes_junto_excel):
                    try:
                        print(f"üñºÔ∏è Insertando {descripcion} en rango {rango}")
                        
                        rango_obj = ws.range(rango)
                        
                        # Insertar imagen en el rango
                        picture = ws.pictures.add(
                            rutas_imagenes_junto_excel[i],
                            left=rango_obj.left,
                            top=rango_obj.top,
                            width=rango_obj.width,
                            height=rango_obj.height
                        )
                        
                        print(f"‚úÖ {descripcion} insertada exitosamente en {rango}")
                        resultados.append({
                            'tipo': 'Imagen',
                            'descripcion': descripcion,
                            'destino': rango,
                            'archivo': os.path.basename(rutas_imagenes_junto_excel[i]),
                            'success': True
                        })
                        
                    except Exception as img_error:
                        print(f"‚ùå Error insertando {descripcion}: {img_error}")
                        resultados.append({
                            'tipo': 'Imagen',
                            'descripcion': descripcion,
                            'destino': rango,
                            'archivo': os.path.basename(rutas_imagenes_junto_excel[i]) if i < len(rutas_imagenes_junto_excel) else 'N/A',
                            'success': False,
                            'error': str(img_error)
                        })
            
            # INSERTAR LOS 2 PDFs COMO OBJETOS EMBEBIDOS
            celdas_pdfs = ['AB121', 'AB166']
            
            for i, celda_pdf in enumerate(celdas_pdfs):
                if i < len(rutas_pdfs_junto_excel):
                    try:
                        print(f"üìÑ Embebiendo PDF {i+1} en celda {celda_pdf}")
                        
                        # Embeber PDF como OLE object usando EXACTAMENTE el mismo m√©todo que Word y KMZ
                        try:
                            print(f"üìÑ Embebiendo PDF {i+1} en celda {celda_pdf} usando m√©todo exacto de Word/KMZ")
                            
                            # M√âTODO EXACTO: Usar la misma sintaxis que funciona para Word y KMZ
                            xl_sheet = ws.api
                            
                            # Insertar archivo PDF como objeto OLE embebido
                            ole_object = xl_sheet.OLEObjects().Add(
                                Filename=rutas_pdfs_junto_excel[i],  # Usar archivo copiado junto al Excel
                                Link=False,  # False = embebido (va dentro del Excel)
                                DisplayAsIcon=True,  # Mostrar como icono
                                IconFileName="",  # Usar icono predeterminado
                                IconIndex=0,
                                IconLabel=os.path.basename(rutas_pdfs_junto_excel[i])
                            )
                            
                            # Posicionar el objeto en la celda espec√≠fica
                            celda_range = ws.range(celda_pdf)
                            ole_object.Left = celda_range.left
                            ole_object.Top = celda_range.top
                            ole_object.Width = 100
                            ole_object.Height = 80
                            
                            print(f"‚úÖ PDF {i+1} embebido exitosamente como objeto OLE en {celda_pdf}")
                            resultados.append({
                                'tipo': 'PDF (embebido)',
                                'descripcion': f'PDF {i+1}',
                                'destino': celda_pdf,
                                'archivo': os.path.basename(rutas_pdfs_junto_excel[i]),
                                'success': True
                            })
                            
                        except Exception as ole_error:
                            print(f"‚ùå Error embebiendo PDF {i+1}: {ole_error}")
                            
                            # Si falla el embebido OLE, insertar solo texto descriptivo (SIN hiperv√≠nculo)
                            try:
                                celda_pdf_obj = ws.range(celda_pdf)
                                celda_pdf_obj.value = f"üìÑ PDF: {os.path.basename(rutas_pdfs_junto_excel[i])}"
                                celda_pdf_obj.font.bold = True
                                celda_pdf_obj.font.color = (139, 69, 19)  # Marr√≥n para PDF
                                print(f"‚úÖ Texto descriptivo insertado en {celda_pdf}: {os.path.basename(rutas_pdfs_junto_excel[i])}")
                                
                                resultados.append({
                                    'tipo': 'PDF (texto)',
                                    'descripcion': f'PDF {i+1}',
                                    'destino': celda_pdf,
                                    'archivo': os.path.basename(rutas_pdfs_junto_excel[i]),
                                    'success': True,
                                    'nota': 'Embebido como texto porque OLE fall√≥'
                                })
                                
                            except Exception as text_error:
                                print(f"‚ùå Error insertando texto para PDF {i+1}: {text_error}")
                                resultados.append({
                                    'tipo': 'PDF (error)',
                                    'descripcion': f'PDF {i+1}',
                                    'destino': celda_pdf,
                                    'archivo': os.path.basename(rutas_pdfs_junto_excel[i]),
                                    'success': False,
                                    'error': f'Error OLE: {str(ole_error)}, Error texto: {str(text_error)}'
                                })
                        
                    except Exception as pdf_error:
                        print(f"‚ùå Error procesando PDF {i+1}: {pdf_error}")
                        resultados.append({
                            'tipo': 'PDF',
                            'descripcion': f'PDF {i+1}',
                            'destino': celda_pdf,
                            'archivo': os.path.basename(rutas_pdfs_junto_excel[i]) if i < len(rutas_pdfs_junto_excel) else 'N/A',
                            'success': False,
                            'error': str(pdf_error)
                        })
            
            # Guardar Excel
            print(f"üíæ Guardando Excel...")
            wb.save()
            print(f"‚úÖ Excel guardado exitosamente")
            
            # Cerrar Excel
            print(f"üîí Cerrando Excel...")
            wb.close()
            app_excel.quit()
            print(f"‚úÖ Excel cerrado correctamente")
            
            # Contar √©xitos
            exitos = sum(1 for r in resultados if r['success'])
            total_archivos = 8  # 6 im√°genes + 2 PDFs
            
            # Preparar respuesta
            response_data = {
                'success': True,
                'message': f'{exitos}/{total_archivos} archivos insertados exitosamente en la hoja "{destino_hoja}"',
                'archivos_procesados': total_archivos,
                'resultados': resultados,
                'hoja': destino_hoja,
                'rangos_imagenes': [rango for rango, _ in rangos_imagenes],
                'celdas_pdfs': celdas_pdfs
            }
            
            print(f"üì§ Enviando respuesta exitosa: {exitos}/{total_archivos} archivos")
            return jsonify(response_data)
            
        except Exception as excel_error:
            print(f"‚ùå Error con xlwings: {excel_error}")
            try:
                if 'wb' in locals():
                    wb.close()
                if 'app_excel' in locals():
                    app_excel.quit()
            except:
                pass
            return jsonify({'success': False, 'error': f'Error integrando archivos en Excel: {str(excel_error)}'})
        
    except Exception as e:
        print(f"‚ùå Error general subiendo estudio de informaci√≥n: {e}")
        import traceback
        traceback.print_exc()
        return jsonify({
            'success': False,
            'error': f'Error interno: {str(e)}'
        })


@app.route('/subir_excel_imagen', methods=['POST'])
@error_handler
def subir_excel_imagen():
    """
    Endpoint para subir 1 imagen + 1 Excel para la hoja "5. Estudio de informacion B"
    
    Ubicaciones:
    - Imagen: B36:AJ45
    - Excel embebido: N52
    """
    try:
        print("üìä === INICIANDO SUBIDA DE EXCEL + IMAGEN ===")
        
        # Obtener datos del formulario
        user_id = request.form.get('user_id')
        fila_idx = request.form.get('fila_idx')
        
        if not user_id:
            return jsonify({'success': False, 'error': 'Falta el user_id'})
        
        print(f"üë§ User ID: {user_id}")
        print(f"üìç Fila: {fila_idx}")
        
        # Obtener la imagen
        imagen_excel = request.files.get('imagen_excel')
        if not imagen_excel or imagen_excel.filename == '':
            return jsonify({'success': False, 'error': 'Se requiere 1 imagen'})
        
        # Obtener el archivo Excel
        archivo_excel = request.files.get('archivo_excel')
        if not archivo_excel or archivo_excel.filename == '':
            return jsonify({'success': False, 'error': 'Se requiere 1 archivo Excel'})
        
        # Validar tipos de archivo
        if not imagen_excel.content_type.startswith('image/'):
            return jsonify({'success': False, 'error': 'Solo se permiten archivos de imagen'})
        
        if not (archivo_excel.content_type in ['application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 'application/vnd.ms-excel'] or 
                archivo_excel.filename.lower().endswith(('.xlsx', '.xls'))):
            return jsonify({'success': False, 'error': 'Solo se permiten archivos Excel (.xlsx, .xls)'})
        
        print(f"‚úÖ Archivos validados: 1 imagen + 1 Excel")
        
        # Crear directorios permanentes
        base_dir = os.path.dirname(os.path.abspath(__file__))
        
        # Directorio para imagen Excel
        imagen_excel_dir = os.path.join(base_dir, 'archivos_permanentes', 'imagen_excel', user_id)
        os.makedirs(imagen_excel_dir, exist_ok=True)
        
        # Directorio para archivo Excel
        archivo_excel_dir = os.path.join(base_dir, 'archivos_permanentes', 'archivo_excel', user_id)
        os.makedirs(archivo_excel_dir, exist_ok=True)
        
        print(f"üìÅ Directorios permanentes creados")
        
        # Guardar archivos permanentemente
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        
        # Guardar imagen
        nombre_imagen = f"excel_img_{timestamp}_{secure_filename(imagen_excel.filename)}"
        ruta_imagen = os.path.join(imagen_excel_dir, nombre_imagen)
        imagen_excel.save(ruta_imagen)
        print(f"üíæ Imagen guardada: {nombre_imagen}")
        
        # Guardar Excel
        nombre_excel = f"excel_file_{timestamp}_{secure_filename(archivo_excel.filename)}"
        ruta_excel = os.path.join(archivo_excel_dir, nombre_excel)
        archivo_excel.save(ruta_excel)
        print(f"üíæ Excel guardado: {nombre_excel}")
        
        # Buscar el archivo Excel de dise√±o m√°s reciente
        archivos_excel_diseno = buscar_archivos_excel(user_id, fila_idx)
        if not archivos_excel_diseno:
            return jsonify({'success': False, 'error': 'No se encontr√≥ el archivo Excel de dise√±o de soluci√≥n'})
        
        archivo_excel_reciente = max(archivos_excel_diseno, key=os.path.getmtime)
        print(f"üìÑ Excel de dise√±o encontrado: {archivo_excel_reciente}")
        
        # Copiar archivos junto al Excel para portabilidad
        excel_dir = os.path.dirname(archivo_excel_reciente)
        
        # Copiar imagen junto al Excel
        nombre_imagen_junto_excel = f"IMG_EXCEL_{os.path.basename(ruta_imagen)}"
        ruta_imagen_junto_excel = os.path.join(excel_dir, nombre_imagen_junto_excel)
        shutil.copy2(ruta_imagen, ruta_imagen_junto_excel)
        print(f"üìã Imagen copiada junto al Excel: {nombre_imagen_junto_excel}")
        
        # Copiar Excel junto al Excel de dise√±o
        nombre_excel_junto_excel = f"EXCEL_EMBEBIDO_{os.path.basename(ruta_excel)}"
        ruta_excel_junto_excel = os.path.join(excel_dir, nombre_excel_junto_excel)
        shutil.copy2(ruta_excel, ruta_excel_junto_excel)
        print(f"üìã Excel copiado junto al Excel de dise√±o: {nombre_excel_junto_excel}")
        
        # INTEGRAR CON EXCEL usando xlwings
        print(f"üîó Integrando archivos en Excel...")
        
        try:
            # Abrir Excel con xlwings
            print(f"üìÇ Abriendo Excel con xlwings...")
            app_excel = xw.App(visible=False, add_book=False)
            app_excel.display_alerts = False
            app_excel.screen_updating = False
            
            wb = app_excel.books.open(archivo_excel_reciente)
            print(f"‚úÖ Excel abierto exitosamente")
            
            # Buscar la hoja "5. Estudio de informacion B" (con variaciones posibles)
            posibles_nombres = [
                "5. Estudio de informacion B",
                "5. Estudio de informaci√≥n B",
                "Estudio de informacion B",
                "Estudio de informaci√≥n B",
                "5. Estudio B",
                "Estudio B"
            ]
            
            ws = None
            destino_hoja = None
            
            # Primero listar todas las hojas disponibles para debug
            print(f"üîç Hojas disponibles en el Excel:")
            for i, sheet in enumerate(wb.sheets):
                print(f"  {i+1}. '{sheet.name}'")
            
            # Buscar coincidencia con los nombres posibles
            for nombre_posible in posibles_nombres:
                for sheet in wb.sheets:
                    if nombre_posible.lower() in sheet.name.lower():
                        ws = sheet
                        destino_hoja = sheet.name
                        print(f"‚úÖ Hoja encontrada: '{destino_hoja}' (buscaba: '{nombre_posible}')")
                        break
                if ws:
                    break
            
            if not ws:
                # Crear lista de hojas disponibles para el mensaje de error
                hojas_disponibles = [sheet.name for sheet in wb.sheets]
                wb.close()
                app_excel.quit()
                return jsonify({
                    'success': False, 
                    'error': f'No se encontr√≥ ninguna hoja con nombres relacionados a "Estudio de informaci√≥n". Hojas disponibles: {", ".join(hojas_disponibles)}'
                })
            
            print(f"‚úÖ Hoja encontrada: {ws.name}")
            
            resultados = []
            
            # 1. INSERTAR IMAGEN EN RANGO B36:AJ45
            try:
                print(f"üñºÔ∏è Insertando imagen en rango B36:AJ45")
                
                rango_imagen = 'B36:AJ45'
                rango_obj = ws.range(rango_imagen)
                
                # Insertar imagen en el rango
                picture = ws.pictures.add(
                    ruta_imagen_junto_excel,
                    left=rango_obj.left,
                    top=rango_obj.top,
                    width=rango_obj.width,
                    height=rango_obj.height
                )
                
                print(f"‚úÖ Imagen insertada exitosamente en {rango_imagen}")
                resultados.append({
                    'tipo': 'Imagen',
                    'descripcion': 'Imagen Excel',
                    'destino': rango_imagen,
                    'archivo': os.path.basename(ruta_imagen_junto_excel),
                    'success': True
                })
                
            except Exception as img_error:
                print(f"‚ùå Error insertando imagen: {img_error}")
                resultados.append({
                    'tipo': 'Imagen',
                    'descripcion': 'Imagen Excel',
                    'destino': 'B36:AJ45',
                    'archivo': os.path.basename(ruta_imagen_junto_excel),
                    'success': False,
                    'error': str(img_error)
                })
            
            # 2. EMBEBER EXCEL EN CELDA N52
            try:
                print(f"üìä Embebiendo Excel en celda N52")
                
                # M√âTODO EXACTO: Usar la misma sintaxis que funciona para Word, KMZ y PDFs
                xl_sheet = ws.api
                
                # Insertar archivo Excel como objeto OLE embebido
                ole_object = xl_sheet.OLEObjects().Add(
                    Filename=ruta_excel_junto_excel,  # Usar archivo copiado junto al Excel
                    Link=False,  # False = embebido (va dentro del Excel)
                    DisplayAsIcon=True,  # Mostrar como icono
                    IconFileName="",  # Usar icono predeterminado
                    IconIndex=0,
                    IconLabel=os.path.basename(ruta_excel_junto_excel)
                )
                
                # Posicionar el objeto en la celda espec√≠fica
                celda_range = ws.range('N52')
                ole_object.Left = celda_range.left
                ole_object.Top = celda_range.top
                ole_object.Width = 100
                ole_object.Height = 80
                
                print(f"‚úÖ Excel embebido exitosamente como objeto OLE en N52")
                resultados.append({
                    'tipo': 'Excel (embebido)',
                    'descripcion': 'Archivo Excel',
                    'destino': 'N52',
                    'archivo': os.path.basename(ruta_excel_junto_excel),
                    'success': True
                })
                
            except Exception as excel_error:
                print(f"‚ùå Error embebiendo Excel: {excel_error}")
                
                # Si falla el embebido OLE, insertar solo texto descriptivo (SIN hiperv√≠nculo)
                try:
                    celda_excel_obj = ws.range('N52')
                    celda_excel_obj.value = f"üìä Excel: {os.path.basename(ruta_excel_junto_excel)}"
                    celda_excel_obj.font.bold = True
                    celda_excel_obj.font.color = (0, 128, 0)  # Verde para Excel
                    print(f"‚úÖ Texto descriptivo insertado en N52: {os.path.basename(ruta_excel_junto_excel)}")
                    
                    resultados.append({
                        'tipo': 'Excel (texto)',
                        'descripcion': 'Archivo Excel',
                        'destino': 'N52',
                        'archivo': os.path.basename(ruta_excel_junto_excel),
                        'success': True,
                        'nota': 'Embebido como texto porque OLE fall√≥'
                    })
                    
                except Exception as text_error:
                    print(f"‚ùå Error insertando texto para Excel: {text_error}")
                    resultados.append({
                        'tipo': 'Excel (error)',
                        'descripcion': 'Archivo Excel',
                        'destino': 'N52',
                        'archivo': os.path.basename(ruta_excel_junto_excel),
                        'success': False,
                        'error': f'Error OLE: {str(excel_error)}, Error texto: {str(text_error)}'
                    })
            
            # Guardar Excel
            print(f"üíæ Guardando Excel...")
            wb.save()
            print(f"‚úÖ Excel guardado exitosamente")
            
            # Cerrar Excel
            print(f"üîí Cerrando Excel...")
            wb.close()
            app_excel.quit()
            print(f"‚úÖ Excel cerrado correctamente")
            
            # Contar √©xitos
            exitos = sum(1 for r in resultados if r['success'])
            total_archivos = 2  # 1 imagen + 1 Excel
            
            # Preparar respuesta
            response_data = {
                'success': True,
                'message': f'{exitos}/{total_archivos} archivos insertados exitosamente en la hoja "{destino_hoja}"',
                'archivos_procesados': total_archivos,
                'resultados': resultados,
                'hoja': destino_hoja,
                'rango_imagen': 'B36:AJ45',
                'celda_excel': 'N52'
            }
            
            print(f"üì§ Enviando respuesta exitosa: {exitos}/{total_archivos} archivos")
            return jsonify(response_data)
            
        except Exception as excel_error:
            print(f"‚ùå Error con xlwings: {excel_error}")
            try:
                if 'wb' in locals():
                    wb.close()
                if 'app_excel' in locals():
                    app_excel.quit()
            except:
                pass
            return jsonify({'success': False, 'error': f'Error integrando archivos en Excel: {str(excel_error)}'})
        
    except Exception as e:
        print(f"‚ùå Error general subiendo Excel + Imagen: {e}")
        import traceback
        traceback.print_exc()
        return jsonify({
            'success': False,
            'error': f'Error interno: {str(e)}'
        })


@app.route('/subir_torres_antenas', methods=['POST'])
@error_handler
def subir_torres_antenas():
    """
    Endpoint para subir 3 im√°genes para la hoja "6. Estudio torres y antenas"
    
    Ubicaciones:
    - Imagen 1: C17:AK60
    - Imagen 2: C69:AK123  
    - Imagen 3: C134:AK173
    """
    try:
        print("üóº === INICIANDO SUBIDA DE TORRES Y ANTENAS ===")
        
        # Obtener datos del formulario
        user_id = request.form.get('user_id')
        fila_idx = request.form.get('fila_idx')
        
        if not user_id:
            return jsonify({'success': False, 'error': 'Falta el user_id'})
        
        print(f"üë§ User ID: {user_id}")
        print(f"üìç Fila: {fila_idx}")
        
        # Obtener las 3 im√°genes
        imagenes_torres = request.files.getlist('imagenes_torres')
        if len(imagenes_torres) != 3:
            return jsonify({'success': False, 'error': f'Se requieren exactamente 3 im√°genes, recibidas: {len(imagenes_torres)}'})
        
        # Validar tipos de archivo
        for i, imagen in enumerate(imagenes_torres):
            if not imagen.content_type.startswith('image/'):
                return jsonify({'success': False, 'error': f'Imagen {i+1}: Solo se permiten archivos de imagen'})
        
        print(f"‚úÖ Archivos validados: 3 im√°genes")
        
        # Crear directorio permanente
        base_dir = os.path.dirname(os.path.abspath(__file__))
        
        # Directorio para im√°genes de torres
        imagenes_torres_dir = os.path.join(base_dir, 'archivos_permanentes', 'imagenes_torres', user_id)
        os.makedirs(imagenes_torres_dir, exist_ok=True)
        
        print(f"üìÅ Directorio permanente creado")
        
        # Guardar archivos permanentemente
        rutas_imagenes = []
        for i, imagen in enumerate(imagenes_torres):
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            nombre_archivo = f"torres_img_{i+1}_{timestamp}_{secure_filename(imagen.filename)}"
            ruta_imagen = os.path.join(imagenes_torres_dir, nombre_archivo)
            imagen.save(ruta_imagen)
            rutas_imagenes.append(ruta_imagen)
            print(f"üíæ Imagen {i+1} guardada: {nombre_archivo}")
        
        # Buscar el archivo Excel de dise√±o m√°s reciente
        archivos_excel_diseno = buscar_archivos_excel(user_id, fila_idx)
        if not archivos_excel_diseno:
            return jsonify({'success': False, 'error': 'No se encontr√≥ el archivo Excel de dise√±o de soluci√≥n'})
        
        archivo_excel_reciente = max(archivos_excel_diseno, key=os.path.getmtime)
        print(f"üìÑ Excel de dise√±o encontrado: {archivo_excel_reciente}")
        
        # Copiar archivos junto al Excel para portabilidad
        excel_dir = os.path.dirname(archivo_excel_reciente)
        
        # Copiar im√°genes junto al Excel
        rutas_imagenes_junto_excel = []
        for i, ruta_imagen in enumerate(rutas_imagenes):
            nombre_imagen = f"IMG_TORRES_{i+1}_{os.path.basename(ruta_imagen)}"
            ruta_junto_excel = os.path.join(excel_dir, nombre_imagen)
            shutil.copy2(ruta_imagen, ruta_junto_excel)
            rutas_imagenes_junto_excel.append(ruta_junto_excel)
            print(f"üìã Imagen {i+1} copiada junto al Excel: {nombre_imagen}")
        
        # INTEGRAR CON EXCEL usando xlwings
        print(f"üîó Integrando im√°genes en Excel...")
        
        try:
            # Abrir Excel con xlwings
            print(f"üìÇ Abriendo Excel con xlwings...")
            app_excel = xw.App(visible=False, add_book=False)
            app_excel.display_alerts = False
            app_excel.screen_updating = False
            
            wb = app_excel.books.open(archivo_excel_reciente)
            print(f"‚úÖ Excel abierto exitosamente")
            
            # Buscar la hoja "6. Estudio torres y antenas" (con variaciones posibles)
            posibles_nombres = [
                "6. Estudio torres y antenas",
                "6. Estudio torres y antenas",
                "Estudio torres y antenas",
                "Estudio torres",
                "6. Torres y antenas",
                "Torres y antenas"
            ]
            
            ws = None
            destino_hoja = None
            
            # Primero listar todas las hojas disponibles para debug
            print(f"üîç Hojas disponibles en el Excel:")
            for i, sheet in enumerate(wb.sheets):
                print(f"  {i+1}. '{sheet.name}'")
            
            # Buscar coincidencia con los nombres posibles
            for nombre_posible in posibles_nombres:
                for sheet in wb.sheets:
                    if nombre_posible.lower() in sheet.name.lower():
                        ws = sheet
                        destino_hoja = sheet.name
                        print(f"‚úÖ Hoja encontrada: '{destino_hoja}' (buscaba: '{nombre_posible}')")
                        break
                if ws:
                    break
            
            if not ws:
                # Crear lista de hojas disponibles para el mensaje de error
                hojas_disponibles = [sheet.name for sheet in wb.sheets]
                wb.close()
                app_excel.quit()
                return jsonify({
                    'success': False, 
                    'error': f'No se encontr√≥ ninguna hoja con nombres relacionados a "6. Estudio torres y antenas". Hojas disponibles: {", ".join(hojas_disponibles)}'
                })
            
            print(f"‚úÖ Hoja encontrada: {ws.name}")
            
            resultados = []
            
            # DEFINIR RANGOS PARA LAS 3 IM√ÅGENES
            rangos_imagenes = [
                ('C17:AK60', 'Torres imagen 1'),
                ('C69:AK123', 'Torres imagen 2'), 
                ('C134:AK173', 'Torres imagen 3')
            ]
            
            # INSERTAR LAS 3 IM√ÅGENES
            for i, (rango, descripcion) in enumerate(rangos_imagenes):
                if i < len(rutas_imagenes_junto_excel):
                    try:
                        print(f"üñºÔ∏è Insertando {descripcion} en rango {rango}")
                        
                        rango_obj = ws.range(rango)
                        
                        # Insertar imagen en el rango
                        picture = ws.pictures.add(
                            rutas_imagenes_junto_excel[i],
                            left=rango_obj.left,
                            top=rango_obj.top,
                            width=rango_obj.width,
                            height=rango_obj.height
                        )
                        
                        print(f"‚úÖ {descripcion} insertada exitosamente en {rango}")
                        resultados.append({
                            'tipo': 'Imagen',
                            'descripcion': descripcion,
                            'destino': rango,
                            'archivo': os.path.basename(rutas_imagenes_junto_excel[i]),
                            'success': True
                        })
                        
                    except Exception as img_error:
                        print(f"‚ùå Error insertando {descripcion}: {img_error}")
                        resultados.append({
                            'tipo': 'Imagen',
                            'descripcion': descripcion,
                            'destino': rango,
                            'archivo': os.path.basename(rutas_imagenes_junto_excel[i]) if i < len(rutas_imagenes_junto_excel) else 'N/A',
                            'success': False,
                            'error': str(img_error)
                        })
            
            # Guardar Excel
            print(f"üíæ Guardando Excel...")
            wb.save()
            print(f"‚úÖ Excel guardado exitosamente")
            
            # Cerrar Excel
            print(f"üîí Cerrando Excel...")
            wb.close()
            app_excel.quit()
            print(f"‚úÖ Excel cerrado correctamente")
            
            # Contar √©xitos
            exitos = sum(1 for r in resultados if r['success'])
            total_archivos = 3  # 3 im√°genes
            
            # Preparar respuesta
            response_data = {
                'success': True,
                'message': f'{exitos}/{total_archivos} im√°genes insertadas exitosamente en la hoja "{destino_hoja}"',
                'archivos_procesados': total_archivos,
                'resultados': resultados,
                'hoja': destino_hoja,
                'rangos_imagenes': [rango for rango, _ in rangos_imagenes]
            }
            
            print(f"üì§ Enviando respuesta exitosa: {exitos}/{total_archivos} im√°genes")
            return jsonify(response_data)
            
        except Exception as excel_error:
            print(f"‚ùå Error con xlwings: {excel_error}")
            try:
                if 'wb' in locals():
                    wb.close()
                if 'app_excel' in locals():
                    app_excel.quit()
            except:
                pass
            return jsonify({'success': False, 'error': f'Error integrando im√°genes en Excel: {str(excel_error)}'})
        
    except Exception as e:
        print(f"‚ùå Error general subiendo torres y antenas: {e}")
        import traceback
        traceback.print_exc()
        return jsonify({
            'success': False,
            'error': f'Error interno: {str(e)}'
        })


@app.route('/subir_torres_antenas_b', methods=['POST'])
@error_handler
def subir_torres_antenas_b():
    """
    Endpoint para subir 3 im√°genes para la hoja "7. Estudio torres y antenas B"
    
    Ubicaciones:
    - Imagen 1: C15:AK58
    - Imagen 2: C67:AK121  
    - Imagen 3: C132:AK171
    """
    try:
        print("üóº === INICIANDO SUBIDA DE TORRES Y ANTENAS B ===")
        
        # Obtener datos del formulario
        user_id = request.form.get('user_id')
        fila_idx = request.form.get('fila_idx')
        
        if not user_id:
            return jsonify({'success': False, 'error': 'Falta el user_id'})
        
        print(f"üë§ User ID: {user_id}")
        print(f"üìç Fila: {fila_idx}")
        
        # Obtener las 3 im√°genes
        imagenes_torres_b = request.files.getlist('imagenes_torres_b')
        if len(imagenes_torres_b) != 3:
            return jsonify({'success': False, 'error': f'Se requieren exactamente 3 im√°genes, recibidas: {len(imagenes_torres_b)}'})
        
        # Validar tipos de archivo
        for i, imagen in enumerate(imagenes_torres_b):
            if not imagen.content_type.startswith('image/'):
                return jsonify({'success': False, 'error': f'Imagen {i+1}: Solo se permiten archivos de imagen'})
        
        print(f"‚úÖ Archivos validados: 3 im√°genes")
        
        # Crear directorio permanente
        base_dir = os.path.dirname(os.path.abspath(__file__))
        
        # Directorio para im√°genes de torres B
        imagenes_torres_b_dir = os.path.join(base_dir, 'archivos_permanentes', 'imagenes_torres_b', user_id)
        os.makedirs(imagenes_torres_b_dir, exist_ok=True)
        
        print(f"üìÅ Directorio permanente creado")
        
        # Guardar archivos permanentemente
        rutas_imagenes = []
        for i, imagen in enumerate(imagenes_torres_b):
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            nombre_archivo = f"torres_b_img_{i+1}_{timestamp}_{secure_filename(imagen.filename)}"
            ruta_imagen = os.path.join(imagenes_torres_b_dir, nombre_archivo)
            imagen.save(ruta_imagen)
            rutas_imagenes.append(ruta_imagen)
            print(f"üíæ Imagen {i+1} guardada: {nombre_archivo}")
        
        # Buscar el archivo Excel de dise√±o m√°s reciente
        archivos_excel_diseno = buscar_archivos_excel(user_id, fila_idx)
        if not archivos_excel_diseno:
            return jsonify({'success': False, 'error': 'No se encontr√≥ el archivo Excel de dise√±o de soluci√≥n'})
        
        archivo_excel_reciente = max(archivos_excel_diseno, key=os.path.getmtime)
        print(f"üìÑ Excel de dise√±o encontrado: {archivo_excel_reciente}")
        
        # Copiar archivos junto al Excel para portabilidad
        excel_dir = os.path.dirname(archivo_excel_reciente)
        
        # Copiar im√°genes junto al Excel
        rutas_imagenes_junto_excel = []
        for i, ruta_imagen in enumerate(rutas_imagenes):
            nombre_imagen = f"IMG_TORRES_B_{i+1}_{os.path.basename(ruta_imagen)}"
            ruta_junto_excel = os.path.join(excel_dir, nombre_imagen)
            shutil.copy2(ruta_imagen, ruta_junto_excel)
            rutas_imagenes_junto_excel.append(ruta_junto_excel)
            print(f"üìã Imagen {i+1} copiada junto al Excel: {nombre_imagen}")
        
        # INTEGRAR CON EXCEL usando xlwings
        print(f"üîó Integrando im√°genes en Excel...")
        
        try:
            # Abrir Excel con xlwings
            print(f"üìÇ Abriendo Excel con xlwings...")
            app_excel = xw.App(visible=False, add_book=False)
            app_excel.display_alerts = False
            app_excel.screen_updating = False
            
            wb = app_excel.books.open(archivo_excel_reciente)
            print(f"‚úÖ Excel abierto exitosamente")
            
            # Buscar la hoja "7. Estudio torres y antenas B" (con variaciones posibles)
            posibles_nombres = [
                "7. Estudio torres y antenas B",
                "7. Estudio torres y antenas B",
                "Estudio torres y antenas B",
                "Estudio torres B",
                "7. Torres y antenas B",
                "Torres y antenas B"
            ]
            
            ws = None
            destino_hoja = None
            
            # Primero listar todas las hojas disponibles para debug
            print(f"üîç Hojas disponibles en el Excel:")
            for i, sheet in enumerate(wb.sheets):
                print(f"  {i+1}. '{sheet.name}'")
            
            # Buscar coincidencia con los nombres posibles
            for nombre_posible in posibles_nombres:
                for sheet in wb.sheets:
                    if nombre_posible.lower() in sheet.name.lower():
                        ws = sheet
                        destino_hoja = sheet.name
                        print(f"‚úÖ Hoja encontrada: '{destino_hoja}' (buscaba: '{nombre_posible}')")
                        break
                if ws:
                    break
            
            if not ws:
                # Crear lista de hojas disponibles para el mensaje de error
                hojas_disponibles = [sheet.name for sheet in wb.sheets]
                wb.close()
                app_excel.quit()
                return jsonify({
                    'success': False, 
                    'error': f'No se encontr√≥ ninguna hoja con nombres relacionados a "7. Estudio torres y antenas B". Hojas disponibles: {", ".join(hojas_disponibles)}'
                })
            
            print(f"‚úÖ Hoja encontrada: {ws.name}")
            
            resultados = []
            
            # DEFINIR RANGOS PARA LAS 3 IM√ÅGENES
            rangos_imagenes = [
                ('C15:AK58', 'Torres B imagen 1'),
                ('C67:AK121', 'Torres B imagen 2'), 
                ('C132:AK171', 'Torres B imagen 3')
            ]
            
            # INSERTAR LAS 3 IM√ÅGENES
            for i, (rango, descripcion) in enumerate(rangos_imagenes):
                if i < len(rutas_imagenes_junto_excel):
                    try:
                        print(f"üñºÔ∏è Insertando {descripcion} en rango {rango}")
                        
                        rango_obj = ws.range(rango)
                        
                        # Insertar imagen en el rango
                        picture = ws.pictures.add(
                            rutas_imagenes_junto_excel[i],
                            left=rango_obj.left,
                            top=rango_obj.top,
                            width=rango_obj.width,
                            height=rango_obj.height
                        )
                        
                        print(f"‚úÖ {descripcion} insertada exitosamente en {rango}")
                        resultados.append({
                            'tipo': 'Imagen',
                            'descripcion': descripcion,
                            'destino': rango,
                            'archivo': os.path.basename(rutas_imagenes_junto_excel[i]),
                            'success': True
                        })
                        
                    except Exception as img_error:
                        print(f"‚ùå Error insertando {descripcion}: {img_error}")
                        resultados.append({
                            'tipo': 'Imagen',
                            'descripcion': descripcion,
                            'destino': rango,
                            'archivo': os.path.basename(rutas_imagenes_junto_excel[i]) if i < len(rutas_imagenes_junto_excel) else 'N/A',
                            'success': False,
                            'error': str(img_error)
                        })
            
            # Guardar Excel
            print(f"üíæ Guardando Excel...")
            wb.save()
            print(f"‚úÖ Excel guardado exitosamente")
            
            # Cerrar Excel
            print(f"üîí Cerrando Excel...")
            wb.close()
            app_excel.quit()
            print(f"‚úÖ Excel cerrado correctamente")
            
            # Contar √©xitos
            exitos = sum(1 for r in resultados if r['success'])
            total_archivos = 3  # 3 im√°genes
            
            # Preparar respuesta
            response_data = {
                'success': True,
                'message': f'{exitos}/{total_archivos} im√°genes insertadas exitosamente en la hoja "{destino_hoja}"',
                'archivos_procesados': total_archivos,
                'resultados': resultados,
                'hoja': destino_hoja,
                'rangos_imagenes': [rango for rango, _ in rangos_imagenes]
            }
            
            print(f"üì§ Enviando respuesta exitosa: {exitos}/{total_archivos} im√°genes")
            return jsonify(response_data)
            
        except Exception as excel_error:
            print(f"‚ùå Error con xlwings: {excel_error}")
            try:
                if 'wb' in locals():
                    wb.close()
                if 'app_excel' in locals():
                    app_excel.quit()
            except:
                pass
            return jsonify({'success': False, 'error': f'Error integrando im√°genes en Excel: {str(excel_error)}'})
        
    except Exception as e:
        print(f"‚ùå Error general subiendo torres y antenas B: {e}")
        import traceback
        traceback.print_exc()
        return jsonify({
            'success': False,
            'error': f'Error interno: {str(e)}'
        })


@app.route('/subir_factibilidad_fotos_a', methods=['POST'])
@error_handler
def subir_factibilidad_fotos_a():
    """
    Endpoint para subir hasta 19 im√°genes para la hoja "9. Factibilidad Reporte Fotos A"
    Las im√°genes que no se suban se marcar√°n como "N/A"
    """
    try:
        print("üì∑ === INICIANDO SUBIDA DE FACTIBILIDAD FOTOS A ===")
        
        # Obtener datos del formulario
        user_id = request.form.get('user_id')
        fila_idx = request.form.get('fila_idx')
        
        if not user_id:
            return jsonify({'success': False, 'error': 'Falta el user_id'})
        
        print(f"üë§ User ID: {user_id}")
        print(f"üìç Fila: {fila_idx}")
        
        # Obtener las im√°genes desde el formulario HTML (pueden ser de 0 a 19)
        imagenes_factibilidad_a = []
        for i in range(1, 20):  # imagen_1 a imagen_19
            imagen = request.files.get(f'imagen_{i}')
            if imagen and imagen.filename:  # Solo agregar si hay archivo
                imagenes_factibilidad_a.append(imagen)
        
        print(f"üìÅ Im√°genes recibidas: {len(imagenes_factibilidad_a)}")
        
        # Validar tipos de archivo
        for i, imagen in enumerate(imagenes_factibilidad_a):
            if not imagen.content_type.startswith('image/'):
                return jsonify({'success': False, 'error': f'Imagen {i+1}: Solo se permiten archivos de imagen'})
        
        print(f"‚úÖ Archivos validados: {len(imagenes_factibilidad_a)} im√°genes")
        
        # Crear directorio permanente
        base_dir = os.path.dirname(os.path.abspath(__file__))
        
        # Directorio para im√°genes de factibilidad A
        imagenes_factibilidad_a_dir = os.path.join(base_dir, 'archivos_permanentes', 'imagenes_factibilidad_a', user_id)
        os.makedirs(imagenes_factibilidad_a_dir, exist_ok=True)
        
        print(f"üìÅ Directorio permanente creado")
        
        # Guardar archivos permanentemente
        rutas_imagenes = []
        for i, imagen in enumerate(imagenes_factibilidad_a):
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            nombre_archivo = f"factibilidad_a_img_{i+1}_{timestamp}_{secure_filename(imagen.filename)}"
            ruta_imagen = os.path.join(imagenes_factibilidad_a_dir, nombre_archivo)
            imagen.save(ruta_imagen)
            rutas_imagenes.append(ruta_imagen)
            print(f"üíæ Imagen {i+1} guardada: {nombre_archivo}")
        
        # Buscar el archivo Excel de dise√±o m√°s reciente
        archivos_excel_diseno = buscar_archivos_excel(user_id, fila_idx)
        if not archivos_excel_diseno:
            return jsonify({'success': False, 'error': 'No se encontr√≥ el archivo Excel de dise√±o de soluci√≥n'})
        
        archivo_excel_reciente = max(archivos_excel_diseno, key=os.path.getmtime)
        print(f"üìÑ Excel de dise√±o encontrado: {archivo_excel_reciente}")
        
        # Copiar archivos junto al Excel para portabilidad
        excel_dir = os.path.dirname(archivo_excel_reciente)
        
        # Copiar im√°genes junto al Excel
        rutas_imagenes_junto_excel = []
        for i, ruta_imagen in enumerate(rutas_imagenes):
            nombre_imagen = f"IMG_FACTIBILIDAD_A_{i+1}_{os.path.basename(ruta_imagen)}"
            ruta_junto_excel = os.path.join(excel_dir, nombre_imagen)
            shutil.copy2(ruta_imagen, ruta_junto_excel)
            rutas_imagenes_junto_excel.append(ruta_junto_excel)
            print(f"üìã Imagen {i+1} copiada junto al Excel: {nombre_imagen}")
        
        # INTEGRAR CON EXCEL usando xlwings
        print(f"üîó Integrando im√°genes en Excel...")
        
        try:
            # Abrir Excel con xlwings
            print(f"üìÇ Abriendo Excel con xlwings...")
            app_excel = xw.App(visible=False, add_book=False)
            app_excel.display_alerts = False
            app_excel.screen_updating = False
            
            wb = app_excel.books.open(archivo_excel_reciente)
            print(f"‚úÖ Excel abierto exitosamente")
            
            # Buscar la hoja "9. Factibilidad Reporte Fotos A" (con variaciones posibles)
            posibles_nombres = [
                "9. Factibilidad Reporte Fotos A",
                "9. Factibilidad Reporte Fotos A",
                "Factibilidad Reporte Fotos A",
                "9. Reporte Fotos A",
                "Reporte Fotos A"
            ]
            
            ws = None
            destino_hoja = None
            
            # Primero listar todas las hojas disponibles para debug
            print(f"üîç Hojas disponibles en el Excel:")
            for i, sheet in enumerate(wb.sheets):
                print(f"  {i+1}. '{sheet.name}'")
            
            # Buscar coincidencia con los nombres posibles
            for nombre_posible in posibles_nombres:
                for sheet in wb.sheets:
                    if nombre_posible.lower() in sheet.name.lower():
                        ws = sheet
                        destino_hoja = sheet.name
                        print(f"‚úÖ Hoja encontrada: '{destino_hoja}' (buscaba: '{nombre_posible}')")
                        break
                if ws:
                    break
            
            if not ws:
                # Crear lista de hojas disponibles para el mensaje de error
                hojas_disponibles = [sheet.name for sheet in wb.sheets]
                wb.close()
                app_excel.quit()
                return jsonify({
                    'success': False, 
                    'error': f'No se encontr√≥ ninguna hoja con nombres relacionados a "9. Factibilidad Reporte Fotos A". Hojas disponibles: {", ".join(hojas_disponibles)}'
                })
            
            print(f"‚úÖ Hoja encontrada: {ws.name}")
            
            # DEFINIR RANGOS PARA LAS 19 IM√ÅGENES (igual que en site survey)
            celdas_imagenes = {
                1: 'G11:L18',   # 6.3.1 Foto linea de Vista de Sitio A a Sitio B
                2: 'X11:AD18',  # 6.3.2 Foto linea de Vista de Sitio A a Sitio B Diversidad
                3: 'G23:L30',   # 6.1.3 Foto de torre completa
                4: 'G48:L55',   # 6.2.1 Foto desde piso mostrando el espacio en torre para antena de MW conforme a topologia
                5: 'X48:AD55',  # 6.2.2 Medici√≥n con cinta del rad center en torre conforme a topologia
                6: 'G59:L66',   # 6.2.3 Foto desde piso mostrando el espacio en torre para antena de MW (SD)
                7: 'X59:AD66',  # 6.2.4 Medici√≥n con cinta del rad center en torre (SD)
                8: 'G70:L77',   # 6.2.5 Foto desde piso mostrando el espacio (propuesto) en torre para antena
                9: 'X70:AD77',  # 6.2.6 Medici√≥n con cinta del rad center (propuesto) en torre conforme a topologia
                10: 'G87:L94',  # 6.3.1 Foto linea de Vista de Sitio A a Sitio B
                11: 'X87:AD94', # 6.3.2 Foto linea de Vista de Sitio A a Sitio B Diversidad
                12: 'G98:L105', # 6.3.3 Foto Barra de Tierra
                13: 'X98:AD105', # 6.3.4 Foto de escalerilla de torre
                14: 'G127:L134', # 6.4.1 Foto del espacio disponible dentro del Gabinete OMB
                15: 'X127:AD134', # 6.4.2 Foto del espacio disponible en torre para OMB adicional
                16: 'G138:L145', # 6.4.3 Foto DPU existente
                17: 'X138:AD145', # 6.4.4 Foto del espacio disponible en torre para DPU y Bateria
                18: 'G150:L157', # 6.4.5 Foto ACDB y Breaker
                19: 'X150:AD157', # 6.4.6 Foto de Agregador (Site Entry)
            }
            
            resultados = []
            imagenes_subidas = 0
            celdas_na = 0
            
            # PROCESAR TODAS LAS POSICIONES (1-19)
            for posicion in range(1, 20):
                rango = celdas_imagenes[posicion]
                
                if posicion <= len(rutas_imagenes_junto_excel):
                    # HAY IMAGEN PARA ESTA POSICI√ìN
                    try:
                        print(f"üñºÔ∏è Insertando imagen {posicion} en rango {rango}")
                        
                        rango_obj = ws.range(rango)
                        
                        # Insertar imagen en el rango
                        picture = ws.pictures.add(
                            rutas_imagenes_junto_excel[posicion-1],
                            left=rango_obj.left,
                            top=rango_obj.top,
                            width=rango_obj.width,
                            height=rango_obj.height
                        )
                        
                        print(f"‚úÖ Imagen {posicion} insertada exitosamente en {rango}")
                        resultados.append({
                            'posicion': posicion,
                            'tipo': 'Imagen',
                            'destino': rango,
                            'archivo': os.path.basename(rutas_imagenes_junto_excel[posicion-1]),
                            'success': True
                        })
                        imagenes_subidas += 1
                        
                    except Exception as img_error:
                        print(f"‚ùå Error insertando imagen {posicion}: {img_error}")
                        resultados.append({
                            'posicion': posicion,
                            'tipo': 'Imagen',
                            'destino': rango,
                            'archivo': os.path.basename(rutas_imagenes_junto_excel[posicion-1]),
                            'success': False,
                            'error': str(img_error)
                        })
                else:
                    # NO HAY IMAGEN PARA ESTA POSICI√ìN - COLOCAR N/A
                    try:
                        print(f"üìù Colocando N/A en posici√≥n {posicion} en rango {rango}")
                        
                        # Escribir "N/A" en la celda superior izquierda del rango
                        celda_na = rango.split(':')[0]  # Obtener primera celda del rango (ej: G11 de G11:L18)
                        ws.range(celda_na).value = "N/A"
                        
                        print(f"‚úÖ N/A colocado en posici√≥n {posicion} celda {celda_na}")
                        resultados.append({
                            'posicion': posicion,
                            'tipo': 'N/A',
                            'destino': celda_na,
                            'archivo': 'N/A',
                            'success': True
                        })
                        celdas_na += 1
                        
                    except Exception as na_error:
                        print(f"‚ùå Error colocando N/A en posici√≥n {posicion}: {na_error}")
                        resultados.append({
                            'posicion': posicion,
                            'tipo': 'N/A',
                            'destino': rango,
                            'archivo': 'N/A',
                            'success': False,
                            'error': str(na_error)
                        })
            
            # Guardar Excel
            print(f"üíæ Guardando Excel...")
            wb.save()
            print(f"‚úÖ Excel guardado exitosamente")
            
            # Cerrar Excel
            print(f"üîí Cerrando Excel...")
            wb.close()
            app_excel.quit()
            print(f"‚úÖ Excel cerrado correctamente")
            
            # Preparar respuesta
            response_data = {
                'success': True,
                'message': f'Procesadas {imagenes_subidas} im√°genes y {celdas_na} celdas N/A en la hoja "{destino_hoja}"',
                'imagenes_subidas': imagenes_subidas,
                'celdas_na': celdas_na,
                'total_procesado': 19,
                'resultados': resultados,
                'hoja': destino_hoja
            }
            
            print(f"üì§ Enviando respuesta exitosa: {imagenes_subidas} im√°genes, {celdas_na} N/A")
            return jsonify(response_data)
            
        except Exception as excel_error:
            print(f"‚ùå Error con xlwings: {excel_error}")
            try:
                if 'wb' in locals():
                    wb.close()
                if 'app_excel' in locals():
                    app_excel.quit()
            except:
                pass
            return jsonify({'success': False, 'error': f'Error integrando im√°genes en Excel: {str(excel_error)}'})
        
    except Exception as e:
        print(f"‚ùå Error general subiendo factibilidad fotos A: {e}")
        import traceback
        traceback.print_exc()
        return jsonify({
            'success': False,
            'error': f'Error interno: {str(e)}'
        })


@app.route('/subir_reporte_fotos_b', methods=['POST'])
@error_handler
def subir_reporte_fotos_b():
    """
    Endpoint para subir hasta 19 im√°genes para la hoja "10. Reporte Fotos B"
    Las im√°genes que no se suban se marcar√°n como "N/A"
    """
    try:
        print("üì∑ === INICIANDO SUBIDA DE REPORTE FOTOS B ===")
        
        # Obtener datos del formulario
        user_id = request.form.get('user_id')
        fila_idx = request.form.get('fila_idx')
        
        if not user_id:
            return jsonify({'success': False, 'error': 'Falta el user_id'})
        
        print(f"üë§ User ID: {user_id}")
        print(f"üìç Fila: {fila_idx}")
        
        # Obtener las im√°genes desde el formulario HTML (pueden ser de 0 a 19)
        imagenes_reporte_b = []
        for i in range(1, 20):  # imagen_1 a imagen_19
            imagen = request.files.get(f'imagen_{i}')
            if imagen and imagen.filename:  # Solo agregar si hay archivo
                imagenes_reporte_b.append(imagen)
        
        print(f"üìÅ Im√°genes recibidas: {len(imagenes_reporte_b)}")
        
        # Validar tipos de archivo
        for i, imagen in enumerate(imagenes_reporte_b):
            if not imagen.content_type.startswith('image/'):
                return jsonify({'success': False, 'error': f'Imagen {i+1}: Solo se permiten archivos de imagen'})
        
        print(f"‚úÖ Archivos validados: {len(imagenes_reporte_b)} im√°genes")
        
        # Crear directorio permanente
        base_dir = os.path.dirname(os.path.abspath(__file__))
        
        # Directorio para im√°genes de reporte B
        imagenes_reporte_b_dir = os.path.join(base_dir, 'archivos_permanentes', 'imagenes_reporte_b', user_id)
        os.makedirs(imagenes_reporte_b_dir, exist_ok=True)
        
        print(f"üìÅ Directorio permanente creado")
        
        # Guardar archivos permanentemente
        rutas_imagenes = []
        for i, imagen in enumerate(imagenes_reporte_b):
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            nombre_archivo = f"reporte_b_img_{i+1}_{timestamp}_{secure_filename(imagen.filename)}"
            ruta_imagen = os.path.join(imagenes_reporte_b_dir, nombre_archivo)
            imagen.save(ruta_imagen)
            rutas_imagenes.append(ruta_imagen)
            print(f"üíæ Imagen {i+1} guardada: {nombre_archivo}")
        
        # Buscar el archivo Excel de dise√±o m√°s reciente
        archivos_excel_diseno = buscar_archivos_excel(user_id, fila_idx)
        if not archivos_excel_diseno:
            return jsonify({'success': False, 'error': 'No se encontr√≥ el archivo Excel de dise√±o de soluci√≥n'})
        
        archivo_excel_reciente = max(archivos_excel_diseno, key=os.path.getmtime)
        print(f"üìÑ Excel de dise√±o encontrado: {archivo_excel_reciente}")
        
        # Copiar archivos junto al Excel para portabilidad
        excel_dir = os.path.dirname(archivo_excel_reciente)
        
        # Copiar im√°genes junto al Excel
        rutas_imagenes_junto_excel = []
        for i, ruta_imagen in enumerate(rutas_imagenes):
            nombre_imagen = f"IMG_REPORTE_B_{i+1}_{os.path.basename(ruta_imagen)}"
            ruta_junto_excel = os.path.join(excel_dir, nombre_imagen)
            shutil.copy2(ruta_imagen, ruta_junto_excel)
            rutas_imagenes_junto_excel.append(ruta_junto_excel)
            print(f"üìã Imagen {i+1} copiada junto al Excel: {nombre_imagen}")
        
        # INTEGRAR CON EXCEL usando xlwings
        print(f"üîó Integrando im√°genes en Excel...")
        
        try:
            # Abrir Excel con xlwings
            print(f"üìÇ Abriendo Excel con xlwings...")
            app_excel = xw.App(visible=False, add_book=False)
            app_excel.display_alerts = False
            app_excel.screen_updating = False
            
            wb = app_excel.books.open(archivo_excel_reciente)
            print(f"‚úÖ Excel abierto exitosamente")
            
            # Buscar la hoja "10. Reporte Fotos B" (con variaciones posibles)
            posibles_nombres = [
                "10. Reporte Fotos B",
                "10. Reporte Fotos B",
                "Reporte Fotos B",
                "10. Fotos B",
                "Fotos B"
            ]
            
            ws = None
            destino_hoja = None
            
            # Primero listar todas las hojas disponibles para debug
            print(f"üîç Hojas disponibles en el Excel:")
            for i, sheet in enumerate(wb.sheets):
                print(f"  {i+1}. '{sheet.name}'")
            
            # Buscar coincidencia con los nombres posibles
            for nombre_posible in posibles_nombres:
                for sheet in wb.sheets:
                    if nombre_posible.lower() in sheet.name.lower():
                        ws = sheet
                        destino_hoja = sheet.name
                        print(f"‚úÖ Hoja encontrada: '{destino_hoja}' (buscaba: '{nombre_posible}')")
                        break
                if ws:
                    break
            
            if not ws:
                # Crear lista de hojas disponibles para el mensaje de error
                hojas_disponibles = [sheet.name for sheet in wb.sheets]
                wb.close()
                app_excel.quit()
                return jsonify({
                    'success': False, 
                    'error': f'No se encontr√≥ ninguna hoja con nombres relacionados a "10. Reporte Fotos B". Hojas disponibles: {", ".join(hojas_disponibles)}'
                })
            
            print(f"‚úÖ Hoja encontrada: {ws.name}")
            
            # DEFINIR RANGOS PARA LAS 19 IM√ÅGENES (igual que en site survey fotos B)
            celdas_imagenes = {
                1: 'G11:L18', # 7.4.4 Foto del espacio disponible en torre para DPU y Bateria
                2: 'X11:AD18',  # 7.4.5 Foto ACDB y Breaker
                3: 'G23:L30', # 7.4.6 Foto de Agregador (Site Entry)
                4: 'G48:L55',  # 7.2.1 Foto desde piso mostrando el espacio en torre para antena de MW conforme a topologia
                5: 'X48:AD55', # 7.2.2 Medici√≥n con cinta del rad center en torre conforme a topologia
                6: 'G59:L66',  # 7.1.3 Foto de torre completa
                7: 'X59:AD66', # 7.2.3 Foto desde piso mostrando el espacio en torre para antena de MW (SD)
                8: 'G70:L77',  # 7.2.4 Medici√≥n con cinta del rad center en torre (SD)
                9: 'X70:AD77', # 7.2.5 Foto desde piso mostrando el espacio (propuesto) en torre para antena
                10: 'G87:L94', # 7.2.6 Medici√≥n con cinta del rad center (propuesto) en torre conforme a topologia
                11: 'X87:AD94', # 7.3.1 Foto linea de Vista de Sitio A a Sitio B
                12: 'G98:L105', # 7.3.2 Foto linea de Vista de Sitio A a Sitio B Diversidad
                13: 'X98:AD105', # 7.3.3 Foto Barra de Tierra
                14: 'G127:L134', # 7.3.4 Foto de escalerilla de torre
                15: 'X127:AD134', # 7.4.1 Foto del espacio disponible dentro del Gabinete OMB
                16: 'G138:L145', # 7.4.2 Foto del espacio disponible en torre para OMB adicional
                17: 'X138:AD145', # 7.4.3 Foto DPU existente
                18: 'G150:L157', # 7.4.4 Foto del espacio disponible en torre para DPU y Bateria
                19: 'X150:AD157', # 7.4.5 Foto ACDB y Breaker
            }
            
            resultados = []
            imagenes_subidas = 0
            celdas_na = 0
            
            # PROCESAR TODAS LAS POSICIONES (1-19)
            for posicion in range(1, 20):
                rango = celdas_imagenes[posicion]
                
                if posicion <= len(rutas_imagenes_junto_excel):
                    # HAY IMAGEN PARA ESTA POSICI√ìN
                    try:
                        print(f"üñºÔ∏è Insertando imagen {posicion} en rango {rango}")
                        
                        rango_obj = ws.range(rango)
                        
                        # Insertar imagen en el rango
                        picture = ws.pictures.add(
                            rutas_imagenes_junto_excel[posicion-1],
                            left=rango_obj.left,
                            top=rango_obj.top,
                            width=rango_obj.width,
                            height=rango_obj.height
                        )
                        
                        print(f"‚úÖ Imagen {posicion} insertada exitosamente en {rango}")
                        resultados.append({
                            'posicion': posicion,
                            'tipo': 'Imagen',
                            'destino': rango,
                            'archivo': os.path.basename(rutas_imagenes_junto_excel[posicion-1]),
                            'success': True
                        })
                        imagenes_subidas += 1
                        
                    except Exception as img_error:
                        print(f"‚ùå Error insertando imagen {posicion}: {img_error}")
                        resultados.append({
                            'posicion': posicion,
                            'tipo': 'Imagen',
                            'destino': rango,
                            'archivo': os.path.basename(rutas_imagenes_junto_excel[posicion-1]),
                            'success': False,
                            'error': str(img_error)
                        })
                else:
                    # NO HAY IMAGEN PARA ESTA POSICI√ìN - COLOCAR N/A
                    try:
                        print(f"üìù Colocando N/A en posici√≥n {posicion} en rango {rango}")
                        
                        # Escribir "N/A" en la celda superior izquierda del rango
                        celda_na = rango.split(':')[0]  # Obtener primera celda del rango (ej: G11 de G11:L18)
                        ws.range(celda_na).value = "N/A"
                        
                        print(f"‚úÖ N/A colocado en posici√≥n {posicion} celda {celda_na}")
                        resultados.append({
                            'posicion': posicion,
                            'tipo': 'N/A',
                            'destino': celda_na,
                            'archivo': 'N/A',
                            'success': True
                        })
                        celdas_na += 1
                        
                    except Exception as na_error:
                        print(f"‚ùå Error colocando N/A en posici√≥n {posicion}: {na_error}")
                        resultados.append({
                            'posicion': posicion,
                            'tipo': 'N/A',
                            'destino': rango,
                            'archivo': 'N/A',
                            'success': False,
                            'error': str(na_error)
                        })
            
            # Guardar Excel
            print(f"üíæ Guardando Excel...")
            wb.save()
            print(f"‚úÖ Excel guardado exitosamente")
            
            # Cerrar Excel
            print(f"üîí Cerrando Excel...")
            wb.close()
            app_excel.quit()
            print(f"‚úÖ Excel cerrado correctamente")
            
            # Preparar respuesta
            response_data = {
                'success': True,
                'message': f'Procesadas {imagenes_subidas} im√°genes y {celdas_na} celdas N/A en la hoja "{destino_hoja}"',
                'imagenes_subidas': imagenes_subidas,
                'celdas_na': celdas_na,
                'total_procesado': 19,
                'resultados': resultados,
                'hoja': destino_hoja
            }
            
            print(f"üì§ Enviando respuesta exitosa: {imagenes_subidas} im√°genes, {celdas_na} N/A")
            return jsonify(response_data)
            
        except Exception as excel_error:
            print(f"‚ùå Error con xlwings: {excel_error}")
            try:
                if 'wb' in locals():
                    wb.close()
                if 'app_excel' in locals():
                    app_excel.quit()
            except:
                pass
            return jsonify({'success': False, 'error': f'Error integrando im√°genes en Excel: {str(excel_error)}'})
        
    except Exception as e:
        print(f"‚ùå Error general subiendo reporte fotos B: {e}")
        import traceback
        traceback.print_exc()
        return jsonify({
            'success': False,
            'error': f'Error interno: {str(e)}'
        })


@app.route('/subir_factibilidad_fotos_a_page')
@error_handler
def subir_factibilidad_fotos_a_page():
    """
    P√°gina para subir im√°genes de Factibilidad Reporte Fotos A
    """
    user_id = request.args.get('user_id')
    fila_idx = request.args.get('fila_idx', '0')
    
    if not user_id:
        return redirect('/')
    
    return render_template('subir_factibilidad_fotos_a.html', user_id=user_id, fila_idx=fila_idx)


@app.route('/subir_reporte_fotos_b_page')
@error_handler
def subir_reporte_fotos_b_page():
    """
    P√°gina para subir im√°genes de Reporte Fotos B
    """
    user_id = request.args.get('user_id')
    fila_idx = request.args.get('fila_idx', '0')
    
    if not user_id:
        return redirect('/')
    
    return render_template('subir_reporte_fotos_b.html', user_id=user_id, fila_idx=fila_idx)


if __name__ == "__main__":
    try:
        print("Iniciando servidor Flask...")
        
        # Crear directorios de uploads si no existen
        crear_directorios_uploads()
        
        print("El servidor estar√° disponible en:")
        print("  - Local: http://127.0.0.1:5000")
        print("  - Red: http://192.168.1.18:5000")
        print("  - Status: http://127.0.0.1:5000/status")
        print("  - Test: http://127.0.0.1:5000/test")
        print("Presiona Ctrl+C para detener el servidor")
        
        # Configuraci√≥n m√°s robusta del servidor
        port = int(os.environ.get('PORT', 5000))
        host = '0.0.0.0' if os.environ.get('RAILWAY_ENVIRONMENT') else '127.0.0.1'
        
        app.run(
            debug=False, 
            use_reloader=False, 
            host=host,  
            port=port,
            threaded=True  
        )
    except KeyboardInterrupt:
        print("\nServidor detenido por el usuario")
    except Exception as e:
        print(f"Error al iniciar el servidor: {e}")
        input("Presiona Enter para salir...")

