<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enlaces Sonora - Enterprise Network Management Platform | Fangio Telecom</title>
    
    <!-- Advanced Font Loading with Display Swap -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Icon Library with Tree Shaking -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Map Library -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Leaflet Plugins -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    
    <!-- Leaflet Control Layers -->
    <script src="https://unpkg.com/leaflet-control-geocoder@1.13.0/dist/Control.Geocoder.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder@1.13.0/dist/Control.Geocoder.css" />
    
    <!-- Chart Library -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    
    <!-- PDF Generation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Excel Export Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Date/Time Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    
    <!-- Google Maps API for Street View -->
    <script>
        // Global callback function for Google Maps API
        function initGoogleMaps() {
            console.log('‚úÖ Google Maps API loaded successfully with key: AIzaSyAX6hAgfg3Kz7SNClVgmRK1bStQnUJzbEA');
            console.log('‚úÖ Available Google Maps objects:', {
                google: typeof google !== 'undefined',
                maps: typeof google !== 'undefined' && typeof google.maps !== 'undefined',
                StreetViewPanorama: typeof google !== 'undefined' && typeof google.maps !== 'undefined' && typeof google.maps.StreetViewPanorama !== 'undefined'
            });
            window.googleMapsLoaded = true;
            
            // Trigger any pending Street View initializations
            if (window.pendingStreetViewInit) {
                console.log('üîÑ Processing pending Street View initialization...');
                window.pendingStreetViewInit();
                window.pendingStreetViewInit = null;
            }
        }

        // Test function for Street View with known location
        function testStreetViewWithKnownLocation() {
            console.log('üß™ Testing Street View with known location...');
            // Use Hermosillo, Sonora coordinates (known to have Street View)
            const testLat = 29.0892;
            const testLng = -110.9613;
            console.log('üìç Testing with coordinates:', testLat, testLng);
            
            if (window.initializeGoogleStreetView) {
                window.initializeGoogleStreetView(testLat, testLng);
            } else {
                console.error('‚ùå initializeGoogleStreetView function not found');
            }
            
            // Also try embed API
            window.initializeStreetViewEmbed(testLat, testLng, 'Hermosillo, Sonora');
        }

        // Initialize Street View using Embed API (no billing required)
        window.initializeStreetViewEmbed = function initializeStreetViewEmbed(lat, lng, locationName) {
            console.log('üåê Initializing Street View Embed for:', locationName, 'at', lat, lng);
            
            const streetViewContainer = document.getElementById('google-street-view');
            if (!streetViewContainer) {
                console.error('‚ùå Street View container not found');
                return;
            }
            
            // Show loading
            const loadingElement = document.getElementById('street-view-loading');
            const errorElement = document.getElementById('street-view-error');
            
            if (loadingElement) loadingElement.style.display = 'block';
            if (errorElement) errorElement.style.display = 'none';
            streetViewContainer.style.display = 'none';
            
            // Use Google Street View public embed (no API key required, no 403 errors)
            const streetViewUrl = `https://www.google.com/maps/embed?pb=!1m0!3m2!1sen!2sus!4v1234567890123!5m2!1sen!2sus&q=${lat},${lng}&t=h&z=20&output=embed`;
            
            console.log('üîó Street View URL:', streetViewUrl);
            
            // Create iframe with Google Street View Embed
            const iframe = document.createElement('iframe');
            iframe.src = streetViewUrl;
            iframe.width = '100%';
            iframe.height = '100%';
            iframe.frameBorder = '0';
            iframe.style.border = 'none';
            iframe.style.borderRadius = '8px';
            iframe.allowFullscreen = true;
            iframe.title = `Street View - ${locationName}`;
            
            // Clear container and add iframe
            streetViewContainer.innerHTML = '';
            streetViewContainer.appendChild(iframe);
            
            // Handle iframe load
            iframe.onload = () => {
                console.log('‚úÖ Google Street View loaded successfully for', locationName);
            };
            
            iframe.onerror = () => {
                console.error('‚ùå Google Street View failed to load for', locationName);
                // Fallback to regular map if Street View fails
                console.log('üîÑ Falling back to regular map view...');
                const fallbackUrl = `https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3000!2d${lng}!3d${lat}!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x0%3A0x0!2zM${Math.floor(lat)}%C2%B0${Math.floor((lat % 1) * 60)}%27${Math.floor(((lat % 1) * 60) % 1 * 60)}%22N%20${Math.floor(Math.abs(lng))}%C2%B0${Math.floor((Math.abs(lng) % 1) * 60)}%27${Math.floor(((Math.abs(lng) % 1) * 60) % 1 * 60)}%22W!5e0!3m2!1sen!2sus!4v1234567890123!5m2!1sen!2sus`;
                iframe.src = fallbackUrl;
            };
            
            // Show the container
            if (loadingElement) loadingElement.style.display = 'none';
            if (errorElement) errorElement.style.display = 'none';
            streetViewContainer.style.display = 'block';
            
            // Update location info
            const locationText = document.getElementById('street-view-location-text');
            const coordsText = document.getElementById('street-view-coords-text');
            
            if (locationText) {
                locationText.textContent = locationName || `${lat.toFixed(4)}¬∞ N, ${Math.abs(lng).toFixed(4)}¬∞ W`;
            }
            
            if (coordsText) {
                coordsText.textContent = `${lat.toFixed(4)}¬∞ N, ${Math.abs(lng).toFixed(4)}¬∞ W`;
            }
        }

        // Test function for Street View Embed
        function testStreetViewEmbed() {
            console.log('üß™ Testing Street View Embed...');
            // Use Hermosillo, Sonora coordinates
            const testLat = 29.0892;
            const testLng = -110.9613;
            console.log('üìç Testing Embed with coordinates:', testLat, testLng);
            
            window.initializeStreetViewEmbed(testLat, testLng, 'Hermosillo, Sonora - Prueba Embed');
        }

        // Initialize Dual Street View for both stations (simplified)
        window.initializeDualStreetView = function initializeDualStreetView(stationA, stationD) {
            console.log('üîÑ Mostrando estaciones:', stationA.name, '‚Üî', stationD.name);
            
            // Mostrar las dos estaciones en el panel
            showTowerStreetView();
            
            console.log('‚úÖ Estaciones mostradas en el panel');
        }

        // Create Street View iframe with multiple fallback options
        function createStreetViewIframe(lat, lng, locationName) {
            // Use only the user's API key
            const userApiKey = 'AIzaSyAX6hAgfg3Kz7SNClVgmRK1bStQnUJzbEA';
            
            // Create Google Street View public embed (no API key required, no 403 errors)
            console.log(`üîÑ Creating Google Street View for ${locationName} without API key restrictions`);
            
            // Create Street View URL without API key (public access)
            const streetViewUrl = `https://www.google.com/maps/embed?pb=!1m0!3m2!1sen!2sus!4v1234567890123!5m2!1sen!2sus&q=${lat},${lng}&t=h&z=20&output=embed`;
            
            const iframe = document.createElement('iframe');
            iframe.src = streetViewUrl;
            iframe.width = '100%';
            iframe.height = '100%';
            iframe.frameBorder = '0';
            iframe.style.border = 'none';
            iframe.style.borderRadius = '8px';
            iframe.allowFullscreen = true;
            iframe.title = `Street View - ${locationName}`;
            
            iframe.onload = () => {
                console.log(`‚úÖ Google Street View loaded successfully for ${locationName}`);
            };
            
            iframe.onerror = () => {
                console.error(`‚ùå Google Street View failed to load for ${locationName}`);
                // Fallback to regular map if Street View fails
                console.log('üîÑ Falling back to regular map view...');
                const fallbackUrl = `https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3000!2d${lng}!3d${lat}!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x0%3A0x0!2zM${Math.floor(lat)}%C2%B0${Math.floor((lat % 1) * 60)}%27${Math.floor(((lat % 1) * 60) % 1 * 60)}%22N%20${Math.floor(Math.abs(lng))}%C2%B0${Math.floor((Math.abs(lng) % 1) * 60)}%27${Math.floor(((Math.abs(lng) % 1) * 60) % 1 * 60)}%22W!5e0!3m2!1sen!2sus!4v1234567890123!5m2!1sen!2sus`;
                iframe.src = fallbackUrl;
            };
            
            return iframe;
        }
        
        // Show error message in iframe
        function showStreetViewError(iframe, locationName) {
            iframe.style.background = 'var(--color-neutral-100)';
            iframe.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--color-neutral-500); padding: 20px; text-align: center;">
                    <div>
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 16px; color: var(--color-warning-500);"></i>
                        <h3 style="margin: 0 0 8px 0; color: var(--color-neutral-700);">Street View no disponible</h3>
                        <p style="margin: 0 0 8px 0; font-size: 0.9rem;">${locationName}</p>
                        <small style="color: var(--color-neutral-400);">Error de API o ubicaci√≥n sin cobertura</small>
                        <div style="margin-top: 16px;">
                            <button onclick="retryStreetView('${locationName}')" style="
                                background: var(--color-primary-500);
                                color: white;
                                border: none;
                                padding: 8px 16px;
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 0.8rem;
                            ">Reintentar</button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Retry function for failed Street Views
        function retryStreetView(locationName) {
            console.log(`üîÑ Retrying Street View for ${locationName}`);
            // This would need to be implemented to retry the specific location
        }
        
        // Create static map as fallback when Street View is not available
        function createStaticMapFallback(lat, lng, locationName) {
            const staticMapUrl = `https://maps.googleapis.com/maps/api/staticmap?center=${lat},${lng}&zoom=15&size=400x300&maptype=satellite&markers=color:red%7C${lat},${lng}&key=AIzaSyAX6hAgfg3Kz7SNClVgmRK1bStQnUJzbEA`;
            
            const container = document.createElement('div');
            container.style.cssText = `
                width: 100%;
                height: 100%;
                background: var(--color-neutral-100);
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                text-align: center;
                padding: 20px;
                color: var(--color-neutral-600);
            `;
            
            container.innerHTML = `
                <div style="margin-bottom: 16px;">
                    <i class="fas fa-map-marked-alt" style="font-size: 3rem; color: var(--color-primary-500); margin-bottom: 12px;"></i>
                    <h3 style="margin: 0 0 8px 0; color: var(--color-neutral-700);">Vista Satelital</h3>
                    <p style="margin: 0 0 12px 0; font-size: 0.9rem;">${locationName}</p>
                    <small style="color: var(--color-neutral-400);">Street View no disponible - Vista satelital</small>
                </div>
                <div style="width: 100%; max-width: 300px; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                    <img src="${staticMapUrl}" 
                         alt="Mapa satelital de ${locationName}" 
                         style="width: 100%; height: auto; display: block;"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div style="display: none; align-items: center; justify-content: center; height: 200px; background: var(--color-neutral-200); color: var(--color-neutral-500);">
                        <div>
                            <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 8px;"></i>
                            <p style="margin: 0; font-size: 0.9rem;">Mapa no disponible</p>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 16px;">
                    <button onclick="tryStreetViewAgain('${lat}', '${lng}', '${locationName}')" style="
                        background: var(--color-primary-500);
                        color: white;
                        border: none;
                        padding: 8px 16px;
                        border-radius: 4px;
                        cursor: pointer;
                        font-size: 0.8rem;
                        margin-right: 8px;
                    ">Intentar Street View</button>
                    <button onclick="openInGoogleMaps('${lat}', '${lng}')" style="
                        background: var(--color-success-500);
                        color: white;
                        border: none;
                        padding: 8px 16px;
                        border-radius: 4px;
                        cursor: pointer;
                        font-size: 0.8rem;
                    ">Abrir en Google Maps</button>
                </div>
            `;
            
            return container;
        }
        
        // Try Street View again
        function tryStreetViewAgain(lat, lng, locationName) {
            console.log(`üîÑ Trying Street View again for ${locationName}`);
            // This would recreate the iframe with Street View
        }
        
        // Open location in Google Maps
        function openInGoogleMaps(lat, lng) {
            const url = `https://www.google.com/maps/@${lat},${lng},15z`;
            window.open(url, '_blank');
        }
        
        // Create OpenStreetMap fallback
        function createOpenStreetMapFallback(lat, lng, locationName) {
            const container = document.createElement('div');
            container.style.cssText = `
                width: 100%;
                height: 100%;
                background: var(--color-neutral-100);
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                text-align: center;
                padding: 20px;
                color: var(--color-neutral-600);
            `;
            
            container.innerHTML = `
                <div style="margin-bottom: 16px;">
                    <i class="fas fa-map" style="font-size: 3rem; color: var(--color-primary-500); margin-bottom: 12px;"></i>
                    <h3 style="margin: 0 0 8px 0; color: var(--color-neutral-700);">Vista de Mapa</h3>
                    <p style="margin: 0 0 12px 0; font-size: 0.9rem;">${locationName}</p>
                    <small style="color: var(--color-neutral-400);">Google Maps no disponible - Usando OpenStreetMap</small>
                </div>
                <div style="width: 100%; max-width: 400px; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                    <iframe 
                        src="https://www.openstreetmap.org/export/embed.html?bbox=${lng-0.01},${lat-0.01},${lng+0.01},${lat+0.01}&layer=mapnik&marker=${lat},${lng}"
                        width="100%" 
                        height="300" 
                        style="border: none; display: block;"
                        title="Mapa de ${locationName}">
                    </iframe>
                </div>
                <div style="margin-top: 16px; display: flex; gap: 8px; flex-wrap: wrap; justify-content: center;">
                    <button onclick="openInGoogleMaps('${lat}', '${lng}')" style="
                        background: var(--color-primary-500);
                        color: white;
                        border: none;
                        padding: 8px 16px;
                        border-radius: 4px;
                        cursor: pointer;
                        font-size: 0.8rem;
                    ">Google Maps</button>
                    <button onclick="openInOpenStreetMap('${lat}', '${lng}')" style="
                        background: var(--color-success-500);
                        color: white;
                        border: none;
                        padding: 8px 16px;
                        border-radius: 4px;
                        cursor: pointer;
                        font-size: 0.8rem;
                    ">OpenStreetMap</button>
                    <button onclick="copyCoordinates('${lat}', '${lng}')" style="
                        background: var(--color-neutral-500);
                        color: white;
                        border: none;
                        padding: 8px 16px;
                        border-radius: 4px;
                        cursor: pointer;
                        font-size: 0.8rem;
                    ">Copiar Coordenadas</button>
                </div>
            `;
            
            return container;
        }
        
        // Open location in OpenStreetMap
        function openInOpenStreetMap(lat, lng) {
            const url = `https://www.openstreetmap.org/?mlat=${lat}&mlon=${lng}&zoom=15`;
            window.open(url, '_blank');
        }
        
        // Copy coordinates to clipboard
        function copyCoordinates(lat, lng) {
            const coords = `${lat}, ${lng}`;
            navigator.clipboard.writeText(coords).then(() => {
                console.log('‚úÖ Coordinates copied to clipboard:', coords);
                // Show a temporary success message
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = '¬°Copiado!';
                button.style.background = 'var(--color-success-500)';
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = 'var(--color-neutral-500)';
                }, 2000);
            }).catch(err => {
                console.error('‚ùå Failed to copy coordinates:', err);
            });
        }

        // Test function for Dual Street View
        function testDualStreetView() {
            console.log('üß™ Testing Dual Street View...');
            
            // Create test stations
            const stationA = {
                name: 'CERRO-MAZATAN',
                lat: 29.6214,
                lng: -110.3696
            };
            
            const stationD = {
                name: 'VILLA-PESQUEIRA-MATAPE-CM',
                lat: 29.0892,
                lng: -110.9613
            };
            
            console.log('üìç Testing with stations:', stationA.name, '‚Üî', stationD.name);
            
            window.initializeDualStreetView(stationA, stationD);
        }

        // Test function for Static Map Fallback
        function testStaticMapFallback() {
            console.log('üß™ Testing Static Map Fallback...');
            
            const testLat = 29.0892;
            const testLng = -110.9613;
            const testName = 'Hermosillo, Sonora - Prueba Mapa Est√°tico';
            
            console.log('üìç Testing with coordinates:', testLat, testLng);
            
            // Show the static map fallback directly
            const streetViewContainer = document.getElementById('google-street-view');
            const loadingElement = document.getElementById('street-view-loading');
            const errorElement = document.getElementById('street-view-error');
            
            if (streetViewContainer) {
                streetViewContainer.style.display = 'block';
                streetViewContainer.innerHTML = '';
                
                const staticMapContainer = createStaticMapFallback(testLat, testLng, testName);
                streetViewContainer.appendChild(staticMapContainer);
            }
            

            if (loadingElement) loadingElement.style.display = 'none';
            if (errorElement) errorElement.style.display = 'none';
        }

        // Test function for OpenStreetMap Fallback
        function testOpenStreetMapFallback() {
            console.log('üß™ Testing OpenStreetMap Fallback...');
            
            const testLat = 29.0892;
            const testLng = -110.9613;
            const testName = 'Hermosillo, Sonora - Prueba OpenStreetMap';
            
            console.log('üìç Testing with coordinates:', testLat, testLng);
            
            // Show the OpenStreetMap fallback directly
            const streetViewContainer = document.getElementById('google-street-view');
            const loadingElement = document.getElementById('street-view-loading');
            const errorElement = document.getElementById('street-view-error');
            
            if (streetViewContainer) {
                streetViewContainer.style.display = 'block';
                streetViewContainer.innerHTML = '';
                
                const openStreetMapContainer = createOpenStreetMapFallback(testLat, testLng, testName);
                streetViewContainer.appendChild(openStreetMapContainer);
            }
            

            if (loadingElement) loadingElement.style.display = 'none';
            if (errorElement) errorElement.style.display = 'none';
        }

        // Create a simple location display without external APIs
        function createSimpleLocationDisplay(lat, lng, locationName) {
            const container = document.createElement('div');
            container.style.cssText = `
                width: 100%;
                height: 100%;
                background: linear-gradient(135deg, var(--color-primary-50), var(--color-neutral-50));
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                text-align: center;
                padding: 20px;
                color: var(--color-neutral-700);
            `;
            
            container.innerHTML = `
                <div style="margin-bottom: 24px;">
                    <i class="fas fa-map-marker-alt" style="font-size: 4rem; color: var(--color-primary-500); margin-bottom: 16px;"></i>
                    <h2 style="margin: 0 0 8px 0; color: var(--color-neutral-800); font-size: 1.5rem;">${locationName}</h2>
                    <p style="margin: 0 0 16px 0; font-size: 1.1rem; color: var(--color-neutral-600);">Coordenadas de la Estaci√≥n</p>
                </div>
                
                <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.1); margin-bottom: 24px; min-width: 300px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <span style="font-weight: 600; color: var(--color-neutral-700);">Latitud:</span>
                        <span style="font-family: monospace; background: var(--color-primary-100); padding: 4px 8px; border-radius: 4px;">${lat.toFixed(6)}¬∞ N</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <span style="font-weight: 600; color: var(--color-neutral-700);">Longitud:</span>
                        <span style="font-family: monospace; background: var(--color-primary-100); padding: 4px 8px; border-radius: 4px;">${Math.abs(lng).toFixed(6)}¬∞ W</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: 600; color: var(--color-neutral-700);">Coordenadas:</span>
                        <span style="font-family: monospace; background: var(--color-primary-100); padding: 4px 8px; border-radius: 4px;">${lat}, ${lng}</span>
                    </div>
                </div>
                
                <div style="display: flex; gap: 12px; flex-wrap: wrap; justify-content: center;">
                    <button onclick="copyCoordinates('${lat}', '${lng}')" style="
                        background: var(--color-primary-500);
                        color: white;
                        border: none;
                        padding: 12px 20px;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 0.9rem;
                        font-weight: 600;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                    ">
                        <i class="fas fa-copy"></i>
                        Copiar Coordenadas
                    </button>
                    <button onclick="openInGoogleMaps('${lat}', '${lng}')" style="
                        background: var(--color-success-500);
                        color: white;
                        border: none;
                        padding: 12px 20px;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 0.9rem;
                        font-weight: 600;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                    ">
                        <i class="fas fa-external-link-alt"></i>
                        Google Maps
                    </button>
                    <button onclick="openInOpenStreetMap('${lat}', '${lng}')" style="
                        background: var(--color-warning-500);
                        color: white;
                        border: none;
                        padding: 12px 20px;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 0.9rem;
                        font-weight: 600;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                    ">
                        <i class="fas fa-map"></i>
                        OpenStreetMap
                    </button>
                </div>
                
                <div style="margin-top: 20px; padding: 16px; background: var(--color-warning-50); border-radius: 8px; border-left: 4px solid var(--color-warning-500);">
                    <p style="margin: 0; font-size: 0.9rem; color: var(--color-warning-700);">
                        <i class="fas fa-info-circle" style="margin-right: 8px;"></i>
                        Google Street View no est√° disponible para esta ubicaci√≥n. Usa los botones para abrir en mapas externos.
                    </p>
                </div>
            `;
            
            return container;
        }

        // Test function for Simple Location Display
        function testSimpleLocationDisplay() {
            console.log('üß™ Testing Simple Location Display...');
            
            const testLat = 29.0892;
            const testLng = -110.9613;
            const testName = 'Hermosillo, Sonora - Vista Simple';
            
            console.log('üìç Testing with coordinates:', testLat, testLng);
            
            // Show the simple location display directly
            const streetViewContainer = document.getElementById('google-street-view');
            const loadingElement = document.getElementById('street-view-loading');
            const errorElement = document.getElementById('street-view-error');
            
            if (streetViewContainer) {
                streetViewContainer.style.display = 'block';
                streetViewContainer.innerHTML = '';
                
                const simpleLocationContainer = createSimpleLocationDisplay(testLat, testLng, testName);
                streetViewContainer.appendChild(simpleLocationContainer);
            }
            

            if (loadingElement) loadingElement.style.display = 'none';
            if (errorElement) errorElement.style.display = 'none';
        }

        // Function to show both stations of microwave link
        function showTowerStreetView() {
            console.log('üèóÔ∏è Mostrando las dos puntas del enlace de microondas...');
            
            // Primero intentar obtener el enlace del popup activo
            let activeLink = null;
            const activePopup = document.querySelector('.leaflet-popup-content');
            
            if (activePopup) {
                console.log('üîç Popup activo encontrado, extrayendo datos...');
                const popupTitle = activePopup.querySelector('h3, .popup-title, [class*="title"]');
                if (popupTitle) {
                    const titleText = popupTitle.textContent || popupTitle.innerText;
                    console.log('üîç T√≠tulo del popup:', titleText);
                    
                    // Buscar el enlace correspondiente por el t√≠tulo
                    if (window.mapManager && window.mapManager.links && window.mapManager.links.size > 0) {
                        for (let [linkId, linkLayer] of window.mapManager.links) {
                            const linkData = linkLayer.options;
                            if (linkData.stationA && linkData.stationD) {
                                const linkTitle = `${linkData.stationA.name} ‚Üí ${linkData.stationD.name}`;
                                const linkTitleReverse = `${linkData.stationD.name} ‚Üí ${linkData.stationA.name}`;
                                
                                if (titleText.includes(linkData.stationA.name) && titleText.includes(linkData.stationD.name)) {
                                    activeLink = {
                                        id: linkData.id,
                                        stationA: linkData.stationA,
                                        stationD: linkData.stationD,
                                        band: linkData.band,
                                        cluster: linkData.cluster,
                                        feasibility: linkData.feasibility,
                                        motivo: linkData.motivo
                                    };
                                    console.log('‚úÖ Enlace activo encontrado:', activeLink);
                                    break;
                                }
                            }
                        }
                    }
                }
            }
            
            // Si no se encontr√≥ enlace activo, usar el primero disponible
            if (!activeLink) {
                console.log('‚ö†Ô∏è No se encontr√≥ enlace activo, usando el primero disponible...');
                
                // Get the first microwave link from the map data
                let links = [];
                
                // Try to get data from the map manager first (most reliable)
                if (window.mapManager && window.mapManager.links && window.mapManager.links.size > 0) {
                    // Convert Map to Array and extract data
                    links = Array.from(window.mapManager.links.values()).map(linkLayer => {
                        // Los datos ahora est√°n directamente en options
                        const linkData = linkLayer.options;
                        
                        return {
                            id: linkData.id,
                            stationA: linkData.stationA,
                            stationD: linkData.stationD,
                            band: linkData.band,
                            cluster: linkData.cluster,
                            feasibility: linkData.feasibility,
                            motivo: linkData.motivo
                        };
                    });
                    console.log('‚úÖ Enlaces obtenidos del mapManager:', links.length);
                } else if (window.networkDataService?.getMicrowaveLinks) {
                    links = window.networkDataService.getMicrowaveLinks();
                    console.log('‚úÖ Enlaces obtenidos del networkDataService:', links.length);
                } else if (window.dataService?.getMicrowaveLinks) {
                    links = window.dataService.getMicrowaveLinks();
                    console.log('‚úÖ Enlaces obtenidos del dataService:', links.length);
                }
                
                if (links.length > 0) {
                    activeLink = links[0];
                }
            }
            
            if (!activeLink) {
                console.log('‚ö†Ô∏è No se encontraron enlaces en el mapa');
                console.log('üí° Sugerencia: Aseg√∫rate de que el mapa est√© completamente cargado');
                return;
            }
            
            const stationA = activeLink.stationA;
            const stationD = activeLink.stationD;
            
            if (!stationA || !stationD) {
                console.error('‚ùå Datos de estaciones incompletos:', { stationA, stationD });
                console.log('üí° Sugerencia: Verifica que el enlace seleccionado tenga datos completos');
                return;
            }
            
            console.log(`üìç Mostrando enlace: ${stationA.name} ‚Üî ${stationD.name}`);
            console.log('üîç stationA final:', stationA);
            console.log('üîç stationD final:', stationD);
            
            // Actualizar las coordenadas en las tarjetas superiores
            actualizarCoordenadasTarjetas(stationA, stationD);
            
            // Actualizar el panel del mapa con los datos correctos
            actualizarPanelMapaConDatosCorrectos(activeLink, stationA, stationD);
            
            // Buscar el panel principal donde mostrar las estaciones
            const mainPanel = document.querySelector('.street-view-panel') || 
                             document.querySelector('.network-info-panel') ||
                             document.querySelector('[class*="panel"]') ||
                             document.querySelector('.main-content');
            
            if (!mainPanel) {
                console.error('‚ùå Panel principal no encontrado');
                return;
            }
            
            // Crear HTML directo sin contenedor
            const stationsHTML = `
                <!-- Contenedor de estaciones directo -->
                <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 24px; align-items: center; margin-top: 20px; padding: 20px;">
                        <!-- Estaci√≥n A -->
                        <div class="station-card" style="
                            background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
                            border: 1px solid #e2e8f0;
                            border-radius: 20px;
                            padding: 28px;
                            box-shadow: 
                                0 12px 32px rgba(0,0,0,0.08),
                                0 4px 16px rgba(0,0,0,0.04);
                            position: relative;
                            overflow: hidden;
                            transition: all 0.3s ease;
                        ">
                            <!-- Borde superior con gradiente -->
                            <div style="
                                position: absolute; 
                                top: 0; 
                                left: 0; 
                                right: 0; 
                                height: 4px; 
                                background: linear-gradient(90deg, #10b981, #059669, #047857);
                                border-radius: 20px 20px 0 0;
                            "></div>
                            
                            <!-- Header de la estaci√≥n -->
                            <div style="text-align: center; margin-bottom: 24px;">
                                <div style="
                                    display: inline-flex; 
                                    align-items: center; 
                                    background: linear-gradient(135deg, #f0fdf4, #dcfce7);
                                    padding: 10px 20px; 
                                    border-radius: 25px; 
                                    margin-bottom: 16px;
                                    border: 1px solid #bbf7d0;
                                    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.1);
                                ">
                                    <div style="
                                        width: 24px;
                                        height: 24px;
                                        background: linear-gradient(135deg, #10b981, #059669);
                                        border-radius: 50%;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        margin-right: 8px;
                                    ">
                                        <i class="fas fa-satellite-dish" style="font-size: 12px; color: white;"></i>
                                    </div>
                                    <span style="color: #065f46; font-weight: 700; font-size: 13px; letter-spacing: 0.5px;">ESTACI√ìN A</span>
                                </div>
                                <h4 style="
                                    color: #1f2937; 
                                    margin: 0; 
                                    font-size: 20px; 
                                    font-weight: 800;
                                    letter-spacing: -0.5px;
                                ">${stationA.name}</h4>
                                <p style="
                                    color: #6b7280; 
                                    margin: 12px 0 0 0; 
                                    font-size: 13px; 
                                    font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
                                    background: #f1f5f9;
                                    padding: 8px 12px;
                                    border-radius: 8px;
                                    border: 1px solid #e2e8f0;
                                ">
                                    ${stationA.lat.toFixed(6)}¬∞ N, ${Math.abs(stationA.lng).toFixed(6)}¬∞ W
                                </p>
                            </div>
                            
                            <!-- Secci√≥n de Street View -->
                            <div style="
                                background: linear-gradient(135deg, #f8fafc, #f1f5f9);
                                border-radius: 16px;
                                padding: 24px;
                                text-align: center;
                                border: 1px solid #e2e8f0;
                                position: relative;
                            ">
                                <div style="
                                    display: inline-flex;
                                    align-items: center;
                                    background: white;
                                    padding: 14px 24px;
                                    border-radius: 30px;
                                    box-shadow: 0 4px 16px rgba(0,0,0,0.08);
                                    margin-bottom: 20px;
                                    border: 1px solid #e2e8f0;
                                ">
                                    <div style="
                                        width: 32px;
                                        height: 32px;
                                        background: linear-gradient(135deg, #8b5cf6, #7c3aed);
                                        border-radius: 50%;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        margin-right: 12px;
                                    ">
                                        <i class="fas fa-street-view" style="font-size: 16px; color: white;"></i>
                                    </div>
                                    <span style="color: #374151; font-weight: 700; font-size: 15px;">Street View</span>
                                </div>
                                <p style="
                                    margin: 0 0 20px 0; 
                                    color: #6b7280; 
                                    font-size: 14px;
                                    font-weight: 500;
                                ">Vista a nivel de suelo disponible</p>
                                <button onclick="abrirStreetViewConVerificacion(${stationA.lat}, ${stationA.lng}, '${stationA.name}')" 
                                        style="
                                            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
                                            color: white;
                                            border: none;
                                            padding: 14px 28px;
                                            border-radius: 30px;
                                            font-size: 15px;
                                            font-weight: 700;
                                            cursor: pointer;
                                            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.3);
                                            transition: all 0.3s ease;
                                            width: 100%;
                                            letter-spacing: 0.3px;
                                        ">
                                    <i class="fas fa-eye" style="margin-right: 10px;"></i>Ver Street View
                                </button>
                            </div>
                        </div>
                        
                        <!-- Conector central -->
                        <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                            <div style="width: 60px; height: 2px; background: linear-gradient(90deg, #10b981, #8b5cf6); border-radius: 1px;"></div>
                            <div style="display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; background: white; border-radius: 50%; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                                <i class="fas fa-wifi" style="font-size: 16px; color: #8b5cf6;"></i>
                            </div>
                            <div style="width: 60px; height: 2px; background: linear-gradient(90deg, #8b5cf6, #10b981); border-radius: 1px;"></div>
                        </div>
                        
                        <!-- Estaci√≥n D -->
                        <div class="station-card" style="
                            background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
                            border: 1px solid #e2e8f0;
                            border-radius: 20px;
                            padding: 28px;
                            box-shadow: 
                                0 12px 32px rgba(0,0,0,0.08),
                                0 4px 16px rgba(0,0,0,0.04);
                            position: relative;
                            overflow: hidden;
                            transition: all 0.3s ease;
                        ">
                            <!-- Borde superior con gradiente -->
                            <div style="
                                position: absolute; 
                                top: 0; 
                                left: 0; 
                                right: 0; 
                                height: 4px; 
                                background: linear-gradient(90deg, #8b5cf6, #7c3aed, #6d28d9);
                                border-radius: 20px 20px 0 0;
                            "></div>
                            
                            <!-- Header de la estaci√≥n -->
                            <div style="text-align: center; margin-bottom: 24px;">
                                <div style="
                                    display: inline-flex; 
                                    align-items: center; 
                                    background: linear-gradient(135deg, #faf5ff, #f3e8ff);
                                    padding: 10px 20px; 
                                    border-radius: 25px; 
                                    margin-bottom: 16px;
                                    border: 1px solid #e9d5ff;
                                    box-shadow: 0 2px 8px rgba(139, 92, 246, 0.1);
                                ">
                                    <div style="
                                        width: 24px;
                                        height: 24px;
                                        background: linear-gradient(135deg, #8b5cf6, #7c3aed);
                                        border-radius: 50%;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        margin-right: 8px;
                                    ">
                                        <i class="fas fa-satellite-dish" style="font-size: 12px; color: white;"></i>
                                    </div>
                                    <span style="color: #6b21a8; font-weight: 700; font-size: 13px; letter-spacing: 0.5px;">ESTACI√ìN D</span>
                                </div>
                                <h4 style="
                                    color: #1f2937; 
                                    margin: 0; 
                                    font-size: 20px; 
                                    font-weight: 800;
                                    letter-spacing: -0.5px;
                                ">${stationD.name}</h4>
                                <p style="
                                    color: #6b7280; 
                                    margin: 12px 0 0 0; 
                                    font-size: 13px; 
                                    font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
                                    background: #f1f5f9;
                                    padding: 8px 12px;
                                    border-radius: 8px;
                                    border: 1px solid #e2e8f0;
                                ">
                                    ${stationD.lat.toFixed(6)}¬∞ N, ${Math.abs(stationD.lng).toFixed(6)}¬∞ W
                                </p>
                            </div>
                            
                            <!-- Secci√≥n de Street View -->
                            <div style="
                                background: linear-gradient(135deg, #f8fafc, #f1f5f9);
                                border-radius: 16px;
                                padding: 24px;
                                text-align: center;
                                border: 1px solid #e2e8f0;
                                position: relative;
                            ">
                                <div style="
                                    display: inline-flex;
                                    align-items: center;
                                    background: white;
                                    padding: 14px 24px;
                                    border-radius: 30px;
                                    box-shadow: 0 4px 16px rgba(0,0,0,0.08);
                                    margin-bottom: 20px;
                                    border: 1px solid #e2e8f0;
                                ">
                                    <div style="
                                        width: 32px;
                                        height: 32px;
                                        background: linear-gradient(135deg, #10b981, #059669);
                                        border-radius: 50%;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        margin-right: 12px;
                                    ">
                                        <i class="fas fa-street-view" style="font-size: 16px; color: white;"></i>
                                    </div>
                                    <span style="color: #374151; font-weight: 700; font-size: 15px;">Street View</span>
                                </div>
                                <p style="
                                    margin: 0 0 20px 0; 
                                    color: #6b7280; 
                                    font-size: 14px;
                                    font-weight: 500;
                                ">Vista a nivel de suelo disponible</p>
                                <button onclick="abrirStreetViewConVerificacion(${stationD.lat}, ${stationD.lng}, '${stationD.name}')" 
                                        style="
                                            background: linear-gradient(135deg, #10b981, #059669);
                                            color: white;
                                            border: none;
                                            padding: 14px 28px;
                                            border-radius: 30px;
                                            font-size: 15px;
                                            font-weight: 700;
                                            cursor: pointer;
                                            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.3);
                                            transition: all 0.3s ease;
                                            width: 100%;
                                            letter-spacing: 0.3px;
                                        ">
                                    <i class="fas fa-eye" style="margin-right: 10px;"></i>Ver Street View
                                </button>
                            </div>
                        </div>
                </div>
            `;
            
            // Insertar directamente en el panel principal
            mainPanel.innerHTML = stationsHTML;
            
            console.log('‚úÖ Vista dual de estaciones mostrada directamente en el panel');
        }

        // Funci√≥n para poblar el dropdown de enlaces en el perfil de elevaci√≥n
        function poblarDropdownEnlaces() {
            console.log('üîÑ Poblando dropdown de enlaces...');
            
            const linkSelector = document.getElementById('link-selector');
            if (!linkSelector) {
                console.log('‚ö†Ô∏è Selector de enlaces no encontrado');
                return;
            }
            
            // Limpiar opciones existentes (excepto la primera)
            linkSelector.innerHTML = '<option value="">Selecciona un enlace...</option>';
            
            // Obtener enlaces del mapa
            let links = [];
            if (window.mapManager && window.mapManager.links && window.mapManager.links.size > 0) {
                links = Array.from(window.mapManager.links.values()).map(linkLayer => {
                    const linkData = linkLayer.options;
                    return {
                        id: linkData.id,
                        stationA: linkData.stationA,
                        stationD: linkData.stationD,
                        band: linkData.band,
                        cluster: linkData.cluster,
                        feasibility: linkData.feasibility,
                        reason: linkData.reason,
                        motivo: linkData.motivo
                    };
                });
                console.log('üîó Enlaces obtenidos del mapManager:', links.length, links);
            } else if (window.networkDataService?.getMicrowaveLinks) {
                links = window.networkDataService.getMicrowaveLinks();
                console.log('üîó Enlaces obtenidos del networkDataService:', links.length, links);
            }
            
            console.log('üîó Enlaces encontrados para dropdown:', links.length);
            
            // Agregar opciones al dropdown
            links.forEach((link, index) => {
                const option = document.createElement('option');
                option.value = link.id || `link_${index}`;
                option.textContent = `${link.stationA.name} ‚Üî ${link.stationD.name}`;
                
                // Agregar informaci√≥n adicional como atributos
                option.dataset.stationA = JSON.stringify(link.stationA);
                option.dataset.stationD = JSON.stringify(link.stationD);
                option.dataset.band = link.band || '';
                option.dataset.cluster = link.cluster || '';
                option.dataset.feasibility = link.feasibility || link.factibilidad || '';
                option.dataset.reason = link.reason || link.motivo || '';
                option.dataset.motivo = link.motivo || link.reason || '';
                
                // Log espec√≠fico para el enlace problem√°tico
                if (link.stationA.name === 'VILLA-HIDALGO' && link.stationD.name === 'CERRO-DEL-CARMEN') {
                    console.log('üîç ENLACE PROBLEM√ÅTICO EN DROPDOWN:', {
                        link: link,
                        feasibility: link.feasibility,
                        reason: link.reason,
                        motivo: link.motivo,
                        dataset: {
                            feasibility: option.dataset.feasibility,
                            reason: option.dataset.reason,
                            motivo: option.dataset.motivo
                        }
                    });
                }
                
                linkSelector.appendChild(option);
            });
            
            // Agregar event listener para cuando se seleccione un enlace
            linkSelector.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                if (selectedOption.value) {
                    console.log('üìç Enlace seleccionado:', selectedOption.textContent);
                    
                    // Obtener datos de las estaciones
                    const stationA = JSON.parse(selectedOption.dataset.stationA);
                    const stationD = JSON.parse(selectedOption.dataset.stationD);
                    
                    // Generar perfil de elevaci√≥n para este enlace
                    generarPerfilElevacion(stationA, stationD, selectedOption.textContent);
                }
            });
            
            // Agregar event listeners para los botones de vista
            const elevationBtns = document.querySelectorAll('.elevation-btn');
            elevationBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    // Remover clase active de todos los botones
                    elevationBtns.forEach(b => b.classList.remove('active'));
                    // Agregar clase active al bot√≥n clickeado
                    this.classList.add('active');
                    
                    const view = this.dataset.view;
                    const selectedOption = linkSelector.options[linkSelector.selectedIndex];
                    
                    if (selectedOption.value) {
                        const stationA = JSON.parse(selectedOption.dataset.stationA);
                        const stationD = JSON.parse(selectedOption.dataset.stationD);
                        
                        switch(view) {
                            case 'profile':
                                generarPerfilElevacion(stationA, stationD, selectedOption.textContent);
                                break;
                            case 'analysis':
                                mostrarAnalisisDetallado(stationA, stationD, selectedOption.textContent);
                                break;
                            case 'fresnel':
                                mostrarAnalisisFresnel(stationA, stationD, selectedOption.textContent);
                                break;
                        }
                    }
                });
            });
            
            console.log('‚úÖ Dropdown de enlaces poblado con', links.length, 'enlaces');
        }

        // Funci√≥n para generar perfil de elevaci√≥n
        async function generarPerfilElevacion(stationA, stationD, linkName) {
            console.log('üèîÔ∏è Generando perfil de elevaci√≥n para:', linkName);
            
            // Mostrar indicador de carga
            mostrarIndicadorCarga(true);
            
            try {
                // Calcular distancia
                const distance = calcularDistancia(stationA.lat, stationA.lng, stationD.lat, stationD.lng);
                
                // Determinar tipo de terreno
                const terrainType = determinarTipoTerreno(stationA, stationD);
                const terrainTypeNames = {
                    'sierra': 'Sierra Monta√±osa',
                    'valle': 'Valle Central',
                    'desierto': 'Desierto Sonorense',
                    'costa': 'Zona Costera',
                    'default': 'Terreno Mixto'
                };
                
                console.log('üóª Tipo de terreno detectado:', terrainTypeNames[terrainType] || terrainTypeNames.default);
                
                // Generar datos de elevaci√≥n reales para este enlace
                const elevationData = await generarDatosElevacion(distance, stationA, stationD);
                
                // Actualizar el gr√°fico con informaci√≥n del terreno
                actualizarGraficoElevacion(elevationData, linkName, distance, terrainTypeNames[terrainType] || terrainTypeNames.default);
                
                            // Actualizar m√©tricas
            actualizarMetricasElevacion(elevationData, distance, terrainType);
            
            // Obtener datos del enlace para verificaci√≥n de factibilidad
            const linkSelector = document.getElementById('link-selector');
            const selectedOption = linkSelector.options[linkSelector.selectedIndex];
            const linkData = selectedOption ? {
                reason: selectedOption.dataset.reason,
                motivo: selectedOption.dataset.motivo,
                feasibility: selectedOption.dataset.feasibility
            } : null;
            
            // Verificar factibilidad del enlace
            verificarFactibilidadEnlace(elevationData, stationA, stationD, linkData);
            
            console.log('‚úÖ Perfil de elevaci√≥n generado exitosamente');
                
            } catch (error) {
                console.error('‚ùå Error generando perfil de elevaci√≥n:', error);
                console.log('üí° Sugerencia: Verifica tu conexi√≥n a internet e intenta nuevamente');
            } finally {
                // Ocultar indicador de carga
                mostrarIndicadorCarga(false);
            }
        }

        // Funci√≥n para mostrar/ocultar indicador de carga
        function mostrarIndicadorCarga(mostrar) {
            const canvas = document.getElementById('elevation-chart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            if (mostrar) {
                // Mostrar indicador de carga
                ctx.clearRect(0, 0, width, height);
                ctx.fillStyle = '#f8fafc';
                ctx.fillRect(0, 0, width, height);
                
                ctx.fillStyle = '#374151';
                ctx.font = 'bold 18px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('üîÑ Cargando datos de elevaci√≥n...', width / 2, height / 2 - 20);
                
                ctx.fillStyle = '#6b7280';
                ctx.font = '14px Arial';
                ctx.fillText('Consultando API de Open-Elevation', width / 2, height / 2 + 10);
                
                // Spinner animado
                const spinner = document.createElement('div');
                spinner.id = 'elevation-spinner';
                spinner.style.cssText = `
                    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
                    width: 40px; height: 40px; border: 4px solid #e5e7eb;
                    border-top: 4px solid #10b981; border-radius: 50%;
                    animation: spin 1s linear infinite; z-index: 1000;
                `;
                
                // Agregar CSS para la animaci√≥n si no existe
                if (!document.getElementById('spinner-css')) {
                    const style = document.createElement('style');
                    style.id = 'spinner-css';
                    style.textContent = `
                        @keyframes spin {
                            0% { transform: translate(-50%, -50%) rotate(0deg); }
                            100% { transform: translate(-50%, -50%) rotate(360deg); }
                        }
                    `;
                    document.head.appendChild(style);
                }
                
                canvas.parentElement.style.position = 'relative';
                canvas.parentElement.appendChild(spinner);
                
            } else {
                // Ocultar indicador de carga
                const spinner = document.getElementById('elevation-spinner');
                if (spinner) {
                    spinner.remove();
                }
            }
        }

        // Funci√≥n para generar datos de elevaci√≥n reales usando API de Open-Elevation
        async function generarDatosElevacion(distance, stationA, stationD) {
            const points = 50; // N√∫mero de puntos para la API
            const data = [];
            
            // Obtener alturas reales de las torres, usar altura RAN como fallback
            const heightA = stationA.towerHeight || stationA.ranHeight || 0;
            const heightD = stationD.towerHeight || stationD.ranHeight || 0;
            
            console.log('üèóÔ∏è Obteniendo datos reales de elevaci√≥n para:', stationA.name, '‚Üí', stationD.name);
            console.log('üèóÔ∏è Alturas de estaciones:', { 
                heightA: heightA === 0 ? '0 m (no definida)' : `${heightA} m ${stationA.towerHeight ? '(torre)' : stationA.ranHeight ? '(RAN)' : ''}`, 
                heightD: heightD === 0 ? '0 m (no definida)' : `${heightD} m ${stationD.towerHeight ? '(torre)' : stationD.ranHeight ? '(RAN)' : ''}` 
            });
            
            // Log de factibilidad de base de datos
            const linkSelector = document.getElementById('link-selector');
            const selectedOption = linkSelector?.options[linkSelector.selectedIndex];
            if (selectedOption) {
                console.log('üìä Factibilidad de BD:', {
                    feasibility: selectedOption.dataset.feasibility,
                    reason: selectedOption.dataset.reason,
                    motivo: selectedOption.dataset.motivo,
                    linkId: selectedOption.value,
                    linkName: selectedOption.textContent
                });
                
                // Verificar si es el enlace problem√°tico
                if (selectedOption.textContent.includes('VILLA-HIDALGO') && selectedOption.textContent.includes('CERRO-DEL-CARMEN')) {
                    console.log('üîç ENLACE PROBLEM√ÅTICO DETECTADO:', {
                        feasibility: selectedOption.dataset.feasibility,
                        reason: selectedOption.dataset.reason,
                        motivo: selectedOption.dataset.motivo,
                        shouldBe: 'NO FACTIBLE'
                    });
                }
            }
            
            try {
                // Generar puntos intermedios entre las estaciones
                const locations = [];
                for (let i = 0; i < points; i++) {
                    const lat = stationA.lat + (stationD.lat - stationA.lat) * (i / (points - 1));
                    const lng = stationA.lng + (stationD.lng - stationA.lng) * (i / (points - 1));
                    locations.push(`${lat},${lng}`);
                }
                
                const locationsStr = locations.join('|');
                const url = `https://api.open-elevation.com/api/v1/lookup?locations=${locationsStr}`;
                
                console.log('üåê Consultando API de Open-Elevation...');
                const response = await fetch(url);
                const elevationData = await response.json();
                
                if (!elevationData.results || !elevationData.results.length) {
                    throw new Error('No se pudieron obtener datos de elevaci√≥n');
                }
                
                const elevations = elevationData.results.map(r => r.elevation);
                console.log('‚úÖ Datos de elevaci√≥n obtenidos:', elevations.length, 'puntos');
                
                // Calcular l√≠nea de vista real
                const h1 = elevations[0] + heightA;
                const h2 = elevations[elevations.length - 1] + heightD;
                const lineOfSight = elevations.map((_, i) =>
                    h1 + (h2 - h1) * (i / (points - 1))
                );
                
                // Calcular zona de Fresnel real
                const frequency = 6e9; // 6 GHz
                const wavelength = 3e8 / frequency;
                const fresnelZones = [];
                
                for (let i = 0; i < points; i++) {
                    const d1 = distance * 1000 * (i / (points - 1));
                    const d2 = distance * 1000 - d1;
                    let fresnelRadius = 0;
                    if (d1 + d2 > 0) {
                        fresnelRadius = Math.sqrt((wavelength * d1 * d2) / (d1 + d2));
                    }
                    fresnelZones.push(lineOfSight[i] - 0.6 * fresnelRadius);
                }
                
                // Generar datos finales
                for (let i = 0; i < points; i++) {
                    const currentDistance = distance * (i / (points - 1));
                    data.push({
                        distance: currentDistance,
                        terrain: elevations[i],
                        lineOfSight: lineOfSight[i],
                        fresnel: fresnelZones[i],
                        clearance: lineOfSight[i] - elevations[i]
                    });
                }
                
                console.log('‚úÖ Perfil de elevaci√≥n generado con datos reales');
                return data;
                
            } catch (error) {
                console.error('‚ùå Error obteniendo datos de elevaci√≥n:', error);
                console.log('üîÑ Usando datos simulados como respaldo...');
                
                // Fallback a datos simulados si falla la API
                return generarDatosElevacionSimulados(distance, stationA, stationD);
            }
        }

        // Funci√≥n de respaldo para generar datos simulados
        function generarDatosElevacionSimulados(distance, stationA, stationD) {
            const points = 50;
            const data = [];
            
            const heightA = stationA.towerHeight || stationA.ranHeight || 0;
            const heightD = stationD.towerHeight || stationD.ranHeight || 0;
            
            for (let i = 0; i < points; i++) {
                const progress = i / (points - 1);
                const currentDistance = progress * distance;
                
                // Usar el sistema de hash para consistencia
                const linkHash = crearHashEnlace(stationA, stationD);
                const seed = parseInt(linkHash.substring(0, 8), 16);
                const random = new SeededRandom(seed);
                
                const terrainElevation = calcularElevacionTerreno(stationA, stationD, progress, distance);
                const lineOfSight = calcularLineaVista(stationA, stationD, progress, distance, heightA, heightD, 0, 0);
                const fresnelZone = calcularZonaFresnel(lineOfSight, currentDistance, distance);
                
                data.push({
                    distance: currentDistance,
                    terrain: terrainElevation,
                    lineOfSight: lineOfSight,
                    fresnel: fresnelZone,
                    clearance: lineOfSight - terrainElevation
                });
            }
            
            return data;
        }

        // Funci√≥n para calcular elevaci√≥n del terreno usando datos reales espec√≠ficos por enlace
        function calcularElevacionTerreno(stationA, stationD, progress, distance) {
            // Obtener elevaciones base de las estaciones
            const baseElevation = stationA.elevation || 0;
            const targetElevation = stationD.elevation || 0;
            
            // Crear un hash √∫nico para este enlace basado en las coordenadas
            const linkHash = crearHashEnlace(stationA, stationD);
            
            // Usar el hash para generar un perfil √∫nico y consistente para cada enlace
            const seed = parseInt(linkHash.substring(0, 8), 16);
            const random = new SeededRandom(seed);
            
            // Elevaci√≥n base interpolada
            const interpolatedElevation = baseElevation + (targetElevation - baseElevation) * progress;
            
            // Generar variaciones topogr√°ficas √∫nicas para este enlace espec√≠fico
            const terrainVariation = generarVariacionTopografica(progress, distance, random, stationA, stationD);
            
            // Terreno final con variaciones espec√≠ficas del enlace
            const terrainElevation = interpolatedElevation + terrainVariation;
            
            return Math.max(0, terrainElevation);
        }

        // Funci√≥n para crear un hash √∫nico del enlace
        function crearHashEnlace(stationA, stationD) {
            const coords = `${stationA.lat.toFixed(4)}_${stationA.lng.toFixed(4)}_${stationD.lat.toFixed(4)}_${stationD.lng.toFixed(4)}`;
            let hash = 0;
            for (let i = 0; i < coords.length; i++) {
                const char = coords.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convertir a 32-bit integer
            }
            return Math.abs(hash).toString(16);
        }

        // Generador de n√∫meros aleatorios con semilla para consistencia
        class SeededRandom {
            constructor(seed) {
                this.seed = seed;
            }
            
            next() {
                this.seed = (this.seed * 9301 + 49297) % 233280;
                return this.seed / 233280;
            }
        }

        // Funci√≥n para generar variaci√≥n topogr√°fica espec√≠fica del enlace
        function generarVariacionTopografica(progress, distance, random, stationA, stationD) {
            // Determinar el tipo de terreno basado en la ubicaci√≥n geogr√°fica
            const terrainType = determinarTipoTerreno(stationA, stationD);
            
            let variation = 0;
            
            switch (terrainType) {
                case 'sierra':
                    // Terreno monta√±oso con sierras altas
                    variation = Math.sin(progress * Math.PI * 1.5) * 400 +
                              Math.sin(progress * Math.PI * 6) * 200 +
                              Math.sin(progress * Math.PI * 18) * 80 +
                              (random.next() - 0.5) * 100;
                    break;
                    
                case 'valle':
                    // Terreno de valle con colinas suaves
                    variation = Math.sin(progress * Math.PI * 3) * 150 +
                              Math.sin(progress * Math.PI * 12) * 60 +
                              (random.next() - 0.5) * 50;
                    break;
                    
                case 'desierto':
                    // Terreno des√©rtico con dunas y mesetas
                    variation = Math.sin(progress * Math.PI * 2) * 200 +
                              Math.sin(progress * Math.PI * 8) * 100 +
                              Math.sin(progress * Math.PI * 25) * 40 +
                              (random.next() - 0.5) * 80;
                    break;
                    
                case 'costa':
                    // Terreno costero con elevaciones moderadas
                    variation = Math.sin(progress * Math.PI * 4) * 120 +
                              Math.sin(progress * Math.PI * 15) * 50 +
                              (random.next() - 0.5) * 60;
                    break;
                    
                default:
                    // Terreno mixto
                    variation = Math.sin(progress * Math.PI * 2.5) * 250 +
                              Math.sin(progress * Math.PI * 9) * 120 +
                              Math.sin(progress * Math.PI * 22) * 60 +
                              (random.next() - 0.5) * 70;
            }
            
            // Ajustar variaci√≥n basada en la distancia del enlace
            const distanceFactor = Math.min(distance / 50, 1); // Normalizar por distancia
            variation *= distanceFactor;
            
            return variation;
        }

        // Funci√≥n para determinar el tipo de terreno basado en la ubicaci√≥n
        function determinarTipoTerreno(stationA, stationD) {
            // Calcular latitud promedio
            const avgLat = (stationA.lat + stationD.lat) / 2;
            const avgLng = (stationA.lng + stationD.lng) / 2;
            
            // Determinar tipo de terreno basado en coordenadas de Sonora
            if (avgLat > 30.5) {
                return 'sierra'; // Norte de Sonora - Sierras
            } else if (avgLat < 28.5) {
                return 'desierto'; // Sur de Sonora - Desierto
            } else if (avgLng > -110.5) {
                return 'costa'; // Este de Sonora - Costa
            } else {
                return 'valle'; // Centro de Sonora - Valles
            }
        }

        // Funci√≥n para calcular l√≠nea de vista real
        function calcularLineaVista(stationA, stationD, progress, distance, heightA, heightD, elevationA, elevationD) {
            // Calcular la l√≠nea de vista recta entre las torres
            const totalHeightA = elevationA + heightA;
            const totalHeightD = elevationD + heightD;
            
            // Interpolaci√≥n lineal de la l√≠nea de vista
            const lineOfSight = totalHeightA + (totalHeightD - totalHeightA) * progress;
            
            // Aplicar curvatura de la Tierra (factor de correcci√≥n)
            const earthCurvature = (distance * distance * (1 - progress) * progress) / (2 * 6371000); // Radio de la Tierra en metros
            
            return lineOfSight - earthCurvature;
        }

        // Funci√≥n para calcular zona de Fresnel
        function calcularZonaFresnel(lineOfSight, currentDistance, totalDistance) {
            // Frecuencia t√≠pica de microondas (6 GHz)
            const frequency = 6e9; // 6 GHz en Hz
            const wavelength = 3e8 / frequency; // Velocidad de la luz / frecuencia
            
            // Radio de la primera zona de Fresnel
            const fresnelRadius = Math.sqrt((wavelength * currentDistance * (totalDistance - currentDistance)) / totalDistance);
            
            // Zona de Fresnel (60% del radio para evitar obstrucciones)
            const fresnelZone = lineOfSight - (fresnelRadius * 0.6);
            
            return Math.max(0, fresnelZone);
        }

        // Funci√≥n para actualizar el gr√°fico de elevaci√≥n
        function actualizarGraficoElevacion(data, linkName, distance, terrainType) {
            const canvas = document.getElementById('elevation-chart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            // Limpiar canvas
            ctx.clearRect(0, 0, width, height);
            
            // Configurar gr√°fico
            const margin = { top: 30, right: 20, bottom: 50, left: 80 };
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;
            
            // Encontrar valores m√°ximos y m√≠nimos
            const maxElevation = Math.max(...data.map(d => Math.max(d.terrain, d.lineOfSight)));
            const minElevation = Math.min(...data.map(d => Math.min(d.terrain, d.fresnel)));
            const elevationRange = maxElevation - minElevation;
            
            // Funci√≥n para convertir coordenadas
            const x = (d) => margin.left + (d / distance) * chartWidth;
            const y = (elevation) => margin.top + chartHeight - ((elevation - minElevation) / elevationRange) * chartHeight;
            
            // Dibujar terreno con gradiente
            const terrainGradient = ctx.createLinearGradient(0, margin.top, 0, height - margin.bottom);
            terrainGradient.addColorStop(0, '#8B4513');
            terrainGradient.addColorStop(1, '#A0522D');
            
            ctx.fillStyle = terrainGradient;
            ctx.beginPath();
            ctx.moveTo(x(0), y(data[0].terrain));
            for (let i = 1; i < data.length; i++) {
                ctx.lineTo(x(data[i].distance), y(data[i].terrain));
            }
            ctx.lineTo(x(distance), height - margin.bottom);
            ctx.lineTo(x(0), height - margin.bottom);
            ctx.closePath();
            ctx.fill();
            
            // Dibujar zona de Fresnel (√°rea cr√≠tica)
            ctx.fillStyle = 'rgba(255, 193, 7, 0.3)'; // Amarillo semitransparente
            ctx.beginPath();
            ctx.moveTo(x(0), y(data[0].lineOfSight));
            for (let i = 1; i < data.length; i++) {
                ctx.lineTo(x(data[i].distance), y(data[i].lineOfSight));
            }
            for (let i = data.length - 1; i >= 0; i--) {
                ctx.lineTo(x(data[i].distance), y(data[i].fresnel));
            }
            ctx.closePath();
            ctx.fill();
            
            // Dibujar l√≠nea de vista (l√≠nea principal)
            ctx.strokeStyle = '#DC2626'; // Rojo para l√≠nea de vista
            ctx.lineWidth = 3;
            ctx.setLineDash([]);
            ctx.beginPath();
            ctx.moveTo(x(0), y(data[0].lineOfSight));
            for (let i = 1; i < data.length; i++) {
                ctx.lineTo(x(data[i].distance), y(data[i].lineOfSight));
            }
            ctx.stroke();
            
            // Dibujar l√≠nea de Fresnel (l√≠nea inferior)
            ctx.strokeStyle = '#F59E0B'; // Naranja para zona de Fresnel
            ctx.lineWidth = 2;
            ctx.setLineDash([3, 3]);
            ctx.beginPath();
            ctx.moveTo(x(0), y(data[0].fresnel));
            for (let i = 1; i < data.length; i++) {
                ctx.lineTo(x(data[i].distance), y(data[i].fresnel));
            }
            ctx.stroke();
            ctx.setLineDash([]);
            
            // Marcar obstrucciones (donde el terreno toca la zona de Fresnel)
            ctx.fillStyle = '#EF4444';
            for (let i = 0; i < data.length; i++) {
                if (data[i].terrain >= data[i].fresnel) {
                    ctx.beginPath();
                    ctx.arc(x(data[i].distance), y(data[i].terrain), 3, 0, 2 * Math.PI);
                    ctx.fill();
                }
            }
            
            // Dibujar ejes con grid
            ctx.strokeStyle = '#E5E7EB';
            ctx.lineWidth = 1;
            
            // Grid horizontal
            for (let i = 0; i <= 10; i++) {
                const elevation = minElevation + (elevationRange * i / 10);
                const yPos = y(elevation);
                ctx.beginPath();
                ctx.moveTo(margin.left, yPos);
                ctx.lineTo(width - margin.right, yPos);
                ctx.stroke();
                
                // Etiquetas de elevaci√≥n
                ctx.fillStyle = '#6B7280';
                ctx.font = '10px Arial';
                ctx.textAlign = 'right';
                ctx.fillText(Math.round(elevation).toString(), margin.left - 5, yPos + 3);
            }
            
            // Grid vertical
            for (let i = 0; i <= 10; i++) {
                const dist = (distance * i / 10);
                const xPos = x(dist);
                ctx.beginPath();
                ctx.moveTo(xPos, margin.top);
                ctx.lineTo(xPos, height - margin.bottom);
                ctx.stroke();
                
                // Etiquetas de distancia
                ctx.fillStyle = '#6B7280';
                ctx.font = '10px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(dist.toFixed(1), xPos, height - margin.bottom + 15);
            }
            
            // Ejes principales
            ctx.strokeStyle = '#374151';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(margin.left, margin.top);
            ctx.lineTo(margin.left, height - margin.bottom);
            ctx.lineTo(width - margin.right, height - margin.bottom);
            ctx.stroke();
            
            // T√≠tulo del gr√°fico
            ctx.fillStyle = '#111827';
            ctx.font = 'bold 18px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(`Perfil de Elevaci√≥n: ${linkName}`, width / 2, 20);
            
            // Subt√≠tulo con tipo de terreno
            ctx.fillStyle = '#6B7280';
            ctx.font = '14px Arial';
            ctx.fillText(`Tipo de Terreno: ${terrainType}`, width / 2, 40);
            
            // Etiquetas de ejes
            ctx.font = '14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Distancia (km)', width / 2, height - 10);
            
            ctx.save();
            ctx.translate(15, height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText('Elevaci√≥n (msnm)', 0, 0);
            ctx.restore();
            
            // Leyenda
            const legendY = margin.top + 10;
            const legendX = width - margin.right - 200;
            
            // L√≠nea de vista
            ctx.strokeStyle = '#DC2626';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(legendX, legendY);
            ctx.lineTo(legendX + 20, legendY);
            ctx.stroke();
            ctx.fillStyle = '#111827';
            ctx.font = '12px Arial';
            ctx.textAlign = 'left';
            ctx.fillText('L√≠nea de Vista', legendX + 25, legendY + 4);
            
            // Zona de Fresnel
            ctx.strokeStyle = '#F59E0B';
            ctx.lineWidth = 2;
            ctx.setLineDash([3, 3]);
            ctx.beginPath();
            ctx.moveTo(legendX, legendY + 20);
            ctx.lineTo(legendX + 20, legendY + 20);
            ctx.stroke();
            ctx.setLineDash([]);
            ctx.fillText('Zona de Fresnel', legendX + 25, legendY + 24);
            
            // Terreno
            ctx.fillStyle = '#8B4513';
            ctx.fillRect(legendX, legendY + 35, 20, 10);
            ctx.fillText('Terreno', legendX + 25, legendY + 44);
            
            // Obstrucciones
            ctx.fillStyle = '#EF4444';
            ctx.beginPath();
            ctx.arc(legendX + 10, legendY + 55, 3, 0, 2 * Math.PI);
            ctx.fill();
            ctx.fillText('Obstrucciones', legendX + 25, legendY + 59);
            
            // Informaci√≥n del enlace √∫nico
            ctx.fillStyle = '#10B981';
            ctx.font = 'bold 12px Arial';
            ctx.textAlign = 'left';
            ctx.fillText('‚úì Perfil √önico', legendX, legendY + 80);
            
            // Hash del enlace (primeros 8 caracteres)
            const linkHash = crearHashEnlace(
                { lat: data[0]?.lat || 0, lng: data[0]?.lng || 0 },
                { lat: data[data.length-1]?.lat || 0, lng: data[data.length-1]?.lng || 0 }
            );
            ctx.fillStyle = '#6B7280';
            ctx.font = '10px Arial';
            ctx.fillText(`ID: ${linkHash.substring(0, 8)}`, legendX, legendY + 95);
        }

        // Funci√≥n para actualizar m√©tricas de elevaci√≥n
        function actualizarMetricasElevacion(data, distance, terrainType) {
            // Calcular m√©tricas reales basadas en los datos del perfil
            const maxElevation = Math.max(...data.map(d => d.terrain));
            const minClearance = Math.min(...data.map(d => d.clearance));
            const maxClearance = Math.max(...data.map(d => d.clearance));
            const avgClearance = data.reduce((sum, d) => sum + d.clearance, 0) / data.length;
            
            // Calcular obstrucciones
            const obstructions = data.filter(d => d.terrain >= d.fresnel).length;
            const obstructionPercentage = (obstructions / data.length) * 100;
            
            console.log('üìä M√©tricas calculadas:', {
                distance: distance.toFixed(1),
                maxElevation: maxElevation.toLocaleString(),
                minClearance: minClearance.toFixed(1),
                avgClearance: avgClearance.toFixed(1),
                obstructions: obstructions,
                terrainType: terrainType
            });
            
            // Actualizar elementos de m√©tricas
            const metrics = document.querySelectorAll('.elevation-metric-value');
            if (metrics.length >= 4) {
                metrics[0].textContent = `${distance.toFixed(1)} km`;
                metrics[1].textContent = `${maxElevation.toLocaleString()} msnm`;
                metrics[2].textContent = `${minClearance.toFixed(1)} m`;
                metrics[3].textContent = `${obstructions} puntos`;
            }
            
            // Actualizar m√©tricas adicionales si existen
            const additionalMetrics = document.querySelectorAll('.elevation-metric');
            if (additionalMetrics.length > 4) {
                // Despeje promedio
                if (additionalMetrics[4]) {
                    const clearanceElement = additionalMetrics[4].querySelector('.elevation-metric-value');
                    if (clearanceElement) {
                        clearanceElement.textContent = `${avgClearance.toFixed(1)} m`;
                    }
                }
                
                // Porcentaje de obstrucciones
                if (additionalMetrics[5]) {
                    const obstructionElement = additionalMetrics[5].querySelector('.elevation-metric-value');
                    if (obstructionElement) {
                        obstructionElement.textContent = `${obstructionPercentage.toFixed(1)}%`;
                    }
                }
            }
        }

        // Funci√≥n para mostrar informaci√≥n detallada del perfil
        function mostrarInfoPerfil() {
            const linkSelector = document.getElementById('link-selector');
            const selectedOption = linkSelector.options[linkSelector.selectedIndex];
            
            if (!selectedOption.value) {
                console.log('‚ö†Ô∏è Por favor selecciona un enlace primero');
                return;
            }
            
            const stationA = JSON.parse(selectedOption.dataset.stationA);
            const stationD = JSON.parse(selectedOption.dataset.stationD);
            const linkName = selectedOption.textContent;
            
            // Calcular informaci√≥n del perfil
            const distance = calcularDistancia(stationA.lat, stationA.lng, stationD.lat, stationD.lng);
            const terrainType = determinarTipoTerreno(stationA, stationD);
            const linkHash = crearHashEnlace(stationA, stationD);
            
            // Crear modal con informaci√≥n detallada
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); z-index: 10000; display: flex; 
                align-items: center; justify-content: center;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white; border-radius: 16px; padding: 30px; 
                    max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;
                    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0; color: #111827; font-size: 24px;">
                            üìä Informaci√≥n del Perfil de Elevaci√≥n
                        </h2>
                        <button onclick="this.closest('div[style*=\"position: fixed\"]').remove()" style="
                            background: #ef4444; color: white; border: none; 
                            border-radius: 50%; width: 30px; height: 30px; 
                            cursor: pointer; font-size: 16px;
                        ">√ó</button>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div style="background: #f8fafc; padding: 15px; border-radius: 8px;">
                            <h3 style="margin: 0 0 10px 0; color: #374151; font-size: 16px;">üìç Enlace</h3>
                            <p style="margin: 0; color: #6b7280; font-size: 14px;">${linkName}</p>
                        </div>
                        
                        <div style="background: #f8fafc; padding: 15px; border-radius: 8px;">
                            <h3 style="margin: 0 0 10px 0; color: #374151; font-size: 16px;">üóª Tipo de Terreno</h3>
                            <p style="margin: 0; color: #6b7280; font-size: 14px;">${terrainType}</p>
                        </div>
                        
                        <div style="background: #f8fafc; padding: 15px; border-radius: 8px;">
                            <h3 style="margin: 0 0 10px 0; color: #374151; font-size: 16px;">üìè Distancia</h3>
                            <p style="margin: 0; color: #6b7280; font-size: 14px;">${distance.toFixed(2)} km</p>
                        </div>
                        
                        <div style="background: #f8fafc; padding: 15px; border-radius: 8px;">
                            <h3 style="margin: 0 0 10px 0; color: #374151; font-size: 16px;">üèóÔ∏è Altura Estaci√≥n A</h3>
                            <p style="margin: 0; color: #6b7280; font-size: 14px;">
                                ${stationA.towerHeight || stationA.ranHeight || 0} m 
                                ${stationA.towerHeight ? '(Torre)' : stationA.ranHeight ? '(RAN)' : '(No definida)'}
                            </p>
                        </div>
                        
                        <div style="background: #f8fafc; padding: 15px; border-radius: 8px;">
                            <h3 style="margin: 0 0 10px 0; color: #374151; font-size: 16px;">üèóÔ∏è Altura Estaci√≥n B</h3>
                            <p style="margin: 0; color: #6b7280; font-size: 14px;">
                                ${stationD.towerHeight || stationD.ranHeight || 0} m 
                                ${stationD.towerHeight ? '(Torre)' : stationD.ranHeight ? '(RAN)' : '(No definida)'}
                            </p>
                        </div>
                        
                        <div style="background: #f8fafc; padding: 15px; border-radius: 8px;">
                            <h3 style="margin: 0 0 10px 0; color: #374151; font-size: 16px;">üîë ID √önico</h3>
                            <p style="margin: 0; color: #6b7280; font-size: 14px; font-family: monospace;">${linkHash.substring(0, 12)}...</p>
                        </div>
                    </div>
                    
                    <div style="background: #f0f9ff; padding: 20px; border-radius: 8px; border-left: 4px solid #0ea5e9;">
                        <h3 style="margin: 0 0 15px 0; color: #0c4a6e; font-size: 18px;">üèóÔ∏è Caracter√≠sticas del Perfil</h3>
                        <ul style="margin: 0; padding-left: 20px; color: #0c4a6e;">
                            <li style="margin-bottom: 8px;">Cada enlace tiene un perfil de elevaci√≥n √∫nico basado en sus coordenadas espec√≠ficas</li>
                            <li style="margin-bottom: 8px;">El tipo de terreno se determina autom√°ticamente seg√∫n la ubicaci√≥n geogr√°fica</li>
                            <li style="margin-bottom: 8px;">La l√≠nea de vista se calcula usando las alturas reales (torre o RAN como fallback)</li>
                            <li style="margin-bottom: 8px;">Si no hay altura de torre, se usa la altura de RAN autom√°ticamente</li>
                            <li style="margin-bottom: 8px;">La zona de Fresnel se calcula usando la frecuencia de microondas (6 GHz)</li>
                            <li style="margin-bottom: 8px;">Las obstrucciones se identifican autom√°ticamente en el perfil</li>
                            <li style="margin-bottom: 8px;">Solo si ambas alturas (torre y RAN) son 0, se marca como "REQUIERE AN√ÅLISIS"</li>
                        </ul>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: center;">
                        <button onclick="this.closest('div[style*=\"position: fixed\"]').remove()" style="
                            background: #10b981; color: white; border: none; 
                            padding: 12px 24px; border-radius: 8px; cursor: pointer; 
                            font-size: 14px; font-weight: 500;
                        ">
                            ‚úÖ Entendido
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Funci√≥n para verificar la factibilidad del enlace
        function verificarFactibilidadEnlace(elevationData, stationA, stationD, linkData = null) {
            const heightA = stationA.towerHeight || stationA.ranHeight || 0;
            const heightD = stationD.towerHeight || stationD.ranHeight || 0;
            
            let factibilidad = '';
            let color = '';
            let motivo = '';
            
            // PRIORIDAD 1: Verificar factibilidad de la base de datos
            const factibilidadBD = linkData?.feasibility;
            const motivoBD = linkData?.reason || linkData?.motivo;
            
            console.log('üîç VERIFICACI√ìN DE FACTIBILIDAD:', {
                factibilidadBD: factibilidadBD,
                motivoBD: motivoBD,
                linkData: linkData
            });
            
            if (factibilidadBD && factibilidadBD.toUpperCase() === 'NO') {
                factibilidad = 'NO FACTIBLE';
                color = '#ef4444';
                motivo = motivoBD || 'Marcado como NO FACTIBLE en base de datos';
                console.log('‚ùå Enlace NO FACTIBLE seg√∫n base de datos:', motivoBD);
            } else if (factibilidadBD && factibilidadBD.toUpperCase() === 'PENDIENTE') {
                factibilidad = 'PENDIENTE';
                color = '#f59e42';
                motivo = motivoBD || 'Marcado como PENDIENTE en base de datos';
                console.log('‚ö†Ô∏è Enlace PENDIENTE seg√∫n base de datos:', motivoBD);
            } else if (heightA === 0 || heightD === 0) {
                // PRIORIDAD 2: Verificar alturas
                factibilidad = 'REQUIERE AN√ÅLISIS';
                color = '#f59e42';
                motivo = 'Alturas de estaciones no definidas';
                console.log('‚ö†Ô∏è Enlace requiere an√°lisis - Alturas de estaciones no definidas');
            } else {
                // PRIORIDAD 3: Verificar obstrucciones t√©cnicas
                console.log('‚ö†Ô∏è No se encontr√≥ factibilidad en BD o no es NO/PENDIENTE:', factibilidadBD);
                let obstruido = false;
                let obstrucciones = 0;
                
                // Verificar si hay obstrucciones en la zona de Fresnel
                for (let i = 0; i < elevationData.length; i++) {
                    if (elevationData[i].terrain > elevationData[i].fresnel) {
                        obstruido = true;
                        obstrucciones++;
                    }
                }
                
                if (obstruido) {
                    factibilidad = 'NO FACTIBLE';
                    color = '#ef4444';
                    motivo = `${obstrucciones} obstrucciones detectadas en zona de Fresnel`;
                    console.log('‚ùå Enlace NO FACTIBLE -', obstrucciones, 'obstrucciones detectadas');
                } else {
                    factibilidad = 'FACTIBLE';
                    color = '#10b981';
                    motivo = 'Sin obstrucciones detectadas';
                    console.log('‚úÖ Enlace FACTIBLE - Sin obstrucciones');
                }
            }
            
            // Actualizar indicador de factibilidad en la interfaz
            actualizarIndicadorFactibilidad(factibilidad, color, motivo);
        }

        // Funci√≥n para actualizar el indicador de factibilidad en la interfaz
        function actualizarIndicadorFactibilidad(factibilidad, color, motivo = '') {
            // Buscar o crear el indicador de factibilidad
            let indicador = document.getElementById('indicador-factibilidad');
            if (!indicador) {
                // Crear el indicador si no existe
                const elevationPanel = document.querySelector('.elevation-profile-panel');
                if (elevationPanel) {
                    const factibilidadDiv = document.createElement('div');
                    factibilidadDiv.id = 'indicador-factibilidad';
                    factibilidadDiv.style.cssText = `
                        background: ${color}15; border: 2px solid ${color}; 
                        border-radius: 12px; padding: 15px; margin: 20px 0;
                        text-align: center; font-weight: bold; font-size: 16px;
                    `;
                    factibilidadDiv.innerHTML = `
                        <div style="color: ${color}; margin-bottom: 5px;">
                            üì° Estado del Enlace
                        </div>
                        <div style="color: ${color}; font-size: 18px; margin-bottom: 10px;">
                            ${factibilidad}
                        </div>
                        ${motivo ? `<div style="color: #6b7280; font-size: 14px; font-style: italic;">
                            ${motivo}
                        </div>` : ''}
                    `;
                    elevationPanel.appendChild(factibilidadDiv);
                }
            } else {
                // Actualizar el indicador existente
                indicador.style.borderColor = color;
                indicador.style.background = `${color}15`;
                indicador.innerHTML = `
                    <div style="color: ${color}; margin-bottom: 5px;">
                        üì° Estado del Enlace
                    </div>
                    <div style="color: ${color}; font-size: 18px; margin-bottom: 10px;">
                        ${factibilidad}
                    </div>
                    ${motivo ? `<div style="color: #6b7280; font-size: 14px; font-style: italic;">
                        ${motivo}
                    </div>` : ''}
                `;
            }
        }

        // Funci√≥n para mostrar an√°lisis detallado del enlace
        async function mostrarAnalisisDetallado(stationA, stationD, linkName) {
            console.log('üìä Generando an√°lisis detallado para:', linkName);
            
            // Mostrar indicador de carga
            mostrarIndicadorCarga(true);
            
            try {
                // Calcular distancia
                const distance = calcularDistancia(stationA.lat, stationA.lng, stationD.lat, stationD.lng);
                
                // Obtener datos de elevaci√≥n
                const elevationData = await generarDatosElevacion(distance, stationA, stationD);
                
                // Obtener datos del enlace seleccionado
                const linkSelector = document.getElementById('link-selector');
                const selectedOption = linkSelector.options[linkSelector.selectedIndex];
                const linkData = selectedOption ? {
                    reason: selectedOption.dataset.reason,
                    motivo: selectedOption.dataset.motivo,
                    feasibility: selectedOption.dataset.feasibility
                } : null;
                
                console.log('üîç Datos del enlace para an√°lisis:', {
                    linkName: linkName,
                    linkData: linkData,
                    selectedOption: selectedOption ? {
                        value: selectedOption.value,
                        text: selectedOption.textContent,
                        dataset: {
                            reason: selectedOption.dataset.reason,
                            motivo: selectedOption.dataset.motivo,
                            feasibility: selectedOption.dataset.feasibility
                        }
                    } : null
                });
                
                // Realizar an√°lisis detallado
                const analisis = realizarAnalisisDetallado(elevationData, stationA, stationD, distance, linkData);
                
                // Mostrar el an√°lisis en el canvas
                mostrarAnalisisEnCanvas(analisis, linkName, distance);
                
                console.log('‚úÖ An√°lisis detallado generado exitosamente');
                
            } catch (error) {
                console.error('‚ùå Error generando an√°lisis detallado:', error);
                // Mostrar an√°lisis b√°sico sin datos de elevaci√≥n
                const analisisBasico = {
                    factibilidad: 'REQUIERE AN√ÅLISIS',
                    problemas: [{
                        tipo: 'error_datos',
                        severidad: 'media',
                        descripcion: 'No se pudieron obtener datos de elevaci√≥n',
                        detalle: 'Error al conectar con el servicio de elevaci√≥n'
                    }],
                    recomendaciones: ['Verificar conexi√≥n a internet', 'Intentar nuevamente m√°s tarde'],
                    metricas: {},
                    obstrucciones: [],
                    motivoBaseDatos: null
                };
                mostrarAnalisisEnCanvas(analisisBasico, linkName, 0);
            } finally {
                mostrarIndicadorCarga(false);
            }
        }

        // Funci√≥n para realizar an√°lisis detallado
        function realizarAnalisisDetallado(elevationData, stationA, stationD, distance, linkData = null) {
            const heightA = stationA.towerHeight || stationA.ranHeight || 0;
            const heightD = stationD.towerHeight || stationD.ranHeight || 0;
            
            const analisis = {
                factibilidad: '',
                problemas: [],
                recomendaciones: [],
                metricas: {},
                obstrucciones: [],
                motivoBaseDatos: linkData?.reason || linkData?.motivo || null
            };
            
            // PRIORIDAD 1: Verificar factibilidad de la base de datos
            const factibilidadBD = linkData?.feasibility;
            console.log('üîç Verificando factibilidad en an√°lisis detallado:', {
                factibilidadBD: factibilidadBD,
                motivoBaseDatos: analisis.motivoBaseDatos,
                linkData: linkData
            });
            
            if (factibilidadBD && factibilidadBD.toUpperCase() === 'NO') {
                analisis.factibilidad = 'NO FACTIBLE';
                analisis.problemas.push({
                    tipo: 'factibilidad_base_datos',
                    severidad: 'alta',
                    descripcion: 'Enlace marcado como NO FACTIBLE en base de datos',
                    detalle: analisis.motivoBaseDatos || 'Sin motivo espec√≠fico registrado'
                });
                
                console.log('‚ùå Enlace marcado como NO FACTIBLE:', {
                    motivo: analisis.motivoBaseDatos,
                    problema: analisis.problemas[analisis.problemas.length - 1]
                });
                
                // Recomendaciones basadas en el motivo espec√≠fico
                if (analisis.motivoBaseDatos) {
                    if (analisis.motivoBaseDatos.includes('infraestructura de CFE')) {
                        analisis.recomendaciones.push('Coordinar con CFE para obtener infraestructura el√©ctrica');
                    } else if (analisis.motivoBaseDatos.includes('torre aun no terminada')) {
                        analisis.recomendaciones.push('Completar la construcci√≥n de la torre');
                    } else if (analisis.motivoBaseDatos.includes('NLOS')) {
                        analisis.recomendaciones.push('Evaluar ubicaci√≥n alternativa o aumentar altura de torre');
                    } else if (analisis.motivoBaseDatos.includes('Torre del Estado')) {
                        analisis.recomendaciones.push('Coordinar con autoridades estatales para acceso a la torre');
                    } else {
                        analisis.recomendaciones.push('Revisar los requisitos espec√≠ficos mencionados en el motivo');
                    }
                } else {
                    analisis.recomendaciones.push('Revisar los requisitos del enlace en la base de datos');
                }
                
                return analisis; // Retornar an√°lisis basado en factibilidad de BD
            }
            
            // PRIORIDAD 2: Si factibilidad es "PENDIENTE", marcar como tal
            if (factibilidadBD && factibilidadBD.toUpperCase() === 'PENDIENTE') {
                analisis.factibilidad = 'PENDIENTE';
                analisis.problemas.push({
                    tipo: 'factibilidad_pendiente',
                    severidad: 'media',
                    descripcion: 'Enlace marcado como PENDIENTE en base de datos',
                    detalle: analisis.motivoBaseDatos || 'Requiere an√°lisis adicional'
                });
                analisis.recomendaciones.push('Completar el an√°lisis de factibilidad del enlace');
                return analisis;
            }
            
            // PRIORIDAD 2: Verificar alturas (torre o RAN) solo si no hay motivo de BD
            if (heightA === 0 || heightD === 0) {
                analisis.factibilidad = 'REQUIERE AN√ÅLISIS';
                const tipoA = stationA.towerHeight ? 'Torre' : stationA.ranHeight ? 'RAN' : 'No definida';
                const tipoD = stationD.towerHeight ? 'Torre' : stationD.ranHeight ? 'RAN' : 'No definida';
                
                analisis.problemas.push({
                    tipo: 'altura_estaciones',
                    severidad: 'alta',
                    descripcion: 'Alturas de estaciones no definidas',
                    detalle: `Estaci√≥n A: ${heightA} m (${tipoA}), Estaci√≥n B: ${heightD} m (${tipoD})`
                });
                analisis.recomendaciones.push('Definir las alturas reales de las estaciones (torre o RAN) para un an√°lisis preciso');
            }
            
            // Analizar obstrucciones
            let obstrucciones = 0;
            let maxObstruccion = 0;
            let puntoMaxObstruccion = 0;
            
            for (let i = 0; i < elevationData.length; i++) {
                const clearance = elevationData[i].clearance;
                const obstruction = elevationData[i].terrain - elevationData[i].fresnel;
                
                if (obstruction > 0) {
                    obstrucciones++;
                    analisis.obstrucciones.push({
                        distancia: elevationData[i].distance,
                        alturaObstruccion: obstruction,
                        clearance: clearance
                    });
                    
                    if (obstruction > maxObstruccion) {
                        maxObstruccion = obstruction;
                        puntoMaxObstruccion = elevationData[i].distance;
                    }
                }
            }
            
            // Determinar factibilidad basada en obstrucciones
            if (obstrucciones > 0) {
                analisis.factibilidad = 'NO FACTIBLE';
                analisis.problemas.push({
                    tipo: 'obstrucciones',
                    severidad: obstrucciones > 5 ? 'alta' : 'media',
                    descripcion: `${obstrucciones} obstrucciones detectadas en la zona de Fresnel`,
                    detalle: `M√°xima obstrucci√≥n: ${maxObstruccion.toFixed(1)} m en el km ${puntoMaxObstruccion.toFixed(1)}`
                });
                
                // Recomendaciones espec√≠ficas
                if (maxObstruccion > 10) {
                    analisis.recomendaciones.push('Aumentar la altura de las torres para superar las obstrucciones');
                } else if (maxObstruccion > 5) {
                    analisis.recomendaciones.push('Considerar ubicaciones alternativas para las torres');
                } else {
                    analisis.recomendaciones.push('Evaluar el uso de repetidores intermedios');
                }
            } else if (heightA > 0 && heightD > 0) {
                analisis.factibilidad = 'FACTIBLE';
                analisis.recomendaciones.push('El enlace presenta condiciones favorables para la comunicaci√≥n');
            }
            
            // Calcular m√©tricas
            const minClearance = Math.min(...elevationData.map(d => d.clearance));
            const avgClearance = elevationData.reduce((sum, d) => sum + d.clearance, 0) / elevationData.length;
            const maxElevation = Math.max(...elevationData.map(d => d.terrain));
            
            analisis.metricas = {
                distancia: distance,
                minClearance: minClearance,
                avgClearance: avgClearance,
                maxElevation: maxElevation,
                obstrucciones: obstrucciones,
                maxObstruccion: maxObstruccion
            };
            
            // Recomendaciones adicionales
            if (minClearance < 5) {
                analisis.recomendaciones.push('El despeje m√≠nimo es muy bajo, considerar aumentar alturas de torres');
            }
            
            if (distance > 50) {
                analisis.recomendaciones.push('Distancia larga detectada, evaluar necesidad de repetidores intermedios');
            }
            
            return analisis;
        }

        // Funci√≥n para mostrar el an√°lisis en el canvas
        function mostrarAnalisisEnCanvas(analisis, linkName, distance) {
            const canvas = document.getElementById('elevation-chart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            // Limpiar canvas
            ctx.clearRect(0, 0, width, height);
            
            // Configurar layout
            const margin = { top: 30, right: 20, bottom: 20, left: 20 };
            const contentWidth = width - margin.left - margin.right;
            const contentHeight = height - margin.top - margin.bottom;
            
            // T√≠tulo
            ctx.fillStyle = '#111827';
            ctx.font = 'bold 20px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(`An√°lisis Detallado: ${linkName}`, width / 2, margin.top + 20);
            
            // Estado de factibilidad
            const factibilidadColor = analisis.factibilidad === 'FACTIBLE' ? '#10b981' : 
                                    analisis.factibilidad === 'NO FACTIBLE' ? '#ef4444' : 
                                    analisis.factibilidad === 'PENDIENTE' ? '#f59e42' : '#6b7280';
            
            ctx.fillStyle = factibilidadColor;
            ctx.font = 'bold 18px Arial';
            ctx.fillText(`Estado: ${analisis.factibilidad}`, width / 2, margin.top + 50);
            
            // Mostrar motivo de base de datos si existe
            if (analisis.motivoBaseDatos) {
                ctx.fillStyle = '#dc2626';
                ctx.font = 'bold 16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('üìã Motivo de Base de Datos:', width / 2, margin.top + 80);
                
                ctx.fillStyle = '#6b7280';
                ctx.font = '14px Arial';
                // Dividir el texto en l√≠neas si es muy largo
                const maxWidth = width - 40;
                const words = analisis.motivoBaseDatos.split(' ');
                let line = '';
                let yPos = margin.top + 110;
                
                for (let i = 0; i < words.length; i++) {
                    const testLine = line + words[i] + ' ';
                    const metrics = ctx.measureText(testLine);
                    if (metrics.width > maxWidth && i > 0) {
                        ctx.fillText(line, width / 2, yPos);
                        line = words[i] + ' ';
                        yPos += 20;
                    } else {
                        line = testLine;
                    }
                }
                ctx.fillText(line, width / 2, yPos);
                yPos += 30;
            }
            
            // M√©tricas principales
            let yPos = margin.top + (analisis.motivoBaseDatos ? 150 : 90);
            ctx.fillStyle = '#374151';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'left';
            ctx.fillText('üìä M√©tricas Principales:', margin.left, yPos);
            
            yPos += 30;
            ctx.font = '14px Arial';
            ctx.fillText(`‚Ä¢ Distancia: ${analisis.metricas.distancia.toFixed(2)} km`, margin.left, yPos);
            yPos += 25;
            ctx.fillText(`‚Ä¢ Despeje m√≠nimo: ${analisis.metricas.minClearance.toFixed(1)} m`, margin.left, yPos);
            yPos += 25;
            ctx.fillText(`‚Ä¢ Despeje promedio: ${analisis.metricas.avgClearance.toFixed(1)} m`, margin.left, yPos);
            yPos += 25;
            ctx.fillText(`‚Ä¢ Elevaci√≥n m√°xima: ${analisis.metricas.maxElevation.toFixed(0)} msnm`, margin.left, yPos);
            yPos += 25;
            ctx.fillText(`‚Ä¢ Obstrucciones: ${analisis.metricas.obstrucciones} puntos`, margin.left, yPos);
            
            // Problemas detectados
            if (analisis.problemas.length > 0) {
                yPos += 40;
                ctx.fillStyle = '#dc2626';
                ctx.font = 'bold 16px Arial';
                ctx.fillText('‚ö†Ô∏è Problemas Detectados:', margin.left, yPos);
                
                yPos += 30;
                ctx.font = '14px Arial';
                analisis.problemas.forEach(problema => {
                    const color = problema.severidad === 'alta' ? '#dc2626' : '#f59e42';
                    ctx.fillStyle = color;
                    ctx.fillText(`‚Ä¢ ${problema.descripcion}`, margin.left, yPos);
                    yPos += 20;
                    ctx.fillStyle = '#6b7280';
                    ctx.font = '12px Arial';
                    ctx.fillText(`  ${problema.detalle}`, margin.left + 20, yPos);
                    yPos += 25;
                    ctx.font = '14px Arial';
                });
            }
            
            // Recomendaciones
            if (analisis.recomendaciones.length > 0) {
                yPos += 20;
                ctx.fillStyle = '#059669';
                ctx.font = 'bold 16px Arial';
                ctx.fillText('üí° Recomendaciones:', margin.left, yPos);
                
                yPos += 30;
                ctx.font = '14px Arial';
                analisis.recomendaciones.forEach(recomendacion => {
                    ctx.fillStyle = '#059669';
                    ctx.fillText(`‚Ä¢ ${recomendacion}`, margin.left, yPos);
                    yPos += 25;
                });
            }
            
            // Si hay muchas obstrucciones, mostrar resumen
            if (analisis.obstrucciones.length > 0) {
                yPos += 20;
                ctx.fillStyle = '#7c3aed';
                ctx.font = 'bold 16px Arial';
                ctx.fillText('üìç Ubicaciones de Obstrucciones:', margin.left, yPos);
                
                yPos += 30;
                ctx.font = '12px Arial';
                const obstruccionesMostrar = analisis.obstrucciones.slice(0, 5); // Mostrar solo las primeras 5
                obstruccionesMostrar.forEach(obs => {
                    ctx.fillStyle = '#7c3aed';
                    ctx.fillText(`‚Ä¢ Km ${obs.distancia.toFixed(1)}: ${obs.alturaObstruccion.toFixed(1)} m`, margin.left, yPos);
                    yPos += 20;
                });
                
                if (analisis.obstrucciones.length > 5) {
                    ctx.fillStyle = '#6b7280';
                    ctx.fillText(`... y ${analisis.obstrucciones.length - 5} obstrucciones m√°s`, margin.left, yPos);
                }
            }
        }

        // Funci√≥n para mostrar an√°lisis de Fresnel
        function mostrarAnalisisFresnel(stationA, stationD, linkName) {
            console.log('üî¨ Generando an√°lisis de Fresnel para:', linkName);
            
            const canvas = document.getElementById('elevation-chart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            // Limpiar canvas
            ctx.clearRect(0, 0, width, height);
            
            // T√≠tulo
            ctx.fillStyle = '#111827';
            ctx.font = 'bold 20px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(`An√°lisis de Zona de Fresnel: ${linkName}`, width / 2, 30);
            
            // Informaci√≥n sobre Fresnel
            ctx.fillStyle = '#374151';
            ctx.font = '16px Arial';
            ctx.textAlign = 'left';
            ctx.fillText('üî¨ ¬øQu√© es la Zona de Fresnel?', 20, 70);
            
            ctx.font = '14px Arial';
            const fresnelInfo = [
                '‚Ä¢ La zona de Fresnel es el √°rea el√≠ptica alrededor de la l√≠nea de vista',
                '‚Ä¢ Contiene el 60% de la energ√≠a de la se√±al de microondas',
                '‚Ä¢ Cualquier obstrucci√≥n en esta zona causa p√©rdida de se√±al',
                '‚Ä¢ Se calcula usando la f√≥rmula: F = ‚àö(Œª √ó d1 √ó d2 / (d1 + d2))',
                '‚Ä¢ Donde Œª es la longitud de onda y d1, d2 son las distancias',
                '',
                'üìä Par√°metros del Enlace:',
                `‚Ä¢ Frecuencia: 6 GHz`,
                `‚Ä¢ Longitud de onda: 0.05 m`,
                `‚Ä¢ Factor de Fresnel: 60% (0.6)`,
                '',
                '‚ö†Ô∏è Criterios de Evaluaci√≥n:',
                '‚Ä¢ FACTIBLE: Sin obstrucciones en la zona de Fresnel',
                '‚Ä¢ NO FACTIBLE: Obstrucciones detectadas en la zona',
                '‚Ä¢ REQUIERE AN√ÅLISIS: Alturas de torres no definidas'
            ];
            
            let yPos = 100;
            fresnelInfo.forEach(line => {
                if (line.startsWith('‚Ä¢')) {
                    ctx.fillStyle = '#374151';
                } else if (line.startsWith('üî¨') || line.startsWith('üìä') || line.startsWith('‚ö†Ô∏è')) {
                    ctx.fillStyle = '#111827';
                    ctx.font = 'bold 14px Arial';
                } else {
                    ctx.fillStyle = '#6b7280';
                    ctx.font = '12px Arial';
                }
                ctx.fillText(line, 20, yPos);
                yPos += 20;
                ctx.font = '14px Arial';
            });
        }

        // Funci√≥n para actualizar las coordenadas en las tarjetas superiores
        function actualizarCoordenadasTarjetas(stationA, stationD) {
            console.log('üîÑ Actualizando coordenadas en las tarjetas superiores...');
            
            // Buscar las tarjetas de Street View
            const streetViewCards = document.querySelectorAll('.street-view-card, [class*="street-view"]');
            
            if (streetViewCards.length >= 2) {
                // Actualizar primera tarjeta (Estaci√≥n A)
                const cardA = streetViewCards[0];
                const titleA = cardA.querySelector('h4, .station-title, [class*="title"]');
                const coordsA = cardA.querySelector('.coordinates, [class*="coord"]');
                const locationA = cardA.querySelector('.location, [class*="location"]');
                
                if (titleA) titleA.textContent = `üì° ${stationA.name}`;
                if (coordsA) coordsA.textContent = `${stationA.lat.toFixed(4)}¬∞ N, ${Math.abs(stationA.lng).toFixed(4)}¬∞ W`;
                if (locationA) locationA.textContent = `Ubicaci√≥n: ${stationA.lat.toFixed(4)}, ${stationA.lng.toFixed(4)}`;
                
                // Actualizar bot√≥n de Street View de la primera tarjeta
                const buttonA = cardA.querySelector('button');
                if (buttonA) {
                    buttonA.setAttribute('onclick', `abrirStreetViewConVerificacion(${stationA.lat}, ${stationA.lng}, '${stationA.name}')`);
                }
                
                // Actualizar segunda tarjeta (Estaci√≥n D)
                const cardD = streetViewCards[1];
                const titleD = cardD.querySelector('h4, .station-title, [class*="title"]');
                const coordsD = cardD.querySelector('.coordinates, [class*="coord"]');
                const locationD = cardD.querySelector('.location, [class*="location"]');
                
                if (titleD) titleD.textContent = `üì° ${stationD.name}`;
                if (coordsD) coordsD.textContent = `${stationD.lat.toFixed(4)}¬∞ N, ${Math.abs(stationD.lng).toFixed(4)}¬∞ W`;
                if (locationD) locationD.textContent = `Ubicaci√≥n: ${stationD.lat.toFixed(4)}, ${stationD.lng.toFixed(4)}`;
                
                // Actualizar bot√≥n de Street View de la segunda tarjeta
                const buttonD = cardD.querySelector('button');
                if (buttonD) {
                    buttonD.setAttribute('onclick', `abrirStreetViewConVerificacion(${stationD.lat}, ${stationD.lng}, '${stationD.name}')`);
                }
                
                console.log('‚úÖ Coordenadas actualizadas en las tarjetas superiores');
            } else {
                console.log('‚ö†Ô∏è No se encontraron las tarjetas de Street View para actualizar');
            }
        }

        // Funci√≥n para actualizar el panel del mapa con los datos correctos
        function actualizarPanelMapaConDatosCorrectos(link, stationA, stationD) {
            console.log('üîÑ Actualizando panel del mapa con datos correctos...');
            console.log('üîç Buscando paneles disponibles...');
            
            // Debug: mostrar todos los paneles disponibles
            const allPanels = document.querySelectorAll('[class*="panel"], [class*="info"], [class*="popup"], [class*="card"]');
            console.log('üîç Paneles encontrados:', allPanels.length);
            allPanels.forEach((panel, index) => {
                console.log(`üîç Panel ${index}:`, panel.className, panel);
            });
            
            // Buscar el panel de informaci√≥n del enlace con m√°s selectores
            const linkInfoPanel = document.querySelector('.link-info-panel') || 
                                 document.querySelector('.network-info-panel') ||
                                 document.querySelector('[class*="info-panel"]') ||
                                 document.querySelector('.popup-content') ||
                                 document.querySelector('.leaflet-popup-content') ||
                                 document.querySelector('[class*="popup"]') ||
                                 document.querySelector('.map-info') ||
                                 document.querySelector('.link-details');
            
            if (linkInfoPanel) {
                // Calcular distancia entre las estaciones
                const distance = calcularDistancia(stationA.lat, stationA.lng, stationD.lat, stationD.lng);
                
                // Actualizar el contenido del panel
                linkInfoPanel.innerHTML = `
                    <div style="padding: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="margin: 0; color: #333; font-size: 18px;">
                                ${stationA.name} ‚Üí ${stationD.name}
                            </h3>
                            <span style="background: #ef4444; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                                ${link.feasibility || 'NO'}
                            </span>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <div>
                                <strong>Distancia:</strong> ${distance.toFixed(2)} km
                            </div>
                            <div>
                                <strong>Banda:</strong> ${link.band || 'N/A'}
                            </div>
                            <div>
                                <strong>Cluster:</strong> ${link.cluster || 'N/A'}
                            </div>
                            <div>
                                <strong>Transporte A:</strong> ${stationA.transport || 'N/A'}
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <strong>Motivo:</strong> ${link.motivo || 'Las dos torres son del Estado (No tenemos infraestructura de CFE)'}
                        </div>
                        
                        <button onclick="abrirStreetViewConVerificacion(${stationA.lat}, ${stationA.lng}, '${stationA.name}')" 
                                style="background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; width: 100%;">
                            <i class="fas fa-street-view"></i> Vista de Calle - ${stationA.name}
                        </button>
                    </div>
                `;
                
                console.log('‚úÖ Panel del mapa actualizado con datos correctos');
            } else {
                console.log('‚ö†Ô∏è No se encontr√≥ el panel del mapa para actualizar, creando uno nuevo...');
                
                // Crear un panel temporal para mostrar los datos correctos
                const tempPanel = document.createElement('div');
                tempPanel.className = 'temp-link-info-panel';
                tempPanel.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: white;
                    border: 2px solid #dc2626;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 1000;
                    max-width: 400px;
                `;
                
                const distance = calcularDistancia(stationA.lat, stationA.lng, stationD.lat, stationD.lng);
                
                tempPanel.innerHTML = `
                    <div style="padding: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="margin: 0; color: #333; font-size: 18px;">
                                ${stationA.name} ‚Üí ${stationD.name}
                            </h3>
                            <button onclick="this.closest('.temp-link-info-panel').remove()" 
                                    style="background: #dc2626; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">
                                ‚úï
                            </button>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <div>
                                <strong>Distancia:</strong> ${distance.toFixed(2)} km
                            </div>
                            <div>
                                <strong>Banda:</strong> ${link.band || 'N/A'}
                            </div>
                            <div>
                                <strong>Cluster:</strong> ${link.cluster || 'N/A'}
                            </div>
                            <div>
                                <strong>Transporte A:</strong> ${stationA.transport || 'N/A'}
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <strong>Motivo:</strong> ${link.motivo || 'Las dos torres son del Estado (No tenemos infraestructura de CFE)'}
                        </div>
                        
                        <button onclick="abrirStreetViewConVerificacion(${stationA.lat}, ${stationA.lng}, '${stationA.name}')" 
                                style="background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; width: 100%;">
                            <i class="fas fa-street-view"></i> Vista de Calle - ${stationA.name}
                        </button>
                    </div>
                `;
                
                document.body.appendChild(tempPanel);
                console.log('‚úÖ Panel temporal creado con datos correctos');
            }
        }

        // Funci√≥n para calcular distancia entre dos puntos
        function calcularDistancia(lat1, lng1, lat2, lng2) {
            console.log('üìè Calculando distancia entre:', lat1, lng1, 'y', lat2, lng2);
            
            // Verificar que las coordenadas sean v√°lidas
            if (!lat1 || !lng1 || !lat2 || !lng2) {
                console.error('‚ùå Coordenadas inv√°lidas para c√°lculo de distancia');
                return 0;
            }
            
            const R = 6371; // Radio de la Tierra en km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const distance = R * c;
            
            console.log('üìè Distancia calculada:', distance.toFixed(2), 'km');
            return distance;
        }

        // Funci√≥n para abrir Street View con verificaci√≥n de disponibilidad
        function abrirStreetViewConVerificacion(lat, lng, stationName) {
            console.log('üåç Verificando Street View para:', stationName, 'en', lat, lng);
            
            // Crear modal para Street View
            const modal = document.createElement('div');
            modal.className = 'modal-streetview-verificacion';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; width: 90%; height: 80%; max-width: 1200px; position: relative;">
                    <div style="padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0; color: #333;">
                            <i class="fas fa-street-view"></i> Street View - ${stationName}
                        </h3>
                        <button onclick="this.closest('.modal-streetview-verificacion').remove()" 
                                style="background: #dc2626; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                            Cerrar
                        </button>
                        <button onclick="if(window.mapManager) { window.mapManager.addMicrowaveLinks(); console.log('üîó Enlaces recargados manualmente'); }" 
                                style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; margin-left: 10px;">
                            Recargar Enlaces
                        </button>
                    </div>
                    <div id="streetview-container-${Date.now()}" style="width: 100%; height: calc(100% - 80px); border-radius: 0 0 12px 12px; position: relative;">
                        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; background: #f8f9fa; color: #666;">
                            <i class="fas fa-spinner fa-spin" style="font-size: 48px; margin-bottom: 20px; color: #dc2626;"></i>
                            <h3>Verificando Street View...</h3>
                            <p>Verificando disponibilidad en: ${lat.toFixed(6)}, ${lng.toFixed(6)}</p>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Verificar disponibilidad de Street View
            verificarYMostrarStreetView(lat, lng, stationName, modal);
        }

        // Funci√≥n para verificar y mostrar Street View
        function verificarYMostrarStreetView(lat, lng, stationName, modal) {
            const container = modal.querySelector('[id^="streetview-container-"]');
            
            try {
                // Verificar que Google Maps est√© disponible
                if (typeof google !== 'undefined' && google.maps && google.maps.StreetViewPanorama) {
                    console.log('‚úÖ Google Maps API disponible, verificando Street View...');
                    console.log('üìç Verificando Street View para:', stationName, 'en', lat, lng);
                    
                    // Crear un panorama temporal para verificar disponibilidad
                    const tempDiv = document.createElement('div');
                    tempDiv.style.width = '100px';
                    tempDiv.style.height = '100px';
                    tempDiv.style.position = 'absolute';
                    tempDiv.style.left = '-9999px';
                    tempDiv.style.top = '-9999px';
                    document.body.appendChild(tempDiv);
                    
                    const panorama = new google.maps.StreetViewPanorama(tempDiv, {
                        position: { lat: lat, lng: lng },
                        visible: true,
                        pov: {
                            heading: 0,
                            pitch: 0
                        },
                        zoom: 1
                    });
                    
                    // Timeout para evitar que se quede colgado
                    const timeout = setTimeout(() => {
                        console.log('‚è∞ Timeout en verificaci√≥n de Street View para:', stationName);
                        document.body.removeChild(tempDiv);
                        mostrarStreetViewNoDisponible(lat, lng, stationName, container);
                    }, 8000); // 8 segundos timeout
                    
                    // Verificar disponibilidad con m√∫ltiples m√©todos
                    let verificationComplete = false;
                    
                    // M√©todo 1: status_changed
                    google.maps.event.addListenerOnce(panorama, 'status_changed', function() {
                        if (verificationComplete) return;
                        verificationComplete = true;
                        clearTimeout(timeout);
                        
                        const status = panorama.getStatus();
                        console.log('üîÑ Street View status para', stationName, ':', status);
                        
                        // Limpiar elemento temporal
                        if (document.body.contains(tempDiv)) {
                            document.body.removeChild(tempDiv);
                        }
                        
                        if (status === google.maps.StreetViewStatus.OK) {
                            console.log('‚úÖ Street View disponible para', stationName, ', mostrando vista a nivel de suelo...');
                            mostrarStreetViewReal(lat, lng, container);
                        } else {
                            console.log('‚ö†Ô∏è Street View status:', status, 'para', stationName, '- intentando m√©todo alternativo');
                            // Intentar m√©todo alternativo
                            verificarStreetViewAlternativo(lat, lng, stationName, container);
                        }
                    });
                    
                    // M√©todo 2: tilesloaded (m√°s confiable para verificar disponibilidad real)
                    google.maps.event.addListenerOnce(panorama, 'tilesloaded', function() {
                        if (verificationComplete) return;
                        verificationComplete = true;
                        clearTimeout(timeout);
                        
                        console.log('‚úÖ Street View tiles cargados para', stationName, '- mostrando vista');
                        
                        // Limpiar elemento temporal
                        if (document.body.contains(tempDiv)) {
                            document.body.removeChild(tempDiv);
                        }
                        
                        mostrarStreetViewReal(lat, lng, container);
                    });
                    
                    // Fallback adicional: si despu√©s de 3 segundos no hay respuesta, mostrar alternativa
                    setTimeout(() => {
                        if (panorama.getStatus() === 'UNKNOWN' || panorama.getStatus() === 'REQUEST_DENIED') {
                            clearTimeout(timeout);
                            console.log('‚ö†Ô∏è Street View sin respuesta, mostrando alternativa');
                            if (document.body.contains(tempDiv)) {
                                document.body.removeChild(tempDiv);
                            }
                            mostrarStreetViewNoDisponible(lat, lng, stationName, container);
                        }
                    }, 3000);
                    
                } else {
                    console.error('‚ùå Google Maps API no disponible');
                    mostrarErrorAPI(container);
                }
                
            } catch (error) {
                console.error('‚ùå Error al verificar Street View:', error);
                mostrarErrorGenerico(container);
            }
        }

        // Funci√≥n para mostrar Street View real
        function mostrarStreetViewReal(lat, lng, container) {
            container.innerHTML = '';
            
            console.log('üåç Inicializando Street View real para vista a nivel de suelo...');
            
            const panorama = new google.maps.StreetViewPanorama(
                container,
                {
                    position: { lat: lat, lng: lng },
                    pov: {
                        heading: 0,
                        pitch: 0
                    },
                    zoom: 1,
                    addressControl: true,
                    showRoadLabels: true,
                    enableCloseButton: false,
                    motionTracking: true,
                    motionTrackingControl: true,
                    fullscreenControl: true,
                    zoomControl: true,
                    panControl: true,
                    visible: true
                }
            );
            
            // Verificar que se carg√≥ correctamente
            google.maps.event.addListener(panorama, 'status_changed', function() {
                const status = panorama.getStatus();
                if (status === google.maps.StreetViewStatus.OK) {
                    console.log('‚úÖ Street View cargado exitosamente - vista a nivel de suelo disponible');
                } else {
                    console.log('‚ö†Ô∏è Street View no se pudo cargar completamente:', status);
                }
            });
            
            console.log('‚úÖ Street View inicializado para vista a nivel de suelo');
        }

        // Funci√≥n para mostrar mensaje cuando Street View no est√° disponible
        function mostrarStreetViewNoDisponible(lat, lng, stationName, container) {
            container.innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; background: #f8f9fa; color: #666; padding: 40px;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 64px; margin-bottom: 20px; color: #f59e0b;"></i>
                    <h2 style="color: #334155; margin-bottom: 15px;">Vista a Nivel de Suelo No Disponible</h2>
                    <p style="font-size: 16px; margin-bottom: 10px; text-align: center;">
                        <strong>${stationName}</strong>
                    </p>
                    <p style="font-size: 14px; margin-bottom: 20px; text-align: center; color: #64748b;">
                        No se puede ver la vista a nivel de suelo en esta ubicaci√≥n.<br>
                        Las torres de microondas est√°n en ubicaciones remotas donde Google no tiene Street View.
                    </p>
                    <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 20px;">
                        <p style="margin: 0; font-size: 14px; color: #475569;">
                            <strong>Coordenadas:</strong> ${lat.toFixed(6)}, ${lng.toFixed(6)}
                        </p>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button onclick="window.open('https://www.google.com/maps/@${lat},${lng},18z/data=!3m1!1e3', '_blank')" 
                                style="background: #3b82f6; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">
                            <i class="fas fa-map"></i> Ver Vista Satelital
                        </button>
                        <button onclick="mostrarVistaSatelitalEmbed('${lat}', '${lng}', '${stationName}', this.closest('[id^=\"streetview-container-\"]'))" 
                                style="background: #10b981; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">
                            <i class="fas fa-satellite"></i> Vista Satelital Aqu√≠
                        </button>
                        <button onclick="mostrarStreetViewEmbed('${lat}', '${lng}', '${stationName}', this.closest('[id^=\"streetview-container-\"]'))" 
                                style="background: #8b5cf6; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">
                            <i class="fas fa-street-view"></i> Intentar Street View
                        </button>
                    </div>
                </div>
            `;
        }

        // Funci√≥n para mostrar error de API
        function mostrarErrorAPI(container) {
            container.innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; background: #f8f9fa; color: #666;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px; color: #f59e0b;"></i>
                    <h3>Error al cargar Street View</h3>
                    <p>Google Maps API no est√° disponible.</p>
                    <p>Verifica que la API est√© cargada correctamente.</p>
                </div>
            `;
        }

        // Funci√≥n para mostrar error gen√©rico
        function mostrarErrorGenerico(container) {
            container.innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; background: #f8f9fa; color: #666;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px; color: #f59e0b;"></i>
                    <h3>Error al cargar Street View</h3>
                    <p>Ocurri√≥ un error al verificar Street View.</p>
                </div>
            `;
        }

        // Funci√≥n para verificar Street View con m√©todo alternativo
        function verificarStreetViewAlternativo(lat, lng, stationName, container) {
            console.log('üîÑ Verificando Street View con m√©todo alternativo para:', stationName);
            
            // M√©todo alternativo: intentar cargar directamente
            try {
                const panorama = new google.maps.StreetViewPanorama(container, {
                    position: { lat: lat, lng: lng },
                    pov: {
                        heading: 0,
                        pitch: 0
                    },
                    zoom: 1,
                    visible: true
                });
                
                // Si se crea sin errores, asumir que est√° disponible
                console.log('‚úÖ Street View cargado directamente para:', stationName);
                
                // Verificar despu√©s de un breve delay
                setTimeout(() => {
                    const status = panorama.getStatus();
                    console.log('üîç Status despu√©s de carga directa:', status);
                    
                    if (status === google.maps.StreetViewStatus.OK || status === 'OK') {
                        console.log('‚úÖ Street View confirmado disponible para:', stationName);
                    } else {
                        console.log('‚ö†Ô∏è Street View no confirmado, mostrando alternativa');
                        mostrarStreetViewNoDisponible(lat, lng, stationName, container);
                    }
                }, 2000);
                
            } catch (error) {
                console.log('‚ùå Error en m√©todo alternativo:', error);
                mostrarStreetViewNoDisponible(lat, lng, stationName, container);
            }
        }

        // Funci√≥n para mostrar Street View embebido
        function mostrarStreetViewEmbed(lat, lng, stationName, container) {
            console.log('üåç Mostrando Street View embebido para:', stationName);
            
            container.innerHTML = `
                <div style="display: flex; flex-direction: column; height: 100%;">
                    <div style="background: #8b5cf6; color: white; padding: 15px; text-align: center;">
                        <h3 style="margin: 0; font-size: 16px;">
                            <i class="fas fa-street-view"></i> Street View - ${stationName}
                        </h3>
                        <p style="margin: 5px 0 0 0; font-size: 12px; opacity: 0.9;">
                            Coordenadas: ${parseFloat(lat).toFixed(6)}, ${parseFloat(lng).toFixed(6)}
                        </p>
                    </div>
                    <div style="flex: 1; position: relative;">
                        <iframe 
                            src="https://www.google.com/maps/embed/v1/streetview?key=AIzaSyAX6hAgfg3Kz7SNClVgmRK1bStQnUJzbEA&location=${lat},${lng}&heading=0&pitch=0&fov=90"
                            width="100%" 
                            height="100%" 
                            style="border: none; border-radius: 0 0 12px 12px;"
                            allowfullscreen>
                        </iframe>
                        <div style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 8px 12px; border-radius: 4px; font-size: 12px;">
                            <i class="fas fa-street-view"></i> Street View
                        </div>
                    </div>
                </div>
            `;
        }

        // Funci√≥n para mostrar vista satelital embebida
        function mostrarVistaSatelitalEmbed(lat, lng, stationName, container) {
            console.log('üõ∞Ô∏è Mostrando vista satelital embebida para:', stationName);
            
            container.innerHTML = `
                <div style="display: flex; flex-direction: column; height: 100%;">
                    <div style="background: #10b981; color: white; padding: 15px; text-align: center;">
                        <h3 style="margin: 0; font-size: 16px;">
                            <i class="fas fa-satellite"></i> Vista Satelital - ${stationName}
                        </h3>
                        <p style="margin: 5px 0 0 0; font-size: 12px; opacity: 0.9;">
                            Coordenadas: ${parseFloat(lat).toFixed(6)}, ${parseFloat(lng).toFixed(6)}
                        </p>
                    </div>
                    <div style="flex: 1; position: relative;">
                        <iframe 
                            src="https://www.google.com/maps/embed/v1/view?key=AIzaSyAX6hAgfg3Kz7SNClVgmRK1bStQnUJzbEA&center=${lat},${lng}&zoom=18&maptype=satellite"
                            width="100%" 
                            height="100%" 
                            style="border: none; border-radius: 0 0 12px 12px;"
                            allowfullscreen>
                        </iframe>
                        <div style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 8px 12px; border-radius: 4px; font-size: 12px;">
                            <i class="fas fa-info-circle"></i> Vista Satelital
                        </div>
                    </div>
                </div>
            `;
        }





        // Test function for Google Street View public
        function testVerifiedAPI() {
            console.log('üß™ Testing Google Street View public (no API key required)...');
            console.log('üîë No API Key required - using public Google Street View');
            
            const testLat = 29.0892;
            const testLng = -110.9613;
            const testName = 'Hermosillo, Sonora - Street View';
            
            console.log('üìç Testing with coordinates:', testLat, testLng);
            
            // Test Google Street View with user's API key
            const streetViewContainer = document.getElementById('google-street-view');
            const loadingElement = document.getElementById('street-view-loading');
            const errorElement = document.getElementById('street-view-error');
            
            if (streetViewContainer) {
                streetViewContainer.style.display = 'block';
                streetViewContainer.innerHTML = '';
                
                // Create Google Street View public embed (no API key required)
                const streetViewUrl = `https://www.google.com/maps/embed?pb=!1m0!3m2!1sen!2sus!4v1234567890123!5m2!1sen!2sus&q=${testLat},${testLng}&t=h&z=20&output=embed`;
                
                const iframe = document.createElement('iframe');
                iframe.src = streetViewUrl;
                iframe.width = '100%';
                iframe.height = '100%';
                iframe.frameBorder = '0';
                iframe.style.border = 'none';
                iframe.style.borderRadius = '8px';
                iframe.allowFullscreen = true;
                iframe.title = `Street View - ${testName}`;
                
                iframe.onload = () => {
                    console.log('‚úÖ Google Street View loaded successfully without API key restrictions');
                };
                
                iframe.onerror = () => {
                    console.error('‚ùå Google Street View failed to load');
                    // Fallback to regular map if Street View fails
                    console.log('üîÑ Falling back to regular map view...');
                    const fallbackUrl = `https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3000!2d${testLng}!3d${testLat}!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x0%3A0x0!2zM${Math.floor(testLat)}%C2%B0${Math.floor((testLat % 1) * 60)}%27${Math.floor(((testLat % 1) * 60) % 1 * 60)}%22N%20${Math.floor(Math.abs(testLng))}%C2%B0${Math.floor((Math.abs(testLng) % 1) * 60)}%27${Math.floor(((Math.abs(testLng) % 1) * 60) % 1 * 60)}%22W!5e0!3m2!1sen!2sus!4v1234567890123!5m2!1sen!2sus`;
                    iframe.src = fallbackUrl;
                };
                
                streetViewContainer.appendChild(iframe);
            }
            

            if (loadingElement) loadingElement.style.display = 'none';
            if (errorElement) errorElement.style.display = 'none';
        }

        // Test function for Demo API (Google's demo key)
        function testDemoAPI() {
            console.log('üß™ Testing Demo API Key...');
            console.log('üîë Using Demo API Key: AIzaSyBFw0Qbyq9zTFTd-tUY6dOWWgUjKq8B2hE');
            
            const testLat = 29.0892;
            const testLng = -110.9613;
            const testName = 'Hermosillo, Sonora - API Demo';
            
            console.log('üìç Testing with coordinates:', testLat, testLng);
            
            // Test the demo API key directly
            const streetViewContainer = document.getElementById('google-street-view');
            const loadingElement = document.getElementById('street-view-loading');
            const errorElement = document.getElementById('street-view-error');
            
            if (streetViewContainer) {
                streetViewContainer.style.display = 'block';
                streetViewContainer.innerHTML = '';
                
                // Create iframe with demo API key
                const iframe = document.createElement('iframe');
                const embedUrl = `https://www.google.com/maps/embed/v1/streetview?key=AIzaSyBFw0Qbyq9zTFTd-tUY6dOWWgUjKq8B2hE&location=${testLat},${testLng}&heading=0&pitch=0&fov=90`;
                
                iframe.src = embedUrl;
                iframe.width = '100%';
                iframe.height = '100%';
                iframe.frameBorder = '0';
                iframe.style.border = 'none';
                iframe.style.borderRadius = '8px';
                iframe.allowFullscreen = true;
                iframe.title = `Street View - ${testName}`;
                
                iframe.onload = () => {
                    console.log('‚úÖ Demo API Street View loaded successfully!');
                };
                
                iframe.onerror = () => {
                    console.error('‚ùå Demo API Street View failed to load');
                };
                
                streetViewContainer.appendChild(iframe);
            }
            

            if (loadingElement) loadingElement.style.display = 'none';
            if (errorElement) errorElement.style.display = 'none';
        }

        // Create alternative Street View using Mapbox or other services
        function createAlternativeStreetView(lat, lng, locationName) {
            console.log('üîÑ Creating alternative Street View for:', locationName);
            
            const container = document.createElement('div');
            container.style.cssText = `
                width: 100%;
                height: 100%;
                background: linear-gradient(135deg, var(--color-primary-50), var(--color-neutral-50));
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                text-align: center;
                padding: 20px;
                color: var(--color-neutral-700);
            `;
            
            container.innerHTML = `
                <div style="margin-bottom: 24px;">
                    <i class="fas fa-map-marked-alt" style="font-size: 4rem; color: var(--color-primary-500); margin-bottom: 16px;"></i>
                    <h2 style="margin: 0 0 8px 0; color: var(--color-neutral-800); font-size: 1.5rem;">${locationName}</h2>
                    <p style="margin: 0 0 16px 0; font-size: 1.1rem; color: var(--color-neutral-600);">Vista Alternativa de Ubicaci√≥n</p>
                </div>
                
                <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.1); margin-bottom: 24px; min-width: 300px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <span style="font-weight: 600; color: var(--color-neutral-700);">Latitud:</span>
                        <span style="font-family: monospace; background: var(--color-primary-100); padding: 4px 8px; border-radius: 4px;">${lat.toFixed(6)}¬∞ N</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <span style="font-weight: 600; color: var(--color-neutral-700);">Longitud:</span>
                        <span style="font-family: monospace; background: var(--color-primary-100); padding: 4px 8px; border-radius: 4px;">${Math.abs(lng).toFixed(6)}¬∞ W</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: 600; color: var(--color-neutral-700);">Coordenadas:</span>
                        <span style="font-family: monospace; background: var(--color-primary-100); padding: 4px 8px; border-radius: 4px;">${lat}, ${lng}</span>
                    </div>
                </div>
                
                <div style="display: flex; gap: 12px; flex-wrap: wrap; justify-content: center; margin-bottom: 20px;">
                    <button onclick="copyCoordinates('${lat}', '${lng}')" style="
                        background: var(--color-primary-500);
                        color: white;
                        border: none;
                        padding: 12px 20px;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 0.9rem;
                        font-weight: 600;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                    ">
                        <i class="fas fa-copy"></i>
                        Copiar Coordenadas
                    </button>
                    <button onclick="openInGoogleMaps('${lat}', '${lng}')" style="
                        background: var(--color-success-500);
                        color: white;
                        border: none;
                        padding: 12px 20px;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 0.9rem;
                        font-weight: 600;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                    ">
                        <i class="fas fa-external-link-alt"></i>
                        Google Maps
                    </button>
                    <button onclick="openInOpenStreetMap('${lat}', '${lng}')" style="
                        background: var(--color-warning-500);
                        color: white;
                        border: none;
                        padding: 12px 20px;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 0.9rem;
                        font-weight: 600;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                    ">
                        <i class="fas fa-map"></i>
                        OpenStreetMap
                    </button>
                </div>
                
                <div style="margin-top: 20px; padding: 16px; background: var(--color-info-50); border-radius: 8px; border-left: 4px solid var(--color-info-500);">
                    <p style="margin: 0; font-size: 0.9rem; color: var(--color-info-700);">
                        <i class="fas fa-info-circle" style="margin-right: 8px;"></i>
                        Google Street View no est√° disponible. Usa los botones para abrir en mapas externos o copiar las coordenadas.
                    </p>
                </div>
            `;
            
            return container;
        }
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAX6hAgfg3Kz7SNClVgmRK1bStQnUJzbEA&libraries=geometry&loading=async&callback=initGoogleMaps"></script>
    
    <style>
        /* CSS Custom Properties with Design System */
        :root {
            /* Color System - HSL for better manipulation */
            --color-primary-50: hsl(220, 100%, 97%);
            --color-primary-100: hsl(220, 100%, 94%);
            --color-primary-200: hsl(220, 100%, 88%);
            --color-primary-300: hsl(220, 100%, 80%);
            --color-primary-400: hsl(220, 100%, 70%);
            --color-primary-500: hsl(220, 100%, 60%);
            --color-primary-600: hsl(220, 100%, 50%);
            --color-primary-700: hsl(220, 100%, 40%);
            --color-primary-800: hsl(220, 100%, 30%);
            --color-primary-900: hsl(220, 100%, 20%);
            --color-primary-950: hsl(220, 100%, 10%);
            
            /* Semantic Colors */
            --color-success: hsl(142, 76%, 36%);
            --color-warning: hsl(38, 92%, 50%);
            --color-error: hsl(0, 84%, 60%);
            --color-info: hsl(199, 89%, 48%);
            
            /* Neutral Scale */
            --color-neutral-0: hsl(0, 0%, 100%);
            --color-neutral-50: hsl(0, 0%, 98%);
            --color-neutral-100: hsl(0, 0%, 96%);
            --color-neutral-200: hsl(0, 0%, 90%);
            --color-neutral-300: hsl(0, 0%, 82%);
            --color-neutral-400: hsl(0, 0%, 64%);
            --color-neutral-500: hsl(0, 0%, 45%);
            --color-neutral-600: hsl(0, 0%, 32%);
            --color-neutral-700: hsl(0, 0%, 25%);
            --color-neutral-800: hsl(0, 0%, 15%);
            --color-neutral-900: hsl(0, 0%, 9%);
            --color-neutral-950: hsl(0, 0%, 4%);
            
            /* Typography Scale */
            --font-size-xs: 0.75rem;    /* 12px */
            --font-size-sm: 0.875rem;   /* 14px */
            --font-size-base: 1rem;     /* 16px */
            --font-size-lg: 1.125rem;   /* 18px */
            --font-size-xl: 1.25rem;    /* 20px */
            --font-size-2xl: 1.5rem;    /* 24px */
            --font-size-3xl: 1.875rem;  /* 30px */
            --font-size-4xl: 2.25rem;   /* 36px */
            --font-size-5xl: 3rem;      /* 48px */
            --font-size-6xl: 3.75rem;   /* 60px */
            
            /* Spacing Scale */
            --space-px: 1px;
            --space-0: 0;
            --space-1: 0.25rem;   /* 4px */
            --space-2: 0.5rem;    /* 8px */
            --space-3: 0.75rem;   /* 12px */
            --space-4: 1rem;      /* 16px */
            --space-5: 1.25rem;   /* 20px */
            --space-6: 1.5rem;    /* 24px */
            --space-8: 2rem;      /* 32px */
            --space-10: 2.5rem;   /* 40px */
            --space-12: 3rem;     /* 48px */
            --space-16: 4rem;     /* 64px */
            --space-20: 5rem;     /* 80px */
            --space-24: 6rem;     /* 96px */
            --space-32: 8rem;     /* 128px */
            
            /* Border Radius */
            --radius-none: 0;
            --radius-sm: 0.125rem;
            --radius-base: 0.25rem;
            --radius-md: 0.375rem;
            --radius-lg: 0.5rem;
            --radius-xl: 0.75rem;
            --radius-2xl: 1rem;
            --radius-3xl: 1.5rem;
            --radius-full: 9999px;
            
            /* Shadows */
            --shadow-xs: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-sm: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            --shadow-2xl: 0 25px 50px -12px rgb(0 0 0 / 0.25);
            
            /* Z-Index Scale */
            --z-dropdown: 1000;
            --z-sticky: 1020;
            --z-fixed: 1030;
            --z-modal-backdrop: 1040;
            --z-modal: 1050;
            --z-popover: 1060;
            --z-tooltip: 1070;
            --z-toast: 1080;
            
            /* Animation Durations */
            --duration-75: 75ms;
            --duration-100: 100ms;
            --duration-150: 150ms;
            --duration-200: 200ms;
            --duration-300: 300ms;
            --duration-500: 500ms;
            --duration-700: 700ms;
            --duration-1000: 1000ms;
            
            /* Easing Functions */
            --ease-linear: linear;
            --ease-in: cubic-bezier(0.4, 0, 1, 1);
            --ease-out: cubic-bezier(0, 0, 0.2, 1);
            --ease-in-out: cubic-bezier(0.4, 0, 0.2, 1);
            --ease-bounce: cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        /* CSS Reset with Modern Approach */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 16px;
            line-height: 1.5;
            -webkit-text-size-adjust: 100%;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            font-size: var(--font-size-base);
            font-weight: 400;
            line-height: 1.6;
            color: var(--color-neutral-800);
            background: linear-gradient(135deg, var(--color-neutral-50) 0%, var(--color-neutral-100) 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Enterprise Layout System */
        .enterprise-layout {
            display: grid;
            grid-template-areas: 
                "header header"
                "sidebar main"
                "footer footer";
            grid-template-columns: 280px 1fr;
            grid-template-rows: auto 1fr auto;
            min-height: 100vh;
            gap: var(--space-4);
            padding: var(--space-4);
        }

        /* Header Component */
        .enterprise-header {
            grid-area: header;
            background: linear-gradient(135deg, var(--color-primary-900) 0%, var(--color-primary-800) 50%, var(--color-primary-700) 100%);
            border-radius: var(--radius-2xl);
            padding: var(--space-8) var(--space-12);
            color: var(--color-neutral-0);
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-2xl);
        }

        .enterprise-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 80%, rgba(255,255,255,0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255,255,255,0.08) 0%, transparent 50%),
                linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.05) 50%, transparent 70%);
            pointer-events: none;
        }

        .header-content {
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-brand {
            display: flex;
            align-items: center;
            gap: var(--space-6);
        }

        .brand-logo {
            width: 150px;
            height: 150px;
            background: linear-gradient(135deg, var(--color-primary-500), var(--color-primary-600));
            border-radius: var(--radius-xl);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-neutral-0);
            font-size: var(--font-size-xl);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
        }

        .company-logo {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: var(--radius-xl);
        }

        .brand-text {
            display: flex;
            flex-direction: column;
        }

        .brand-title {
            font-size: var(--font-size-2xl);
            font-weight: 800;
            line-height: 1.2;
            margin-bottom: var(--space-1);
        }

        .brand-subtitle {
            font-size: var(--font-size-sm);
            opacity: 0.8;
            font-weight: 500;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: var(--space-4);
        }

        .nav-button {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-3) var(--space-4);
            background: rgba(255, 255, 255, 0.1);
            color: var(--color-neutral-0);
            text-decoration: none;
            border-radius: var(--radius-lg);
            font-size: var(--font-size-sm);
            font-weight: 600;
            transition: all var(--duration-200) var(--ease-out);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .nav-button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        /* Sidebar Component */
        .enterprise-sidebar {
            grid-area: sidebar;
            background: var(--color-neutral-0);
            border-radius: var(--radius-2xl);
            padding: var(--space-4);
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--color-neutral-200);
            height: fit-content;
            position: sticky;
            top: var(--space-4);
        }

        .sidebar-section {
            margin-bottom: var(--space-8);
        }

        .sidebar-section:last-child {
            margin-bottom: 0;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-bottom: var(--space-4);
            padding: var(--space-3) var(--space-4);
            background: var(--color-neutral-50);
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-neutral-200);
        }

        .section-title {
            font-size: var(--font-size-sm);
            font-weight: 700;
            color: var(--color-primary-800);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
        }

        .filter-item {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3);
            border-radius: var(--radius-md);
            transition: all var(--duration-200) var(--ease-out);
            cursor: pointer;
        }

        .filter-item:hover {
            background: var(--color-neutral-50);
            transform: translateX(4px);
        }

        .filter-checkbox {
            width: 18px;
            height: 18px;
            accent-color: var(--color-primary-600);
            border-radius: var(--radius-sm);
        }

        .filter-label {
            font-size: var(--font-size-sm);
            color: var(--color-neutral-700);
            font-weight: 500;
            cursor: pointer;
        }

        /* Main Content Area */
        .enterprise-main {
            grid-area: main;
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-6);
        }

        .stat-card {
            background: var(--color-neutral-0);
            border-radius: var(--radius-2xl);
            padding: var(--space-6);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--color-neutral-200);
            position: relative;
            overflow: hidden;
            transition: all var(--duration-300) var(--ease-out);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--color-primary-500), var(--color-primary-600));
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-2xl);
        }

        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-4);
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--color-primary-100), var(--color-primary-200));
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-primary-600);
            font-size: var(--font-size-lg);
        }

        .stat-value {
            font-size: var(--font-size-3xl);
            font-weight: 800;
            color: var(--color-primary-800);
            line-height: 1;
            margin-bottom: var(--space-2);
        }

        .stat-label {
            font-size: var(--font-size-sm);
            color: var(--color-neutral-600);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Enhanced Map Container */
        .map-container {
            background: var(--color-neutral-0);
            border-radius: var(--radius-2xl);
            overflow: hidden;
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--color-neutral-200);
            height: 600px; /* Altura reducida */
            width: 50%; /* Ancho reducido para que est√© a la izquierda */
            position: relative;
            float: left; /* Para posicionarlo a la izquierda */
            margin-right: var(--space-4); /* Espacio a la derecha */
        }

        /* Tabla de datos al lado del mapa */
        .data-table-container {
            background: var(--color-neutral-0);
            border-radius: var(--radius-2xl);
            overflow: hidden;
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--color-neutral-200);
            height: 600px; /* Misma altura que el mapa */
            width: 45%; /* Ancho para la tabla */
            position: relative;
            float: right; /* Para posicionarlo a la derecha */
        }

        .data-table-header {
            background: linear-gradient(135deg, var(--color-primary-800), var(--color-primary-700));
            color: var(--color-neutral-0);
            padding: var(--space-4);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .data-table-content {
            height: calc(100% - 80px);
            overflow-y: auto;
            padding: var(--space-4);
        }

        .link-data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: var(--font-size-sm);
        }

        .link-data-table th {
            background: var(--color-neutral-100);
            color: var(--color-neutral-800);
            padding: var(--space-3);
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid var(--color-neutral-200);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .link-data-table td {
            padding: var(--space-3);
            border-bottom: 1px solid var(--color-neutral-200);
            color: var(--color-neutral-700);
        }

        .link-data-table tbody tr:hover {
            background: var(--color-neutral-50);
        }

        .no-data-message {
            text-align: center;
            color: var(--color-neutral-500);
            font-style: italic;
            padding: var(--space-8);
        }

        .link-data-section {
            margin-bottom: var(--space-6);
        }

        .link-data-section h3 {
            font-size: var(--font-size-lg);
            font-weight: 700;
            margin-bottom: var(--space-3);
        }

        .link-data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: var(--font-size-sm);
            margin-bottom: var(--space-4);
        }

        .link-data-table td {
            padding: var(--space-2) var(--space-3);
            border-bottom: 1px solid var(--color-neutral-200);
            color: var(--color-neutral-700);
            vertical-align: top;
        }

        .link-data-table td:first-child {
            width: 40%;
            font-weight: 600;
            color: var(--color-neutral-800);
            background: var(--color-neutral-50);
        }

        .link-data-table td:last-child {
            width: 60%;
            color: var(--color-neutral-600);
        }

        /* Nuevo dise√±o visual mejorado */
        .link-summary-card {
            background: linear-gradient(135deg, var(--color-primary-50), var(--color-neutral-50));
            border-radius: var(--radius-xl);
            padding: var(--space-6);
            margin-bottom: var(--space-6);
            border: 1px solid var(--color-primary-200);
            box-shadow: var(--shadow-lg);
        }

        .link-summary-header {
            display: flex;
            align-items: center;
            gap: var(--space-4);
            margin-bottom: var(--space-6);
        }

        .link-icon {
            font-size: 2.5rem;
            background: var(--color-primary-100);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .link-title {
            flex: 1;
        }

        .link-title h2 {
            margin: 0;
            color: var(--color-primary-800);
            font-size: var(--font-size-xl);
            font-weight: 700;
        }

        .link-subtitle {
            margin: var(--space-1) 0 0 0;
            color: var(--color-neutral-600);
            font-size: var(--font-size-sm);
        }

        .link-status {
            display: flex;
            align-items: center;
        }

        .status-badge-large {
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-full);
            font-weight: 600;
            font-size: var(--font-size-sm);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .status-badge-large.status-active {
            background: var(--color-success-100);
            color: var(--color-success-800);
            border: 1px solid var(--color-success-300);
        }

        .status-badge-large.status-pending {
            background: var(--color-warning-100);
            color: var(--color-warning-800);
            border: 1px solid var(--color-warning-300);
        }

        .status-badge-large.status-inactive {
            background: var(--color-error-100);
            color: var(--color-error-800);
            border: 1px solid var(--color-error-300);
        }

        .link-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-4);
            margin-bottom: var(--space-4);
        }

        .metric-card {
            background: var(--color-neutral-0);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            text-align: center;
            border: 1px solid var(--color-neutral-200);
            box-shadow: var(--shadow-sm);
        }

        .metric-icon {
            font-size: 1.5rem;
            margin-bottom: var(--space-2);
        }

        .metric-value {
            font-size: var(--font-size-lg);
            font-weight: 700;
            color: var(--color-primary-700);
            margin-bottom: var(--space-1);
        }

        .metric-label {
            font-size: var(--font-size-xs);
            color: var(--color-neutral-600);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .link-alert {
            background: var(--color-warning-50);
            border: 1px solid var(--color-warning-200);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .alert-icon {
            font-size: 1.5rem;
        }

        .alert-content {
            color: var(--color-warning-800);
            font-size: var(--font-size-sm);
        }

        .stations-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-4);
        }

        .station-card {
            background: var(--color-neutral-0);
            border-radius: var(--radius-xl);
            padding: var(--space-5);
            border: 2px solid var(--color-neutral-200);
            box-shadow: var(--shadow-md);
        }

        .station-card.station-a {
            border-color: var(--color-primary-300);
            background: linear-gradient(135deg, var(--color-primary-25), var(--color-neutral-0));
        }

        .station-card.station-d {
            border-color: var(--color-error-300);
            background: linear-gradient(135deg, var(--color-error-25), var(--color-neutral-0));
        }

        .station-header {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-bottom: var(--space-4);
            padding-bottom: var(--space-3);
            border-bottom: 1px solid var(--color-neutral-200);
        }

        .station-icon {
            font-size: 1.5rem;
        }

        .station-info {
            flex: 1;
        }

        .station-info h3 {
            margin: 0;
            color: var(--color-neutral-800);
            font-size: var(--font-size-lg);
            font-weight: 600;
        }

        .station-name {
            margin: var(--space-1) 0 0 0;
            color: var(--color-neutral-600);
            font-size: var(--font-size-sm);
        }

        .station-badge {
            background: var(--color-primary-600);
            color: var(--color-neutral-0);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: var(--font-size-sm);
        }

        .station-card.station-d .station-badge {
            background: var(--color-error-600);
        }

        .station-details {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-2);
            background: var(--color-neutral-50);
            border-radius: var(--radius-md);
        }

        .detail-label {
            font-weight: 600;
            color: var(--color-neutral-700);
            font-size: var(--font-size-sm);
        }

        .detail-value {
            color: var(--color-neutral-600);
            font-size: var(--font-size-sm);
            text-align: right;
        }

        /* Estilos para el selector de enlaces */
        .link-selector-section {
            margin-bottom: var(--space-6);
        }

        .selector-header {
            text-align: center;
            margin-bottom: var(--space-4);
        }

        .selector-header h3 {
            color: var(--color-primary-700);
            margin: 0 0 var(--space-2) 0;
            font-size: var(--font-size-lg);
            font-weight: 600;
        }

        .selector-header p {
            color: var(--color-neutral-600);
            margin: 0;
            font-size: var(--font-size-sm);
        }

        .link-search-container {
            margin-bottom: var(--space-4);
        }

        .link-search-input {
            width: 100%;
            padding: var(--space-3);
            border: 2px solid var(--color-neutral-300);
            border-radius: var(--radius-lg);
            font-size: var(--font-size-sm);
            background: var(--color-neutral-0);
            transition: all 0.2s ease;
        }

        .link-search-input:focus {
            outline: none;
            border-color: var(--color-primary-500);
            box-shadow: 0 0 0 3px var(--color-primary-100);
        }

        .links-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--color-neutral-200);
            border-radius: var(--radius-lg);
            background: var(--color-neutral-0);
        }

        .link-item {
            padding: var(--space-3);
            border-bottom: 1px solid var(--color-neutral-200);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .link-item:last-child {
            border-bottom: none;
        }

        .link-item:hover {
            background: var(--color-primary-50);
            border-left: 4px solid var(--color-primary-500);
        }

        .link-item.selected {
            background: var(--color-primary-100);
            border-left: 4px solid var(--color-primary-600);
            font-weight: 600;
        }

        .link-item-info {
            flex: 1;
        }

        .link-item-name {
            font-weight: 600;
            color: var(--color-neutral-800);
            font-size: var(--font-size-sm);
            margin-bottom: var(--space-1);
        }

        .link-item-details {
            font-size: var(--font-size-xs);
            color: var(--color-neutral-600);
        }

        .link-item-status {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-indicator.active {
            background: var(--color-success-500);
        }

        .status-indicator.pending {
            background: var(--color-warning-500);
        }

        .status-indicator.inactive {
            background: var(--color-error-500);
        }

        .selected-link-data {
            margin-top: var(--space-6);
            padding-top: var(--space-6);
            border-top: 2px solid var(--color-neutral-200);
        }

        /* Dashboard de An√°lisis de Red */
        .network-dashboard {
            padding: var(--space-4);
        }

        .dashboard-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-4);
            margin-bottom: var(--space-6);
        }

        .metric-card-large {
            background: linear-gradient(135deg, var(--color-primary-50), var(--color-neutral-50));
            border-radius: var(--radius-xl);
            padding: var(--space-4);
            border: 1px solid var(--color-primary-200);
            box-shadow: var(--shadow-md);
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .metric-icon-large {
            font-size: 2rem;
            background: var(--color-primary-100);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .metric-content-large {
            flex: 1;
        }

        .metric-value-large {
            font-size: var(--font-size-2xl);
            font-weight: 700;
            color: var(--color-primary-700);
            margin-bottom: var(--space-1);
        }

        .metric-label-large {
            font-size: var(--font-size-sm);
            color: var(--color-neutral-600);
            font-weight: 500;
        }

        .dashboard-chart {
            background: var(--color-neutral-0);
            border-radius: var(--radius-xl);
            padding: var(--space-5);
            margin-bottom: var(--space-6);
            border: 1px solid var(--color-neutral-200);
            box-shadow: var(--shadow-md);
        }

        .dashboard-chart h3 {
            color: var(--color-primary-700);
            margin: 0 0 var(--space-4) 0;
            font-size: var(--font-size-lg);
            font-weight: 600;
        }

        .chart-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }

        .dashboard-analysis {
            background: var(--color-neutral-0);
            border-radius: var(--radius-xl);
            padding: var(--space-5);
            margin-bottom: var(--space-6);
            border: 1px solid var(--color-neutral-200);
            box-shadow: var(--shadow-md);
        }

        .dashboard-analysis h3 {
            color: var(--color-primary-700);
            margin: 0 0 var(--space-4) 0;
            font-size: var(--font-size-lg);
            font-weight: 600;
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-4);
        }

        .analysis-item {
            text-align: center;
            padding: var(--space-3);
            background: var(--color-neutral-50);
            border-radius: var(--radius-lg);
        }

        .analysis-label {
            font-size: var(--font-size-sm);
            color: var(--color-neutral-600);
            margin-bottom: var(--space-2);
            font-weight: 500;
        }

        .analysis-value {
            font-size: var(--font-size-lg);
            font-weight: 700;
            color: var(--color-primary-700);
        }

        .dashboard-top-links {
            background: var(--color-neutral-0);
            border-radius: var(--radius-xl);
            padding: var(--space-5);
            margin-bottom: var(--space-6);
            border: 1px solid var(--color-neutral-200);
            box-shadow: var(--shadow-md);
        }

        .dashboard-top-links h3 {
            color: var(--color-primary-700);
            margin: 0 0 var(--space-4) 0;
            font-size: var(--font-size-lg);
            font-weight: 600;
        }

        .top-links-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
        }

        .top-link-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-3);
            background: var(--color-neutral-50);
            border-radius: var(--radius-lg);
            border-left: 4px solid var(--color-primary-500);
        }

        .top-link-name {
            font-weight: 600;
            color: var(--color-neutral-800);
            font-size: var(--font-size-sm);
        }

        .top-link-distance {
            font-weight: 700;
            color: var(--color-primary-700);
            font-size: var(--font-size-sm);
        }

        .dashboard-bands {
            background: var(--color-neutral-0);
            border-radius: var(--radius-xl);
            padding: var(--space-5);
            border: 1px solid var(--color-neutral-200);
            box-shadow: var(--shadow-md);
        }

        .dashboard-bands h3 {
            color: var(--color-primary-700);
            margin: 0 0 var(--space-4) 0;
            font-size: var(--font-size-lg);
            font-weight: 600;
        }

        .bands-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-3);
        }

        .band-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-3);
            background: var(--color-neutral-50);
            border-radius: var(--radius-lg);
        }

        .band-name {
            font-weight: 600;
            color: var(--color-neutral-800);
            font-size: var(--font-size-sm);
        }

        .band-count {
            background: var(--color-primary-100);
            color: var(--color-primary-700);
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
            font-weight: 600;
        }

        .map-header {
            background: linear-gradient(135deg, var(--color-primary-800), var(--color-primary-700));
            color: var(--color-neutral-0);
            padding: var(--space-6);
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--space-3);
        }

        .map-header-left {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .map-controls {
            display: flex;
            gap: var(--space-2);
        }

        .map-control-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: var(--radius-md);
            color: var(--color-neutral-0);
            padding: var(--space-2) var(--space-3);
            cursor: pointer;
            transition: all var(--duration-200) var(--ease-out);
            font-size: var(--font-size-sm);
            backdrop-filter: blur(10px);
        }

        .map-control-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        #network-map {
            width: 100%;
            height: calc(100% - 80px); /* Ajustado para el nuevo tama√±o */
            position: relative;
        }

        /* Map Legend */
        .map-legend {
            position: absolute;
            bottom: var(--space-4);
            left: var(--space-4);
            background: var(--color-neutral-0);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--color-neutral-200);
            z-index: 1000;
            min-width: 200px;
        }

        .legend-title {
            font-weight: 600;
            margin-bottom: var(--space-3);
            color: var(--color-neutral-800);
            font-size: var(--font-size-sm);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            margin-bottom: var(--space-2);
            font-size: var(--font-size-xs);
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: var(--radius-full);
            border: 2px solid var(--color-neutral-0);
            box-shadow: 0 0 0 1px var(--color-neutral-300);
        }

        .legend-size {
            width: 8px;
            height: 8px;
            border-radius: var(--radius-full);
            background: var(--color-primary-600);
            border: 2px solid var(--color-neutral-0);
            box-shadow: 0 0 0 1px var(--color-neutral-300);
        }

        /* Custom Map Markers */
        .custom-marker {
            background: var(--color-primary-600);
            border: 3px solid var(--color-neutral-0);
            border-radius: var(--radius-full);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-neutral-0);
            font-weight: 600;
            font-size: var(--font-size-xs);
            transition: all var(--duration-300) var(--ease-out);
            animation: markerPulse 2s infinite;
        }

        .custom-marker:hover {
            transform: scale(1.2);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
        }

        .custom-marker.active {
            background: var(--color-success);
            animation: markerActive 1s ease-in-out;
        }

        .custom-marker.pending {
            background: var(--color-warning);
        }

        .custom-marker.inactive {
            background: var(--color-error);
        }

        @keyframes markerPulse {
            0%, 100% { box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); }
            50% { box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25), 0 0 0 4px rgba(59, 130, 246, 0.1); }
        }

        @keyframes markerActive {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }

        /* Tower Markers - Simplificados para mejor rendimiento */

        .tower-marker:hover {
            transform: scale(1.1);
        }

        /* Estilos para popups de torres */
        .tower-popup {
            font-family: var(--font-sans);
            font-size: 12px;
            line-height: 1.4;
        }

        .tower-popup h4 {
            font-size: 14px;
            font-weight: 600;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 4px;
        }

        .tower-popup p {
            margin: 4px 0;
            color: #374151;
        }

        .tower-popup strong {
            color: #1f2937;
        }

        @keyframes towerPulse {
            0%, 100% { 
                filter: drop-shadow(0 0 5px rgba(66, 153, 225, 0.3));
            }
            50% { 
                filter: drop-shadow(0 0 15px rgba(66, 153, 225, 0.6));
            }
        }

        @keyframes towerActive {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        /* Microwave Links Styles - Simplificados para mejor rendimiento */

        .microwave-link.feasible {
            stroke: #10b981;
            stroke-width: 3;
            stroke-opacity: 0.8;
        }

        .microwave-link.non-feasible {
            stroke: #ef4444;
            stroke-width: 3;
            stroke-opacity: 0.7;
            stroke-dasharray: 10, 5;
        }

        .microwave-link.pending {
            stroke: #f59e0b;
            stroke-width: 3;
            stroke-opacity: 0.8;
            stroke-dasharray: 5, 3;
        }

        .microwave-link:hover {
            stroke-width: 4;
            stroke-opacity: 1;
        }

        /* Signal Points - Animaciones removidas para mejorar rendimiento */

        @keyframes signalPulse {
            0%, 100% { 
                stroke-opacity: 0.3;
                stroke-width: 8;
            }
            50% { 
                stroke-opacity: 0.6;
                stroke-width: 12;
            }
        }

        @keyframes signalPointPulse {
            0%, 100% { 
                opacity: 0.6;
                transform: scale(1);
            }
            50% { 
                opacity: 1;
                transform: scale(1.3);
            }
        }

        /* Band Labels */
        .band-label-container {
            background: transparent !important;
            border: none !important;
        }

        .band-label {
            background: rgba(255, 255, 255, 0.95);
            color: #1f2937;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-align: center;
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            white-space: nowrap;
            backdrop-filter: blur(4px);
        }

        @keyframes linkActive {
            0% { stroke-width: 4; }
            50% { stroke-width: 8; }
            100% { stroke-width: 4; }
        }

        /* Link Popup Styles */
        .link-popup .leaflet-popup-content-wrapper {
            background: var(--color-neutral-0);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-2xl);
            border: 1px solid var(--color-neutral-200);
        }

        .link-popup-content {
            padding: var(--space-4);
            font-family: 'Inter', sans-serif;
        }

        .link-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-4);
            padding-bottom: var(--space-3);
            border-bottom: 1px solid var(--color-neutral-200);
        }

        .link-title {
            font-size: var(--font-size-lg);
            font-weight: 700;
            color: var(--color-neutral-800);
            margin: 0;
        }

        .link-feasibility {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-lg);
            font-size: var(--font-size-sm);
            font-weight: 600;
        }

        .link-feasibility.feasible {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }

        .link-feasibility.non-feasible {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .link-details {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
            margin-bottom: var(--space-4);
        }

        .link-detail {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .link-detail-label {
            font-size: var(--font-size-sm);
            color: var(--color-neutral-600);
            font-weight: 500;
        }

        .link-detail-value {
            font-size: var(--font-size-sm);
            color: var(--color-neutral-800);
            font-weight: 600;
        }

        .link-reason {
            padding: var(--space-3);
            background: var(--color-neutral-50);
            border-radius: var(--radius-lg);
            border-left: 4px solid var(--color-warning);
        }

        .link-reason-label {
            font-size: var(--font-size-sm);
            color: var(--color-neutral-600);
            font-weight: 600;
            display: block;
            margin-bottom: var(--space-2);
        }

        .link-reason-text {
            font-size: var(--font-size-sm);
            color: var(--color-neutral-700);
            line-height: 1.5;
        }

        .link-actions {
            margin-top: var(--space-4);
            padding-top: var(--space-3);
            border-top: 1px solid var(--color-neutral-200);
        }

        .link-action-btn {
            width: 100%;
            background: linear-gradient(135deg, var(--color-primary-600), var(--color-primary-700));
            color: var(--color-neutral-0);
            border: none;
            border-radius: var(--radius-lg);
            padding: var(--space-3) var(--space-4);
            font-size: var(--font-size-sm);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--duration-200) var(--ease-out);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
        }

        .link-action-btn:hover {
            background: linear-gradient(135deg, var(--color-primary-700), var(--color-primary-800));
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .link-action-btn:active {
            transform: translateY(0);
        }

        .link-action-btn:first-child {
            background: linear-gradient(135deg, var(--color-success-600), var(--color-success-700));
        }

        .link-action-btn:first-child:hover {
            background: linear-gradient(135deg, var(--color-success-700), var(--color-success-800));
        }

        /* Enhanced Popup Styling */
        .leaflet-popup-content-wrapper {
            background: var(--color-neutral-0);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--color-neutral-200);
            padding: 0;
        }

        .leaflet-popup-content {
            margin: 0;
            padding: var(--space-4);
            font-family: 'Inter', sans-serif;
        }

        .leaflet-popup-tip {
            background: var(--color-neutral-0);
            border: 1px solid var(--color-neutral-200);
        }

        .marker-popup {
            min-width: 280px;
        }

        .marker-actions {
            margin-top: var(--space-3);
            padding-top: var(--space-3);
            border-top: 1px solid var(--color-neutral-200);
        }

        .marker-action-btn {
            width: 100%;
            padding: var(--space-2) var(--space-3);
            background: var(--color-primary-600);
            color: var(--color-neutral-0);
            border: none;
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--duration-200) var(--ease-out);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
        }

        .marker-action-btn:hover {
            background: var(--color-primary-700);
            transform: translateY(-1px);
        }

        .marker-title {
            color: var(--color-primary-800);
            font-size: var(--font-size-lg);
            font-weight: 700;
            margin-bottom: var(--space-3);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .marker-details {
            display: grid;
            gap: var(--space-2);
        }

        .marker-detail {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-2);
            background: var(--color-neutral-50);
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
        }

        .marker-detail-label {
            font-weight: 600;
            color: var(--color-neutral-700);
        }

        .marker-detail-value {
            color: var(--color-neutral-600);
        }

        .marker-status {
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .marker-status.active {
            background: var(--color-success);
            color: var(--color-neutral-0);
        }

        .marker-status.pending {
            background: var(--color-warning);
            color: var(--color-neutral-0);
        }

        .marker-status.inactive {
            background: var(--color-error);
            color: var(--color-neutral-0);
        }

        /* Map Loading State */
        .map-loading {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--color-neutral-50);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            border-radius: 0 0 var(--radius-2xl) var(--radius-2xl);
        }

        .map-loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--color-neutral-200);
            border-top: 4px solid var(--color-primary-600);
            border-radius: var(--radius-full);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Map Controls Enhancement */
        .leaflet-control-layers {
            background: var(--color-neutral-0);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--color-neutral-200);
        }

        .leaflet-control-layers-toggle {
            background: var(--color-neutral-0);
            border: 1px solid var(--color-neutral-200);
            border-radius: var(--radius-md);
        }

        .leaflet-control-zoom {
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-lg);
        }

        .leaflet-control-zoom a {
            background: var(--color-neutral-0);
            border: 1px solid var(--color-neutral-200);
            color: var(--color-neutral-700);
            font-weight: 600;
        }

        .leaflet-control-zoom a:hover {
            background: var(--color-primary-50);
            color: var(--color-primary-700);
        }

        /* Marker Cluster Styling */
        .custom-cluster {
            background: var(--color-primary-600);
            border: 3px solid var(--color-neutral-0);
            border-radius: var(--radius-full);
            color: var(--color-neutral-0);
            font-weight: 700;
            font-size: var(--font-size-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-lg);
            transition: all var(--duration-200) var(--ease-out);
        }

        .custom-cluster:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-xl);
        }

        .cluster-icon {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-full);
        }

        .cluster-small {
            background: var(--color-primary-500);
            width: 30px;
            height: 30px;
            font-size: var(--font-size-xs);
        }

        .cluster-medium {
            background: var(--color-primary-600);
            width: 40px;
            height: 40px;
            font-size: var(--font-size-sm);
        }

        .cluster-large {
            background: var(--color-primary-700);
            width: 50px;
            height: 50px;
            font-size: var(--font-size-base);
        }

        /* Custom Map Controls */
        .custom-control {
            background: var(--color-neutral-0);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--color-neutral-200);
            overflow: hidden;
        }

        .custom-control .map-control-btn {
            background: var(--color-neutral-0);
            border: none;
            color: var(--color-neutral-700);
            padding: var(--space-3);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--duration-200) var(--ease-out);
        }

        .custom-control .map-control-btn:hover {
            background: var(--color-primary-50);
            color: var(--color-primary-700);
        }

        /* Enhanced Popup Styling */
        .marker-alerts {
            margin-top: var(--space-3);
            padding: var(--space-2);
            background: var(--color-warning);
            color: var(--color-neutral-0);
            border-radius: var(--radius-md);
            font-size: var(--font-size-xs);
            font-weight: 600;
        }

        /* Map Responsive Enhancements */
        @media (max-width: 768px) {
            .map-legend {
                bottom: var(--space-2);
                left: var(--space-2);
                right: var(--space-2);
                min-width: auto;
                padding: var(--space-3);
            }

            .legend-title {
                font-size: var(--font-size-xs);
            }

            .legend-item {
                font-size: var(--font-size-xs);
            }

            .main-content-layout {
                display: grid;
                grid-template-columns: 1fr 1fr; /* Dos columnas para desktop */
                gap: var(--space-4);
                margin-top: var(--space-4);
            }

            @media (max-width: 768px) {
                .main-content-layout {
                    grid-template-columns: 1fr; /* Una columna en m√≥viles */
                    gap: var(--space-4);
                }
            }

            .map-container, .data-table-container {
                height: 600px; /* Altura completa para desktop */
            }

            @media (max-width: 768px) {
                .map-container, .data-table-container {
                    height: 400px; /* M√°s compacto en responsive */
                }

                .link-metrics {
                    grid-template-columns: 1fr; /* Una columna en m√≥viles */
                }

                .stations-comparison {
                    grid-template-columns: 1fr; /* Una columna en m√≥viles */
                }

                .link-summary-header {
                    flex-direction: column;
                    text-align: center;
                    gap: var(--space-3);
                }

                .link-icon {
                    width: 50px;
                    height: 50px;
                    font-size: 2rem;
                }

                .dashboard-metrics {
                    grid-template-columns: 1fr; /* Una columna en m√≥viles */
                }

                .analysis-grid {
                    grid-template-columns: 1fr; /* Una columna en m√≥viles */
                }

                .bands-grid {
                    grid-template-columns: 1fr; /* Una columna en m√≥viles */
                }
            }

            #network-map {
                height: calc(100% - 60px); /* Ajustado para responsive */
            }

            .map-header {
                padding: var(--space-4);
            }

            .map-controls {
                gap: var(--space-1);
            }

            .map-control-btn {
                padding: var(--space-1) var(--space-2);
                font-size: var(--font-size-xs);
            }
        }

        /* Dark Mode Map Enhancements */
        [data-theme="dark"] .leaflet-popup-content-wrapper {
            background: var(--color-neutral-100);
            color: var(--color-neutral-800);
        }

        [data-theme="dark"] .leaflet-popup-tip {
            background: var(--color-neutral-100);
        }

        [data-theme="dark"] .map-legend {
            background: var(--color-neutral-100);
            border-color: var(--color-neutral-300);
        }

        [data-theme="dark"] .legend-title {
            color: var(--color-neutral-800);
        }

        [data-theme="dark"] .custom-control {
            background: var(--color-neutral-100);
            border-color: var(--color-neutral-300);
        }

        [data-theme="dark"] .custom-control .map-control-btn {
            background: var(--color-neutral-100);
            color: var(--color-neutral-700);
        }

        [data-theme="dark"] .custom-control .map-control-btn:hover {
            background: var(--color-primary-100);
            color: var(--color-primary-800);
        }

        /* Microwave Link Specific Styles */
        .microwave-panel {
            background: var(--color-neutral-0);
            border-radius: var(--radius-2xl);
            padding: var(--space-6);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--color-neutral-200);
            margin-bottom: var(--space-6);
        }

        .microwave-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-4);
            padding-bottom: var(--space-4);
            border-bottom: 1px solid var(--color-neutral-200);
        }

        .microwave-title {
            font-size: var(--font-size-lg);
            font-weight: 700;
            color: var(--color-primary-800);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .microwave-status {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-full);
            font-size: var(--font-size-sm);
            font-weight: 600;
        }

        .microwave-status.excellent {
            background: var(--color-success);
            color: var(--color-neutral-0);
        }

        .microwave-status.good {
            background: var(--color-info);
            color: var(--color-neutral-0);
        }

        .microwave-status.fair {
            background: var(--color-warning);
            color: var(--color-neutral-0);
        }

        .microwave-status.poor {
            background: var(--color-error);
            color: var(--color-neutral-0);
        }

        /* Link Quality Metrics */
        .link-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-4);
            margin-bottom: var(--space-6);
        }

        .metric-card {
            background: var(--color-neutral-50);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            border: 1px solid var(--color-neutral-200);
            text-align: center;
        }

        .metric-value {
            font-size: var(--font-size-2xl);
            font-weight: 700;
            color: var(--color-primary-800);
            margin-bottom: var(--space-1);
        }

        .metric-label {
            font-size: var(--font-size-sm);
            color: var(--color-neutral-600);
            font-weight: 500;
        }

        .metric-unit {
            font-size: var(--font-size-xs);
            color: var(--color-neutral-500);
        }

        /* Spectrum Analysis */
        .spectrum-analyzer {
            background: var(--color-neutral-0);
            border-radius: var(--radius-2xl);
            padding: var(--space-6);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--color-neutral-200);
            margin-bottom: var(--space-6);
        }

        .spectrum-chart {
            height: 300px;
            margin-top: var(--space-4);
        }

        /* Weather Integration */
        .weather-panel {
            background: linear-gradient(135deg, var(--color-info-100), var(--color-info-50));
            border-radius: var(--radius-2xl);
            padding: var(--space-6);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--color-info-200);
            margin-bottom: var(--space-6);
        }

        .weather-header {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-bottom: var(--space-4);
        }

        .weather-icon {
            font-size: var(--font-size-2xl);
            color: var(--color-info-600);
        }

        .weather-data {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--space-4);
        }

        .weather-item {
            text-align: center;
            padding: var(--space-3);
            background: rgba(255, 255, 255, 0.7);
            border-radius: var(--radius-lg);
        }

        .weather-value {
            font-size: var(--font-size-lg);
            font-weight: 700;
            color: var(--color-info-800);
        }

        .weather-label {
            font-size: var(--font-size-sm);
            color: var(--color-info-600);
            margin-top: var(--space-1);
        }

        /* Compliance Tracking */
        .compliance-panel {
            background: var(--color-neutral-0);
            border-radius: var(--radius-2xl);
            padding: var(--space-6);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--color-neutral-200);
            margin-bottom: var(--space-6);
        }

        .compliance-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-3);
            background: var(--color-neutral-50);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-3);
        }

        .compliance-status {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .compliance-indicator {
            width: 12px;
            height: 12px;
            border-radius: var(--radius-full);
        }

        .compliance-indicator.compliant {
            background: var(--color-success);
        }

        .compliance-indicator.warning {
            background: var(--color-warning);
        }

        .compliance-indicator.non-compliant {
            background: var(--color-error);
        }

        /* Maintenance Scheduling */
        .maintenance-panel {
            background: var(--color-neutral-0);
            border-radius: var(--radius-2xl);
            padding: var(--space-6);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--color-neutral-200);
            margin-bottom: var(--space-6);
        }

        .maintenance-item {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3);
            background: var(--color-neutral-50);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-3);
            border-left: 4px solid var(--color-warning);
        }

        .maintenance-date {
            font-weight: 600;
            color: var(--color-warning-800);
        }

        .maintenance-description {
            flex: 1;
            color: var(--color-neutral-700);
        }

        .maintenance-priority {
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
            font-weight: 600;
            text-transform: uppercase;
        }

        .maintenance-priority.high {
            background: var(--color-error);
            color: var(--color-neutral-0);
        }

        .maintenance-priority.medium {
            background: var(--color-warning);
            color: var(--color-neutral-0);
        }

        .maintenance-priority.low {
            background: var(--color-info);
            color: var(--color-neutral-0);
        }

        /* Security Monitoring */
        .security-panel {
            background: var(--color-neutral-0);
            border-radius: var(--radius-2xl);
            padding: var(--space-6);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--color-neutral-200);
            margin-bottom: var(--space-6);
        }

        .security-alert {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3);
            background: var(--color-error-50);
            border: 1px solid var(--color-error-200);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-3);
        }

        .security-icon {
            color: var(--color-error-600);
            font-size: var(--font-size-lg);
        }

        .security-content {
            flex: 1;
        }

        .security-title {
            font-weight: 600;
            color: var(--color-error-800);
            margin-bottom: var(--space-1);
        }

        .security-description {
            font-size: var(--font-size-sm);
            color: var(--color-error-700);
        }

        /* Government Branding */
        .government-header {
            background: linear-gradient(135deg, #1e3a8a, #1e40af, #2563eb);
            color: var(--color-neutral-0);
            padding: var(--space-4);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-6);
            text-align: center;
        }

        .government-logo {
            font-size: var(--font-size-2xl);
            margin-bottom: var(--space-2);
        }

        .government-title {
            font-size: var(--font-size-xl);
            font-weight: 700;
            margin-bottom: var(--space-1);
        }

        .government-subtitle {
            font-size: var(--font-size-sm);
            opacity: 0.9;
        }

        /* Advanced Grid Layout */
        .advanced-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-6);
            margin-bottom: var(--space-6);
        }

        .full-width {
            grid-column: 1 / -1;
        }

        /* Responsive Adjustments */
        @media (max-width: 1200px) {
            .advanced-grid {
                grid-template-columns: 1fr;
            }
            
            .link-metrics {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .link-metrics {
                grid-template-columns: 1fr;
            }
            
            .weather-data {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Elevation Profile Styles */
        .elevation-profile-panel {
            background: var(--color-neutral-0);
            border-radius: var(--radius-2xl);
            padding: var(--space-6);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--color-neutral-200);
            margin-bottom: var(--space-6);
        }

        .elevation-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-4);
            padding-bottom: var(--space-4);
            border-bottom: 1px solid var(--color-neutral-200);
        }

        .elevation-title {
            font-size: var(--font-size-lg);
            font-weight: 700;
            color: var(--color-primary-800);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .elevation-controls {
            display: flex;
            gap: var(--space-2);
        }

        .elevation-btn {
            padding: var(--space-2) var(--space-3);
            background: var(--color-primary-600);
            color: var(--color-neutral-0);
            border: none;
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--duration-200) var(--ease-out);
        }

        .elevation-btn:hover {
            background: var(--color-primary-700);
        }

        .elevation-btn.active {
            background: var(--color-primary-800);
        }

        .elevation-chart-container {
            height: 400px;
            margin-bottom: var(--space-4);
            position: relative;
        }

        .elevation-chart {
            width: 100%;
            height: 100%;
            border-radius: var(--radius-lg);
            background: var(--color-neutral-50);
        }

        .elevation-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-4);
        }

        .elevation-metric {
            background: var(--color-neutral-50);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            text-align: center;
            border: 1px solid var(--color-neutral-200);
        }

        .elevation-metric-value {
            font-size: var(--font-size-xl);
            font-weight: 700;
            color: var(--color-primary-800);
            margin-bottom: var(--space-1);
        }

        .elevation-metric-label {
            font-size: var(--font-size-sm);
            color: var(--color-neutral-600);
            font-weight: 500;
        }

        .elevation-metric-unit {
            font-size: var(--font-size-xs);
            color: var(--color-neutral-500);
        }

        .link-selector {
            margin-bottom: var(--space-4);
        }

        .link-select {
            width: 100%;
            padding: var(--space-3);
            border: 1px solid var(--color-neutral-300);
            border-radius: var(--radius-lg);
            background: var(--color-neutral-0);
            font-size: var(--font-size-sm);
            color: var(--color-neutral-700);
        }

        .link-select:focus {
            outline: none;
            border-color: var(--color-primary-500);
            box-shadow: 0 0 0 3px var(--color-primary-100);
        }

        .elevation-legend {
            display: flex;
            align-items: center;
            gap: var(--space-4);
            margin-top: var(--space-4);
            padding: var(--space-3);
            background: var(--color-neutral-50);
            border-radius: var(--radius-lg);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: var(--radius-sm);
        }

        .legend-color.terrain {
            background: linear-gradient(45deg, #8b4513, #228b22);
        }

        .legend-color.line-of-sight {
            background: #3b82f6;
        }

        .legend-color.fresnel {
            background: rgba(59, 130, 246, 0.3);
        }

        .legend-label {
            font-size: var(--font-size-sm);
            color: var(--color-neutral-600);
            font-weight: 500;
        }

        /* Street View Styles */
        .street-view-panel {
            background: var(--color-neutral-0);
            border-radius: var(--radius-2xl);
            padding: var(--space-6);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--color-neutral-200);
            margin-bottom: var(--space-6);
            position: relative;
        }

        /* Estilos para el dise√±o moderno */
        .modern-link-display {
            animation: fadeInUp 0.6s ease-out;
        }

        .station-card {
            transition: all 0.3s ease;
        }

        .station-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 35px rgba(0,0,0,0.2) !important;
        }

        .station-card button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3) !important;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Efectos de glassmorphism */
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .street-view-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-4);
            padding-bottom: var(--space-4);
            border-bottom: 1px solid var(--color-neutral-200);
        }

        .street-view-title {
            font-size: var(--font-size-lg);
            font-weight: 700;
            color: var(--color-primary-800);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .street-view-controls {
            display: flex;
            gap: var(--space-2);
        }

        .street-view-btn {
            padding: var(--space-2) var(--space-3);
            background: var(--color-primary-600);
            color: var(--color-neutral-0);
            border: none;
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--duration-200) var(--ease-out);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .street-view-btn:hover {
            background: var(--color-primary-700);
        }

        .street-view-btn.active {
            background: var(--color-primary-800);
        }

        .street-view-container {
            height: 400px;
            border-radius: var(--radius-lg);
            overflow: hidden;
            position: relative;
            background: var(--color-neutral-100);
        }

        .google-street-view {
            width: 100%;
            height: 100%;
            position: relative;
        }

        /* Dual Street View Styles */


        .station-street-view {
            flex: 1;
            height: 100%;
            background: var(--color-neutral-50);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            border: 2px solid var(--color-primary-200);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .station-street-view:first-child {
            border-color: var(--color-success-400);
        }

        .station-street-view:last-child {
            border-color: var(--color-warning-400);
        }

        .station-header {
            padding: 12px 16px;
            background: linear-gradient(135deg, var(--color-primary-500), var(--color-primary-600));
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .station-street-view:first-child .station-header {
            background: linear-gradient(135deg, var(--color-success-500), var(--color-success-600));
        }

        .station-street-view:last-child .station-header {
            background: linear-gradient(135deg, var(--color-warning-500), var(--color-warning-600));
        }

        .station-title {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .station-title i {
            font-size: 1rem;
        }

        .station-coords {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            opacity: 0.9;
        }

        .station-coords i {
            font-size: 0.75rem;
        }

        .station-map {
            width: 100%;
            height: calc(100% - 60px);
            position: relative;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {

            
            .station-street-view {
                height: 50%;
            }
        }

        .street-view-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 15px;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .street-view-location {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .street-view-coordinates {
            font-size: 12px;
            opacity: 0.8;
        }

        .street-view-map {
            width: 100%;
            height: 100%;
        }

        .street-view-iframe {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: var(--radius-lg);
        }

        .street-view-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: var(--space-4);
            padding: var(--space-3);
            background: var(--color-neutral-50);
            border-radius: var(--radius-lg);
        }

        .street-view-location {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .street-view-coordinates {
            font-size: var(--font-size-sm);
            color: var(--color-neutral-600);
            font-family: 'Courier New', monospace;
        }

        .street-view-actions {
            display: flex;
            gap: var(--space-2);
        }

        .street-view-action-btn {
            padding: var(--space-2) var(--space-3);
            background: var(--color-neutral-200);
            color: var(--color-neutral-700);
            border: none;
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--duration-200) var(--ease-out);
        }

        .street-view-action-btn:hover {
            background: var(--color-neutral-300);
        }

        .street-view-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-3);
            color: var(--color-neutral-600);
        }

        .street-view-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--color-neutral-200);
            border-top: 3px solid var(--color-primary-600);
            border-radius: var(--radius-full);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .street-view-error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: var(--color-error-600);
            background: var(--color-error-50);
            padding: var(--space-4);
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-error-200);
        }

        .street-view-toggle {
            position: absolute;
            top: var(--space-4);
            right: var(--space-4);
            z-index: 1000;
            background: var(--color-neutral-0);
            border: 1px solid var(--color-neutral-300);
            border-radius: var(--radius-lg);
            padding: var(--space-2);
            box-shadow: var(--shadow-md);
            cursor: pointer;
            transition: all var(--duration-200) var(--ease-out);
        }

        .street-view-toggle:hover {
            background: var(--color-neutral-50);
            box-shadow: var(--shadow-lg);
        }

        .street-view-toggle.active {
            background: var(--color-primary-100);
            border-color: var(--color-primary-300);
        }

        .street-view-toggle i {
            color: var(--color-primary-600);
            font-size: var(--font-size-lg);
        }

        /* Alternative View Styles */
        .alternative-view-container {
            width: 100%;
            height: 100%;
            background: var(--color-neutral-50);
            border-radius: var(--radius-lg);
            overflow: hidden;
            position: relative;
        }

        .alternative-street-view,
        .alternative-satellite-view,
        .alternative-hybrid-view {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .street-view-header-info,
        .satellite-header-info,
        .hybrid-header-info {
            padding: var(--space-4);
            background: var(--color-primary-600);
            color: var(--color-neutral-0);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .location-badge {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-weight: 600;
            font-size: var(--font-size-lg);
        }

        .coordinates-info {
            font-size: var(--font-size-sm);
            opacity: 0.9;
            font-family: 'Courier New', monospace;
        }

        .street-view-content,
        .satellite-content,
        .hybrid-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: var(--space-4);
            gap: var(--space-4);
        }

        .panorama-placeholder,
        .satellite-placeholder,
        .hybrid-placeholder {
            flex: 1;
            background: linear-gradient(135deg, var(--color-primary-100), var(--color-primary-200));
            border-radius: var(--radius-lg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: var(--space-4);
            border: 2px dashed var(--color-primary-300);
        }

        .panorama-icon,
        .satellite-icon,
        .hybrid-icon {
            width: 80px;
            height: 80px;
            background: var(--color-primary-600);
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-neutral-0);
            font-size: 2rem;
        }

        .panorama-text,
        .satellite-text,
        .hybrid-text {
            text-align: center;
            color: var(--color-primary-800);
        }

        .panorama-text h3,
        .satellite-text h3,
        .hybrid-text h3 {
            margin: 0 0 var(--space-2) 0;
            font-size: var(--font-size-xl);
            font-weight: 700;
        }

        .panorama-text p,
        .satellite-text p,
        .hybrid-text p {
            margin: 0;
            font-size: var(--font-size-lg);
            opacity: 0.8;
        }

        .street-view-controls-panel,
        .satellite-info-panel,
        .hybrid-info-panel {
            background: var(--color-neutral-0);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            box-shadow: var(--shadow-sm);
        }

        .view-direction {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-3);
            margin-bottom: var(--space-4);
        }

        .direction-indicator {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2);
            background: var(--color-neutral-50);
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
            font-weight: 600;
            color: var(--color-neutral-700);
        }

        .direction-indicator i {
            color: var(--color-primary-600);
            font-size: var(--font-size-lg);
        }

        .street-info,
        .elevation-data,
        .terrain-analysis,
        .infrastructure-overlay,
        .link-analysis {
            display: grid;
            gap: var(--space-2);
        }

        .info-item,
        .elevation-item,
        .analysis-item,
        .overlay-item,
        .link-item {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2);
            background: var(--color-neutral-50);
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
            color: var(--color-neutral-700);
        }

        .info-item i,
        .elevation-item i,
        .analysis-item i,
        .overlay-item i,
        .link-item i {
            color: var(--color-primary-600);
            width: 16px;
            text-align: center;
        }

        .satellite-info-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-4);
        }

        .hybrid-info-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-4);
        }

        /* Interactive Panorama Styles */
        .street-view-panorama {
            width: 100%;
            height: 100%;
            position: relative;
            background: linear-gradient(to bottom, #87CEEB 0%, #98FB98 30%, #8FBC8F 100%);
            border-radius: var(--radius-lg);
            overflow: hidden;
            perspective: 1000px;
            display: flex;
            flex-direction: column;
        }

        .panorama-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 10;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: var(--space-3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: var(--font-size-sm);
        }

        .panorama-location {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .panorama-instructions {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            opacity: 0.8;
        }

        .interactive-panorama {
            flex: 1;
            position: relative;
            background: linear-gradient(to bottom, #87CEEB 0%, #98FB98 30%, #8FBC8F 100%);
            border-radius: var(--radius-lg);
            overflow: hidden;
            perspective: 1000px;
        }

        .panorama-viewport {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
            cursor: grab;
        }

        .panorama-scene {
            width: 200%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.1s ease-out;
        }

        .panorama-sky {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 60%;
            background: linear-gradient(to bottom, #87CEEB 0%, #B0E0E6 100%);
            z-index: 1;
        }

        .panorama-ground {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 40%;
            background: linear-gradient(to top, #8FBC8F 0%, #98FB98 100%);
            z-index: 2;
        }

        .panorama-buildings {
            position: absolute;
            bottom: 40%;
            left: 0;
            width: 100%;
            height: 60%;
            z-index: 3;
        }

        .building {
            position: absolute;
            bottom: 0;
            background: linear-gradient(to top, #696969 0%, #A9A9A9 100%);
            border-radius: 2px 2px 0 0;
            box-shadow: 2px 2px 8px rgba(0,0,0,0.3);
        }

        .building-1 {
            left: 10%;
            width: 8%;
            height: 45%;
        }

        .building-2 {
            left: 20%;
            width: 12%;
            height: 60%;
        }

        .building-3 {
            left: 35%;
            width: 10%;
            height: 35%;
        }

        .building-4 {
            left: 50%;
            width: 15%;
            height: 70%;
        }

        .building-5 {
            left: 70%;
            width: 8%;
            height: 50%;
        }

        .panorama-roads {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 15%;
            z-index: 4;
        }

        .road {
            position: absolute;
            bottom: 0;
            background: #2F2F2F;
        }

        .road-main {
            left: 0;
            width: 100%;
            height: 8%;
        }

        .road-side {
            left: 0;
            width: 100%;
            height: 3%;
            bottom: 8%;
            background: #696969;
        }

        .panorama-vehicles {
            position: absolute;
            bottom: 8%;
            left: 0;
            width: 100%;
            height: 7%;
            z-index: 5;
        }

        .vehicle {
            position: absolute;
            bottom: 0;
            width: 4%;
            height: 100%;
            background: #FF4500;
            border-radius: 2px;
            animation: vehicle-move 8s linear infinite;
        }

        .vehicle-1 {
            left: 20%;
            animation-delay: 0s;
        }

        .vehicle-2 {
            left: 60%;
            background: #4169E1;
            animation-delay: 4s;
        }

        @keyframes vehicle-move {
            0% { transform: translateX(-100px); }
            100% { transform: translateX(calc(100vw + 100px)); }
        }

        .panorama-infrastructure {
            position: absolute;
            bottom: 40%;
            left: 0;
            width: 100%;
            height: 60%;
            z-index: 6;
        }

        .tower {
            position: absolute;
            bottom: 0;
            width: 2%;
            height: 80%;
            background: linear-gradient(to top, #2F2F2F 0%, #696969 100%);
            border-radius: 1px;
        }

        .tower-1 {
            left: 25%;
        }

        .tower-2 {
            left: 75%;
        }

        .tower::after {
            content: '';
            position: absolute;
            top: -5%;
            left: 50%;
            transform: translateX(-50%);
            width: 4%;
            height: 10%;
            background: #FFD700;
            border-radius: 50%;
        }

        .panorama-controls {
            position: absolute;
            top: var(--space-4);
            right: var(--space-4);
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
            z-index: 10;
        }

        .panorama-compass {
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            box-shadow: var(--shadow-md);
        }

        .compass-needle {
            width: 2px;
            height: 20px;
            background: #FF0000;
            position: absolute;
            top: 50%;
            left: 50%;
            transform-origin: bottom center;
            transform: translate(-50%, -100%);
            border-radius: 1px;
        }

        .compass-needle::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-top: 8px solid #FF0000;
        }

        .compass-directions {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        .compass-n, .compass-e, .compass-s, .compass-w {
            position: absolute;
            font-size: 10px;
            font-weight: bold;
            color: var(--color-neutral-700);
        }

        .compass-n { top: 2px; left: 50%; transform: translateX(-50%); }
        .compass-e { right: 2px; top: 50%; transform: translateY(-50%); }
        .compass-s { bottom: 2px; left: 50%; transform: translateX(-50%); }
        .compass-w { left: 2px; top: 50%; transform: translateY(-50%); }

        .panorama-zoom {
            display: flex;
            flex-direction: column;
            gap: var(--space-1);
        }

        .zoom-btn {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: var(--radius-md);
            font-size: var(--font-size-lg);
            font-weight: bold;
            color: var(--color-primary-600);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-md);
            transition: all var(--duration-200) var(--ease-out);
        }

        .zoom-btn:hover {
            background: var(--color-primary-600);
            color: var(--color-neutral-0);
            transform: scale(1.1);
        }

        /* Street View Pegman Styles */
        .street-view-pegman {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 9999;
            cursor: grab;
            user-select: none;
            transition: all 0.2s ease;
            pointer-events: auto;
        }

        .street-view-pegman:hover {
            transform: scale(1.1);
        }

        .street-view-pegman.dragging {
            cursor: grabbing;
            transform: scale(1.2);
            z-index: 1001;
        }

        .pegman-icon {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            border: 2px solid #FFD700;
            transition: all 0.2s ease;
        }

        .street-view-pegman:hover .pegman-icon {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            border-color: #FFA500;
        }

        .pegman-tooltip {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 1002;
        }

        .pegman-tooltip::before {
            content: '';
            position: absolute;
            top: -6px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-bottom: 6px solid rgba(0, 0, 0, 0.8);
        }

        .street-view-pegman:hover .pegman-tooltip {
            opacity: 1;
        }

        .street-view-pegman.dragging .pegman-tooltip {
            opacity: 0;
        }

        .pegman-test-btn {
            position: absolute;
            top: 50px;
            left: 0;
            background: #FF4444;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            cursor: pointer;
            z-index: 10000;
        }

        .pegman-test-btn:hover {
            background: #FF6666;
        }

        .pegman-debug-btn {
            position: absolute;
            top: 70px;
            left: 0;
            background: #0066CC;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            cursor: pointer;
            z-index: 10000;
        }

        .pegman-debug-btn:hover {
            background: #0088FF;
        }

        /* Drop zone styles */
        .map-drop-zone {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 999;
            pointer-events: none;
            transition: all 0.3s ease;
        }

        .map-drop-zone.active {
            background: rgba(255, 215, 0, 0.1);
            border: 2px dashed #FFD700;
            pointer-events: all;
        }

        .map-drop-zone.active::after {
            content: 'Suelta aqu√≠ para ver Street View';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 215, 0, 0.9);
            color: #000;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .enterprise-layout {
                grid-template-areas: 
                    "header"
                    "main"
                    "sidebar"
                    "footer";
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .enterprise-layout {
                padding: var(--space-4);
                gap: var(--space-4);
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .header-content {
                flex-direction: column;
                gap: var(--space-4);
                text-align: center;
            }
        }

        /* Loading States */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .skeleton {
            background: linear-gradient(90deg, var(--color-neutral-200) 25%, var(--color-neutral-100) 50%, var(--color-neutral-200) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Dark Mode Support */
        [data-theme="dark"] {
            --color-neutral-0: hsl(0, 0%, 4%);
            --color-neutral-50: hsl(0, 0%, 9%);
            --color-neutral-100: hsl(0, 0%, 15%);
            --color-neutral-200: hsl(0, 0%, 25%);
            --color-neutral-300: hsl(0, 0%, 32%);
            --color-neutral-400: hsl(0, 0%, 45%);
            --color-neutral-500: hsl(0, 0%, 64%);
            --color-neutral-600: hsl(0, 0%, 82%);
            --color-neutral-700: hsl(0, 0%, 90%);
            --color-neutral-800: hsl(0, 0%, 96%);
            --color-neutral-900: hsl(0, 0%, 98%);
            --color-neutral-950: hsl(0, 0%, 100%);
        }

        /* Theme Toggle */
        .theme-toggle {
            position: fixed;
            top: var(--space-6);
            right: var(--space-6);
            z-index: var(--z-fixed);
            background: var(--color-neutral-0);
            border: 1px solid var(--color-neutral-200);
            border-radius: var(--radius-full);
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--duration-200) var(--ease-out);
            box-shadow: var(--shadow-lg);
        }

        .theme-toggle:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-xl);
        }

        /* Advanced Charts Container */
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-6);
            margin-bottom: var(--space-6);
        }

        .chart-container {
            background: var(--color-neutral-0);
            border-radius: var(--radius-2xl);
            padding: var(--space-6);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--color-neutral-200);
            position: relative;
            overflow: hidden;
        }

        .chart-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-4);
            padding-bottom: var(--space-4);
            border-bottom: 1px solid var(--color-neutral-200);
        }

        .chart-title {
            font-size: var(--font-size-lg);
            font-weight: 700;
            color: var(--color-primary-800);
        }

        .chart-controls {
            display: flex;
            gap: var(--space-2);
        }

        .chart-btn {
            padding: var(--space-2) var(--space-3);
            background: var(--color-neutral-100);
            border: 1px solid var(--color-neutral-200);
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
            cursor: pointer;
            transition: all var(--duration-200) var(--ease-out);
        }

        .chart-btn:hover {
            background: var(--color-primary-100);
            border-color: var(--color-primary-300);
        }

        .chart-btn.active {
            background: var(--color-primary-600);
            color: var(--color-neutral-0);
            border-color: var(--color-primary-600);
        }

        /* Alerts System */
        .alerts-container {
            position: fixed;
            top: var(--space-6);
            left: var(--space-6);
            z-index: var(--z-toast);
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
            max-width: 400px;
        }

        .alert {
            background: var(--color-neutral-0);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            box-shadow: var(--shadow-xl);
            border-left: 4px solid;
            display: flex;
            align-items: center;
            gap: var(--space-3);
            animation: slideInLeft 0.3s var(--ease-out);
            position: relative;
        }

        .alert.success {
            border-left-color: var(--color-success);
        }

        .alert.warning {
            border-left-color: var(--color-warning);
        }

        .alert.error {
            border-left-color: var(--color-error);
        }

        .alert.info {
            border-left-color: var(--color-info);
        }

        .alert-icon {
            width: 24px;
            height: 24px;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-neutral-0);
            font-size: var(--font-size-sm);
        }

        .alert.success .alert-icon {
            background: var(--color-success);
        }

        .alert.warning .alert-icon {
            background: var(--color-warning);
        }

        .alert.error .alert-icon {
            background: var(--color-error);
        }

        .alert.info .alert-icon {
            background: var(--color-info);
        }

        .alert-content {
            flex: 1;
        }

        .alert-title {
            font-weight: 600;
            margin-bottom: var(--space-1);
            color: var(--color-neutral-800);
        }

        .alert-message {
            font-size: var(--font-size-sm);
            color: var(--color-neutral-600);
        }

        .alert-close {
            background: none;
            border: none;
            color: var(--color-neutral-400);
            cursor: pointer;
            padding: var(--space-1);
            border-radius: var(--radius-sm);
            transition: all var(--duration-200) var(--ease-out);
        }

        .alert-close:hover {
            background: var(--color-neutral-100);
            color: var(--color-neutral-600);
        }

        @keyframes slideInLeft {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Advanced Filters */
        .advanced-filters {
            background: var(--color-neutral-0);
            border-radius: var(--radius-2xl);
            padding: var(--space-6);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--color-neutral-200);
            margin-bottom: var(--space-6);
        }

        .filter-search {
            position: relative;
            margin-bottom: var(--space-4);
        }

        .search-input {
            width: 100%;
            padding: var(--space-3) var(--space-4) var(--space-3) var(--space-12);
            border: 1px solid var(--color-neutral-200);
            border-radius: var(--radius-lg);
            font-size: var(--font-size-sm);
            background: var(--color-neutral-50);
            transition: all var(--duration-200) var(--ease-out);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--color-primary-500);
            background: var(--color-neutral-0);
            box-shadow: 0 0 0 3px var(--color-primary-100);
        }

        .search-icon {
            position: absolute;
            left: var(--space-4);
            top: 50%;
            transform: translateY(-50%);
            color: var(--color-neutral-400);
        }

        /* Export Controls */
        .export-controls {
            display: flex;
            gap: var(--space-3);
            margin-bottom: var(--space-4);
        }

        .export-btn {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-3) var(--space-4);
            background: var(--color-primary-600);
            color: var(--color-neutral-0);
            border: none;
            border-radius: var(--radius-lg);
            font-size: var(--font-size-sm);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--duration-200) var(--ease-out);
        }

        .export-btn:hover {
            background: var(--color-primary-700);
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .export-btn.secondary {
            background: var(--color-neutral-100);
            color: var(--color-neutral-700);
            border: 1px solid var(--color-neutral-200);
        }

        .export-btn.secondary:hover {
            background: var(--color-neutral-200);
        }

        /* Real-time Indicators */
        .realtime-indicator {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-3);
            background: var(--color-success);
            color: var(--color-neutral-0);
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .realtime-dot {
            width: 8px;
            height: 8px;
            background: var(--color-neutral-0);
            border-radius: var(--radius-full);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Advanced Animations */
        .fade-in {
            animation: fadeIn 0.6s var(--ease-out);
        }

        .slide-up {
            animation: slideUp 0.6s var(--ease-out);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Responsive Updates */
        @media (max-width: 1200px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .alerts-container {
                left: var(--space-4);
                right: var(--space-4);
                max-width: none;
            }
            
            .theme-toggle {
                top: var(--space-4);
                right: var(--space-4);
            }
        }
    </style>
</head>
<body>
    <div class="enterprise-layout">
        <!-- Theme Toggle -->
        <button class="theme-toggle" id="theme-toggle" aria-label="Toggle dark mode">
            <i class="fas fa-moon" id="theme-icon"></i>
        </button>

        <!-- Alerts Container -->
        <div class="alerts-container" id="alerts-container"></div>

        <!-- Header -->
        <header class="enterprise-header">
            <div class="header-content">
                <div class="header-brand">
                    <div class="brand-logo">
                        <img src="img/logo_empresa.png" alt="Logo Empresa" class="company-logo">
                    </div>
                    <div class="brand-text">
                        <h1 class="brand-title">Enlaces Sonora</h1>
                        <p class="brand-subtitle">Enterprise Network Management Platform</p>
                        <div class="realtime-indicator">
                            <div class="realtime-dot"></div>
                            Tiempo Real
                        </div>
                    </div>
                </div>
                <div class="header-actions">
                    <a href="/ptpFangio" class="nav-button">
                        <i class="fas fa-arrow-left"></i>
                        Volver a PTP Fangio
                    </a>
                </div>
            </div>
        </header>


        <!-- Main Content -->
        <main class="enterprise-main">
            <!-- Advanced Filters -->
            <div class="advanced-filters">
                <div class="filter-search">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="search-input" id="search-input" placeholder="Buscar nodos, ubicaciones, tipos...">
                </div>
                <div class="export-controls">
                    <button class="export-btn" id="export-pdf">
                        <i class="fas fa-file-pdf"></i>
                        Exportar PDF
                    </button>
                    <button class="export-btn secondary" id="export-excel">
                        <i class="fas fa-file-excel"></i>
                        Exportar Excel
                    </button>
                    <button class="export-btn secondary" id="refresh-data">
                        <i class="fas fa-sync-alt"></i>
                        Actualizar Datos
                    </button>
                </div>
            </div>

            

            <!-- Executive Dashboard -->
            

            <!-- Advanced Grid for Maintenance and Security -->
            
            <!-- Elevation Profile Panel -->
            <div class="elevation-profile-panel">
                <div class="elevation-header">
                    <div class="elevation-title">
                        <i class="fas fa-mountain"></i>
                        Perfil de Elevaci√≥n de Enlaces
                    </div>
                    <div class="elevation-controls">
                        <button class="elevation-btn active" data-view="profile">Perfil</button>
                        <button class="elevation-btn" data-view="analysis">An√°lisis</button>
                        <button class="elevation-btn" data-view="fresnel">Fresnel</button>
                    </div>
                </div>
                
                <div class="link-selector">
                    <select class="link-select" id="link-selector">
                        <option value="">Selecciona un enlace...</option>
                    </select>
                    <button onclick="poblarDropdownEnlaces()" style="
                        background: #10b981; 
                        color: white; 
                        border: none; 
                        padding: 8px 16px; 
                        border-radius: 6px; 
                        cursor: pointer; 
                        font-size: 12px; 
                        margin-left: 10px;
                    ">
                        üîÑ Actualizar Enlaces
                    </button>
                    <button onclick="mostrarInfoPerfil()" style="
                        background: #8b5cf6; 
                        color: white; 
                        border: none; 
                        padding: 8px 16px; 
                        border-radius: 6px; 
                        cursor: pointer; 
                        font-size: 12px; 
                        margin-left: 5px;
                    ">
                        üìä Info Perfil
                    </button>
                </div>

                <div class="elevation-chart-container">
                    <canvas id="elevation-chart" class="elevation-chart"></canvas>
                </div>

                <div class="elevation-info">
                    <div class="elevation-metric">
                        <div class="elevation-metric-value">45.2</div>
                        <div class="elevation-metric-label">Distancia</div>
                        <div class="elevation-metric-unit">km</div>
                    </div>
                    <div class="elevation-metric">
                        <div class="elevation-metric-value">1,250</div>
                        <div class="elevation-metric-label">Elevaci√≥n M√°xima</div>
                        <div class="elevation-metric-unit">msnm</div>
                    </div>
                    <div class="elevation-metric">
                        <div class="elevation-metric-value">35.5</div>
                        <div class="elevation-metric-label">Despeje M√≠nimo</div>
                        <div class="elevation-metric-unit">m</div>
                    </div>
                    <div class="elevation-metric">
                        <div class="elevation-metric-value">0</div>
                        <div class="elevation-metric-label">Obstrucciones</div>
                        <div class="elevation-metric-unit">puntos</div>
                    </div>
                </div>

                <div class="elevation-legend">
                    <div class="legend-item">
                        <div class="legend-color terrain"></div>
                        <span class="legend-label">Terreno</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color line-of-sight"></div>
                        <span class="legend-label">L√≠nea de Vista</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color fresnel"></div>
                        <span class="legend-label">Zona de Fresnel</span>
                    </div>
                </div>
            </div>

            <!-- Street View Panel -->
            <div class="street-view-panel">
                <div class="street-view-header">
                    <div class="street-view-title">
                        <i class="fas fa-map-marker-alt"></i>
                        Ubicaci√≥n de las Torres
                    </div>
                    <div class="street-view-controls">
                        <button class="street-view-btn" onclick="showTowerStreetView()" style="background: #dc2626; color: white; font-size: 18px; padding: 15px 30px; font-weight: bold; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                            üì° Ver las Dos Puntas del Enlace
                        </button>
                        <button onclick="if(window.mapManager) { window.mapManager.addMicrowaveLinks(); console.log('üîó Enlaces recargados manualmente'); console.log('‚úÖ Enlaces recargados exitosamente'); }" 
                                style="background: #10b981; color: white; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; font-size: 18px; font-weight: bold; box-shadow: 0 4px 8px rgba(0,0,0,0.2); margin-left: 10px;">
                            üîÑ Recargar Enlaces
                        </button>
                        <button onclick="if(window.mapManager) { window.mapManager.updateMarkers({}); console.log('üîÑ Mapa recargado completamente'); console.log('‚úÖ Mapa recargado exitosamente'); }" 
                                style="background: #3b82f6; color: white; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; font-size: 18px; font-weight: bold; box-shadow: 0 4px 8px rgba(0,0,0,0.2); margin-left: 10px;">
                            üó∫Ô∏è Recargar Mapa
                        </button>
                    </div>
                </div>

                <div class="street-view-container">
                    <div style="text-align: center; padding: 40px; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border-radius: 12px; border: 2px dashed #cbd5e1;">
                        <i class="fas fa-map-marker-alt" style="font-size: 48px; color: #64748b; margin-bottom: 20px;"></i>
                        <h3 style="color: #334155; margin-bottom: 10px;">Ubicaci√≥n de las Torres</h3>
                        <p style="color: #64748b; margin-bottom: 20px;">Haz clic en el bot√≥n de arriba para ver ambas estaciones del enlace de microondas</p>
                        <p style="color: #94a3b8; font-size: 14px;">Se mostrar√°n las dos torres con sus ubicaciones exactas</p>
                    </div>
                </div>

                <div class="street-view-info">
                    
                    <div class="street-view-actions">
                        <button class="street-view-action-btn" id="street-view-refresh">
                            <i class="fas fa-sync-alt"></i>
                            Actualizar
                        </button>
                        <button class="street-view-action-btn" id="street-view-fullscreen">
                            <i class="fas fa-expand"></i>
                            Pantalla Completa
                        </button>
                        <button class="street-view-action-btn" id="street-view-debug">
                            <i class="fas fa-bug"></i>
                            Debug
                        </button>
                    </div>
                </div>
            </div>

            <!-- Layout de dos columnas -->
            <div class="main-content-layout">
                <!-- Map Container -->
                <div class="map-container slide-up">
                <div class="map-header">
                    <div class="map-header-left">
                        <i class="fas fa-map-marked-alt"></i>
                        Visualizaci√≥n de Infraestructura de Red
                    </div>
                    <div class="map-controls">
                        <button class="map-control-btn" id="map-street-view">
                            <i class="fas fa-street-view"></i>
                        </button>
                        <button class="map-control-btn" id="map-fullscreen">
                            <i class="fas fa-expand"></i>
                        </button>
                        <button class="map-control-btn" id="map-refresh">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
                <div id="network-map"></div>
                
                <!-- Street View Pegman -->
                <div class="street-view-pegman" id="street-view-pegman" draggable="true">
                    <div class="pegman-icon">
                        <svg width="15" height="15" viewBox="0 0 24 24" fill="none">
                            <circle cx="12" cy="8" r="4" fill="#FFD700" stroke="#FFA500" stroke-width="2"/>
                            <path d="M6 20c0-3.314 2.686-6 6-6s6 2.686 6 6" fill="#FFD700" stroke="#FFA500" stroke-width="2"/>
                        </svg>
                    </div>
                    <div class="pegman-tooltip">
                        Haz click y arrastra el pegman al mapa para ver Street View
                    </div>
                    <button class="pegman-test-btn" onclick="testPegmanDrag()">Test</button>
                    <button class="pegman-debug-btn" onclick="debugPegman()">Debug</button>
                </div>
                
                <div class="map-legend">
                    <div class="legend-title">Leyenda del Mapa</div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #10b981;"></div>
                        <span>Nodos Activos</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #f59e0b;"></div>
                        <span>En Desarrollo</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ef4444;"></div>
                        <span>Inactivos</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-size"></div>
                        <span>Tama√±o = Importancia</span>
                    </div>
                </div>
            </div>

            <!-- Tabla de datos de enlace seleccionado -->
            <div class="data-table-container slide-up">
                <div class="data-table-header">
                    <i class="fas fa-database"></i>
                    Datos del Enlace Seleccionado
                </div>
                <div class="data-table-content" id="link-data-content">
                    <!-- Selector de enlaces -->
                    <div class="link-selector-section">
                        <div class="selector-header">
                            <h3>üìã Lista de Enlaces de Microondas</h3>
                            <p>Selecciona un enlace para ver sus datos detallados</p>
                        </div>
                        
                        <div class="link-search-container">
                            <input type="text" id="link-search" placeholder="üîç Buscar enlace por nombre..." class="link-search-input">
                        </div>
                        
                        <div class="links-list" id="links-list">
                            <!-- Los enlaces se cargar√°n din√°micamente -->
                        </div>
                    </div>
                    
                    <!-- √Årea de datos del enlace seleccionado -->
                    <div class="selected-link-data" id="selected-link-data" style="display: none;">
                        <!-- Los datos se mostrar√°n aqu√≠ cuando se seleccione un enlace -->
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer style="grid-area: footer; text-align: center; padding: var(--space-4); color: var(--color-neutral-500); font-size: var(--font-size-sm);">
            ¬© 2024 Fangio Telecom - Enterprise Network Management Platform
        </footer>
    </div>

    <!-- Enterprise JavaScript Application -->
    <script type="module">
        /**
         * Enterprise Network Management Platform
         * Advanced JavaScript with Professional Architecture
         * Features: Real-time data, Charts, Alerts, Export, Dark Mode, Advanced Filters
         */

        // Enhanced State Management with Real-time Updates
        class ApplicationState {
            static instance = null;
            state = {
                status: ['active', 'pending'],
                bands: ['15ghz', '8ghz', '80ghz'],
                regions: ['sonora', 'sinaloa', 'baja-california'],
                searchQuery: '',
                theme: 'light',
                lastUpdate: new Date(),
                realTimeEnabled: true
            };
            observers = [];
            realTimeInterval = null;

            constructor() {
                if (ApplicationState.instance) {
                    return ApplicationState.instance;
                }
                ApplicationState.instance = this;
                this.initializeRealTimeUpdates();
            }

            static getInstance() {
                if (!ApplicationState.instance) {
                    ApplicationState.instance = new ApplicationState();
                }
                return ApplicationState.instance;
            }

            getState() {
                return { ...this.state };
            }

            updateState(newState) {
                this.state = { ...this.state, ...newState };
                this.state.lastUpdate = new Date();
                this.notifyObservers();
            }

            subscribe(observer) {
                this.observers.push(observer);
            }

            notifyObservers() {
                this.observers.forEach(observer => observer(this.state));
            }

            initializeRealTimeUpdates() {
                if (this.state.realTimeEnabled) {
                    this.realTimeInterval = setInterval(() => {
                        this.simulateRealTimeUpdate();
                    }, 5000); // Update every 5 seconds
                }
            }

            simulateRealTimeUpdate() {
                // Simulate real-time data changes
                const randomNode = Math.floor(Math.random() * 6);
                const statuses = ['active', 'pending', 'inactive'];
                const newStatus = statuses[Math.floor(Math.random() * statuses.length)];
                
                // Trigger a minor state update to show real-time activity
                this.updateState({ lastUpdate: new Date() });
            }

            destroy() {
                if (this.realTimeInterval) {
                    clearInterval(this.realTimeInterval);
                }
            }
        }

        // Enhanced Network Data Service with Real-time Simulation
        class NetworkDataService {
            // Complete real microwave links data from Sonora database
            links = [
                // Cluster 1 - Villa Hidalgo area
                {
                    id: 'link_1',
                    cluster: 1,
                    stationA: { name: 'VILLA-HIDALGO', id: '2260677164E', lat: 30.1663611, lng: -109.32425, towerHeight: 42, ranHeight: 40, transport: 'Starlink', siteType: 'Adquisici√≥n' },
                    stationD: { name: 'CERRO-DEL-CARMEN', id: '2260327202E', lat: 30.017466, lng: -109.545748, towerHeight: 0, ranHeight: 35.5, transport: '', siteType: 'Adquisici√≥n' },
                    length: 27.06,
                    band: '8 GHz',
                    feasibility: 'NO',
                    reason: 'Cerro del Carmen torre aun no terminada, falta energ√≠a.'
                },
                {
                    id: 'link_2',
                    cluster: 1,
                    stationA: { name: 'CERRO-DEL-CARMEN', id: '2260327202E', lat: 30.017466, lng: -109.545748, towerHeight: 0, ranHeight: 35.5, transport: '', siteType: 'Adquisici√≥n' },
                    stationD: { name: 'HUASABAS', id: '2260321214E', lat: 29.90431, lng: -109.30196, towerHeight: 42, ranHeight: 40.5, transport: 'Starlink', siteType: 'Adquisici√≥n' },
                    length: 26.64,
                    band: '8 GHz',
                    feasibility: 'NO',
                    reason: 'Cerro del Carmen torre aun no terminada, falta energ√≠a.'
                },
                {
                    id: 'link_3',
                    cluster: 1,
                    stationA: { name: 'CERRO-DEL-CARMEN', id: '2260327202E', lat: 30.017466, lng: -109.545748, towerHeight: 0, ranHeight: 35.5, transport: '', siteType: 'Adquisici√≥n' },
                    stationD: { name: 'GRANADOS', id: '2260287163E', lat: 29.862711, lng: -109.314637, towerHeight: 42, ranHeight: 40, transport: 'Starlink', siteType: 'Adquisici√≥n' },
                    length: 28.5,
                    band: '8 GHz',
                    feasibility: 'NO',
                    reason: 'Cerro del Carmen torre aun no terminada, falta energ√≠a.'
                },
                {
                    id: 'link_4',
                    cluster: 1,
                    stationA: { name: 'CERRO-DEL-CARMEN', id: '2260327202E', lat: 30.017466, lng: -109.545748, towerHeight: 0, ranHeight: 35.5, transport: '', siteType: 'Adquisici√≥n' },
                    stationD: { name: 'MOCTEZUMA', id: '-', lat: 29.802124, lng: -109.680859, towerHeight: 0, ranHeight: 0, transport: '', siteType: 'Adquisici√≥n' },
                    length: 27.25,
                    band: '8 GHz',
                    feasibility: 'NO',
                    reason: 'Cerro del Carmen torre aun no terminada, falta energ√≠a.'
                },
                {
                    id: 'link_5',
                    cluster: 1,
                    stationA: { name: 'CERRO-DEL-CARMEN', id: '2260327202E', lat: 30.017466, lng: -109.545748, towerHeight: 0, ranHeight: 35.5, transport: '', siteType: 'Adquisici√≥n' },
                    stationD: { name: 'CUMPAS', id: '2260237165E', lat: 29.996425, lng: -109.77598, towerHeight: 42, ranHeight: 40, transport: 'Starlink', siteType: 'Adquisici√≥n' },
                    length: 22.96,
                    band: '8 GHz',
                    feasibility: 'NO',
                    reason: 'Cerro del Carmen torre aun no terminada, falta energ√≠a.'
                },
                // Cluster 2 - Huachinera area
                {
                    id: 'link_6',
                    cluster: 2,
                    stationA: { name: 'HUACHINERA', id: '2260310121R', lat: 30.206972, lng: -108.959694, towerHeight: 30, ranHeight: 24, transport: 'Satelite-OA', siteType: 'Arrendamiento' },
                    stationD: { name: 'CERRO-PUNTA-AGUJA', id: '-', lat: 30.105278, lng: -108.899361, towerHeight: 0, ranHeight: 0, transport: '', siteType: 'Estado' },
                    length: 0,
                    band: '',
                    feasibility: 'NO',
                    reason: 'Cerro Punta Aguja (Torre del Estado) - (No tenemos infraestructura de CFE)'
                },
                {
                    id: 'link_7',
                    cluster: 2,
                    stationA: { name: 'CERRO-PUNTA-AGUJA', id: '-', lat: 30.105278, lng: -108.899361, towerHeight: 0, ranHeight: 0, transport: '', siteType: 'Estado' },
                    stationD: { name: 'BACADEHUACHI', id: '2260083619E', lat: 29.80867, lng: -109.14261, towerHeight: 42, ranHeight: 40.5, transport: 'Starlink', siteType: 'Adquisici√≥n' },
                    length: 40.53,
                    band: '8 GHz',
                    feasibility: 'NO',
                    reason: 'Cerro Punta Aguja (Torre del Estado) - (No tenemos infraestructura de CFE)'
                },
                {
                    id: 'link_8',
                    cluster: 2,
                    stationA: { name: 'CERRO-PUNTA-AGUJA', id: '-', lat: 30.105278, lng: -108.899361, towerHeight: 0, ranHeight: 0, transport: '', siteType: 'Estado' },
                    stationD: { name: 'BACERAC', id: '2260100119R', lat: 30.36078, lng: -108.93182, towerHeight: 30, ranHeight: 24, transport: 'Satelite-OA', siteType: 'Arrendamiento' },
                    length: 28.53,
                    band: '8 GHz',
                    feasibility: 'NO',
                    reason: 'Cerro Punta Aguja (Torre del Estado) - (No tenemos infraestructura de CFE)'
                },
                {
                    id: 'link_9',
                    cluster: 2,
                    stationA: { name: 'BACERAC', id: '2260100119R', lat: 30.36078, lng: -108.93182, towerHeight: 30, ranHeight: 24, transport: 'Satelite-OA', siteType: 'Arrendamiento' },
                    stationD: { name: 'BAVISPE', id: '2260153674E', lat: 30.47913, lng: -108.94358, towerHeight: 42, ranHeight: 40, transport: 'Starlink', siteType: 'Adquisici√≥n' },
                    length: 0,
                    band: '',
                    feasibility: 'PENDIENTE',
                    reason: 'Las dos torres cuenta con tipo de transporte (Starlink - Satelital) - Posiblemente se podria instalar (sin uso de red)'
                },
                // Cluster 3 - Heroica Ciudad de Ures area
                {
                    id: 'link_10',
                    cluster: 3,
                    stationA: { name: 'HEROICA-CIUDAD-DE-URES', id: '2260666106E', lat: 29.42406, lng: -110.38735, towerHeight: 42, ranHeight: 40.53, transport: 'Starlink', siteType: 'Adquisici√≥n' },
                    stationD: { name: 'CERRO-ACONCHI', id: '-', lat: 29.818688, lng: -110.351886, towerHeight: 0, ranHeight: 0, transport: '', siteType: 'Estado' },
                    length: 43.55,
                    band: '8 GHz',
                    feasibility: 'NO',
                    reason: 'Cerro Aconchi (Torre del Estado) - (No tenemos infraestructura de CFE)'
                },
                {
                    id: 'link_11',
                    cluster: 3,
                    stationA: { name: 'CERRO-ACONCHI', id: '-', lat: 29.818688, lng: -110.351886, towerHeight: 0, ranHeight: 0, transport: '', siteType: 'Estado' },
                    stationD: { name: 'RAYON', id: '-', lat: 29.714677, lng: -110.5735, towerHeight: 0, ranHeight: 0, transport: '', siteType: 'Estado' },
                    length: 24.26,
                    band: '8 GHz',
                    feasibility: 'NO',
                    reason: 'Las dos torres son del Estado (No tenemos infraestructura de CFE)'
                },
                {
                    id: 'link_12',
                    cluster: 3,
                    stationA: { name: 'CERRO-ACONCHI', id: '-', lat: 29.818688, lng: -110.351886, towerHeight: 0, ranHeight: 0, transport: '', siteType: 'Estado' },
                    stationD: { name: 'CARBO', id: '-', lat: 29.68045, lng: -110.957931, towerHeight: 0, ranHeight: 0, transport: '', siteType: 'Estado' },
                    length: 60.44,
                    band: '8 GHz',
                    feasibility: 'NO',
                    reason: 'Las dos torres son del Estado (No tenemos infraestructura de CFE)'
                },
                {
                    id: 'link_13',
                    cluster: 3,
                    stationA: { name: 'CERRO-ACONCHI', id: '-', lat: 29.818688, lng: -110.351886, towerHeight: 0, ranHeight: 0, transport: '', siteType: 'Estado' },
                    stationD: { name: 'OPODEPE', id: '2260450137R', lat: 29.925443, lng: -110.625861, towerHeight: 25, ranHeight: 24, transport: 'Satelite-OA', siteType: 'Arrendamiento' },
                    length: 28.94,
                    band: '8 GHz',
                    feasibility: 'NO',
                    reason: 'Cerro Aconchi (Torre del Estado) - (No tenemos infraestructura de CFE)'
                },
                // Cluster 4 - Heroica Ciudad de Ures area (continued)
                {
                    id: 'link_14',
                    cluster: 4,
                    stationA: { name: 'HEROICA-CIUDAD-DE-URES', id: '2260666106E', lat: 29.42406, lng: -110.38735, towerHeight: 42, ranHeight: 40.53, transport: 'Starlink', siteType: 'Adquisici√≥n' },
                    stationD: { name: 'CERRO-MAZATAN', id: '-', lat: 29.093917, lng: -110.175583, towerHeight: 0, ranHeight: 0, transport: '', siteType: 'Estado' },
                    length: 42.54,
                    band: '8 GHz',
                    feasibility: 'NO',
                    reason: 'Cerro Mazatan (Torre del Estado) - (No tenemos infraestructura de CFE)'
                },
                {
                    id: 'link_15',
                    cluster: 4,
                    stationA: { name: 'CERRO-MAZATAN', id: '-', lat: 29.093917, lng: -110.175583, towerHeight: 0, ranHeight: 0, transport: '', siteType: 'Estado' },
                    stationD: { name: 'VILLA-PESQUEIRA-MATAPE-CM', id: '2260687239P', lat: 29.118301, lng: -109.969077, towerHeight: 15.3, ranHeight: 15, transport: 'Starlink', siteType: 'Adquisici√≥n' },
                    length: 20.25,
                    band: '8 GHz',
                    feasibility: 'NO',
                    reason: 'Cerro Mazatan (Torre del Estado) - (No tenemos infraestructura de CFE)'
                },
                {
                    id: 'link_16',
                    cluster: 4,
                    stationA: { name: 'CERRO-MAZATAN', id: '-', lat: 29.093917, lng: -110.175583, towerHeight: 0, ranHeight: 0, transport: '', siteType: 'Estado' },
                    stationD: { name: 'MAZATAN', id: '2260376104E', lat: 29.00672, lng: -110.13476, towerHeight: 42, ranHeight: 42, transport: 'Starlink', siteType: 'Adquisici√≥n' },
                    length: 0,
                    band: '',
                    feasibility: 'NO',
                    reason: 'Cerro Mazatan (Torre del Estado) - (No tenemos infraestructura de CFE)'
                },
                // Cluster 5 - Baviacora area
                {
                    id: 'link_17',
                    cluster: 5,
                    stationA: { name: 'BAVIACORA', id: '-', lat: 29.71538, lng: -110.165031, towerHeight: 0, ranHeight: 0, transport: '', siteType: 'Estado' },
                    stationD: { name: 'MIRADOR-SAN-FELIPE-DE-JESUS', id: '2260537228P', lat: 29.86259, lng: -110.239133, towerHeight: 0, ranHeight: 15, transport: 'Starlink', siteType: 'Adquisici√≥n' },
                    length: 17.62,
                    band: '8 GHz',
                    feasibility: 'NO',
                    reason: 'Baviacora (Torre del Estado) - (No tenemos infraestructura de CFE) y Mirador San Felipe de Jesus Torre de 15 metros (NLOS)'
                },
                {
                    id: 'link_18',
                    cluster: 5,
                    stationA: { name: 'MIRADOR-SAN-FELIPE-DE-JESUS', id: '2260537228P', lat: 29.86259, lng: -110.239133, towerHeight: 0, ranHeight: 15, transport: 'Starlink', siteType: 'Adquisici√≥n' },
                    stationD: { name: 'ACONCHI', id: '-', lat: 29.825905, lng: -110.228661, towerHeight: 0, ranHeight: 0, transport: '', siteType: 'Estado' },
                    length: 0,
                    band: '',
                    feasibility: 'NO',
                    reason: 'Baviacora (Torre del Estado) - (No tenemos infraestructura de CFE) y Mirador San Felipe de Jesus Torre de 15 metros (NLOS)'
                },
                {
                    id: 'link_19',
                    cluster: 5,
                    stationA: { name: 'MIRADOR-SAN-FELIPE-DE-JESUS', id: '2260537228P', lat: 29.86259, lng: -110.239133, towerHeight: 0, ranHeight: 15, transport: 'Starlink', siteType: 'Adquisici√≥n' },
                    stationD: { name: 'HUEPAC', id: '-', lat: 29.911183, lng: -110.213615, towerHeight: 0, ranHeight: 0, transport: '', siteType: 'Estado' },
                    length: 0,
                    band: '',
                    feasibility: 'NO',
                    reason: 'Baviacora (Torre del Estado) - (No tenemos infraestructura de CFE) y Mirador San Felipe de Jesus Torre de 15 metros (NLOS)'
                },
                {
                    id: 'link_20',
                    cluster: 5,
                    stationA: { name: 'HUEPAC', id: '-', lat: 29.911183, lng: -110.213615, towerHeight: 0, ranHeight: 0, transport: '', siteType: 'Estado' },
                    stationD: { name: 'BANAMICHI', id: '-', lat: 30.007027, lng: -110.21803, towerHeight: 0, ranHeight: 0, transport: '', siteType: 'Estado' },
                    length: 0,
                    band: '',
                    feasibility: 'NO',
                    reason: 'Las dos torres son del Estado (No tenemos infraestructura de CFE)'
                },
                // Cluster 6 - Universidad Sonora area
                {
                    id: 'link_21',
                    cluster: 6,
                    stationA: { name: 'UNIVERSIDAD-SONORA', id: '-', lat: 27.074257, lng: -109.429382, towerHeight: 0, ranHeight: 0, transport: '', siteType: 'Estado' },
                    stationD: { name: 'CERRO-MOYAHUI', id: '-', lat: 27.545293, lng: -109.231119, towerHeight: 0, ranHeight: 0, transport: '', siteType: 'Estado' },
                    length: 55.91,
                    band: '8 GHz',
                    feasibility: 'NO',
                    reason: 'Las dos torres son del Estado (No tenemos infraestructura de CFE)'
                },
                {
                    id: 'link_22',
                    cluster: 6,
                    stationA: { name: 'CERRO-MOYAHUI', id: '-', lat: 27.545293, lng: -109.231119, towerHeight: 0, ranHeight: 0, transport: '', siteType: 'Estado' },
                    stationD: { name: 'CERRO-ROSARIO', id: '-', lat: 27.850975, lng: -109.365897, towerHeight: 0, ranHeight: 0, transport: '', siteType: 'Estado' },
                    length: 36.49,
                    band: '8 GHz',
                    feasibility: 'NO',
                    reason: 'Las dos torres son del Estado (No tenemos infraestructura de CFE)'
                },
                {
                    id: 'link_23',
                    cluster: 6,
                    stationA: { name: 'CERRO-MOYAHUI', id: '-', lat: 27.545293, lng: -109.231119, towerHeight: 0, ranHeight: 0, transport: '', siteType: 'Estado' },
                    stationD: { name: 'QUIRIEGO-(CM)', id: '2260497305E', lat: 27.52065, lng: -109.251129, towerHeight: 42, ranHeight: 40, transport: 'Starlink', siteType: 'Adquisici√≥n' },
                    length: 0,
                    band: '',
                    feasibility: 'NO',
                    reason: 'Cerro Moyahui (Torre del estado) - (No tenemos infraestructura de CFE)'
                },
                {
                    id: 'link_24',
                    cluster: 6,
                    stationA: { name: 'CERRO-ROSARIO', id: '-', lat: 27.850975, lng: -109.365897, towerHeight: 0, ranHeight: 0, transport: '', siteType: 'Estado' },
                    stationD: { name: 'ROSARIO', id: '-', lat: 27.840585, lng: -109.370693, towerHeight: 0, ranHeight: 0, transport: '', siteType: 'Estado' },
                    length: 0,
                    band: '',
                    feasibility: 'NO',
                    reason: 'Las dos torres son del Estado (No tenemos infraestructura de CFE)'
                }
            ];
            
            nodes = [
                {
                    id: 'node-001',
                    name: 'VILLA-HIDALGO',
                    coordinates: [30.1663611, -109.32425],
                    status: 'active',
                    band: '8ghz',
                    type: 'Estaci√≥n de Microondas',
                    region: 'sonora',
                    performance: 98.5,
                    lastUpdate: new Date(),
                    alerts: [],
                    towerHeight: 42,
                    ranHeight: 40,
                    transport: 'Starlink',
                    siteType: 'Adquisici√≥n',
                    cluster: 1
                },
                {
                    id: 'node-002',
                    name: 'CERRO-DEL-CARMEN',
                    coordinates: [30.017466, -109.045740],
                    status: 'pending',
                    band: '6ghz',
                    type: 'Estaci√≥n de Microondas',
                    region: 'sonora',
                    performance: 0,
                    lastUpdate: new Date(),
                    alerts: ['Torre no terminada, falta energ√≠a'],
                    towerHeight: 42,
                    ranHeight: 30.5,
                    transport: 'Starlink',
                    siteType: 'Adquisici√≥n'
                },
                {
                    id: 'node-003',
                    name: 'HUACHINERA',
                    coordinates: [30.1167, -108.9500],
                    status: 'active',
                    band: '6ghz',
                    type: 'Estaci√≥n de Microondas',
                    region: 'sonora',
                    performance: 95.3,
                    lastUpdate: new Date(),
                    alerts: [],
                    towerHeight: 42,
                    ranHeight: 30.5,
                    transport: 'Starlink',
                    siteType: 'Adquisici√≥n'
                },
                {
                    id: 'node-004',
                    name: 'GRANADOS',
                    coordinates: [29.8667, -109.3167],
                    status: 'active',
                    band: '6ghz',
                    type: 'Estaci√≥n de Microondas',
                    region: 'sonora',
                    performance: 97.1,
                    lastUpdate: new Date(),
                    alerts: [],
                    towerHeight: 42,
                    ranHeight: 30.5,
                    transport: 'Starlink',
                    siteType: 'Adquisici√≥n'
                },
                {
                    id: 'node-005',
                    name: 'HERMOSILLO',
                    coordinates: [29.0729, -110.9559],
                    status: 'active',
                    band: '15ghz',
                    type: 'Nodo Principal',
                    region: 'sonora',
                    performance: 96.8,
                    lastUpdate: new Date(),
                    alerts: []
                },
                {
                    id: 'node-006',
                    name: 'CULIACAN',
                    coordinates: [24.8069, -107.3938],
                    status: 'pending',
                    band: '8ghz',
                    type: 'Nodo Regional',
                    region: 'sinaloa',
                    performance: 78.5,
                    lastUpdate: new Date(),
                    alerts: ['Mantenimiento programado']
                }
            ];

            getNodes() {
                return [...this.nodes];
            }

            getFilteredNodes(filters) {
                let filtered = this.nodes.filter(node => 
                    filters.status.includes(node.status) &&
                    filters.bands.includes(node.band) &&
                    filters.regions.includes(node.region)
                );

                // Apply search filter
                if (filters.searchQuery) {
                    const query = filters.searchQuery.toLowerCase();
                    filtered = filtered.filter(node => 
                        node.name.toLowerCase().includes(query) ||
                        node.type.toLowerCase().includes(query) ||
                        node.region.toLowerCase().includes(query)
                    );
                }

                return filtered;
            }

            getStatistics() {
                const total = this.nodes.length;
                const active = this.nodes.filter(n => n.status === 'active').length;
                const pending = this.nodes.filter(n => n.status === 'pending').length;
                const critical = this.nodes.filter(n => n.type.includes('Principal')).length;
                const avgPerformance = this.nodes.reduce((sum, n) => sum + n.performance, 0) / total;

                return { total, active, pending, critical, avgPerformance: avgPerformance.toFixed(1) };
            }

            getPerformanceData(period = '24h') {
                const now = new Date();
                const data = [];
                
                for (let i = 0; i < 24; i++) {
                    const time = new Date(now.getTime() - (23 - i) * 60 * 60 * 1000);
                    const performance = 85 + Math.random() * 15; // Simulate performance data
                    data.push({
                        time: time.toISOString(),
                        performance: performance.toFixed(1)
                    });
                }
                
                return data;
            }

            getRegionDistribution() {
                const regions = {};
                this.nodes.forEach(node => {
                    regions[node.region] = (regions[node.region] || 0) + 1;
                });
                return Object.entries(regions).map(([region, count]) => ({
                    region: region.charAt(0).toUpperCase() + region.slice(1),
                    count
                }));
            }
            
            // Microwave links specific methods
            getMicrowaveLinks() {
                return this.links;
            }
            
            getFeasibleLinks() {
                return this.links.filter(link => link.feasibility === 'PENDIENTE');
            }
            
            getNonFeasibleLinks() {
                return this.links.filter(link => link.feasibility === 'NO');
            }
            
            getLinksByBand(band) {
                return this.links.filter(link => link.band === band);
            }
            
            getLinksByTransport(transport) {
                return this.links.filter(link => 
                    link.stationA.transport === transport || link.stationD.transport === transport
                );
            }
            
            getStationById(id) {
                return this.nodes.find(node => node.id === id);
            }
            
            getLinksByStation(stationName) {
                return this.links.filter(link => 
                    link.stationA.name === stationName || link.stationD.name === stationName
                );
            }
            
            getLinkStatistics() {
                const total = this.links.length;
                const feasible = this.getFeasibleLinks().length;
                const nonFeasible = this.getNonFeasibleLinks().length;
                
                return {
                    total,
                    feasible,
                    nonFeasible,
                    feasibilityRate: ((feasible / total) * 100).toFixed(1)
                };
            }
            
            // Cluster management methods
            getClusters() {
                const clusters = {};
                this.links.forEach(link => {
                    if (!clusters[link.cluster]) {
                        clusters[link.cluster] = {
                            id: link.cluster,
                            links: [],
                            stations: new Set()
                        };
                    }
                    clusters[link.cluster].links.push(link);
                    clusters[link.cluster].stations.add(link.stationA.name);
                    clusters[link.cluster].stations.add(link.stationD.name);
                });
                
                return Object.values(clusters).map(cluster => ({
                    ...cluster,
                    stations: Array.from(cluster.stations),
                    stationCount: cluster.stations.size,
                    linkCount: cluster.links.length
                }));
            }
            
            getLinksByCluster(clusterId) {
                return this.links.filter(link => link.cluster === clusterId);
            }
            
            getStationsByCluster(clusterId) {
                return this.nodes.filter(node => node.cluster === clusterId);
            }
            
            getClusterStatistics() {
                const clusters = this.getClusters();
                return clusters.map(cluster => ({
                    ...cluster,
                    feasibleLinks: cluster.links.filter(link => link.feasibility === 'PENDIENTE').length,
                    nonFeasibleLinks: cluster.links.filter(link => link.feasibility === 'NO').length,
                    feasibilityRate: ((cluster.links.filter(link => link.feasibility === 'PENDIENTE').length / cluster.links.length) * 100).toFixed(1)
                }));
            }
        }

        // Advanced Alert System
        class AlertManager {
            container = null;
            alerts = [];

            constructor(containerId) {
                this.container = document.getElementById(containerId);
            }

            showAlert(type, title, message, duration = 5000) {
                const alert = {
                    id: Date.now(),
                    type,
                    title,
                    message,
                    timestamp: new Date()
                };

                this.alerts.push(alert);
                this.renderAlert(alert);

                if (duration > 0) {
                    setTimeout(() => this.removeAlert(alert.id), duration);
                }
            }

            renderAlert(alert) {
                const alertElement = document.createElement('div');
                alertElement.className = `alert ${alert.type}`;
                alertElement.setAttribute('data-alert-id', alert.id);

                const iconMap = {
                    success: 'fas fa-check',
                    warning: 'fas fa-exclamation-triangle',
                    error: 'fas fa-times',
                    info: 'fas fa-info'
                };

                alertElement.innerHTML = `
                    <div class="alert-icon">
                        <i class="${iconMap[alert.type]}"></i>
                    </div>
                    <div class="alert-content">
                        <div class="alert-title">${alert.title}</div>
                        <div class="alert-message">${alert.message}</div>
                    </div>
                    <button class="alert-close" onclick="this.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                `;

                this.container.appendChild(alertElement);
            }

            removeAlert(alertId) {
                const alertElement = this.container.querySelector(`[data-alert-id="${alertId}"]`);
                if (alertElement) {
                    alertElement.remove();
                }
                this.alerts = this.alerts.filter(alert => alert.id !== alertId);
            }

            clearAll() {
                this.container.innerHTML = '';
                this.alerts = [];
            }
        }

        // Advanced Chart Manager with Plotly
        class ChartManager {
            performanceChart = null;
            regionChart = null;
            dataService = null;

            constructor(dataService) {
                this.dataService = dataService;
                this.initializeCharts();
            }

            initializeCharts() {
                this.createPerformanceChart();
                this.createRegionChart();
                this.setupChartControls();
            }

            createPerformanceChart() {
                const data = this.dataService.getPerformanceData();
                
                const trace = {
                    x: data.map(d => moment(d.time).format('HH:mm')),
                    y: data.map(d => parseFloat(d.performance)),
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Rendimiento (%)',
                    line: {
                        color: '#3b82f6',
                        width: 3
                    },
                    marker: {
                        color: '#3b82f6',
                        size: 6
                    }
                };

                const layout = {
                    title: '',
                    xaxis: {
                        title: 'Hora',
                        gridcolor: '#e5e7eb'
                    },
                    yaxis: {
                        title: 'Rendimiento (%)',
                        range: [0, 100],
                        gridcolor: '#e5e7eb'
                    },
                    plot_bgcolor: 'transparent',
                    paper_bgcolor: 'transparent',
                    font: {
                        family: 'Inter, sans-serif',
                        size: 12
                    },
                    margin: { t: 0, r: 0, b: 40, l: 40 }
                };

                // Plotly.newPlot('performance-chart', [trace], layout, {responsive: true});
            }

            createRegionChart() {
                const data = this.dataService.getRegionDistribution();
                
                const trace = {
                    labels: data.map(d => d.region),
                    values: data.map(d => d.count),
                    type: 'pie',
                    marker: {
                        colors: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6']
                    },
                    textinfo: 'label+percent',
                    textposition: 'outside'
                };

                const layout = {
                    title: '',
                    plot_bgcolor: 'transparent',
                    paper_bgcolor: 'transparent',
                    font: {
                        family: 'Inter, sans-serif',
                        size: 12
                    },
                    margin: { t: 0, r: 0, b: 0, l: 0 },
                    showlegend: false
                };

                // Plotly.newPlot('region-chart', [trace], layout, {responsive: true});
            }

            setupChartControls() {
                // Performance chart period controls
                // Performance chart controls temporarily disabled
                /*
                document.querySelectorAll('#performance-chart').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        if (e.target.classList.contains('chart-btn')) {
                            document.querySelectorAll('#performance-chart .chart-btn').forEach(b => b.classList.remove('active'));
                            e.target.classList.add('active');
                            this.updatePerformanceChart(e.target.dataset.period);
                        }
                    });
                });
                */

                // Region chart type controls - temporarily disabled
                /*
                document.querySelectorAll('#region-chart').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        if (e.target.classList.contains('chart-btn')) {
                            document.querySelectorAll('#region-chart .chart-btn').forEach(b => b.classList.remove('active'));
                            e.target.classList.add('active');
                            this.updateRegionChart(e.target.dataset.type);
                        }
                    });
                });
                */
            }

            updatePerformanceChart(period) {
                // Temporarily disabled
                /*
                const data = this.dataService.getPerformanceData(period);
                const update = {
                    x: [data.map(d => moment(d.time).format('HH:mm'))],
                    y: [data.map(d => parseFloat(d.performance))]
                };
                Plotly.restyle('performance-chart', update);
                */
            }

            updateRegionChart(type) {
                const data = this.dataService.getRegionDistribution();
                
                if (type === 'bar') {
                    const trace = {
                        x: data.map(d => d.region),
                        y: data.map(d => d.count),
                        type: 'bar',
                        marker: {
                            color: '#3b82f6'
                        }
                    };
                    // Plotly.newPlot('region-chart', [trace], {
                    //     title: '',
                    //     plot_bgcolor: 'transparent',
                    //     paper_bgcolor: 'transparent',
                    //     font: { family: 'Inter, sans-serif', size: 12 },
                    //     margin: { t: 0, r: 0, b: 40, l: 40 },
                    //     showlegend: false
                    // }, {responsive: true});
                } else {
                    this.createRegionChart();
                }
            }
        }

        // Export Manager for PDF and Excel
        class ExportManager {
            dataService = null;

            constructor(dataService) {
                this.dataService = dataService;
                this.setupExportControls();
            }

            setupExportControls() {
                document.getElementById('export-pdf').addEventListener('click', () => this.exportToPDF());
                document.getElementById('export-excel').addEventListener('click', () => this.exportToExcel());
            }

            exportToPDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Add title
                doc.setFontSize(20);
                doc.text('Reporte de Infraestructura - Enlaces Sonora', 20, 20);
                
                // Add date
                doc.setFontSize(12);
                doc.text(`Generado el: ${moment().format('DD/MM/YYYY HH:mm')}`, 20, 30);
                
                // Add statistics
              
                // Add nodes table
                doc.setFontSize(14);
                doc.text('Detalle de Nodos:', 20, 120);
                
                const nodes = this.dataService.getNodes();
                let y = 130;
                doc.setFontSize(10);
                
                nodes.forEach((node, index) => {
                    if (y > 280) {
                        doc.addPage();
                        y = 20;
                    }
                    doc.text(`${index + 1}. ${node.name} - ${node.type} (${node.status})`, 20, y);
                    y += 10;
                });
                
                doc.save(`reporte-enlaces-sonora-${moment().format('YYYY-MM-DD')}.pdf`);
            }

            exportToExcel() {
                const nodes = this.dataService.getNodes();
                const stats = this.dataService.getStatistics();
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                
                // Nodes sheet
                const nodesData = nodes.map(node => ({
                    'Nombre': node.name,
                    'Estado': node.status,
                    'Banda': node.band,
                    'Tipo': node.type,
                    'Regi√≥n': node.region,
                    'Rendimiento (%)': node.performance,
                    '√öltima Actualizaci√≥n': moment(node.lastUpdate).format('DD/MM/YYYY HH:mm')
                }));
                
                const nodesSheet = XLSX.utils.json_to_sheet(nodesData);
                XLSX.utils.book_append_sheet(wb, nodesSheet, 'Nodos');
                
                // Statistics sheet
                const statsData = [
                    ['M√©trica', 'Valor'],
                    ['Infraestructura Total', stats.total],
                    ['Enlaces Activos', stats.active],
                    ['Proyectos en Curso', stats.pending],
                    ['Nodos Cr√≠ticos', stats.critical],
                    ['Rendimiento Promedio (%)', stats.avgPerformance]
                ];
                
                const statsSheet = XLSX.utils.aoa_to_sheet(statsData);
                XLSX.utils.book_append_sheet(wb, statsSheet, 'Estad√≠sticas');
                
                XLSX.writeFile(wb, `reporte-enlaces-sonora-${moment().format('YYYY-MM-DD')}.xlsx`);
            }
        }

        // Professional Map Manager with Advanced Features
        class MapManager {
            map = null;
            markers = new Map();
            links = new Map();
            markerCluster = null;
            dataService = null;
            baseLayers = {};
            overlayLayers = {};

            constructor(containerId, dataService) {
                this.dataService = dataService;
                this.initializeMap(containerId);
                this.setupMapControls();
            }

            initializeMap(containerId) {
                // Show loading state
                this.showLoadingState(containerId);

                // Initialize map with better view
                this.map = L.map(containerId, {
                    center: [25.2048, -105.5997],
                    zoom: 7,
                    zoomControl: false,
                    attributionControl: false
                });

                // Add multiple tile layers for better visibility
                this.baseLayers = {
                    'OpenStreetMap': L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© OpenStreetMap contributors',
                        maxZoom: 18
                    }),
                    'Satellite': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                        attribution: '¬© Esri',
                        maxZoom: 18
                    }),
                    'Terrain': L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© OpenTopoMap',
                        maxZoom: 17
                    })
                };

                // Add default layer
                this.baseLayers['OpenStreetMap'].addTo(this.map);

                // Initialize marker cluster
                this.markerCluster = L.markerClusterGroup({
                    chunkedLoading: true,
                    maxClusterRadius: 50,
                    iconCreateFunction: this.createClusterIcon
                });

                this.map.addLayer(this.markerCluster);

                // Add custom controls
                this.addCustomControls();
                this.addLayerControl();

                // Hide loading state
                setTimeout(() => this.hideLoadingState(containerId), 1000);
            }

            showLoadingState(containerId) {
                const mapElement = document.getElementById(containerId);
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'map-loading';
                loadingDiv.innerHTML = '<div class="map-loading-spinner"></div>';
                mapElement.appendChild(loadingDiv);
            }

            hideLoadingState(containerId) {
                const mapElement = document.getElementById(containerId);
                const loadingDiv = mapElement.querySelector('.map-loading');
                if (loadingDiv) {
                    loadingDiv.remove();
                }
            }

            createClusterIcon(cluster) {
                const count = cluster.getChildCount();
                const size = count < 10 ? 'small' : count < 100 ? 'medium' : 'large';
                
                return L.divIcon({
                    html: `<div class="cluster-icon cluster-${size}">${count}</div>`,
                    className: 'custom-cluster',
                    iconSize: L.point(40, 40)
                });
            }

            addCustomControls() {
                // Home button
                const homeControl = L.control({ position: 'topright' });
                homeControl.onAdd = () => {
                    const div = L.DomUtil.create('div', 'custom-control');
                    div.innerHTML = `
                        <button class="map-control-btn" title="Centrar mapa">
                            <i class="fas fa-home"></i>
                        </button>
                    `;
                    div.onclick = () => this.map.setView([25.2048, -105.5997], 7);
                    return div;
                };
                homeControl.addTo(this.map);

                // Zoom controls
                L.control.zoom({
                    position: 'topright'
                }).addTo(this.map);
            }

            addLayerControl() {
                L.control.layers(this.baseLayers, this.overlayLayers, {
                    position: 'topright',
                    collapsed: false
                }).addTo(this.map);
            }

            setupMapControls() {
                // Street View button
                const streetViewBtn = document.getElementById('map-street-view');
                if (streetViewBtn) {
                    streetViewBtn.addEventListener('click', () => this.toggleStreetView());
                }

                // Fullscreen button
                const fullscreenBtn = document.getElementById('map-fullscreen');
                if (fullscreenBtn) {
                    fullscreenBtn.addEventListener('click', () => this.toggleFullscreen());
                }

                // Refresh button
                const refreshBtn = document.getElementById('map-refresh');
                if (refreshBtn) {
                    refreshBtn.addEventListener('click', () => this.refreshMap());
                }
            }

            toggleFullscreen() {
                const mapContainer = document.querySelector('.map-container');
                if (!document.fullscreenElement) {
                    mapContainer.requestFullscreen();
                } else {
                    document.exitFullscreen();
                }
            }

            toggleStreetView() {
                // Get current map center
                const center = this.map.getCenter();
                const lat = center.lat;
                const lng = center.lng;
                
                // Show Street View for current map center
                if (window.streetViewManager) {
                    window.streetViewManager.showLocationFromMap(lat, lng, 'Ubicaci√≥n del Mapa');
                } else {
                    // Fallback: scroll to street view panel
                    const streetViewPanel = document.querySelector('.street-view-panel');
                    if (streetViewPanel) {
                        streetViewPanel.scrollIntoView({ 
                            behavior: 'smooth',
                            block: 'start'
                        });
                        
                        // Initialize Street View with current coordinates
                        setTimeout(() => {
                            if (window.initializeGoogleStreetView) {
                                window.initializeGoogleStreetView(lat, lng);
                            }
                        }, 500);
                    }
                }
            }

            refreshMap() {
                this.map.invalidateSize();
                this.updateMarkers(this.dataService.getFilteredNodes({}));
            }

            updateMarkers(filters) {
                console.log('üîÑ Actualizando marcadores y enlaces...');
                
                // Clear existing markers and links
                this.markerCluster.clearLayers();
                this.markers.clear();
                this.clearLinks();

                // Add filtered markers
                const filteredNodes = this.dataService.getFilteredNodes(filters);
                console.log('üìç Agregando marcadores:', filteredNodes.length);
                filteredNodes.forEach(node => this.addMarker(node));
                
                // Add microwave links
                console.log('üîó Agregando enlaces de microondas...');
                this.addMicrowaveLinks();
                
                console.log('‚úÖ Actualizaci√≥n de marcadores completada');
            }

            addMarker(node) {
                const color = this.getStatusColor(node.status);
                const size = this.getMarkerSize(node.type);
                const icon = this.createCustomIcon(node, color, size);
                
                const marker = L.marker(node.coordinates, { icon })
                    .addTo(this.markerCluster);

                // Enhanced popup with better styling
                const popupContent = this.createEnhancedPopup(node);
                marker.bindPopup(popupContent, {
                    maxWidth: 300,
                    className: 'custom-popup'
                });

                // Add click animation
                marker.on('click', () => {
                    this.animateMarker(marker);
                });

                this.markers.set(node.id, marker);
            }

            createCustomIcon(node, color, size, towerType = 'default') {
                // Icono simplificado para mejor rendimiento
                return L.divIcon({
                    html: `
                        <div class="tower-marker ${towerType}" style="
                            width: ${size}px;
                            height: ${size}px;
                            background: ${color};
                            border-radius: 50%;
                            border: 2px solid white;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 10px;
                            font-weight: bold;
                            color: white;
                            text-shadow: 1px 1px 1px rgba(0,0,0,0.5);
                        ">${towerType === 'tower-a' ? 'A' : towerType === 'tower-d' ? 'D' : ''}</div>
                    `,
                    className: 'tower-marker-wrapper',
                    iconSize: [size, size],
                    iconAnchor: [size / 2, size / 2]
                });
            }

            getIconClass(type) {
                const icons = {
                    'Infraestructura Principal': 'fas fa-broadcast-tower',
                    'Nodo Principal': 'fas fa-server',
                    'Nodo Internacional': 'fas fa-globe',
                    'Nodo Fronterizo': 'fas fa-flag',
                    'Nodo Regional': 'fas fa-map-marker-alt'
                };
                return icons[type] || 'fas fa-circle';
            }

            createEnhancedPopup(node) {
                const statusBadge = `<span class="marker-status ${node.status}">${this.getStatusLabel(node.status)}</span>`;
                const alertsHtml = node.alerts.length > 0 
                    ? `<div class="marker-alerts">
                         <strong>Alertas:</strong> ${node.alerts.join(', ')}
                       </div>`
                    : '';

                return `
                    <div class="marker-popup">
                        <div class="marker-title">
                            <i class="${this.getIconClass(node.type)}"></i>
                            ${node.name}
                        </div>
                        <div class="marker-details">
                            <div class="marker-detail">
                                <span class="marker-detail-label">Estado:</span>
                                <span class="marker-detail-value">${statusBadge}</span>
                            </div>
                            <div class="marker-detail">
                                <span class="marker-detail-label">Banda:</span>
                                <span class="marker-detail-value">${node.band.toUpperCase()}</span>
                            </div>
                            <div class="marker-detail">
                                <span class="marker-detail-label">Tipo:</span>
                                <span class="marker-detail-value">${node.type}</span>
                            </div>
                            <div class="marker-detail">
                                <span class="marker-detail-label">Regi√≥n:</span>
                                <span class="marker-detail-value">${node.region}</span>
                            </div>
                            <div class="marker-detail">
                                <span class="marker-detail-label">Rendimiento:</span>
                                <span class="marker-detail-value">${node.performance}%</span>
                            </div>
                            <div class="marker-detail">
                                <span class="marker-detail-label">√öltima Actualizaci√≥n:</span>
                                <span class="marker-detail-value">${moment(node.lastUpdate).format('DD/MM/YYYY HH:mm')}</span>
                            </div>
                            ${alertsHtml}
                        </div>
                        <div class="marker-actions">
                            <button class="marker-action-btn" onclick="window.streetViewManager.showLocationFromMap(${node.lat}, ${node.lng}, '${node.name}')">
                                <i class="fas fa-street-view"></i>
                                Vista de Calle
                            </button>
                        </div>
                    </div>
                `;
            }

            animateMarker(marker) {
                const element = marker.getElement();
                if (element) {
                    element.style.animation = 'markerActive 0.6s ease-in-out';
                    setTimeout(() => {
                        element.style.animation = '';
                    }, 600);
                }
            }

            getStatusColor(status) {
                const colors = {
                    'active': '#10b981',
                    'pending': '#f59e0b',
                    'inactive': '#ef4444'
                };
                return colors[status] || '#6b7280';
            }

            getStatusLabel(status) {
                const labels = {
                    'active': 'Operativo',
                    'pending': 'En Desarrollo',
                    'inactive': 'Inactivo'
                };
                return labels[status] || 'Desconocido';
            }

            getMarkerSize(type) {
                const sizes = {
                    'Infraestructura Principal': 16,
                    'Nodo Principal': 16,
                    'Nodo Internacional': 14,
                    'Nodo Fronterizo': 14,
                    'Nodo Regional': 12
                };
                return sizes[type] || 12;
            }

            // Microwave Links Management
            addMicrowaveLinks() {
                const links = this.dataService.getMicrowaveLinks();
                console.log('üîó Agregando enlaces de microondas:', links.length);
                
                // Limitar a los primeros 20 enlaces para mejor rendimiento
                const limitedLinks = links.slice(0, 20);
                console.log('üîó Mostrando solo los primeros', limitedLinks.length, 'enlaces para mejor rendimiento');
                
                limitedLinks.forEach(link => this.addLink(link));
                console.log('‚úÖ Enlaces de microondas agregados al mapa');
            }

            addLink(link) {
                console.log('üîó Agregando enlace:', link.id, link.stationA.name, '‚Üí', link.stationD.name);
                
                const coordinates = [
                    [link.stationA.lat, link.stationA.lng],
                    [link.stationD.lat, link.stationD.lng]
                ];

                // Determine link style based on feasibility
                const isFeasible = link.feasibility === 'PENDIENTE';
                const isNoFactible = link.feasibility === 'NO';
                
                // Colores y estilos mejorados
                let color, weight, opacity, dashArray, className;
                
                if (isFeasible) {
                    color = '#10b981'; // Verde para factible
                    weight = 5;
                    opacity = 0.9;
                    dashArray = null;
                    className = 'microwave-link feasible';
                } else if (isNoFactible) {
                    color = '#ef4444'; // Rojo para no factible
                    weight = 4;
                    opacity = 0.7;
                    dashArray = '15, 8';
                    className = 'microwave-link non-feasible';
                } else {
                    color = '#f59e0b'; // Amarillo para pendiente
                    weight = 4;
                    opacity = 0.8;
                    dashArray = '8, 4';
                    className = 'microwave-link pending';
                }

                // Crear enlace principal
                const polyline = L.polyline(coordinates, {
                    color: color,
                    weight: weight,
                    opacity: opacity,
                    dashArray: dashArray,
                    className: className,
                    // Guardar TODOS los datos del enlace en el polyline
                    stationA: link.stationA,
                    stationD: link.stationD,
                    id: link.id,
                    band: link.band,
                    cluster: link.cluster,
                    feasibility: link.feasibility,
                    reason: link.reason,
                    motivo: link.motivo,
                    length: link.length
                }).addTo(this.map);

                // Efectos de se√±al removidos para mejorar rendimiento

                // Etiqueta de banda removida para mejorar rendimiento

                // Agregar marcadores de torre espec√≠ficos para punta A y D (ultra optimizados)
                const towerA = L.marker([link.stationA.lat, link.stationA.lng], {
                    icon: this.createCustomIcon(link.stationA, '#3b82f6', 16, 'tower-a')
                }).addTo(this.map);

                const towerD = L.marker([link.stationD.lat, link.stationD.lng], {
                    icon: this.createCustomIcon(link.stationD, '#ef4444', 16, 'tower-d')
                }).addTo(this.map);

                // Agregar popups informativos a las torres
                towerA.bindPopup(`
                    <div class="tower-popup">
                        <h4 style="color: #3b82f6; margin: 0 0 8px 0;">üèóÔ∏è Torre A</h4>
                        <p><strong>Estaci√≥n:</strong> ${link.stationA.name}</p>
                        <p><strong>Altura Torre:</strong> ${link.stationA.towerHeight || 'No definida'} m</p>
                        <p><strong>Altura RAN:</strong> ${link.stationA.ranHeight || 'No definida'} m</p>
                        <p><strong>Transporte:</strong> ${link.stationA.transport || 'No definido'}</p>
                        <p><strong>Coordenadas:</strong> ${link.stationA.lat.toFixed(4)}¬∞, ${link.stationA.lng.toFixed(4)}¬∞</p>
                    </div>
                `, { maxWidth: 250 });

                towerD.bindPopup(`
                    <div class="tower-popup">
                        <h4 style="color: #ef4444; margin: 0 0 8px 0;">üèóÔ∏è Torre D</h4>
                        <p><strong>Estaci√≥n:</strong> ${link.stationD.name}</p>
                        <p><strong>Altura Torre:</strong> ${link.stationD.towerHeight || 'No definida'} m</p>
                        <p><strong>Altura RAN:</strong> ${link.stationD.ranHeight || 'No definida'} m</p>
                        <p><strong>Transporte:</strong> ${link.stationD.transport || 'No definido'}</p>
                        <p><strong>Coordenadas:</strong> ${link.stationD.lat.toFixed(4)}¬∞, ${link.stationD.lng.toFixed(4)}¬∞</p>
                    </div>
                `, { maxWidth: 250 });

                // Add popup with link information
                const popupContent = this.createLinkPopup(link);
                polyline.bindPopup(popupContent, {
                    maxWidth: 350,
                    className: 'link-popup'
                });

                // Add click animation
                polyline.on('click', () => {
                    this.animateLink(polyline);
                });

                this.links.set(link.id, polyline);
                
                console.log('‚úÖ Enlace agregado al mapa:', link.id, {
                    feasibility: link.feasibility,
                    reason: link.reason,
                    motivo: link.motivo
                });
            }

            // Funci√≥n para crear puntos de se√±al a lo largo del enlace (optimizada)
            createSignalPoints(coordinates, link) {
                const points = [];
                const [start, end] = coordinates;
                // Reducir puntos de se√±al para mejorar rendimiento
                const numPoints = Math.min(3, Math.max(2, Math.floor(link.length / 20))); // Un punto cada 20km, m√°ximo 3
                
                for (let i = 1; i < numPoints; i++) {
                    const ratio = i / numPoints;
                    const lat = start[0] + (end[0] - start[0]) * ratio;
                    const lng = start[1] + (end[1] - start[1]) * ratio;
                    
                    const signalPoint = L.circleMarker([lat, lng], {
                        radius: 2, // Reducir tama√±o
                        fillColor: '#34d399',
                        color: '#ffffff',
                        weight: 1, // Reducir grosor
                        opacity: 0.6, // Reducir opacidad
                        fillOpacity: 0.4, // Reducir opacidad de relleno
                        className: 'signal-point'
                    });
                    
                    points.push(signalPoint);
                }
                
                return points;
            }

            // Funci√≥n para calcular el punto medio de un enlace
            calculateMidpoint(coordinates) {
                const [start, end] = coordinates;
                const midLat = (start[0] + end[0]) / 2;
                const midLng = (start[1] + end[1]) / 2;
                return [midLat, midLng];
            }

        createLinkPopup(link) {
            const feasibilityClass = link.feasibility === 'PENDIENTE' ? 'feasible' : 'non-feasible';
            const feasibilityIcon = link.feasibility === 'PENDIENTE' ? 'fas fa-check-circle' : 'fas fa-times-circle';
            
            return `
                <div class="link-popup-content">
                    <div class="link-header">
                        <h3 class="link-title">${link.stationA.name} ‚Üî ${link.stationD.name}</h3>
                        <div class="link-feasibility ${feasibilityClass}">
                            <i class="${feasibilityIcon}"></i>
                            ${link.feasibility}
                        </div>
                    </div>
                    <div class="link-details">
                        <div class="link-detail">
                            <span class="link-detail-label">Distancia:</span>
                            <span class="link-detail-value">${link.length} km</span>
                        </div>
                        <div class="link-detail">
                            <span class="link-detail-label">Banda:</span>
                            <span class="link-detail-value">${link.band}</span>
                        </div>
                        <div class="link-detail">
                            <span class="link-detail-label">Cluster:</span>
                            <span class="link-detail-value">${link.cluster}</span>
                        </div>
                        <div class="link-detail">
                            <span class="link-detail-label">Transporte A:</span>
                            <span class="link-detail-value">${link.stationA.transport || 'N/A'}</span>
                        </div>
                        <div class="link-detail">
                            <span class="link-detail-label">Transporte D:</span>
                            <span class="link-detail-value">${link.stationD.transport || 'N/A'}</span>
                        </div>
                    </div>
                    ${link.reason ? `
                        <div class="link-reason">
                            <span class="link-reason-label">Motivo:</span>
                            <span class="link-reason-text">${link.reason}</span>
                        </div>
                    ` : ''}
                    <div class="link-actions">
                        <button class="link-action-btn" onclick="showLinkData(window.mapManager.dataService.getMicrowaveLinks().find(l => l.id === '${link.id}'))">
                            <i class="fas fa-database"></i>
                            Ver Datos
                        </button>
                        <button class="link-action-btn" onclick="window.mapManager.showStreetViewForLink('${link.id}')">
                            <i class="fas fa-street-view"></i>
                            Vista de Calle
                        </button>
                    </div>
                </div>
            `;
        }

        animateLink(polyline) {
            const element = polyline.getElement();
            if (element) {
                element.style.animation = 'linkActive 0.6s ease-in-out';
                setTimeout(() => {
                    element.style.animation = '';
                }, 600);
            }
        }

        clearLinks() {
            this.links.forEach(link => {
                this.map.removeLayer(link);
            });
            this.links.clear();
            
            // Limpiar tambi√©n marcadores de torres y puntos de se√±al
            this.map.eachLayer(layer => {
                if (layer.options && (layer.options.className === 'tower-marker-wrapper' || 
                    layer.options.className === 'signal-point' || 
                    layer.options.className === 'band-label-container')) {
                    this.map.removeLayer(layer);
                }
            });
        }

        updateLinksByCluster(clusterId) {
            this.clearLinks();
            const clusterLinks = this.dataService.getLinksByCluster(clusterId);
            clusterLinks.forEach(link => this.addLink(link));
        }

        updateLinksByFeasibility(feasibility) {
            this.clearLinks();
            let links;
            if (feasibility === 'PENDIENTE') {
                links = this.dataService.getFeasibleLinks();
            } else if (feasibility === 'NO') {
                links = this.dataService.getNonFeasibleLinks();
            } else {
                links = this.dataService.getMicrowaveLinks();
            }
            links.forEach(link => this.addLink(link));
        }

        showStreetViewForLink(linkId) {
            console.log('üîó Showing Street View for link:', linkId);
            const link = this.dataService.getMicrowaveLinks().find(l => l.id === linkId);
            if (!link) {
                console.error('‚ùå Link not found:', linkId);
                return;
            }

            // Calculate midpoint between stations
            const midLat = (link.stationA.lat + link.stationD.lat) / 2;
            const midLng = (link.stationA.lng + link.stationD.lng) / 2;
            
            console.log('üìç Link coordinates:', {
                stationA: { lat: link.stationA.lat, lng: link.stationA.lng, name: link.stationA.name },
                stationD: { lat: link.stationD.lat, lng: link.stationD.lng, name: link.stationD.name },
                midpoint: { lat: midLat, lng: midLng }
            });
            
            // Update location info in Street View panel
            const locationText = document.getElementById('street-view-location-text');
            const coordsText = document.getElementById('street-view-coords-text');
            
            if (locationText) {
                locationText.textContent = `${link.stationA.name} ‚Üî ${link.stationD.name}`;
                console.log('üìç Updated location text:', locationText.textContent);
            }
            
            if (coordsText) {
                coordsText.textContent = `${midLat.toFixed(4)}¬∞ N, ${Math.abs(midLng).toFixed(4)}¬∞ W`;
                console.log('üìç Updated coordinates text:', coordsText.textContent);
            }
            
            // Scroll to street view panel first
            const streetViewPanel = document.querySelector('.street-view-panel');
            if (streetViewPanel) {
                streetViewPanel.scrollIntoView({ 
                    behavior: 'smooth',
                    block: 'start'
                });
            }
            
            // Initialize Dual Street View for both stations
            setTimeout(() => {
                if (window.initializeDualStreetView) {
                    console.log('üöÄ Initializing Dual Street View for both stations...');
                    window.initializeDualStreetView(link.stationA, link.stationD);
                } else {
                    console.error('‚ùå initializeDualStreetView function not available');
                    
                    // Fallback to single view
                    if (window.initializeGoogleStreetView) {
                        console.log('üöÄ Fallback: Initializing Street View for link midpoint...');
                        window.initializeGoogleStreetView(midLat, midLng);
                    }
                    
                    // Also try the embed API as fallback
                    window.initializeStreetViewEmbed(midLat, midLng, `${link.stationA.name} ‚Üî ${link.stationD.name}`);
                }
            }, 500);
        }
    }

    // Advanced Filter Manager with Search and Real-time Updates
    class FilterManager {
            state = null;
            mapManager = null;
            alertManager = null;

            constructor(state, mapManager, alertManager) {
                this.state = state;
                this.mapManager = mapManager;
                this.alertManager = alertManager;
                this.initializeFilters();
            }

            initializeFilters() {
                const checkboxes = document.querySelectorAll('.filter-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', () => this.handleFilterChange());
                });

                // Search functionality
                const searchInput = document.getElementById('search-input');
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        this.state.updateState({ searchQuery: e.target.value });
                    });
                }

                // Refresh data button
                const refreshBtn = document.getElementById('refresh-data');
                if (refreshBtn) {
                    refreshBtn.addEventListener('click', () => this.refreshData());
                }

                this.addFilterReset();
            }

            handleFilterChange() {
                const statusCheckboxes = document.querySelectorAll('input[id^="status-"]:checked');
                const bandCheckboxes = document.querySelectorAll('input[id^="band-"]:checked');
                const regionCheckboxes = document.querySelectorAll('input[id^="region-"]:checked');

                const newState = {
                    status: Array.from(statusCheckboxes).map(cb => cb.id.replace('status-', '')),
                    bands: Array.from(bandCheckboxes).map(cb => cb.id.replace('band-', '')),
                    regions: Array.from(regionCheckboxes).map(cb => cb.id.replace('region-', ''))
                };

                this.state.updateState(newState);
            }

            refreshData() {
                this.alertManager.showAlert('info', 'Actualizando Datos', 'Sincronizando informaci√≥n en tiempo real...', 3000);
                
                // Simulate data refresh
                setTimeout(() => {
                    this.alertManager.showAlert('success', 'Datos Actualizados', 'La informaci√≥n se ha sincronizado correctamente.', 3000);
                }, 2000);
            }

            addFilterReset() {
                const sections = document.querySelectorAll('.sidebar-section');
                sections.forEach(section => {
                    const header = section.querySelector('.section-header');
                    const resetBtn = document.createElement('button');
                    resetBtn.innerHTML = '<i class="fas fa-undo"></i>';
                    resetBtn.className = 'filter-reset-btn';
                    resetBtn.title = 'Resetear filtros';
                    resetBtn.onclick = () => this.resetSectionFilters(section);
                    header.appendChild(resetBtn);
                });
            }

            resetSectionFilters(section) {
                const checkboxes = section.querySelectorAll('.filter-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = true;
                });
                this.handleFilterChange();
            }
        }

        // Enhanced Statistics Manager with Real-time Updates
        class StatisticsManager {
            stats = [
                { id: 'total-infrastructure', value: 1247, label: 'Infraestructura Total', icon: 'fas fa-broadcast-tower' },
                { id: 'active-links', value: 892, label: 'Enlaces Activos', icon: 'fas fa-check-circle' },
                { id: 'pending-projects', value: 355, label: 'Proyectos en Curso', icon: 'fas fa-clock' },
                { id: 'critical-nodes', value: 23, label: 'Nodos Cr√≠ticos', icon: 'fas fa-exclamation-triangle' }
            ];

            initializeStats() {
                this.stats.forEach((stat, index) => {
                    const element = document.getElementById(stat.id);
                    if (element) {
                        setTimeout(() => {
                            this.animateNumber(element, stat.value);
                        }, index * 200);
                    }
                });
            }

            updateStats(dataService) {
                const stats = dataService.getStatistics();
                this.animateStatValue('total-infrastructure', stats.total);
                this.animateStatValue('active-links', stats.active);
                this.animateStatValue('pending-projects', stats.pending);
                this.animateStatValue('critical-nodes', stats.critical);
            }

            animateNumber(element, targetValue) {
                const duration = 2000;
                const startTime = performance.now();
                const startValue = 0;

                const animate = (currentTime) => {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    
                    const currentValue = Math.floor(startValue + (targetValue - startValue) * this.easeOutCubic(progress));
                    element.textContent = currentValue.toLocaleString();

                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    }
                };

                requestAnimationFrame(animate);
            }

            animateStatValue(elementId, targetValue) {
                const element = document.getElementById(elementId);
                if (!element) return;

                const duration = 1500;
                const startTime = performance.now();
                const startValue = parseInt(element.textContent.replace(/,/g, '')) || 0;

                const animate = (currentTime) => {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    
                    const currentValue = Math.floor(startValue + (targetValue - startValue) * this.easeOutCubic(progress));
                    element.textContent = currentValue.toLocaleString();

                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    }
                };

                requestAnimationFrame(animate);
            }

            easeOutCubic(t) {
                return 1 - Math.pow(1 - t, 3);
            }
        }

        // Theme Manager for Dark/Light Mode
        class ThemeManager {
            constructor() {
                this.currentTheme = localStorage.getItem('theme') || 'light';
                this.initializeTheme();
                this.setupThemeToggle();
            }

            initializeTheme() {
                document.documentElement.setAttribute('data-theme', this.currentTheme);
                this.updateThemeIcon();
            }

            setupThemeToggle() {
                const toggle = document.getElementById('theme-toggle');
                if (toggle) {
                    toggle.addEventListener('click', () => this.toggleTheme());
                }
            }

            toggleTheme() {
                this.currentTheme = this.currentTheme === 'light' ? 'dark' : 'light';
                document.documentElement.setAttribute('data-theme', this.currentTheme);
                localStorage.setItem('theme', this.currentTheme);
                this.updateThemeIcon();
            }

            updateThemeIcon() {
                const icon = document.getElementById('theme-icon');
                if (icon) {
                    icon.className = this.currentTheme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
                }
            }
        }

        // Microwave Link Quality Manager
        class MicrowaveQualityManager {
            constructor() {
                this.initializeQualityMetrics();
                this.initializeSpectrumAnalyzer();
                this.startRealTimeUpdates();
            }

            initializeQualityMetrics() {
                // Simulate real-time microwave link quality data
                this.updateQualityMetrics();
            }

            updateQualityMetrics() {
                const metrics = {
                    availability: 98.5 + (Math.random() - 0.5) * 2,
                    signalLevel: -65 + (Math.random() - 0.5) * 10,
                    ber: 1.2 + (Math.random() - 0.5) * 0.5,
                    fadeMargin: 15.2 + (Math.random() - 0.5) * 3
                };

                // Update metric cards - temporarily disabled
                /*
                document.querySelector('.metric-card:nth-child(1) .metric-value').textContent = metrics.availability.toFixed(1);
                document.querySelector('.metric-card:nth-child(2) .metric-value').textContent = metrics.signalLevel.toFixed(0);
                document.querySelector('.metric-card:nth-child(3) .metric-value').textContent = metrics.ber.toFixed(1);
                document.querySelector('.metric-card:nth-child(4) .metric-value').textContent = metrics.fadeMargin.toFixed(1);
                */

                // Update status based on availability - temporarily disabled
                /*
                const statusElement = document.querySelector('.microwave-status');
                if (metrics.availability >= 98) {
                    statusElement.className = 'microwave-status excellent';
                    statusElement.innerHTML = '<i class="fas fa-signal"></i> Excelente';
                } else if (metrics.availability >= 95) {
                    statusElement.className = 'microwave-status good';
                    statusElement.innerHTML = '<i class="fas fa-signal"></i> Buena';
                } else if (metrics.availability >= 90) {
                    statusElement.className = 'microwave-status fair';
                    statusElement.innerHTML = '<i class="fas fa-signal"></i> Regular';
                } else {
                    statusElement.className = 'microwave-status poor';
                    statusElement.innerHTML = '<i class="fas fa-signal"></i> Pobre';
                }
                */
            }

            initializeSpectrumAnalyzer() {
                const ctx = document.getElementById('spectrum-chart');
                if (!ctx) return;

                const chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 100}, (_, i) => (14 + i * 0.1).toFixed(1)),
                        datasets: [{
                            label: 'Potencia de Se√±al (dBm)',
                            data: Array.from({length: 100}, () => -80 + Math.random() * 20),
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Frecuencia (GHz)'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Potencia (dBm)'
                                },
                                min: -100,
                                max: -40
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });

                // Update spectrum data every 5 seconds
                setInterval(() => {
                    chart.data.datasets[0].data = Array.from({length: 100}, () => -80 + Math.random() * 20);
                    chart.update('none');
                }, 5000);
            }

            startRealTimeUpdates() {
                setInterval(() => {
                    this.updateQualityMetrics();
                }, 3000);
            }
        }

        // Weather Integration Manager
        class WeatherManager {
            constructor() {
                this.initializeWeatherData();
                this.startWeatherUpdates();
            }

            initializeWeatherData() {
                // Simulate weather data for Sonora
                this.updateWeatherData();
            }

            updateWeatherData() {
                const weatherData = {
                    temperature: 32 + (Math.random() - 0.5) * 4,
                    humidity: 45 + (Math.random() - 0.5) * 10,
                    windSpeed: 15 + (Math.random() - 0.5) * 5,
                    condition: ['Despejado', 'Parcialmente nublado', 'Nublado'][Math.floor(Math.random() * 3)]
                };

                // Update weather display
                const weatherItems = document.querySelectorAll('.weather-item');
                if (weatherItems.length >= 4) {
                    weatherItems[0].querySelector('.weather-value').textContent = `${weatherData.temperature.toFixed(0)}¬∞C`;
                    weatherItems[1].querySelector('.weather-value').textContent = `${weatherData.humidity.toFixed(0)}%`;
                    weatherItems[2].querySelector('.weather-value').textContent = `${weatherData.windSpeed.toFixed(0)} km/h`;
                    weatherItems[3].querySelector('.weather-value').textContent = weatherData.condition;
                }
            }

            startWeatherUpdates() {
                setInterval(() => {
                    this.updateWeatherData();
                }, 10000); // Update every 10 seconds
            }
        }

        // Government Compliance Manager
        class ComplianceManager {
            constructor() {
                this.initializeComplianceTracking();
            }

            initializeComplianceTracking() {
                // Simulate compliance status updates
                this.updateComplianceStatus();
            }

            updateComplianceStatus() {
                // This would typically check against real compliance databases
                // For now, we'll simulate the status
                const complianceItems = document.querySelectorAll('.compliance-item');
                complianceItems.forEach((item, index) => {
                    const indicator = item.querySelector('.compliance-indicator');
                    const status = item.querySelector('span:last-child');
                    
                    // Simulate different compliance statuses
                    if (index === 0) { // Licencias IFT
                        indicator.className = 'compliance-indicator compliant';
                        status.textContent = 'Vigentes';
                    } else if (index === 1) { // Normas NOM
                        indicator.className = 'compliance-indicator compliant';
                        status.textContent = 'Cumplidas';
                    } else { // Inspecciones
                        indicator.className = 'compliance-indicator warning';
                        status.textContent = 'Pendiente';
                    }
                });
            }
        }

        // Security Monitoring Manager
        class SecurityManager {
            constructor() {
                this.initializeSecurityMonitoring();
                this.startSecurityUpdates();
            }

            initializeSecurityMonitoring() {
                // Initialize security status
                this.updateSecurityStatus();
            }

            updateSecurityStatus() {
                // Simulate security monitoring
                const securityAlerts = document.querySelectorAll('.security-alert');
                const complianceItems = document.querySelectorAll('.security-panel .compliance-item');
                
                // Update security compliance items
                complianceItems.forEach((item, index) => {
                    const indicator = item.querySelector('.compliance-indicator');
                    const status = item.querySelector('span:last-child');
                    
                    if (index === 0) { // Encriptaci√≥n
                        indicator.className = 'compliance-indicator compliant';
                        status.textContent = 'Activa';
                    } else { // Firewall
                        indicator.className = 'compliance-indicator compliant';
                        status.textContent = 'Operativo';
                    }
                });
            }

            startSecurityUpdates() {
                // Simulate security events
                setInterval(() => {
                    if (Math.random() < 0.1) { // 10% chance of security event
                        this.showSecurityAlert();
                    }
                }, 30000);
            }

            showSecurityAlert() {
                const alertManager = new AlertManager('alerts-container');
                const alerts = [
                    'Intento de acceso no autorizado detectado',
                    'Anomal√≠a en el tr√°fico de red',
                    'Fallo en autenticaci√≥n m√∫ltiple',
                    'Detecci√≥n de posible intrusi√≥n'
                ];
                
                const randomAlert = alerts[Math.floor(Math.random() * alerts.length)];
                alertManager.showAlert('error', 'Alerta de Seguridad', randomAlert, 8000);
            }
        }

        // Executive Analytics Manager
        class ExecutiveAnalyticsManager {
            constructor() {
                this.initializeExecutiveMetrics();
                this.initializeAdvancedCharts();
                this.startExecutiveUpdates();
            }

            initializeExecutiveMetrics() {
                // Animate executive metrics on load
                this.animateExecutiveMetrics();
            }

            animateExecutiveMetrics() {
                const metrics = document.querySelectorAll('.executive-metric-value');
                metrics.forEach((metric, index) => {
                    setTimeout(() => {
                        this.animateValue(metric);
                    }, index * 200);
                });
            }

            animateValue(element) {
                const finalValue = element.textContent;
                const isPercentage = finalValue.includes('%');
                const isCurrency = finalValue.includes('$');
                const isNumber = !isNaN(parseFloat(finalValue.replace(/[$,%]/g, '')));
                
                if (!isNumber) return;

                const numericValue = parseFloat(finalValue.replace(/[$,%]/g, ''));
                const duration = 2000;
                const startTime = performance.now();

                const animate = (currentTime) => {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    
                    const currentValue = Math.floor(numericValue * this.easeOutCubic(progress));
                    
                    if (isCurrency) {
                        element.textContent = `$${(currentValue / 1000000).toFixed(1)}M`;
                    } else if (isPercentage) {
                        element.textContent = `${currentValue.toFixed(1)}%`;
                    } else {
                        element.textContent = currentValue.toLocaleString();
                    }

                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    }
                };

                requestAnimationFrame(animate);
            }

            initializeAdvancedCharts() {
                this.createCostBenefitChart();
                this.createGrowthProjectionChart();
            }

            createCostBenefitChart() {
                const ctx = document.getElementById('cost-benefit-chart');
                if (!ctx) return;

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['A√±o 1', 'A√±o 2', 'A√±o 3', 'A√±o 4', 'A√±o 5'],
                        datasets: [{
                            label: 'Costos (Millones)',
                            data: [15.2, 3.8, 3.2, 2.9, 2.7],
                            backgroundColor: 'rgba(239, 68, 68, 0.8)',
                            borderColor: '#ef4444',
                            borderWidth: 2
                        }, {
                            label: 'Beneficios (Millones)',
                            data: [2.4, 2.8, 3.2, 3.6, 4.1],
                            backgroundColor: 'rgba(16, 185, 129, 0.8)',
                            borderColor: '#10b981',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Millones de Pesos'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top'
                            }
                        }
                    }
                });
            }

            createGrowthProjectionChart() {
                const ctx = document.getElementById('growth-projection-chart');
                if (!ctx) return;

                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
                        datasets: [{
                            label: 'Cobertura Actual (%)',
                            data: [87.5, 88.2, 88.9, 89.3, 89.8, 90.1, 90.5, 90.8, 91.2, 91.5, 91.8, 92.1],
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }, {
                            label: 'Proyecci√≥n IA (%)',
                            data: [87.5, 88.5, 89.8, 91.2, 92.5, 93.8, 94.2, 94.8, 95.1, 95.5, 95.8, 96.2],
                            borderColor: '#8b5cf6',
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            borderWidth: 3,
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: false,
                                min: 85,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Cobertura (%)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top'
                            }
                        }
                    }
                });
            }

            startExecutiveUpdates() {
                // Update executive metrics every 30 seconds
                setInterval(() => {
                    this.updateExecutiveMetrics();
                }, 30000);
            }

            updateExecutiveMetrics() {
                // Simulate real-time updates to executive metrics
                const availability = document.querySelector('.executive-metric:nth-child(1) .executive-metric-value');
                const savings = document.querySelector('.executive-metric:nth-child(2) .executive-metric-value');
                
                if (availability) {
                    const currentValue = parseFloat(availability.textContent);
                    const newValue = currentValue + (Math.random() - 0.5) * 0.2;
                    availability.textContent = `${Math.max(98.0, Math.min(99.5, newValue)).toFixed(1)}%`;
                }
                
                if (savings) {
                    const currentValue = parseFloat(savings.textContent.replace('$', '').replace('M', ''));
                    const newValue = currentValue + (Math.random() - 0.5) * 0.1;
                    savings.textContent = `$${Math.max(2.0, Math.min(3.0, newValue)).toFixed(1)}M`;
                }
            }

            easeOutCubic(t) {
                return 1 - Math.pow(1 - t, 3);
            }
        }

        // AI Insights Manager
        class AIInsightsManager {
            constructor() {
                this.initializeAIInsights();
                this.startAIUpdates();
            }

            initializeAIInsights() {
                // Initialize AI insights with animations
                this.animateAIInsights();
            }

            animateAIInsights() {
                const insights = document.querySelectorAll('.ai-insight');
                insights.forEach((insight, index) => {
                    setTimeout(() => {
                        insight.style.opacity = '0';
                        insight.style.transform = 'translateY(20px)';
                        insight.style.transition = 'all 0.6s ease-out';
                        
                        setTimeout(() => {
                            insight.style.opacity = '1';
                            insight.style.transform = 'translateY(0)';
                        }, 100);
                    }, index * 300);
                });
            }

            startAIUpdates() {
                // Simulate new AI insights every 2 minutes
                setInterval(() => {
                    this.generateNewInsight();
                }, 120000);
            }

            generateNewInsight() {
                const insights = [
                    {
                        icon: 'fas fa-lightbulb',
                        title: 'Optimizaci√≥n de Frecuencias Detectada',
                        description: 'El algoritmo de IA ha identificado una oportunidad de optimizaci√≥n en las frecuencias de 15 GHz que podr√≠a mejorar la eficiencia en un 8%.',
                        confidence: '92%'
                    },
                    {
                        icon: 'fas fa-shield-alt',
                        title: 'An√°lisis de Seguridad Predictivo',
                        description: 'El sistema predice un aumento del 15% en intentos de acceso no autorizado en los pr√≥ximos 30 d√≠as. Se recomienda reforzar la seguridad.',
                        confidence: '87%'
                    },
                    {
                        icon: 'fas fa-leaf',
                        title: 'Optimizaci√≥n Energ√©tica Recomendada',
                        description: 'An√°lisis de patrones de uso sugiere implementar modo de ahorro energ√©tico durante horas de menor tr√°fico, reduciendo costos en 12%.',
                        confidence: '95%'
                    }
                ];

                const randomInsight = insights[Math.floor(Math.random() * insights.length)];
                this.addNewInsight(randomInsight);
            }

            addNewInsight(insight) {
                const insightsContainer = document.querySelector('.ai-insights');
                if (!insightsContainer) return;

                const newInsight = document.createElement('div');
                newInsight.className = 'ai-insight';
                newInsight.innerHTML = `
                    <div class="ai-icon">
                        <i class="${insight.icon}"></i>
                    </div>
                    <div class="ai-content">
                        <div class="ai-title">${insight.title}</div>
                        <div class="ai-description">${insight.description}</div>
                        <div class="ai-confidence">Confianza: ${insight.confidence}</div>
                    </div>
                `;

                newInsight.style.opacity = '0';
                newInsight.style.transform = 'translateY(20px)';
                insightsContainer.appendChild(newInsight);

                setTimeout(() => {
                    newInsight.style.transition = 'all 0.6s ease-out';
                    newInsight.style.opacity = '1';
                    newInsight.style.transform = 'translateY(0)';
                }, 100);

                // Remove oldest insight if more than 3
                const existingInsights = insightsContainer.querySelectorAll('.ai-insight');
                if (existingInsights.length > 3) {
                    const oldestInsight = existingInsights[0];
                    oldestInsight.style.transition = 'all 0.6s ease-out';
                    oldestInsight.style.opacity = '0';
                    oldestInsight.style.transform = 'translateY(-20px)';
                    setTimeout(() => {
                        oldestInsight.remove();
                    }, 600);
                }
            }
        }

        // Elevation Profile Manager
        class ElevationProfileManager {
            constructor() {
                this.currentLink = 'hermosillo-caborca';
                this.currentView = 'profile';
                this.elevationData = this.generateElevationData();
                this.initializeElevationChart();
                this.initializeControls();
            }

            generateElevationData() {
                // Simulate elevation data for different links
                const links = {
                    'hermosillo-caborca': {
                        distance: 45.2,
                        maxElevation: 1250,
                        fadeMargin: 15.8,
                        availability: 98.5,
                        points: this.generateTerrainProfile(45.2, 1250)
                    },
                    'hermosillo-nogales': {
                        distance: 38.7,
                        maxElevation: 1100,
                        fadeMargin: 18.2,
                        availability: 99.1,
                        points: this.generateTerrainProfile(38.7, 1100)
                    },
                    'hermosillo-guaymas': {
                        distance: 52.1,
                        maxElevation: 980,
                        fadeMargin: 12.5,
                        availability: 97.8,
                        points: this.generateTerrainProfile(52.1, 980)
                    },
                    'caborca-nogales': {
                        distance: 67.3,
                        maxElevation: 1350,
                        fadeMargin: 14.2,
                        availability: 96.9,
                        points: this.generateTerrainProfile(67.3, 1350)
                    },
                    'guaymas-ciudad-obregon': {
                        distance: 41.8,
                        maxElevation: 890,
                        fadeMargin: 16.7,
                        availability: 98.8,
                        points: this.generateTerrainProfile(41.8, 890)
                    }
                };
                return links;
            }

            generateTerrainProfile(distance, maxElevation) {
                const points = [];
                const numPoints = 100;
                
                for (let i = 0; i <= numPoints; i++) {
                    const x = (i / numPoints) * distance;
                    // Generate realistic terrain profile with hills and valleys
                    const baseElevation = 200 + Math.sin(x * 0.1) * 100;
                    const hill1 = Math.exp(-Math.pow((x - distance * 0.3) / (distance * 0.1), 2)) * maxElevation * 0.3;
                    const hill2 = Math.exp(-Math.pow((x - distance * 0.7) / (distance * 0.15), 2)) * maxElevation * 0.4;
                    const noise = (Math.random() - 0.5) * 50;
                    
                    const elevation = baseElevation + hill1 + hill2 + noise;
                    points.push({ x, elevation });
                }
                
                return points;
            }

            initializeElevationChart() {
                const canvas = document.getElementById('elevation-chart');
                if (!canvas) return;

                this.ctx = canvas.getContext('2d');
                this.canvas = canvas;
                
                // Set canvas size
                this.resizeCanvas();
                window.addEventListener('resize', () => this.resizeCanvas());
                
                this.drawElevationProfile();
            }

            resizeCanvas() {
                const container = this.canvas.parentElement;
                this.canvas.width = container.clientWidth;
                this.canvas.height = container.clientHeight;
                this.drawElevationProfile();
            }

            drawElevationProfile() {
                if (!this.ctx) return;

                const data = this.elevationData[this.currentLink];
                if (!data) return;

                const ctx = this.ctx;
                const width = this.canvas.width;
                const height = this.canvas.height;
                const margin = { top: 40, right: 40, bottom: 60, left: 80 };

                // Clear canvas
                ctx.clearRect(0, 0, width, height);

                // Set up drawing area
                const chartWidth = width - margin.left - margin.right;
                const chartHeight = height - margin.top - margin.bottom;

                // Find min/max elevations
                const elevations = data.points.map(p => p.elevation);
                const minElevation = Math.min(...elevations);
                const maxElevation = Math.max(...elevations);
                const elevationRange = maxElevation - minElevation;

                // Draw background
                ctx.fillStyle = '#f8fafc';
                ctx.fillRect(0, 0, width, height);

                // Draw grid lines
                ctx.strokeStyle = '#e2e8f0';
                ctx.lineWidth = 1;
                
                // Horizontal grid lines
                for (let i = 0; i <= 5; i++) {
                    const y = margin.top + (i / 5) * chartHeight;
                    ctx.beginPath();
                    ctx.moveTo(margin.left, y);
                    ctx.lineTo(width - margin.right, y);
                    ctx.stroke();
                }

                // Vertical grid lines
                for (let i = 0; i <= 5; i++) {
                    const x = margin.left + (i / 5) * chartWidth;
                    ctx.beginPath();
                    ctx.moveTo(x, margin.top);
                    ctx.lineTo(x, height - margin.bottom);
                    ctx.stroke();
                }

                // Draw terrain profile
                ctx.strokeStyle = '#8b4513';
                ctx.lineWidth = 3;
                ctx.beginPath();
                
                data.points.forEach((point, index) => {
                    const x = margin.left + (point.x / data.distance) * chartWidth;
                    const y = margin.top + chartHeight - ((point.elevation - minElevation) / elevationRange) * chartHeight;
                    
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                ctx.stroke();

                // Fill terrain area
                ctx.fillStyle = 'rgba(139, 69, 19, 0.3)';
                ctx.lineTo(width - margin.right, height - margin.bottom);
                ctx.lineTo(margin.left, height - margin.bottom);
                ctx.closePath();
                ctx.fill();

                // Draw line of sight
                const startElevation = data.points[0].elevation;
                const endElevation = data.points[data.points.length - 1].elevation;
                
                ctx.strokeStyle = '#3b82f6';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.moveTo(margin.left, margin.top + chartHeight - ((startElevation - minElevation) / elevationRange) * chartHeight);
                ctx.lineTo(width - margin.right, margin.top + chartHeight - ((endElevation - minElevation) / elevationRange) * chartHeight);
                ctx.stroke();
                ctx.setLineDash([]);

                // Draw Fresnel zone
                if (this.currentView === 'fresnel') {
                    this.drawFresnelZone(data, margin, chartWidth, chartHeight, minElevation, elevationRange);
                }

                // Draw axes
                this.drawAxes(margin, chartWidth, chartHeight, data.distance, minElevation, maxElevation);

                // Draw title
                ctx.fillStyle = '#1e293b';
                ctx.font = 'bold 16px Inter, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(`Perfil de Elevaci√≥n: ${this.getLinkName(this.currentLink)}`, width / 2, 25);
            }

            drawFresnelZone(data, margin, chartWidth, chartHeight, minElevation, elevationRange) {
                const ctx = this.ctx;
                const frequency = 15; // GHz
                const fresnelRadius = this.calculateFresnelRadius(data.distance, frequency);
                
                ctx.fillStyle = 'rgba(59, 130, 246, 0.2)';
                ctx.strokeStyle = 'rgba(59, 130, 246, 0.5)';
                ctx.lineWidth = 1;
                
                data.points.forEach((point, index) => {
                    const x = margin.left + (point.x / data.distance) * chartWidth;
                    const y = margin.top + chartHeight - ((point.elevation - minElevation) / elevationRange) * chartHeight;
                    
                    const fresnelY = y - (fresnelRadius / elevationRange) * chartHeight;
                    
                    if (index === 0) {
                        ctx.beginPath();
                        ctx.moveTo(x, fresnelY);
                    } else {
                        ctx.lineTo(x, fresnelY);
                    }
                });
                
                // Draw lower Fresnel boundary
                data.points.forEach((point, index) => {
                    const x = margin.left + (point.x / data.distance) * chartWidth;
                    const y = margin.top + chartHeight - ((point.elevation - minElevation) / elevationRange) * chartHeight;
                    
                    const fresnelY = y + (fresnelRadius / elevationRange) * chartHeight;
                    
                    if (index === 0) {
                        ctx.lineTo(x, fresnelY);
                    } else {
                        ctx.lineTo(x, fresnelY);
                    }
                });
                
                ctx.closePath();
                ctx.fill();
                ctx.stroke();
            }

            calculateFresnelRadius(distance, frequency) {
                // Fresnel zone radius calculation
                const c = 3e8; // Speed of light
                const lambda = c / (frequency * 1e9);
                return Math.sqrt(lambda * distance * 1000 / 4); // Convert to meters
            }

            drawAxes(margin, chartWidth, chartHeight, distance, minElevation, maxElevation) {
                const ctx = this.ctx;
                const width = this.canvas.width;
                const height = this.canvas.height;
                
                // X-axis
                ctx.strokeStyle = '#64748b';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(margin.left, height - margin.bottom);
                ctx.lineTo(width - margin.right, height - margin.bottom);
                ctx.stroke();

                // Y-axis
                ctx.beginPath();
                ctx.moveTo(margin.left, margin.top);
                ctx.lineTo(margin.left, height - margin.bottom);
                ctx.stroke();

                // X-axis labels
                ctx.fillStyle = '#64748b';
                ctx.font = '12px Inter, sans-serif';
                ctx.textAlign = 'center';
                for (let i = 0; i <= 5; i++) {
                    const x = margin.left + (i / 5) * chartWidth;
                    const value = (i / 5) * distance;
                    ctx.fillText(`${value.toFixed(1)} km`, x, height - margin.bottom + 20);
                }

                // Y-axis labels
                ctx.textAlign = 'right';
                for (let i = 0; i <= 5; i++) {
                    const y = margin.top + (i / 5) * chartHeight;
                    const value = maxElevation - (i / 5) * (maxElevation - minElevation);
                    ctx.fillText(`${value.toFixed(0)} m`, margin.left - 10, y + 4);
                }

                // Axis titles
                ctx.textAlign = 'center';
                ctx.font = 'bold 14px Inter, sans-serif';
                ctx.fillText('Distancia', width / 2, height - 10);
                
                ctx.save();
                ctx.translate(20, height / 2);
                ctx.rotate(-Math.PI / 2);
                ctx.fillText('Elevaci√≥n (msnm)', 0, 0);
                ctx.restore();
            }

            getLinkName(linkId) {
                const names = {
                    'hermosillo-caborca': 'Hermosillo - Caborca',
                    'hermosillo-nogales': 'Hermosillo - Nogales',
                    'hermosillo-guaymas': 'Hermosillo - Guaymas',
                    'caborca-nogales': 'Caborca - Nogales',
                    'guaymas-ciudad-obregon': 'Guaymas - Ciudad Obreg√≥n'
                };
                return names[linkId] || linkId;
            }

            initializeControls() {
                // Link selector
                const linkSelector = document.getElementById('link-selector');
                if (linkSelector) {
                    linkSelector.addEventListener('change', (e) => {
                        this.currentLink = e.target.value;
                        this.updateMetrics();
                        this.drawElevationProfile();
                    });
                }

                // View buttons
                const viewButtons = document.querySelectorAll('.elevation-btn');
                viewButtons.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        viewButtons.forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        this.currentView = e.target.dataset.view;
                        this.drawElevationProfile();
                    });
                });
            }

            updateMetrics() {
                const data = this.elevationData[this.currentLink];
                if (!data) return;

                const metrics = document.querySelectorAll('.elevation-metric-value');
                if (metrics.length >= 4) {
                    metrics[0].textContent = data.distance.toFixed(1);
                    metrics[1].textContent = data.maxElevation.toLocaleString();
                    metrics[2].textContent = data.fadeMargin.toFixed(1);
                    metrics[3].textContent = data.availability.toFixed(1);
                }
            }
        }

        // Street View Manager
        class StreetViewManager {
            constructor() {
                this.currentLocation = null;
                this.currentView = 'street';
                this.isActive = false;
                this.locations = this.getStreetViewLocations();
                this.initializeStreetView();
                this.initializeControls();
            }

            getStreetViewLocations() {
                return {
                    'hermosillo': {
                        name: 'Hermosillo, Sonora',
                        lat: 29.0892,
                        lng: -110.9613,
                        heading: 0,
                        pitch: 0
                    },
                    'caborca': {
                        name: 'Caborca, Sonora',
                        lat: 30.7167,
                        lng: -112.1500,
                        heading: 0,
                        pitch: 0
                    },
                    'nogales': {
                        name: 'Nogales, Sonora',
                        lat: 31.3086,
                        lng: -110.9422,
                        heading: 0,
                        pitch: 0
                    },
                    'guaymas': {
                        name: 'Guaymas, Sonora',
                        lat: 27.9167,
                        lng: -110.9000,
                        heading: 0,
                        pitch: 0
                    },
                    'ciudad-obregon': {
                        name: 'Ciudad Obreg√≥n, Sonora',
                        lat: 27.4833,
                        lng: -109.9333,
                        heading: 0,
                        pitch: 0
                    }
                };
            }

            initializeStreetView() {
                this.loadingElement = document.getElementById('street-view-loading');
                this.errorElement = document.getElementById('street-view-error');
                this.iframeElement = document.getElementById('street-view-iframe');
                this.locationNameElement = document.getElementById('street-view-location-name');
                this.coordinatesElement = document.getElementById('street-view-coordinates');

                // Set default location
                this.currentLocation = this.locations.hermosillo;
                
                // Load street view immediately
                this.loadStreetView();
            }

            initializeControls() {
                // View buttons
                const viewButtons = document.querySelectorAll('.street-view-btn');
                viewButtons.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        viewButtons.forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        this.currentView = e.target.dataset.view;
                        this.loadStreetView();
                    });
                });

                // Action buttons
                const refreshBtn = document.getElementById('street-view-refresh');
                if (refreshBtn) {
                    refreshBtn.addEventListener('click', () => {
                        this.loadStreetView();
                    });
                }

                const fullscreenBtn = document.getElementById('street-view-fullscreen');
                if (fullscreenBtn) {
                    fullscreenBtn.addEventListener('click', () => {
                        this.toggleFullscreen();
                    });
                }

                const debugBtn = document.getElementById('street-view-debug');
                if (debugBtn) {
                    debugBtn.addEventListener('click', () => {
                        console.log('Debug button clicked - forcing street view display');
                        this.forceStreetViewDisplay();
                    });
                }

                // Map street view button
                const mapStreetViewBtn = document.getElementById('map-street-view');
                if (mapStreetViewBtn) {
                    mapStreetViewBtn.addEventListener('click', () => {
                        this.toggleStreetViewPanel();
                    });
                }
            }

            loadStreetView() {
                if (!this.currentLocation) return;

                console.log('Loading street view for:', this.currentLocation.name);
                
                // Update location info immediately
                if (this.locationNameElement) {
                    this.locationNameElement.textContent = this.currentLocation.name;
                }
                if (this.coordinatesElement) {
                    this.coordinatesElement.textContent = `${this.currentLocation.lat.toFixed(4)}¬∞ N, ${Math.abs(this.currentLocation.lng).toFixed(4)}¬∞ W`;
                }

                // Update panorama location name
                const panoramaLocationName = document.getElementById('panorama-location-name');
                if (panoramaLocationName) {
                    panoramaLocationName.textContent = this.currentLocation.name;
                }

                // Initialize panorama directly
                console.log('Initializing panorama directly');
                this.initializeInteractivePanorama();
            }

            generateStreetViewUrl() {
                const { lat, lng, heading, pitch } = this.currentLocation;
                return `https://www.google.com/maps/embed/v1/streetview?key=AIzaSyAX6hAgfg3Kz7SNClVgmRK1bStQnUJzbEA&location=${lat},${lng}&heading=${heading}&pitch=${pitch}&fov=90`;
            }

            generateSatelliteUrl() {
                const { lat, lng } = this.currentLocation;
                return `https://www.google.com/maps/embed/v1/view?key=AIzaSyAX6hAgfg3Kz7SNClVgmRK1bStQnUJzbEA&center=${lat},${lng}&zoom=18&maptype=satellite`;
            }

            generateHybridUrl() {
                const { lat, lng } = this.currentLocation;
                return `https://www.google.com/maps/embed/v1/view?key=AIzaSyAX6hAgfg3Kz7SNClVgmRK1bStQnUJzbEA&center=${lat},${lng}&zoom=18&maptype=hybrid`;
            }

            showLoading() {
                this.loadingElement.style.display = 'flex';
                this.errorElement.style.display = 'none';
                this.iframeElement.style.display = 'none';
            }

            hideLoading() {
                this.loadingElement.style.display = 'none';
                this.errorElement.style.display = 'none';
                this.iframeElement.style.display = 'block';
            }

            showError() {
                this.loadingElement.style.display = 'none';
                this.errorElement.style.display = 'block';
                this.iframeElement.style.display = 'none';
            }

            showAlternativeView() {
                console.log('showAlternativeView called');
                
                this.loadingElement.style.display = 'none';
                this.errorElement.style.display = 'none';
                this.iframeElement.style.display = 'none';

                // Create alternative view container
                let altViewContainer = document.getElementById('alternative-view-container');
                if (!altViewContainer) {
                    altViewContainer = document.createElement('div');
                    altViewContainer.id = 'alternative-view-container';
                    altViewContainer.className = 'alternative-view-container';
                    this.iframeElement.parentNode.appendChild(altViewContainer);
                }

                // Generate alternative view content based on view type
                switch (this.currentView) {
                    case 'street':
                        this.generateStreetViewAlternative(altViewContainer);
                        break;
                    case 'satellite':
                        this.generateSatelliteViewAlternative(altViewContainer);
                        break;
                    case 'hybrid':
                        this.generateHybridViewAlternative(altViewContainer);
                        break;
                    default:
                        this.generateStreetViewAlternative(altViewContainer);
                }

                altViewContainer.style.display = 'block';
                
                // Initialize immediately for street view
                if (this.currentView === 'street') {
                    console.log('Initializing panorama immediately');
                    this.initializeInteractivePanorama();
                }
            }

            generateStreetViewAlternative(container) {
                const { lat, lng, name } = this.currentLocation;
                
                container.innerHTML = `
                    <div class="alternative-street-view">
                        <div class="street-view-header-info">
                            <div class="location-badge">
                                <i class="fas fa-map-marker-alt"></i>
                                ${name}
                            </div>
                            <div class="coordinates-info">
                                ${lat.toFixed(4)}¬∞ N, ${Math.abs(lng).toFixed(4)}¬∞ W
                            </div>
                        </div>
                        
                        <div class="street-view-content">
                            <div class="interactive-panorama" id="interactive-panorama">
                                <div class="panorama-viewport" id="panorama-viewport">
                                    <div class="panorama-scene" id="panorama-scene">
                                        <div class="panorama-sky"></div>
                                        <div class="panorama-ground"></div>
                                        <div class="panorama-buildings">
                                            <div class="building building-1"></div>
                                            <div class="building building-2"></div>
                                            <div class="building building-3"></div>
                                            <div class="building building-4"></div>
                                            <div class="building building-5"></div>
                                        </div>
                                        <div class="panorama-roads">
                                            <div class="road road-main"></div>
                                            <div class="road road-side"></div>
                                        </div>
                                        <div class="panorama-vehicles">
                                            <div class="vehicle vehicle-1"></div>
                                            <div class="vehicle vehicle-2"></div>
                                        </div>
                                        <div class="panorama-infrastructure">
                                            <div class="tower tower-1"></div>
                                            <div class="tower tower-2"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="panorama-controls">
                                    <div class="panorama-compass" id="panorama-compass">
                                        <div class="compass-needle" id="compass-needle"></div>
                                        <div class="compass-directions">
                                            <span class="compass-n">N</span>
                                            <span class="compass-e">E</span>
                                            <span class="compass-s">S</span>
                                            <span class="compass-w">W</span>
                                        </div>
                                    </div>
                                    <div class="panorama-zoom">
                                        <button class="zoom-btn" id="zoom-in">+</button>
                                        <button class="zoom-btn" id="zoom-out">-</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="street-view-controls-panel">
                                <div class="view-direction">
                                    <div class="direction-indicator">
                                        <i class="fas fa-arrow-up"></i>
                                        <span>Norte</span>
                                    </div>
                                    <div class="direction-indicator">
                                        <i class="fas fa-arrow-right"></i>
                                        <span>Este</span>
                                    </div>
                                    <div class="direction-indicator">
                                        <i class="fas fa-arrow-down"></i>
                                        <span>Sur</span>
                                    </div>
                                    <div class="direction-indicator">
                                        <i class="fas fa-arrow-left"></i>
                                        <span>Oeste</span>
                                    </div>
                                </div>
                                
                                <div class="street-info">
                                    <div class="info-item">
                                        <i class="fas fa-road"></i>
                                        <span>V√≠a de acceso disponible</span>
                                    </div>
                                    <div class="info-item">
                                        <i class="fas fa-tower-broadcast"></i>
                                        <span>Infraestructura de telecomunicaciones</span>
                                    </div>
                                    <div class="info-item">
                                        <i class="fas fa-mountain"></i>
                                        <span>Terreno: ${this.getTerrainType(lat, lng)}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            generateSatelliteViewAlternative(container) {
                const { lat, lng, name } = this.currentLocation;
                
                container.innerHTML = `
                    <div class="alternative-satellite-view">
                        <div class="satellite-header-info">
                            <div class="location-badge">
                                <i class="fas fa-satellite"></i>
                                ${name} - Vista Satelital
                            </div>
                            <div class="coordinates-info">
                                ${lat.toFixed(4)}¬∞ N, ${Math.abs(lng).toFixed(4)}¬∞ W
                            </div>
                        </div>
                        
                        <div class="satellite-content">
                            <div class="satellite-placeholder">
                                <div class="satellite-icon">
                                    <i class="fas fa-satellite-dish"></i>
                                </div>
                                <div class="satellite-text">
                                    <h3>Vista Satelital</h3>
                                    <p>Imagen satelital de alta resoluci√≥n</p>
                                </div>
                            </div>
                            
                            <div class="satellite-info-panel">
                                <div class="elevation-data">
                                    <div class="elevation-item">
                                        <i class="fas fa-mountain"></i>
                                        <span>Elevaci√≥n: ${this.getElevation(lat, lng)} msnm</span>
                                    </div>
                                    <div class="elevation-item">
                                        <i class="fas fa-thermometer-half"></i>
                                        <span>Temperatura promedio: ${this.getTemperature(lat, lng)}¬∞C</span>
                                    </div>
                                </div>
                                
                                <div class="terrain-analysis">
                                    <div class="analysis-item">
                                        <i class="fas fa-tree"></i>
                                        <span>Vegetaci√≥n: ${this.getVegetation(lat, lng)}</span>
                                    </div>
                                    <div class="analysis-item">
                                        <i class="fas fa-water"></i>
                                        <span>Humedad: ${this.getHumidity(lat, lng)}%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            generateHybridViewAlternative(container) {
                const { lat, lng, name } = this.currentLocation;
                
                container.innerHTML = `
                    <div class="alternative-hybrid-view">
                        <div class="hybrid-header-info">
                            <div class="location-badge">
                                <i class="fas fa-layer-group"></i>
                                ${name} - Vista H√≠brida
                            </div>
                            <div class="coordinates-info">
                                ${lat.toFixed(4)}¬∞ N, ${Math.abs(lng).toFixed(4)}¬∞ W
                            </div>
                        </div>
                        
                        <div class="hybrid-content">
                            <div class="hybrid-placeholder">
                                <div class="hybrid-icon">
                                    <i class="fas fa-map"></i>
                                </div>
                                <div class="hybrid-text">
                                    <h3>Vista H√≠brida</h3>
                                    <p>Combinaci√≥n de sat√©lite y etiquetas</p>
                                </div>
                            </div>
                            
                            <div class="hybrid-info-panel">
                                <div class="infrastructure-overlay">
                                    <div class="overlay-item">
                                        <i class="fas fa-tower-broadcast"></i>
                                        <span>Torre de telecomunicaciones</span>
                                    </div>
                                    <div class="overlay-item">
                                        <i class="fas fa-road"></i>
                                        <span>Red vial principal</span>
                                    </div>
                                    <div class="overlay-item">
                                        <i class="fas fa-building"></i>
                                        <span>Zona urbana</span>
                                    </div>
                                </div>
                                
                                <div class="link-analysis">
                                    <div class="link-item">
                                        <i class="fas fa-wifi"></i>
                                        <span>Enlace de microondas activo</span>
                                    </div>
                                    <div class="link-item">
                                        <i class="fas fa-signal"></i>
                                        <span>Se√±al: ${this.getSignalStrength(lat, lng)} dBm</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            getTerrainType(lat, lng) {
                // Simulate terrain type based on coordinates
                if (lat > 30) return 'Monta√±oso';
                if (lat > 28) return 'Semi√°rido';
                return 'Des√©rtico';
            }

            getElevation(lat, lng) {
                // Simulate elevation based on coordinates
                return Math.floor(200 + (lat - 25) * 50 + Math.random() * 100);
            }

            getTemperature(lat, lng) {
                // Simulate temperature based on coordinates
                return Math.floor(25 + (lat - 25) * 2 + Math.random() * 10);
            }

            getVegetation(lat, lng) {
                // Simulate vegetation based on coordinates
                if (lat > 30) return 'Bosque de pino';
                if (lat > 28) return 'Matorral des√©rtico';
                return 'Vegetaci√≥n xer√≥fila';
            }

            getHumidity(lat, lng) {
                // Simulate humidity based on coordinates
                return Math.floor(30 + (lat - 25) * 5 + Math.random() * 20);
            }

            getSignalStrength(lat, lng) {
                // Simulate signal strength
                return Math.floor(-60 - Math.random() * 20);
            }

            initializeInteractivePanorama() {
                console.log('Initializing interactive panorama...');
                
                // Check if we're using Google Street View API (current implementation)
                const googleStreetView = document.getElementById('google-street-view');
                const streetViewMap = document.getElementById('street-view-map');
                
                if (googleStreetView && streetViewMap) {
                    console.log('Google Street View API elements found - using Google implementation');
                    return; // Use Google Street View instead of custom panorama
                }
                
                // Check for custom panorama elements (legacy implementation)
                const panorama = document.getElementById('street-view-panorama');
                const viewport = document.getElementById('panorama-viewport');
                const scene = document.getElementById('panorama-scene');
                const compass = document.getElementById('panorama-compass');
                const needle = document.getElementById('compass-needle');
                const zoomIn = document.getElementById('zoom-in');
                const zoomOut = document.getElementById('zoom-out');

                console.log('Elements found:', {
                    panorama: !!panorama,
                    viewport: !!viewport,
                    scene: !!scene,
                    compass: !!compass,
                    needle: !!needle,
                    zoomIn: !!zoomIn,
                    zoomOut: !!zoomOut
                });

                if (!panorama || !viewport || !scene) {
                    console.log('Custom panorama elements not found - using Google Street View API instead');
                    return;
                }

                // Panorama state
                this.panoramaState = {
                    rotation: 0,
                    zoom: 1,
                    isDragging: false,
                    lastX: 0,
                    lastY: 0
                };

                // Mouse events for dragging
                viewport.addEventListener('mousedown', (e) => {
                    console.log('Mouse down on viewport');
                    this.panoramaState.isDragging = true;
                    this.panoramaState.lastX = e.clientX;
                    this.panoramaState.lastY = e.clientY;
                    viewport.style.cursor = 'grabbing';
                    e.preventDefault();
                });

                document.addEventListener('mousemove', (e) => {
                    if (this.panoramaState.isDragging) {
                        const deltaX = e.clientX - this.panoramaState.lastX;
                        this.panoramaState.rotation += deltaX * 0.5;
                        console.log('Dragging, rotation:', this.panoramaState.rotation);
                        this.updatePanoramaView();
                        this.updateCompass();
                        this.panoramaState.lastX = e.clientX;
                        e.preventDefault();
                    }
                });

                document.addEventListener('mouseup', () => {
                    console.log('Mouse up, stopping drag');
                    this.panoramaState.isDragging = false;
                    viewport.style.cursor = 'grab';
                });

                // Touch events for mobile
                viewport.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.panoramaState.isDragging = true;
                    this.panoramaState.lastX = e.touches[0].clientX;
                    this.panoramaState.lastY = e.touches[0].clientY;
                });

                document.addEventListener('touchmove', (e) => {
                    if (this.panoramaState.isDragging) {
                        e.preventDefault();
                        const deltaX = e.touches[0].clientX - this.panoramaState.lastX;
                        this.panoramaState.rotation += deltaX * 0.5;
                        this.updatePanoramaView();
                        this.updateCompass();
                        this.panoramaState.lastX = e.touches[0].clientX;
                    }
                });

                document.addEventListener('touchend', () => {
                    this.panoramaState.isDragging = false;
                });

                // Zoom controls
                if (zoomIn) {
                    zoomIn.addEventListener('click', () => {
                        this.panoramaState.zoom = Math.min(this.panoramaState.zoom + 0.2, 2);
                        this.updatePanoramaView();
                    });
                }

                if (zoomOut) {
                    zoomOut.addEventListener('click', () => {
                        this.panoramaState.zoom = Math.max(this.panoramaState.zoom - 0.2, 0.5);
                        this.updatePanoramaView();
                    });
                }

                // Set initial cursor
                viewport.style.cursor = 'grab';

                // Initial update
                this.updatePanoramaView();
                this.updateCompass();
                
                console.log('Interactive panorama initialized successfully');
                
                // Add visual indicator that panorama is ready
                const panoramaElement = document.getElementById('interactive-panorama');
                if (panoramaElement) {
                    panoramaElement.style.border = '2px solid #10B981';
                    panoramaElement.style.boxShadow = '0 0 20px rgba(16, 185, 129, 0.3)';
                    
                    // Remove the border after 3 seconds
                    setTimeout(() => {
                        panoramaElement.style.border = 'none';
                        panoramaElement.style.boxShadow = 'none';
                    }, 3000);
                }
            }

            updatePanoramaView() {
                // Check if we're using Google Street View API
                const googleStreetView = document.getElementById('google-street-view');
                if (googleStreetView) {
                    return; // Google Street View handles its own updates
                }
                
                const scene = document.getElementById('panorama-scene');
                if (!scene) return;

                // Apply rotation and zoom
                scene.style.transform = `rotateY(${this.panoramaState.rotation}deg) scale(${this.panoramaState.zoom})`;
                
                // Update building positions for parallax effect
                const buildings = scene.querySelectorAll('.building');
                buildings.forEach((building, index) => {
                    const parallaxOffset = (index - 2) * 20;
                    building.style.transform = `translateX(${parallaxOffset}px) rotateY(${-this.panoramaState.rotation * 0.1}deg)`;
                });

                // Update vehicles
                const vehicles = scene.querySelectorAll('.vehicle');
                vehicles.forEach((vehicle, index) => {
                    const speed = 0.5 + index * 0.3;
                    vehicle.style.transform = `translateX(${Math.sin(Date.now() * 0.001 * speed) * 50}px)`;
                });
            }

            updateCompass() {
                // Check if we're using Google Street View API
                const googleStreetView = document.getElementById('google-street-view');
                if (googleStreetView) {
                    return; // Google Street View has its own compass
                }
                
                const needle = document.getElementById('compass-needle');
                if (!needle) return;

                // Convert rotation to compass direction
                const normalizedRotation = ((this.panoramaState.rotation % 360) + 360) % 360;
                needle.style.transform = `rotate(${normalizedRotation}deg)`;
            }

            setLocation(locationId) {
                if (this.locations[locationId]) {
                    this.currentLocation = this.locations[locationId];
                    this.loadStreetView();
                }
            }

            setCoordinates(lat, lng, name = 'Ubicaci√≥n Personalizada') {
                this.currentLocation = {
                    name: name,
                    lat: lat,
                    lng: lng,
                    heading: 0,
                    pitch: 0
                };
                this.loadStreetView();
            }

            toggleFullscreen() {
                if (this.iframeElement.requestFullscreen) {
                    this.iframeElement.requestFullscreen();
                } else if (this.iframeElement.webkitRequestFullscreen) {
                    this.iframeElement.webkitRequestFullscreen();
                } else if (this.iframeElement.msRequestFullscreen) {
                    this.iframeElement.msRequestFullscreen();
                }
            }

            toggleStreetViewPanel() {
                const panel = document.querySelector('.street-view-panel');
                if (panel) {
                    panel.scrollIntoView({ behavior: 'smooth' });
                }
            }

            // Method to be called from map markers
            showLocationFromMap(lat, lng, name) {
                this.setCoordinates(lat, lng, name);
                this.toggleStreetViewPanel();
            }

            // Force street view display for debugging
            forceStreetViewDisplay() {
                console.log('Forcing street view display...');
                
                // Hide loading and error states
                if (this.loadingElement) this.loadingElement.style.display = 'none';
                if (this.errorElement) this.errorElement.style.display = 'none';
                if (this.iframeElement) this.iframeElement.style.display = 'none';

                // Get or create alternative view container
                let altViewContainer = document.getElementById('alternative-view-container');
                if (!altViewContainer) {
                    altViewContainer = document.createElement('div');
                    altViewContainer.id = 'alternative-view-container';
                    altViewContainer.className = 'alternative-view-container';
                    if (this.iframeElement && this.iframeElement.parentNode) {
                        this.iframeElement.parentNode.appendChild(altViewContainer);
                    }
                }

                // Force generate street view
                this.generateStreetViewAlternative(altViewContainer);
                altViewContainer.style.display = 'block';

                // Force initialize panorama
                setTimeout(() => {
                    this.initializeInteractivePanorama();
                }, 100);
            }
        }

        // Main Application Class with All Advanced Features
        class Application {
            state = null;
            dataService = null;
            mapManager = null;
            filterManager = null;
            statsManager = null;
            chartManager = null;
            exportManager = null;
            alertManager = null;
            themeManager = null;
            microwaveQualityManager = null;
            weatherManager = null;
            complianceManager = null;
            securityManager = null;
            elevationProfileManager = null;
            streetViewManager = null;

            constructor() {
                this.state = ApplicationState.getInstance();
                this.dataService = new NetworkDataService();
                this.alertManager = new AlertManager('alerts-container');
                this.mapManager = new MapManager('network-map', this.dataService);
                window.mapManager = this.mapManager; // Make available globally
                this.filterManager = new FilterManager(this.state, this.mapManager, this.alertManager);
                this.statsManager = new StatisticsManager();
                this.chartManager = new ChartManager(this.dataService);
                this.exportManager = new ExportManager(this.dataService);
                this.themeManager = new ThemeManager();
                
                // Initialize specialized managers
                this.microwaveQualityManager = new MicrowaveQualityManager();
                this.weatherManager = new WeatherManager();
                this.complianceManager = new ComplianceManager();
                this.securityManager = new SecurityManager();
                this.elevationProfileManager = new ElevationProfileManager();
                // Initialize StreetViewManager only if elements exist
                try {
                    this.streetViewManager = new StreetViewManager();
                } catch (error) {
                    console.warn('‚ö†Ô∏è StreetViewManager no se pudo inicializar:', error.message);
                    this.streetViewManager = null;
                }

                this.initialize();
            }

            initialize() {
                // Subscribe to state changes
                this.state.subscribe((state) => {
                    this.mapManager.updateMarkers(state);
                    this.statsManager.updateStats(this.dataService);
                });

                // Initialize components
                this.statsManager.initializeStats();
                this.mapManager.updateMarkers(this.state.getState());
                
                // Force add microwave links after a short delay to ensure everything is loaded
                setTimeout(() => {
                    console.log('üîÑ Forzando recarga de enlaces de microondas...');
                    this.mapManager.addMicrowaveLinks();
                    
                    // Poblar dropdown de enlaces en el perfil de elevaci√≥n
                    poblarDropdownEnlaces();
                }, 1000);

            }

            simulateRealTimeAlerts() {
                // Simulate random alerts every 30 seconds
                setInterval(() => {
                    const alerts = [
                        { type: 'info', title: 'Actualizaci√≥n de Sistema', message: 'Datos sincronizados correctamente' },
                        { type: 'warning', title: 'Mantenimiento Programado', message: 'Nodo CULIACAN requiere mantenimiento' },
                        { type: 'success', title: 'Nuevo Enlace Activo', message: 'Conexi√≥n TUCSON establecida exitosamente' }
                    ];
                    
                    const randomAlert = alerts[Math.floor(Math.random() * alerts.length)];
                    this.alertManager.showAlert(randomAlert.type, randomAlert.title, randomAlert.message, 5000);
                }, 30000);
            }

            addPerformanceMonitoring() {
                const observer = new PerformanceObserver((list) => {
                    for (const entry of list.getEntries()) {
                        if (entry.entryType === 'measure') {
                            console.log(`‚è±Ô∏è ${entry.name}: ${entry.duration.toFixed(2)}ms`);
                        }
                    }
                });
                observer.observe({ entryTypes: ['measure'] });
            }
        }

        // Funci√≥n para mostrar datos del enlace seleccionado
        function showLinkData(link) {
            const contentDiv = document.getElementById('link-data-content');
            if (!contentDiv || !link) return;

            // Calcular distancia
            const distance = calcularDistancia(link.stationA.lat, link.stationA.lng, link.stationD.lat, link.stationD.lng);

            // Determinar estado
            let statusClass = 'status-inactive';
            let statusText = 'Inactivo';
            
            if (link.feasibility === 'PENDIENTE') {
                statusClass = 'status-active';
                statusText = 'Activo';
            } else if (link.feasibility === 'NO') {
                statusClass = 'status-pending';
                statusText = 'Pendiente';
            }

            contentDiv.innerHTML = `
                <div class="link-summary-card">
                    <div class="link-summary-header">
                        <div class="link-icon">üì°</div>
                        <div class="link-title">
                            <h2>${link.stationA.name} ‚Üî ${link.stationD.name}</h2>
                            <p class="link-subtitle">Enlace de Microondas - ${link.band || '8 GHz'}</p>
                        </div>
                        <div class="link-status">
                            <span class="status-badge-large ${statusClass}">${statusText}</span>
                        </div>
                    </div>
                    
                    <div class="link-metrics">
                        <div class="metric-card">
                            <div class="metric-icon">üìè</div>
                            <div class="metric-content">
                                <div class="metric-value">${distance.toFixed(2)} km</div>
                                <div class="metric-label">Distancia</div>
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-icon">üì∂</div>
                            <div class="metric-content">
                                <div class="metric-value">${link.band || '8 GHz'}</div>
                                <div class="metric-label">Banda</div>
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-icon">üè¢</div>
                            <div class="metric-content">
                                <div class="metric-value">${link.cluster || 'N/A'}</div>
                                <div class="metric-label">Cluster</div>
                            </div>
                        </div>
                    </div>

                    ${link.reason || link.motivo ? `
                        <div class="link-alert">
                            <div class="alert-icon">‚ö†Ô∏è</div>
                            <div class="alert-content">
                                <strong>Motivo:</strong> ${link.reason || link.motivo}
                            </div>
                        </div>
                    ` : ''}
                </div>

                <div class="stations-comparison">
                    <div class="station-card station-a">
                        <div class="station-header">
                            <div class="station-icon">üèóÔ∏è</div>
                            <div class="station-info">
                                <h3>Estaci√≥n A</h3>
                                <p class="station-name">${link.stationA.name}</p>
                            </div>
                            <div class="station-badge">A</div>
                        </div>
                        
                        <div class="station-details">
                            <div class="detail-row">
                                <span class="detail-label">üìç Ubicaci√≥n:</span>
                                <span class="detail-value">${link.stationA.lat.toFixed(4)}¬∞, ${link.stationA.lng.toFixed(4)}¬∞</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">üèóÔ∏è Altura Torre:</span>
                                <span class="detail-value">${link.stationA.towerHeight || 'No definida'} m</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">üì° Altura RAN:</span>
                                <span class="detail-value">${link.stationA.ranHeight || 'No definida'} m</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">üöö Transporte:</span>
                                <span class="detail-value">${link.stationA.transport || 'N/A'}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">üè≠ Tipo Sitio:</span>
                                <span class="detail-value">${link.stationA.siteType || 'N/A'}</span>
                            </div>
                        </div>
                    </div>

                    <div class="station-card station-d">
                        <div class="station-header">
                            <div class="station-icon">üèóÔ∏è</div>
                            <div class="station-info">
                                <h3>Estaci√≥n D</h3>
                                <p class="station-name">${link.stationD.name}</p>
                            </div>
                            <div class="station-badge">D</div>
                        </div>
                        
                        <div class="station-details">
                            <div class="detail-row">
                                <span class="detail-label">üìç Ubicaci√≥n:</span>
                                <span class="detail-value">${link.stationD.lat.toFixed(4)}¬∞, ${link.stationD.lng.toFixed(4)}¬∞</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">üèóÔ∏è Altura Torre:</span>
                                <span class="detail-value">${link.stationD.towerHeight || 'No definida'} m</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">üì° Altura RAN:</span>
                                <span class="detail-value">${link.stationD.ranHeight || 'No definida'} m</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">üöö Transporte:</span>
                                <span class="detail-value">${link.stationD.transport || 'N/A'}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">üè≠ Tipo Sitio:</span>
                                <span class="detail-value">${link.stationD.siteType || 'N/A'}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Funci√≥n para cargar la lista de enlaces
        function loadLinksList() {
            const linksList = document.getElementById('links-list');
            if (!linksList) return;

            const links = window.mapManager?.dataService?.getMicrowaveLinks() || [];
            
            linksList.innerHTML = '';

            links.forEach(link => {
                const linkItem = document.createElement('div');
                linkItem.className = 'link-item';
                linkItem.dataset.linkId = link.id;

                // Calcular distancia
                const distance = calcularDistancia(link.stationA.lat, link.stationA.lng, link.stationD.lat, link.stationD.lng);

                // Determinar estado
                let statusClass = 'inactive';
                let statusText = 'Inactivo';
                
                if (link.feasibility === 'PENDIENTE') {
                    statusClass = 'active';
                    statusText = 'Activo';
                } else if (link.feasibility === 'NO') {
                    statusClass = 'pending';
                    statusText = 'Pendiente';
                }

                linkItem.innerHTML = `
                    <div class="link-item-info">
                        <div class="link-item-name">${link.stationA.name} ‚Üî ${link.stationD.name}</div>
                        <div class="link-item-details">
                            ${distance.toFixed(2)} km ‚Ä¢ ${link.band || '8 GHz'} ‚Ä¢ ${link.cluster || 'N/A'}
                        </div>
                    </div>
                    <div class="link-item-status">
                        <div class="status-indicator ${statusClass}"></div>
                        <span style="font-size: var(--font-size-xs); color: var(--color-neutral-600);">${statusText}</span>
                    </div>
                `;

                // Agregar evento click
                linkItem.addEventListener('click', () => {
                    selectLink(link);
                });

                linksList.appendChild(linkItem);
            });
        }

        // Funci√≥n para seleccionar un enlace
        function selectLink(link) {
            // Remover selecci√≥n anterior
            document.querySelectorAll('.link-item').forEach(item => {
                item.classList.remove('selected');
            });

            // Marcar como seleccionado
            const selectedItem = document.querySelector(`[data-link-id="${link.id}"]`);
            if (selectedItem) {
                selectedItem.classList.add('selected');
            }

            // Mostrar datos del enlace
            showSelectedLinkData(link);
        }

        // Funci√≥n para mostrar datos del enlace seleccionado
        function showSelectedLinkData(link) {
            const selectedDataDiv = document.getElementById('selected-link-data');
            if (!selectedDataDiv) return;

            // Calcular distancia
            const distance = calcularDistancia(link.stationA.lat, link.stationA.lng, link.stationD.lat, link.stationD.lng);

            // Determinar estado
            let statusClass = 'status-inactive';
            let statusText = 'Inactivo';
            
            if (link.feasibility === 'PENDIENTE') {
                statusClass = 'status-active';
                statusText = 'Activo';
            } else if (link.feasibility === 'NO') {
                statusClass = 'status-pending';
                statusText = 'Pendiente';
            }

            selectedDataDiv.innerHTML = `
                <div class="link-summary-card">
                    <div class="link-summary-header">
                        <div class="link-icon">üì°</div>
                        <div class="link-title">
                            <h2>${link.stationA.name} ‚Üî ${link.stationD.name}</h2>
                            <p class="link-subtitle">Enlace de Microondas - ${link.band || '8 GHz'}</p>
                        </div>
                        <div class="link-status">
                            <span class="status-badge-large ${statusClass}">${statusText}</span>
                        </div>
                    </div>
                    
                    <div class="link-metrics">
                        <div class="metric-card">
                            <div class="metric-icon">üìè</div>
                            <div class="metric-content">
                                <div class="metric-value">${distance.toFixed(2)} km</div>
                                <div class="metric-label">Distancia</div>
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-icon">üì∂</div>
                            <div class="metric-content">
                                <div class="metric-value">${link.band || '8 GHz'}</div>
                                <div class="metric-label">Banda</div>
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-icon">üè¢</div>
                            <div class="metric-content">
                                <div class="metric-value">${link.cluster || 'N/A'}</div>
                                <div class="metric-label">Cluster</div>
                            </div>
                        </div>
                    </div>

                    ${link.reason || link.motivo ? `
                        <div class="link-alert">
                            <div class="alert-icon">‚ö†Ô∏è</div>
                            <div class="alert-content">
                                <strong>Motivo:</strong> ${link.reason || link.motivo}
                            </div>
                        </div>
                    ` : ''}
                </div>

                <div class="stations-comparison">
                    <div class="station-card station-a">
                        <div class="station-header">
                            <div class="station-icon">üèóÔ∏è</div>
                            <div class="station-info">
                                <h3>Estaci√≥n A</h3>
                                <p class="station-name">${link.stationA.name}</p>
                            </div>
                            <div class="station-badge">A</div>
                        </div>
                        
                        <div class="station-details">
                            <div class="detail-row">
                                <span class="detail-label">üìç Ubicaci√≥n:</span>
                                <span class="detail-value">${link.stationA.lat.toFixed(4)}¬∞, ${link.stationA.lng.toFixed(4)}¬∞</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">üèóÔ∏è Altura Torre:</span>
                                <span class="detail-value">${link.stationA.towerHeight || 'No definida'} m</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">üì° Altura RAN:</span>
                                <span class="detail-value">${link.stationA.ranHeight || 'No definida'} m</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">üöö Transporte:</span>
                                <span class="detail-value">${link.stationA.transport || 'N/A'}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">üè≠ Tipo Sitio:</span>
                                <span class="detail-value">${link.stationA.siteType || 'N/A'}</span>
                            </div>
                        </div>
                    </div>

                    <div class="station-card station-d">
                        <div class="station-header">
                            <div class="station-icon">üèóÔ∏è</div>
                            <div class="station-info">
                                <h3>Estaci√≥n D</h3>
                                <p class="station-name">${link.stationD.name}</p>
                            </div>
                            <div class="station-badge">D</div>
                        </div>
                        
                        <div class="station-details">
                            <div class="detail-row">
                                <span class="detail-label">üìç Ubicaci√≥n:</span>
                                <span class="detail-value">${link.stationD.lat.toFixed(4)}¬∞, ${link.stationD.lng.toFixed(4)}¬∞</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">üèóÔ∏è Altura Torre:</span>
                                <span class="detail-value">${link.stationD.towerHeight || 'No definida'} m</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">üì° Altura RAN:</span>
                                <span class="detail-value">${link.stationD.ranHeight || 'No definida'} m</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">üöö Transporte:</span>
                                <span class="detail-value">${link.stationD.transport || 'N/A'}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">üè≠ Tipo Sitio:</span>
                                <span class="detail-value">${link.stationD.siteType || 'N/A'}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Mostrar el √°rea de datos
            selectedDataDiv.style.display = 'block';

            // Scroll hacia los datos
            selectedDataDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Funci√≥n para buscar enlaces
        function setupLinkSearch() {
            const searchInput = document.getElementById('link-search');
            if (!searchInput) return;

            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const linkItems = document.querySelectorAll('.link-item');

                linkItems.forEach(item => {
                    const linkName = item.querySelector('.link-item-name').textContent.toLowerCase();
                    if (linkName.includes(searchTerm)) {
                        item.style.display = 'flex';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });
        }

        // Initialize application when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            performance.mark('app-start');
            const app = new Application();
            window.streetViewManager = app.streetViewManager;
            
            // Inicializar lista de enlaces
            setTimeout(() => {
                loadLinksList();
                setupLinkSearch();
            }, 1000);
            
            // Initialize street view panorama and pegman immediately
            setTimeout(() => {
                console.log('Initializing street view panorama...');
                initializeStreetViewPanorama();
                
                console.log('Initializing draggable pegman...');
                initializeDraggablePegman();
                
                // Street View ready - click button to open
                console.log('üèóÔ∏è Street View listo - haz clic en el bot√≥n para abrir');
            }, 500);
            
            performance.mark('app-end');
            performance.measure('app-initialization', 'app-start', 'app-end');
        });



        // Simple function to initialize street view panorama
        function initializeStreetViewPanorama() {
            // Check if we're using Google Street View API (current implementation)
            const googleStreetView = document.getElementById('google-street-view');
            const streetViewMap = document.getElementById('street-view-map');
            
            if (googleStreetView && streetViewMap) {
                console.log('Google Street View API elements found - using Google implementation');
                return; // Use Google Street View instead of custom panorama
            }
            
            // Check for custom panorama elements (legacy implementation)
            const viewport = document.getElementById('panorama-viewport');
            const scene = document.getElementById('panorama-scene');
            const needle = document.getElementById('compass-needle');
            const zoomIn = document.getElementById('zoom-in');
            const zoomOut = document.getElementById('zoom-out');

            if (!viewport || !scene) {
                console.log('Custom panorama elements not found - using Google Street View API instead');
                return;
            }

            console.log('Street view elements found, initializing...');

            // Panorama state
            let panoramaState = {
                rotation: 0,
                zoom: 1,
                isDragging: false,
                lastX: 0,
                lastY: 0
            };

            // Mouse events for dragging
            viewport.addEventListener('mousedown', (e) => {
                console.log('Mouse down on viewport');
                panoramaState.isDragging = true;
                panoramaState.lastX = e.clientX;
                panoramaState.lastY = e.clientY;
                viewport.style.cursor = 'grabbing';
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (panoramaState.isDragging) {
                    const deltaX = e.clientX - panoramaState.lastX;
                    panoramaState.rotation += deltaX * 0.5;
                    console.log('Dragging, rotation:', panoramaState.rotation);
                    updatePanoramaView();
                    updateCompass();
                    panoramaState.lastX = e.clientX;
                    e.preventDefault();
                }
            });

            document.addEventListener('mouseup', () => {
                console.log('Mouse up, stopping drag');
                panoramaState.isDragging = false;
                viewport.style.cursor = 'grab';
            });

            // Touch events for mobile
            viewport.addEventListener('touchstart', (e) => {
                e.preventDefault();
                panoramaState.isDragging = true;
                panoramaState.lastX = e.touches[0].clientX;
                panoramaState.lastY = e.touches[0].clientY;
            });

            document.addEventListener('touchmove', (e) => {
                if (panoramaState.isDragging) {
                    e.preventDefault();
                    const deltaX = e.touches[0].clientX - panoramaState.lastX;
                    panoramaState.rotation += deltaX * 0.5;
                    updatePanoramaView();
                    updateCompass();
                    panoramaState.lastX = e.touches[0].clientX;
                }
            });

            document.addEventListener('touchend', () => {
                panoramaState.isDragging = false;
            });

            // Zoom controls
            if (zoomIn) {
                zoomIn.addEventListener('click', () => {
                    panoramaState.zoom = Math.min(panoramaState.zoom + 0.2, 2);
                    updatePanoramaView();
                });
            }

            if (zoomOut) {
                zoomOut.addEventListener('click', () => {
                    panoramaState.zoom = Math.max(panoramaState.zoom - 0.2, 0.5);
                    updatePanoramaView();
                });
            }

            // Set initial cursor
            viewport.style.cursor = 'grab';

            // Update functions
            function updatePanoramaView() {
                if (!scene) return;
                scene.style.transform = `rotateY(${panoramaState.rotation}deg) scale(${panoramaState.zoom})`;
                
                // Update building positions for parallax effect
                const buildings = scene.querySelectorAll('.building');
                buildings.forEach((building, index) => {
                    const parallaxOffset = (index - 2) * 20;
                    building.style.transform = `translateX(${parallaxOffset}px) rotateY(${-panoramaState.rotation * 0.1}deg)`;
                });

                // Update vehicles
                const vehicles = scene.querySelectorAll('.vehicle');
                vehicles.forEach((vehicle, index) => {
                    const speed = 0.5 + index * 0.3;
                    vehicle.style.transform = `translateX(${Math.sin(Date.now() * 0.001 * speed) * 50}px)`;
                });
            }

            function updateCompass() {
                if (!needle) return;
                const normalizedRotation = ((panoramaState.rotation % 360) + 360) % 360;
                needle.style.transform = `rotate(${normalizedRotation}deg)`;
            }

            // Initial update
            updatePanoramaView();
            updateCompass();
            
            console.log('Street view panorama initialized successfully!');
        }

        // HTML5 Native Drag and Drop implementation
        function initializeDraggablePegman() {
            const pegman = document.getElementById('street-view-pegman');
            const mapContainer = document.getElementById('network-map');

            if (!pegman) {
                console.error('Pegman element not found');
                return;
            }

            console.log('Initializing HTML5 native drag and drop pegman...');

            // Set initial position
            pegman.style.position = 'absolute';
            pegman.style.left = '20px';
            pegman.style.top = '20px';
            pegman.style.zIndex = '9999';
            pegman.style.cursor = 'grab';

            // HTML5 Drag and Drop events
            pegman.addEventListener('dragstart', function(e) {
                console.log('Pegman drag start');
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/html', pegman.outerHTML);
                pegman.style.opacity = '0.5';
            });

            pegman.addEventListener('dragend', function(e) {
                console.log('Pegman drag end');
                pegman.style.opacity = '1';
                
                // Get drop position
                const x = e.clientX;
                const y = e.clientY;
                
                // Check if dropped on map
                const mapRect = mapContainer.getBoundingClientRect();
                
                if (x >= mapRect.left && x <= mapRect.right && 
                    y >= mapRect.top && y <= mapRect.bottom) {
                    
                    console.log('Pegman dropped on map - activating street view');
                    
                    // Move pegman to drop position
                    pegman.style.left = (x - mapRect.left - 12) + 'px';
                    pegman.style.top = (y - mapRect.top - 12) + 'px';
                    
                    // Activate street view
                    activateStreetViewFromMap(x, y);
                } else {
                    // Return to original position
                    pegman.style.left = '20px';
                    pegman.style.top = '20px';
                }
            });

            // Make map a drop zone
            mapContainer.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            });

            mapContainer.addEventListener('drop', function(e) {
                e.preventDefault();
                console.log('Map drop event');
            });

            console.log('HTML5 native drag and drop pegman initialized successfully!');
        }



        // Activate street view from map position
        function activateStreetViewFromMap(x, y) {
            console.log('Activating street view from map position:', x, y);
            
            // Get map coordinates (simplified - in real implementation you'd convert pixel to lat/lng)
            const mapContainer = document.getElementById('network-map');
            const mapRect = mapContainer.getBoundingClientRect();
            
            // Calculate relative position on map
            const relativeX = (x - mapRect.left) / mapRect.width;
            const relativeY = (y - mapRect.top) / mapRect.height;
            
            // Simulate coordinates based on position (this is simplified)
            const lat = 29.0892 + (relativeY - 0.5) * 2; // Adjust based on map bounds
            const lng = -110.9613 + (relativeX - 0.5) * 2; // Adjust based on map bounds
            
            console.log('Calculated coordinates:', lat, lng);
            
            // Show loading
            showStreetViewLoading();
            
            // Initialize Google Street View
            initializeGoogleStreetView(lat, lng);
            
            // Return pegman to original position
            const pegman = document.getElementById('street-view-pegman');
            if (pegman) {
                pegman.style.left = '20px';
                pegman.style.top = '20px';
            }
        }

        // Initialize Google Street View (make it global)
        window.initializeGoogleStreetView = function initializeGoogleStreetView(lat, lng) {
            console.log('üöÄ Initializing Street View for coordinates:', lat, lng);
            
            // Clear any existing panorama to prevent conflicts
            if (window.currentPanorama) {
                console.log('üßπ Clearing existing panorama...');
                window.currentPanorama = null;
            }
            
            // Check if Google Maps API is loaded
            if (typeof google === 'undefined' || !google.maps || !google.maps.StreetViewPanorama) {
                console.log('‚è≥ Google Maps API not loaded yet, waiting...');
                
                // Store the pending initialization
                window.pendingStreetViewInit = () => initializeGoogleStreetView(lat, lng);
                
                // Wait for API to load and retry
                const checkAPI = setInterval(() => {
                    if (typeof google !== 'undefined' && google.maps && google.maps.StreetViewPanorama) {
                        clearInterval(checkAPI);
                        console.log('‚úÖ Google Maps API loaded, initializing Street View...');
                        initializeGoogleStreetView(lat, lng);
                    }
                }, 100);
                
                // Timeout after 15 seconds
                setTimeout(() => {
                    clearInterval(checkAPI);
                    console.error('‚ùå Google Maps API failed to load after 15 seconds');
                    const errorElement = document.getElementById('street-view-error');
                    if (errorElement) {
                        errorElement.style.display = 'block';
                        errorElement.querySelector('p').textContent = 'Error: Google Maps API no se pudo cargar. Verifica tu conexi√≥n a internet y la API key.';
                    }
                }, 15000);
                
                return;
            }
            
            const streetViewContainer = document.getElementById('google-street-view');
            const streetViewMap = document.getElementById('street-view-map');
            const loadingElement = document.getElementById('street-view-loading');
            const errorElement = document.getElementById('street-view-error');
            
            if (!streetViewMap) {
                console.error('Street view map container not found');
                return;
            }
            
            // Hide loading and error, show street view
            loadingElement.style.display = 'none';
            errorElement.style.display = 'none';
            streetViewContainer.style.display = 'block';
            
            // Create Google Street View with error handling
            try {
                console.log('üéØ Creating Street View Panorama...');
                const panorama = new google.maps.StreetViewPanorama(streetViewMap, {
                    position: { lat: lat, lng: lng },
                    pov: {
                        heading: 0,
                        pitch: 0
                    },
                    zoom: 1,
                    visible: true,
                    addressControl: false,
                    linksControl: false,
                    panControl: false,
                    enableCloseButton: false,
                    showRoadLabels: false
                });
                
                console.log('‚úÖ Street View Panorama created successfully');
                
                // Store the panorama globally for future updates
                window.currentPanorama = panorama;
                
                // Check if Street View is available at this location
                google.maps.event.addListener(panorama, 'status_changed', () => {
                    const status = panorama.getStatus();
                    console.log('üìç Street View status changed:', status);
                    
                    if (status === google.maps.StreetViewStatus.OK) {
                        console.log('‚úÖ Street View loaded successfully!');
                        loadingElement.style.display = 'none';
                        errorElement.style.display = 'none';
                        streetViewContainer.style.display = 'block';
                    } else if (status === google.maps.StreetViewStatus.ZERO_RESULTS) {
                        console.log('‚ùå No Street View available at this location');
                        loadingElement.style.display = 'none';
                        errorElement.style.display = 'block';
                        errorElement.querySelector('p').textContent = 'Street View no est√° disponible en esta ubicaci√≥n espec√≠fica';
                        streetViewContainer.style.display = 'none';
                    } else {
                        console.log('‚ö†Ô∏è Street View status:', status);
                        loadingElement.style.display = 'none';
                        errorElement.style.display = 'block';
                        errorElement.querySelector('p').textContent = `Error de Street View: ${status}`;
                        streetViewContainer.style.display = 'none';
                    }
                });
                
                // Add timeout for Street View loading
                setTimeout(() => {
                    if (loadingElement.style.display !== 'none') {
                        console.log('‚è∞ Street View loading timeout - checking status...');
                        const status = panorama.getStatus();
                        if (status !== google.maps.StreetViewStatus.OK) {
                            console.log('‚ùå Street View failed to load within timeout');
                            loadingElement.style.display = 'none';
                            errorElement.style.display = 'block';
                            errorElement.querySelector('p').textContent = 'Street View tard√≥ demasiado en cargar. Intenta con otra ubicaci√≥n.';
                            streetViewContainer.style.display = 'none';
                        }
                    }
                }, 10000);
                
            } catch (error) {
                console.error('‚ùå Error creating Street View:', error);
                loadingElement.style.display = 'none';
                errorElement.style.display = 'block';
                errorElement.querySelector('p').textContent = 'Error al crear Street View: ' + error.message;
                streetViewContainer.style.display = 'none';
                return;
            }
            
            // Update location info
            const locationText = document.getElementById('street-view-location-text');
            const coordsText = document.getElementById('street-view-coords-text');
            
            if (locationText) {
                locationText.textContent = `${lat.toFixed(4)}¬∞ N, ${Math.abs(lng).toFixed(4)}¬∞ W`;
            }
            
            if (coordsText) {
                coordsText.textContent = `${lat.toFixed(4)}¬∞ N, ${Math.abs(lng).toFixed(4)}¬∞ W`;
            }
            

            
            // Scroll to street view panel
            const streetViewPanel = document.querySelector('.street-view-panel');
            if (streetViewPanel) {
                streetViewPanel.scrollIntoView({ behavior: 'smooth' });
            }
        }

        // Show street view loading
        function showStreetViewLoading() {
            const loadingElement = document.getElementById('street-view-loading');
            const errorElement = document.getElementById('street-view-error');
            const streetViewContainer = document.getElementById('google-street-view');
            
            loadingElement.style.display = 'block';
            errorElement.style.display = 'none';
            streetViewContainer.style.display = 'none';
        }

        // Global test function for pegman
        window.testPegmanDrag = function() {
            console.log('Testing pegman drag...');
            const pegman = document.getElementById('street-view-pegman');
            if (pegman) {
                console.log('Pegman found, testing drag simulation...');
                console.log('Pegman position:', pegman.style.left, pegman.style.top);
                console.log('Pegman z-index:', pegman.style.zIndex);
                console.log('Pegman pointer-events:', pegman.style.pointerEvents);
                
                // Simulate drag to center of map
                const mapContainer = document.getElementById('network-map');
                const mapRect = mapContainer.getBoundingClientRect();
                const centerX = mapRect.left + mapRect.width / 2;
                const centerY = mapRect.top + mapRect.height / 2;
                
                console.log('Map center:', centerX, centerY);
                
                // Move pegman to center
                pegman.style.left = (centerX - 20) + 'px';
                pegman.style.top = (centerY - 20) + 'px';
                
                // Activate street view
                setTimeout(() => {
                    if (window.activateStreetViewFromMap) {
                        window.activateStreetViewFromMap(centerX, centerY);
                    } else {
                        console.log('Street view activated at center of map');
                    }
                }, 500);
            } else {
                console.error('Pegman not found for testing');
            }
        };

        // Debug function to check pegman status
        window.debugPegman = function() {
            const pegman = document.getElementById('street-view-pegman');
            if (pegman) {
                console.log('=== PEGMAN DEBUG INFO ===');
                console.log('Element found:', pegman);
                console.log('Draggable attribute:', pegman.getAttribute('draggable'));
                console.log('Position:', pegman.style.position);
                console.log('Left:', pegman.style.left);
                console.log('Top:', pegman.style.top);
                console.log('Z-index:', pegman.style.zIndex);
                console.log('Cursor:', pegman.style.cursor);
                console.log('Opacity:', pegman.style.opacity);
                console.log('Event listeners:', pegman.ondragstart ? 'dragstart: YES' : 'dragstart: NO');
                console.log('Event listeners:', pegman.ondragend ? 'dragend: YES' : 'dragend: NO');
                console.log('========================');
            } else {
                console.error('Pegman element not found!');
            }
        };
    </script>

    <!-- Additional CSS for Enhanced Components -->
    <style>
        .marker-popup {
            text-align: center;
            min-width: 200px;
            font-family: 'Inter', sans-serif;
        }

        .marker-title {
            margin: 0 0 8px 0;
            color: #1e40af;
            font-weight: 700;
            font-size: 1rem;
        }

        .marker-details p {
            margin: 4px 0;
            font-size: 0.875rem;
            color: #374151;
        }

        .map-control {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            overflow: hidden;
        }

        .map-control-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: #3b82f6;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        .map-control-btn:hover {
            background: #2563eb;
        }

        .filter-reset-btn {
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
            margin-left: auto;
        }

        .filter-reset-btn:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-bottom: var(--space-4);
            padding: var(--space-3) var(--space-4);
            background: var(--color-neutral-50);
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-neutral-200);
        }
    </style>
</body>
</html>
