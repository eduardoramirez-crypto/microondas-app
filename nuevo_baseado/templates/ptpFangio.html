<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fangio Telecom - Gestor de Enlaces PtP con An√°lisis de Factibilidad</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <!-- Favicon files not found - commented out to prevent errors -->
  <!-- <link rel="icon" type="image/png" href="img/favicon-32x32-light.png" sizes="32x32"> -->
  <!-- <link rel="icon" type="image/png" href="img/favicon-32x32-light.png" sizes="32x32" media="(prefers-color-scheme: light)"> -->
  <!-- <link rel="icon" type="image/png" href="img/favicon-32x32-dark.png" sizes="32x32" media="(prefers-color-scheme: dark)"> -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
<!-- Agregar despu√©s de las otras librer√≠as de Leaflet -->
<script src="https://unpkg.com/leaflet-streetview@1.0.0/dist/leaflet-streetview.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet-streetview@1.0.0/dist/leaflet-streetview.css" />
<!-- Agregar despu√©s de las otras librer√≠as -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<!-- Para Street View de Google (alternativa) -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAX6hAgfg3Kz7SNClVgmRK1bStQnUJzbEA&libraries=geometry"></script>

<!-- ‚úÖ AGREGAR B√öSQUEDA GEOGR√ÅFICA -->
<script src="https://unpkg.com/leaflet-control-geocoder@3.0.0/dist/Control.Geocoder.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder@3.0.0/dist/Control.Geocoder.css" />
  <style>
.nav-buttons-container {
  display: flex;
  gap: 10px;
  justify-content: flex-start;
  margin: 10px 0;
  flex-wrap: wrap;
  padding: 0 10px;
  background: linear-gradient(135deg, rgba(11, 17, 31, 0.8) 0%, rgba(30, 136, 229, 0.1) 100%);
  border-radius: 12px;
  padding: 12px;
  border: 1px solid rgba(0, 188, 212, 0.2);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
  margin-left: 400px;
  margin-right: 40px;
  max-width: calc(100% - 160px);
}

.nav-button {
  position: relative;
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 16px 24px;
  background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 50%, #0891b2 100%);
  color: #ffffff;
  border: none;
  border-radius: 16px;
  font-size: 1rem;
  font-weight: 600;
  text-decoration: none;
  cursor: pointer;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 25px rgba(14, 165, 233, 0.3);
  min-width: 200px;
  justify-content: center;
  overflow: hidden;
  backdrop-filter: blur(10px);
  border: 2px solid rgba(255, 255, 255, 0.1);
}

.nav-button::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
  transition: left 0.8s ease;
}

.nav-button:hover::before {
  left: 100%;
}

.nav-button:hover {
  transform: translateY(-8px) scale(1.02);
  box-shadow: 0 20px 40px rgba(14, 165, 233, 0.4);
  background: linear-gradient(135deg, #0284c7 0%, #0ea5e9 50%, #06b6d4 100%);
  border-color: rgba(255, 255, 255, 0.3);
}

.nav-button.active {
  background: linear-gradient(135deg, #059669 0%, #10b981 50%, #34d399 100%);
  box-shadow: 0 12px 35px rgba(5, 150, 105, 0.4);
  transform: translateY(-4px);
  border-color: rgba(255, 255, 255, 0.4);
}

.nav-button.active:hover {
  background: linear-gradient(135deg, #047857 0%, #059669 50%, #10b981 100%);
  transform: translateY(-6px) scale(1.03);
}

.nav-button .icon {
  font-size: 1.2em;
  width: 24px;
  text-align: center;
  transition: all 0.3s ease;
  color: #ffffff;
  filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
}

.nav-button:hover .icon {
  transform: scale(1.1) rotate(5deg);
  filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
}

.nav-button .text {
  font-weight: 600;
  letter-spacing: 0.5px;
  text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
}

/* Efectos especiales para botones espec√≠ficos */
.nav-button.ptmp-button {
  background: linear-gradient(135deg, #7c3aed 0%, #8b5cf6 50%, #a855f7 100%);
  box-shadow: 0 8px 25px rgba(124, 58, 237, 0.3);
}

.nav-button.ptmp-button:hover {
  background: linear-gradient(135deg, #6d28d9 0%, #7c3aed 50%, #8b5cf6 100%);
  box-shadow: 0 20px 40px rgba(124, 58, 237, 0.4);
}

/* Bot√≥n de toggle especial */
.nav-button.toggle-button {
  background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 50%, #fcd34d 100%);
  box-shadow: 0 8px 25px rgba(245, 158, 11, 0.3);
}

.nav-button.toggle-button:hover {
  background: linear-gradient(135deg, #d97706 0%, #f59e0b 50%, #fbbf24 100%);
  box-shadow: 0 20px 40px rgba(245, 158, 11, 0.4);
}

/* Responsive */
@media (max-width: 768px) {
  .nav-button {
    min-width: 160px;
    padding: 14px 20px;
    font-size: 0.9rem;
  }
  
  .nav-button .icon {
    font-size: 1.1em;
    width: 20px;
  }
}

.nav-button:hover .icon {
  transform: scale(1.15) rotate(5deg);
  color: #ffffff;
}

.nav-button.active .icon {
  color: #ffffff;
}

.nav-button .text {
  font-weight: 700;
  letter-spacing: 0.8px;
  text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
}

.nav-button .badge {
  background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
  color: #ffffff;
  font-size: 0.85em;
  padding: 6px 10px;
  border-radius: 14px;
  font-weight: 800;
  margin-left: 10px;
  box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

/* Bot√≥n toggle especial */
.nav-button.toggle-button {
  background: linear-gradient(135deg, #1a2332 0%, #2d3748 100%);
  border: 2px solid #00bcd4;
  position: relative;
  padding-right: 70px;
  min-width: 320px;
}

.nav-button.toggle-button.active {
  background: linear-gradient(135deg, #00bcd4 0%, #1e88e5 100%);
  border-color: #00bcd4;
}

.nav-button.toggle-button .toggle-indicator {
  position: absolute;
  right: 20px;
  top: 50%;
  transform: translateY(-50%);
  width: 36px;
  height: 20px;
  background: #4b5563;
  border-radius: 10px;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
}

.nav-button.toggle-button .toggle-indicator::after {
  content: '';
  position: absolute;
  top: 2px;
  left: 2px;
  width: 16px;
  height: 16px;
  background: #ffffff;
  border-radius: 50%;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.nav-button.toggle-button.active .toggle-indicator {
  background: #10b981;
  box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
}

.nav-button.toggle-button.active .toggle-indicator::after {
  transform: translateX(16px);
}

/* Bot√≥n PtMP especial */
.nav-button.ptmp-button {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-color: #667eea;
  color: #ffffff;
  min-width: 280px;
}

.nav-button.ptmp-button:hover {
  background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
  border-color: #764ba2;
  box-shadow: 0 12px 35px rgba(102, 126, 234, 0.4);
  transform: translateY(-6px) scale(1.03);
}

.nav-button.ptmp-button .icon {
  color: #ffffff;
}

/* Bot√≥n de Llenado de Datos */
.nav-button.llenado-button {
  background: linear-gradient(135deg, #059669 0%, #10b981 50%, #34d399 100%);
  border-color: #059669;
  color: #ffffff;
  min-width: 280px;
}

.nav-button.llenado-button:hover {
  background: linear-gradient(135deg, #047857 0%, #059669 50%, #10b981 100%);
  border-color: #047857;
  box-shadow: 0 12px 35px rgba(5, 150, 105, 0.4);
  transform: translateY(-6px) scale(1.03);
}

.nav-button.llenado-button .icon {
  color: #ffffff;
}

/* Efectos de brillo */
.nav-button::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%);
  transform: translateX(-100%);
  transition: transform 0.6s ease;
}

.nav-button:hover::after {
  transform: translateX(100%);
}

/* Responsive design */
@media (max-width: 1400px) {
  .nav-buttons-container {
    gap: 16px;
    padding: 20px;
    margin-left: 100px;
  }
  
  .nav-button {
    min-width: 200px;
    padding: 18px 24px;
    font-size: 1rem;
  }
  
  .nav-button.toggle-button {
    min-width: 300px;
  }
  
  .nav-button.ptmp-button {
    min-width: 260px;
  }
  
  .nav-button.llenado-button {
    min-width: 260px;
  }
}

@media (max-width: 1200px) {
  .nav-buttons-container {
    gap: 14px;
    margin-left: 80px;
  }
  
  .nav-button {
    min-width: 180px;
    padding: 16px 20px;
    font-size: 0.95rem;
  }
  
  .nav-button.toggle-button {
    min-width: 280px;
  }
  
  .nav-button.ptmp-button {
    min-width: 240px;
  }
  
  .nav-button.llenado-button {
    min-width: 240px;
  }
}

@media (max-width: 900px) {
  .nav-buttons-container {
    flex-direction: column;
    align-items: center;
    gap: 18px;
    padding: 20px;
    margin-left: 40px;
    margin-right: 40px;
    justify-content: center;
  }
  
  .nav-button {
    min-width: 320px;
    padding: 22px 28px;
    font-size: 1.05rem;
  }
  
  .nav-button.toggle-button {
    min-width: 320px;
  }
  
  .nav-button.ptmp-button {
    min-width: 320px;
  }
  
  .nav-button.llenado-button {
    min-width: 320px;
  }
}

@media (max-width: 600px) {
  .nav-buttons-container {
    padding: 16px;
    margin: 20px 0;
    margin-left: 20px;
    margin-right: 20px;
  }
  
  .nav-button {
    min-width: 100%;
    padding: 20px 24px;
    font-size: 1rem;
  }
  
  .nav-button .text {
    font-size: 0.95rem;
  }
}

/* Estados de interacci√≥n */
.nav-button:active {
  transform: translateY(-2px) scale(0.98);
  transition: all 0.1s ease;
}

.nav-button:focus {
  outline: none;
  box-shadow: 0 0 0 4px rgba(0, 188, 212, 0.3);
}

/* Estado de carga */
.nav-button.loading {
  opacity: 0.7;
  cursor: not-allowed;
  pointer-events: none;
}

.nav-button.loading .icon {
  animation: spin 1s linear infinite;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

/* Efecto de part√≠culas flotantes */
.nav-buttons-container::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-image: 
    radial-gradient(circle at 20% 20%, rgba(0, 188, 212, 0.1) 0%, transparent 50%),
    radial-gradient(circle at 80% 80%, rgba(30, 136, 229, 0.1) 0%, transparent 50%);
  pointer-events: none;
  border-radius: 24px;
}
   .sidebar {
  position: fixed;
  left: 0; top: 0; bottom: 0;
  width: 260px;
  background: linear-gradient(135deg, #0b111f 60%, #1e88e5 100%);
  color: #e0f7fa;
  box-shadow: 2px 0 18px #00bcd455;
  z-index: 1000;
  padding: 0 0 24px 0;
  display: flex;
  flex-direction: column;
}
.sidebar-header {
  padding: 32px 18px 18px 18px;
  text-align: center;
}
.sidebar-logo {
  width: 160px;
  height: 160px;
  border-radius: 16px;
  margin-bottom: 12px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.sidebar-logo:hover {
  transform: scale(1.05);
  box-shadow: 0 6px 20px rgba(0, 230, 255, 0.3);
}
.sidebar-title {
  font-size: 1.3rem;
  font-weight: 800;
  color: #00e6ff;
  letter-spacing: 2px;
}
.sidebar-subtitle {
  font-size: 0.9rem;
  color: #90caf9;
  font-weight: 600;
  margin-bottom: 12px;
}
.sidebar-menu {
  list-style: none;
  padding: 0 18px;
  margin: 0;
  flex: 1;
}
.sidebar-menu li {
  padding: 12px 0;
  font-size: 1.08rem;
  display: flex;
  align-items: center;
  gap: 12px;
  cursor: pointer;
  transition: background 0.2s, color 0.2s;
}
.sidebar-menu li:hover {
  background: rgba(0,188,212,0.10);
  color: #fff;
  border-radius: 8px;
}
.sidebar-menu .badge {
  background: #ef4444;
  color: #fff;
  font-size: 0.85em;
  padding: 2px 8px;
  border-radius: 8px;
  margin-left: auto;
}
.sidebar-menu hr {
  border: none;
  border-top: 1px solid #1e88e5;
  margin: 12px 0;
}
 .topbar {
  position: fixed;
  left: 260px; top: 0; right: 0;
  height: 64px;
  background: #101a2a;
  color: #e0f7fa;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 32px;
  z-index: 900;
  box-shadow: 0 2px 8px #00bcd455;
}
.topbar-left {
  display: flex;
  align-items: center;
  gap: 32px;
}
.topbar-title {
  font-size: 1.2rem;
  font-weight: 700;
  color: #00e6ff;
}
.topbar-link {
  font-size: 1rem;
  color: #e0f7fa;
  cursor: pointer;
  position: relative;
}
.topbar-link .badge {
  position: absolute;
  top: -8px; right: -18px;
}
.topbar-right {
  display: flex;
  align-items: center;
  gap: 18px;
}
.user-badge {
  background: #7c3aed;
  color: #fff;
  font-weight: 700;
  border-radius: 50%;
  width: 36px; height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.1rem;
}
.footer {
  background: #101a2a;
  color: #e0f7fa;
  text-align: center;
  padding: 24px 0;
  font-size: 1rem;
  margin-top: 48px;
  letter-spacing: 1px;
  border-top: 1px solid #1e88e5;
}
/* Ajuste para que el contenido principal no se superponga con la sidebar y la topbar */
.container, .main-content {
  margin-left: 260px; /* ancho de la sidebar */
  margin-top: 64px;   /* alto de la topbar */
}
@media (max-width: 900px) {
  .container, .main-content {
    margin-left: 60px;
    margin-top: 64px;
  }
}
    
  .tab-content {
  display: none;
}
.tab-content.active {
  display: block;
}
:root {
  --accent: #00bcd4;
  --primary: #1e88e5;
  --dark-bg: #0b111f;
  --text-light: #e0f7fa;
  --glass: rgba(0, 0, 0, 0.1);
  --radius: 16px;
}
* {
  box-sizing: border-box;
  font-family: 'Inter', sans-serif;
}
body, html {
  margin: 0;
  min-height: 100vh;
  background: linear-gradient(135deg, #000000 0%, #0f172a 50%, #1e293b 100%);
  color: #e2e8f0;
  font-family: 'Inter', 'Segoe UI', 'Roboto', sans-serif;
  line-height: 1.6;;
}
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-image: 
    radial-gradient(circle at 20% 20%, rgba(59, 130, 246, 0.03) 0%, transparent 50%),
    radial-gradient(circle at 80% 80%, rgba(30, 64, 175, 0.03) 0%, transparent 50%);
  pointer-events: none;
  z-index: -1;
}
.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 40px 20px;
  background: var(--glass);
  border-radius: var(--radius);
   background: none !important;
  box-shadow: none !important;
}
.header {
  background: transparent;
  box-shadow: none;
  border: none;
  border-radius: 0;
  padding: 0;
  margin-bottom: 30px;
  display: flex;
  align-items: center;
  gap: 30px;
}
.logo-container .logo-wrapper {
  width: 110px;
  height: 110px;
}
.logo img {
  width: 100%;
  height: 100%;
  border-radius: 16px;
  background: #000000;
  box-shadow: 0 2px 12px #000000;
}
.company-info h1 {
  font-size: 2.8rem;
  font-weight: 700;
  color: var(--accent);
  text-shadow: 0 0 8px var(--accent);
  margin-bottom: 10px;
  background: none;
  -webkit-text-fill-color: unset;
}
.company-info .subtitle {
  font-size: 1.2rem;
  color: var(--primary);
  font-weight: 600;
  margin-top: 10px;
  padding-left: 0;
}
.premium-badge {
  display: none;
}
.main-content {
  background: #000000;
  border-radius: 20px;
  box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
  border: 1px solid rgba(148, 163, 184, 0.2);
  padding: 40px 35px;
  margin-top: 40px;
  color: #e2e8f0;
  position: relative;
  backdrop-filter: blur(10px);
}
.main-content::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, #1e40af, #3b82f6, #60a5fa);
  border-radius: 20px 20px 0 0;
}
h1, h2, h3, h4, h5, h6 {
  font-family: 'Inter', 'Segoe UI', sans-serif;
  font-weight: 600;
  line-height: 1.3;
  color: #f8fafc;
}

p, span, div {
  font-family: 'Inter', 'Segoe UI', sans-serif;
  line-height: 1.6;
}

/* Mejorar la legibilidad del texto */
.text-content {
  color: #cbd5e1;
  font-size: 1rem;
  line-height: 1.7;
}
.tabs {
  display: flex;
  gap: 18px;
  margin-bottom: 32px;
  justify-content: center;
}
.tab-button {
  background: rgba(0,188,212,0.12);
  color: #e0f7fa;
  border: none;
  border-radius: 14px;
  padding: 16px 32px;
  font-size: 1.1rem;
  font-weight: 600;
  transition: background 0.2s, color 0.2s, box-shadow 0.2s;
  box-shadow: 0 2px 8px rgba(30,136,229,0.08);
}
.tab-button.active, .tab-button:hover {
  background: linear-gradient(135deg, #00bcd4 60%, #1e88e5 100%);
  color: #fff;
  box-shadow: 0 4px 16px rgba(30,136,229,0.18);
}
.frecuencia-info {
  background: linear-gradient(135deg, rgba(11, 17, 31, 0.98) 0%, rgba(30, 136, 229, 0.15) 100%);
  border: 2px solid rgba(0, 188, 212, 0.3);
  border-radius: 20px;
  padding: 28px 32px;
  margin: 32px 0;
  color: #e0f7fa;
  font-weight: 500;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
  position: relative;
  overflow: hidden;
  min-height: 120px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  margin-left: 120px !important;
  margin-right: 40px !important;
  max-width: calc(100% - 160px) !important;
}

.frecuencia-info::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, #00bcd4, #1e88e5, #667eea, #764ba2);
  border-radius: 20px 20px 0 0;
}

.frecuencia-info::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-image: 
    radial-gradient(circle at 20% 20%, rgba(0, 188, 212, 0.08) 0%, transparent 50%),
    radial-gradient(circle at 80% 80%, rgba(30, 136, 229, 0.08) 0%, transparent 50%);
  pointer-events: none;
  border-radius: 20px;
}

.frecuencia-header {
  display: flex;
  align-items: center;
  gap: 16px;
  margin-bottom: 20px;
  position: relative;
  z-index: 2;
}

.frecuencia-icon {
  width: 56px;
  height: 56px;
  background: linear-gradient(135deg, #00bcd4, #1e88e5);
  border-radius: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 1.5em;
  box-shadow: 0 6px 20px rgba(0, 188, 212, 0.3);
  animation: iconPulse 2s ease-in-out infinite;
}

@keyframes iconPulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

.frecuencia-title {
  font-size: 1.6rem;
  font-weight: 800;
  color: #00bcd4;
  margin: 0;
  text-shadow: 0 2px 8px rgba(0, 188, 212, 0.3);
  letter-spacing: 1px;
}

.frecuencia-subtitle {
  font-size: 1rem;
  color: #94a3b8;
  margin: 4px 0 0 0;
  font-weight: 400;
}

.frecuencia-rules {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
  position: relative;
  z-index: 2;
}

.frecuencia-rule {
  background: rgba(26, 35, 50, 0.8);
  border-radius: 16px;
  padding: 20px;
  border: 1px solid rgba(0, 188, 212, 0.2);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
}

.frecuencia-rule:hover {
  transform: translateY(-4px);
  border-color: rgba(0, 188, 212, 0.4);
  box-shadow: 0 8px 25px rgba(0, 188, 212, 0.15);
  background: rgba(26, 35, 50, 0.9);
}

.frecuencia-rule::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, #00bcd4, #1e88e5);
  opacity: 0;
  transition: opacity 0.3s ease;
}

.frecuencia-rule:hover::before {
  opacity: 1;
}

.rule-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 12px;
}

.rule-icon {
  width: 40px;
  height: 40px;
  background: linear-gradient(135deg, #1e88e5, #667eea);
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 1.1em;
}

.rule-range {
  font-size: 1.1rem;
  font-weight: 700;
  color: #00bcd4;
  margin: 0;
}

.rule-frequency {
  font-size: 1rem;
  color: #e0f7fa;
  margin: 0;
  font-weight: 500;
}

.rule-description {
  font-size: 0.9rem;
  color: #94a3b8;
  margin: 8px 0 0 0;
  font-weight: 400;
  line-height: 1.4;
}

/* Responsive design */
@media (max-width: 1200px) {
  .frecuencia-info {
    padding: 24px 28px;
  }
  
  .frecuencia-rules {
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 16px;
  }
}

@media (max-width: 900px) {
  .frecuencia-info {
    padding: 20px 24px;
    margin: 24px 0;
  }
  
  .frecuencia-header {
    flex-direction: column;
  text-align: center;
    gap: 16px;
  }
  
  .frecuencia-title {
    font-size: 1.4rem;
  }
  
  .frecuencia-rules {
    grid-template-columns: 1fr;
    gap: 16px;
  }
  
  .frecuencia-rule {
    padding: 18px;
  }
}

@media (max-width: 600px) {
  .frecuencia-info {
    padding: 16px 20px;
    margin: 20px 0;
  }
  
  .frecuencia-icon {
    width: 48px;
    height: 48px;
    font-size: 1.3em;
  }
  
  .frecuencia-title {
    font-size: 1.3rem;
  }
  
  .frecuencia-rule {
    padding: 16px;
  }
  
  .rule-header {
    flex-direction: column;
    text-align: center;
    gap: 8px;
  }
}

/* Efectos especiales */
.frecuencia-rule:nth-child(1) {
  animation: ruleFloat 4s ease-in-out infinite;
}

.frecuencia-rule:nth-child(2) {
  animation: ruleFloat 4s ease-in-out infinite 1.3s;
}

.frecuencia-rule:nth-child(3) {
  animation: ruleFloat 4s ease-in-out infinite 2.6s;
}

@keyframes ruleFloat {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-3px); }
}

/* Efecto de brillo en hover */
.frecuencia-rule::after {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
  transition: left 0.6s ease;
}

.frecuencia-rule:hover::after {
  left: 100%;
}
.modern-upload-container {
  background: linear-gradient(135deg, rgba(11, 17, 31, 0.95) 0%, rgba(30, 136, 229, 0.08) 100%);
  border-radius: 24px;
  padding: 32px;
  margin: 32px 0;
  border: 2px solid rgba(0, 188, 212, 0.2);
  box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
  position: relative;
  overflow: hidden;
  margin-left: 120px !important;
  margin-right: 40px !important;
  max-width: calc(100% - 160px) !important;
}

.modern-upload-container::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, #00bcd4, #1e88e5, #667eea, #764ba2);
  border-radius: 24px 24px 0 0;
}

.modern-upload-container::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-image: 
    radial-gradient(circle at 20% 20%, rgba(0, 188, 212, 0.05) 0%, transparent 50%),
    radial-gradient(circle at 80% 80%, rgba(30, 136, 229, 0.05) 0%, transparent 50%);
  pointer-events: none;
  border-radius: 24px;
}

.upload-header {
  text-align: center;
  margin-bottom: 32px;
  position: relative;
  z-index: 2;
}

.upload-title {
  font-size: 1.8rem;
  font-weight: 800;
  color: #00bcd4;
  margin: 0 0 8px 0;
  text-shadow: 0 2px 8px rgba(0, 188, 212, 0.3);
  letter-spacing: 1px;
}

.upload-subtitle {
  font-size: 1rem;
  color: #94a3b8;
  margin: 0;
  font-weight: 400;
}

.upload-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
  gap: 24px;
  position: relative;
  z-index: 2;
}

.upload-card {
  background: #000000;
  border-radius: 20px;
  padding: 28px;
  border: 2px solid rgba(0, 188, 212, 0.15);
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  backdrop-filter: blur(10px);
}

.upload-card:hover {
  transform: translateY(-8px);
  border-color: rgba(0, 188, 212, 0.4);
  box-shadow: 0 16px 40px rgba(0, 188, 212, 0.2);
  background: rgba(26, 35, 50, 0.9);
}

.upload-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, #00bcd4, #1e88e5);
  opacity: 0;
  transition: opacity 0.3s ease;
}

.upload-card:hover::before {
  opacity: 1;
}

.upload-card-header {
  display: flex;
  align-items: center;
  gap: 16px;
  margin-bottom: 20px;
}

.upload-icon {
  width: 56px;
  height: 56px;
  background: linear-gradient(135deg, #00bcd4, #1e88e5);
  border-radius: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 1.5em;
  box-shadow: 0 6px 20px rgba(0, 188, 212, 0.3);
  transition: all 0.3s ease;
}

.upload-card:hover .upload-icon {
  transform: scale(1.1) rotate(5deg);
  box-shadow: 0 8px 25px rgba(0, 188, 212, 0.4);
}

.upload-card-title {
  font-size: 1.3rem;
  font-weight: 700;
  color: #e0f7fa;
  margin: 0;
  text-shadow: 0 1px 4px rgba(0, 0, 0, 0.3);
}

.upload-card-description {
  font-size: 0.9rem;
  color: #94a3b8;
  margin: 4px 0 0 0;
  font-weight: 400;
}

.upload-button {
  width: 100%;
  padding: 18px 24px;
  background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
  border: 2px solid rgba(0, 188, 212, 0.3);
  border-radius: 16px;
  color: #e0f7fa;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  position: relative;
  overflow: hidden;
}

.upload-button:hover {
  background: linear-gradient(135deg, #00bcd4 0%, #1e88e5 100%);
  border-color: #00bcd4;
  color: white;
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(0, 188, 212, 0.3);
}

.upload-button::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
  transition: left 0.6s ease;
}

.upload-button:hover::before {
  left: 100%;
}

.upload-button i {
  font-size: 1.2em;
  transition: transform 0.3s ease;
}

.upload-button:hover i {
  transform: scale(1.1);
}

.upload-input {
  display: none;
}

/* Estados de archivo cargado */
.file-loaded {
  background: rgba(16, 185, 129, 0.1) !important;
  border-color: rgba(16, 185, 129, 0.4) !important;
}

.file-loaded .upload-icon {
  background: linear-gradient(135deg, #10b981, #059669) !important;
}

.file-loaded .upload-card-title {
  color: #10b981 !important;
}

/* Informaci√≥n del archivo cargado */
.file-info {
  margin-top: 20px;
  padding: 20px;
  background: rgba(16, 185, 129, 0.1);
  border-radius: 16px;
  border: 1px solid rgba(16, 185, 129, 0.3);
  display: none;
}

.file-info.show {
  display: block;
  animation: slideDown 0.4s ease-out;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.file-info-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 16px;
}

.file-info-icon {
  width: 40px;
  height: 40px;
  background: linear-gradient(135deg, #10b981, #059669);
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 1.1em;
}

.file-info-title {
  font-size: 1.1rem;
  font-weight: 700;
  color: #10b981;
  margin: 0;
}

.file-info-details {
  margin-bottom: 16px;
}

.file-name {
  font-weight: 600;
  color: #e0f7fa;
  margin-bottom: 4px;
}

.file-meta {
  font-size: 0.9rem;
  color: #94a3b8;
}

.file-actions {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}

.file-action-btn {
  padding: 10px 16px;
  border-radius: 12px;
  font-size: 0.9rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  border: none;
  display: flex;
  align-items: center;
  gap: 8px;
}

.file-action-btn.primary {
  background: linear-gradient(135deg, #00bcd4, #1e88e5);
  color: white;
}

.file-action-btn.primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 16px rgba(0, 188, 212, 0.3);
}

.file-action-btn.danger {
  background: linear-gradient(135deg, #ef4444, #dc2626);
  color: white;
}

.file-action-btn.danger:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 16px rgba(239, 68, 68, 0.3);
}

/* Loading state */
.upload-loading {
  display: none;
  text-align: center;
  padding: 20px;
  color: #00bcd4;
}

.upload-loading.show {
  display: block;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.upload-spinner {
  width: 40px;
  height: 40px;
  border: 4px solid rgba(0, 188, 212, 0.2);
  border-top: 4px solid #00bcd4;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto 16px auto;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.loading-text {
  font-weight: 600;
  color: #00bcd4;
}

/* Responsive design */
@media (max-width: 1200px) {
  .upload-grid {
    grid-template-columns: 1fr;
    gap: 20px;
  }
  
  .modern-upload-container {
    padding: 24px;
  }
}

@media (max-width: 900px) {
  .modern-upload-container {
    padding: 20px;
    margin: 24px 0;
  }
  
  .upload-card {
    padding: 24px;
  }
  
  .upload-header {
    margin-bottom: 24px;
  }
  
  .upload-title {
    font-size: 1.6rem;
  }
}

@media (max-width: 600px) {
  .modern-upload-container {
    padding: 16px;
    margin: 20px 0;
  }
  
  .upload-card {
    padding: 20px;
  }
  
  .upload-card-header {
    flex-direction: column;
    text-align: center;
    gap: 16px;
  }
  
  .upload-title {
    font-size: 1.4rem;
  }
  
  .file-actions {
    flex-direction: column;
  }
  
  .file-action-btn {
    width: 100%;
    justify-content: center;
  }
}

/* Animaciones especiales */
@keyframes cardFloat {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-5px); }
}

.upload-card:nth-child(1) {
  animation: cardFloat 4s ease-in-out infinite;
}

.upload-card:nth-child(2) {
  animation: cardFloat 4s ease-in-out infinite 2s;
}

/* Efecto de part√≠culas */
.upload-card::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(45deg, transparent 30%, rgba(0, 188, 212, 0.05) 50%, transparent 70%);
  transform: translateX(-100%);
  transition: transform 0.6s ease;
}

.upload-card:hover::after {
  transform: translateX(100%);
}


.enterprise-form-container {
  background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
  border-radius: 24px;
  padding: 0;
  margin: 40px 0;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  border: 1px solid rgba(0, 188, 212, 0.2);
  overflow: hidden;
  position: relative;
  margin-left: 120px !important;
  margin-right: 40px !important;
  max-width: calc(100% - 160px) !important;
}

.enterprise-form-header {
  background: linear-gradient(90deg, #00bcd4, #1e88e5, #667eea, #764ba2);
  padding: 24px 32px;
  color: white;
  text-align: center;
  position: relative;
  overflow: hidden;
}

.enterprise-form-header::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
  animation: headerShine 3s infinite;
}

@keyframes headerShine {
  0% { left: -100%; }
  100% { left: 100%; }
}

.enterprise-form-title {
  font-size: 1.8rem;
  font-weight: 800;
  margin: 0;
  text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
  position: relative;
  z-index: 2;
}

.enterprise-form-subtitle {
  font-size: 1rem;
  opacity: 0.9;
  margin: 8px 0 0 0;
  font-weight: 400;
  position: relative;
  z-index: 2;
}

.enterprise-form-content {
  padding: 32px;
  display: grid;
  grid-template-columns: 1fr;
  gap: 32px;
}

.form-section {
  background: rgba(15, 23, 42, 0.6);
  border-radius: 20px;
  padding: 28px;
  border: 1px solid rgba(0, 188, 212, 0.15);
  position: relative;
  overflow: hidden;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.form-section:hover {
  transform: translateY(-8px);
  border-color: rgba(0, 188, 212, 0.4);
  box-shadow: 0 16px 40px rgba(0, 188, 212, 0.15);
  background: rgba(15, 23, 42, 0.8);
}

.form-section::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, #00bcd4, #1e88e5);
  opacity: 0;
  transition: opacity 0.3s ease;
}

.form-section:hover::before {
  opacity: 1;
}

.section-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 24px;
  padding-bottom: 16px;
  border-bottom: 2px solid rgba(0, 188, 212, 0.2);
}

.section-icon {
  width: 48px;
  height: 48px;
  background: linear-gradient(135deg, #00bcd4, #1e88e5);
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 1.3em;
  box-shadow: 0 4px 16px rgba(0, 188, 212, 0.3);
}

.section-title {
  font-size: 1.4rem;
  font-weight: 700;
  color: #00bcd4;
  margin: 0;
  text-shadow: 0 1px 4px rgba(0, 0, 0, 0.3);
}

.section-description {
  font-size: 0.9rem;
  color: #94a3b8;
  margin: 4px 0 0 0;
  font-weight: 400;
}

.form-fields-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 20px;
}

.form-field {
  position: relative;
  background: rgba(30, 41, 59, 0.8);
  border-radius: 16px;
  padding: 20px;
  border: 2px solid rgba(51, 65, 85, 0.3);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  overflow: hidden;
}

.form-field:hover {
  border-color: rgba(0, 188, 212, 0.4);
  background: rgba(30, 41, 59, 0.9);
  transform: translateY(-4px);
  box-shadow: 0 8px 25px rgba(0, 188, 212, 0.15);
}

.form-field::after {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(0, 188, 212, 0.05), transparent);
  transition: left 0.6s ease;
}

.form-field:hover::after {
  left: 100%;
}

.field-label {
  display: flex;
  align-items: center;
  gap: 10px;
  font-weight: 600;
  color: #e2e8f0;
  margin-bottom: 12px;
  font-size: 0.95rem;
  letter-spacing: 0.5px;
}

.field-label i {
  color: #00bcd4;
  font-size: 1.1em;
  width: 20px;
  text-align: center;
}

.field-input {
  width: 100%;
  padding: 16px 18px;
  border-radius: 12px;
  border: 2px solid rgba(51, 65, 85, 0.5);
  background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
  color: #f1f5f9;
  font-size: 1rem;
  font-weight: 500;
  outline: none;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.field-input:focus {
  border-color: #00bcd4;
  background: linear-gradient(135deg, #334155 0%, #475569 100%);
  box-shadow: 0 0 0 4px rgba(0, 188, 212, 0.15);
  transform: translateY(-2px);
}

.field-input:hover {
  border-color: rgba(0, 188, 212, 0.6);
  box-shadow: 0 4px 16px rgba(0, 188, 212, 0.1);
}

.field-input[readonly] {
  background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
  color: #94a3b8;
  border-color: rgba(0, 188, 212, 0.2);
  cursor: not-allowed;
  position: relative;
}

.field-input[readonly]::before {
  content: 'üîí';
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 0.8em;
  opacity: 0.6;
}

/* Campo especial de frecuencia */
.field-input[id="frecuencia"] {
  background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%) !important;
  color: #92400e !important;
  border-color: #f59e0b !important;
  font-weight: 700 !important;
  text-align: center !important;
  position: relative;
}

.field-input[id="frecuencia"]:focus {
  background: linear-gradient(135deg, #fef3c7 0%, #fbbf24 100%) !important;
  box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.2) !important;
}

/* Estados especiales */
.form-field.required {
  border-color: rgba(239, 68, 68, 0.4);
}

.form-field.required .field-label {
  color: #ef4444;
}

.form-field.success {
  border-color: rgba(16, 185, 129, 0.4);
}

.form-field.success .field-label {
  color: #10b981;
}

/* Responsive design */
@media (max-width: 1400px) {
  .enterprise-form-content {
    padding: 24px;
  }
  
  .form-section {
    padding: 24px;
  }
  
  .form-fields-grid {
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 16px;
  }
}

@media (max-width: 1200px) {
  .enterprise-form-content {
    padding: 20px;
  }
  
  .form-section {
    padding: 20px;
  }
  
  .form-fields-grid {
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 14px;
  }
}

@media (max-width: 900px) {
  .enterprise-form-content {
    padding: 16px;
  }
  
  .form-section {
    padding: 16px;
  }
  
  .form-fields-grid {
    grid-template-columns: 1fr;
    gap: 16px;
  }
  
  .section-header {
    flex-direction: column;
    text-align: center;
    gap: 16px;
  }
}

@media (max-width: 600px) {
  .enterprise-form-header {
    padding: 20px 16px;
  }
  
  .enterprise-form-title {
    font-size: 1.5rem;
  }
  
  .enterprise-form-content {
    padding: 12px;
  }
  
  .form-section {
    padding: 16px;
  }
  
  .form-field {
    padding: 16px;
  }
  
  .field-input {
    padding: 14px 16px;
    font-size: 0.95rem;
  }
}

/* Animaciones especiales */
@keyframes sectionFloat {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-5px); }
}

.form-section:nth-child(odd) {
  animation: sectionFloat 4s ease-in-out infinite;
}

.form-section:nth-child(even) {
  animation: sectionFloat 4s ease-in-out infinite 2s;
}

/* Efectos de part√≠culas */
.enterprise-form-container::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-image: 
    radial-gradient(circle at 20% 20%, rgba(0, 188, 212, 0.03) 0%, transparent 50%),
    radial-gradient(circle at 80% 80%, rgba(30, 136, 229, 0.03) 0%, transparent 50%);
  pointer-events: none;
  border-radius: 24px;
}

.action-buttons .btn,
.btn {
  background: var(--accent);
  color: #000;
  font-weight: 700;
  padding: 14px 30px;
  border-radius: var(--radius);
  cursor: pointer;
  font-size: 1.1rem;
  border: none;
  margin: 6px 8px 6px 0;
  transition: background 0.3s, color 0.3s;
  box-shadow: 0 2px 12px rgba(0,188,212,0.10);
}
.btn:hover {
  background: var(--primary);
  color: #fff;
}
.table-container {
  background: rgba(11, 17, 31, 0.98);
  border-radius: 16px;
  box-shadow: 0 6px 32px 0 rgba(0,188,212,0.10);
  border: 2px solid var(--accent);
  padding: 12px;
  overflow-x: auto;
}
table {
  border-collapse: collapse;
  width: 100%;
  background: transparent;
  color: var(--text-light);
}
th, td {
  padding: 12px 14px;
  text-align: left;
  font-size: 14px;
  border-bottom: 1px solid rgba(0,188,212,0.10);
}
th {
  background: rgba(0,188,212,0.10);
  color: var(--accent);
  font-weight: 700;
}
tr:hover {
  background: rgba(0,188,212,0.08);
}
tr.selected {
  background: var(--accent) !important;
  color: #000 !important;
}
::-webkit-scrollbar {
  width: 10px;
  background: rgba(0,188,212,0.08);
  border-radius: 8px;
}
::-webkit-scrollbar-thumb {
  background: linear-gradient(135deg, #00bcd4 30%, #1e88e5 100%);
  border-radius: 8px;
}
@media (max-width: 768px) {
  .container { padding: 10px; }
  .main-content { padding: 10px; }
  .form-grid { gap: 12px 8px; }
  th, td { padding: 8px 6px; }
}
.fangio-header {
  display: flex;
  align-items: center;
  gap: 0;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 0;
  box-shadow: none;
  padding: 0;
  margin-bottom: 0;
  position: relative;
  min-height: 200px;
  justify-content: center;
  overflow: hidden;
}

/* Fondo con patr√≥n geom√©trico moderno */
.fangio-header::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-image: 
    radial-gradient(circle at 25% 25%, rgba(255,255,255,0.1) 0%, transparent 50%),
    radial-gradient(circle at 75% 75%, rgba(255,255,255,0.1) 0%, transparent 50%);
  pointer-events: none;
}

/* Contenedor interno con glassmorphism */
.fangio-header-inner {
  display: flex;
  align-items: center;
  gap: 48px;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(20px);
  border-radius: 24px;
  padding: 40px 48px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  position: relative;
  z-index: 2;
  margin: 40px;
  min-width: 800px;
}

/* Logo con dise√±o moderno */
.fangio-logo-box {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 20px;
  padding: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 120px;
  height: 120px;
  box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
  position: relative;
  overflow: hidden;
}

.fangio-logo-box::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: linear-gradient(45deg, transparent, rgba(255,255,255,0.2), transparent);
  animation: logoShine 3s infinite;
}

@keyframes logoShine {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.fangio-logo-img {
  width: 80px;
  height: 80px;
  object-fit: contain;
  filter: brightness(0) invert(1);
  z-index: 2;
  position: relative;
}

/* T√≠tulo con tipograf√≠a moderna */
.fangio-title-box {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.fangio-title {
  font-size: 3.5rem;
  font-weight: 900;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin: 0;
  font-family: 'Inter', 'Segoe UI', sans-serif;
  letter-spacing: -0.03em;
  line-height: 1;
  text-shadow: none;
}

.fangio-subtitle {
  font-size: 1.4rem;
  color: #64748b;
  font-weight: 500;
  margin: 0;
  font-family: 'Inter', 'Segoe UI', sans-serif;
  line-height: 1.3;
  opacity: 0.8;
}

/* Bot√≥n con dise√±o neum√≥rfico */
.fangio-header .nav-button {
  display: inline-flex;
  align-items: center;
  gap: 14px;
  padding: 18px 32px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: #ffffff;
  border: none;
  border-radius: 16px;
  font-size: 1.2rem;
  font-weight: 700;
  text-decoration: none;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  font-family: 'Inter', 'Segoe UI', sans-serif;
  box-shadow: 
    0 8px 25px rgba(102, 126, 234, 0.3),
    inset 0 1px 0 rgba(255, 255, 255, 0.2);
  position: relative;
  overflow: hidden;
}

.fangio-header .nav-button::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
  transition: left 0.6s ease;
}

.fangio-header .nav-button:hover::before {
  left: 100%;
}

.fangio-header .nav-button:hover {
  transform: translateY(-4px);
  box-shadow: 
    0 15px 35px rgba(102, 126, 234, 0.4),
    inset 0 1px 0 rgba(255, 255, 255, 0.3);
}

.fangio-header .nav-button .icon {
  font-size: 1.3em;
  color: #ffffff;
  transition: transform 0.3s ease;
}

.fangio-header .nav-button:hover .icon {
  transform: scale(1.1) rotate(5deg);
}

/* Responsive moderno */
@media (max-width: 1024px) {
  .fangio-header-inner {
    min-width: 600px;
    padding: 32px 40px;
    gap: 32px;
  }
  
  .fangio-title {
    font-size: 3rem;
  }
}

@media (max-width: 768px) {
  .fangio-header-inner {
    flex-direction: column;
    text-align: center;
    min-width: auto;
    width: calc(100% - 80px);
    gap: 24px;
    padding: 32px 24px;
  }
  
  .fangio-title {
    font-size: 2.5rem;
  }
  
  .fangio-subtitle {
    font-size: 1.2rem;
  }
}

.btn-institucional {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  background: linear-gradient(90deg, #00bcd4 60%, #1e88e5 100%);
  color: #fff;
  font-weight: 700;
  font-size: 1.08rem;
  padding: 12px 26px;
  border-radius: 14px;
  text-decoration: none;
  box-shadow: 0 2px 12px rgba(30,136,229,0.10);
  margin-left: auto;
  transition: background 0.2s, box-shadow 0.2s, color 0.2s;
  border: none;
  outline: none;
}
.btn-institucional:hover {
  background: linear-gradient(90deg, #1e88e5 60%, #00bcd4 100%);
  color: #fff;
  box-shadow: 0 4px 18px rgba(30,136,229,0.18);
  text-decoration: none;
}
@media (max-width: 700px) {
  .btn-institucional {
   display: none;
  }
}
.fangio-tower-bg {
  position: absolute;
  bottom: 0;
  left: 0;
  height: 100%;
  width: 160px;
  pointer-events: none;
  z-index: 0;
  opacity: 0.18;
  display: flex;
  align-items: flex-end;
  justify-content: flex-start;
}
.fangio-tower-bg svg {
  height: 90%;
  width: auto;
  min-width: 80px;
  max-width: 120px;
  display: block;
}
.fangio-header .nav-button {
  position: absolute;
  right: 50px;
  top: 50%;
  transform: translateY(-50%);
  display: inline-flex;
  align-items: center;
  gap: 12px;
  padding: 16px 32px;
  background: #1e40af;
  color: #ffffff;
  border: 2px solid #3b82f6;
  border-radius: 12px;
  font-size: 1.1rem;
  font-weight: 600;
  text-decoration: none;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 6px 20px rgba(30, 64, 175, 0.25);
  font-family: 'Inter', 'Segoe UI', sans-serif;
  letter-spacing: 0.02em;
}

.fangio-header .nav-button:hover {
  background: #1d4ed8;
  border-color: #60a5fa;
  transform: translateY(-50%) translateX(-2px);
  box-shadow: 0 8px 25px rgba(30, 64, 175, 0.35);
}

.fangio-header .nav-button .icon {
  font-size: 1.2em;
  color: #ffffff;
  transition: transform 0.3s ease;
}

.fangio-header .nav-button:hover .icon {
  transform: scale(1.1);
}
@media (max-width: 900px) {
  .fangio-tower-bg {
    opacity: 0.10;
    width: 80px;
  }
  .fangio-tower-bg svg {
    min-width: 40px;
    max-width: 60px;
  }
}
#mapa-enlaces {
  margin-left: 340px; 
}
table, th, td {
  white-space: nowrap;
  vertical-align: middle;
}
tbody tr {
  height: 36px;
  min-height: 36px;
  max-height: 40px;
}
#panel-detalle-enlace {
  display: none;
  position: fixed;
  right: 0;
  top: 120px;
  width: 340px;
  max-width: 95vw;
  height: calc(100vh - 120px); 
  background: #fff;
  color: #222;
  border-radius: 18px 0 0 18px;
  box-shadow: 2px 0 18px #00bcd455;
  z-index: 2000;
  padding: 24px 18px 24px 18px;
  overflow-y: auto;
  font-size: 1rem;
}
#mapa-enlaces {
  margin-left: 0 !important;
  margin-right: 340px !important;
}
@media (max-width: 700px) {
  #panel-detalle-enlace {
    width: 98vw;
    border-radius: 0 0 18px 18px;
    height: auto;
    max-height: 80vh;
  }
  #mapa-enlaces {
    margin-left: 0 !important;
  }
}
#panel-detalle-enlace {
  z-index: 999999 !important;
  top: 0 !important;
  height: 100vh !important;
}
#detalle-enlace-contenido {
  padding-bottom: 40px;
}
#panel-detalle-enlace {
  top: 0 !important;
  height: 100vh !important;
  max-height: 100vh !important;
  overflow-y: auto !important;
}
.table-container {
  max-width: 100vw;
  overflow-x: auto;
  margin-bottom: 24px;
}
#tab-mismoTransporte .table-container {
  max-height: 60vh;
  overflow-y: auto;
}
#tab-mismoTransporte {
  overflow: visible !important;
}
#tab-mismoTransporte table {
  font-size: 13px;
  border-radius: 12px;
  background: #101a2a;
}
#tab-mismoTransporte th, #tab-mismoTransporte td {
  padding: 7px 10px;
  border-bottom: 1px solid #1e88e533;
  white-space: nowrap;
}
#tab-mismoTransporte th {
  background: #0b111f;
  color: #00e6ff;
  position: sticky;
  top: 0;
  z-index: 2;
}
#tab-mismoTransporte tr:hover {
  background: #1e88e522;
}
#tab-mismoTransporte .table-container {
  max-width: 100vw;
  overflow-x: auto;
  background: #101a2a;
  border-radius: 14px;
  border: 1.5px solid #00e6ff44;
  box-shadow: 0 2px 18px #00e6ff22;
  margin-bottom: 18px;
  padding: 0;
}
#tab-mismoTransporte table {
  font-size: 13px;
  border-radius: 12px;
  background: #101a2a;
  min-width: 1200px;
}
#tab-mismoTransporte th, #tab-mismoTransporte td {
  padding: 7px 10px;
  border-bottom: 1px solid #1e88e533;
  white-space: nowrap;
  text-align: center;
}
#tab-mismoTransporte th {
  background: #0b111f;
  color: #00e6ff;
  position: sticky;
  top: 0;
  z-index: 2;
  font-size: 13px;
  letter-spacing: 0.5px;
}
#tab-mismoTransporte tr:hover {
  background: #1e88e522;
}
#tab-mismoTransporte td:last-child {
  min-width: 120px;
  max-width: 140px;
  text-align: center;
  white-space: nowrap;
  overflow: hidden;
}
#tab-mismoTransporte button.btn-info {
  padding: 4px 10px;
  font-size: 12px;
  border-radius: 8px;
}
#tab-mismoTransporte .action-buttons {
  display: flex;
  gap: 12px;
  margin-bottom: 10px;
  flex-wrap: wrap;
}
#tab-mismoTransporte .enlaces-counter {
  margin-bottom: 8px;
  font-size: 1.08rem;
  color: #00e6ff;
  font-weight: 600;
}
#tab-mismoTransporte table {
  font-size: 13px;
  border-radius: 12px;
  background: #101a2a;
}
#tab-mismoTransporte th, #tab-mismoTransporte td {
  padding: 7px 10px;
  border-bottom: 1px solid #1e88e533;
  white-space: nowrap;
}
#tab-mismoTransporte th {
  background: #0b111f;
  color: #00e6ff;
  position: sticky;
  top: 0;
  z-index: 2;
}
#tab-mismoTransporte tr:hover {
  background: #1e88e522;
}
.fangio-video-wrapper {
  position: relative;
  width: 100%;
  max-width: 600px;
  aspect-ratio: 16/9;
  margin: 32px auto 0 auto;
  border-radius: 22px;
  overflow: hidden;
  box-shadow: 0 0 32px #00e6ff66, 0 2px 18px #00e6ff33;
  background: linear-gradient(135deg, #0b111f 60%, #1e88e5 100%);
  display: flex;
  align-items: center;
  justify-content: center;
}
.fangio-video-glow {
  position: absolute;
  inset: 0;
  border-radius: 22px;
  pointer-events: none;
  z-index: 1;
  box-shadow: 0 0 60px 10px #00e6ff88, 0 0 0 8px #00e6ff33 inset;
  animation: fangio-glow 2.5s infinite alternate;
}
@keyframes fangio-glow {
  0% { box-shadow: 0 0 60px 10px #00e6ff88, 0 0 0 8px #00e6ff33 inset; }
  100% { box-shadow: 0 0 90px 18px #00e6ffcc, 0 0 0 12px #00e6ff44 inset; }
}
.fangio-video {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 22px;
  z-index: 2;
  background: #000;
  display: block;
}
@media (max-width: 700px) {
  .fangio-video-wrapper {
    max-width: 98vw;
    border-radius: 12px;
  }
  .fangio-video-glow {
    border-radius: 12px;
  }
  .fangio-video {
    border-radius: 12px;
  }
}
.video-hero-bg {
  display: flex;
  justify-content: center;
  align-items: center;
  width: 100%;
  max-width: 700px;
  margin: 40px auto 32px auto;
  background: linear-gradient(135deg, #101a2a 60%, #1e88e5 100%);
  border-radius: 24px;
  box-shadow: 0 8px 40px #00e6ff22, 0 2px 18px #00e6ff11;
  padding: 0;
  overflow: hidden;
}
.video-hero {
  width: 100%;
  aspect-ratio: 16/9;
  border-radius: 24px;
  object-fit: cover;
  display: block;
  box-shadow: 0 2px 24px #000a;
}
@media (max-width: 900px) {
  .video-hero-bg { max-width: 98vw; border-radius: 12px; }
  .video-hero { border-radius: 12px; }
}
.video-banner {
  width: 100%;
  max-width: 1200px;
  height: 280px;
  margin: 32px auto 32px auto;
  position: relative;
  overflow: hidden;
  border-radius: 0;
  box-shadow: none;
  background: #000;
  display: flex;
  align-items: center;
  justify-content: center;
}
.video-banner-video {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
  border-radius: 0;
  box-shadow: none;
  background: #000;
}
.video-banner-overlay {
  position: absolute;
  left: 0; top: 0; width: 100%; height: 100%;
  display: flex; align-items: center; justify-content: center;
  color: #fff;
  font-size: 2.2rem;
  font-weight: 800;
  background: rgba(0,0,0,0.18);
  text-shadow: 0 2px 16px #000;
  pointer-events: none;
}
@media (max-width: 900px) {
  .video-banner { height: 180px; }
  .video-banner-overlay { font-size: 1.2rem; }
}
.banner-hero {
  position: relative;
  width: 100%;
  min-height: 220px;
  max-height: 320px;
  height: 280px;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  border-radius: 0 0 32px 32px;
  margin-bottom: 32px;
  background: none;
  box-shadow: 0 8px 40px #00e6ff22, 0 2px 18px #00e6ff11;
}
.banner-hero video {
  position: absolute;
  top: 0; left: 0;
  width: 100%;
  height: 100%;
  min-height: 220px;
  max-height: 320px;
  object-fit: cover;
  filter: blur(0.01px) brightness(0.95);
  opacity: 0.96;
  z-index: 0;
  border-radius: 0 0 32px 32px;
}
.banner-hero-overlay {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2;
  background: linear-gradient(120deg, rgba(11,17,31,0.55) 60%, rgba(30,136,229,0.18) 100%);
  pointer-events: none;
}

.banner-hero-content {
  display: flex;
  align-items: center;
  gap: 32px;
  z-index: 3;
  background: rgba(10,20,40,0.72);
  border-radius: 22px;
  padding: 32px 38px;
  box-shadow: 0 4px 32px #00e6ff22;
  pointer-events: auto;
  margin: 0 auto;
}
  
.banner-hero-logo {
  width: 90px;
  height: 90px;
  border-radius: 18px;
  background: #fff;
  box-shadow: 0 2px 12px #00e6ff33;
  margin-right: 18px;
}
.banner-hero-title {
  font-size: 2.8rem;
  font-weight: 800;
  color: #00e6ff;
  text-shadow: 0 0 18px #00e6ff55, 0 2px 8px #1e88e5cc;
  margin: 0 0 10px 0;
  letter-spacing: 2px;
}
.banner-hero-subtitle {
  font-size: 1.3rem;
  color: #2196f3;
  font-weight: 600;
  margin-bottom: 10px;
  letter-spacing: 1px;
  text-shadow: 0 1px 8px #1e88e555;
}
.banner-hero-link {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  background: linear-gradient(90deg, #00bcd4 60%, #1e88e5 100%);
  color: #fff;
  font-weight: 700;
  font-size: 1.08rem;
  padding: 12px 26px;
  border-radius: 14px;
  text-decoration: none;
  box-shadow: 0 2px 12px rgba(30,136,229,0.10);
  margin-top: 8px;
  transition: background 0.2s, box-shadow 0.2s, color 0.2s;
  border: none;
  outline: none;
}
.banner-hero-link:hover {
  background: linear-gradient(90deg, #1e88e5 60%, #00bcd4 100%);
  color: #fff;
  box-shadow: 0 4px 18px rgba(30,136,229,0.18);
  text-decoration: none;
}
@media (max-width: 900px) {
  .banner-hero {
    min-height: 120px;
    max-height: 180px;
    height: 160px;
    border-radius: 0 0 18px 18px;
  }
  .banner-hero-logo {
    margin: 0 0 10px 0;
  }
  .banner-hero-title {
    font-size: 1.7rem;
  }
  .banner-hero-subtitle {
    font-size: 1.05rem;
  }
  .banner-hero {
    min-height: 160px;
    max-height: 220px;
    border-radius: 0 0 18px 18px;
  }
  .banner-hero-video {
    min-height: 160px;
    max-height: 220px;
  }
}
.container {
  .container,
.fangio-header,
.fangio-header-decoration,
.banner-hero,
.banner-hero::before,
.banner-hero::after {
  background: none !important;
  box-shadow: none !important;
}
}
#toggleMismoTransporte {
  position: relative;
  font-weight: 700;
  border: 2.5px solid #00e6ff;
  background: linear-gradient(90deg, #00bcd4 60%, #1e88e5 100%);
  color: #fff;
  box-shadow: 0 2px 12px #00e6ff33;
  transition: background 0.2s, color 0.2s, border 0.2s, box-shadow 0.2s;
  outline: none;
  min-width: 320px;
  padding-right: 48px;
}
#toggleMismoTransporte.btn-outline-info {
  background: #0b111f;
  color: #00e6ff;
  border: 2.5px solid #00e6ff;
  box-shadow: none;
}
#toggleMismoTransporte.btn-info {
  background: linear-gradient(90deg, #00e6ff 60%, #00bcd4 100%);
  color: #0b111f;
  border: 2.5px solid #00e6ff;
  box-shadow: 0 4px 18px #00e6ff44;
}
#toggleMismoTransporte .toggle-icon {
  position: absolute;
  right: 18px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 1.5em;
  transition: color 0.2s;
}
#toggleMismoTransporte.btn-info .toggle-icon {
  color: #10b981;
  text-shadow: 0 0 8px #10b98188;
}
#toggleMismoTransporte.btn-outline-info .toggle-icon {
  color: #888;
  text-shadow: none;
}
button, .tab-button, .btn {
  transition: background 0.2s, color 0.2s, box-shadow 0.2s, transform 0.15s;
}
button:hover, .tab-button:hover, .btn:hover {
  transform: translateY(-2px) scale(1.03);
}
.badge {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 0.95em;
  font-weight: 700;
  color: #fff;
}
.badge-factible { background: #10b981; }
.badge-nofactible { background: #ef4444; }
.badge-indef { background: #f59e42; }
body.modo-claro {
  background: #f5f7fa;
  color: #222;
}
body.modo-claro .main-content,
body.modo-claro .table-container {
  background: #fff !important;
  color: #222 !important;
}
#perfil-elevacion-con-torres {
  margin-left: 440px !important; /* Mueve 120px m√°s a la derecha */
  margin-right: 40px !important; /* Espacio desde el borde derecho */
  max-width: calc(100% - 480px) !important; /* Ajusta el ancho */
}

/* Ajuste para pantallas medianas */
@media (max-width: 1400px) {
  #perfil-elevacion-con-torres {
    margin-left: 400px !important;
  }
}

/* Ajuste para pantallas peque√±as */
@media (max-width: 1200px) {
  #perfil-elevacion-con-torres {
    margin-left: 360px !important;
  }
}

/* Ajuste para tablets */
@media (max-width: 900px) {
  #perfil-elevacion-con-torres {
    margin-left: 280px !important;
    margin-right: 40px !important;
    max-width: calc(100% - 320px) !important;
  }
}

/* Ajuste para m√≥viles */
@media (max-width: 600px) {
  #perfil-elevacion-con-torres {
    margin-left: 200px !important;
    margin-right: 20px !important;
    max-width: calc(100% - 220px) !important;
  }
}
body.modo-claro .badge-factible { background: #059669; }
body.modo-claro .badge-nofactible { background: #dc2626; }
body.modo-claro .badge-indef { background: #f59e42; }
.microwave-feasibility-dashboard {
  padding: 70px; /* Reducido de 40px a 20px */
  max-width: 1600px;
  margin: 0 auto;
  background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
  min-height: auto; /* Cambiado de 100vh a auto */
  
  /* Mantener la posici√≥n a la derecha */
  margin-left: 300px !important;
  margin-right: 40px !important;
  max-width: calc(100% - 160px) !important;
}
/* ===== DASHBOARD DE FACTIBILIDAD MICROONDAS - CSS COMPLETO ===== */


/* Header Especializado */
.dashboard-header {
  background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
  border-radius: 20px;
  padding: 20px;
  margin-bottom: 18px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  border: 1px solid rgba(59, 130, 246, 0.2);
  position: relative;
  overflow: hidden;
}

.dashboard-header::before {
  content: '';
  position: absolute;
  top: 0;
  right: 0;
  width: 200px;
  height: 200px;
  background: radial-gradient(circle, rgba(59, 130, 246, 0.1) 0%, transparent 70%);
  pointer-events: none;
}

.dashboard-title-section {
  margin-bottom: 32px;
}

.dashboard-title {
  font-size: 2.8rem;
  font-weight: 800;
  color: #60a5fa;
  margin: 0 0 16px 0;
  font-family: 'Inter', 'Segoe UI', sans-serif;
  letter-spacing: -0.02em;
}

.dashboard-subtitle {
  font-size: 1.2rem;
  color: #94a3b8;
  margin: 0;
  font-weight: 400;
  line-height: 1.6;
  font-family: 'Inter', 'Segoe UI', sans-serif;
}

/* Botones de Acci√≥n Especializados */
.dashboard-actions {
  display: flex;
  gap: 16px;
  flex-wrap: wrap;
}

.action-btn {
  display: inline-flex;
  align-items: center;
  gap: 10px;
  padding: 16px 28px;
  border: none;
  border-radius: 12px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  font-family: 'Inter', 'Segoe UI', sans-serif;
  color: #ffffff;
  min-width: 180px;
  justify-content: center;
}

.action-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
}

.btn-primary { background: #8b5cf6; }
.btn-primary:hover { background: #7c3aed; }
.btn-success { background: #059669; }
.btn-success:hover { background: #047857; }
.btn-info { background: #06b6d4; }
.btn-info:hover { background: #0891b2; }
.btn-warning { background: #d97706; }
.btn-warning:hover { background: #b45309; }
.btn-secondary { background: #475569; }
.btn-secondary:hover { background: #374151; }

/* M√©tricas T√©cnicas */
.technical-metrics {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 24px;
  margin-bottom: 32px;
}

.metric-card {
  background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
  border-radius: 16px;
  padding: 28px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  border: 1px solid rgba(59, 130, 246, 0.2);
  position: relative;
  overflow: hidden;
  transition: all 0.3s ease;
}

.metric-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
}

.metric-icon {
  width: 70px;
  height: 70px;
  border-radius: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 24px;
  font-size: 1.8em;
  color: #ffffff;
}

.metric-icon.blue { background: #06b6d4; }
.metric-icon.green { background: #059669; }
.metric-icon.orange { background: #d97706; }
.metric-icon.purple { background: #8b5cf6; }

.metric-content {
  margin-bottom: 24px;
}

.metric-title {
  font-size: 0.9rem;
  font-weight: 600;
  color: #94a3b8;
  margin: 0 0 12px 0;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  font-family: 'Inter', 'Segoe UI', sans-serif;
}

.metric-value {
  font-size: 2.8rem;
  font-weight: 800;
  color: #ffffff;
  margin: 0 0 12px 0;
  font-family: 'Inter', 'Segoe UI', sans-serif;
}

.metric-change {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 16px;
  border-radius: 10px;
  font-size: 0.9rem;
  font-weight: 600;
  font-family: 'Inter', 'Segoe UI', sans-serif;
  margin-bottom: 8px;
}

.metric-change.positive {
  background: rgba(34, 197, 94, 0.2);
  color: #22c55e;
}

.metric-change.negative {
  background: rgba(239, 68, 68, 0.2);
  color: #ef4444;
}

.metric-change.neutral {
  background: rgba(148, 163, 184, 0.2);
  color: #94a3b8;
}

.metric-subtitle {
  font-size: 0.9rem;
  color: #64748b;
  font-weight: 500;
  font-family: 'Inter', 'Segoe UI', sans-serif;
}

.metric-bar {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 4px;
  border-radius: 0 0 16px 16px;
}

.metric-bar.blue { background: linear-gradient(90deg, #06b6d4, #0891b2); }
.metric-bar.green { background: linear-gradient(90deg, #059669, #047857); }
.metric-bar.orange { background: linear-gradient(90deg, #d97706, #b45309); }
.metric-bar.purple { background: linear-gradient(90deg, #8b5cf6, #7c3aed); }

/* An√°lisis de Frecuencias */
.frequency-analysis {
  background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
  border-radius: 20px;
  padding: 32px;
  margin-bottom: 32px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  border: 1px solid rgba(59, 130, 246, 0.2);
}

.analysis-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 24px;
  flex-wrap: wrap;
  gap: 16px;
}

.analysis-title {
  font-size: 1.5rem;
  font-weight: 700;
  color: #ffffff;
  margin: 0;
  font-family: 'Inter', 'Segoe UI', sans-serif;
}

.frequency-legend {
  display: flex;
  gap: 20px;
  flex-wrap: wrap;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 8px;
  color: #94a3b8;
  font-size: 0.9rem;
  font-family: 'Inter', 'Segoe UI', sans-serif;
}

.legend-color {
  width: 16px;
  height: 16px;
  border-radius: 4px;
}

.legend-color.green { background: #059669; }
.legend-color.blue { background: #06b6d4; }
.legend-color.orange { background: #d97706; }

.frequency-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
}

.frequency-card {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 12px;
  padding: 24px;
  border: 1px solid rgba(255, 255, 255, 0.1);
  text-align: center;
  transition: all 0.3s ease;
}

.frequency-card:hover {
  transform: translateY(-2px);
  background: rgba(255, 255, 255, 0.08);
}

.frequency-card.green { border-color: rgba(5, 150, 105, 0.3); }
.frequency-card.blue { border-color: rgba(6, 182, 212, 0.3); }
.frequency-card.orange { border-color: rgba(217, 119, 6, 0.3); }

.frequency-range {
  font-size: 1.1rem;
  font-weight: 700;
  color: #ffffff;
  margin-bottom: 8px;
  font-family: 'Inter', 'Segoe UI', sans-serif;
}

.frequency-value {
  font-size: 2rem;
  font-weight: 800;
  color: #60a5fa;
  margin-bottom: 8px;
  font-family: 'Inter', 'Segoe UI', sans-serif;
}

.frequency-description {
  font-size: 0.9rem;
  color: #94a3b8;
  margin-bottom: 12px;
  font-family: 'Inter', 'Segoe UI', sans-serif;
  line-height: 1.4;
}

.frequency-count {
  font-size: 1rem;
  font-weight: 600;
  color: #ffffff;
  font-family: 'Inter', 'Segoe UI', sans-serif;
}

/* Estado de Enlaces */
.link-status-section {
  background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
  border-radius: 20px;
  padding: 32px;
  margin-bottom: 32px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  border: 1px solid rgba(59, 130, 246, 0.2);
}

.status-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 24px;
}

.status-title {
  font-size: 1.5rem;
  font-weight: 700;
  color: #ffffff;
  margin: 0;
  font-family: 'Inter', 'Segoe UI', sans-serif;
}

.refresh-btn {
  background: rgba(59, 130, 246, 0.2);
  border: 1px solid rgba(59, 130, 246, 0.3);
  border-radius: 8px;
  padding: 10px 14px;
  color: #60a5fa;
  cursor: pointer;
  transition: all 0.3s ease;
}

.refresh-btn:hover {
  background: rgba(59, 130, 246, 0.3);
  transform: rotate(180deg);
}

.status-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 20px;
}

.status-item {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 20px;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 12px;
  border: 1px solid rgba(255, 255, 255, 0.1);
  transition: all 0.3s ease;
}

.status-item:hover {
  background: rgba(255, 255, 255, 0.08);
  transform: translateX(4px);
}

.status-icon {
  width: 50px;
  height: 50px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.3em;
  color: #ffffff;
  flex-shrink: 0;
}

.status-icon.green { background: #059669; }
.status-icon.orange { background: #d97706; }
.status-icon.red { background: #ef4444; }
.status-icon.blue { background: #06b6d4; }

.status-content {
  flex: 1;
}

.status-name {
  font-size: 1.1rem;
  font-weight: 700;
  color: #ffffff;
  margin: 0 0 6px 0;
  font-family: 'Inter', 'Segoe UI', sans-serif;
}

.status-details {
  font-size: 0.9rem;
  color: #94a3b8;
  margin: 0 0 4px 0;
  font-family: 'Inter', 'Segoe UI', sans-serif;
}

.status-time {
  font-size: 0.8rem;
  color: #64748b;
  font-family: 'Inter', 'Segoe UI', sans-serif;
}

/* Actividad T√©cnica */
.technical-activity {
  background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
  border-radius: 20px;
  padding: 32px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  border: 1px solid rgba(59, 130, 246, 0.2);
}

.activity-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 24px;
  flex-wrap: wrap;
  gap: 16px;
}

.activity-title {
  font-size: 1.5rem;
  font-weight: 700;
  color: #ffffff;
  margin: 0;
  font-family: 'Inter', 'Segoe UI', sans-serif;
}

.activity-filters {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.filter-btn {
  background: rgba(148, 163, 184, 0.2);
  border: 1px solid rgba(148, 163, 184, 0.3);
  border-radius: 8px;
  padding: 8px 16px;
  color: #94a3b8;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 0.9rem;
  font-family: 'Inter', 'Segoe UI', sans-serif;
}

.filter-btn.active,
.filter-btn:hover {
  background: rgba(59, 130, 246, 0.2);
  border-color: rgba(59, 130, 246, 0.5);
  color: #60a5fa;
}

.activity-list {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.activity-item {
  display: flex;
  align-items: flex-start;
  gap: 16px;
  padding: 20px;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 12px;
  border: 1px solid rgba(255, 255, 255, 0.1);
  transition: all 0.3s ease;
}

.activity-item:hover {
  background: rgba(255, 255, 255, 0.08);
  transform: translateX(4px);
}

.activity-icon {
  width: 45px;
  height: 45px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.1em;
  color: #ffffff;
  flex-shrink: 0;
}

.activity-icon.blue { background: #06b6d4; }
.activity-icon.orange { background: #d97706; }
.activity-icon.green { background: #059669; }
.activity-icon.purple { background: #8b5cf6; }

.activity-content {
  flex: 1;
}

.activity-text {
  font-size: 1rem;
  color: #e2e8f0;
  margin: 0 0 6px 0;
  font-weight: 500;
  font-family: 'Inter', 'Segoe UI', sans-serif;
  line-height: 1.4;
}

.activity-time {
  font-size: 0.9rem;
  color: #94a3b8;
  font-weight: 400;
  font-family: 'Inter', 'Segoe UI', sans-serif;
  margin-right: 12px;
}

.activity-status {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 6px;
  font-size: 0.8rem;
  font-weight: 600;
  font-family: 'Inter', 'Segoe UI', sans-serif;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.activity-status.success {
  background: rgba(34, 197, 94, 0.2);
  color: #22c55e;
}

.activity-status.warning {
  background: rgba(245, 158, 11, 0.2);
  color: #f59e0b;
}

.activity-status.info {
  background: rgba(6, 182, 212, 0.2);
  color: #06b6d4;
}

/* Responsive */
@media (max-width: 768px) {
  .microwave-feasibility-dashboard {
    padding: 20px;
  }
  
  .dashboard-header {
    padding: 24px;
  }
  
  .dashboard-title {
    font-size: 2.2rem;
  }
  
  .dashboard-actions {
    gap: 12px;
  }
  
  .action-btn {
    min-width: 150px;
    padding: 14px 20px;
    font-size: 0.9rem;
  }
  
  .technical-metrics {
    grid-template-columns: 1fr;
    gap: 16px;
  }
  
  .metric-card {
    padding: 24px;
  }
  
  .metric-value {
    font-size: 2.2rem;
  }
  
  .frequency-grid {
    grid-template-columns: 1fr;
  }
  
  .status-grid {
    grid-template-columns: 1fr;
  }
  
  .analysis-header,
  .activity-header {
    flex-direction: column;
    align-items: flex-start;
  }
}
.massive-processing-progress {
  background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
  border-radius: 20px;
  padding: 24px;
  margin-bottom: 24px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  border: 1px solid rgba(59, 130, 246, 0.2);
}

.progress-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 20px;
}

.progress-header h3 {
  color: #ffffff;
  margin: 0;
  font-size: 1.3rem;
}

.cancel-btn {
  background: #ef4444;
  color: #ffffff;
  border: none;
  border-radius: 8px;
  padding: 8px 16px;
  cursor: pointer;
  font-size: 0.9rem;
  transition: all 0.3s ease;
}

.cancel-btn:hover {
  background: #dc2626;
  transform: translateY(-1px);
}

.progress-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 16px;
  margin-bottom: 20px;
}

.progress-stats span {
  color: #94a3b8;
  font-size: 0.9rem;
  font-weight: 500;
}

.progress-bar-container {
  background: rgba(255, 255, 255, 0.1);
  border-radius: 10px;
  height: 20px;
  overflow: hidden;
  margin-bottom: 16px;
}

.progress-bar {
  background: linear-gradient(90deg, #06b6d4, #0891b2);
  height: 100%;
  width: 0%;
  transition: width 0.3s ease;
  border-radius: 10px;
}

.progress-details {
  color: #94a3b8;
  font-size: 0.9rem;
  text-align: center;
}

.progress-complete {
  text-align: center;
  color: #ffffff;
}

.progress-complete h3 {
  color: #22c55e;
  margin-bottom: 16px;
}

.completion-stats {
  margin-bottom: 20px;
}

.completion-stats p {
  margin: 8px 0;
  color: #94a3b8;
}

.close-btn {
  background: #64748b;
  color: #ffffff;
  border: none;
  border-radius: 8px;
  padding: 10px 20px;
  cursor: pointer;
  font-size: 0.9rem;
  transition: all 0.3s ease;
}

.close-btn:hover {
  background: #475569;
}

.results-summary {
  background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
  border-radius: 20px;
  padding: 24px;
  margin-top: 24px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  border: 1px solid rgba(59, 130, 246, 0.2);
}

.results-summary h4 {
  color: #ffffff;
  margin: 0 0 16px 0;
  font-size: 1.2rem;
}

.results-summary ul {
  color: #94a3b8;
  margin: 0;
  padding-left: 20px;
}

.results-summary li {
  margin: 8px 0;
  font-size: 0.9rem;
}
.modal-progreso {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  backdrop-filter: blur(10px);
  z-index: 10000;
  display: flex;
  align-items: center;
  justify-content: center;
  animation: fadeIn 0.3s ease;
}

.modal-progreso-content {
  background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
  border-radius: 25px;
  width: 90%;
  max-width: 800px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
  border: 1px solid rgba(255, 255, 255, 0.1);
  animation: slideInUp 0.4s ease;
}

/* Header del Modal */
.modal-progreso-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 25px 30px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
  border-radius: 25px 25px 0 0;
}

.modal-progreso-title {
  display: flex;
  align-items: center;
  gap: 15px;
  color: white;
}

.modal-progreso-title i {
  font-size: 2rem;
  color: #fbbf24;
}

.modal-progreso-title h3 {
  margin: 0;
  font-size: 1.5rem;
  font-weight: 700;
}

.modal-progreso-close {
  background: rgba(255, 255, 255, 0.2);
  border: none;
  color: white;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
}

.modal-progreso-close:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: scale(1.1);
}

/* Cuerpo del Modal */
.modal-progreso-body {
  padding: 30px;
  color: white;
}

/* Informaci√≥n General */
.progreso-info {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.info-item {
  background: rgba(255, 255, 255, 0.1);
  padding: 20px;
  border-radius: 15px;
  text-align: center;
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.info-label {
  display: block;
  font-size: 0.9rem;
  color: #94a3b8;
  margin-bottom: 8px;
}

.info-value {
  display: block;
  font-size: 1.5rem;
  font-weight: 700;
  color: #fbbf24;
}

/* Barra de Progreso Principal */
.progreso-barra-principal {
  margin-bottom: 30px;
}

.progreso-texto {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.progreso-porcentaje {
  font-size: 1.8rem;
  font-weight: 700;
  color: #10b981;
}

.progreso-estado {
  font-size: 1rem;
  color: #94a3b8;
}

.progreso-barra {
  background: rgba(255, 255, 255, 0.1);
  height: 25px;
  border-radius: 15px;
  overflow: hidden;
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.progreso-fill {
  background: linear-gradient(90deg, #10b981, #059669, #047857);
  height: 100%;
  width: 0%;
  transition: width 0.5s ease;
  border-radius: 15px;
  position: relative;
  overflow: hidden;
}

.progreso-fill::after {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
  animation: shimmer 2s infinite;
}

@keyframes shimmer {
  0% { left: -100%; }
  100% { left: 100%; }
}

/* M√©tricas en Tiempo Real */
.progreso-metricas {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.metrica-item {
  display: flex;
  align-items: center;
  gap: 15px;
  background: rgba(255, 255, 255, 0.05);
  padding: 20px;
  border-radius: 15px;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.metrica-item i {
  font-size: 1.5rem;
  color: #3b82f6;
  width: 30px;
  text-align: center;
}

.metrica-content {
  flex: 1;
}

.metrica-label {
  display: block;
  font-size: 0.85rem;
  color: #94a3b8;
  margin-bottom: 5px;
}

.metrica-valor {
  display: block;
  font-size: 1.1rem;
  font-weight: 600;
  color: #f1f5f9;
}

/* Lote Actual */
.progreso-lote-actual {
  background: rgba(59, 130, 246, 0.1);
  padding: 25px;
  border-radius: 15px;
  margin-bottom: 30px;
  border: 1px solid rgba(59, 130, 246, 0.3);
}

.progreso-lote-actual h4 {
  margin: 0 0 15px 0;
  color: #3b82f6;
  font-size: 1.1rem;
}

.lote-info {
  display: flex;
  justify-content: space-between;
  margin-bottom: 15px;
  font-weight: 600;
  color: #e2e8f0;
}

.lote-barra {
  background: rgba(255, 255, 255, 0.1);
  height: 15px;
  border-radius: 10px;
  overflow: hidden;
}

.lote-fill {
  background: linear-gradient(90deg, #3b82f6, #1d4ed8);
  height: 100%;
  width: 0%;
  transition: width 0.3s ease;
  border-radius: 10px;
}

/* Log de Actividad */
.progreso-log {
  background: rgba(0, 0, 0, 0.3);
  padding: 25px;
  border-radius: 15px;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.progreso-log h4 {
  margin: 0 0 15px 0;
  color: #e2e8f0;
  font-size: 1.1rem;
}

.log-container {
  max-height: 150px;
  overflow-y: auto;
  background: rgba(0, 0, 0, 0.2);
  border-radius: 10px;
  padding: 15px;
}

.log-item {
  display: flex;
  gap: 15px;
  margin-bottom: 8px;
  font-size: 0.9rem;
  padding: 8px;
  border-radius: 8px;
  background: rgba(255, 255, 255, 0.05);
}

.log-time {
  color: #64748b;
  font-family: monospace;
  min-width: 80px;
}

.log-message {
  color: #e2e8f0;
}

/* Footer del Modal */
.modal-progreso-footer {
  display: flex;
  gap: 15px;
  padding: 25px 30px;
  border-top: 1px solid rgba(255, 255, 255, 0.1);
  background: rgba(0, 0, 0, 0.2);
  border-radius: 0 0 25px 25px;
  flex-wrap: wrap;
  justify-content: center;
}

.modal-progreso-footer .btn {
  padding: 12px 20px;
  border: none;
  border-radius: 10px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 8px;
  min-width: 140px;
  justify-content: center;
}

.modal-progreso-footer .btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
}

/* Estados de los botones */
.btn-success {
  background: linear-gradient(135deg, #10b981, #059669);
  color: white;
}

.btn-warning {
  background: linear-gradient(135deg, #f59e0b, #d97706);
  color: white;
}

.btn-danger {
  background: linear-gradient(135deg, #ef4444, #dc2626);
  color: white;
}

.btn-secondary {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  color: white;
}

/* Animaciones */
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideInUp {
  from {
    opacity: 0;
    transform: translateY(50px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Responsive */
@media (max-width: 768px) {
  .modal-progreso-content {
    width: 95%;
    margin: 20px;
  }
  
  .modal-progreso-body {
    padding: 20px;
  }
  
  .progreso-info {
    grid-template-columns: 1fr;
  }
  
  .progreso-metricas {
    grid-template-columns: 1fr;
  }
  
  .modal-progreso-footer {
    flex-direction: column;
  }
  
  .modal-progreso-footer .btn {
    width: 100%;
  }
}
/* ‚úÖ ESTILOS PARA TOOLTIPS MEJORADOS */
.leaflet-tooltip {
  background: white !important;
  border: 2px solid #00bcd4 !important;
  border-radius: 10px !important;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
  font-size: 12px !important;
  padding: 8px 12px !important;
}

.leaflet-tooltip::before {
  border-top-color: #00bcd4 !important;
}

/* ‚úÖ ESTILOS PARA POPUPS MEJORADOS */
.leaflet-popup-content-wrapper {
  border-radius: 12px !important;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3) !important;
}

.leaflet-popup-content {
  margin: 15px !important;
  font-size: 14px !important;
  line-height: 1.4 !important;
}

.leaflet-popup-tip {
  background: white !important;
  box-shadow: 0 2px 10px rgba(0,0,0,0.2) !important;
}

/* ‚úÖ ESTILOS PARA CONTROLES DE CAPAS */
.leaflet-control-layers {
  border-radius: 8px !important;
  box-shadow: 0 2px 10px rgba(0,0,0,0.2) !important;
}

.leaflet-control-layers-toggle {
  background: white !important;
  border: 2px solid #00bcd4 !important;
  border-radius: 6px !important;
  width: 36px !important;
  height: 36px !important;
}

.leaflet-control-layers-toggle:hover {
  background: #00bcd4 !important;
  color: white !important;
}

/* ‚úÖ ESTILOS PARA ESCALA */
.leaflet-control-scale {
  background: rgba(255, 255, 255, 0.9) !important;
  border-radius: 6px !important;
  padding: 4px 8px !important;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2) !important;
}

.leaflet-control-scale-line {
  border: 2px solid #00bcd4 !important;
  border-top: none !important;
  color: #333 !important;
  font-weight: bold !important;
}

/* ‚úÖ ESTILOS PARA FULLSCREEN */
.leaflet-control-fullscreen {
  background: white !important;
  border: 2px solid #00bcd4 !important;
  border-radius: 6px !important;
  width: 36px !important;
  height: 36px !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  font-size: 18px !important;
  color: #00bcd4 !important;
  transition: all 0.3s ease !important;
}

.leaflet-control-fullscreen:hover {
  background: #00bcd4 !important;
  color: white !important;
  transform: scale(1.1) !important;
}

/* ‚úÖ ESTILOS PARA MEDIDOR DE DISTANCIA */
.leaflet-control-measure {
  background: white !important;
  border: 2px solid #00bcd4 !important;
  border-radius: 6px !important;
  width: 36px !important;
  height: 36px !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  font-size: 18px !important;
  color: #00bcd4 !important;
  transition: all 0.3s ease !important;
}

.leaflet-control-measure:hover {
  background: #00bcd4 !important;
  color: white !important;
  transform: scale(1.1) !important;
}

/* ‚úÖ ESTILOS PARA IMPRESI√ìN */
.leaflet-control-print {
  background: white !important;
  border: 2px solid #00bcd4 !important;
  border-radius: 6px !important;
  width: 36px !important;
  height: 36px !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  font-size: 18px !important;
  color: #00bcd4 !important;
  transition: all 0.3s ease !important;
}

.leaflet-control-print:hover {
  background: #00bcd4 !important;
  color: white !important;
  transform: scale(1.1) !important;
}

/* ‚úÖ ESTILOS PARA EXPORTAR */
.leaflet-control-export {
  background: white !important;
  border: 2px solid #00bcd4 !important;
  border-radius: 6px !important;
  width: 36px !important;
  height: 36px !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  font-size: 18px !important;
  color: #00bcd4 !important;
  transition: all 0.3s ease !important;
}

.leaflet-control-export:hover {
  background: #00bcd4 !important;
  color: white !important;
  transform: scale(1.1) !important;
}

/* ‚úÖ ESTILOS PARA B√öSQUEDA AVANZADA */
.leaflet-control-search {
  background: white !important;
  border-radius: 8px !important;
  box-shadow: 0 2px 10px rgba(0,0,0,0.2) !important;
  min-width: 250px !important;
}

.leaflet-control-search .search-input {
  border: 2px solid #e5e7eb !important;
  border-radius: 6px !important;
  padding: 8px 12px !important;
  font-size: 14px !important;
  outline: none !important;
  transition: border-color 0.3s ease !important;
}

.leaflet-control-search .search-input:focus {
  border-color: #00bcd4 !important;
  box-shadow: 0 0 0 3px rgba(0, 188, 212, 0.1) !important;
}

.leaflet-control-search .search-button {
  background: #00bcd4 !important;
  border: none !important;
  border-radius: 6px !important;
  color: white !important;
  padding: 8px 16px !important;
  font-weight: 600 !important;
  cursor: pointer !important;
  transition: all 0.3s ease !important;
}

.leaflet-control-search .search-button:hover {
  background: #0284c7 !important;
  transform: translateY(-1px) !important;
}

/* ‚úÖ ESTILOS PARA FILTROS DE CAPAS */
.layer-filter {
  background: rgba(255, 255, 255, 0.95) !important;
  border-radius: 10px !important;
  padding: 15px !important;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
  min-width: 200px !important;
  z-index: 1000 !important;
}

.layer-filter h4 {
  margin: 0 0 15px 0 !important;
  color: #1e88e5 !important;
  font-size: 16px !important;
  text-align: center !important;
}

.layer-option {
  display: flex !important;
  align-items: center !important;
  margin: 10px 0 !important;
  padding: 8px !important;
  border-radius: 6px !important;
  transition: background-color 0.3s ease !important;
}

.layer-option:hover {
  background: rgba(0, 188, 212, 0.1) !important;
}

.layer-option input[type="checkbox"] {
  margin-right: 10px !important;
  accent-color: #00bcd4 !important;
}

.layer-option label {
  font-size: 14px !important;
  color: #333 !important;
  cursor: pointer !important;
  flex: 1 !important;
}

.layer-option .layer-count {
  background: #00bcd4 !important;
  color: white !important;
  padding: 2px 8px !important;
  border-radius: 12px !important;
  font-size: 12px !important;
  font-weight: bold !important;
}

/* ‚úÖ ESTILOS PARA PANEL DE INFORMACI√ìN */
.info-panel {
  background: rgba(255, 255, 255, 0.95) !important;
  border-radius: 10px !important;
  padding: 15px !important;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
  min-width: 250px !important;
  z-index: 1000 !important;
}

.info-panel h4 {
  margin: 0 0 15px 0 !important;
  color: #1e88e5 !important;
  font-size: 16px !important;
  text-align: center !important;
  border-bottom: 2px solid #e5e7eb !important;
  padding-bottom: 10px !important;
}

.info-item {
  display: flex !important;
  justify-content: space-between !important;
  margin: 8px 0 !important;
  padding: 5px 0 !important;
  border-bottom: 1px solid #f3f4f6 !important;
}

.info-item:last-child {
  border-bottom: none !important;
}

.info-label {
  font-weight: 600 !important;
  color: #374151 !important;
  font-size: 13px !important;
}

.info-value {
  color: #00bcd4 !important;
  font-weight: bold !important;
  font-size: 13px !important;
}

/* ‚úÖ ESTILOS PARA BOTONES DE ACCI√ìN */
.action-button {
  background: #00bcd4 !important;
  border: none !important;
  border-radius: 6px !important;
  color: white !important;
  padding: 8px 16px !important;
  font-size: 13px !important;
  font-weight: 600 !important;
  cursor: pointer !important;
  transition: all 0.3s ease !important;
  margin: 5px !important;
  display: inline-block !important;
}

.action-button:hover {
  background: #0284c7 !important;
  transform: translateY(-2px) !important;
  box-shadow: 0 4px 12px rgba(0, 188, 212, 0.3) !important;
}

.action-button.secondary {
  background: #6c757d !important;
}

.action-button.secondary:hover {
  background: #5a6268 !important;
}

.action-button.danger {
  background: #ef4444 !important;
}

.action-button.danger:hover {
  background: #dc2626 !important;
}

/* ‚úÖ ESTILOS PARA NOTIFICACIONES TOAST */
.toast-notification {
  position: fixed !important;
  top: 20px !important;
  right: 20px !important;
  background: #00bcd4 !important;
  color: white !important;
  padding: 15px 20px !important;
  border-radius: 8px !important;
  box-shadow: 0 4px 15px rgba(0, 188, 212, 0.3) !important;
  z-index: 10000 !important;
  max-width: 300px !important;
  animation: slideInRight 0.3s ease !important;
}

.toast-notification.success {
  background: #10b981 !important;
}

.toast-notification.warning {
  background: #f59e0b !important;
}

.toast-notification.error {
  background: #ef4444 !important;
}

@keyframes slideInRight {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

/* ‚úÖ ESTILOS PARA MODAL DE CONFIRMACI√ìN */
.confirm-modal {
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  width: 100vw !important;
  height: 100vh !important;
  background: rgba(0, 0, 0, 0.8) !important;
  display: none !important;
  align-items: center !important;
  justify-content: center !important;
  z-index: 10000 !important;
}

.confirm-modal.show {
  display: flex !important;
}

.confirm-content {
  background: white !important;
  border-radius: 15px !important;
  padding: 30px !important;
  max-width: 400px !important;
  width: 90% !important;
  text-align: center !important;
  box-shadow: 0 8px 25px rgba(0,0,0,0.3) !important;
}

.confirm-content h3 {
  margin: 0 0 20px 0 !important;
  color: #1e88e5 !important;
  font-size: 20px !important;
}

.confirm-content p {
  margin: 0 0 25px 0 !important;
  color: #666 !important;
  font-size: 16px !important;
  line-height: 1.5 !important;
}

.confirm-buttons {
  display: flex !important;
  gap: 15px !important;
  justify-content: center !important;
}

.confirm-btn {
  padding: 12px 24px !important;
  border: none !important;
  border-radius: 8px !important;
  font-size: 14px !important;
  font-weight: 600 !important;
  cursor: pointer !important;
  transition: all 0.3s ease !important;
  min-width: 100px !important;
}

.confirm-btn.confirm {
  background: #00bcd4 !important;
  color: white !important;
}

.confirm-btn.cancel {
  background: #6c757d !important;
  color: white !important;
}

.confirm-btn:hover {
  transform: translateY(-2px) !important;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2) !important;
}

/* ‚úÖ ESTILOS PARA LOADING SPINNER */
.loading-spinner-container {
  display: flex !important;
  flex-direction: column !important;
  align-items: center !important;
  justify-content: center !important;
  padding: 20px !important;
}

.spinner {
  width: 40px !important;
  height: 40px !important;
  border: 4px solid #f3f3f3 !important;
  border-top: 4px solid #00bcd4 !important;
  border-radius: 50% !important;
  animation: spin 1s linear infinite !important;
  margin-bottom: 15px !important;
}

.loading-text {
  color: #666 !important;
  font-size: 14px !important;
  font-weight: 600 !important;
  text-align: center !important;
}

/* ‚úÖ ESTILOS PARA PROGRESS BAR */
.progress-container {
  width: 100% !important;
  background: #e5e7eb !important;
  border-radius: 10px !important;
  overflow: hidden !important;
  margin: 10px 0 !important;
}

.progress-bar {
  height: 8px !important;
  background: #00bcd4 !important;
  border-radius: 10px !important;
  transition: width 0.3s ease !important;
  position: relative !important;
}

.progress-bar::after {
  content: '' !important;
  position: absolute !important;
  top: 0 !important;
  left: 0 !important;
  right: 0 !important;
  bottom: 0 !important;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent) !important;
  animation: shimmer 2s infinite !important;
}

@keyframes shimmer {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(100%); }
}

/* ‚úÖ ESTILOS PARA BADGES */
.badge {
  display: inline-block !important;
  padding: 4px 8px !important;
  border-radius: 12px !important;
  font-size: 11px !important;
  font-weight: 600 !important;
  text-transform: uppercase !important;
  letter-spacing: 0.5px !important;
}

.badge.success {
  background: #d1fae5 !important;
  color: #065f46 !important;
}

.badge.warning {
  background: #fef3c7 !important;
  color: #92400e !important;
}

.badge.error {
  background: #fee2e2 !important;
  color: #991b1b !important;
}

.badge.info {
  background: #dbeafe !important;
  color: #1e40af !important;
}

/* ‚úÖ ESTILOS PARA TARJETAS */
.card {
  background: white !important;
  border-radius: 12px !important;
  padding: 20px !important;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1) !important;
  margin: 15px 0 !important;
  transition: all 0.3s ease !important;
}

.card:hover {
  transform: translateY(-2px) !important;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15) !important;
}

.card-header {
  border-bottom: 2px solid #f3f4f6 !important;
  padding-bottom: 15px !important;
  margin-bottom: 20px !important;
}

.card-title {
  margin: 0 !important;
  color: #1e88e5 !important;
  font-size: 18px !important;
  font-weight: 600 !important;
}

.card-body {
  color: #666 !important;
  line-height: 1.6 !important;
}

/* ‚úÖ ESTILOS PARA GRADIENTES */
.gradient-bg {
  background: linear-gradient(135deg, #00bcd4 0%, #0284c7 100%) !important;
}

.gradient-text {
  background: linear-gradient(135deg, #00bcd4 0%, #0284c7 100%) !important;
  -webkit-background-clip: text !important;
  -webkit-text-fill-color: transparent !important;
  background-clip: text !important;
}

/* ‚úÖ ESTILOS PARA SOMBRAS */
.shadow-sm {
  box-shadow: 0 1px 2px rgba(0,0,0,0.05) !important;
}

.shadow {
  box-shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06) !important;
}

.shadow-md {
  box-shadow: 0 4px 6px rgba(0,0,0,0.07), 0 2px 4px rgba(0,0,0,0.06) !important;
}

.shadow-lg {
  box-shadow: 0 10px 15px rgba(0,0,0,0.1), 0 4px 6px rgba(0,0,0,0.05) !important;
}

.shadow-xl {
  box-shadow: 0 20px 25px rgba(0,0,0,0.1), 0 10px 10px rgba(0,0,0,0.04) !important;
}

/* ‚úÖ ESTILOS PARA BORDES */
.border {
  border: 1px solid #e5e7eb !important;
}

.border-t {
  border-top: 1px solid #e5e7eb !important;
}

.border-b {
  border-bottom: 1px solid #e5e7eb !important;
}

.border-l {
  border-left: 1px solid #e5e7eb !important;
}

.border-r {
  border-right: 1px solid #e5e7eb !important;
}

.border-primary {
  border-color: #00bcd4 !important;
}

.border-success {
  border-color: #10b981 !important;
}

.border-warning {
  border-color: #f59e0b !important;
}

.border-error {
  border-color: #ef4444 !important;
}

/* ‚úÖ ESTILOS PARA UTILIDADES */
.text-center { text-align: center !important; }
.text-left { text-align: left !important; }
.text-right { text-align: right !important; }

.font-bold { font-weight: bold !important; }
.font-semibold { font-weight: 600 !important; }
.font-normal { font-weight: normal !important; }

.text-sm { font-size: 12px !important; }
.text-base { font-size: 14px !important; }
.text-lg { font-size: 16px !important; }
.text-xl { font-size: 18px !important; }

.text-primary { color: #00bcd4 !important; }
.text-success { color: #10b981 !important; }
.text-warning { color: #f59e0b !important; }
.text-error { color: #ef4444 !important; }
.text-gray { color: #6b7280 !important; }

.mt-1 { margin-top: 4px !important; }
.mt-2 { margin-top: 8px !important; }
.mt-3 { margin-top: 12px !important; }
.mt-4 { margin-top: 16px !important; }
.mt-5 { margin-top: 20px !important; }

.mb-1 { margin-bottom: 4px !important; }
.mb-2 { margin-bottom: 8px !important; }
.mb-3 { margin-bottom: 12px !important; }
.mb-4 { margin-bottom: 16px !important; }
.mb-5 { margin-bottom: 20px !important; }

.p-1 { padding: 4px !important; }
.p-2 { padding: 8px !important; }
.p-3 { padding: 12px !important; }
.p-4 { padding: 16px !important; }
.p-5 { padding: 20px !important; }

.rounded { border-radius: 6px !important; }
.rounded-lg { border-radius: 12px !important; }
.rounded-full { border-radius: 9999px !important; }

.hidden { display: none !important; }
.block { display: block !important; }
.flex { display: flex !important; }
.inline-block { display: inline-block !important; }

/* ‚úÖ ESTILOS PARA ANIMACIONES FINALES */
.fade-in {
  animation: fadeIn 0.5s ease-in !important;
}

.fade-out {
  animation: fadeOut 0.5s ease-out !important;
}

.slide-up {
  animation: slideUp 0.5s ease !important;
}

.slide-down {
  animation: slideDown 0.5s ease !important;
}

.bounce {
  animation: bounce 0.6s ease !important;
}

.pulse {
  animation: pulse 2s infinite !important;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes fadeOut {
  from { opacity: 1; }
  to { opacity: 0; }
}

@keyframes slideUp {
  from { transform: translateY(20px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

@keyframes slideDown {
  from { transform: translateY(-20px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

@keyframes bounce {
  0%, 20%, 53%, 80%, 100% { transform: translate3d(0,0,0); }
  40%, 43% { transform: translate3d(0,-30px,0); }
  70% { transform: translate3d(0,-15px,0); }
  90% { transform: translate3d(0,-4px,0); }
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}
/* ‚úÖ ESTILOS PARA CLUSTERS AVANZADOS */
.marker-cluster {
  background: linear-gradient(135deg, #00bcd4, #0284c7);
  border: 3px solid white;
  border-radius: 50%;
  color: white;
  font-weight: bold;
  text-align: center;
  box-shadow: 0 4px 15px rgba(0, 188, 212, 0.4);
  transition: all 0.3s ease;
}

.marker-cluster.small {
  background: linear-gradient(135deg, #10b981, #059669);
  transform: scale(0.8);
}

.marker-cluster.medium {
  background: linear-gradient(135deg, #f59e0b, #d97706);
  transform: scale(1);
}

.marker-cluster.large {
  background: linear-gradient(135deg, #ef4444, #dc2626);
  transform: scale(1.2);
}

.marker-cluster:hover {
  transform: scale(1.1);
  box-shadow: 0 6px 20px rgba(0, 188, 212, 0.6);
}

/* ‚úÖ ESTILOS PARA PANELES AVANZADOS */
.advanced-stats-panel,
.advanced-filters-panel {
  background: rgba(255, 255, 255, 0.98);
  border-radius: 15px;
  padding: 20px;
  box-shadow: 0 8px 25px rgba(0,0,0,0.15);
  min-width: 280px;
  backdrop-filter: blur(10px);
  border: 1px solid rgba(0, 188, 212, 0.2);
}

.stats-header,
.filter-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
  padding-bottom: 10px;
  border-bottom: 2px solid #e5e7eb;
}

.stats-header h4,
.filter-header h4 {
  margin: 0;
  color: #1e88e5;
  font-size: 16px;
  font-weight: 600;
}

.toggle-btn {
  background: #00bcd4;
  border: none;
  border-radius: 6px;
  color: white;
  width: 30px;
  height: 30px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.toggle-btn:hover {
  background: #0284c7;
  transform: scale(1.1);
}

/* ‚úÖ ESTILOS PARA FILTROS */
.filter-group {
  margin: 15px 0;
}

.filter-group label {
  display: block;
  margin: 5px 0;
  font-size: 13px;
  color: #374151;
  font-weight: 600;
}

.filter-group select,
.filter-group input {
  width: 100%;
  padding: 8px 12px;
  border: 2px solid #e5e7eb;
  border-radius: 8px;
  font-size: 13px;
  transition: all 0.3s ease;
}

.filter-group select:focus,
.filter-group input:focus {
  border-color: #00bcd4;
  box-shadow: 0 0 0 3px rgba(0, 188, 212, 0.1);
  outline: none;
}

.range-inputs {
  display: flex;
  align-items: center;
  gap: 10px;
}

.range-inputs input {
  flex: 1;
}

.range-inputs span {
  color: #6b7280;
  font-weight: bold;
}

/* ‚úÖ ESTILOS PARA BOTONES DE ACCI√ìN */
.action-btn,
.clear-btn,
.save-btn {
  padding: 8px 16px;
  border: none;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  margin: 5px;
}

.action-btn {
  background: #00bcd4;
  color: white;
}

.clear-btn {
  background: #6c757d;
  color: white;
}

.save-btn {
  background: #10b981;
  color: white;
}

.action-btn:hover,
.clear-btn:hover,
.save-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

/* ‚úÖ ESTILOS PARA RESPONSIVIDAD */
@media (max-width: 768px) {
  .advanced-stats-panel,
  .advanced-filters-panel {
    min-width: 250px;
    padding: 15px;
    font-size: 12px;
  }
  
  .stats-header h4,
  .filter-header h4 {
    font-size: 14px;
  }
  
  .filter-group label {
    font-size: 12px;
  }
  
  .filter-group select,
  .filter-group input {
    padding: 6px 10px;
    font-size: 12px;
  }
  
  .action-btn,
  .clear-btn,
  .save-btn {
    padding: 6px 12px;
    font-size: 11px;
  }
}

/* ‚úÖ ESTILOS PARA FULLSCREEN M√ìVIL */
.fullscreen-btn-mobile {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 50px;
  height: 50px;
  background: #00bcd4;
  border: none;
  border-radius: 50%;
  color: white;
  font-size: 24px;
  cursor: pointer;
  z-index: 1000;
  box-shadow: 0 4px 15px rgba(0, 188, 212, 0.3);
  transition: all 0.3s ease;
}

.fullscreen-btn-mobile:hover {
  background: #0284c7;
  transform: scale(1.1);
}

/* ‚úÖ ESTILOS PARA PANELES COLAPSABLES */
.advanced-stats-panel.collapsed .stats-content,
.advanced-filters-panel.collapsed .filter-content {
  display: none;
}

.advanced-stats-panel.collapsed,
.advanced-filters-panel.collapsed {
  min-width: 200px;
  padding: 15px;
}

/* ‚úÖ ESTILOS PARA NOTIFICACIONES */
.map-notification {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  padding: 12px 24px;
  border-radius: 25px;
  z-index: 10000;
  font-weight: bold;
  box-shadow: 0 4px 15px rgba(0,0,0,0.3);
  animation: slideDown 0.3s ease;
}

.map-notification.success {
  background: #10b981;
  color: white;
}

.map-notification.error {
  background: #ef4444;
  color: white;
}

.map-notification.warning {
  background: #f59e0b;
  color: white;
}

.map-notification.info {
  background: #00bcd4;
  color: white;
}

@keyframes slideDown {
  from { transform: translateX(-50%) translateY(-100%); opacity: 0; }
  to { transform: translateX(-50%) translateY(0); opacity: 1; }
}
/* Panel de Controles */
.panel-controles-mapa {
  background: rgba(255, 255, 255, 0.95);
  border-radius: 12px;
  padding: 16px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  min-width: 280px;
  backdrop-filter: blur(10px);
}

.panel-header h4 {
  margin: 0 0 12px 0;
  color: #1e88e5;
  font-size: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.control-group {
  margin: 12px 0;
}

.control-group label {
  display: block;
  font-size: 12px;
  color: #666;
  margin-bottom: 4px;
  font-weight: 600;
}

.control-group select,
.control-group input {
  width: 100%;
  padding: 8px;
  border: 1px solid #ddd;
  border-radius: 6px;
  font-size: 12px;
}

/* Estad√≠sticas Avanzadas */
.panel-estadisticas-avanzadas {
  background: rgba(255, 255, 255, 0.95);
  border-radius: 12px;
  padding: 16px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  min-width: 250px;
  backdrop-filter: blur(10px);
}

.stats-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}

.stats-header h4 {
  margin: 0;
  color: #1e88e5;
  font-size: 16px;
}

.stat-card {
  display: flex;
  align-items: center;
  gap: 12px;
  margin: 12px 0;
  padding: 12px;
  background: rgba(0,0,0,0.05);
  border-radius: 8px;
}

.stat-icon {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 18px;
}

.stat-icon.factible { background: #10b981; }
.stat-icon.no-factible { background: #ef4444; }
.stat-icon.total { background: #3b82f6; }

.stat-info {
  display: flex;
  flex-direction: column;
}

.stat-value {
  font-size: 20px;
  font-weight: 700;
  color: #1f2937;
}

.stat-label {
  font-size: 12px;
  color: #6b7280;
}

/* Barra de Progreso */
.stat-progress {
  margin-top: 16px;
}

.progress-bar {
  height: 8px;
  background: #e5e7eb;
  border-radius: 4px;
  overflow: hidden;
  margin-bottom: 8px;
}

.progress-fill {
  height: 100%;
  transition: width 0.3s ease;
}

.progress-fill.factible { background: #10b981; }
.progress-fill.no-factible { background: #ef4444; }

.progress-text {
  font-size: 12px;
  color: #6b7280;
  text-align: center;
  display: block;
}

/* Popups Mejorados */
.popup-enlace {
  min-width: 300px;
}

.popup-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
  padding-bottom: 8px;
  border-bottom: 1px solid #e5e7eb;
}

.popup-header.factible { border-color: #10b981; }
.popup-header.no-factible { border-color: #ef4444; }

.popup-header h4 {
  margin: 0;
  font-size: 16px;
  color: #1f2937;
}

.info-grid {
  display: grid;
  gap: 8px;
  margin-bottom: 16px;
}

.info-item {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
  color: #374151;
}

.info-item i {
  color: #6b7280;
  width: 16px;
}

.popup-actions {
  display: flex;
  gap: 8px;
}

.btn-popup {
  padding: 6px 12px;
  border: none;
  border-radius: 6px;
  background: #3b82f6;
  color: white;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.btn-popup:hover {
  background: #2563eb;
  transform: translateY(-1px);
}

/* Control de B√∫squeda */
.control-busqueda {
  background: rgba(255, 255, 255, 0.95);
  border-radius: 12px;
  padding: 16px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  min-width: 300px;
  backdrop-filter: blur(10px);
}

.search-container input {
  width: 100%;
  padding: 10px;
  border: 1px solid #ddd;
  border-radius: 8px;
  font-size: 14px;
  margin-bottom: 12px;
}

.search-filters {
  display: flex;
  gap: 8px;
}

.search-filters select {
  flex: 1;
  padding: 8px;
  border: 1px solid #ddd;
  border-radius: 6px;
  font-size: 12px;
}

/* Responsive */
@media (max-width: 768px) {
  .panel-controles-mapa,
  .panel-estadisticas-avanzadas,
  .control-busqueda {
    min-width: 250px;
    padding: 12px;
  }
  


  .search-filters {
    flex-direction: column;
  }
}
/* Estilos para el modal de Street View */
.modal-streetview {
  display: none;
  position: fixed;
  z-index: 10000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.8);
}

.modal-content {
  background-color: #fefefe;
  margin: 5% auto;
  padding: 0;
  border-radius: 12px;
  width: 90%;
  max-width: 800px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.3);
  overflow: hidden;
}

.modal-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-header h3 {
  margin: 0;
  font-size: 20px;
  font-weight: 600;
}

.close-btn {
  background: rgba(255,255,255,0.2);
  border: none;
  color: white;
  padding: 8px 12px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 18px;
  transition: all 0.3s ease;
}

.close-btn:hover {
  background: rgba(255,255,255,0.3);
  transform: scale(1.1);
}

.streetview-panorama {
  width: 100%;
  height: 500px;
  background: #f0f0f0;
  border-radius: 0 0 12px 12px;
}
/* Estilos para modal temporal */
.modal-streetview-temp {
  position: fixed;
  z-index: 10000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.8);
}

.modal-content {
  background-color: #fefefe;
  margin: 5% auto;
  padding: 0;
  border-radius: 12px;
  width: 90%;
  max-width: 800px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.3);
  overflow: hidden;
}

.modal-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-header h3 {
  margin: 0;
  font-size: 20px;
  font-weight: 600;
}

.close-btn {
  background: rgba(255,255,255,0.2);
  border: none;
  color: white;
  padding: 8px 12px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 18px;
  transition: all 0.3s ease;
}

.close-btn:hover {
  background: rgba(255,255,255,0.3);
  transform: scale(1.1);
}

.streetview-panorama {
  width: 100%;
  height: 500px;
  background: #f0f0f0;
  border-radius: 0 0 12px 12px;
}
/* Estilos para Street View completo */
.modal-streetview-completo {
  position: fixed;
  z-index: 10000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.9);
}

.modal-content-streetview {
  background-color: #fefefe;
  margin: 2% auto;
  padding: 0;
  border-radius: 12px;
  width: 95%;
  height: 90%;
  box-shadow: 0 8px 32px rgba(0,0,0,0.5);
  overflow: hidden;
}

.modal-header-streetview {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 15px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-header-streetview h3 {
  margin: 0;
  font-size: 18px;
  font-weight: 600;
}

.close-btn-streetview {
  background: rgba(255,255,255,0.2);
  border: none;
  color: white;
  padding: 8px 12px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 16px;
  transition: all 0.3s ease;
}

.close-btn-streetview:hover {
  background: rgba(255,255,255,0.3);
  transform: scale(1.1);
}

.streetview-container {
  display: flex;
  height: calc(100% - 60px);
}

.streetview-panorama-completo {
  flex: 1;
  background: #f0f0f0;
}

.streetview-controles {
  width: 200px;
  background: #f8f9fa;
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.btn-control {
  background: #007bff;
  color: white;
  border: none;
  padding: 12px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.3s ease;
}

.btn-control:hover {
  background: #0056b3;
  transform: translateY(-2px);
}

.streetview-fallback, .streetview-error {
  text-align: center;
  padding: 40px;
  color: #666;
}

.fallback-actions {
  margin-top: 20px;
}
/* Estilos para bot√≥n KMZ */
.btn-success {
  background: linear-gradient(135deg, #28a745, #20c997);
  border: none;
  color: white;
  padding: 12px 20px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
}

.btn-success:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
  background: linear-gradient(135deg, #218838, #1ea085);
}

.btn-success i {
  margin-right: 8px;
  font-size: 16px;
}
/* Estilos para sistema completo de colores */
.leyenda-colores {
  position: fixed;
  top: 20px;
  right: 20px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.3);
  z-index: 10000;
  width: 300px;
  max-height: 80vh;
  overflow-y: auto;
}

.leyenda-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 15px;
  border-radius: 12px 12px 0 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.leyenda-header h4 {
  margin: 0;
  font-size: 16px;
}

.leyenda-close {
  background: rgba(255,255,255,0.2);
  border: none;
  color: white;
  padding: 5px 10px;
  border-radius: 4px;
  cursor: pointer;
}

.leyenda-content {
  padding: 20px;
}

.leyenda-section {
  margin-bottom: 20px;
}

.leyenda-section h5 {
  margin: 0 0 15px 0;
  color: #333;
  font-size: 14px;
}

.leyenda-item {
  display: flex;
  align-items: center;
  margin-bottom: 8px;
  gap: 10px;
}

.color-sample {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  border: 2px solid #ddd;
}

/* Panel de filtros avanzados */
.panel-filtros-avanzados {
  position: fixed;
  top: 20px;
  left: 20px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.3);
  z-index: 10000;
  width: 280px;
}

.panel-header {
  background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
  color: white;
  padding: 15px;
  border-radius: 12px 12px 0 0;
}

.panel-header h4 {
  margin: 0;
  font-size: 16px;
}

.filtros-content {
  padding: 20px;
}

.filtro-grupo {
  margin-bottom: 20px;
}

.filtro-grupo h5 {
  margin: 0 0 15px 0;
  color: #333;
  font-size: 14px;
}

.filtro-checkbox {
  display: flex;
  align-items: center;
  margin-bottom: 8px;
  cursor: pointer;
  gap: 8px;
}

.filtro-checkbox input[type="checkbox"] {
  margin: 0;
}

.filtro-acciones {
  display: flex;
  gap: 10px;
}

.btn {
  padding: 8px 16px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 12px;
  transition: all 0.3s ease;
}

.btn-primary {
  background: #007bff;
  color: white;
}

.btn-secondary {
  background: #6c757d;
  color: white;
}

/* Estad√≠sticas de colores */
.estadisticas-colores {
  margin-top: 20px;
  padding: 15px;
  background: #f8f9fa;
  border-radius: 8px;
}

.estadisticas-colores h4 {
  margin: 0 0 15px 0;
  font-size: 14px;
  color: #333;
}

.estadisticas-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
}

.estadistica-item {
  text-align: center;
  padding: 10px;
  border-radius: 6px;
  color: white;
}

.estadistica-item.verde {
  background: #28a745;
}

.estadistica-item.rojo {
  background: #dc3545;
}

.estadistica-item .numero {
  display: block;
  font-size: 20px;
  font-weight: bold;
}

.estadistica-item .label {
  display: block;
  font-size: 12px;
  opacity: 0.9;
}
  </style>
</head>
<body> 
  <!-- Sidebar empresarial -->
<div class="sidebar">
  <div class="sidebar-header">
    <img src="img/logo_empresa.png" alt="Logo" class="sidebar-logo">
    <div class="sidebar-title">FANGIO TELECOM</div>
    <div class="sidebar-subtitle">ENTERPRISE SOLUTIONS</div>
  </div>
  <ul class="sidebar-menu">
    <li><i class="fas fa-tachometer-alt"></i> Dashboard Ejecutivo</li>
    <li><i class="fas fa-link"></i> Gesti√≥n de Enlaces</span></li>
    <li><i class="fas fa-map-marked-alt"></i> Visualizaci√≥n Geogr√°fica</li>
    <li><i class="fas fa-chart-bar"></i> Reportes y Analytics</li>
    <hr>
    <li><i class="fas fa-upload"></i> Importaci√≥n de Datos</li>
    <li><i class="fas fa-download"></i> Exportaci√≥n</li>
    <li><i class="fas fa-sync"></i> Sincronizaci√≥n</li>
    <hr>
    <li><i class="fas fa-users"></i> Gesti√≥n de Usuarios</li>
    <li><i class="fas fa-shield-alt"></i> Seguridad</li>
    <li><i class="fas fa-database"></i> Base de Datos</li>
    <li><i class="fas fa-file-alt"></i> Logs del Sistema</li>
  </ul>
</div>
  <div class="topbar">
    <div class="topbar-left">
      <span class="topbar-title">Dashboard</span>
      <span class="topbar-link" onclick="window.location.href='enlaces_sonora.html'" style="cursor: pointer;">Enlaces Sonora</span>
      <span class="topbar-link">Analytics</span>
      <span class="topbar-link">Configuraci√≥n</span>
    </div>
    <div class="topbar-right">
      <span class="user-badge">EF</span>
      <button class="btn btn-institucional"><i class="fas fa-sign-out-alt"></i> Cerrar sesi√≥n</button>
    </div>
  </div>
  <script>
    window.procesamientoActivo = false;
window.enlacesGuardadosRecientemente = false;
window.procesamientoCancelado = false;
window.intervaloResumen = null;
if (localStorage.getItem('fangioSesion') !== 'activa') {
  window.location.href = 'login.html';
}
</script>



<script>
    let permitirMismoTransporte = localStorage.getItem('permitirMismoTransporte') === 'true';

    function togglePermitirMismoTransporte() {
  permitirMismoTransporte = !permitirMismoTransporte;
  localStorage.setItem('permitirMismoTransporte', permitirMismoTransporte);
  
  // ‚úÖ VALIDACIONES DE SEGURIDAD
  const btn = document.getElementById('toggleMismoTransporte');
  if (!btn) {
    console.error('‚ùå No se encontr√≥ el bot√≥n toggleMismoTransporte');
    return;
  }
  
  const icon = btn.querySelector('.toggle-icon i');
  if (!icon) {
    console.error('‚ùå No se encontr√≥ el √≠cono del bot√≥n');
    return;
  }
  
  // ‚úÖ ACTUALIZAR EL BOT√ìN
  if (permitirMismoTransporte) {
    btn.classList.remove('btn-outline-info');
    btn.classList.add('btn-info');
    icon.className = 'fas fa-toggle-on';
    console.log('‚úÖ Mismo transporte ACTIVADO');
  } else {
    btn.classList.remove('btn-info');
    btn.classList.add('btn-outline-info');
    icon.className = 'fas fa-toggle-off';
    console.log('‚ùå Mismo transporte DESACTIVADO');
  }
}

function actualizarEstadoBotonMismoTransporte() {
  const btn = document.getElementById('toggleMismoTransporte');
  if (!btn) return;
  
  const icon = btn.querySelector('.toggle-icon i');
  if (!icon) return;
  
  if (permitirMismoTransporte) {
    btn.classList.remove('btn-outline-info');
    btn.classList.add('btn-info');
    icon.className = 'fas fa-toggle-on';
  } else {
    btn.classList.remove('btn-info');
    btn.classList.add('btn-outline-info');
    icon.className = 'fas fa-toggle-off';
  }
}

function inicializarBotonMismoTransporte() {
  actualizarEstadoBotonMismoTransporte();
}
  
</script>
<script>
function importarArchivoPathloss() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.pl5,.csv';
  
  input.onchange = async function(e) {
    const file = e.target.files[0];
    if (!file) return;

    try {
      if (file.name.endsWith('.csv')) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const text = e.target.result;
          const lines = text.split('\n');
          processPathlossCSV(lines);
        };
        reader.readAsText(file);
      } else if (file.name.endsWith('.pl5')) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const buffer = e.target.result;
          processPathlossFile(buffer);
        };
        reader.readAsArrayBuffer(file);
      }
    } catch (error) {
      console.error('Error al importar archivo:', error);
      alert('Error al importar el archivo. Verifica el formato.');
    }
  };

  input.click();
}

function processPathlossCSV(lines) {

  try {
    lines.forEach(line => {
      const columns = line.split(',');
    });
    alert('Archivo CSV importado correctamente');
  } catch (error) {
    alert('Error al procesar el archivo CSV');
  }
}

function processPathlossFile(buffer) {
  alert('El formato .pl5 a√∫n no est√° soportado. Por favor usa archivos CSV.');
}

let factorK = 4/3;
function setFactorK(nuevoK) {
  factorK = parseFloat(nuevoK) || 4/3;
  alert('Nuevo factor K aplicado: ' + factorK);
}

function abrirPanelParametrosRadio() {
  document.getElementById('modal-parametros-radio').style.display = 'flex';
}
function cerrarPanelParametrosRadio() {
  document.getElementById('modal-parametros-radio').style.display = 'none';
}
function calcularParametrosRadio() {
  const pt = parseFloat(document.getElementById('potenciaTX').value);
  const ga = parseFloat(document.getElementById('gananciaA').value);
  const gb = parseFloat(document.getElementById('gananciaB').value);
  const l = parseFloat(document.getElementById('perdidas').value);
  const fade = parseFloat(document.getElementById('fadeMargin').value);
  const distancia = parseFloat(document.getElementById('distanciaRadio').value);
  const frecuencia = parseFloat(document.getElementById('frecuenciaRadio').value);
  if (isNaN(pt) || isNaN(ga) || isNaN(gb) || isNaN(l) || isNaN(fade) || isNaN(distancia) || isNaN(frecuencia)) {
    document.getElementById('resultado-parametros-radio').innerHTML = '<span style="color:#ef4444;">Datos incompletos</span>';
    return;
  }
  const Lfs = 92.45 + 20 * Math.log10(distancia) + 20 * Math.log10(frecuencia);
  const pr = pt + ga + gb - Lfs - l;
  document.getElementById('resultado-parametros-radio').innerHTML =
    `<b>P√©rdida espacio libre:</b> ${Lfs.toFixed(2)} dB<br>
     <b>Potencia recibida:</b> ${pr.toFixed(2)} dBm<br>
     <b>Margen de desvanecimiento:</b> ${fade} dB<br>
     <b>Margen total:</b> ${(pr - fade).toFixed(2)} dBm`;
}
let equiposAntenas = [];
function abrirPanelEquiposAntenas() {
  document.getElementById('modal-equipos-antenas').style.display = 'flex';
  mostrarListaEquiposAntenas();
}
function cerrarPanelEquiposAntenas() {
  document.getElementById('modal-equipos-antenas').style.display = 'none';
}
function guardarEquipoAntena() {
  const modeloRadio = document.getElementById('modeloRadio').value.trim();
  const modeloAntena = document.getElementById('modeloAntena').value.trim();
  const ganancia = parseFloat(document.getElementById('gananciaAntena').value);
  if (!modeloRadio || !modeloAntena || isNaN(ganancia)) {
    alert('Completa todos los campos.');
    return;
  }
  equiposAntenas.push({ modeloRadio, modeloAntena, ganancia });
  mostrarListaEquiposAntenas();
}
function mostrarListaEquiposAntenas() {
  const div = document.getElementById('lista-equipos-antenas');
  if (!equiposAntenas.length) {
    div.innerHTML = '<i>No hay equipos registrados.</i>';
    return;
  }
  div.innerHTML = '<ul>' + equiposAntenas.map(eq =>
    `<li><b>${eq.modeloRadio}</b> - ${eq.modeloAntena} (${eq.ganancia} dBi)</li>`
  ).join('') + '</ul>';
}
function mostrarMapaEnlaces(estadoFiltro = null) {
}
</script>
</script>
<div class="microwave-feasibility-dashboard">
  <!-- Actividad Reciente T√©cnica -->
  <div class="technical-activity">
    <div class="activity-header">
      <h3 class="activity-title">Actividad T√©cnica Reciente</h3>
      <div class="activity-filters">
        <button class="filter-btn active">Todos</button>
        <button class="filter-btn">Factibilidad</button>
        <button class="filter-btn">Mantenimiento</button>
        <button class="filter-btn">Reportes</button>
      </div>
    </div>
    
    <div class="activity-list">
      <div class="activity-item">
        <div class="activity-icon blue">
          <i class="fas fa-calculator"></i>
  </div>
        <div class="activity-content">
          <p class="activity-text">Proyecto en curso</p>
          <span class="activity-time">Hace 3 minutos</span>
          <span class="activity-status success">Factible</span>
</div>
      </div>
  
      <div class="activity-item">
        <div class="activity-icon orange">
          <i class="fas fa-tools"></i>
</div>
        <div class="activity-content">
          <p class="activity-text">Proyecto en curso</p>
          <span class="activity-time">Hace 15 minutos</span>
          <span class="activity-status warning">Programado</span>
        </div>
      </div>
      
      <div class="activity-item">
        <div class="activity-icon green">
          <i class="fas fa-file-alt"></i>
        </div>
        <div class="activity-content">
          <p class="activity-text">Proyecto en curso</p>
          <span class="activity-time">Hace 1 hora</span>
          <span class="activity-status info">Completado</span>
        </div>
      </div>
    </div>
  </div>
</div>
    <div class="action-buttons">    
</div>
<div id="indicador-factibilidad" style="text-align:center; font-size:2rem; font-weight:800; margin-bottom:10px;">
</div>
<div id="perfil-elevacion-con-torres"
     style="display: flex; align-items: flex-end; justify-content: center; margin: 30px auto 24px auto; width: 60%; max-width: 100vw; position: relative; margin-left: 320px; margin-top: 64px;">
<div style="width:160px; min-width:120px; height:320px; display:flex; flex-direction:column; align-items:center; justify-content:flex-end; margin-right:48px; position:relative;">    <!-- Cuadro de datos arriba de la torre -->
    <div id="torreA-info"
         style="position:absolute; left:50%; top:-70px; transform:translateX(-50%); background:#181f2a; color:#00e6ff; border-radius:12px; box-shadow:0 2px 12px #00e6ff33; padding:10px 18px; min-width:120px; text-align:center; font-size:14px; z-index:2;">
      <b id="torreA-id">ID</b><br>
      <span id="torreA-nombre">Nombre</span><br>
      <span id="torreA-altura">Altura m</span>
    </div>
<svg viewBox="0 0 48 180" style="height:320px; width:auto; display:block;" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <linearGradient id="torreMetalB" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%" stop-color="#fff" stop-opacity="0.95"/>
      <stop offset="100%" stop-color="#e53935" stop-opacity="0.85"/>
    </linearGradient>
    <pattern id="rejillaB" width="8" height="8" patternUnits="userSpaceOnUse">
      <rect x="0" y="0" width="8" height="8" fill="none"/>
      <line x1="0" y1="0" x2="8" y2="8" stroke="#e53935" stroke-width="0.7" opacity="0.18"/>
      <line x1="8" y1="0" x2="0" y2="8" stroke="#e53935" stroke-width="0.7" opacity="0.18"/>
    </pattern>
  </defs>
  <ellipse cx="24" cy="175" rx="13" ry="4" fill="#000" opacity="0.12"/>
  <ellipse cx="24" cy="170" rx="16" ry="8" fill="#b0bec5"/>
  <ellipse cx="24" cy="170" rx="10" ry="4" fill="#e53935" opacity="0.7"/>
  <polygon points="24,10 6,170 42,170" fill="url(#torreMetalB)" stroke="#fff" stroke-width="6"/>
  <polygon points="24,20 12,165 36,165" fill="url(#rejillaB)" opacity="0.5"/>
  <line x1="24" y1="10" x2="24" y2="170" stroke="#e53935" stroke-width="4"/>
  <line x1="12" y1="50" x2="36" y2="130" stroke="#e53935" stroke-width="2"/>
  <line x1="36" y1="50" x2="12" y2="130" stroke="#e53935" stroke-width="2"/>
  <line x1="10" y1="90" x2="38" y2="150" stroke="#e53935" stroke-width="2"/>
  <line x1="38" y1="90" x2="10" y2="150" stroke="#e53935" stroke-width="2"/>
  <line x1="12" y1="50" x2="36" y2="50" stroke="#fff" stroke-width="2" opacity="0.8"/>
  <line x1="10" y1="90" x2="38" y2="90" stroke="#fff" stroke-width="2" opacity="0.8"/>
  <line x1="12" y1="130" x2="36" y2="130" stroke="#fff" stroke-width="2" opacity="0.8"/>
  <line x1="6" y1="170" x2="42" y2="170" stroke="#e53935" stroke-width="5"/>
  <rect x="20" y="2" width="8" height="16" rx="2" fill="#fff" opacity="0.85"/>
  <rect x="16" y="0" width="16" height="4" rx="2" fill="#e53935" opacity="0.9"/>
  <rect x="23" y="-8" width="2" height="10" rx="1" fill="#b0bec5"/>
  <circle cx="24" cy="-8" r="2" fill="#ffd600" stroke="#b0bec5" stroke-width="0.7"/>
  <ellipse cx="32" cy="60" rx="3" ry="7" fill="#e53935" opacity="0.7"/>
  <ellipse cx="16" cy="100" rx="3" ry="7" fill="#e53935" opacity="0.7"/>
  <ellipse cx="32" cy="140" rx="3" ry="7" fill="#e53935" opacity="0.7"/>
  <circle cx="24" cy="50" r="1.1" fill="#b0bec5"/>
  <circle cx="24" cy="90" r="1.1" fill="#b0bec5"/>
  <circle cx="24" cy="130" r="1.1" fill="#b0bec5"/>
  <circle cx="24" cy="170" r="1.1" fill="#b0bec5"/>
</svg>
  </div>
  <div style="flex:1; min-width:0;">
    <div id="perfilElevacionPlotly"
         style="width:100%;height:400px;margin:0;background:#181f2a;border-radius:32px;"></div>
  </div>
<div style="width:160px; min-width:120px; height:320px; display:flex; flex-direction:column; align-items:center; justify-content:flex-end; margin-right:48px; position:relative;">    <!-- Cuadro de datos arriba de la torre -->
    <div id="torreB-info"
         style="position:absolute; left:50%; top:-70px; transform:translateX(-50%); background:#181f2a; color:#00e6ff; border-radius:12px; box-shadow:0 2px 12px #00e6ff33; padding:10px 18px; min-width:120px; text-align:center; font-size:14px; z-index:2;">
      <b id="torreB-id">ID</b><br>
      <span id="torreB-nombre">Nombre</span><br>
      <span id="torreB-altura">Altura m</span>
    </div>
<svg viewBox="0 0 48 180" style="height:320px; width:auto; display:block;" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <linearGradient id="torreMetalB" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%" stop-color="#fff" stop-opacity="0.95"/>
      <stop offset="100%" stop-color="#e53935" stop-opacity="0.85"/>
    </linearGradient>
    <pattern id="rejillaB" width="8" height="8" patternUnits="userSpaceOnUse">
      <rect x="0" y="0" width="8" height="8" fill="none"/>
      <line x1="0" y1="0" x2="8" y2="8" stroke="#e53935" stroke-width="0.7" opacity="0.18"/>
      <line x1="8" y1="0" x2="0" y2="8" stroke="#e53935" stroke-width="0.7" opacity="0.18"/>
    </pattern>
  </defs>
  <ellipse cx="24" cy="175" rx="13" ry="4" fill="#000" opacity="0.12"/>
  <ellipse cx="24" cy="170" rx="16" ry="8" fill="#b0bec5"/>
  <ellipse cx="24" cy="170" rx="10" ry="4" fill="#e53935" opacity="0.7"/>
  <polygon points="24,10 6,170 42,170" fill="url(#torreMetalB)" stroke="#fff" stroke-width="6"/>
  <polygon points="24,20 12,165 36,165" fill="url(#rejillaB)" opacity="0.5"/>
  <line x1="24" y1="10" x2="24" y2="170" stroke="#e53935" stroke-width="4"/>
  <line x1="12" y1="50" x2="36" y2="130" stroke="#e53935" stroke-width="2"/>
  <line x1="36" y1="50" x2="12" y2="130" stroke="#e53935" stroke-width="2"/>
  <line x1="10" y1="90" x2="38" y2="150" stroke="#e53935" stroke-width="2"/>
  <line x1="38" y1="90" x2="10" y2="150" stroke="#e53935" stroke-width="2"/>
  <line x1="12" y1="50" x2="36" y2="50" stroke="#fff" stroke-width="2" opacity="0.8"/>
  <line x1="10" y1="90" x2="38" y2="90" stroke="#fff" stroke-width="2" opacity="0.8"/>
  <line x1="12" y1="130" x2="36" y2="130" stroke="#fff" stroke-width="2" opacity="0.8"/>
  <line x1="6" y1="170" x2="42" y2="170" stroke="#e53935" stroke-width="5"/>
  <rect x="20" y="2" width="8" height="16" rx="2" fill="#fff" opacity="0.85"/>
  <rect x="16" y="0" width="16" height="4" rx="2" fill="#e53935" opacity="0.9"/>
  <rect x="23" y="-8" width="2" height="10" rx="1" fill="#b0bec5"/>
  <circle cx="24" cy="-8" r="2" fill="#ffd600" stroke="#b0bec5" stroke-width="0.7"/>
  <ellipse cx="32" cy="60" rx="3" ry="7" fill="#e53935" opacity="0.7"/>
  <ellipse cx="16" cy="100" rx="3" ry="7" fill="#e53935" opacity="0.7"/>
  <ellipse cx="32" cy="140" rx="3" ry="7" fill="#e53935" opacity="0.7"/>
  <circle cx="24" cy="50" r="1.1" fill="#b0bec5"/>
  <circle cx="24" cy="90" r="1.1" fill="#b0bec5"/>
  <circle cx="24" cy="130" r="1.1" fill="#b0bec5"/>
  <circle cx="24" cy="170" r="1.1" fill="#b0bec5"/>
</svg>
  </div>
</div>
<div class="nav-buttons-container">
  <button class="nav-button active" onclick="mostrarPestana('formulario', event)">
    <i class="fas fa-edit icon"></i>
    <span class="text">Formulario de Enlaces</span>
  </button>
  
  <button class="nav-button" onclick="mostrarPestana('enlaces', event)">
    <i class="fas fa-list icon"></i>
    <span class="text">Mis Enlaces</span>
    <span class="badge" id="contador-enlaces">0</span>
  </button>
  
  <button class="nav-button" onclick="mostrarPestana('mismoTransporte', event)">
    <i class="fas fa-exchange-alt icon"></i>
    <span class="text">Mismo Transporte</span>
  </button>
  
  <button class="nav-button" onclick="mostrarPestana('resumen', event)">
    <i class="fas fa-chart-pie icon"></i>
    <span class="text">Resumen</span>
  </button>
  
  <button id="toggleMismoTransporte" class="btn btn-outline-info" type="button" onclick="togglePermitirMismoTransporte()">
    <span style="margin-right: 12px;"><i class="fas fa-exchange-alt"></i></span>
    Permitir mismo tipo de transporte
    <span class="toggle-icon">
      <i class="fas fa-toggle-off"></i>
    </span>
  </button>
  
  <button class="nav-button ptmp-button" onclick="window.location.href='ptmpFangio.html'">
    <i class="fas fa-project-diagram icon"></i>
    <span class="text">Estudio Multipunto (PtMP)</span>
</button>

  <button class="nav-button llenado-button" onclick="window.location.href='http://127.0.0.1:5000/'">
    <i class="fas fa-database icon"></i>
    <span class="text">Llenado de Datos</span>
</button>
</div>
</div>
    <div class="main-content">
      <div class="tabs-container">
        <div class="tabs">
</div>
      </div>
      <div id="tab-formulario" class="tab-content active">
        <div class="frecuencia-info">
          <div class="frecuencia-header">
            <div class="frecuencia-icon">
              <i class="fas fa-signal"></i>
        </div>
        <div>
              <h3 class="frecuencia-title">üì° Reglas de Frecuencia</h3>
              <p class="frecuencia-subtitle">Protocolos de asignaci√≥n de frecuencias seg√∫n distancia del enlace</p>
        </div>
      </div>
          
          <div class="frecuencia-rules">
            <div class="frecuencia-rule">
              <div class="rule-header">
                <div class="rule-icon">
                  <i class="fas fa-wifi"></i>
    </div>
                <h4 class="rule-range">0 - 5 km</h4>
    </div>
              <p class="rule-frequency">Frecuencia: <strong>80 GHz</strong></p>
              <p class="rule-description">Enlaces de corta distancia con alta capacidad de datos y baja latencia</p>
  </div>
            
            <div class="frecuencia-rule">
              <div class="rule-header">
                <div class="rule-icon">
                  <i class="fas fa-broadcast-tower"></i>
                </div>
                <h4 class="rule-range">5 - 15 km</h4>
              </div>
              <p class="rule-frequency">Frecuencia: <strong>15 GHz</strong></p>
              <p class="rule-description">Enlaces de distancia media con balance entre capacidad y alcance</p>
            </div>
            
            <div class="frecuencia-rule">
              <div class="rule-header">
                <div class="rule-icon">
                  <i class="fas fa-satellite"></i>
                </div>
                <h4 class="rule-range">15+ km</h4>
              </div>
              <p class="rule-frequency">Frecuencia: <strong>8 GHz</strong></p>
              <p class="rule-description">Enlaces de larga distancia con mayor alcance y estabilidad</p>
            </div>
          </div>
        </div>
        <div class="modern-upload-container">
          <div class="upload-header">
            <h3 class="upload-title">üìÅ Gesti√≥n de Archivos Excel</h3>
            <p class="upload-subtitle">Carga y procesamiento de archivos para enlaces PtP</p>
          </div>
          
          <div class="upload-grid">
            <!-- CARD 1: Archivo Excel Principal -->
            <div class="upload-card" id="upload-card-main">
              <div class="upload-card-header">
                <div class="upload-icon">
                  <i class="fas fa-file-excel"></i>
                </div>
                <div>
                  <h4 class="upload-card-title">üìä Archivo Excel Principal</h4>
                  <p class="upload-card-description">Base de datos de sitios y coordenadas</p>
                </div>
              </div>
              
              <label class="upload-button" for="inputFile">
                <i class="fas fa-upload"></i>
                Cargar archivo Excel
    </label>
              <input type="file" id="inputFile" class="upload-input" accept=".xlsx" />
              
              <!-- Informaci√≥n del archivo cargado -->
              <div class="file-info" id="archivo-cargado">
                <div class="file-info-header">
                  <div class="file-info-icon">
                    <i class="fas fa-check-circle"></i>
                  </div>
                  <h5 class="file-info-title">Archivo Cargado Exitosamente</h5>
                </div>
                
                <div class="file-info-details">
                  <div class="file-name" id="nombre-archivo"></div>
                  <div class="file-meta" id="info-archivo"></div>
                </div>
                
                <div class="file-actions">
                  <button id="borrar-archivo" class="file-action-btn danger">
                    <i class="fas fa-trash"></i>
                    Eliminar Archivo
                  </button>
                </div>
              </div>
              
              <!-- Estado de carga -->
              <div class="upload-loading" id="loading">
                <div class="upload-spinner"></div>
                <p class="loading-text">Procesando archivo...</p>
              </div>
            </div>
        
            <!-- CARD 2: Archivo Excel de Pares -->
            <div class="upload-card" id="upload-card-pairs">
              <div class="upload-card-header">
                <div class="upload-icon">
                  <i class="fas fa-project-diagram"></i>
                </div>
    <div>
                  <h4 class="upload-card-title">üîó Archivo Excel de Pares</h4>
                  <p class="upload-card-description">Configuraci√≥n de enlaces punto a punto</p>
    </div>
              </div>
              
              <label class="upload-button" for="inputFilePairs">
                <i class="fas fa-upload"></i>
                Cargar Excel de Pares
              </label>
              <input type="file" id="inputFilePairs" class="upload-input" accept=".xlsx" />
              
              <!-- Informaci√≥n del archivo de pares cargado -->
              <div class="file-info" id="archivo-pares-cargado">
                <div class="file-info-header">
                  <div class="file-info-icon">
                    <i class="fas fa-check-circle"></i>
                  </div>
                  <h5 class="file-info-title">Archivo de Pares Cargado</h5>
                </div>
                
                <div class="file-info-details">
                  <div class="file-name" id="nombre-archivo-pares"></div>
                  <div class="file-meta" id="info-archivo-pares"></div>
                </div>
                
                <div class="file-actions">
                  <button class="file-action-btn primary" id="btn-procesar-pares">
                    <i class="fas fa-play"></i>
                    Procesar Pares
      </button>
                  <button id="borrar-archivo-pares" class="file-action-btn danger">
                    <i class="fas fa-trash"></i>
                    Eliminar
      </button>
    </div>
  </div>
</div>
  </div>
</div>
<div class="enterprise-form-container">
  <div class="enterprise-form-header">
    <h2 class="enterprise-form-title">üì° Configuraci√≥n de Enlace PtP</h2>
    <p class="enterprise-form-subtitle">Sistema de Gesti√≥n de Enlaces Punto a Punto - Fangio Telecom</p>
  </div>
  
  <div class="enterprise-form-content">
    <!-- SECCI√ìN 1: IDENTIFICACI√ìN DE SITIOS -->
    <div class="form-section">
      <div class="section-header">
        <div class="section-icon">
          <i class="fas fa-building"></i>
        </div>
          <div>
          <h3 class="section-title">üè¢ Identificaci√≥n de Sitios</h3>
          <p class="section-description">Informaci√≥n b√°sica de identificaci√≥n de ambos sitios del enlace</p>
        </div>
      </div>
      
      <div class="form-fields-grid">
        <div class="form-field">
          <label class="field-label" for="idA">
            <i class="fas fa-id-card"></i> ID Sitio A
          </label>
          <input type="text" id="idA" class="field-input" placeholder="Identificador √∫nico del sitio A" />
        </div>
        
        <div class="form-field">
          <label class="field-label" for="idB">
            <i class="fas fa-id-card"></i> ID Sitio B
          </label>
          <input type="text" id="idB" class="field-input" placeholder="Identificador √∫nico del sitio B" />
        </div>
        
        <div class="form-field">
          <label class="field-label" for="nombreA">
            <i class="fas fa-building"></i> Nombre Sitio A
          </label>
          <input type="text" id="nombreA" class="field-input" placeholder="Nombre del sitio A" />
        </div>
        
        <div class="form-field">
          <label class="field-label" for="nombreB">
            <i class="fas fa-building"></i> Nombre Sitio B
          </label>
          <input type="text" id="nombreB" class="field-input" placeholder="Nombre del sitio B" />
        </div>
      </div>
    </div>

    <!-- SECCI√ìN 2: COORDENADAS GEOGR√ÅFICAS -->
    <div class="form-section">
      <div class="section-header">
        <div class="section-icon">
          <i class="fas fa-globe-americas"></i>
        </div>
        <div>
          <h3 class="section-title">ÔøΩÔøΩ Coordenadas Geogr√°ficas</h3>
          <p class="section-description">Posicionamiento GPS de ambos sitios para c√°lculo de distancia</p>
        </div>
      </div>
      
      <div class="form-fields-grid">
        <div class="form-field">
          <label class="field-label" for="latA">
            <i class="fas fa-map-marker-alt"></i> Latitud A
          </label>
          <input type="text" id="latA" class="field-input" placeholder="Ej: 19.4326" />
        </div>
        
        <div class="form-field">
          <label class="field-label" for="lonA">
            <i class="fas fa-map-marker-alt"></i> Longitud A
          </label>
          <input type="text" id="lonA" class="field-input" placeholder="Ej: -99.1332" />
        </div>
        
        <div class="form-field">
          <label class="field-label" for="latB">
            <i class="fas fa-map-marker-alt"></i> Latitud B
          </label>
          <input type="text" id="latB" class="field-input" placeholder="Ej: 19.4326" />
        </div>
        
        <div class="form-field">
          <label class="field-label" for="lonB">
            <i class="fas fa-map-marker-alt"></i> Longitud B
          </label>
          <input type="text" id="lonB" class="field-input" placeholder="Ej: -99.1332" />
        </div>
      </div>
    </div>

    <!-- SECCI√ìN 3: C√ÅLCULOS AUTOM√ÅTICOS -->
    <div class="form-section">
      <div class="section-header">
        <div class="section-icon">
          <i class="fas fa-calculator"></i>
        </div>
        <div>
          <h3 class="section-title">üßÆ C√°lculos Autom√°ticos</h3>
          <p class="section-description">Valores calculados autom√°ticamente por el sistema</p>
        </div>
      </div>
      
      <div class="form-fields-grid">
        <div class="form-field">
          <label class="field-label" for="latArad">
            <i class="fas fa-calculator"></i> Latitud A (rad)
          </label>
          <input type="text" id="latArad" class="field-input" readonly />
        </div>
        
        <div class="form-field">
          <label class="field-label" for="lonArad">
            <i class="fas fa-calculator"></i> Longitud A (rad)
          </label>
          <input type="text" id="lonArad" class="field-input" readonly />
        </div>
        
        <div class="form-field">
          <label class="field-label" for="latBrad">
            <i class="fas fa-calculator"></i> Latitud B (rad)
          </label>
          <input type="text" id="latBrad" class="field-input" readonly />
        </div>
        
        <div class="form-field">
          <label class="field-label" for="lonBrad">
            <i class="fas fa-calculator"></i> Longitud B (rad)
          </label>
          <input type="text" id="lonBrad" class="field-input" readonly />
        </div>
        
        <div class="form-field">
          <label class="field-label" for="distancia">
            <i class="fas fa-ruler"></i> Distancia (km)
          </label>
          <input type="text" id="distancia" class="field-input" readonly />
        </div>
        
        <div class="form-field">
          <label class="field-label" for="frecuencia">
            <i class="fas fa-signal"></i> Frecuencia (GHz)
          </label>
          <input type="text" id="frecuencia" class="field-input" readonly />
        </div>
      </div>
    </div>

    <!-- SECCI√ìN 4: INFRAESTRUCTURA F√çSICA -->
    <div class="form-section">
      <div class="section-header">
        <div class="section-icon">
          <i class="fas fa-broadcast-tower"></i>
        </div>
        <div>
          <h3 class="section-title">ÔøΩÔøΩÔ∏è Infraestructura F√≠sica</h3>
          <p class="section-description">Caracter√≠sticas f√≠sicas de torres y equipos</p>
        </div>
      </div>
      
      <div class="form-fields-grid">
        <div class="form-field">
          <label class="field-label" for="alturaA">
            <i class="fas fa-arrows-alt-v"></i> Altura Torre A
          </label>
          <input type="text" id="alturaA" class="field-input" placeholder="Altura en metros" />
        </div>
        
        <div class="form-field">
          <label class="field-label" for="alturaB">
            <i class="fas fa-arrows-alt-v"></i> Altura Torre B
          </label>
          <input type="text" id="alturaB" class="field-input" placeholder="Altura en metros" />
        </div>
        
        <div class="form-field">
          <label class="field-label" for="ranA">
            <i class="fas fa-wifi"></i> Altura RAN A
          </label>
          <input type="text" id="ranA" class="field-input" placeholder="Altura RAN en metros" />
        </div>
        
        <div class="form-field">
          <label class="field-label" for="ranB">
            <i class="fas fa-wifi"></i> Altura RAN B
          </label>
          <input type="text" id="ranB" class="field-input" placeholder="Altura RAN en metros" />
        </div>
        
        <div class="form-field">
          <label class="field-label" for="TorreA">
            <i class="fas fa-broadcast-tower"></i> Tipo de Torre A
          </label>
          <input type="text" id="TorreA" class="field-input" placeholder="Ej: Monopolo, Lattice" />
        </div>
        
        <div class="form-field">
          <label class="field-label" for="TorreB">
            <i class="fas fa-broadcast-tower"></i> Tipo de Torre B
          </label>
          <input type="text" id="TorreB" class="field-input" placeholder="Ej: Monopolo, Lattice" />
        </div>
      </div>
    </div>

    <!-- SECCI√ìN 5: CONECTIVIDAD Y TRANSPORTE -->
    <div class="form-section">
      <div class="section-header">
        <div class="section-icon">
          <i class="fas fa-network-wired"></i>
        </div>
        <div>
          <h3 class="section-title">üåê Conectividad y Transporte</h3>
          <p class="section-description">Configuraci√≥n de transporte y conectividad de red</p>
        </div>
      </div>
      
      <div class="form-fields-grid">
        <div class="form-field">
          <label class="field-label" for="TransA">
            <i class="fas fa-truck"></i> Transporte Sitio A
          </label>
          <input type="text" id="TransA" class="field-input" placeholder="Ej: Fibra, Satelital" />
        </div>
        
        <div class="form-field">
          <label class="field-label" for="TransB">
            <i class="fas fa-truck"></i> Transporte Sitio B
          </label>
          <input type="text" id="TransB" class="field-input" placeholder="Ej: Fibra, Satelital" />
        </div>
        
        <div class="form-field">
          <label class="field-label" for="ArreA">
            <i class="fas fa-handshake"></i> Arrendamiento A
          </label>
          <input type="text" id="ArreA" class="field-input" placeholder="Propio/Arrendado" />
        </div>
        
        <div class="form-field">
          <label class="field-label" for="ArreB">
            <i class="fas fa-handshake"></i> Arrendamiento B
          </label>
          <input type="text" id="ArreB" class="field-input" placeholder="Propio/Arrendado" />
        </div>
      </div>
    </div>

    <!-- SECCI√ìN 6: ESTADO OPERATIVO -->
    <div class="form-section">
      <div class="section-header">
        <div class="section-icon">
          <i class="fas fa-power-off"></i>
        </div>
        <div>
          <h3 class="section-title">‚ö° Estado Operativo</h3>
          <p class="section-description">Estado actual de operaci√≥n de ambos sitios</p>
        </div>
      </div>
      
      <div class="form-fields-grid">
        <div class="form-field">
          <label class="field-label" for="OnA">
            <i class="fas fa-power-off"></i> On Air A
          </label>
          <input type="text" id="OnA" class="field-input" placeholder="Operativo/Pendiente" />
        </div>
        
        <div class="form-field">
          <label class="field-label" for="OnB">
            <i class="fas fa-power-off"></i> On Air B
          </label>
          <input type="text" id="OnB" class="field-input" placeholder="Operativo/Pendiente" />
        </div>
        
        <div class="form-field">
          <label class="field-label" for="EstadoA">
            <i class="fas fa-flag"></i> Estado A
          </label>
          <input type="text" id="EstadoA" class="field-input" placeholder="Activo/Inactivo" />
        </div>
        
        <div class="form-field">
          <label class="field-label" for="EstadoB">
            <i class="fas fa-flag"></i> Estado B
          </label>
          <input type="text" id="EstadoB" class="field-input" placeholder="Activo/Inactivo" />
        </div>
      </div>
    </div>

    <!-- SECCI√ìN 7: AN√ÅLISIS T√âCNICO -->
    <div class="form-section">
      <div class="section-header">
        <div class="section-icon">
          <i class="fas fa-chart-line"></i>
        </div>
        <div>
          <h3 class="section-title">ÔøΩÔøΩ An√°lisis T√©cnico</h3>
          <p class="section-description">Resultados del an√°lisis de factibilidad y c√°lculos t√©cnicos</p>
        </div>
      </div>
      
      <div class="form-fields-grid">
        <div class="form-field">
          <label class="field-label" for="bulboCurvatura">
            <i class="fas fa-globe"></i> Curvatura Terrestre (m)
          </label>
          <input type="text" id="bulboCurvatura" class="field-input" readonly />
        </div>
        
        <div class="form-field">
          <label class="field-label" for="radioFresnel">
            <i class="fas fa-circle"></i> Radio Fresnel (m)
          </label>
          <input type="text" id="radioFresnel" class="field-input" readonly />
        </div>
        
        <div class="form-field">
          <label class="field-label" for="alturaLibre">
            <i class="fas fa-arrows-alt-v"></i> Altura Libre Necesaria (m)
          </label>
          <input type="text" id="alturaLibre" class="field-input" readonly />
        </div>
        
        <div class="form-field">
          <label class="field-label" for="alturaDisponible">
            <i class="fas fa-arrows-alt-v"></i> Altura Real Disponible (m)
          </label>
          <input type="text" id="alturaDisponible" class="field-input" readonly />
        </div>
        
        <div class="form-field">
          <label class="field-label" for="factibilidadCurvatura">
            <i class="fas fa-check-circle"></i> Factibilidad
          </label>
          <input type="text" id="factibilidadCurvatura" class="field-input" readonly />
        </div>
        
        <div class="form-field">
          <label class="field-label" for="disponibilidadAnual">
            <i class="fas fa-percentage"></i> Disponibilidad Anual (%)
          </label>
          <input type="text" id="disponibilidadAnual" class="field-input" readonly />
        </div>
      </div>
    </div>
           </div>
        </div>
        <div class="action-buttons">
          <button id="agregarBtn" class="btn btn-success" onclick="agregarEnlace()">
            <i class="fas fa-check"></i> Agregar Enlace
          </button>
          <button class="btn btn-secondary" onclick="limpiarFormulario()">
            <i class="fas fa-trash"></i> Limpiar Formulario
          </button>
          <button class="btn btn-primary" onclick="mostrarPestana('enlaces')">
            <i class="fas fa-list"></i> Ver Mis Enlaces
          </button>
          <button class="btn btn-warning" onclick="exportarFactiblesParaPathloss()">
            <i class="fas fa-file-export"></i> Exportar Factibles para Pathloss
  </button>
</div>
      </div>
      <div id="tab-seleccion" class="tab-content">
  <div class="enlaces-counter">
    <i class="fas fa-check-square"></i> Enlaces Seleccionados: <span id="enlaces-seleccionados">0</span>
  </div>
  <div class="action-buttons">
    <button class="btn btn-primary" onclick="seleccionarTodo()">
      <i class="fas fa-check-double"></i> Seleccionar Todo
    </button>
    <button class="btn btn-secondary" onclick="deseleccionarTodo()">
      <i class="fas fa-times"></i> Deseleccionar Todo
    </button>
    <button id="eliminarSeleccionadosBtn" class="btn btn-danger" onclick="eliminarSeleccionados()" disabled>
      <i class="fas fa-trash-alt"></i> Eliminar Seleccionados
    </button>

  </div>

  <div class="table-container seleccion-container">
  </div>
</div>
      <div id="tab-enlaces" class="tab-content">
        <div class="enlaces-counter">
          <i class="fas fa-chart-line"></i> Total de Enlaces Registrados: <span id="total-enlaces">0</span>
        </div>
        <div class="action-buttons">
          <button class="btn btn-primary" onclick="mostrarPestana('formulario')">
            <i class="fas fa-plus"></i> Agregar Nuevo Enlace
          </button>
          <button class="btn btn-success" onclick="exportarExcel()">
            <i class="fas fa-file-excel"></i> Exportar a Excel
          </button>
        </div>
        <button class="btn btn-secondary" onclick="seleccionarTodosEnlaces()">
            <i class="fas fa-check-double"></i> Seleccionar Todos
        </button>
        <button class="btn btn-danger" onclick="eliminarEnlacesSeleccionados()" id="btnEliminarSeleccionados" disabled>
            <i class="fas fa-trash"></i> Eliminar Seleccionados
        </button>
        <button id="btnPerfilElevacionGlobal" class="btn btn-info" style="display:none; margin-left:8px;">
        <i class="fas fa-mountain"></i> Perfil Elevaci√≥n
        </button>
        <div class="table-container">

<table id="tabla">
  <thead>
  <tr>
    <th><input type="checkbox" id="checkTodos" onclick="toggleSeleccionarTodos(this)"></th>
    <th class="th-a" title="Identificador √∫nico del sitio A"><i class="fas fa-map-marker-alt"></i><br>ID A</th>
    <th class="th-a" title="Nombre del sitio A"><i class="fas fa-building"></i><br>Nombre A</th>
    <th class="th-a" title="Latitud del sitio A"><i class="fas fa-compass"></i><br>Lat A</th>
    <th class="th-a" title="Longitud del sitio A"><i class="fas fa-globe"></i><br>Lon A</th>
    <th class="th-a" title="Latitud en radianes del sitio A"><i class="fas fa-calculator"></i><br>Lat A (rad)</th>
    <th class="th-a" title="Longitud en radianes del sitio A"><i class="fas fa-calculator"></i><br>Lon A (rad)</th>
    <th class="th-b" title="Identificador √∫nico del sitio B"><i class="fas fa-map-marker-alt"></i><br>ID B</th>
    <th class="th-b" title="Nombre del sitio B"><i class="fas fa-building"></i><br>Nombre B</th>
    <th class="th-b" title="Latitud del sitio B"><i class="fas fa-compass"></i><br>Lat B</th>
    <th class="th-b" title="Longitud del sitio B"><i class="fas fa-globe"></i><br>Lon B</th>
    <th class="th-b" title="Latitud en radianes del sitio B"><i class="fas fa-calculator"></i><br>Lat B (rad)</th>
    <th class="th-b" title="Longitud en radianes del sitio B"><i class="fas fa-calculator"></i><br>Lon B (rad)</th>
    <th class="th-calc" title="Distancia calculada entre sitios (km)"><i class="fas fa-route"></i><br>Distancia (km)</th>
    <th class="th-calc" title="Frecuencia recomendada seg√∫n distancia"><i class="fas fa-broadcast-tower"></i><br>Frecuencia (GHz)</th>
    <th class="th-calc" title="Disponibilidad anual (%)"><i class="fas fa-percentage"></i><br>Disponibilidad</th>
    <th class="th-tech" title="Altura de la torre A"><i class="fas fa-arrows-alt-v"></i><br>Altura Torre A</th>
    <th class="th-tech" title="Altura de la torre B"><i class="fas fa-arrows-alt-v"></i><br>Altura Torre B</th>
    <th class="th-tech" title="Altura RAN A"><i class="fas fa-wifi"></i><br>Altura RAN A</th>
    <th class="th-tech" title="Altura RAN B"><i class="fas fa-wifi"></i><br>Altura RAN B</th>
    <th class="th-trans" title="Tipo de transporte sitio A"><i class="fas fa-truck"></i><br>Transporte A</th>
    <th class="th-trans" title="Tipo de transporte sitio B"><i class="fas fa-truck"></i><br>Transporte B</th>
    <th class="th-arr" title="Tipo de arrendamiento A"><i class="fas fa-handshake"></i><br>Arrendamiento A</th>
    <th class="th-arr" title="Tipo de arrendamiento B"><i class="fas fa-handshake"></i><br>Arrendamiento B</th>
    <th class="th-onair" title="Estado operativo A"><i class="fas fa-power-off"></i><br>On Air A</th>
    <th class="th-onair" title="Estado operativo B"><i class="fas fa-power-off"></i><br>On Air B</th>
    <th class="th-tower" title="Tipo de torre A"><i class="fas fa-tower-broadcast"></i><br>Tipo Torre A</th>
    <th class="th-tower" title="Tipo de torre B"><i class="fas fa-tower-broadcast"></i><br>Tipo Torre B</th>
    <th class="th-state" title="Estado A"><i class="fas fa-flag"></i><br>Estado A</th>
    <th class="th-state" title="Estado B"><i class="fas fa-flag"></i><br>Estado B</th>
    <th class="th-fact" title="¬øEnlace factible?" style="font-weight: bold; text-align: center;"><i class="fas fa-check-circle"></i><br>Factible</th>
    <th class="th-fact" title="Antenas requeridas" style="font-weight: bold;"><i class="fas fa-satellite-dish"></i><br>Antenas</th>
    <th class="th-fact" title="Tipo de enlace" style="font-weight: bold;"><i class="fas fa-network-wired"></i><br>Tipo Enlace</th>
    <th class="th-fact" title="An√°lisis detallado" style="font-weight: bold;"><i class="fas fa-info-circle"></i><br>An√°lisis</th>
  </tr>
</thead>
  <tbody></tbody>
</table>
        </div>
        <div id="mensaje-sin-enlaces" class="mensaje-sin-enlaces" style="display: none;">
          <i class="fas fa-broadcast-tower"></i>
          <h3>No hay enlaces registrados</h3>
          <p>Usa el formulario para agregar tu primer enlace PtP</p>
          <button class="btn btn-primary" onclick="mostrarPestana('formulario')">
            <i class="fas fa-plus"></i> Agregar Primer Enlace
          </button>
        </div>
      </div>
      <div id="tab-mismoTransporte" class="tab-content">
  <div style="margin: 24px 0;">
    <h2>An√°lisis de Enlaces con Mismo Tipo de Transporte Permitido</h2>
    <div class="table-container" id="tabla-mismo-transporte"></div>
  </div>
</div>
     <div id="tab-resumen" class="tab-content">
  <div class="table-container" style="max-width:600px;margin:auto;">
    <div class="resumen-enlaces" style="display: flex; flex-wrap:wrap; gap: 24px; align-items: center; margin-bottom: 18px; justify-content:center;">
      <div>
        <strong>Total de Enlaces:</strong> <span id="resumen-total-enlaces">0</span>
      </div>
      <div>
        <strong>Factibles:</strong> <span id="resumen-enlaces-factibles" style="color:#10b981;">0</span>
      </div>
      <button class="btn btn-success" onclick="exportarFactiblesParaPathloss()">
        <i class="fas fa-file-export"></i> Exportar Factibles
      </button>
        <button class="btn btn-danger" id="btnDescargarFaltantes" style="margin-left:8px; display:none;">
  <i class="fas fa-download"></i> Descargar Pares Faltantes
</button>

      <button class="btn btn-primary" onclick="exportarExcel()">
        <i class="fas fa-file-excel"></i> Exportar Todos
      </button>
      <button class="btn btn-info" onclick="mostrarGraficoResumen()">
        <i class="fas fa-chart-bar"></i> Ver Gr√°fico Resumen
      </button>
<button class="btn btn-info" onclick="activarMonitoEnMapa()">
  <i class="fas fa-street-view"></i> Activar Monito
</button>

<button class="btn btn-warning" onclick="verificarMonito()">
  <i class="fas fa-search"></i> Verificar Monito
</button>

<button class="btn btn-danger" onclick="quitarMonitoDelMapa()">
  <i class="fas fa-times"></i> Quitar Monito
</button>
<!-- Agregar despu√©s de otros botones de exportaci√≥n -->
<button class="btn btn-success" onclick="exportarEnlacesFactiblesKMZ()">
  <i class="fas fa-file-archive"></i> Exportar Factibles KMZ
</button>
<button class="btn btn-info" onclick="exportarKMZMismoTransporte()">
    <i class="fas fa-file-archive"></i> Exportar Mismo Transporte FACTIBLES KMZ
  </button>
<!-- Agregar temporalmente para verificaci√≥n completa -->
<button class="btn btn-warning" onclick="verificarTodasLasVariables()">
  <i class="fas fa-search"></i> Verificar Todas las Variables
</button>

    </div>
    <div style="margin-top:30px; text-align:center; color:#888;">
      <i class="fas fa-info-circle"></i> Aqu√≠ puedes ver el resumen y exportar tus enlaces.
    </div>
  </div>
  <div id="mapa-enlaces" style="width:100%;max-width:900px;height:480px;margin:32px auto 0 auto;border-radius:18px;box-shadow:0 2px 18px #00bcd455;">
  </div>
</div>
<div id="panel-detalle-enlace">
  <button onclick="document.getElementById('panel-detalle-enlace').style.display='none'" style="position:absolute; top:12px; right:16px; background:none; border:none; font-size:1.5rem; color:#888; cursor:pointer;"><i class="fas fa-times"></i></button>
  <div id="detalle-enlace-contenido"></div>
</div>
<div id="segmentacion-estados" style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin:24px 0 0 0;">
</div>
    </div>
  </div>
<script>
  // Funci√≥n para asegurar que siempre se calcule el tama√±o de antena
function calcularDiametroAntenaSeguro(distancia, esArrendamiento = false) {
  if (distancia <= 0 || distancia > 100) {
    return 'Distancia inv√°lida';
  }
  
  if (esArrendamiento) {
    if (distancia <= 3.1) return '1 pie';
    if (distancia <= 8) return '2 pies';
    if (distancia <= 13.5) return '3 pies';
    return '4+ pies (no recomendado)';
  }
  
  // Para torres de adquisici√≥n (no arrendadas)
  if (distancia >= 0 && distancia <= 3) return '1 pie';
  if (distancia > 3 && distancia <= 5) return '2 pies';
  if (distancia > 5 && distancia <= 10) return '3 pies';
  if (distancia > 10 && distancia <= 20) return '4 pies';
  if (distancia > 20) return '6 pies';
  
  return 'Tama√±o no definido';
}
// Funci√≥n para limpiar y recrear IndexedDB
function limpiarYRecrearIndexedDB() {
  console.log('üßπ Limpiando IndexedDB...');
  
  // Cerrar conexiones existentes
  if (window.db) {
    window.db.close();
  }
  
  // Eliminar la base de datos existente
  const deleteRequest = indexedDB.deleteDatabase('ArchivosExcelDB');
  
  deleteRequest.onsuccess = function() {
    console.log('‚úÖ Base de datos eliminada');
    // Recrear la base de datos
    inicializarIndexedDB();
  };
  
  deleteRequest.onerror = function() {
    console.error('‚ùå Error al eliminar base de datos');
  };
}

// Funci√≥n para inicializar IndexedDB correctamente
function inicializarIndexedDB() {
  console.log('üöÄ Inicializando IndexedDB...');
  const request = indexedDB.open('ArchivosExcelDB', 3);
  
  request.onupgradeneeded = function(event) {
    const db = event.target.result;
    console.log('üìä Creando object stores...');
    
    // Crear object store para archivos Excel
    if (!db.objectStoreNames.contains('archivos')) {
      db.createObjectStore('archivos', { keyPath: 'nombre' });
      console.log('‚úÖ Object store "archivos" creado');
    }
    
    // Crear object store para pares
    if (!db.objectStoreNames.contains('pares')) {
      db.createObjectStore('pares', { keyPath: 'nombre' });
      console.log('‚úÖ Object store "pares" creado');
    }
  };
  
  request.onsuccess = function(event) {
    window.db = event.target.result;
    console.log('‚úÖ IndexedDB inicializada correctamente');
    console.log('Object stores disponibles:', window.db.objectStoreNames);
  };
  
  request.onerror = function(event) {
    console.error('‚ùå Error al abrir IndexedDB:', event.target.error);
  };
}
// Mostrar modal de progreso
function mostrarModalProgreso() {
  modalProgreso = document.getElementById('modal-progreso-masivo');
  if (modalProgreso) {
    modalProgreso.style.display = 'flex';
    inicializarModalProgreso();
  }
}

// Cerrar modal de progreso
function cerrarModalProgreso() {
  const modal = document.getElementById('modal-progreso-masivo');
  if (modal) {
    modal.style.display = 'none';
  }
  
  // üö® DETENER TODO EL PROCESAMIENTO AL CERRAR EL MODAL
 
  
  console.log('Modal cerrado - Procesamiento detenido autom√°ticamente');
}

// Inicializar modal
function inicializarModalProgreso() {
  resetearProgreso();
  mostrarBotonesIniciales();
  agregarLog('Modal de progreso abierto', 'info');
}

// Resetear progreso


// Mostrar botones iniciales
function mostrarBotonesIniciales() {
  document.getElementById('btn-iniciar-procesamiento').style.display = 'inline-flex';
  document.getElementById('btn-pausar-procesamiento').style.display = 'none';
  document.getElementById('btn-cancelar-procesamiento').style.display = 'none';
}

function detenerProcesamiento() {
  console.log('üõë DETENIENDO PROCESAMIENTO DE EMERGENCIA...');
  window.procesamientoActivo = false;
  window.intervaloResumen = null;
  
  // Limpiar cualquier timeout pendiente
  if (window.timeoutProcesamiento) {
    clearTimeout(window.timeoutProcesamiento);
    window.timeoutProcesamiento = null;
  }
  
  console.log('‚úÖ Procesamiento detenido');
}
function mostrarError(mensaje) {
  console.error('‚ùå Error:', mensaje);
  // Si tienes un modal de error, √∫salo aqu√≠
  alert(mensaje); // Temporalmente usar alert
}

// Funci√≥n para mostrar advertencias
function mostrarAdvertencia(mensaje) {
  console.warn('‚ö†Ô∏è Advertencia:', mensaje);
  alert(mensaje); // Temporalmente usar alert
}

// Funci√≥n para mostrar √©xito
function mostrarExito(mensaje) {
  console.log('‚úÖ √âxito:', mensaje);
  alert(mensaje); // Temporalmente usar alert
}


window.procesarPares = async function procesarPares() {
  console.log('ÔøΩÔøΩ INICIANDO PROCESAMIENTO DE PARES...');
  
  // RESETEAR VARIABLES AL INICIAR
  window.enlacesGuardadosRecientemente = false;
  window.faltantes = [];
  window.filasDiferenteTransporte = [];
  window.filasMismoTransporte = [];
  window.permitirMismoTransporte = window.permitirMismoTransporte || false;
  window.procesados = 0;
  window.omitidos = 0;
  window.paresNoProcesados = 0;
  window.procesamientoActivo = true;
  window.procesamientoCancelado = false;
  
  // LIMPIAR CUALQUIER TIMEOUT PENDIENTE
  if (window.timeoutProcesamiento) {
    clearTimeout(window.timeoutProcesamiento);
    window.timeoutProcesamiento = null;
  }
  
  // LIMPIAR TODOS LOS TIMEOUTS EXISTENTES
  for (let i = 1; i < 100000; i++) {
    clearTimeout(i);
    clearInterval(i);
  }
  
  if (!dataExcel.length) {
    mostrarError('‚ùå Error: Primero debes cargar el Excel con los datos de las torres');
    return;
  }
  if (!dataPares.length) {
    mostrarError('‚ùå Error: No hay pares de IDs para procesar');
    return;
  }
  
  // ‚úÖ MOSTRAR MODAL CORRECTAMENTE
  mostrarModalProgreso();

  const mapaTorres = {};
  dataExcel.forEach(row => {
    if (row[0]) mapaTorres[row[0].toString().trim().toUpperCase()] = row;
  });

  let index = 0;
  const batchSize = 1000;
  const startTime = Date.now();
  let procesamientoCompletado = false; // FLAG CR√çTICO

  function procesarLote() {
    // VERIFICAR SI EL PROCESAMIENTO EST√Å ACTIVO Y NO COMPLETADO
    if (!window.procesamientoActivo || window.procesamientoCancelado || procesamientoCompletado) {
      console.log('üõë FUNCI√ìN BLOQUEADA - Procesamiento no activo, cancelado o ya completado');
      return;
    }
    
    const start = index;
    const end = Math.min(index + batchSize, dataPares.length);
    
    console.log(`üîÑ Procesando lote: ${start} a ${end} de ${dataPares.length} (√≠ndice actual: ${index})`);
    
    // Actualizar progreso del lote
    const progresoLote = document.getElementById('progreso-lote');
    if (progresoLote) {
      progresoLote.textContent = `${start + 1}-${end} / ${dataPares.length}`;
    }
    
    // Procesar pares del lote actual
    for (let i = start; i < end; i++) {
      // Verificar si el procesamiento sigue activo o cancelado en cada iteraci√≥n
      if (!window.procesamientoActivo || window.procesamientoCancelado || procesamientoCompletado) {
        console.log('üõë FUNCI√ìN BLOQUEADA - Procesamiento no activo, cancelado o ya completado (dentro del ciclo)');
        return;
      }
      
      const par = dataPares[i];
      const idA = par[0]?.toString().trim().toUpperCase();
      const idB = par[1]?.toString().trim().toUpperCase();
      
      if (!idA || !idB) {
        window.omitidos++;
        continue;
      }
      
      const datosTorreA = mapaTorres[idA] || [];
      const datosTorreB = mapaTorres[idB] || [];
      
      if (datosTorreA.length === 0 || datosTorreB.length === 0) {
  console.log(`‚ö†Ô∏è PAR CON TORRE FALTANTE: A="${idA}" (${datosTorreA.length} datos), B="${idB}" (${datosTorreB.length} datos)`);
  window.faltantes.push([
    idA, idB,
    datosTorreA.length === 0 ? 'FALTA A' : '',
    datosTorreB.length === 0 ? 'FALTA B' : ''
  ]);
  window.paresNoProcesados++;
}
      
      // Llenar formulario con datos de las torres
      document.getElementById('idA').value = idA;
      document.getElementById('nombreA').value = datosTorreA[3] || '';
      document.getElementById('latA').value = datosTorreA[11] || '';
      document.getElementById('lonA').value = datosTorreA[12] || '';
      document.getElementById('alturaA').value = datosTorreA[51] || '';
      document.getElementById('ranA').value = datosTorreA[52] || '';
      document.getElementById('TransA').value = datosTorreA[103] || '';
      document.getElementById('ArreA').value = datosTorreA[4] || '';
      document.getElementById('OnA').value = datosTorreA[102] || '';
      document.getElementById('TorreA').value = datosTorreA[21] || '';
      document.getElementById('EstadoA').value = datosTorreA[13] || '';
      
      document.getElementById('idB').value = idB;
      document.getElementById('nombreB').value = datosTorreB[3] || '';
      document.getElementById('latB').value = datosTorreB[11] || '';
      document.getElementById('lonB').value = datosTorreB[12] || '';
      document.getElementById('alturaB').value = datosTorreB[51] || '';
      document.getElementById('ranB').value = datosTorreB[52] || '';
      document.getElementById('TransB').value = datosTorreB[103] || '';
      document.getElementById('ArreB').value = datosTorreB[4] || '';
      document.getElementById('OnB').value = datosTorreB[102] || '';
      document.getElementById('TorreB').value = datosTorreB[21] || '';
      document.getElementById('EstadoB').value = datosTorreB[13] || '';
      
      actualizarCalculos();
      
      const get = id => document.getElementById(id).value.trim();
      const latA = parseFloat(get('latA'));
      const lonA = parseFloat(get('lonA'));
      const latB = parseFloat(get('latB'));
      const lonB = parseFloat(get('lonB'));
      
      if (!get('idA') || !get('idB')) continue;
      if (isNaN(latA) || isNaN(lonA) || isNaN(latB) || isNaN(lonB)) continue;
      
      const distanciaKm = calcularDistancia(latA, lonA, latB, lonB);
      const frecuencia = asignarFrecuencia(distanciaKm);
      
      const factibilidad = analizarFactibilidad(
        distanciaKm,
        get('ArreA'),
        get('ArreB'),
        get('TransA'),
        get('TransB'),
        get('TorreA'),
        get('TorreB'),
        get('OnA'),
        get('OnB'),
        true // esFactibleLOS
      );
      console.log('üîç factibilidad en procesarPares:', factibilidad); // ‚úÖ AGREGAR ESTA L√çNEA
      console.log('üì° diametroAntena en procesarPares:', factibilidad.diametroAntena); // ‚úÖ AGREGAR ESTA L√çNEA

      
      const estadoFactible = (factibilidad.advertencia)
        ? 'FACTIBLE (Requiere an√°lisis)'
        : (factibilidad.razon && factibilidad.razon.toUpperCase().includes('NO DISPONIBLE'))
          ? 'NO DISPONIBLE'
          : (factibilidad.factible ? 'S√ç' : 'NO');
      
      const filaDatos = [
        get('idA'), get('nombreA'), get('latA'), get('lonA'),
        document.getElementById('latArad').value,
        document.getElementById('lonArad').value,
        get('idB'), get('nombreB'), get('latB'), get('lonB'),
        document.getElementById('latBrad').value,
        document.getElementById('lonBrad').value,
        distanciaKm.toFixed(6), frecuencia,
        document.getElementById('disponibilidadAnual').value,
        get('alturaA'), get('alturaB'), get('ranA'), get('ranB'),
        get('TransA'), get('TransB'), get('ArreA'), get('ArreB'),
        get('OnA'), get('OnB'), get('TorreA'), get('TorreB'),
        get('EstadoA'), get('EstadoB'),
        estadoFactible,
        factibilidad.diametroAntena,
        factibilidad.tipoEnlace,
        JSON.stringify(factibilidad)
      ];
      
      const transA = get('TransA').toLowerCase();
      const transB = get('TransB').toLowerCase();
      
      if (transA && transB && transA === transB) {
        window.filasMismoTransporte.push(filaDatos);
      } else {
        window.filasDiferenteTransporte.push(filaDatos);
      }
      
      window.procesados++;
      actualizarResumenEnlaces();
      
      // Actualizar progreso en tiempo real
      const porcentaje = Math.round((window.procesados / dataPares.length) * 100);
      const barraProgreso = document.getElementById('barra-progreso');
      const porcentajeTexto = document.getElementById('porcentaje-progreso');
      const procesadosTexto = document.getElementById('pares-procesados');
      const restantesTexto = document.getElementById('pares-restantes');
      
      if (barraProgreso) barraProgreso.style.width = porcentaje + '%';
      if (porcentajeTexto) porcentajeTexto.textContent = porcentaje + '%';
      if (procesadosTexto) procesadosTexto.textContent = window.procesados.toLocaleString();
      if (restantesTexto) restantesTexto.textContent = (dataPares.length - window.procesados).toLocaleString();
      
      // Actualizar velocidad y tiempo
      const elapsed = Math.floor((Date.now() - startTime) / 1000);
      if (elapsed > 0) {
        const velocidad = window.procesados / (elapsed / 60);
        const tiempoRestante = Math.floor((dataPares.length - window.procesados) / velocidad * 60);
        
        const tiempoTranscurrido = document.getElementById('tiempo-transcurrido');
        const tiempoRestanteEl = document.getElementById('tiempo-restante');
        const velocidadEl = document.getElementById('velocidad-procesamiento');
        
        if (tiempoTranscurrido) tiempoTranscurrido.textContent = `${Math.floor(elapsed/60)}:${(elapsed%60).toString().padStart(2,'0')}`;
        if (tiempoRestanteEl) tiempoRestanteEl.textContent = `${Math.floor(tiempoRestante/60)}:${(tiempoRestante%60).toString().padStart(2,'0')}`;
        if (velocidadEl) velocidadEl.textContent = `${Math.round(velocidad)} pares/min`;
      }
    }
    
    // Actualizar √≠ndice para el siguiente lote
    index = end;
    
    console.log(`‚úÖ Lote completado. √çndice actualizado a: ${index}, Total procesados: ${window.procesados}`);
    actualizarResumenEnlaces();
    
    // VERIFICAR SI HAY M√ÅS PARES PARA PROCESAR
    if (index < dataPares.length && window.procesamientoActivo && !window.procesamientoCancelado && !procesamientoCompletado) {
      console.log(`üîÑ Continuando con siguiente lote...`);
      // Continuar con el siguiente lote despu√©s de una peque√±a pausa
      window.timeoutProcesamiento = setTimeout(() => {
        // VERIFICAR TRIPLEMENTE ANTES DE CONTINUAR
        if (window.procesamientoActivo && !window.procesamientoCancelado && !procesamientoCompletado && index < dataPares.length) {
          procesarLote();
        } else {
          console.log('üõë FUNCI√ìN BLOQUEADA - Procesamiento no activo, cancelado o ya completado (setTimeout)');
          // Si se cancel√≥, limpiar todo
          if (window.procesamientoCancelado || procesamientoCompletado) {
            window.procesamientoActivo = false;
            if (window.timeoutProcesamiento) {
              clearTimeout(window.timeoutProcesamiento);
              window.timeoutProcesamiento = null;
            }
          }
        }
      }, 50);
    } else {
      // PROCESAMIENTO COMPLETADO - DETENER COMPLETAMENTE
      console.log(`üéâ ¬°PROCESAMIENTO COMPLETADO! Total procesados: ${window.procesados}, Total omitidos: ${window.omitidos}`);
      
      // MARCAR COMO COMPLETADO INMEDIATAMENTE
      procesamientoCompletado = true;
      
      // DETENER PROCESAMIENTO INMEDIATAMENTE
      window.procesamientoActivo = false;
      window.procesamientoCancelado = true;
      
      // Limpiar timeout pendiente
      if (window.timeoutProcesamiento) {
        clearTimeout(window.timeoutProcesamiento);
        window.timeoutProcesamiento = null;
      }
      
      // Limpiar cualquier otro timeout que pueda estar pendiente
      for (let i = 1; i < 100000; i++) {
        clearTimeout(i);
        clearInterval(i);
      }
      
      // Llamar a completarProcesamiento SOLO UNA VEZ
      completarProcesamiento();
      
      // RETORNAR PARA EVITAR EJECUCI√ìN POSTERIOR
      return;
    }
  }
  
  // Iniciar procesamiento SOLO UNA VEZ
  procesarLote();
}


  let dataExcel = [];
  let filaEditando = null;
  let dataPares = [];


  function guardarArchivoExcelEnIndexedDB(nombre, arrayBuffer, info) {
  if (!window.db) {
    console.error('IndexedDB no est√° inicializada');
    return;
  }
  
  try {
    const tx = window.db.transaction('archivos', 'readwrite');
    const store = tx.objectStore('archivos');
    store.put({ nombre, arrayBuffer, info });
    tx.oncomplete = () => console.log('‚úÖ Archivo Excel guardado');
  } catch (error) {
    console.error('Error al guardar archivo Excel:', error);
  }
}
function cargarArchivoExcelDeIndexedDB(nombre, callback) {
  if (!window.db) {
    console.error('IndexedDB no est√° inicializada');
    callback(null, null);
    return;
  }
  
  try {
    const tx = window.db.transaction('archivos', 'readonly');
    const store = tx.objectStore('archivos');
    const getReq = store.get(nombre);
    getReq.onsuccess = function() {
      callback(getReq.result ? getReq.result.arrayBuffer : null, getReq.result ? getReq.result.info : null);
    };
  } catch (error) {
    console.error('Error al cargar archivo Excel:', error);
    callback(null, null);
  }
}
function cargarArchivoDeStorage() {
  const archivoInfo = localStorage.getItem('archivoExcelInfo');
  if (archivoInfo) {
    try {
      const info = JSON.parse(archivoInfo);
      cargarArchivoExcelDeIndexedDB(info.nombre, function(arrayBuffer, infoGuardada) {
        if (arrayBuffer) {
          const data = new Uint8Array(arrayBuffer);
          const workbook = XLSX.read(data, { type: 'array' });
          const sheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[sheetName];
          dataExcel = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
          mostrarArchivoCargado(infoGuardada || info);
        }
      });
    } catch (error) {
      console.error('Error al cargar archivo desde storage:', error);
    }
  }
}
function guardarArchivoParesEnIndexedDB(nombre, arrayBuffer, info) {
  if (!window.db) {
    console.error('IndexedDB no est√° inicializada');
    return;
  }
  
  try {
    const tx = window.db.transaction('pares', 'readwrite');
    const store = tx.objectStore('pares');
    store.put({ nombre, arrayBuffer, info });
    tx.oncomplete = () => console.log('‚úÖ Archivo de pares guardado');
  } catch (error) {
    console.error('Error al guardar archivo de pares:', error);
  }
}
function cargarArchivoParesDeIndexedDB(nombre, callback) {
  if (!window.db) {
    console.error('IndexedDB no est√° inicializada');
    callback(null, null);
    return;
  }
  
  try {
    const tx = window.db.transaction('pares', 'readonly');
    const store = tx.objectStore('pares');
    const getReq = store.get(nombre);
    getReq.onsuccess = function() {
      callback(getReq.result ? getReq.result.arrayBuffer : null, getReq.result ? getReq.result.info : null);
    };
  } catch (error) {
    console.error('Error al cargar archivo de pares:', error);
    callback(null, null);
}
}

function cargarArchivoParesDeStorage() {
  const archivoInfo = localStorage.getItem('archivoParesInfo');
  if (archivoInfo) {
    try {
      const info = JSON.parse(archivoInfo);
      cargarArchivoParesDeIndexedDB(info.nombre, function(arrayBuffer, infoGuardada) {
        if (arrayBuffer) {
          const data = new Uint8Array(arrayBuffer);
          const workbook = XLSX.read(data, { type: 'array' });
          const sheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[sheetName];
          dataPares = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
          const contenedor = document.getElementById('archivo-pares-cargado');
          const nombreArchivo = document.getElementById('nombre-archivo-pares');
          const infoArchivo = document.getElementById('info-archivo-pares');
          if (contenedor && nombreArchivo && infoArchivo) {
            nombreArchivo.textContent = infoGuardada.nombre;
            infoArchivo.textContent = `${infoGuardada.filas} filas ‚Ä¢ ${(infoGuardada.tama√±o / 1024).toFixed(1)} KB ‚Ä¢ Cargado: ${new Date(infoGuardada.fechaCarga).toLocaleString()}`;
            contenedor.style.display = 'block';
            document.getElementById('inputFilePairs').style.display = 'none';
          }
        }
      });
    } catch (error) {
      console.error('Error al cargar archivo de pares desde storage:', error);
    }
  }
} 
function guardarEnlacesEnStorage() {
  // ÔøΩÔøΩ PROTECCI√ìN M√ÅXIMA
  if (window.procesamientoCancelado || !window.procesamientoActivo) {
    console.log('üõë FUNCI√ìN BLOQUEADA - Procesamiento no activo o cancelado');
    return;
  }
  
  // Verificar si ya se guardaron enlaces recientemente
  if (window.enlacesGuardadosRecientemente) {
    console.log('üõë Enlaces ya fueron guardados recientemente');
    return;
  }
  
  // Verificar si se cancel√≥ el procesamiento
  if (window.procesamientoCancelado) {
    console.log('üõë Procesamiento cancelado');
    return;
  }
  
  // Verificar si el procesamiento est√° activo
  if (!window.procesamientoActivo) {
    console.log('üõë Procesamiento no activo');
    return;
  }
  
  // Si pasa todas las verificaciones, entonces guardar
  try {
    const tabla = document.querySelector('#tabla tbody');
    if (!tabla) {
      console.log('üõë Tabla no encontrada');
      return;
    }
    
    const filas = tabla.querySelectorAll('tr');
    if (filas.length === 0) {
      console.log('ÔøΩÔøΩ No hay filas en la tabla');
      return;
    }
    
    const enlaces = [];
    filas.forEach(fila => {
      const celdas = fila.querySelectorAll('td');
      const enlace = [];
      for (let i = 1; i < celdas.length; i++) {
        if (i === 33 && celdas[i].querySelector('button') && celdas[i].dataset.analisis) {
          enlace.push(celdas[i].dataset.analisis);
        } else {
          enlace.push(celdas[i].textContent);
        }
      }
      enlaces.push(enlace);
    });
    
    localStorage.setItem('enlacesPtP', JSON.stringify(enlaces));
    console.log('üíæ Enlaces guardados:', enlaces.length);
    
    // Marcar que se guardaron enlaces
    window.enlacesGuardadosRecientemente = true;
    
    // Resetear despu√©s de 10 segundos
    setTimeout(() => {
      window.enlacesGuardadosRecientemente = false;
    }, 10000);
    
  } catch (error) {
    console.error('‚ùå Error al guardar enlaces:', error);
  }
}
function cargarEnlacesDeStorage() {
  const enlacesGuardados = localStorage.getItem('enlacesPtP');
  if (!enlacesGuardados) return;
  
  try {
  const enlaces = JSON.parse(enlacesGuardados);
  const tbody = document.querySelector('#tabla tbody');
    if (!tbody) return;
    
    tbody.innerHTML = ''; // Limpiar tabla

  enlaces.forEach(enlaceData => {
    const fila = document.createElement('tr');
    const tdCheck = document.createElement('td');
    const check = document.createElement('input');
    check.type = 'checkbox';
    check.className = 'check-enlace';
    check.onclick = function(e) {
      e.stopPropagation();
      actualizarBotonEliminarSeleccionados();
    };
    tdCheck.appendChild(check);
    fila.appendChild(tdCheck);

enlaceData.forEach((val, i) => {
  const td = document.createElement('td');
        if (i === 32) { // An√°lisis
          td.innerHTML = `<button class="btn btn-info btn-sm" onclick="mostrarAnalisisDetallado(${JSON.stringify(val)})" style="width: 120px; font-size: 0.9rem;"><i class="fas fa-info-circle"></i> Ver An√°lisis</button>`;
        } else if (i === 29) { // Factible
    let valNorm = val.trim().toUpperCase();
    let badge = '';
    if (valNorm.startsWith('S√ç') || valNorm.startsWith('FACTIBLE')) {
      badge = `<span class="badge badge-factible">Factible</span>`;
    } else if (valNorm.startsWith('NO')) {
      badge = `<span class="badge badge-nofactible">No Factible</span>`;
    } else {
      badge = `<span class="badge badge-indef">N/D</span>`;
    }
    td.innerHTML = badge;
  } else {
    td.textContent = val;
  }
  fila.appendChild(td);
});
      tbody.appendChild(fila);
    });
    
    actualizarContadorEnlaces();
    verificarEnlacesVacios();
    console.log('‚úÖ Enlaces cargados:', enlaces.length);
  } catch (error) {
    console.error('‚ùå Error al cargar enlaces:', error);
  }
}

// Variable global para controlar la carga
let enlacesCargados = false;
// Funci√≥n simple y directa que S√ç funciona
function cargarEnlacesInmediatamente() {
  console.log('üöÄ CARGANDO ENLACES INMEDIATAMENTE...');
  
  const enlacesGuardados = localStorage.getItem('enlacesPtP');
  console.log('üì¶ Enlaces en localStorage:', enlacesGuardados ? 'S√ç' : 'NO');
  
  if (!enlacesGuardados) {
    console.log('‚ùå No hay enlaces guardados');
    return;
  }
  
  try {
    const enlaces = JSON.parse(enlacesGuardados);
    console.log(` Cargando ${enlaces.length} enlaces...`);
    
    const tbody = document.querySelector('#tabla tbody');
    if (!tbody) {
      console.log('‚ùå No se encontr√≥ la tabla');
      return;
    }
    
    // Limpiar tabla
    tbody.innerHTML = '';
    
    // Cargar TODOS los enlaces de una vez
    enlaces.forEach((enlaceData, index) => {
      const fila = document.createElement('tr');
      
      // Checkbox
      const tdCheck = document.createElement('td');
      const check = document.createElement('input');
      check.type = 'checkbox';
      check.className = 'check-enlace';
      check.onclick = function(e) {
        e.stopPropagation();
        actualizarBotonEliminarSeleccionados();
      };
      tdCheck.appendChild(check);
      fila.appendChild(tdCheck);
      
      // Datos del enlace
      enlaceData.forEach((val, i) => {
        const td = document.createElement('td');
        
        if (i === 32) { // An√°lisis
          td.innerHTML = `
            <button class="btn btn-info btn-sm" 
                    onclick="mostrarAnalisisDetallado(${JSON.stringify(val)})"
                    style="width: 120px; font-size: 0.9rem;">
              <i class="fas fa-info-circle"></i> Ver An√°lisis
            </button>
          `;
        } else if (i === 29) { // Factible
          let valNorm = val.trim().toUpperCase();
          let badge = '';
          if (valNorm.startsWith('S√ç') || valNorm.startsWith('FACTIBLE')) {
            badge = `<span class="badge badge-factible">Factible</span>`;
          } else if (valNorm.startsWith('NO')) {
            badge = `<span class="badge badge-nofactible">No Factible</span>`;
          } else {
            badge = `<span class="badge badge-indef">N/D</span>`;
          }
          td.innerHTML = badge;
        } else {
          td.textContent = val;
        }
        
        fila.appendChild(td);
      });

    tbody.appendChild(fila);
  });
    
    // Actualizar contadores
  actualizarContadorEnlaces();
  verificarEnlacesVacios();
    
    console.log('‚úÖ ENLACES CARGADOS EXITOSAMENTE');
    
  } catch (error) {
    console.error('‚ùå Error al cargar enlaces:', error);
}
}


document.querySelector('#tabla tbody').addEventListener('click', function(e) {
  let fila = e.target.closest('tr');
  if (!fila) return;
  document.querySelectorAll('#tabla tbody tr').forEach(f => f.classList.remove('selected'));
  fila.classList.add('selected');
  actualizarBotonPerfilElevacionGlobal();
});
document.querySelector('#tabla tbody').addEventListener('dblclick', function(e) {
  let fila = e.target.closest('tr');
  if (!fila) return;
  
  // Obtener los datos de la fila
  const celdas = fila.querySelectorAll('td');
  const datos = {
    idA: celdas[1]?.textContent,
    nombreA: celdas[2]?.textContent,
    latA: celdas[3]?.textContent,
    lonA: celdas[4]?.textContent,
    idB: celdas[7]?.textContent,
    nombreB: celdas[8]?.textContent,
    latB: celdas[9]?.textContent,
    lonB: celdas[10]?.textContent,
    alturaA: celdas[16]?.textContent, 
    alturaB: celdas[17]?.textContent, 
    frecuencia: celdas[13]?.textContent
  };
  
  // Mostrar el perfil de elevaci√≥n
  mostrarPerfilElevacionDesdeDatos(datos);
  
  // Hacer scroll al gr√°fico
  const perfilDiv = document.getElementById('perfil-elevacion-con-torres');
  if (perfilDiv) {
    perfilDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
});

document.getElementById('btnPerfilElevacionGlobal').onclick = function() {
  const fila = document.querySelector('#tabla tbody tr.selected');
  if (!fila) return;
  const celdas = fila.querySelectorAll('td');
const datos = {
  idA: celdas[1]?.textContent,
  nombreA: celdas[2]?.textContent,
  latA: celdas[3]?.textContent,
  lonA: celdas[4]?.textContent,
  idB: celdas[7]?.textContent,
  nombreB: celdas[8]?.textContent,
  latB: celdas[9]?.textContent,
  lonB: celdas[10]?.textContent,
  alturaA: celdas[16]?.textContent, 
  alturaB: celdas[17]?.textContent, 
  frecuencia: celdas[13]?.textContent
};
  mostrarPerfilElevacionDesdeDatos(datos);
  const perfilDiv = document.getElementById('perfil-elevacion-con-torres');
  if (perfilDiv) {
    perfilDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
};
// ==================== GESTI√ìN DE ARCHIVOS ====================
function mostrarArchivoCargado(archivoInfo) {
  const contenedor = document.getElementById('archivo-cargado');
  const nombreArchivo = document.getElementById('nombre-archivo');
  const infoArchivo = document.getElementById('info-archivo');
  if (contenedor && nombreArchivo && infoArchivo) {
    nombreArchivo.textContent = archivoInfo.nombre;
    infoArchivo.textContent = `${archivoInfo.filas} filas ‚Ä¢ ${(archivoInfo.tama√±o / 1024).toFixed(1)} KB ‚Ä¢ Cargado: ${new Date(archivoInfo.fechaCarga).toLocaleString()}`;
    contenedor.style.display = 'block';
    document.getElementById('inputFile').style.display = 'none';
  }
}
function borrarArchivo() {
  if (confirm('¬øEst√°s seguro de que quieres borrar el archivo cargado? Esto eliminar√° todos los datos del Excel.')) {
    dataExcel = [];
    localStorage.removeItem('archivoExcelInfo');
    const contenedor = document.getElementById('archivo-cargado');
    const inputFile = document.getElementById('inputFile');
    if (contenedor) contenedor.style.display = 'none';
    if (inputFile) {
      inputFile.style.display = 'block';
      inputFile.value = '';
    } 
    alert('‚úÖ Archivo eliminado correctamente');
  }
}
function borrarArchivoPares() {
  if (confirm('¬øEst√°s seguro de que quieres borrar el archivo de pares cargado? Esto eliminar√° todos los datos de pares.')) {
    dataPares = [];
    localStorage.removeItem('archivoParesInfo');
    const request = indexedDB.open('ArchivosExcelDB', 3);
    request.onsuccess = function(event) {
      const db = event.target.result;
      if (db.objectStoreNames.contains('pares')) {
        const tx = db.transaction('pares', 'readwrite');
        const store = tx.objectStore('pares');
        const archivoInfo = JSON.parse(localStorage.getItem('archivoParesInfo') || '{}');
        if (archivoInfo.nombre) store.delete(archivoInfo.nombre);
        tx.oncomplete = () => db.close();
      }
    };
    const contenedor = document.getElementById('archivo-pares-cargado');
    const inputFile = document.getElementById('inputFilePairs');
    if (contenedor) contenedor.style.display = 'none';
    if (inputFile) {
      inputFile.style.display = 'block';
      inputFile.value = '';
    }
    alert('‚úÖ Archivo de pares eliminado correctamente');
  }
}
  document.getElementById('borrar-archivo').addEventListener('click', borrarArchivo);
  document.getElementById('idA').addEventListener('blur', () => autoCompletar('A'));
  document.getElementById('idB').addEventListener('blur', () => autoCompletar('B'));
  document.getElementById('latA').addEventListener('input', actualizarCalculos);
  document.getElementById('lonA').addEventListener('input', actualizarCalculos);
  document.getElementById('latB').addEventListener('input', actualizarCalculos);
  document.getElementById('lonB').addEventListener('input', actualizarCalculos);
  function actualizarContadorEnlaces() {
  const filas = document.querySelectorAll('#tabla tbody tr');
  const totalEnlaces = filas.length;
  let totalFactibles = 0;
  
  // Contar enlaces factibles
  filas.forEach(fila => {
    const celdas = fila.querySelectorAll('td');
    if (celdas.length >= 31) {
      // La columna Factible est√° en el √≠ndice 30 (despu√©s del checkbox)
      const factible = celdas[30]?.textContent.trim().toUpperCase().startsWith('S√ç') || 
                       celdas[30]?.textContent.trim().toUpperCase().startsWith('FACTIBLE');
      if (factible) totalFactibles++;
    }
  });
  
  // Actualizar contadores
  const contadorElement = document.getElementById('contador-enlaces');
  const totalElement = document.getElementById('total-enlaces');
  const resumenTotalElement = document.getElementById('resumen-total-enlaces');
  const resumenFactiblesElement = document.getElementById('resumen-enlaces-factibles');
  
  if (contadorElement) contadorElement.textContent = totalEnlaces;
  if (totalElement) totalElement.textContent = totalEnlaces;
  if (resumenTotalElement) resumenTotalElement.textContent = totalEnlaces;
  if (resumenFactiblesElement) resumenFactiblesElement.textContent = totalFactibles;
  
  console.log(`üìä Contadores actualizados: Total=${totalEnlaces}, Factibles=${totalFactibles}`);
}
function crearPanelControlesMapa() {
  const panel = L.control({position: 'topright'});
  
  panel.onAdd = function() {
    const div = L.DomUtil.create('div', 'panel-controles-mapa');
    div.innerHTML = `
      <div class="panel-header">
        <h4><i class="fas fa-cog"></i> Controles del Mapa</h4>
      </div>
      <div class="panel-content">
        <div class="control-group">
          <label><i class="fas fa-filter"></i> Filtros</label>
          <select id="filtro-factibilidad">
            <option value="todos">Todos los Enlaces</option>
            <option value="factibles">Solo Factibles</option>
            <option value="no-factibles">Solo No Factibles</option>
          </select>
        </div>
        <div class="control-group">
          <label><i class="fas fa-eye"></i> Vista</label>
          <button id="btn-vista-satelite" class="btn-vista">Sat√©lite</button>
          <button id="btn-vista-calles" class="btn-vista active">Calles</button>
        </div>
        <div class="control-group">
          <label><i class="fas fa-search"></i> B√∫squeda</label>
          <input type="text" id="buscar-enlace" placeholder="Buscar enlace...">
        </div>
      </div>
    `;
    return div;
  };
  
  return panel;
}

function crearPanelEstadisticasAvanzadas() {
  const panel = L.control({position: 'bottomleft'});
  
  panel.onAdd = function() {
    const div = L.DomUtil.create('div', 'panel-estadisticas-avanzadas');
    div.innerHTML = `
      <div class="stats-header">
        <h4><i class="fas fa-chart-bar"></i> Estad√≠sticas Avanzadas</h4>
        <button id="btn-expandir-stats"><i class="fas fa-expand"></i></button>
      </div>
      <div class="stats-content">
        <div class="stat-card">
          <div class="stat-icon factible"><i class="fas fa-check-circle"></i></div>
          <div class="stat-info">
            <span class="stat-value" id="contador-factibles">12</span>
            <span class="stat-label">Factibles</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon no-factible"><i class="fas fa-times-circle"></i></div>
          <div class="stat-info">
            <span class="stat-value" id="contador-no-factibles">13</span>
            <span class="stat-label">No Factibles</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon total"><i class="fas fa-link"></i></div>
          <div class="stat-info">
            <span class="stat-value" id="contador-total">25</span>
            <span class="stat-label">Total</span>
          </div>
        </div>
        <div class="stat-progress">
          <div class="progress-bar">
            <div class="progress-fill factible" style="width: 48%"></div>
            <div class="progress-fill no-factible" style="width: 52%"></div>
          </div>
          <span class="progress-text">48% Factibles</span>
        </div>
      </div>
    `;
    return div;
  };
  
  return panel;
}


function crearPopupEnlaceMejorado(enlace) {
  return `
    <div class="popup-enlace">
      <div class="popup-header ${enlace.factible ? 'factible' : 'no-factible'}">
        <h4><i class="fas fa-link"></i> Enlace ${enlace.idA} ‚Üí ${enlace.idB}</h4>
        <span class="badge ${enlace.factible ? 'badge-success' : 'badge-danger'}">
          ${enlace.factible ? 'FACTIBLE' : 'NO FACTIBLE'}
        </span>
      </div>
      <div class="popup-content">
        <div class="info-grid">
          <div class="info-item">
            <i class="fas fa-route"></i>
            <span>Distancia: ${enlace.distancia} km</span>
          </div>
          <div class="info-item">
            <i class="fas fa-broadcast-tower"></i>
            <span>Frecuencia: ${enlace.frecuencia} GHz</span>
          </div>
          <div class="info-item">
            <i class="fas fa-percentage"></i>
            <span>Disponibilidad: ${enlace.disponibilidad}%</span>
          </div>
        </div>
        <div class="popup-actions">
          <button class="btn-popup" onclick="mostrarDetalleEnlace('${enlace.id}')">
            <i class="fas fa-info-circle"></i> Ver Detalle
          </button>
          <button class="btn-popup" onclick="mostrarPerfilElevacion('${enlace.id}')">
            <i class="fas fa-mountain"></i> Perfil
          </button>
        </div>
      </div>
    </div>
  `;
}

function crearControlCapas() {
  const controlCapas = L.control.layers(null, null, {
    position: 'topright',
    collapsed: false
  });
  
  // Capa base
  const capaCalles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap contributors'
  });
  
  const capaSatelite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution: '¬© Esri'
  });
  
  // Capas de enlaces
  const capaFactibles = L.layerGroup();
  const capaNoFactibles = L.layerGroup();
  const capaTodos = L.layerGroup();
  
  controlCapas.addBaseLayer(capaCalles, 'Calles');
  controlCapas.addBaseLayer(capaSatelite, 'Sat√©lite');
  controlCapas.addOverlay(capaFactibles, 'Enlaces Factibles');
  controlCapas.addOverlay(capaNoFactibles, 'Enlaces No Factibles');
  controlCapas.addOverlay(capaTodos, 'Todos los Enlaces');
  
  return { controlCapas, capaFactibles, capaNoFactibles, capaTodos };
}
function crearSistemaBusqueda() {
  const busqueda = L.control({position: 'topleft'});
  
  busqueda.onAdd = function() {
    const div = L.DomUtil.create('div', 'control-busqueda');
    div.innerHTML = `
      <div class="search-container">
        <input type="text" id="busqueda-enlaces" placeholder="üîç Buscar enlaces, sitios...">
        <div class="search-filters">
          <select id="filtro-tipo">
            <option value="">Todos los tipos</option>
            <option value="factible">Factibles</option>
            <option value="no-factible">No Factibles</option>
          </select>
          <select id="filtro-frecuencia">
            <option value="">Todas las frecuencias</option>
            <option value="6">6 GHz</option>
            <option value="11">11 GHz</option>
            <option value="18">18 GHz</option>
          </select>
        </div>
      </div>
    `;
    return div;
  };
  
  return busqueda;
}

  
 function verificarEnlacesVacios() {
    const totalEnlaces = document.querySelectorAll('#tabla tbody tr').length;
    const tabla = document.querySelector('.table-container');
    const mensaje = document.getElementById('mensaje-sin-enlaces');
    if (totalEnlaces === 0) {
      tabla.style.display = 'none';
      mensaje.style.display = 'block';
    } else {
      tabla.style.display = 'block';
      mensaje.style.display = 'none';
    }
  }
  //function mostrarAnalisisDetallado(analisis) {
  // Crear modal o popup con el an√°lisis completo
 // const modal = document.createElement('div');
 // modal.style.cssText = `
 //   position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
 //   background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.5);
 //   max-width: 80%; max-height: 80%; overflow-y: auto; z-index: 10000;
 // `;
  
 // modal.innerHTML = `
 //   <h3>An√°lisis Detallado</h3>
 //   <pre style="white-space: pre-wrap; font-size: 12px;">${JSON.stringify(analisis, null, 2)}</pre>
 //   <button onclick="this.parentElement.remove()" style="margin-top: 10px;">Cerrar</button>
 // `;
  
 // document.body.appendChild(modal);
//}
 function autoCompletar(letra) {
  const id = document.getElementById('id' + letra).value.trim().toUpperCase();
if (!id) return;
const fila = dataExcel.find(row => row[0] && row[0].toString().trim().toUpperCase() === id);
  if (fila) {
    document.getElementById('nombre' + letra).value = fila[3] || '';
    document.getElementById('lat' + letra).value = fila[11] || '';
    document.getElementById('lon' + letra).value = fila[12] || '';
    document.getElementById('altura' + letra).value = fila[51] || '';
    document.getElementById('ran' + letra).value = fila[52] || '';
    document.getElementById('Trans' + letra).value = fila[103] || '';
    document.getElementById('Arre' + letra).value = fila[4] || '';
    document.getElementById('On' + letra).value = fila[102] || '';
    document.getElementById('Torre' + letra).value = fila[21] || '';
    document.getElementById('Estado' + letra).value = fila[13] || '';
    actualizarCalculos();
  } else {
    document.getElementById('nombre' + letra).value = '';
    document.getElementById('lat' + letra).value = '';
    document.getElementById('lon' + letra).value = '';
    document.getElementById('altura' + letra).value = '';
    document.getElementById('ran' + letra).value = '';
    document.getElementById('Trans' + letra).value = '';
    document.getElementById('Arre' + letra).value = '';
    document.getElementById('On' + letra).value = '';
    document.getElementById('Torre' + letra).value = '';
    document.getElementById('Estado' + letra).value = '';
    actualizarCalculos();
  }
}
  function actualizarCalculos() {
    actualizarRadianes();
    calcularDistanciaYFrecuencia();
    calcularCurvaturaFresnel();
  }
  function actualizarRadianes() {
    const rad = x => x * Math.PI / 180;
    const latA = parseFloat(document.getElementById('latA').value);
    const lonA = parseFloat(document.getElementById('lonA').value);
    const latB = parseFloat(document.getElementById('latB').value);
    const lonB = parseFloat(document.getElementById('lonB').value);
    document.getElementById('latArad').value = isNaN(latA) ? '' : rad(latA).toFixed(6);
    document.getElementById('lonArad').value = isNaN(lonA) ? '' : rad(lonA).toFixed(6);
    document.getElementById('latBrad').value = isNaN(latB) ? '' : rad(latB).toFixed(6);
    document.getElementById('lonBrad').value = isNaN(lonB) ? '' : rad(lonB).toFixed(6);
  }
  function calcularDistancia(lat1, lon1, lat2, lon2) {
    if (isNaN(lat1) || isNaN(lon1) || isNaN(lat2) || isNaN(lon2)) return NaN;
    const rad = x => x * Math.PI / 180;
    const R = 6371.0088;
    const œÜ1 = rad(lat1), œÜ2 = rad(lat2);
    const ŒîœÜ = rad(lat2 - lat1);
    const ŒîŒª = rad(lon2 - lon1);
    const a = Math.sin(ŒîœÜ / 2) ** 2 +
              Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª / 2) ** 2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }
  function desdeFormulario() {
  return {
    'Latitud A': document.getElementById('latA').value,
    'Longitud A': document.getElementById('lonA').value,
    'Latitud B': document.getElementById('latB').value,
    'Longitud B': document.getElementById('lonB').value,
    'Altura Torre A': document.getElementById('alturaA').value,
    'Altura Torre B': document.getElementById('alturaB').value,
    'Frecuencia': document.getElementById('frecuencia').value,
    'idA': document.getElementById('idA').value,
    'idB': document.getElementById('idB').value,
    'nombreA': document.getElementById('nombreA').value,
    'nombreB': document.getElementById('nombreB').value
  };
}
  // ==================== VALIDACIONES DE FACTIBILIDAD ====================
  function asignarFrecuencia(distanciaKm) {
    if (isNaN(distanciaKm)) return ''; 
    if (distanciaKm <= 5) {
      return '80';
    } else if (distanciaKm <= 15) {
      return '15';
    } else {
      return '8';
    }
  }
  function calcularDistanciaYFrecuencia() {
    const latA = parseFloat(document.getElementById('latA').value);
    const lonA = parseFloat(document.getElementById('lonA').value);
    const latB = parseFloat(document.getElementById('latB').value);
    const lonB = parseFloat(document.getElementById('lonB').value);
    const distanciaKm = calcularDistancia(latA, lonA, latB, lonB);
    if (!isNaN(distanciaKm)) {
      document.getElementById('distancia').value = distanciaKm.toFixed(6);
      document.getElementById('frecuencia').value = asignarFrecuencia(distanciaKm);
    } else {
      document.getElementById('distancia').value = '';
      document.getElementById('frecuencia').value = '';
    }
    calcularDisponibilidadAnual();
  }
  function calcularDisponibilidadAnual() {
  const distanciaKm = parseFloat(document.getElementById('distancia').value);
  const frecuenciaGHz = parseFloat(document.getElementById('frecuencia').value);
  if (isNaN(distanciaKm) || isNaN(frecuenciaGHz)) {
    document.getElementById('disponibilidadAnual').value = '';
    return;
  }
  let disponibilidad = 100 - (distanciaKm * 0.15) - (frecuenciaGHz * 0.5);
  if (disponibilidad < 0) disponibilidad = 0;
  if (disponibilidad > 100) disponibilidad = 100;
  document.getElementById('disponibilidadAnual').value = disponibilidad.toFixed(2);
}
function calcularCurvaturaFresnel() {
  const distanciaKm = parseFloat(document.getElementById('distancia').value);
  const alturaTorreA = parseFloat(document.getElementById('alturaA').value);
  const alturaTorreB = parseFloat(document.getElementById('alturaB').value);
  const frecuenciaGHz = parseFloat(document.getElementById('frecuencia').value);
  if (
    isNaN(distanciaKm) ||
    isNaN(alturaTorreA) ||
    isNaN(alturaTorreB) ||
    isNaN(frecuenciaGHz) ||
    distanciaKm <= 0 ||
    alturaTorreA <= 0 ||
    alturaTorreB <= 0 ||
    frecuenciaGHz <= 0
  ) {
    document.getElementById('bulboCurvatura').value = '';
    document.getElementById('radioFresnel').value = '';
    document.getElementById('alturaLibre').value = '';
    document.getElementById('alturaDisponible').value = '';
    document.getElementById('factibilidadCurvatura').value = 'NO DISPONIBLE';
    return;
  }
  const R = 8495000; 
  const d_m = distanciaKm * 1000;
  const bulboCurvatura = (d_m * d_m) / (8 * R);
  const D = distanciaKm;
  const F1 = 17.32 * Math.sqrt(D / (4 * frecuenciaGHz));
  const alturaLibre = bulboCurvatura + 0.6 * F1;
  const alturaDisponible = Math.min(alturaTorreA, alturaTorreB);
  let factibilidadCurvatura = '';
  if (!isNaN(alturaDisponible) && !isNaN(alturaLibre)) {
    factibilidadCurvatura = alturaDisponible >= alturaLibre ? 'FACTIBLE' : 'NO FACTIBLE';
  } else {
    factibilidadCurvatura = 'NO DISPONIBLE';
  }
  document.getElementById('bulboCurvatura').value = bulboCurvatura.toFixed(2);
  document.getElementById('radioFresnel').value = F1.toFixed(2);
  document.getElementById('alturaLibre').value = alturaLibre.toFixed(2);
  document.getElementById('alturaDisponible').value = alturaDisponible.toFixed(2);
  document.getElementById('factibilidadCurvatura').value = factibilidadCurvatura;
}
// ============================================
//            AN√ÅLISIS DE FACTIBILIDAD 
// ============================================
function analizarFactibilidad(distanciaKm, arreA, arreB, transA, transB, torreA, torreB, OnA, OnB, esFactibleLOS = true) {
  let factible = false;
  let razon = '';
  let diametroAntena = '';
  let tipoEnlace = '';
  let detallesValidacion = [];
  if (!distanciaKm || isNaN(distanciaKm) || distanciaKm <= 0) {
    return {
      factible: false,
      razon: 'No factible - Distancia inv√°lida o cero',
      diametroAntena: 'N/A',
      tipoEnlace: 'Error de Datos',
      distancia: distanciaKm,
      detalles: ['‚ùå Error en c√°lculo de distancia']
    };
  }
  if (!distanciaKm || isNaN(distanciaKm) || distanciaKm <= 0) {
    return {
      factible: false,
      razon: 'No factible - Distancia inv√°lida o cero',
      diametroAntena: 'N/A',
      tipoEnlace: 'Error de Datos',
      distancia: distanciaKm,
      detalles: ['‚ùå Error en c√°lculo de distancia']
    };
  }
  const DISTANCIA_MAXIMA = 50;
  if (distanciaKm > DISTANCIA_MAXIMA) {
    return {
      factible: false,
      razon: `No factible - Distancia excesiva (${distanciaKm.toFixed(2)}km > ${DISTANCIA_MAXIMA}km)`,
      diametroAntena: 'N/A',
      tipoEnlace: 'Fuera de Rango',
      distancia: distanciaKm,
      detalles: [`‚ùå Distancia ${distanciaKm.toFixed(2)}km supera el l√≠mite m√°ximo de ${DISTANCIA_MAXIMA}km`]
    };
  }
    if (!esFactibleLOS) {
    return {
      factible: false,
      razon: 'No factible - L√≠nea de vista obstruida (perfil de elevaci√≥n)',
      diametroAntena: 'N/A',
      tipoEnlace: 'LOS Obstruida',
      distancia: distanciaKm,
      detalles: ['‚ùå L√≠nea de vista obstruida seg√∫n perfil de elevaci√≥n']
    };
  }
function analizarEnlaceSatelital() {
  if (!document.getElementById('latA').value || !document.getElementById('latB').value) {
    alert('‚ùå Debes ingresar al menos las coordenadas de ambos sitios antes de realizar el an√°lisis satelital');
    return;
  }
  const transAOriginal = document.getElementById('TransA').value;
  const transBOriginal = document.getElementById('TransB').value;

  try {
    document.getElementById('TransA').value = 'Satelite-OA';
    document.getElementById('TransB').value = 'Satelite-OA';
    const mensaje = 'üõ∞Ô∏è Analizando enlace en modo Satelital-Satelital...';
    const indicador = document.createElement('div');
    indicador.innerHTML = mensaje;
    indicador.style.cssText = 'position:fixed; top:20px; left:50%; transform:translateX(-50%); background:#00bcd4; color:#fff; padding:8px 16px; border-radius:20px; z-index:1000;';
    document.body.appendChild(indicador);
    setTimeout(() => indicador.remove(), 3000);
    agregarOActualizarEnlace();

  } finally {
    document.getElementById('TransA').value = transAOriginal;
    document.getElementById('TransB').value = transBOriginal;
  }
}
function validarEnlaceSatelital(distanciaKm) {
  if (distanciaKm > 100) {
    return {
      factible: false,
      mensaje: 'Distancia excesiva para enlace satelital'
    };
  }
  return {
    factible: true,
    mensaje: 'Distancia aceptable para enlace satelital'
  };
}

function esSatelital(tipoTransporte) {
  const t = (tipoTransporte || '').toLowerCase();
  return t.includes('starlink') || 
         t.includes('orbita') ||
         t.includes('satelite-oa') ||
         t.includes('satelital') ||
         t.includes('satellite') ||
         t.includes('sat-oa') ||
         t.includes('satelite') ||
         t.includes('sat√©lite');
}
  const arreANorm = (arreA || '').toLowerCase().trim();
  const arreBNorm = (arreB || '').toLowerCase().trim();
  const transANorm = (transA || '').toLowerCase().trim();
  const transBNorm = (transB || '').toLowerCase().trim();
  const torreANorm = (torreA || '').toLowerCase().trim();
  const torreBNorm = (torreB || '').toLowerCase().trim();
  const onAirANorm = (OnA || '').toLowerCase().trim();
  const onAirBNorm = (OnB || '').toLowerCase().trim();
  function estaOnAir(estadoOnAir) {
    return estadoOnAir.includes('on air') || 
           estadoOnAir.includes('onair') ||
           estadoOnAir.includes('operativo') ||
           estadoOnAir.includes('activo') ||
           estadoOnAir.includes('funcionando') ||
           estadoOnAir === 'si' ||
           estadoOnAir === 's√≠' ||
           estadoOnAir === 'yes';
  }
  function estaPendiente(estadoOnAir) {
    return estadoOnAir.includes('pendiente') ||
           estadoOnAir.includes('construcci√≥n') ||
           estadoOnAir.includes('construccion') ||
           estadoOnAir.includes('instalaci√≥n') ||
           estadoOnAir.includes('instalacion') ||
           estadoOnAir.includes('desarrollo') ||
           estadoOnAir.includes('proyecto') ||
           estadoOnAir.includes('planeado') ||
           estadoOnAir.includes('no operativo') ||
           estadoOnAir.includes('inactivo') ||
           estadoOnAir === 'no';
  }
  const onAirAActivo = estaOnAir(onAirANorm);
  const onAirBActivo = estaOnAir(onAirBNorm);
  const onAirAPendiente = estaPendiente(onAirANorm);
  const onAirBPendiente = estaPendiente(onAirBNorm);
if (onAirAPendiente) {
  let motivoOnAir = `Torre A est√° pendiente: "${OnA}"`;
  detallesValidacion.push(`‚ùå Torre A: "${OnA}" - Estado pendiente/inactivo`);
  if (onAirBPendiente) {
    detallesValidacion.push(`‚úÖ Torre B: "${OnB}" - Estado pendiente/inactivo (no bloquea factibilidad)`);
  } else {
    detallesValidacion.push(`‚úÖ Torre B: "${OnB}" - Estado operativo`);
  }
  detallesValidacion.push('‚ö†Ô∏è La torre A debe estar "On Air" (operativa) para establecer enlaces PtP');
  return {
    factible: false,
    razon: `No factible - ${motivoOnAir}`,
    diametroAntena: 'N/A',
    tipoEnlace: 'Torre No Operativa',
    distancia: distanciaKm,
    detalles: detallesValidacion
  };
}
  if (onAirAActivo && onAirBActivo) {
    detallesValidacion.push(`‚úÖ Torre A: "${OnA}" - Estado operativo confirmado`);
    detallesValidacion.push(`‚úÖ Torre B: "${OnB}" - Estado operativo confirmado`);
  } else {
    detallesValidacion.push(`‚ö†Ô∏è Torre A: "${OnA}" - Estado no claramente definido`);
    detallesValidacion.push(`‚ö†Ô∏è Torre B: "${OnB}" - Estado no claramente definido`);
    detallesValidacion.push(`‚ÑπÔ∏è Se asume estado operativo, pero verificar manualmente`);
  }
  function esTorreNoFactible(tipoTorre) {
    const t = tipoTorre.toLowerCase();
    return t.includes('poste') || 
           t.includes('monopolo') ||
           t.includes('mono polo') ||
           t.includes('mono-polo') ||
           t.includes('mastil') ||  
           t.includes('m√°stil'); 
  }
  const torreANoFactible = esTorreNoFactible(torreANorm);
  const torreBNoFactible = esTorreNoFactible(torreBNorm);
  if (torreANoFactible || torreBNoFactible) {
    let motivoTorre = '';
    if (torreANoFactible && torreBNoFactible) {
      motivoTorre = `Ambas torres son de tipo no compatible (A: ${torreA}, B: ${torreB})`;
      detallesValidacion.push(`‚ùå Torre A: "${torreA}" - Tipo no factible`);
      detallesValidacion.push(`‚ùå Torre B: "${torreB}" - Tipo no factible`);
    } else if (torreANoFactible) {
      motivoTorre = `Torre A es de tipo no compatible: "${torreA}"`;
      detallesValidacion.push(`‚ùå Torre A: "${torreA}" - Tipo no factible`);
      detallesValidacion.push(`‚úÖ Torre B: "${torreB}" - Tipo compatible`);
    } else {
      motivoTorre = `Torre B es de tipo no compatible: "${torreB}"`;
      detallesValidacion.push(`‚úÖ Torre A: "${torreA}" - Tipo compatible`);
      detallesValidacion.push(`‚ùå Torre B: "${torreB}" - Tipo no factible`);
    }
    detallesValidacion.push('‚ö†Ô∏è Los tipos de torre "poste" y "monopolo" no son compatibles para enlaces PtP');
    return {
      factible: false,
      razon: `No factible - ${motivoTorre}`,
      diametroAntena: 'N/A',
      tipoEnlace: 'Torre Incompatible',
      distancia: distanciaKm,
      detalles: detallesValidacion
    };
  }
  detallesValidacion.push(`‚úÖ Torre A: "${torreA}" - Tipo compatible para enlace PtP`);
  detallesValidacion.push(`‚úÖ Torre B: "${torreB}" - Tipo compatible para enlace PtP`);
  const alturaLibre = parseFloat(document.getElementById('alturaLibre').value);
  const alturaDisponible = parseFloat(document.getElementById('alturaDisponible').value);
  if (!isNaN(alturaLibre) && !isNaN(alturaDisponible)) {
    if (alturaDisponible < alturaLibre) {
      detallesValidacion.push(`‚ùå L√≠nea de vista obstruida: Altura disponible (${alturaDisponible.toFixed(2)} m) < Altura libre necesaria (${alturaLibre.toFixed(2)} m)`);
      return {
        factible: false,
        razon: 'No factible - L√≠nea de vista obstruida (altura insuficiente)',
        diametroAntena: 'N/A',
        tipoEnlace: 'LOS Obstruida',
        distancia: distanciaKm,
        detalles: detallesValidacion
      };
    } else {
      detallesValidacion.push(`‚úÖ L√≠nea de vista: Altura disponible (${alturaDisponible.toFixed(2)} m) ‚â• Altura libre necesaria (${alturaLibre.toFixed(2)} m)`);
    }
  }
  function calcularDiametroAntena(distancia, esArrendamiento = false) {
    console.log('üîç calcularDiametroAntena llamada con:', { distancia, esArrendamiento }); // ‚úÖ AGREGAR ESTA L√çNEA

    if (esArrendamiento) {
      if (distancia <= 3.1) return '1 pie';
      if (distancia <= 8) return '2 pies';
      if (distancia <= 13.5) return '3 pies';
      return 'No factible';
    }
  if (distancia >= 0 && distancia <= 3) return '1 pie';
  if (distancia > 3 && distancia <= 5) return '2 pies';
  if (distancia > 5 && distancia <= 10) return '3 pies';
  if (distancia > 10 && distancia <= 20) return '4 pies';
  if (distancia > 20) return '6 pies';
  return 'No factible';
}
   function validarCapacidadAntena(distancia, diametro, esArrendamiento = false) {
    if (esArrendamiento) {
      if (diametro === '1 pie') return distancia <= 3.1;
      if (diametro === '2 pies') return distancia > 3.1 && distancia <= 8;
      if (diametro === '3 pies') return distancia > 8 && distancia <= 13.5;
      return false;
    }
  if (diametro === '1 pie') return distancia >= 0 && distancia <= 3;
  if (diametro === '2 pies') return distancia > 3 && distancia <= 5;
  if (diametro === '3 pies') return distancia > 5 && distancia <= 10;
  return false;
}
  function esArrendada(tipoArrendamiento) {
    return tipoArrendamiento.includes('arrendada') || 
           tipoArrendamiento.includes('arrendamiento') ||
           tipoArrendamiento.includes('renta');
  }
  function esAdquisicion(tipoArrendamiento) {
    return tipoArrendamiento.includes('adquisici√≥n') || 
           tipoArrendamiento.includes('adquisicion') ||
           tipoArrendamiento.includes('compra') ||
           tipoArrendamiento.includes('propia');
  }
  function esFibra(tipoTransporte) {
    return tipoTransporte.includes('fibra') || 
           tipoTransporte.includes('√≥ptica') ||
           tipoTransporte.includes('optica') ||
           tipoTransporte.includes('fo');
  }
function esSatelital(tipoTransporte) {
  return tipoTransporte.includes('starlink') || 
         tipoTransporte.includes('orbita') ||
         tipoTransporte.includes('satelite-oa') ||
         tipoTransporte.includes('satelital') ||
         tipoTransporte.includes('satellite');
  }
  const transporteBNulo = transBNorm === 'n/a' || transBNorm === '0' || transBNorm === '' || transBNorm === 'na';
if (transporteBNulo) {
  const fibraA = esFibra(transANorm);
  detallesValidacion.push('‚úÖ Transporte en B est√° vac√≠o/N/A/0, se permite enlace si A tiene fibra √≥ptica');
  if (!fibraA) {
    detallesValidacion.push('‚ùå Torre A debe tener Fibra √ìptica');
    return {
      factible: false,
      razon: `No factible - Torre A debe tener Fibra √ìptica`,
      diametroAntena: 'N/A',
      tipoEnlace: 'Transporte Incompatible',
      distancia: distanciaKm,
      detalles: detallesValidacion
    };
  }
  diametroAntena = calcularDiametroAntena(distanciaKm, false);
  detallesValidacion.push(`üì° Antenas requeridas: ${diametroAntena} (seg√∫n distancia ${distanciaKm.toFixed(2)}km)`);
  if (validarCapacidadAntena(distanciaKm, diametroAntena)) {
    detallesValidacion.push(`‚úÖ Distancia ${distanciaKm.toFixed(2)}km compatible con antenas de ${diametroAntena}`);
    factible = true;
    razon = `Enlace factible - Fibra en A, B vac√≠o, distancia: ${distanciaKm.toFixed(2)}km, antenas: ${diametroAntena}`;
  } else {
    detallesValidacion.push(`‚ùå Distancia ${distanciaKm.toFixed(2)}km excede capacidad de antenas de ${diametroAntena}`);
    factible = false;
    razon = `No factible - Distancia ${distanciaKm.toFixed(2)}km excede capacidad de antenas ${diametroAntena}`;
  }
  return { 
    factible, 
    razon, 
    diametroAntena, 
    tipoEnlace: 'Fibra A / B vac√≠o', 
    distancia: distanciaKm, 
    detalles: detallesValidacion 
  };
}
if (!transA || !transB) {
  detallesValidacion.push('‚ö†Ô∏è Falta informaci√≥n de tipo de transporte');
  return {
    factible: false,
    razon: 'No factible - Informaci√≥n incompleta de transporte',
    diametroAntena: 'N/A',
    tipoEnlace: 'Datos Incompletos',
    distancia: distanciaKm,
    detalles: detallesValidacion
  };
}
  if (!transA || !transB) {
    detallesValidacion.push('‚ö†Ô∏è Falta informaci√≥n de tipo de transporte');
    return {
      factible: false,
      razon: 'No factible - Informaci√≥n incompleta de transporte',
      diametroAntena: 'N/A',
      tipoEnlace: 'Datos Incompletos',
      distancia: distanciaKm,
      detalles: detallesValidacion
    };
  }
if (transANorm === transBNorm) {
  if (!permitirMismoTransporte) {
    detallesValidacion.push(`‚ùå Ambas torres tienen el mismo transporte: "${transA}"`);
    return {
      factible: false,
      razon: `No factible - Ambas torres tienen el mismo tipo de transporte (${transA})`,
      diametroAntena: 'N/A',
      tipoEnlace: 'Transporte Duplicado',
      distancia: distanciaKm,
      detalles: detallesValidacion
    };
  } else {
    detallesValidacion.push(`‚úÖ Permitiendo mismo tipo de transporte: "${transA}"`);
    const esSatA = esSatelital(transANorm);
    const esSatB = esSatelital(transBNorm);
    diametroAntena = calcularDiametroAntena(distanciaKm, true);
    if (esSatA && esSatB && validarCapacidadAntena(distanciaKm, diametroAntena, true)) {
      detallesValidacion.push(`‚úÖ Ambos sitios tienen transporte satelital y antena compatible`);
      return {
        factible: true,
        razon: `Enlace factible - Mismo tipo de transporte permitido (${transA}), distancia: ${distanciaKm.toFixed(2)}km, antenas: ${diametroAntena}`,
        diametroAntena,
        tipoEnlace: 'Mismo Transporte Permitido',
        distancia: distanciaKm,
        detalles: detallesValidacion
      };
    } else {
      detallesValidacion.push(`‚ùå Ambos sitios deben tener transporte satelital y antena compatible`);
      return {
        factible: false,
        razon: `No factible - Ambos sitios deben tener transporte satelital y antena compatible`,
        diametroAntena,
        tipoEnlace: 'Mismo Transporte Permitido',
        distancia: distanciaKm,
        detalles: detallesValidacion
      };
    }
  }
}else if (transANorm === transBNorm && permitirMismoTransporte) {
  detallesValidacion.push(`‚úÖ Permitiendo mismo tipo de transporte: "${transA}"`);
}
  const esArrendadaA = esArrendada(arreANorm);
  const esArrendadaB = esArrendada(arreBNorm);
if (esArrendadaA || esArrendadaB) {
    diametroAntena = calcularDiametroAntena(distanciaKm, true);
    tipoEnlace = 'Torres Arrendadas';
    detallesValidacion.push(`üìç Torre A: ${esArrendadaA ? 'Arrendada' : 'Propia'}`);
    detallesValidacion.push(`üìç Torre B: ${esArrendadaB ? 'Arrendada' : 'Propia'}`);
    detallesValidacion.push(`üì° Antena asignada: ${diametroAntena} (seg√∫n distancia)`);
    if (diametroAntena === '1 pie' || diametroAntena === '2 pies') {
      detallesValidacion.push(`‚úÖ Antena de ${diametroAntena} permitida en arrendada`);
      factible = true;
      razon = `Enlace factible - Antena de ${diametroAntena} en torre arrendada`;
    } else if (diametroAntena === '3 pies') {
      detallesValidacion.push('‚ö†Ô∏è Antena de 3 pies en torre arrendada: requiere an√°lisis adicional.');
      return {
        factible: true,
        razon: 'FACTIBLE (Requiere an√°lisis: antena de 3 pies en torre arrendada)',
        diametroAntena,
        tipoEnlace,
        distancia: distanciaKm,
        detalles: detallesValidacion,
        advertencia: true
      };
    } else {
      detallesValidacion.push(`‚ùå Antena de ${diametroAntena} NO permitida en torre arrendada (solo 1, 2 o 3 pies)`);
      return {
        factible: false,
        razon: `No factible - Solo se permiten antenas de 1, 2 o 3 pies en torres arrendadas`,
        diametroAntena,
        tipoEnlace,
        distancia: distanciaKm,
        detalles: detallesValidacion
      };
    }
    return { factible, razon, diametroAntena, tipoEnlace, distancia: distanciaKm, detalles: detallesValidacion };
  }
  const esAdquisicionA = esAdquisicion(arreANorm);
  const esAdquisicionB = esAdquisicion(arreBNorm);
 if (esAdquisicionA && esAdquisicionB) {
  tipoEnlace = 'Torres de Adquisici√≥n';
  detallesValidacion.push('üè¢ Ambas torres son de adquisici√≥n (mayor flexibilidad)');
  if (distanciaKm > 50) {
    factible = false;
    razon = `No factible - Distancia excesiva (${distanciaKm.toFixed(2)}km > 50km)`;
    diametroAntena = 'Cualquiera';
    detallesValidacion.push(`‚ùå Distancia ${distanciaKm.toFixed(2)}km supera el l√≠mite m√°ximo de 50km`);
  } else {
    factible = true;
    razon = `Enlace factible - Torres de adquisici√≥n, sin restricci√≥n de di√°metro de antena`;
     if (distanciaKm <= 5) {
      diametroAntena = '1 a 2 pies';
    } else if (distanciaKm <= 15) {
      diametroAntena = '3 a 4 pies';
    } else {
      diametroAntena = '4 a 6 pies';
    }
    detallesValidacion.push(`‚úÖ Antena recomendada para adquisici√≥n: ${diametroAntena}`);
  }
  return {
    factible,
    razon,
    diametroAntena,
    tipoEnlace,
    distancia: distanciaKm,
    detalles: detallesValidacion
  };
} else {
  tipoEnlace = 'Torres Mixtas';
  detallesValidacion.push(`üè¢ Torre A: ${esAdquisicionA ? 'Adquisici√≥n' : 'Otro'}, Torre B: ${esAdquisicionB ? 'Adquisici√≥n' : 'Otro'}`);
  diametroAntena = calcularDiametroAntena(distanciaKm, false);
  detallesValidacion.push(`üì° Antenas requeridas: ${diametroAntena} (seg√∫n distancia ${distanciaKm.toFixed(2)}km)`);
  if (validarCapacidadAntena(distanciaKm, diametroAntena)) {
    detallesValidacion.push(`‚úÖ Distancia ${distanciaKm.toFixed(2)}km compatible con antenas de ${diametroAntena}`);
    factible = true;
    razon = `Enlace factible - Fibra+Satelital, distancia: ${distanciaKm.toFixed(2)}km, antenas: ${diametroAntena}`;
  } else {
    detallesValidacion.push(`‚ùå Distancia ${distanciaKm.toFixed(2)}km excede capacidad de antenas de ${diametroAntena}`);
    factible = false;
    razon = `No factible - Distancia ${distanciaKm.toFixed(2)}km excede capacidad de antenas ${diametroAntena}`;
  }
  return {
    factible,
    razon,
    diametroAntena,
    tipoEnlace,
    distancia: distanciaKm,
    detalles: detallesValidacion
  };
}
  function verificarLineaDeVista(elevaciones, lineaVista, fresnel) {
  for (let i = 0; i < elevaciones.length; i++) {
    if (elevaciones[i] > fresnel[i]) {
      return false; 
    }
  }
  return true; 
}
const satelitalA = esSatelital(transANorm);
const satelitalB = esSatelital(transBNorm);
if (satelitalA && satelitalB) {
   const validacionSatelital = validarEnlaceSatelital(distanciaKm);
  if (!validacionSatelital.factible) {
    detallesValidacion.push(`‚ùå ${validacionSatelital.mensaje}`);
    return {
      factible: false,
      razon: `No factible - ${validacionSatelital.mensaje}`,
      diametroAntena: 'N/A',
      tipoEnlace: 'Satelital-Satelital',
      distancia: distanciaKm,
      detalles: detallesValidacion
    };
  }
  diametroAntena = calcularDiametroAntena(distanciaKm, false);
  tipoEnlace = 'Satelital-Satelital';
  detallesValidacion.push('üì° Torre A: Transporte Satelital');
  detallesValidacion.push('üì° Torre B: Transporte Satelital');
  detallesValidacion.push(`üì° Antenas requeridas: ${diametroAntena} (seg√∫n distancia ${distanciaKm.toFixed(2)}km)`);
  if (validarCapacidadAntena(distanciaKm, diametroAntena)) {
    detallesValidacion.push(`‚úÖ Distancia ${distanciaKm.toFixed(2)}km compatible con antenas de ${diametroAntena}`);
    factible = true;
    razon = `Enlace factible - Configuraci√≥n Satelital-Satelital, distancia: ${distanciaKm.toFixed(2)}km, antenas: ${diametroAntena}`;
  } else {
    detallesValidacion.push(`‚ùå Distancia ${distanciaKm.toFixed(2)}km excede capacidad de antenas de ${diametroAntena}`);
    factible = false;
    razon = `No factible - Distancia ${distanciaKm.toFixed(2)}km excede capacidad de antenas ${diametroAntena}`;
  }
  return { 
    factible, 
    razon, 
    diametroAntena, 
    tipoEnlace, 
    distancia: distanciaKm, 
    detalles: detallesValidacion 
  };
}
}
function analizarFactibilidadPermisiva(distanciaKm, arreA, arreB, transA, transB, torreA, torreB, OnA, OnB, esFactibleLOS = true) {
  let factible = false;
  let razon = '';
  let diametroAntena = '';
  let tipoEnlace = '';
  let detallesValidacion = [];
  if (!distanciaKm || isNaN(distanciaKm) || distanciaKm <= 0) {
    return {
      factible: false,
      razon: 'No factible - Distancia inv√°lida o cero',
      diametroAntena: 'N/A',
      tipoEnlace: 'Error de Datos',
      distancia: distanciaKm,
      detalles: ['‚ùå Error en c√°lculo de distancia']
    };
  }
  const DISTANCIA_MAXIMA = 50;
  if (distanciaKm > DISTANCIA_MAXIMA) {
    return {
      factible: false,
      razon: `No factible - Distancia excesiva (${distanciaKm.toFixed(2)}km > ${DISTANCIA_MAXIMA}km)`,
      diametroAntena: 'N/A',
      tipoEnlace: 'Fuera de Rango',
      distancia: distanciaKm,
      detalles: [`‚ùå Distancia ${distanciaKm.toFixed(2)}km supera el l√≠mite m√°ximo de ${DISTANCIA_MAXIMA}km`]
    };
  }
  if (!esFactibleLOS) {
    return {
      factible: false,
      razon: 'No factible - L√≠nea de vista obstruida (perfil de elevaci√≥n)',
      diametroAntena: 'N/A',
      tipoEnlace: 'LOS Obstruida',
      distancia: distanciaKm,
      detalles: ['‚ùå L√≠nea de vista obstruida seg√∫n perfil de elevaci√≥n']
    };
  }
  const arreANorm = (arreA || '').toLowerCase().trim();
  const arreBNorm = (arreB || '').toLowerCase().trim();
  const transANorm = (transA || '').toLowerCase().trim();
  const transBNorm = (transB || '').toLowerCase().trim();
  const torreANorm = (torreA || '').toLowerCase().trim();
  const torreBNorm = (torreB || '').toLowerCase().trim();
  const onAirANorm = (OnA || '').toLowerCase().trim();
  const onAirBNorm = (OnB || '').toLowerCase().trim();
  function estaOnAir(estadoOnAir) {
    return estadoOnAir.includes('on air') ||
      estadoOnAir.includes('onair') ||
      estadoOnAir.includes('operativo') ||
      estadoOnAir.includes('activo') ||
      estadoOnAir.includes('funcionando') ||
      estadoOnAir === 'si' ||
      estadoOnAir === 's√≠' ||
      estadoOnAir === 'yes';
  }
  function estaPendiente(estadoOnAir) {
    return estadoOnAir.includes('pendiente') ||
      estadoOnAir.includes('construcci√≥n') ||
      estadoOnAir.includes('construccion') ||
      estadoOnAir.includes('instalaci√≥n') ||
      estadoOnAir.includes('instalacion') ||
      estadoOnAir.includes('desarrollo') ||
      estadoOnAir.includes('proyecto') ||
      estadoOnAir.includes('planeado') ||
      estadoOnAir.includes('no operativo') ||
      estadoOnAir.includes('inactivo') ||
      estadoOnAir === 'no';
  }
  const onAirAActivo = estaOnAir(onAirANorm);
  const onAirBActivo = estaOnAir(onAirBNorm);
  const onAirAPendiente = estaPendiente(onAirANorm);
  const onAirBPendiente = estaPendiente(onAirBNorm);
  if (onAirAPendiente) {
    let motivoOnAir = `Torre A est√° pendiente: "${OnA}"`;
    detallesValidacion.push(`‚ùå Torre A: "${OnA}" - Estado pendiente/inactivo`);
    if (onAirBPendiente) {
      detallesValidacion.push(`‚úÖ Torre B: "${OnB}" - Estado pendiente/inactivo (no bloquea factibilidad)`);
    } else {
      detallesValidacion.push(`‚úÖ Torre B: "${OnB}" - Estado operativo`);
    }
    detallesValidacion.push('‚ö†Ô∏è La torre A debe estar "On Air" (operativa) para establecer enlaces PtP');
    return {
      factible: false,
      razon: `No factible - ${motivoOnAir}`,
      diametroAntena: 'N/A',
      tipoEnlace: 'Torre No Operativa',
      distancia: distanciaKm,
      detalles: detallesValidacion
    };
  }
  if (onAirAActivo && onAirBActivo) {
    detallesValidacion.push(`‚úÖ Torre A: "${OnA}" - Estado operativo confirmado`);
    detallesValidacion.push(`‚úÖ Torre B: "${OnB}" - Estado operativo confirmado`);
  } else {
    detallesValidacion.push(`‚ö†Ô∏è Torre A: "${OnA}" - Estado no claramente definido`);
    detallesValidacion.push(`‚ö†Ô∏è Torre B: "${OnB}" - Estado no claramente definido`);
    detallesValidacion.push(`‚ÑπÔ∏è Se asume estado operativo, pero verificar manualmente`);
  }
  function esTorreNoFactible(tipoTorre) {
    const t = tipoTorre.toLowerCase();
    return t.includes('poste') ||
      t.includes('monopolo') ||
      t.includes('mono polo') ||
      t.includes('mono-polo') ||
      t.includes('mastil') ||
      t.includes('m√°stil');
  }
  const torreANoFactible = esTorreNoFactible(torreANorm);
  const torreBNoFactible = esTorreNoFactible(torreBNorm);
  if (torreANoFactible || torreBNoFactible) {
    let motivoTorre = '';
    if (torreANoFactible && torreBNoFactible) {
      motivoTorre = `Ambas torres son de tipo no compatible (A: ${torreA}, B: ${torreB})`;
      detallesValidacion.push(`‚ùå Torre A: "${torreA}" - Tipo no factible`);
      detallesValidacion.push(`‚ùå Torre B: "${torreB}" - Tipo no factible`);
    } else if (torreANoFactible) {
      motivoTorre = `Torre A es de tipo no compatible: "${torreA}"`;
      detallesValidacion.push(`‚ùå Torre A: "${torreA}" - Tipo no factible`);
      detallesValidacion.push(`‚úÖ Torre B: "${torreB}" - Tipo compatible`);
    } else {
      motivoTorre = `Torre B es de tipo no compatible: "${torreB}"`;
      detallesValidacion.push(`‚úÖ Torre A: "${torreA}" - Tipo compatible`);
      detallesValidacion.push(`‚ùå Torre B: "${torreB}" - Tipo no factible`);
    }
    detallesValidacion.push('‚ö†Ô∏è Los tipos de torre "poste" y "monopolo" no son compatibles para enlaces PtP');
    return {
      factible: false,
      razon: `No factible - ${motivoTorre}`,
      diametroAntena: 'N/A',
      tipoEnlace: 'Torre Incompatible',
      distancia: distanciaKm,
      detalles: detallesValidacion
    };
  }
  detallesValidacion.push(`‚úÖ Torre A: "${torreA}" - Tipo compatible para enlace PtP`);
  detallesValidacion.push(`‚úÖ Torre B: "${torreB}" - Tipo compatible para enlace PtP`);
  const alturaLibre = parseFloat(document.getElementById('alturaLibre').value);
  const alturaDisponible = parseFloat(document.getElementById('alturaDisponible').value);
  if (!isNaN(alturaLibre) && !isNaN(alturaDisponible)) {
    if (alturaDisponible < alturaLibre) {
      detallesValidacion.push(`‚ùå L√≠nea de vista obstruida: Altura disponible (${alturaDisponible.toFixed(2)} m) < Altura libre necesaria (${alturaLibre.toFixed(2)} m)`);
      return {
        factible: false,
        razon: 'No factible - L√≠nea de vista obstruida (altura insuficiente)',
        diametroAntena: 'N/A',
        tipoEnlace: 'LOS Obstruida',
        distancia: distanciaKm,
        detalles: detallesValidacion
      };
    } else {
      detallesValidacion.push(`‚úÖ L√≠nea de vista: Altura disponible (${alturaDisponible.toFixed(2)} m) ‚â• Altura libre necesaria (${alturaLibre.toFixed(2)} m)`);
    }
  }
  function calcularDiametroAntena(distancia, esArrendamiento = false) {
    console.log('üîç calcularDiametroAntena llamada con:', { distancia, esArrendamiento }); // ‚úÖ AGREGAR ESTA L√çNEA

  if (esArrendamiento) {
    if (distancia <= 3.1) return '1 pie';
    if (distancia <= 8) return '2 pies';
    if (distancia <= 13.5) return '3 pies';
    return 'No factible'; 
  }
  if (distancia >= 0 && distancia <= 3) return '1 pie';
  if (distancia > 3 && distancia <= 5) return '2 pies';
  if (distancia > 5 && distancia <= 10) return '3 pies';
  if (distancia > 10 && distancia <= 20) return '4 pies';
  if (distancia > 20) return '6 pies';
  return 'No factible';
}
  function validarCapacidadAntena(distancia, diametro, esArrendamiento = false) {
    if (esArrendamiento) {
      if (diametro === '1 pie') return distancia <= 3.1;
      if (diametro === '2 pies') return distancia > 3.1 && distancia <= 8;
      if (diametro === '3 pies') return distancia > 8 && distancia <= 13.5;
      return false;
    }
    if (diametro === '1 pie') return distancia >= 0 && distancia <= 3;
    if (diametro === '2 pies') return distancia > 3 && distancia <= 5;
    if (diametro === '3 pies') return distancia > 5 && distancia <= 10;
    return false;
  }
  function esArrendada(tipoArrendamiento) {
    return tipoArrendamiento.includes('arrendada') ||
      tipoArrendamiento.includes('arrendamiento') ||
      tipoArrendamiento.includes('renta');
  }
  function esAdquisicion(tipoArrendamiento) {
    return tipoArrendamiento.includes('adquisici√≥n') ||
      tipoArrendamiento.includes('adquisicion') ||
      tipoArrendamiento.includes('compra') ||
      tipoArrendamiento.includes('propia');
  }
  function esFibra(tipoTransporte) {
    return tipoTransporte.includes('fibra') ||
      tipoTransporte.includes('√≥ptica') ||
      tipoTransporte.includes('optica') ||
      tipoTransporte.includes('fo');
  }
  function esSatelital(tipoTransporte) {
    return tipoTransporte.includes('starlink') ||
      tipoTransporte.includes('orbita') ||
      tipoTransporte.includes('satelite-oa') ||
      tipoTransporte.includes('satelital') ||
      tipoTransporte.includes('satellite');
  }
  const transporteBNulo = transBNorm === 'n/a' || transBNorm === '0' || transBNorm === '' || transBNorm === 'na';
  if (transporteBNulo) {
    const fibraA = esFibra(transANorm);
    detallesValidacion.push('‚úÖ Transporte en B est√° vac√≠o/N/A/0, se permite enlace si A tiene fibra √≥ptica');
    if (!fibraA) {
      detallesValidacion.push('‚ùå Torre A debe tener Fibra √ìptica');
      return {
        factible: false,
        razon: `No factible - Torre A debe tener Fibra √ìptica`,
        diametroAntena: 'N/A',
        tipoEnlace: 'Transporte Incompatible',
        distancia: distanciaKm,
        detalles: detallesValidacion
      };
    }
    diametroAntena = calcularDiametroAntena(distanciaKm, false);
    detallesValidacion.push(`üì° Antenas requeridas: ${diametroAntena} (seg√∫n distancia ${distanciaKm.toFixed(2)}km)`);
    if (validarCapacidadAntena(distanciaKm, diametroAntena)) {
      detallesValidacion.push(`‚úÖ Distancia ${distanciaKm.toFixed(2)}km compatible con antenas de ${diametroAntena}`);
      factible = true;
      razon = `Enlace factible - Fibra en A, B vac√≠o, distancia: ${distanciaKm.toFixed(2)}km, antenas: ${diametroAntena}`;
    } else {
      detallesValidacion.push(`‚ùå Distancia ${distanciaKm.toFixed(2)}km excede capacidad de antenas de ${diametroAntena}`);
      factible = false;
      razon = `No factible - Distancia ${distanciaKm.toFixed(2)}km excede capacidad de antenas ${diametroAntena}`;
    }
    return {
      factible,
      razon,
      diametroAntena,
      tipoEnlace: 'Fibra A / B vac√≠o',
      distancia: distanciaKm,
      detalles: detallesValidacion
    };
  }
  if (!transA || !transB) {
    detallesValidacion.push('‚ö†Ô∏è Falta informaci√≥n de tipo de transporte');
    return {
      factible: false,
      razon: 'No factible - Informaci√≥n incompleta de transporte',
      diametroAntena: 'N/A',
      tipoEnlace: 'Datos Incompletos',
      distancia: distanciaKm,
      detalles: detallesValidacion
    };
  }
if (transANorm === transBNorm) {
  const esStarlinkOA = (t) => t.includes('starlink') || t.includes('satelite-oa') || t.includes('sat√©lite-oa');
  if (esStarlinkOA(transANorm) || esStarlinkOA(transBNorm)) {
    detallesValidacion.push(`‚úÖ Ambos sitios tienen el mismo transporte (${transA}) y al menos uno es Starlink o Satelite-OA. Se considera FACTIBLE.`);
    return {
      factible: true,
      razon: `Enlace factible - Mismo tipo de transporte (${transA}) con Starlink/Satelite-OA en A o B.`,
      diametroAntena: 'N/A',
      tipoEnlace: 'Mismo Transporte Satelital',
      distancia: distanciaKm,
      detalles: detallesValidacion
    };
  }
  detallesValidacion.push(`‚ö†Ô∏è Permitiendo mismo tipo de transporte: "${transA}"`);
}
  const esArrendadaA = esArrendada(arreANorm);
  const esArrendadaB = esArrendada(arreBNorm);
if (esArrendadaA || esArrendadaB) {
  diametroAntena = calcularDiametroAntena(distanciaKm, true);
  tipoEnlace = 'Torres Arrendadas';

  detallesValidacion.push(`üìç Torre A: ${esArrendadaA ? 'Arrendada' : 'Propia'}`);
  detallesValidacion.push(`üìç Torre B: ${esArrendadaB ? 'Arrendada' : 'Propia'}`);
  detallesValidacion.push(`üì° Antena asignada: ${diametroAntena} (seg√∫n distancia)`);
  // Solo 1, 2, 3 pies son factibles. 3 pies requiere an√°lisis. 4 o 6 pies NO factible.
  if (diametroAntena === '1 pie' || diametroAntena === '2 pies') {
    detallesValidacion.push(`‚úÖ Antena de ${diametroAntena} permitida en arrendada`);
    factible = true;
    razon = `Enlace factible - Antena de ${diametroAntena} en torre arrendada`;
  } else if (diametroAntena === '3 pies') {
    detallesValidacion.push('‚ö†Ô∏è Antena de 3 pies en torre arrendada: requiere an√°lisis adicional.');
    return {
      factible: true,
      razon: 'FACTIBLE (Requiere an√°lisis: antena de 3 pies en torre arrendada)',
      diametroAntena,
      tipoEnlace,
      distancia: distanciaKm,
      detalles: detallesValidacion,
      advertencia: true
    };
  } else {
    detallesValidacion.push(`‚ùå Antena de ${diametroAntena} NO permitida en torre arrendada (solo 1, 2 o 3 pies)`);
    return {
      factible: false,
      razon: `No factible - Solo se permiten antenas de 1, 2 o 3 pies en torres arrendadas`,
      diametroAntena,
      tipoEnlace,
      distancia: distanciaKm,
      detalles: detallesValidacion
    };
  }
  return { factible, razon, diametroAntena, tipoEnlace, distancia: distanciaKm, detalles: detallesValidacion };
}
  const esAdquisicionA = esAdquisicion(arreANorm);
  const esAdquisicionB = esAdquisicion(arreBNorm);
  if (esAdquisicionA && esAdquisicionB) {
  tipoEnlace = 'Torres de Adquisici√≥n';
  detallesValidacion.push('üè¢ Ambas torres son de adquisici√≥n (mayor flexibilidad)');
  if (distanciaKm > 50) {
    factible = false;
    razon = `No factible - Distancia excesiva (${distanciaKm.toFixed(2)}km > 50km)`;
    diametroAntena = 'Cualquiera';
    detallesValidacion.push(`‚ùå Distancia ${distanciaKm.toFixed(2)}km supera el l√≠mite m√°ximo de 50km`);
  } else {
    factible = true;
    razon = `Enlace factible - Torres de adquisici√≥n, sin restricci√≥n de di√°metro de antena`;
     if (distanciaKm <= 5) {
      diametroAntena = '1 a 2 pies';
    } else if (distanciaKm <= 15) {
      diametroAntena = '3 a 4 pies';
    } else {
      diametroAntena = '4 a 6 pies';
    }
    detallesValidacion.push(`‚úÖ Antena recomendada para adquisici√≥n: ${diametroAntena}`);
  }
  return {
    factible,
    razon,
    diametroAntena,
    tipoEnlace,
    distancia: distanciaKm,
    detalles: detallesValidacion
  };
}  else {
  tipoEnlace = 'Torres Mixtas';
  detallesValidacion.push(`üè¢ Torre A: ${esAdquisicionA ? 'Adquisici√≥n' : 'Otro'}, Torre B: ${esAdquisicionB ? 'Adquisici√≥n' : 'Otro'}`);
  diametroAntena = calcularDiametroAntena(distanciaKm, false);
  detallesValidacion.push(`üì° Antenas requeridas: ${diametroAntena} (seg√∫n distancia ${distanciaKm.toFixed(2)}km)`);
  if (validarCapacidadAntena(distanciaKm, diametroAntena)) {
    detallesValidacion.push(`‚úÖ Distancia ${distanciaKm.toFixed(2)}km compatible con antenas de ${diametroAntena}`);
    factible = true;
    razon = `Enlace factible - Fibra+Satelital, distancia: ${distanciaKm.toFixed(2)}km, antenas: ${diametroAntena}`;
  } else {
    detallesValidacion.push(`‚ùå Distancia ${distanciaKm.toFixed(2)}km excede capacidad de antenas de ${diametroAntena}`);
    factible = false;
    razon = `No factible - Distancia ${distanciaKm.toFixed(2)}km excede capacidad de antenas ${diametroAntena}`;
  }
  return {
    factible,
    razon,
    diametroAntena,
    tipoEnlace,
    distancia: distanciaKm,
    detalles: detallesValidacion
  };
}
}
function verificarLineaDeVista(elevaciones, lineaVista, fresnel) {
  for (let i = 0; i < elevaciones.length; i++) {
    if (elevaciones[i] > fresnel[i]) {
      return false;
    }
  }
  return true;
}
// ============================================
// FUNCI√ìN PARA MOSTRAR DETALLES COMPLETOS
// ============================================
function mostrarAnalisisDetallado(factibilidad) {
  let estado = '';
  let color = '';
  let icono = '';
  if (factibilidad.razon && factibilidad.razon.toUpperCase().includes('NO DISPONIBLE')) {
    estado = 'NO DISPONIBLE';
    color = '#f59e42';
    icono = '<i class="fas fa-exclamation-circle" style="color:#f59e42"></i>';
  } else if (factibilidad.factible) {
    estado = 'FACTIBLE';
    color = '#10b981';
    icono = '<i class="fas fa-check-circle" style="color:#10b981"></i>';
  } else {
    estado = 'NO FACTIBLE';
    color = '#ef4444';
    icono = '<i class="fas fa-times-circle" style="color:#ef4444"></i>';
  }
  const titulo = `Enlace ${estado}`;
  const resumen = `
    <b>Distancia:</b> ${factibilidad.distancia?.toFixed(2) || 'N/A'} km<br>
    <b>Tipo de Enlace:</b> ${factibilidad.tipoEnlace || 'N/A'}<br>
    <b>Antenas Requeridas:</b> ${factibilidad.diametroAntena || 'N/A'}<br>
    <b>Estado:</b> <span style="color:${color}; font-weight:bold;">${estado}</span><br>
    <b>Motivo principal:</b> ${factibilidad.razon || 'N/A'}
  `;
  let lista = '';
  if (factibilidad.detalles && factibilidad.detalles.length > 0) {
    lista = factibilidad.detalles.map(det => `<li>${det}</li>`).join('');
  }
  document.getElementById('modal-analisis-icono').innerHTML = icono;
  document.getElementById('modal-analisis-titulo').innerHTML = titulo;
  document.getElementById('modal-analisis-resumen').innerHTML = resumen;
  document.getElementById('modal-analisis-lista').innerHTML = lista;
  document.getElementById('modal-analisis').style.display = 'flex';
}
function cerrarModalAnalisis() {
  document.getElementById('modal-analisis').style.display = 'none';
}
function agregarOActualizarEnlace() {
  const get = id => document.getElementById(id).value.trim();
  const latA = parseFloat(get('latA'));
  const lonA = parseFloat(get('lonA'));
  const latB = parseFloat(get('latB'));
  const lonB = parseFloat(get('lonB'));
  if (!get('idA') || !get('idB')) {
    alert('‚ùå Error: Debes ingresar ID A y ID B');
    return;
  }
  if (isNaN(latA) || isNaN(lonA) || isNaN(latB) || isNaN(lonB)) {
    alert('‚ùå Error: Las coordenadas deben ser n√∫meros v√°lidos para ambos sitios');
    return;
  }
  const distanciaKm = calcularDistancia(latA, lonA, latB, lonB);
  const frecuencia = asignarFrecuencia(distanciaKm);
  const factibilidad = analizarFactibilidad(
    distanciaKm,
    get('ArreA'),
    get('ArreB'),
    get('TransA'),
    get('TransB'),
    get('TorreA'),
    get('TorreB'),
    get('OnA'),
    get('OnB'),
    window.ultimaFactibilidadLOS
  );
  const estadoFactible = (factibilidad.advertencia)
    ? 'FACTIBLE (Requiere an√°lisis)'
    : (factibilidad.razon && factibilidad.razon.toUpperCase().includes('NO DISPONIBLE'))
      ? 'NO DISPONIBLE'
      : (factibilidad.factible ? 'S√ç' : 'NO');
  const filaDatos = [
    get('idA'), get('nombreA'), get('latA'), get('lonA'),
    document.getElementById('latArad').value,
    document.getElementById('lonArad').value,
    get('idB'), get('nombreB'), get('latB'), get('lonB'),
    document.getElementById('latBrad').value,
    document.getElementById('lonBrad').value,
    distanciaKm.toFixed(6), frecuencia,
    document.getElementById('disponibilidadAnual').value,
    get('alturaA'), get('alturaB'), get('ranA'), get('ranB'),
    get('TransA'), get('TransB'), get('ArreA'), get('ArreB'),
    get('OnA'), get('OnB'), get('TorreA'), get('TorreB'),
    get('EstadoA'), get('EstadoB'),
    estadoFactible,
    factibilidad.diametroAntena,
    factibilidad.tipoEnlace,
    JSON.stringify(factibilidad)
  ];
  const esMismoTransporte = (
    permitirMismoTransporte &&
    get('TransA').toLowerCase() === get('TransB').toLowerCase()
  );
  if (esMismoTransporte) {
    let enlaces = JSON.parse(localStorage.getItem('enlacesMismoTransporte') || '[]');
    enlaces.push(filaDatos);
    localStorage.setItem('enlacesMismoTransporte', JSON.stringify(enlaces));
    mostrarPestana('mismoTransporte');
    mostrarTablaMismoTransporte();
    limpiarFormulario();
    return;
  }
  if (permitirMismoTransporte) {
    limpiarFormulario();
    return;
  }
  if (filaEditando) {
    const celdas = filaEditando.querySelectorAll('td');
    filaDatos.forEach((val, i) => {
      if (!celdas[i]) return;
      if (i === 33) {
        celdas[i].innerHTML = '';
        const btn = document.createElement('button');
        btn.className = 'btn btn-info btn-sm';
        btn.innerHTML = '<i class="fas fa-info-circle"></i> Ver An√°lisis';
        btn.onclick = function(e) {
          e.stopPropagation();
          try {
            const analisis = JSON.parse(val);
            mostrarAnalisisDetallado(analisis);
          } catch {
            alert('No hay an√°lisis detallado disponible.');
          }
        };
        celdas[i].appendChild(btn);
        celdas[i].dataset.analisis = val;
      } else {
        celdas[i].textContent = val;
      }
    });
    aplicarEstiloFactibilidad(filaEditando, factibilidad.factible);
    filaEditando.classList.remove('selected');
    filaEditando = null;
    document.getElementById('agregarBtn').innerHTML = '<i class="fas fa-check"></i> Agregar Enlace';
    document.getElementById('eliminarBtn').disabled = true;
  } else {
    const fila = document.createElement('tr');
    const tdCheck = document.createElement('td');
    const check = document.createElement('input');
    check.type = 'checkbox';
    check.className = 'check-enlace';
    check.onclick = function(e) {
      e.stopPropagation();
      actualizarBotonEliminarSeleccionados();
    };
    tdCheck.appendChild(check);
    fila.appendChild(tdCheck);

    filaDatos.forEach((val, i) => {
      const td = document.createElement('td');
      if (i === 33) {
        const btn = document.createElement('button');
        btn.className = 'btn btn-info btn-sm';
        btn.innerHTML = '<i class="fas fa-info-circle"></i> Ver An√°lisis';
        btn.onclick = function(e) {
          e.stopPropagation();
          try {
            const analisis = JSON.parse(val);
            mostrarAnalisisDetallado(analisis);
          } catch {
            alert('No hay an√°lisis detallado disponible.');
          }
        };
        td.appendChild(btn);
        td.dataset.analisis = val;
      } else {
        td.textContent = val;
      }
      fila.appendChild(td);
    });
    document.querySelector('#tabla tbody').appendChild(fila);
  }
  actualizarContadorEnlaces();
  verificarEnlacesVacios();
  ordenarTablaPorFactibilidad();
  
  // ‚úÖ REDIRIGIR CONDICIONALMENTE seg√∫n el tipo de enlace
  if (esMismoTransporte) {
    // Ya se redirigi√≥ arriba, no hacer nada m√°s
  } else {
    mostrarPestana('enlaces');
  }
  
  guardarEnlacesEnStorage();
}
function aplicarEstiloFactibilidad(fila, esFactible, razon = "") {
  fila.classList.remove('enlace-factible', 'enlace-no-factible');
  const celdas = fila.querySelectorAll('td');
  if (celdas[28]) {
    celdas[28].classList.remove('factible', 'no-factible');
    if (esFactible) {
      fila.classList.add('enlace-factible');
      celdas[28].classList.add('factible');
      celdas[28].title = razon || "Enlace factible";
    } else {
      fila.classList.add('enlace-no-factible');
      celdas[28].classList.add('no-factible');
      celdas[28].title = razon || "Enlace no factible";
    }
  }
}
function cargarFilaEnFormulario(fila) {
  const celdas = fila.querySelectorAll('td');
 const ids = [
  'idA','nombreA','latA','lonA','latArad','lonArad',
  'idB','nombreB','latB','lonB','latBrad','lonBrad',
  'distancia','frecuencia','disponibilidadAnual', 
  'alturaA', 
  'alturaB', 
  'ranA','ranB','TransA','TransB','ArreA','ArreB',
  'OnA','OnB','TorreA','TorreB','EstadoA','EstadoB'
];
  ids.forEach((id, i) => {
    if (document.getElementById(id) && celdas[i+1]) {
      let valor = celdas[i+1].textContent.trim();
      if (['latA','lonA','latB','lonB','alturaA','alturaB','frecuencia'].includes(id)) {
        valor = valor.replace(',', '.').replace(/[^0-9\.\-]/g, '');
      }
      document.getElementById(id).value = valor;
    }
  });
  actualizarCalculos();
}
function validarFactibilidadEnTiempoReal() {
  const campos = ['latA', 'lonA', 'latB', 'lonB', 'ArreA', 'ArreB', 'TransA', 'TransB'];
  campos.forEach(campo => {
    const elemento = document.getElementById(campo);
    if (elemento) {
      elemento.addEventListener('blur', () => {
        mostrarVistaPrevia();
      });
    }
  });
}
function mostrarVistaPrevia() {
  const get = id => document.getElementById(id).value.trim();
  const latA = parseFloat(get('latA'));
  const lonA = parseFloat(get('lonA'));
  const latB = parseFloat(get('latB'));
  const lonB = parseFloat(get('lonB'));
  if (latA && lonA && latB && lonB) {
    const distanciaKm = calcularDistancia(latA, lonA, latB, lonB);
    const factibilidad = analizarFactibilidad(
      distanciaKm,
      get('ArreA'),
      get('ArreB'),
      get('TransA'),
      get('TransB')
    );
    const preview = document.getElementById('vista-previa');
    if (preview) {
      const color = factibilidad.factible ? '#10b981' : '#ef4444';
      const icono = factibilidad.factible ? '‚úÖ' : '‚ùå';
      preview.innerHTML = `
        <div style="color: ${color}; font-weight: bold;">
          ${icono} ${factibilidad.factible ? 'FACTIBLE' : 'NO FACTIBLE'}
          <br><small>${factibilidad.razon}</small>
        </div>
      `;
    }
  }
}
function eliminarEnlace() {
  if (!filaEditando) {
    alert('‚ö†Ô∏è Debes seleccionar una fila para eliminar');
    return;
  }
  const idA = filaEditando.querySelector('td:first-child').textContent;
  const idB = filaEditando.querySelector('td:nth-child(7)').textContent;
  if (!confirm(`¬øSeguro quieres eliminar el enlace entre ${idA} y ${idB}?`)) {
    return;
  }
  filaEditando.remove();
  filaEditando = null;
  limpiarFormulario();
  document.getElementById('agregarBtn').innerHTML = '<i class="fas fa-check"></i> Agregar Enlace';
  document.getElementById('eliminarBtn').disabled = true;
  actualizarContadorEnlaces();
  verificarEnlacesVacios();
if (
  permitirMismoTransporte &&
  document.getElementById('TransA').value.trim().toLowerCase() === document.getElementById('TransB').value.trim().toLowerCase()
) {
  guardarEnlacesEnStorageModo("mismo");
} else {
  guardarEnlacesEnStorageModo("normal");
}
  alert('‚úÖ Enlace eliminado correctamente');
}
 function limpiarFormulario() { 
  const campos = [
    'idA','nombreA','latA','lonA','latArad','lonArad',
    'idB','nombreB','latB','lonB','latBrad','lonBrad',
    'distancia','frecuencia','alturaA','alturaB','ranA','ranB',
    'TransA','TransB','ArreA','ArreB','OnA','OnB','TorreA','TorreB','EstadoA','EstadoB'
  ];
     campos.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });
  document.getElementById('agregarBtn').innerHTML = '<i class="fas fa-check"></i> Agregar Enlace';
  document.getElementById('eliminarBtn').disabled = true;
  filaEditando = null;
  window.ultimaFactibilidadLOS = undefined;
}
  function exportarExcel() {
  const filasNormales = Array.from(document.querySelectorAll('#tabla tbody tr'));
  const filasMismo = [];
  const tablaMismo = document.getElementById('tabla-mismo-tipo');
  if (tablaMismo) {
    Array.from(tablaMismo.querySelectorAll('tbody tr')).forEach(tr => filasMismo.push(tr));
  }
  const filas = filasNormales.concat(filasMismo);

  if (filas.length === 0) {
    alert('No hay enlaces para exportar');
    return;
  }
  const encabezado = [
    'ID A','Nombre A','Latitud A','Longitud A','Lat A (rad)','Lon A (rad)',
    'ID B','Nombre B','Latitud B','Longitud B','Lat B (rad)','Lon B (rad)',
    'Distancia (km)','Frecuencia (GHz)','Disponibilidad',
    'Altura Torre A','Altura Torre B','Altura RAN A','Altura RAN B',
    'Transporte A','Transporte B','Arrendamiento A','Arrendamiento B',
    'On Air A','On Air B','Tipo Torre A','Tipo Torre B','Estado A','Estado B',
    'Factible','Antenas','Tipo Enlace','An√°lisis'
  ];
  const datos = filas.map(fila => {
    const c = fila.querySelectorAll('td');
    return Array.from({length: 33}, (_, i) => c[i+1]?.textContent || "");
  });
  const wsData = [encabezado].concat(datos);
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(wsData);
  XLSX.utils.book_append_sheet(wb, ws, "EnlacesPtP");
  XLSX.writeFile(wb, "enlaces_ptp.xlsx");
}
let enlacesSeleccionados = new Set();
function seleccionarTodo() {
  const tabla = document.querySelector('.seleccion-container table tbody');
  if (!tabla) return;
  const filas = tabla.querySelectorAll('tr');
  filas.forEach(fila => {
    fila.classList.add('selected');
    enlacesSeleccionados.add(fila.dataset.id);
  });
  actualizarContadorSeleccionados();
  document.getElementById('eliminarSeleccionadosBtn').disabled = false;
}
function deseleccionarTodo() {
  const tabla = document.querySelector('.seleccion-container table tbody');
  if (!tabla) return;
  const filas = tabla.querySelectorAll('tr');
  filas.forEach(fila => {
    fila.classList.remove('selected');
  });
  enlacesSeleccionados.clear();
  actualizarContadorSeleccionados();
  document.getElementById('eliminarSeleccionadosBtn').disabled = true;
}
function actualizarContadorSeleccionados() {
  document.getElementById('enlaces-seleccionados').textContent = enlacesSeleccionados.size;
}
function eliminarSeleccionados() {
  if (enlacesSeleccionados.size === 0) {
    alert('‚ö†Ô∏è Debes seleccionar al menos un enlace para eliminar');
    return;
  }
  if (!confirm(`¬øSeguro quieres eliminar ${enlacesSeleccionados.size} enlaces seleccionados?`)) {
    return;
  }
  enlacesSeleccionados.forEach(id => {
    const fila = document.querySelector(`tr[data-id="${id}"]`);
    if (fila) fila.remove();
  });
  enlacesSeleccionados.clear();
  actualizarContadorSeleccionados();
  actualizarContadorEnlaces();
  verificarEnlacesVacios();
  guardarEnlacesEnStorage();
  document.getElementById('eliminarSeleccionadosBtn').disabled = true;
  alert('‚úÖ Enlaces eliminados correctamente');
}
function mostrarPestana(pestana, event) {
  document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
  document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
  
  const tabContent = document.getElementById('tab-' + pestana);
  if (tabContent) tabContent.classList.add('active');
  
  if (event) event.currentTarget.classList.add('active');
  
  // ‚úÖ ESTA L√çNEA ES CR√çTICA - debe llamar a mostrarMapaEnlaces
  if (pestana === 'resumen') {
    console.log('üîÑ Cambiando a pesta√±a Resumen - llamando a mostrarMapaEnlaces');
    setTimeout(() => {
      mostrarMapaEnlaces();
    }, 100);
  }
  
  if (pestana === 'mismoTransporte') {
    mostrarTablaMismoTransporte();
  }
}
document.getElementById('inputFile').addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function (e) {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: 'array' });
    const sheetName = workbook.SheetNames[0];
    const worksheet = workbook.Sheets[sheetName];
    dataExcel = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
    const archivoInfo = {
      nombre: file.name,
      tama√±o: file.size,
      filas: dataExcel.length,
      fechaCarga: new Date().toISOString()
    };
    localStorage.setItem('archivoExcelInfo', JSON.stringify(archivoInfo));
    guardarArchivoExcelEnIndexedDB(file.name, e.target.result, archivoInfo);
    mostrarArchivoCargado(archivoInfo);
    alert(`‚úÖ Archivo cargado exitosamente!\nüìÅ ${file.name}\nüìä ${dataExcel.length} filas procesadas`);
  };
  reader.readAsArrayBuffer(file);
});
document.getElementById('inputFilePairs').addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function (e) {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: 'array' });
    const sheetName = workbook.SheetNames[0];
    const worksheet = workbook.Sheets[sheetName];
    dataPares = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
    const archivoInfo = {
      nombre: file.name,
      tama√±o: file.size,
      filas: dataPares.length,
      fechaCarga: new Date().toISOString()
    };
    localStorage.setItem('archivoParesInfo', JSON.stringify(archivoInfo));
    guardarArchivoParesEnIndexedDB(file.name, e.target.result, archivoInfo);
    const contenedor = document.getElementById('archivo-pares-cargado');
    const nombreArchivo = document.getElementById('nombre-archivo-pares');
    const infoArchivo = document.getElementById('info-archivo-pares');
    if (contenedor && nombreArchivo && infoArchivo) {
      nombreArchivo.textContent = archivoInfo.nombre;
      infoArchivo.textContent = `${archivoInfo.filas} filas ‚Ä¢ ${(archivoInfo.tama√±o / 1024).toFixed(1)} KB ‚Ä¢ Cargado: ${new Date(archivoInfo.fechaCarga).toLocaleString()}`;
      contenedor.style.display = 'block';
      document.getElementById('inputFilePairs').style.display = 'none';
    }
    alert(`‚úÖ Archivo de pares cargado exitosamente!\nüìÅ ${file.name}\nüìä ${dataPares.length} filas procesadas`);
  };
  reader.readAsArrayBuffer(file);
});

document.getElementById('btnDescargarFaltantes').onclick = function() {
  if (!window.paresFaltantes || window.paresFaltantes.length === 0) {
    alert('No hay pares faltantes.');
    return;
  }
  let csv = 'ID_A;ID_B;Falta_A;Falta_B\n';
  window.paresFaltantes.forEach(par => {
    csv += par.join(';') + '\n';
  });
  const blob = new Blob([csv], {type: 'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'pares_faltantes.csv';
  a.click();
  URL.revokeObjectURL(url);
};
function mostrarTablaMismoTransporte() {
  const contenedor = document.getElementById('tabla-mismo-transporte');
  if (!contenedor) return;
  const enlaces = JSON.parse(localStorage.getItem('enlacesMismoTransporte') || '[]');
  if (!enlaces.length) {
    contenedor.innerHTML = `<div style="color:#ef4444; text-align:center; margin:32px 0;">
      <i class="fas fa-exclamation-triangle"></i> No hay enlaces procesados con mismo tipo de transporte.
    </div>`;
    return;
  }
  let html = `
    <div class="enlaces-counter">
      <i class="fas fa-chart-line"></i> Total de Enlaces (Permisivo): <span id="total-enlaces-mismo">${enlaces.length}</span>
    </div>
    <div class="action-buttons">
      <button class="btn btn-success" onclick="exportarExcelMismoTransporte()">
        <i class="fas fa-file-excel"></i> Exportar a Excel
      </button>
      <button class="btn btn-secondary" onclick="seleccionarTodosMismoTransporte()">
        <i class="fas fa-check-double"></i> Seleccionar Todos
      </button>
      <button class="btn btn-danger" onclick="eliminarEnlacesSeleccionadosMismo()" id="btnEliminarSeleccionadosMismo" disabled>
        <i class="fas fa-trash"></i> Eliminar Seleccionados
      </button>
      <button id="btnPerfilElevacionMismo" class="btn btn-info" style="display:none; margin-left:8px;">
        <i class="fas fa-mountain"></i> Perfil Elevaci√≥n
      </button>
    </div>
    <div class="table-container">
      <table id="tabla-mismo-tipo" style="width:100%;border-radius:12px;overflow:hidden;">
        <thead>
          <tr>
            <th><input type="checkbox" id="checkTodosMismo" onclick="toggleSeleccionarTodosMismo(this)"></th>
            <th>ID A</th>
            <th>Nombre A</th>
            <th>Lat A</th>
            <th>Lon A</th>
            <th>Lat A (rad)</th>
            <th>Lon A (rad)</th>
            <th>ID B</th>
            <th>Nombre B</th>
            <th>Lat B</th>
            <th>Lon B</th>
            <th>Lat B (rad)</th>
            <th>Lon B (rad)</th>
            <th>Distancia (km)</th>
            <th>Frecuencia (GHz)</th>
            <th>Disponibilidad</th>
            <th>Altura Torre A</th>
            <th>Altura Torre B</th>
            <th>Altura RAN A</th>
            <th>Altura RAN B</th>
            <th>Transporte A</th>
            <th>Transporte B</th>
            <th>Arrendamiento A</th>
            <th>Arrendamiento B</th>
            <th>On Air A</th>
            <th>On Air B</th>
            <th>Tipo Torre A</th>
            <th>Tipo Torre B</th>
            <th>Estado A</th>
            <th>Estado B</th>
            <th>Factible</th>
            <th>Antenas</th>
            <th>Tipo Enlace</th>
            <th>An√°lisis</th>
          </tr>
        </thead>
        <tbody>
  `;
  enlaces.forEach((enlaceData, idx) => {
    html += `<tr data-idx="${idx}">`;
    html += `<td><input type="checkbox" class="check-mismo-transporte" onchange="resaltarFilaMismoTransporte(this)"></td>`;
    enlaceData.forEach((val, i) => {
      if (i === enlaceData.length - 1) {
        html += `<td style="text-align:center;">
          <button class="btn btn-info btn-sm" style="width: 140px; font-size: 1rem; font-weight:600; display:flex;align-items:center;justify-content:center;gap:8px;"
            onclick="try{mostrarAnalisisDetallado(JSON.parse(decodeURIComponent(this.dataset.analisis)));}catch(e){alert('No hay an√°lisis detallado disponible.');}" 
            data-analisis="${encodeURIComponent(val)}">
            <i class="fas fa-info-circle"></i> Ver An√°lisis
          </button>
        </td>`;
      } else {
        html += `<td>${val}</td>`;
      }
    });
    html += `</tr>`;
  });
  html += '</tbody></table></div>';
  contenedor.innerHTML = html;
  const tbody = contenedor.querySelector('tbody');
  let filaSeleccionada = null;
  tbody.addEventListener('click', function(e) {
    const fila = e.target.closest('tr');
    if (!fila) return;
    tbody.querySelectorAll('tr').forEach(f => f.classList.remove('selected'));
    fila.classList.add('selected');
    filaSeleccionada = fila;
    document.getElementById('btnPerfilElevacionMismo').style.display = 'inline-block';
  });
  document.getElementById('btnPerfilElevacionMismo').onclick = function() {
    if (!filaSeleccionada) return;
    const celdas = filaSeleccionada.querySelectorAll('td');
    const datos = {
      idA: celdas[1]?.textContent,
      nombreA: celdas[2]?.textContent,
      latA: celdas[3]?.textContent,
      lonA: celdas[4]?.textContent,
      idB: celdas[7]?.textContent,
      nombreB: celdas[8]?.textContent,
      latB: celdas[9]?.textContent,
      lonB: celdas[10]?.textContent,
      alturaA: celdas[16]?.textContent,
      alturaB: celdas[17]?.textContent,
      frecuencia: celdas[13]?.textContent
    };
    mostrarPerfilElevacionDesdeDatos(datos);
    const perfilDiv = document.getElementById('perfil-elevacion-con-torres');
    if (perfilDiv) {
      perfilDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  };
}
function resaltarFilaMismoTransporte(checkbox) {
  const fila = checkbox.closest('tr');
  if (checkbox.checked) {
    fila.classList.add('selected');
  } else {
    fila.classList.remove('selected');
  }
  const algunoSeleccionado = Array.from(document.querySelectorAll('#tabla-mismo-tipo .check-mismo-transporte')).some(cb => cb.checked);
  document.getElementById('btnEliminarSeleccionadosMismo').disabled = !algunoSeleccionado;
}
function toggleSeleccionarTodosMismo(master) {
  document.querySelectorAll('#tabla-mismo-tipo .check-mismo-transporte').forEach(cb => cb.checked = master.checked);
  document.getElementById('btnEliminarSeleccionadosMismo').disabled = !master.checked;
}
function seleccionarTodosMismoTransporte() {
  document.querySelectorAll('#tabla-mismo-tipo .check-mismo-transporte').forEach(cb => cb.checked = true);
  document.getElementById('btnEliminarSeleccionadosMismo').disabled = false;
}
function eliminarEnlacesSeleccionadosMismo() {
  if (!confirm('¬øSeguro que deseas eliminar los enlaces seleccionados?')) return;
  const checks = Array.from(document.querySelectorAll('#tabla-mismo-tipo .check-mismo-transporte'));
  const enlaces = JSON.parse(localStorage.getItem('enlacesMismoTransporte') || '[]');
  const nuevos = enlaces.filter((_, idx) => !checks[idx].checked);
  localStorage.setItem('enlacesMismoTransporte', JSON.stringify(nuevos));
  mostrarTablaMismoTransporte();
  document.getElementById('btnEliminarSeleccionadosMismo').disabled = true;
}
function exportarExcelMismoTransporte() {
  const tabla = document.getElementById('tabla-mismo-tipo');
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.table_to_sheet(tabla);
  XLSX.utils.book_append_sheet(wb, ws, "MismoTransporte");
  XLSX.writeFile(wb, "enlaces_mismo_transporte.xlsx");
}
function toggleSeleccionarTodosMismo(master) {
  document.querySelectorAll('#tabla-mismo-tipo .check-mismo-transporte').forEach(cb => cb.checked = master.checked);
}
function crearFilaEnlaceTemporal() {
  const get = id => document.getElementById(id).value.trim();
  const latA = parseFloat(get('latA'));
  const lonA = parseFloat(get('lonA'));
  const latB = parseFloat(get('latB'));
  const lonB = parseFloat(get('lonB'));
  if (!get('idA') || !get('idB')) return null;
  if (isNaN(latA) || isNaN(lonA) || isNaN(latB) || isNaN(lonB)) return null;
  const distanciaKm = calcularDistancia(latA, lonA, latB, lonB);
  const frecuencia = asignarFrecuencia(distanciaKm);
  const factibilidad = analizarFactibilidad(
    distanciaKm,
    get('ArreA'),
    get('ArreB'),
    get('TransA'),
    get('TransB'),
    get('TorreA'),
    get('TorreB'),
    get('OnA'),
    get('OnB'),
    window.ultimaFactibilidadLOS
  );
  const estadoFactible = (factibilidad.advertencia)
    ? 'FACTIBLE (Requiere an√°lisis)'
    : (factibilidad.razon && factibilidad.razon.toUpperCase().includes('NO DISPONIBLE'))
      ? 'NO DISPONIBLE'
      : (factibilidad.factible ? 'S√ç' : 'NO');
  const filaDatos = [
    get('idA'), get('nombreA'), get('latA'), get('lonA'),
    document.getElementById('latArad').value,
    document.getElementById('lonArad').value,
    get('idB'), get('nombreB'), get('latB'), get('lonB'),
    document.getElementById('latBrad').value,
    document.getElementById('lonBrad').value,
    distanciaKm.toFixed(6), frecuencia,
    document.getElementById('disponibilidadAnual').value,
    get('alturaA'), get('alturaB'), get('ranA'), get('ranB'),
    get('TransA'), get('TransB'), get('ArreA'), get('ArreB'),
    get('OnA'), get('OnB'), get('TorreA'), get('TorreB'),
    get('EstadoA'), get('EstadoB'),
    estadoFactible,
    factibilidad.diametroAntena,
    factibilidad.tipoEnlace,
    JSON.stringify(factibilidad)
  ];
  const fila = document.createElement('tr');
  const tdCheck = document.createElement('td');
  const check = document.createElement('input');
  check.type = 'checkbox';
  check.className = 'check-enlace';
  check.onclick = function(e) {
    e.stopPropagation();
    actualizarBotonEliminarSeleccionados();
  };
  tdCheck.appendChild(check);
  fila.appendChild(tdCheck);
  filaDatos.forEach((val, i) => {
    const td = document.createElement('td');
    if (i === 33) {
      const btn = document.createElement('button');
      btn.className = 'btn btn-info btn-sm';
      btn.innerHTML = '<i class="fas fa-info-circle"></i> Ver An√°lisis';
      btn.onclick = function(e) {
        e.stopPropagation();
        try {
          const analisis = JSON.parse(val);
          mostrarAnalisisDetallado(analisis);
        } catch {
          alert('No hay an√°lisis detallado disponible.');
        }
      };
      td.appendChild(btn);
      td.dataset.analisis = val;
    } else {
      td.textContent = val;
    }
    fila.appendChild(td);
  });
  aplicarEstiloFactibilidad(fila, factibilidad.factible);
  return fila;
}
function ordenarTablaPorFactibilidad() {
  guardarEnlacesEnStorage();
  actualizarContadorEnlaces();
  verificarEnlacesVacios();
  
  // Mostrar mensaje de √©xito
  setTimeout(() => {
    
    // Cambiar a la pesta√±a de enlaces
    mostrarPestana('enlaces');
    
    // Mostrar bot√≥n de descarga si hay faltantes
    const btnDescargarFaltantes = document.getElementById('btnDescargarFaltantes');
    if (btnDescargarFaltantes) {
      btnDescargarFaltantes.style.display = 'inline-block';
    }
  }, 200);
}
function exportarFactiblesParaPathloss() {
  const filasNormales = Array.from(document.querySelectorAll('#tabla tbody tr'));
  const filasMismo = [];
  const tablaMismo = document.getElementById('tabla-mismo-tipo');
  if (tablaMismo) {
    Array.from(tablaMismo.querySelectorAll('tbody tr')).forEach(tr => filasMismo.push(tr));
  }
  const filas = filasNormales.concat(filasMismo);
  const factibles = filas.filter(fila => {
    const celdas = fila.querySelectorAll('td');
    const val = celdas[30]?.textContent.trim().toUpperCase();
    return val === 'S√ç' || val.startsWith('FACTIBLE');
  });
  if (factibles.length === 0) {
    alert('No hay enlaces factibles para exportar');
    return;
  }
  const encabezado = [
    'ID A','Nombre A','Latitud A','Longitud A','ID B','Nombre B','Latitud B','Longitud B',
    'Arrendamiento A','Arrendamiento B','Tipo Torre A','Tipo Torre B','Transporte A','Transporte B',
    'Distancia (km)','Frecuencia (GHz)','Altura RAN A','Altura RAN B','Altura Torre A','Altura Torre B',
    'On Air A','On Air B','Antenas'
  ];
  const datos = factibles.map(fila => {
    const c = fila.querySelectorAll('td');
    return [
      c[1]?.textContent,   // ID A
      c[2]?.textContent,   // Nombre A
      c[3]?.textContent,   // Latitud A
      c[4]?.textContent,   // Longitud A
      c[7]?.textContent,   // ID B
      c[8]?.textContent,   // Nombre B
      c[9]?.textContent,   // Latitud B
      c[10]?.textContent,  // Longitud B
      c[22]?.textContent,  // Arrendamiento A
      c[23]?.textContent,  // Arrendamiento B
      c[26]?.textContent,  // Tipo Torre A
      c[27]?.textContent,  // Tipo Torre B
      c[20]?.textContent,  // Transporte A
      c[21]?.textContent,  // Transporte B
      c[13]?.textContent,  // Distancia (km)
      c[14]?.textContent,  // Frecuencia (GHz)
      c[18]?.textContent,  // Altura RAN A
      c[19]?.textContent,  // Altura RAN B
      c[16]?.textContent,  // Altura Torre A
      c[17]?.textContent,  // Altura Torre B
      c[24]?.textContent,  // On Air A
      c[25]?.textContent,  // On Air B
      c[31]?.textContent   // Antenas
    ].join(';');
  });
  const csv = [encabezado.join(';')].concat(datos).join('\n');
  const blob = new Blob([csv], {type: 'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'enlaces_factibles_pathloss.csv';
  a.click();
  URL.revokeObjectURL(url);
}
async function mostrarPerfilElevacionDesdeDatos(datos) {
  const idA = datos.idA || datos['idA'] || '';
  const nombreA = datos.nombreA || datos['nombreA'] || '';
  const alturaA = parseFloat(datos.alturaA || datos['Altura Torre A']) || 0;
  const idB = datos.idB || datos['idB'] || '';
  const nombreB = datos.nombreB || datos['nombreB'] || '';
  const alturaB = parseFloat(datos.alturaB || datos['Altura Torre B']) || 0;
  const latA = parseFloat(datos.latA || datos['Latitud A']);
  const lonA = parseFloat(datos.lonA || datos['Longitud A']);
  const latB = parseFloat(datos.latB || datos['Latitud B']);
  const lonB = parseFloat(datos.lonB || datos['Longitud B']);
  const frecuenciaGHz = parseFloat(datos.frecuencia || datos['Frecuencia']);
  const numPuntos = 50;
  if (
    isNaN(latA) || isNaN(lonA) || isNaN(latB) || isNaN(lonB) ||
    isNaN(alturaA) || isNaN(alturaB) || isNaN(frecuenciaGHz)
  ) {
    alert('Datos insuficientes para generar el perfil de elevaci√≥n.');
    return;
  }
  const locations = [];
  for (let i = 0; i < numPuntos; i++) {
    const lat = latA + (latB - latA) * (i / (numPuntos - 1));
    const lon = lonA + (lonB - lonA) * (i / (numPuntos - 1));
    locations.push(`${lat},${lon}`);
  }
  const locationsStr = locations.join('|');
  const url = `https://api.open-elevation.com/api/v1/lookup?locations=${locationsStr}`;
  try {
    const resp = await fetch(url);
    const data = await resp.json();
    if (!data.results || !data.results.length) {
      alert('No se pudo obtener el perfil de elevaci√≥n.');
      return;
    }
    const elevaciones = data.results.map(r => r.elevation);
    const distanciaKm = calcularDistancia(latA, lonA, latB, lonB);
    const h1 = elevaciones[0] + alturaA;
    const h2 = elevaciones[elevaciones.length - 1] + alturaB;
    const lineaVista = elevaciones.map((_, i) =>
      h1 + (h2 - h1) * (i / (numPuntos - 1))
    );
const c = 299792458;
const frecuenciaHz = frecuenciaGHz * 1e9;
const lambda = c / frecuenciaHz;
const n = 1; 

let fresnelSup = [], fresnelInf = [];
for (let i = 0; i < numPuntos; i++) {
  const d1 = distanciaKm * 1000 * (i / (numPuntos - 1));
  const d2 = distanciaKm * 1000 - d1;
  let F = 0;
  if (d1 + d2 > 0) {
    F = Math.sqrt((n * lambda * d1 * d2) / (d1 + d2));
  }
  fresnelSup.push(lineaVista[i] + 0.6 * F);
  fresnelInf.push(lineaVista[i] - 0.6 * F);
}
    const distancias = elevaciones.map((_, i) => +(distanciaKm * i / (numPuntos - 1)).toFixed(2));
    const torreA = {
  x: [0, 0],
  y: [elevaciones[0], elevaciones[0] + alturaA],
  name: `Torre A (${alturaA} m)`,
  mode: 'lines+markers',
  line: { color: '#00e6ff', width: 6 },
  marker: { size: 10, color: '#00e6ff' },
  showlegend: true
};
const torreB = {
  x: [distanciaKm, distanciaKm],
  y: [elevaciones[elevaciones.length - 1], elevaciones[elevaciones.length - 1] + alturaB],
  name: `Torre B (${alturaB} m)`,
  mode: 'lines+markers',
  line: { color: '#e53935', width: 6 },
  marker: { size: 10, color: '#e53935' },
  showlegend: true
};   
    Plotly.newPlot('perfilElevacionPlotly', [
      {
        x: distancias,
        y: elevaciones,
        name: 'Terreno',
        type: 'scatter',
        mode: 'lines',
        fill: 'tozeroy',
        line: { color: '#764ba2', width: 3 }
      },
  torreA,
  torreB,     
      {
        x: distancias,
        y: lineaVista,
        name: 'L√≠nea de Vista',
        type: 'scatter',
        mode: 'lines',
        line: { color: '#10b981', width: 2, dash: 'dash' }
      },
      {
        x: [...distancias, ...distancias.slice().reverse()],
        y: [...fresnelSup, ...fresnelInf.slice().reverse()],
        name: 'Zona Fresnel (60%)',
        type: 'scatter',
        mode: 'lines',
        fill: 'toself',
        fillcolor: 'rgba(245,158,66,0.18)',
        line: { color: '#f59e42', width: 1, dash: 'dot' },
        hoverinfo: 'skip',
        showlegend: true
      }
    ], {
      title: 'Perfil de Elevaci√≥n y Zona de Fresnel',
      xaxis: { title: 'Distancia (km)', zeroline: false },
      yaxis: { title: 'Altura (msnm)', zeroline: false },
      legend: { orientation: 'h', x: 0.5, xanchor: 'center', y: -0.2 },
      plot_bgcolor: '#181f2a',
      paper_bgcolor: '#181f2a',
      font: { color: '#e0f7fa' },
      margin: { t: 60, l: 60, r: 30, b: 60 }
    }, {responsive: true});
    if (document.getElementById('torreA-id')) {
      document.getElementById('torreA-id').textContent = idA;
      document.getElementById('torreA-nombre').textContent = nombreA;
      document.getElementById('torreA-altura').textContent = alturaA + ' m';
    }
    if (document.getElementById('torreB-id')) {
      document.getElementById('torreB-id').textContent = idB;
      document.getElementById('torreB-nombre').textContent = nombreB;
      document.getElementById('torreB-altura').textContent = alturaB + ' m';
    }
    let factibilidad = '';
let color = '';
if (alturaA > 0 && alturaB > 0) {
  let obstruido = false;
  for (let i = 0; i < elevaciones.length; i++) {
    if (elevaciones[i] > fresnelSup[i]) {
      obstruido = true;
      break;
    }
  }
  if (obstruido) {
    factibilidad = 'NO FACTIBLE';
    color = '#ef4444';
  } else {
    factibilidad = 'FACTIBLE';
    color = '#10b981';
  }
} else {
  factibilidad = 'REQUIERE AN√ÅLISIS';
  color = '#f59e42';
}
const indicador = document.getElementById('indicador-factibilidad');
if (indicador) {
  indicador.innerHTML = `<span style="color:${color};">${factibilidad}</span>`;
}
  } catch (error) {
    alert('Error al consultar Open-Elevation.');
  }
let factorK = 4/3; 
const R = 6371000 * factorK; 
const distanciaTotalM = distanciaKm * 1000;
const bulboCurvatura = (distanciaTotalM * distanciaTotalM) / (8 * R);
}
function actualizarResumenEnlaces() {
  // Verificar si el procesamiento est√° activo
  if (!window.procesamientoActivo) {
    return; // No actualizar si no hay procesamiento activo
  }
  
  const filasNormales = Array.from(document.querySelectorAll('#tabla tbody tr'));
  const filasMismo = [];
  const tablaMismo = document.getElementById('tabla-mismo-tipo');
  if (tablaMismo) {
    Array.from(tablaMismo.querySelectorAll('tbody tr')).forEach(tr => filasMismo.push(tr));
  }
  const filas = filasNormales.concat(filasMismo);
  const total = filas.length;
  const factibles = filas.filter(fila => {
    const celdas = fila.querySelectorAll('td');
    const val = celdas[30]?.textContent.trim().toUpperCase();
    return val === 'S√ç' || val.startsWith('FACTIBLE');
  }).length;

  document.getElementById('resumen-total-enlaces').textContent = total;
  document.getElementById('resumen-enlaces-factibles').textContent = factibles;
}

function hookResumenEnlaces() {
  actualizarResumenEnlaces();
}
let intervaloResumen = null;

function iniciarIntervaloResumen() {
  if (intervaloResumen) {
    clearInterval(intervaloResumen);
  }
  
}

function detenerIntervaloResumen() {
  if (intervaloResumen) {
    clearInterval(intervaloResumen);
    intervaloResumen = null;
  }
}
const estados = {};
document.querySelectorAll('#tabla tbody tr').forEach(fila => {
  const estadoA = fila.querySelectorAll('td')[28]?.textContent.trim() || 'N/D';
  estados[estadoA] = (estados[estadoA] || 0) + 1;
});
const ctxBar = document.getElementById('graficoEstados').getContext('2d');
new Chart(ctxBar, {
  type: 'bar',
  data: {
    labels: Object.keys(estados),
    datasets: [{
      label: 'Enlaces por Estado',
      data: Object.values(estados),
      backgroundColor: '#2196f3'
    }]
  }
});
function seleccionarTodosEnlaces() {
  document.querySelectorAll('#tabla tbody .check-enlace').forEach(cb => cb.checked = true);
  actualizarBotonEliminarSeleccionados();
}
function toggleSeleccionarTodos(master) {
  document.querySelectorAll('#tabla tbody .check-enlace').forEach(cb => cb.checked = master.checked);
  actualizarBotonEliminarSeleccionados();
}
function actualizarBotonEliminarSeleccionados() {
  const algunoSeleccionado = Array.from(document.querySelectorAll('#tabla tbody .check-enlace')).some(cb => cb.checked);
  document.getElementById('btnEliminarSeleccionados').disabled = !algunoSeleccionado;
}
function eliminarEnlacesSeleccionados() {
  if (!confirm('¬øSeguro que deseas eliminar los enlaces seleccionados?')) return;
  document.querySelectorAll('#tabla tbody .check-enlace:checked').forEach(cb => {
    cb.closest('tr').remove();
  });
  actualizarContadorEnlaces();
  verificarEnlacesVacios();
  guardarEnlacesEnStorage();
  actualizarBotonEliminarSeleccionados();
}
['latA','lonA','latB','lonB','alturaA','alturaB','frecuencia'].forEach(id => {
  const el = document.getElementById(id);
  if (el) {
    el.addEventListener('input', () => {
      window.ultimaFactibilidadLOS = undefined;
      document.getElementById('agregarBtn').disabled = true;    });
  }
});
// ‚úÖ FUNCI√ìN PARA CREAR EL PANEL DE FILTROS AVANZADOS
function crearPanelFiltrosAvanzados() {
  // Remover panel anterior si existe
  const panelAnterior = document.querySelector('.panel-filtros-avanzados');
  if (panelAnterior) {
    panelAnterior.remove();
  }
  
  const panel = document.createElement('div');
  panel.className = 'panel-filtros-avanzados';
  panel.innerHTML = `
    <div class="panel-header">
      <h4><i class="fas fa-filter"></i> Filtros Avanzados</h4>
    </div>
    
    <div class="filtros-content">
      <div class="filtro-grupo">
        <h5>üìä Estado</h5>
        <label class="filtro-checkbox">
          <input type="checkbox" id="filtro-factibles" checked>
          <span>üü¢ Factibles</span>
        </label>
        <label class="filtro-checkbox">
          <input type="checkbox" id="filtro-no-factibles" checked>
          <span>ÔøΩÔøΩ No Factibles</span>
        </label>
      </div>
      
      <div class="filtro-grupo">
        <h5>ÔøΩÔøΩ Tipo de Enlace</h5>
        <label class="filtro-checkbox">
          <input type="checkbox" id="filtro-fibra" checked>
          <span>ÔøΩÔøΩ Fibra √ìptica</span>
        </label>
        <label class="filtro-checkbox">
          <input type="checkbox" id="filtro-radio" checked>
          <span>üîµ Radio</span>
        </label>
        <label class="filtro-checkbox">
          <input type="checkbox" id="filtro-satelite" checked>
          <span>üü£ Sat√©lite</span>
        </label>
        <label class="filtro-checkbox">
          <input type="checkbox" id="filtro-adquisicion" checked>
          <span>üü† Adquisici√≥n</span>
        </label>
      </div>
      
      <div class="filtro-acciones">
        <button class="btn btn-primary" onclick="aplicarFiltrosAvanzados()">
          <i class="fas fa-filter"></i> Aplicar Filtros
        </button>
        <button class="btn btn-secondary" onclick="limpiarFiltros()">
          <i class="fas fa-times"></i> Limpiar
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(panel);
  console.log('‚úÖ Panel de filtros avanzados creado');
}

// ‚úÖ FUNCI√ìN PARA APLICAR FILTROS AVANZADOS
function aplicarFiltrosAvanzados() {
  const filtros = {
    factibles: document.getElementById('filtro-factibles')?.checked || false,
    noFactibles: document.getElementById('filtro-no-factibles')?.checked || false,
    fibra: document.getElementById('filtro-fibra')?.checked || false,
    radio: document.getElementById('filtro-radio')?.checked || false,
    satelite: document.getElementById('filtro-satelite')?.checked || false,
    adquisicion: document.getElementById('filtro-adquisicion')?.checked || false
  };
  
  console.log('üîç Aplicando filtros:', filtros);
  
  if (!window.mapaEnlaces) return;
  
  let enlacesVisibles = 0;
  let enlacesOcultos = 0;
  
  window.mapaEnlaces.eachLayer((layer) => {
    if (layer instanceof L.Polyline) {
      // Obtener informaci√≥n del enlace desde el tooltip
      const tooltip = layer.getTooltip();
      if (tooltip && tooltip.getContent()) {
        const contenido = tooltip.getContent();
        const esFactible = contenido.includes('‚úÖ S√≠');
        const tipoEnlace = obtenerTipoEnlace(contenido);
        
        const debeMostrar = evaluarFiltros({ factible: esFactible, tipoEnlace }, filtros);
        
        if (debeMostrar) {
          layer.setStyle({ opacity: 0.8, weight: 4 });
          enlacesVisibles++;
        } else {
          layer.setStyle({ opacity: 0.1, weight: 1 });
          enlacesOcultos++;
        }
      }
    }
  });
  
  console.log(`ÔøΩÔøΩ Filtros aplicados: ${enlacesVisibles} visibles, ${enlacesOcultos} ocultos`);
  mostrarNotificacion(`ÔøΩÔøΩ Filtros aplicados: ${enlacesVisibles} enlaces visibles`);
}

// ‚úÖ FUNCI√ìN PARA EVALUAR FILTROS
function evaluarFiltros(infoEnlace, filtros) {
  // Si no hay filtros activos, mostrar todo
  if (!Object.values(filtros).some(f => f)) return true;
  
  // Evaluar filtros de factibilidad
  if (filtros.factibles && !infoEnlace.factible) return false;
  if (filtros.noFactibles && infoEnlace.factible) return false;
  
  // Evaluar filtros de tipo
  const tipoEnlace = infoEnlace.tipoEnlace?.toString().toLowerCase() || '';
  
  if (filtros.fibra && tipoEnlace.includes('fibra')) return true;
  if (filtros.radio && tipoEnlace.includes('radio')) return true;
  if (filtros.satelite && tipoEnlace.includes('sat√©lite')) return true;
  if (filtros.adquisicion && tipoEnlace.includes('adquisici√≥n')) return true;
  
  // Si hay filtros de tipo activos pero no coincide ninguno, ocultar
  if (filtros.fibra || filtros.radio || filtros.satelite || filtros.adquisicion) {
    return false;
  }
  
  return true;
}

// ‚úÖ FUNCI√ìN PARA OBTENER TIPO DE ENLACE
function obtenerTipoEnlace(contenido) {
  if (contenido.includes('Fibra')) return 'Fibra √ìptica';
  if (contenido.includes('Radio')) return 'Radio';
  if (contenido.includes('Sat√©lite')) return 'Sat√©lite';
  if (contenido.includes('Adquisici√≥n')) return 'Adquisici√≥n';
  return 'Desconocido';
}

// ‚úÖ FUNCI√ìN PARA LIMPIAR FILTROS
function limpiarFiltros() {
  // Marcar todos los checkboxes como checked
  const checkboxes = document.querySelectorAll('.filtro-checkbox input[type="checkbox"]');
  checkboxes.forEach(checkbox => {
    checkbox.checked = true;
  });
  
  // Mostrar todos los enlaces
  if (window.mapaEnlaces) {
    window.mapaEnlaces.eachLayer((layer) => {
      if (layer instanceof L.Polyline) {
        layer.setStyle({ opacity: 0.8, weight: 4 });
      }
    });
  }
  
  mostrarNotificacion('‚úÖ Filtros limpiados - Todos los enlaces visibles');
}


function mostrarMapaEnlaces(estadoFiltro = null) {
  console.log('üöÄ INICIANDO mostrarMapaEnlaces...');
  
  const divMapa = document.getElementById('mapa-enlaces');
  if (!divMapa) {
    console.error('‚ùå No se encontr√≥ el div del mapa');
    return;
  }
  
  console.log('‚úÖ Div del mapa encontrado:', divMapa);
  
  if (window.mapaEnlaces) {
    console.log('üóëÔ∏è Removiendo mapa anterior...');
    window.mapaEnlaces.remove();
  }
  
  // ‚úÖ HACER EL MAPA M√ÅS ALTO (EXPANSI√ìN VERTICAL)
  divMapa.style.width = '100%';
  divMapa.style.maxWidth = '100vw';
  divMapa.style.height = '90vh';           // ‚úÖ AUMENTAR A 90% DE LA ALTURA
  divMapa.style.minHeight = '800px';       // ‚úÖ ALTURA M√çNIMA DE 800px
  divMapa.style.margin = '16px auto';     // ‚úÖ MARGEN REDUCIDO
  divMapa.style.borderRadius = '12px';    // ‚úÖ BORDES M√ÅS SUAVES
  
  console.log('üó∫Ô∏è Creando nuevo mapa...');
  const mapa = L.map('mapa-enlaces').setView([23.6345, -102.5528], 5.2);
  window.mapaEnlaces = mapa;
  
  console.log('‚úÖ Mapa creado correctamente');
  
  // ‚úÖ AGREGAR CONTROLES MEJORADOS (NUEVAS FUNCIONALIDADES)
  const panelControles = crearPanelControlesMapa();
  const panelEstadisticas = crearPanelEstadisticasAvanzadas();
  const sistemaBusqueda = crearSistemaBusqueda();
  const { controlCapas, capaFactibles, capaNoFactibles, capaTodos } = crearControlCapas();
  
  panelControles.addTo(mapa);
  panelEstadisticas.addTo(mapa);
  sistemaBusqueda.addTo(mapa);
  controlCapas.addTo(mapa);
  
  // ‚úÖ AGREGAR CAPA B√ÅSICA
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap contributors'
  }).addTo(mapa);
  
  console.log('‚úÖ Mapa creado correctamente');
  
  // ‚úÖ OBTENER ENLACES DE LA TABLA
  const tablaPrincipal = document.querySelector('#tabla tbody');
  const tablaMismo = document.querySelector('#tabla-mismo-tipo tbody');
  
  console.log('ÔøΩÔøΩ Buscando tablas...');
  console.log('Tabla principal:', tablaPrincipal);
  console.log('Tabla mismo tipo:', tablaMismo);
  
  let filas = [];
  
  if (tablaPrincipal) {
    const filasPrincipales = Array.from(tablaPrincipal.querySelectorAll('tr'));
    console.log('üìä Filas en tabla principal:', filasPrincipales.length);
    filas = filas.concat(filasPrincipales);
  }
  
  if (tablaMismo) {
    const filasMismo = Array.from(tablaMismo.querySelectorAll('tr'));
    console.log('üìä Filas en tabla mismo tipo:', filasMismo.length);
    filas = filas.concat(filasMismo);
  }
  
  console.log('üìä Total de filas encontradas:', filas.length);
  
  // ‚úÖ VERIFICAR QUE TENGA DATOS
  if (filas.length === 0) {
    console.log('‚ö†Ô∏è No se encontraron filas en las tablas');
    
    // ‚úÖ CREAR PANEL DE ERROR
    const errorPanel = L.control({position: 'center'});
    errorPanel.onAdd = function() {
      const div = L.DomUtil.create('div', 'map-error');
      div.innerHTML = `
        <h4>‚ö†Ô∏è No hay enlaces para mostrar</h4>
        <p>No se encontraron enlaces en las tablas.</p>
        <p>Verifica que hayas procesado los pares primero.</p>
      `;
      return div;
    };
    errorPanel.addTo(mapa);
    return;
  }
  
  // ‚úÖ PROCESAR CADA ENLACE
  let enlacesAgregados = 0;
  let enlacesFactibles = 0;
  let enlacesNoFactibles = 0;
  
  console.log('ÔøΩÔøΩ Procesando enlaces...');
  
  filas.forEach((fila, index) => {
    const celdas = fila.querySelectorAll('td');
    
    // ‚úÖ VERIFICAR QUE TENGA SUFICIENTES CELDAS
    if (celdas.length < 31) {
      console.log(`‚ö†Ô∏è Fila ${index} no tiene suficientes celdas:`, celdas.length);
      return;
    }
    
    // ‚úÖ LEER DATOS DE LAS CELDAS CORRECTAS
    const latA = parseFloat(celdas[3]?.textContent.replace(',', '.'));
    const lonA = parseFloat(celdas[4]?.textContent.replace(',', '.'));
    const latB = parseFloat(celdas[9]?.textContent.replace(',', '.'));
    const lonB = parseFloat(celdas[10]?.textContent.replace(',', '.'));
    const estadoA = celdas[28]?.textContent.trim() || 'Sin Estado';
    const estadoB = celdas[29]?.textContent.trim() || 'Sin Estado';
    const factible = celdas[30]?.textContent.trim().toUpperCase().startsWith('S√ç') || 
                     celdas[30]?.textContent.trim().toUpperCase().startsWith('FACTIBLE');
    const tipoTransporte = celdas[20]?.textContent.trim() || '';
    const nombreA = celdas[1]?.textContent || 'A';
    const nombreB = celdas[7]?.textContent || 'B';
    
    console.log(`ÔøΩÔøΩ Procesando fila ${index}:`, {
      nombreA, nombreB, latA, lonA, latB, lonB, factible, estadoA, estadoB
    });
    
    // ‚úÖ FILTRAR POR ESTADO SI SE ESPECIFICA
    if (estadoFiltro && estadoA !== estadoFiltro && estadoB !== estadoFiltro) {
      console.log(`üö´ Filtrado por estado: ${estadoA} - ${estadoB} != ${estadoFiltro}`);
      return;
    }
    
    if (!isNaN(latA) && !isNaN(lonA) && !isNaN(latB) && !isNaN(lonB)) {
      // ‚úÖ CONTAR ENLACES
      if (factible) {
        enlacesFactibles++;
      } else {
        enlacesNoFactibles++;
      }
      
      console.log(`‚úÖ Coordenadas v√°lidas: ${latA}, ${lonA} ‚Üí ${latB}, ${lonB}`);
      
      // ‚úÖ L√çNEAS DE ENLACE CON COLORES
      const color = factible ? '#10b981' : '#ef4444';
      const poly = L.polyline([[latA, lonA], [latB, lonB]], {
        color: color,
        weight: 4,
        opacity: 0.8,
        dashArray: factible ? '5, 5' : '10, 5'
      }).addTo(mapa);
      
      console.log(`‚úÖ L√≠nea de enlace agregada: ${nombreA} ‚Üí ${nombreB}`);
      
      // ‚úÖ TOOLTIPS INTERACTIVOS
      poly.bindTooltip(`
        <div class="tooltip-enlace">
          <h4>${nombreA} ‚Üí ${nombreB}</h4>
          <p><strong>Estado:</strong> ${estadoA} - ${estadoB}</p>
          <p><strong>Factible:</strong> ${factible ? '‚úÖ S√≠' : '‚ùå No'}</p>
          <p><strong>Transporte:</strong> ${tipoTransporte}</p>
        </div>
      `, {permanent: false, direction: 'top'});
      
      // ‚úÖ MARCADORES PERSONALIZADOS
      const iconoA = factible ? 
        L.divIcon({
          html: '<div class="marker-factible">‚úÖ</div>',
          className: 'marker-custom',
          iconSize: [30, 30],
          iconAnchor: [15, 15]
        }) : 
        L.divIcon({
          html: '<div class="marker-no-factible">‚ùå</div>',
          className: 'marker-custom',
          iconSize: [30, 30],
          iconAnchor: [15, 15]
        });
      
      const iconoB = iconoA;
      
      const markerA = L.marker([latA, lonA], {icon: iconoA}).addTo(mapa);
      const markerB = L.marker([latB, lonB], {icon: iconoB}).addTo(mapa);
      
      console.log(`‚úÖ Marcadores agregados: ${nombreA} y ${nombreB}`);
      
      // ‚úÖ TOOLTIPS PARA MARCADORES
      markerA.bindTooltip(`
        <div class="tooltip-marker">
          <h5>${nombreA}</h5>
          <p><strong>Estado:</strong> ${estadoA}</p>
          <p><strong>Factible:</strong> ${factible ? '‚úÖ S√≠' : '‚ùå No'}</p>
        </div>
      `);
      
      markerB.bindTooltip(`
        <div class="tooltip-marker">
          <h5>${nombreB}</h5>
          <p><strong>Estado:</strong> ${estadoB}</p>
          <p><strong>Factible:</strong> ${factible ? '‚úÖ S√≠' : '‚ùå No'}</p>
        </div>
      `);
      
      enlacesAgregados++;
      console.log(`‚úÖ Enlace ${index} agregado al mapa: ${nombreA} ‚Üí ${nombreB}`);
    } else {
      console.log(`‚ùå Coordenadas inv√°lidas en fila ${index}:`, {latA, lonA, latB, lonB});
    }
  });
  
  console.log(`ÔøΩÔøΩ Resumen final:`);
  console.log(`- Total de filas: ${filas.length}`);
  console.log(`- Enlaces agregados al mapa: ${enlacesAgregados}`);
  console.log(`- Enlaces factibles: ${enlacesFactibles}`);
  console.log(`- Enlaces no factibles: ${enlacesNoFactibles}`);
  
  // ‚úÖ ACTUALIZAR ESTAD√çSTICAS AVANZADAS
  const contadorFactibles = document.getElementById('contador-factibles');
  const contadorNoFactibles = document.getElementById('contador-no-factibles');
  const contadorTotal = document.getElementById('contador-total');
  
  if (contadorFactibles) contadorFactibles.textContent = enlacesFactibles;
  if (contadorNoFactibles) contadorNoFactibles.textContent = enlacesNoFactibles;
  if (contadorTotal) contadorTotal.textContent = enlacesAgregados;
  
  // ‚úÖ ACTUALIZAR BARRA DE PROGRESO
  const progressFillFactible = document.querySelector('.progress-fill.factible');
  const progressFillNoFactible = document.querySelector('.progress-fill.no-factible');
  const progressText = document.querySelector('.progress-text');
  
  if (enlacesAgregados > 0) {
    const porcentajeFactibles = Math.round((enlacesFactibles / enlacesAgregados) * 100);
    const porcentajeNoFactibles = 100 - porcentajeFactibles;
    
    if (progressFillFactible) progressFillFactible.style.width = `${porcentajeFactibles}%`;
    if (progressFillNoFactible) progressFillNoFactibles.style.width = `${porcentajeNoFactibles}%`;
    if (progressText) progressText.textContent = `${porcentajeFactibles}% Factibles`;
  }
  
  // ‚úÖ PANEL DE ESTAD√çSTICAS SIMPLE (MANTENER PARA COMPATIBILIDAD)
  const statsPanel = L.control({position: 'bottomleft'});
  statsPanel.onAdd = function() {
    const div = L.DomUtil.create('div', 'stats-panel');
    div.innerHTML = `
      <div class="stats-content">
        <h4>ÔøΩÔøΩ Estad√≠sticas del Mapa</h4>
        <p><strong>Altura:</strong> Expandida (90vh)</p>
        <p><strong>Total de Filas:</strong> ${filas.length}</p>
        <p><strong>Enlaces en Mapa:</strong> ${enlacesAgregados}</p>
        <p><strong>Factibles:</strong> ${enlacesFactibles}</p>
        <p><strong>No Factibles:</strong> ${enlacesNoFactibles}</p>
      </div>
    `;
    return div;
  };
  statsPanel.addTo(mapa);
  
  // ‚úÖ AGREGAR CONTROLES DE MAPA ADICIONALES
  L.control.scale({position: 'bottomright'}).addTo(mapa);
  L.control.fullscreen({position: 'topright'}).addTo(mapa);
  
  // ‚úÖ AGREGAR FUNCIONALIDAD DE ZOOM AUTOM√ÅTICO
  if (enlacesAgregados > 0) {
    setTimeout(() => {
      mapa.fitBounds(L.latLngBounds(filas.map(fila => {
        const celdas = fila.querySelectorAll('td');
        const latA = parseFloat(celdas[3]?.textContent.replace(',', '.'));
        const lonA = parseFloat(celdas[4]?.textContent.replace(',', '.'));
        const latB = parseFloat(celdas[9]?.textContent.replace(',', '.'));
        const lonB = parseFloat(celdas[10]?.textContent.replace(',', '.'));
        
        if (!isNaN(latA) && !isNaN(lonA)) return [latA, lonA];
        if (!isNaN(latB) && !isNaN(lonB)) return [latB, lonB];
        return null;
      }).filter(Boolean)), {padding: [50, 50]});
    }, 1000);
  }
  
  console.log('üéâ Mapa de enlaces completado exitosamente');
}


// ‚úÖ FUNCI√ìN PARA ZOOM A TODOS LOS ENLACES
function zoomToFit() {
  if (window.mapaEnlaces) {
    const enlaces = document.querySelectorAll('#tabla tbody tr, #tabla-mismo-tipo tbody tr');
    const bounds = L.latLngBounds();
    
    enlaces.forEach(fila => {
      const celdas = fila.querySelectorAll('td');
      const latA = parseFloat(celdas[3]?.textContent.replace(',', '.'));
      const lonA = parseFloat(celdas[4]?.textContent.replace(',', '.'));
      const latB = parseFloat(celdas[9]?.textContent.replace(',', '.'));
      const lonB = parseFloat(celdas[10]?.textContent.replace(',', '.'));
      
      if (!isNaN(latA) && !isNaN(lonA)) {
        bounds.extend([latA, lonA]);
      }
      if (!isNaN(latB) && !isNaN(lonB)) {
        bounds.extend([latB, lonB]);
      }
    });
    
    if (!bounds.isEmpty()) {
      window.mapaEnlaces.fitBounds(bounds, {padding: [50, 50]});
    }
  }
}

// ‚úÖ FUNCI√ìN PARA CAMBIAR ESTILO DE MAPA
let currentStyle = 0;
const estilosMapa = [
  'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
  'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
  'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',
  'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
];

const nombresEstilos = ['OpenStreetMap', 'Sat√©lite', 'Terreno', 'Oscuro'];

function cambiarEstiloMapa() {
  if (window.mapaEnlaces) {
    // Remover capa actual
    window.mapaEnlaces.eachLayer(layer => {
      if (layer instanceof L.TileLayer) {
        window.mapaEnlaces.removeLayer(layer);
      }
    });
    
    // Cambiar estilo
    currentStyle = (currentStyle + 1) % estilosMapa.length;
    
    // Agregar nueva capa
    L.tileLayer(estilosMapa[currentStyle], {
      attribution: '¬© OpenStreetMap contributors'
    }).addTo(window.mapaEnlaces);
    
    // Mostrar notificaci√≥n
    const notif = document.createElement('div');
    notif.style.cssText = `
      position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
      background: #00bcd4; color: white; padding: 10px 20px;
      border-radius: 20px; z-index: 10000; font-weight: bold;
    `;
    notif.textContent = `Estilo: ${nombresEstilos[currentStyle]}`;
    document.body.appendChild(notif);
    setTimeout(() => notif.remove(), 2000);
  }
}

// ‚úÖ FUNCI√ìN PARA EXPANDIR ALTURA DEL MAPA
function expandirAlturaMapa() {
  const divMapa = document.getElementById('mapa-enlaces');
  
  // ‚úÖ EXPANDIR A ALTURA COMPLETA
  divMapa.style.height = '95vh';           // 95% de la altura de la ventana
  divMapa.style.minHeight = '900px';       // Altura m√≠nima de 900px
  divMapa.style.margin = '8px auto';       // Margen m√≠nimo
  divMapa.style.borderRadius = '8px';      // Bordes m√°s suaves
  
  // ‚úÖ ACTUALIZAR INDICADOR
  actualizarIndicadorAltura();
  
  // ‚úÖ AJUSTAR MAPA DE LEAFLET
  if (window.mapaEnlaces) {
    setTimeout(() => {
      window.mapaEnlaces.invalidateSize();
    }, 100);
  }
  
  mostrarNotificacion('üìè Mapa expandido verticalmente', 'success');
}

// ‚úÖ FUNCI√ìN PARA ALTURA EXTREMA
function alturaExtremaMapa() {
  const divMapa = document.getElementById('mapa-enlaces');
  
  // ‚úÖ ALTURA EXTREMA - CASI TODA LA PANTALLA
  divMapa.style.height = '98vh';           // 98% de la altura de la ventana
  divMapa.style.minHeight = '1000px';      // Altura m√≠nima de 1000px
  divMapa.style.margin = '4px auto';       // Margen m√≠nimo
  divMapa.style.borderRadius = '4px';      // Bordes muy suaves
  
  // ‚úÖ ACTUALIZAR INDICADOR
  actualizarIndicadorAltura();
  
  // ‚úÖ AJUSTAR MAPA DE LEAFLET
  if (window.mapaEnlaces) {
    setTimeout(() => {
      window.mapaEnlaces.invalidateSize();
    }, 100);
  }
  
  mostrarNotificacion('üöÄ Altura extrema activada', 'success');
}

// ‚úÖ FUNCI√ìN PARA RESTAURAR ALTURA NORMAL
function restaurarAlturaMapa() {
  const divMapa = document.getElementById('mapa-enlaces');
  
  // ‚úÖ RESTAURAR ALTURA NORMAL
  divMapa.style.height = '90vh';           // Altura expandida
  divMapa.style.minHeight = '800px';       // Altura m√≠nima expandida
  divMapa.style.margin = '16px auto';      // Margen expandido
  divMapa.style.borderRadius = '12px';     // Bordes expandidos
  
  // ‚úÖ ACTUALIZAR INDICADOR
  actualizarIndicadorAltura();
  
  // ‚úÖ AJUSTAR MAPA DE LEAFLET
  if (window.mapaEnlaces) {
    setTimeout(() => {
      window.mapaEnlaces.invalidateSize();
    }, 100);
  }
  
  mostrarNotificacion('üì± Altura expandida restaurada', 'info');
}

// ‚úÖ FUNCI√ìN PARA ACTUALIZAR INDICADOR DE ALTURA
function actualizarIndicadorAltura() {
  const divMapa = document.getElementById('mapa-enlaces');
  const indicator = document.getElementById('altura-indicator');
  
  if (indicator && divMapa) {
    const altura = divMapa.style.height;
    const alturaNum = parseInt(altura);
    
    if (altura === '98vh' || alturaNum >= 1000) {
      indicator.innerHTML = 'Altura: Extrema (98vh)';
      indicator.className = 'altura-indicator extrema';
    } else if (altura === '95vh' || alturaNum >= 900) {
      indicator.innerHTML = 'Altura: Expandida (95vh)';
      indicator.className = 'altura-indicator expandida';
    } else {
      indicator.innerHTML = 'Altura: Expandida (90vh)';
      indicator.className = 'altura-indicator';
    }
  }
}
// ‚úÖ FUNCI√ìN PARA AGREGAR ENLACE MANUALMENTE (√çNDICES CORREGIDOS)
function agregarEnlace() {
  console.log('üöÄ Iniciando agregarEnlace...');
  
  // ‚úÖ OBTENER VALORES DEL FORMULARIO
  const get = id => document.getElementById(id).value.trim();
  
  const idA = get('idA');
  const nombreA = get('nombreA');
  const latA = parseFloat(get('latA'));
  const lonA = parseFloat(get('lonA'));
  const alturaA = get('alturaA');
  const ranA = get('ranA');
  const transA = get('TransA');
  const arreA = get('ArreA');
  const onA = get('OnA');
  const torreA = get('TorreA');
  const estadoA = get('EstadoA');
  
  const idB = get('idB');
  const nombreB = get('nombreB');
  const latB = parseFloat(get('latB'));
  const lonB = parseFloat(get('lonB'));
  const alturaB = get('alturaB');
  const ranB = get('ranB');
  const transB = get('TransB');
  const arreB = get('ArreB');
  const onB = get('OnB');
  const torreB = get('TorreB');
  const estadoB = get('EstadoB');
  
  // ‚úÖ VALIDACIONES
  if (!idA || !idB) {
    mostrarNotificacion('‚ùå Error: Debes ingresar IDs para ambas torres', 'error');
    return;
  }
  
  if (isNaN(latA) || isNaN(lonA) || isNaN(latB) || isNaN(lonB)) {
    mostrarNotificacion('‚ùå Error: Coordenadas inv√°lidas', 'error');
    return;
  }
  
  // ‚úÖ CALCULAR DISTANCIA Y FRECUENCIA
  const distanciaKm = calcularDistancia(latA, lonA, latB, lonB);
  const frecuencia = asignarFrecuencia(distanciaKm);
  
  // ‚úÖ ANALIZAR FACTIBILIDAD
  const factibilidad = analizarFactibilidad(
    distanciaKm,
    arreA,
    arreB,
    transA,
    transB,
    torreA,
    torreB,
    onA,
    onB,
    true // esFactibleLOS
  );
  
  console.log('üîç factibilidad en agregarEnlace:', factibilidad);
  console.log('üì° diametroAntena en agregarEnlace:', factibilidad.diametroAntena);
  
  // ‚úÖ DETERMINAR ESTADO FACTIBLE
  const estadoFactible = (factibilidad.advertencia)
    ? 'FACTIBLE (Requiere an√°lisis)'
    : (factibilidad.razon && factibilidad.razon.toUpperCase().includes('NO DISPONIBLE'))
      ? 'NO DISPONIBLE'
      : (factibilidad.factible ? 'S√ç' : 'NO');
  
  // ‚úÖ CREAR FILA DE DATOS (33 COLUMNAS)
  const filaDatos = [
    '', // ‚úÖ COLUMNA 0: Checkbox vac√≠o
    idA, nombreA, latA.toFixed(6), lonA.toFixed(6),
    document.getElementById('latArad').value || '',
    document.getElementById('lonArad').value || '',
    idB, nombreB, latB.toFixed(6), lonB.toFixed(6),
    document.getElementById('latBrad').value || '',
    document.getElementById('lonBrad').value || '',
    distanciaKm.toFixed(6), frecuencia,
    document.getElementById('disponibilidadAnual').value || '',
    alturaA, alturaB, ranA, ranB,
    transA, transB, arreA, arreB,
    onA, onB, torreA, torreB,
    estadoA, estadoB,
    estadoFactible, // ‚úÖ COLUMNA 29: Factible
    factibilidad.diametroAntena, // ‚úÖ COLUMNA 30: Antenas
    factibilidad.tipoEnlace, // ‚úÖ COLUMNA 31: Tipo Enlace
    JSON.stringify(factibilidad) // ‚úÖ COLUMNA 32: An√°lisis
  ];
  
  // ‚úÖ AGREGAR A LA TABLA
  const tbody = document.querySelector('#tabla tbody');
  if (!tbody) {
    console.error('‚ùå No se encontr√≥ el tbody de la tabla');
    return;
  }
  
  const nuevaFila = document.createElement('tr');
  nuevaFila.style.animation = 'fadeIn 0.5s ease-in';
  
  // ‚úÖ CREAR CELDAS CON FORMATO CORRECTO
  filaDatos.forEach((valor, i) => {
    const td = document.createElement('td');
    
    // ‚úÖ APLICAR FORMATO SEG√öN EL √çNDICE CORRECTO
    if (i === 0) { // ‚úÖ COLUMNA 0: Checkbox
      td.innerHTML = '<input type="checkbox" class="form-check-input">';
    } else if (i === 29) { // ‚úÖ COLUMNA 29: Factible
      if (valor === 'S√ç') {
        td.innerHTML = '<span class="badge badge-success">S√ç</span>';
      } else if (valor === 'NO') {
        td.innerHTML = '<span class="badge badge-danger">NO</span>';
      } else if (valor.includes('FACTIBLE')) {
        td.innerHTML = '<span class="badge badge-warning">FACTIBLE</span>';
      } else if (valor.includes('NO DISPONIBLE')) {
        td.innerHTML = '<span class="badge badge-secondary">NO DISPONIBLE</span>';
      } else {
        td.innerHTML = `<span class="badge badge-secondary">${valor}</span>`;
      }
    } else if (i === 30) { // ‚úÖ COLUMNA 30: Antenas
      if (valor && valor !== 'N/A' && valor !== 'No factible') {
        td.innerHTML = `<span class="badge badge-info">${valor}</span>`;
      } else {
        td.innerHTML = '<span class="badge badge-secondary">N/D</span>';
      }
    } else if (i === 32) { // ‚úÖ COLUMNA 32: An√°lisis
      td.innerHTML = '<button class="btn btn-sm btn-outline-info" onclick="mostrarAnalisisDetallado(' + JSON.stringify(factibilidad).replace(/"/g, '&quot;') + ')">Ver An√°lisis</button>';
    } else {
      td.textContent = valor || '';
    }
    
    nuevaFila.appendChild(td);
  });
  
  // ‚úÖ AGREGAR EVENTO DE DOBLE CLIC
  nuevaFila.addEventListener('dblclick', function() {
    const celdas = this.querySelectorAll('td');
    const datos = {
      idA: celdas[1]?.textContent, nombreA: celdas[2]?.textContent,
      latA: celdas[3]?.textContent, lonA: celdas[4]?.textContent,
      idB: celdas[7]?.textContent, nombreB: celdas[8]?.textContent,
      latB: celdas[9]?.textContent, lonB: celdas[10]?.textContent,
      alturaA: celdas[16]?.textContent, alturaB: celdas[17]?.textContent,
      frecuencia: celdas[13]?.textContent
    };
    mostrarPerfilElevacionDesdeDatos(datos);
    const perfilDiv = document.getElementById('perfil-elevacion-con-torres');
    if (perfilDiv) {
      perfilDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  });
  
  // ‚úÖ AGREGAR A LA TABLA
  tbody.appendChild(nuevaFila);
  
  // ‚úÖ GUARDAR EN localStorage
  const enlacesExistentes = JSON.parse(localStorage.getItem('enlacesPtP') || '[]');
  enlacesExistentes.push(filaDatos);
  localStorage.setItem('enlacesPtP', JSON.stringify(enlacesExistentes));
  
  // ‚úÖ ACTUALIZAR CONTADORES
  actualizarContadorEnlaces();
  
  // ‚úÖ MOSTRAR NOTIFICACI√ìN
  mostrarNotificacion('‚úÖ Enlace agregado correctamente', 'success');
  
  // ‚úÖ LIMPIAR FORMULARIO
  limpiarFormulario();
  
  console.log('üéâ Enlace agregado exitosamente:', filaDatos);
}


// ‚úÖ FUNCI√ìN PARA LIMPIAR FORMULARIO
function limpiarFormulario() {
  console.log('üßπ Limpiando formulario...');
  
  // ‚úÖ LISTA DE CAMPOS A LIMPIAR
  const campos = [
    'idA', 'nombreA', 'latA', 'lonA', 'idB', 'nombreB', 'latB', 'lonB',
    'frecuencia', 'alturaA', 'alturaB', 'tipoTransporte', 'estadoA', 'estadoB'
  ];
  
  campos.forEach(campo => {
    const elemento = document.getElementById(campo);
    if (elemento) {
      elemento.value = '';
    }
  });
  
  console.log('‚úÖ Formulario limpiado');
  mostrarNotificacion('üßπ Formulario limpiado', 'info');
}

// ‚úÖ FUNCI√ìN PARA VER MIS ENLACES
function verMisEnlaces() {
  console.log('üëÄ Mostrando mis enlaces...');
  
  // ‚úÖ CAMBIAR A LA PESTA√ëA DE ENLACES
  const pestanaEnlaces = document.querySelector('[onclick*="mostrarPestana(\'enlaces\'"]');
  if (pestanaEnlaces) {
    pestanaEnlaces.click();
  } else {
    // ‚úÖ ALTERNATIVA: CAMBIAR MANUALMENTE
    mostrarPestana('enlaces');
  }
  
  mostrarNotificacion('üëÄ Mostrando mis enlaces', 'info');
}

// ‚úÖ FUNCI√ìN PARA EXPORTAR FACTIBLES PARA PATHLOSS
function exportarFactiblesPathloss() {
  console.log('üì§ Exportando factibles para Pathloss...');
  
  // ‚úÖ OBTENER ENLACES FACTIBLES
  const enlaces = JSON.parse(localStorage.getItem('enlacesPtP') || '[]');
  const factibles = enlaces.filter(enlace => enlace.factible === 'S√≠');
  
  if (factibles.length === 0) {
    mostrarNotificacion('‚ùå No hay enlaces factibles para exportar', 'warning');
    return;
  }
  
  // ‚úÖ CREAR CONTENIDO CSV PARA PATHLOSS
  let csvContent = 'ID_A,Nombre_A,Lat_A,Lon_A,Altura_A,ID_B,Nombre_B,Lat_B,Lon_B,Altura_B,Frecuencia,Distancia\n';
  
  factibles.forEach(enlace => {
    csvContent += `${enlace.idA},${enlace.nombreA},${enlace.latA},${enlace.lonA},${enlace.alturaA},${enlace.idB},${enlace.nombreB},${enlace.latB},${enlace.lonB},${enlace.alturaB},${enlace.frecuencia},${enlace.distancia}\n`;
  });
  
  // ‚úÖ CREAR ARCHIVO PARA DESCARGAR
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  
  link.setAttribute('href', url);
  link.setAttribute('download', `enlaces_factibles_pathloss_${new Date().toISOString().split('T')[0]}.csv`);
  link.style.visibility = 'hidden';
  
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  console.log(`‚úÖ Exportados ${factibles.length} enlaces factibles`);
  mostrarNotificacion(`üì§ Exportados ${factibles.length} enlaces factibles`, 'success');
}

// ‚úÖ FUNCI√ìN PARA NOTIFICACIONES
function mostrarNotificacion(mensaje, tipo = 'info') {
  const notif = document.createElement('div');
  notif.style.cssText = `
    position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
    padding: 12px 24px; border-radius: 25px; z-index: 10000; 
    font-weight: bold; color: white;
  `;
  
  const colores = {
    'success': '#10b981',
    'error': '#ef4444',
    'warning': '#f59e0b',
    'info': '#00bcd4'
  };
  
  notif.style.background = colores[tipo] || colores.info;
  notif.textContent = mensaje;
  document.body.appendChild(notif);
  
  setTimeout(() => {
    notif.remove();
  }, 3000);
}


function actualizarContadores() {
  console.log('üîÑ Actualizando contadores...');
  
  // Buscar en la tabla principal
  const tablaPrincipal = document.querySelector('#tabla tbody');
  const tablaMismo = document.querySelector('#tabla-mismo-tipo tbody');
  
  let totalEnlaces = 0;
  let totalFactibles = 0;
  
  if (tablaPrincipal) {
    const filas = Array.from(tablaPrincipal.querySelectorAll('tr'));
    filas.forEach(fila => {
      const celdas = fila.querySelectorAll('td');
      if (celdas.length >= 31) {
        totalEnlaces++;
        const factible = celdas[30]?.textContent.trim().toUpperCase().startsWith('S√ç') || 
                         celdas[30]?.textContent.trim().toUpperCase().startsWith('FACTIBLE');
        if (factible) totalFactibles++;
      }
    });
  }
  
  if (tablaMismo) {
    const filas = Array.from(tablaMismo.querySelectorAll('tr'));
    filas.forEach(fila => {
      const celdas = fila.querySelectorAll('td');
      if (celdas.length >= 31) {
        totalEnlaces++;
        const factible = celdas[30]?.textContent.trim().toUpperCase().startsWith('S√ç') || 
                         celdas[30]?.textContent.trim().toUpperCase().startsWith('FACTIBLE');
        if (factible) totalFactibles++;
      }
    });
  }
  
  console.log(`üìä Contadores actualizados: Total=${totalEnlaces}, Factibles=${totalFactibles}`);
  
  // Actualizar elementos en la interfaz
  const totalElement = document.querySelector('[data-total-enlaces]') || 
                      document.querySelector('.total-enlaces') ||
                      document.querySelector('#total-enlaces');
  
  const factiblesElement = document.querySelector('[data-factibles]') || 
                           document.querySelector('.factibles') ||
                           document.querySelector('#factibles');
  
  if (totalElement) {
    totalElement.textContent = totalEnlaces;
  }
  
  if (factiblesElement) {
    factiblesElement.textContent = totalFactibles;
  }
  
  // Mostrar notificaci√≥n
  const notif = document.createElement('div');
  notif.style.cssText = `
    position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
    background: #10b981; color: white; padding: 10px 20px;
    border-radius: 20px; z-index: 10000; font-weight: bold;
  `;
  notif.textContent = `Contadores actualizados: ${totalEnlaces} enlaces, ${totalFactibles} factibles`;
  document.body.appendChild(notif);
  setTimeout(() => notif.remove(), 3000);
}




function zoomToFit() {
  if (window.mapaEnlaces) {
    const enlaces = document.querySelectorAll('#tabla tbody tr');
    const bounds = L.latLngBounds();
    
    enlaces.forEach(fila => {
      const celdas = fila.querySelectorAll('td');
      const latA = parseFloat(celdas[3]?.textContent.replace(',', '.'));
      const lonA = parseFloat(celdas[4]?.textContent.replace(',', '.'));
      const latB = parseFloat(celdas[9]?.textContent.replace(',', '.'));
      const lonB = parseFloat(celdas[10]?.textContent.replace(',', '.'));
      
      if (!isNaN(latA) && !isNaN(lonA)) {
        bounds.extend([latA, lonA]);
      }
      if (!isNaN(latB) && !isNaN(lonB)) {
        bounds.extend([latB, lonB]);
      }
    });
    
    if (!bounds.isEmpty()) {
      window.mapaEnlaces.fitBounds(bounds, {padding: [50, 50]});
    }
  }
}



function cambiarEstiloMapa() {
  if (window.mapaEnlaces) {
    // Remover capa actual
    window.mapaEnlaces.eachLayer(layer => {
      if (layer instanceof L.TileLayer) {
        window.mapaEnlaces.removeLayer(layer);
      }
    });
    
    // Cambiar estilo
    currentStyle = (currentStyle + 1) % estilosMapa.length;
    
    // Agregar nueva capa
    L.tileLayer(estilosMapa[currentStyle], {
      attribution: '¬© OpenStreetMap contributors'
    }).addTo(window.mapaEnlaces);
    
    // Mostrar notificaci√≥n
    const notif = document.createElement('div');
    notif.style.cssText = `
      position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
      background: #00bcd4; color: white; padding: 10px 20px;
      border-radius: 20px; z-index: 10000; font-weight: bold;
    `;
    notif.textContent = `Estilo: ${nombresEstilos[currentStyle]}`;
    document.body.appendChild(notif);
    setTimeout(() => notif.remove(), 2000);
  }
}



function mostrarPanelDetalleEnlace(datos) {
  const panel = document.getElementById('panel-detalle-enlace');
  const contenido = document.getElementById('detalle-enlace-contenido');
  let analisisLista = '';
  try {
    const detalles = JSON.parse(datos.motivo);
    if (Array.isArray(detalles) && detalles.length > 0) {
      analisisLista = '<ul style="margin-top:6px;">' + detalles.map(det => `<li>${det}</li>`).join('') + '</ul>';
    } else {
      
    }
  } catch {
  }
contenido.innerHTML = `
  <h3 style="margin-top:0;">${datos.nombreA} ‚Üí ${datos.nombreB}</h3>
  <b>ID A:</b> ${datos.idA}<br>
  <b>Nombre A:</b> ${datos.nombreA}<br>
  <b>Latitud A:</b> ${datos.latA}<br>
  <b>Longitud A:</b> ${datos.lonA}<br>
  <b>Altura Torre A:</b> ${datos.alturaA}<br>
  <b>Tipo Torre A:</b> ${datos.TorreA}<br>
  <b>Estado A:</b> ${datos.EstadoA}<br>
  <hr>
  <b>ID B:</b> ${datos.idB}<br>
  <b>Nombre B:</b> ${datos.nombreB}<br>
  <b>Latitud B:</b> ${datos.latB}<br>
  <b>Longitud B:</b> ${datos.lonB}<br>
  <b>Altura Torre B:</b> ${datos.alturaB}<br>
  <b>Tipo Torre B:</b> ${datos.TorreB}<br>
  <b>Estado B:</b> ${datos.EstadoB}<br>
  <hr>
  <button id="btnPerfilFlotante" class="btn btn-info" style="margin-top:10px; float:right; min-width:unset; width:auto; padding:10px 18px;">
  <i class="fas fa-mountain"></i> Perfil Elevaci√≥n
  </button>
  ${analisisLista}
`;
  panel.style.display = 'block';
  window.ultimoDatosPanelDetalle = datos;
  setTimeout(() => {
  const btn = document.getElementById('btnPerfilFlotante');
  if (btn) {
    btn.onclick = function() {
      mostrarPerfilElevacionDesdeDatos(window.ultimoDatosPanelDetalle || {});
    };
  }
}, 100);
}
async function mostrarPerfilElevacionFlotante(datos) {
  const latA = parseFloat(datos['Latitud A'] || datos.latA);
  const lonA = parseFloat(datos['Longitud A'] || datos.lonA);
  const latB = parseFloat(datos['Latitud B'] || datos.latB);
  const lonB = parseFloat(datos['Longitud B'] || datos.lonB);
  const alturaA = parseFloat(datos['Altura Torre A'] || datos.alturaA) || 0;
  const alturaB = parseFloat(datos['Altura Torre B'] || datos.alturaB) || 0;
  const frecuenciaGHz = parseFloat(datos['Frecuencia'] || datos.frecuencia);
  if (
    isNaN(latA) || isNaN(lonA) || isNaN(latB) || isNaN(lonB) ||
    isNaN(alturaA) || isNaN(alturaB) || isNaN(frecuenciaGHz)
  ) {
    alert('Datos insuficientes para generar el perfil de elevaci√≥n.');
    return;
  }
  const numPuntos = 50;
  const locations = [];
  for (let i = 0; i < numPuntos; i++) {
    const lat = latA + (latB - latA) * (i / (numPuntos - 1));
    const lon = lonA + (lonB - lonA) * (i / (numPuntos - 1));
    locations.push(`${lat},${lon}`);
  }
  const locationsStr = locations.join('|');
  const url = `https://api.open-elevation.com/api/v1/lookup?locations=${locationsStr}`;
  try {
    const resp = await fetch(url);
    const data = await resp.json();
    if (!data.results || !data.results.length) {
      alert('No se pudo obtener el perfil de elevaci√≥n.');
      return;
    }
    const elevaciones = data.results.map(r => r.elevation);
    const distanciaKm = Math.sqrt(
      Math.pow(latA - latB, 2) + Math.pow(lonA - lonB, 2)
    ) * 111.32;
    const h1 = elevaciones[0] + alturaA;
    const h2 = elevaciones[elevaciones.length - 1] + alturaB;
    const lineaVista = elevaciones.map((_, i) =>
      h1 + (h2 - h1) * (i / (numPuntos - 1))
    );
    let fresnelSup = [], fresnelInf = [];
    for (let i = 0; i < numPuntos; i++) {
      const d1 = distanciaKm * 1000 * (i / (numPuntos - 1));
      const d2 = distanciaKm * 1000 - d1;
      const rFresnel = 17.32 * Math.sqrt((d1 * d2) / (frecuenciaGHz * distanciaKm * 1000));
      fresnelSup.push(lineaVista[i] + 0.6 * rFresnel);
      fresnelInf.push(lineaVista[i] - 0.6 * rFresnel);
    }
    const distancias = elevaciones.map((_, i) => +(distanciaKm * i / (numPuntos - 1)).toFixed(2));
    Plotly.newPlot('perfilElevacionModalPlotly', [
      {
        x: distancias,
        y: elevaciones,
        name: 'Terreno',
        type: 'scatter',
        mode: 'lines',
        fill: 'tozeroy',
        line: { color: '#764ba2', width: 3 }
      },
      {
        x: distancias,
        y: lineaVista,
        name: 'L√≠nea de Vista',
        type: 'scatter',
        mode: 'lines',
        line: { color: '#10b981', width: 2, dash: 'dash' }
      },
      {
        x: [...distancias, ...distancias.slice().reverse()],
        y: [...fresnelSup, ...fresnelInf.slice().reverse()],
        name: 'Zona Fresnel (60%)',
        type: 'scatter',
        mode: 'lines',
        fill: 'toself',
        fillcolor: 'rgba(245,158,66,0.18)',
        line: { color: '#f59e42', width: 1, dash: 'dot' },
        hoverinfo: 'skip',
        showlegend: true
      }
    ], {
      title: 'Perfil de Elevaci√≥n y Zona de Fresnel',
      xaxis: { title: 'Distancia (km)', zeroline: false },
      yaxis: { title: 'Altura (msnm)', zeroline: false },
      legend: { orientation: 'h', x: 0.5, xanchor: 'center', y: -0.2 },
      plot_bgcolor: '#fff',
      paper_bgcolor: '#fff',
      font: { color: '#222' },
      margin: { t: 60, l: 60, r: 30, b: 60 }
    }, {responsive: true});
    document.getElementById('modal-perfil-elevacion').style.display = 'flex';
  } catch (error) {
    alert('Error al consultar Open-Elevation.');
  }
}

if (document.getElementById('tab-resumen').classList.contains('active')) {
  mostrarMapaEnlaces(null);
}
function abrirPerfilElevacionEnNuevaVentana(datos) {
  const params = encodeURIComponent(JSON.stringify(datos));
  window.open(`perfil_elevacion.html?datos=${params}`, '_blank');
}
function actualizarBotonPerfilElevacionGlobal() {
  const fila = document.querySelector('#tabla tbody tr.selected');
  const btn = document.getElementById('btnPerfilElevacionGlobal');
  btn.style.display = fila ? 'inline-block' : 'none';
}
function guardarEnlacesEnStorageModo(modo) {
  if (modo === "mismo") {
    return;
  }
  const tabla = document.querySelector('#tabla tbody');
  const filas = tabla.querySelectorAll('tr');
  const enlaces = [];
  filas.forEach(fila => {
    const celdas = fila.querySelectorAll('td');
    const enlace = [];
    for (let i = 1; i < celdas.length; i++) {
      if (i === 33 && celdas[i].querySelector('button') && celdas[i].dataset.analisis) {
        enlace.push(celdas[i].dataset.analisis);
      } else {
        enlace.push(celdas[i].textContent);
      }
    }
    enlaces.push(enlace);
  });
  localStorage.setItem('enlacesPtP', JSON.stringify(enlaces));
}
function cargarEnlacesDeStorageModo(modo) {
  if (modo === "mismo") {
    mostrarTablaMismoTransporte();
    return;
  }
  const key = 'enlacesPtP';
  const enlacesGuardados = localStorage.getItem(key);
  if (!enlacesGuardados) return;
  const enlaces = JSON.parse(enlacesGuardados);
  const tbody = document.querySelector('#tabla tbody');
  tbody.innerHTML = '';
  enlaces.forEach(enlaceData => {
    const fila = document.createElement('tr');
    const tdCheck = document.createElement('td');
    const check = document.createElement('input');
    check.type = 'checkbox';
    check.className = 'check-enlace';
    check.onclick = function(e) {
      e.stopPropagation();
      actualizarBotonEliminarSeleccionados();
    };
    tdCheck.appendChild(check);
    fila.appendChild(tdCheck);
    enlaceData.forEach((val, i) => {
      const td = document.createElement('td');
      if (i === enlaceData.length - 1) {
        const btn = document.createElement('button');
        btn.className = 'btn btn-info btn-sm';
        btn.innerHTML = '<i class="fas fa-info-circle"></i> Ver An√°lisis';
        btn.onclick = function(e) {
          e.stopPropagation();
          try {
            const analisis = JSON.parse(val);
            mostrarAnalisisDetallado(analisis);
          } catch {
            alert('No hay an√°lisis detallado disponible.');
          }
        };
        td.appendChild(btn);
        td.dataset.analisis = val;
      } else {
        td.textContent = val;
      }
      fila.appendChild(td);
    });
    tbody.appendChild(fila);
  });
  actualizarContadorEnlaces();
  verificarEnlacesVacios();
}
function limpiarProcesamientoEmergencia() {
  console.log('üö® LIMPIEZA DE EMERGENCIA ACTIVADA');
  
  // Detener procesamiento
  window.procesamientoActivo = false;
  window.procesamientoCancelado = true;
  
  // Limpiar TODOS los timeouts
  for (let i = 1; i < 100000; i++) {
    clearTimeout(i);
    clearInterval(i);
  }
  
  // Limpiar timeout espec√≠fico
  if (window.timeoutProcesamiento) {
    clearTimeout(window.timeoutProcesamiento);
    window.timeoutProcesamiento = null;
  }
  
  // Limpiar intervalo de resumen
  if (window.intervaloResumen) {
    clearInterval(window.intervaloResumen);
    window.intervaloResumen = null;
  }
  
  console.log('‚úÖ Limpieza de emergencia completada');
}

// Hacer disponible globalmente
window.limpiarProcesamientoEmergencia = limpiarProcesamientoEmergencia;

function limpiezaManual() {
  console.log('ÔøΩÔøΩ INICIANDO LIMPIEZA MANUAL...');
  
  // Detener TODOS los intervalos
  for (let i = 1; i < 100000; i++) {
    clearInterval(i);
    clearTimeout(i);
  }
  
  // Detener intervalos espec√≠ficos
  if (window.intervaloResumen) {
    clearInterval(window.intervaloResumen);
    window.intervaloResumen = null;
  }
  
  if (window.intervaloActualizacion) {
    clearInterval(window.intervaloActualizacion);
    window.intervaloActualizacion = null;
  }
  
  // Limpiar variables
  window.procesamientoActivo = false;
  window.procesamientoCancelado = true;
  window.enlacesGuardadosRecientemente = true;
  
  console.log('‚úÖ LIMPIEZA MANUAL COMPLETADA');
}

// Hacer la funci√≥n disponible globalmente
window.limpiezaManual = limpiezaManual;
</script>
<div id="modal-analisis" style="display:none; position:fixed; z-index:9999; left:0; top:0; width:100vw; height:100vh; background:rgba(30,30,40,0.7); align-items:center; justify-content:center;">
  <div style="background:#fff; border-radius:18px; max-width:420px; width:90%; margin:auto; box-shadow:0 8px 32px rgba(0,0,0,0.25); padding:32px 24px 24px 24px; position:relative; animation:fadeInUp 0.3s;">
    <button onclick="cerrarModalAnalisis()" style="position:absolute; top:12px; right:16px; background:none; border:none; font-size:1.5rem; color:#888; cursor:pointer;"><i class="fas fa-times"></i></button>
    <div id="modal-analisis-icono" style="font-size:2.5rem; margin-bottom:10px;"></div>
    <div id="modal-analisis-titulo" style="font-size:1.3rem; font-weight:700; margin-bottom:10px;"></div>
    <div id="modal-analisis-resumen" style="font-size:1rem; margin-bottom:10px; color:#444;"></div>
    <ul id="modal-analisis-lista" style="padding-left:20px; margin-bottom:0; color:#333; font-size:0.98rem;"></ul>
    
  </div>
</div>
<div id="modal-parametros-radio" style="display:none; position:fixed; z-index:9999; left:0; top:0; width:100vw; height:100vh; background:rgba(30,30,40,0.7); align-items:center; justify-content:center;">
  <div style="background:#fff; border-radius:18px; max-width:420px; width:90%; margin:auto; box-shadow:0 8px 32px rgba(0,0,0,0.25); padding:32px 24px 24px 24px; position:relative;">
    <button onclick="cerrarPanelParametrosRadio()" style="position:absolute; top:12px; right:16px; background:none; border:none; font-size:1.5rem; color:#888; cursor:pointer;"><i class="fas fa-times"></i></button>
    <h3>Par√°metros de Radioenlace</h3>
    <div>
      <label>Potencia TX (dBm): <input type="number" id="potenciaTX" value="20"></label><br>
      <label>Ganancia Antena A (dBi): <input type="number" id="gananciaA" value="30"></label><br>
      <label>Ganancia Antena B (dBi): <input type="number" id="gananciaB" value="30"></label><br>
      <label>P√©rdidas (dB): <input type="number" id="perdidas" value="2"></label><br>
      <label>Frecuencia (GHz): <input type="number" id="frecuenciaRadio" value="15"></label><br>
      <label>Distancia (km): <input type="number" id="distanciaRadio" value="10"></label><br>
      <label>Margen de desvanecimiento (dB): <input type="number" id="fadeMargin" value="30"></label><br>
      <button class="btn btn-success" onclick="calcularParametrosRadio()">Calcular</button>
    </div>
    <div id="resultado-parametros-radio" style="margin-top:12px; color:#222;"></div>
  </div>
</div>
<div id="modal-equipos-antenas" style="display:none; position:fixed; z-index:9999; left:0; top:0; width:100vw; height:100vh; background:rgba(30,30,40,0.7); align-items:center; justify-content:center;">
  <div style="background:#fff; border-radius:18px; max-width:420px; width:90%; margin:auto; box-shadow:0 8px 32px rgba(0,0,0,0.25); padding:32px 24px 24px 24px; position:relative;">
    <button onclick="cerrarPanelEquiposAntenas()" style="position:absolute; top:12px; right:16px; background:none; border:none; font-size:1.5rem; color:#888; cursor:pointer;"><i class="fas fa-times"></i></button>
    <h3>Gesti√≥n de Equipos y Antenas</h3>
    <div>
      <label>Modelo Radio: <input type="text" id="modeloRadio" value="Ej: Ubiquiti AirFiber"></label><br>
      <label>Modelo Antena: <input type="text" id="modeloAntena" value="Ej: Dish 30dBi"></label><br>
      <label>Ganancia (dBi): <input type="number" id="gananciaAntena" value="30"></label><br>
      <button class="btn btn-success" onclick="guardarEquipoAntena()">Guardar</button>
    </div>
    <div id="lista-equipos-antenas" style="margin-top:12px; color:#222;"></div>
  </div>
</div>
<script>
if (localStorage.getItem('fangioSesion') === 'activa') {
  document.getElementById('logoutBtn').style.display = 'flex';
}
document.getElementById('logoutBtn').onclick = function() {
  localStorage.removeItem('fangioSesion');
  window.location.href = 'login.html';
};
document.getElementById('toggleThemeBtn').onclick = function() {
  document.body.classList.toggle('modo-claro');
  localStorage.setItem('fangioTema', document.body.classList.contains('modo-claro') ? 'claro' : 'oscuro');
};
if (localStorage.getItem('fangioTema') === 'claro') {
  document.body.classList.add('modo-claro');
}
</script>
<script>  
// Funciones para mostrar mensajes en el modal (sin alert())
function mostrarError(mensaje) {
  const progresoEstado = document.getElementById('progreso-estado');
  if (progresoEstado) {
    progresoEstado.innerHTML = `
      <div style="color: #ef4444; font-weight: 700; text-align: center; padding: 20px;">
        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 10px;"></i>
        <div>${mensaje}</div>
      </div>
    `;
  }
}

function mostrarAdvertencia(mensaje) {
  const progresoEstado = document.getElementById('progreso-estado');
  if (progresoEstado) {
    progresoEstado.innerHTML = `
      <div style="color: #f59e0b; font-weight: 700; text-align: center; padding: 20px;">
        <i class="fas fa-exclamation-circle" style="font-size: 2rem; margin-bottom: 10px;"></i>
        <div>${mensaje}</div>
      </div>
    `;
  }
}

function mostrarExito(mensaje) {
  const progresoEstado = document.getElementById('progreso-estado');
  if (progresoEstado) {
    progresoEstado.innerHTML = `
      <div style="color: #10b981; font-weight: 700; text-align: center; padding: 20px;">
        <i class="fas fa-check-circle" style="font-size: 2rem; margin-bottom: 10px;"></i>
        <div>${mensaje}</div>
      </div>
    `;
  }
}
  let modalProgreso = null;
let procesamientoActivo = false;
let procesamientoPausado = false;
let tiempoInicio = null;
let intervaloActualizacion = null;


function procesarLote() {
  console.log('Entrando a procesarLote, procesamientoActivo:', window.procesamientoActivo);
  // VERIFICAR SI EL PROCESAMIENTO EST√Å ACTIVO Y NO COMPLETADO
  if (!window.procesamientoActivo || window.procesamientoCancelado || procesamientoCompletado) {
    console.log('üõë FUNCI√ìN BLOQUEADA - Procesamiento no activo, cancelado o ya completado');
    return;
  }
  const start = index;
  const end = Math.min(index + batchSize, dataPares.length);
  console.log(`üîÑ Procesando lote: ${start} a ${end} de ${dataPares.length} (√≠ndice actual: ${index})`);
  // Actualizar progreso del lote
  const progresoLote = document.getElementById('progreso-lote');
  if (progresoLote) {
    progresoLote.textContent = `${start + 1}-${end} / ${dataPares.length}`;
}

// Llamar a procesarLote() despu√©s de inicializar y verificar datos
if (dataExcel.length && dataPares.length) {
  procesarLote();
}
    
    // Procesar pares del lote actual
    for (let i = start; i < end; i++) {
      // Verificar si el procesamiento sigue activo o cancelado en cada iteraci√≥n
      if (!window.procesamientoActivo || window.procesamientoCancelado || procesamientoCompletado) {
        console.log('üõë FUNCI√ìN BLOQUEADA - Procesamiento no activo, cancelado o ya completado (dentro del ciclo)');
        return;
      }
      
      const par = dataPares[i];
      const idA = par[0]?.toString().trim().toUpperCase();
      const idB = par[1]?.toString().trim().toUpperCase();
      
      if (!idA || !idB) {
        window.omitidos++;
        continue;
      }
      
      const datosTorreA = mapaTorres[idA] || [];
      const datosTorreB = mapaTorres[idB] || [];
      
      if (datosTorreA.length === 0 || datosTorreB.length === 0) {
        window.faltantes.push([
          idA, idB,
          datosTorreA.length === 0 ? 'FALTA A' : '',
          datosTorreB.length === 0 ? 'FALTA B' : ''
        ]);
        continue;
      }
      
      // Llenar formulario con datos de las torres
      document.getElementById('idA').value = idA;
      document.getElementById('nombreA').value = datosTorreA[3] || '';
      document.getElementById('latA').value = datosTorreA[11] || '';
      document.getElementById('lonA').value = datosTorreA[12] || '';
      document.getElementById('alturaA').value = datosTorreA[51] || '';
      document.getElementById('ranA').value = datosTorreA[52] || '';
      document.getElementById('TransA').value = datosTorreA[103] || '';
      document.getElementById('ArreA').value = datosTorreA[4] || '';
      document.getElementById('OnA').value = datosTorreA[102] || '';
      document.getElementById('TorreA').value = datosTorreA[21] || '';
      document.getElementById('EstadoA').value = datosTorreA[13] || '';
      
      document.getElementById('idB').value = idB;
      document.getElementById('nombreB').value = datosTorreB[3] || '';
      document.getElementById('latB').value = datosTorreB[11] || '';
      document.getElementById('lonB').value = datosTorreB[12] || '';
      document.getElementById('alturaB').value = datosTorreB[51] || '';
      document.getElementById('ranB').value = datosTorreB[52] || '';
      document.getElementById('TransB').value = datosTorreB[103] || '';
      document.getElementById('ArreB').value = datosTorreB[4] || '';
      document.getElementById('OnB').value = datosTorreB[102] || '';
      document.getElementById('TorreB').value = datosTorreB[21] || '';
      document.getElementById('EstadoB').value = datosTorreB[13] || '';
      
      actualizarCalculos();
      
      const get = id => document.getElementById(id).value.trim();
      const latA = parseFloat(get('latA'));
      const lonA = parseFloat(get('lonA'));
      const latB = parseFloat(get('latB'));
      const lonB = parseFloat(get('lonB'));
      
      if (!get('idA') || !get('idB')) continue;
      if (isNaN(latA) || isNaN(lonA) || isNaN(latB) || isNaN(lonB)) continue;
      
      const distanciaKm = calcularDistancia(latA, lonA, latB, lonB);
      const frecuencia = asignarFrecuencia(distanciaKm);
      
      const factibilidad = analizarFactibilidad(
        distanciaKm,
        get('ArreA'),
        get('ArreB'),
        get('TransA'),
        get('TransB'),
        get('TorreA'),
        get('TorreB'),
        get('OnA'),
        get('OnB'),
        true // esFactibleLOS
      );
      console.log('üîç factibilidad en procesarPares:', factibilidad); // ‚úÖ AGREGAR ESTA L√çNEA
      console.log('üì° diametroAntena en procesarPares:', factibilidad.diametroAntena); // ‚úÖ AGREGAR ESTA L√çNEA

      
      const estadoFactible = (factibilidad.advertencia)
        ? 'FACTIBLE (Requiere an√°lisis)'
        : (factibilidad.razon && factibilidad.razon.toUpperCase().includes('NO DISPONIBLE'))
          ? 'NO DISPONIBLE'
          : (factibilidad.factible ? 'S√ç' : 'NO');
      
      const filaDatos = [
        get('idA'), get('nombreA'), get('latA'), get('lonA'),
        document.getElementById('latArad').value,
        document.getElementById('lonArad').value,
        get('idB'), get('nombreB'), get('latB'), get('lonB'),
        document.getElementById('latBrad').value,
        document.getElementById('lonBrad').value,
        distanciaKm.toFixed(6), frecuencia,
        document.getElementById('disponibilidadAnual').value,
        get('alturaA'), get('alturaB'), get('ranA'), get('ranB'),
        get('TransA'), get('TransB'), get('ArreA'), get('ArreB'),
        get('OnA'), get('OnB'), get('TorreA'), get('TorreB'),
        get('EstadoA'), get('EstadoB'),
        estadoFactible,
        factibilidad.diametroAntena,
        factibilidad.tipoEnlace,
        JSON.stringify(factibilidad)
      ];
      
      const transA = get('TransA').toLowerCase();
      const transB = get('TransB').toLowerCase();
      
      if (transA && transB && transA === transB) {
        window.filasMismoTransporte.push(filaDatos);
      } else {
        window.filasDiferenteTransporte.push(filaDatos);
      }
      
      window.procesados++;
      actualizarResumenEnlaces();
      
      // Actualizar progreso en tiempo real
      const porcentaje = Math.round((window.procesados / dataPares.length) * 100);
      const barraProgreso = document.getElementById('barra-progreso');
      const porcentajeTexto = document.getElementById('porcentaje-progreso');
      const procesadosTexto = document.getElementById('pares-procesados');
      const restantesTexto = document.getElementById('pares-restantes');
      
      if (barraProgreso) barraProgreso.style.width = porcentaje + '%';
      if (porcentajeTexto) porcentajeTexto.textContent = porcentaje + '%';
      if (procesadosTexto) procesadosTexto.textContent = window.procesados.toLocaleString();
      if (restantesTexto) restantesTexto.textContent = (dataPares.length - window.procesados).toLocaleString();
      
      // Actualizar velocidad y tiempo
      const elapsed = Math.floor((Date.now() - startTime) / 1000);
      if (elapsed > 0) {
        const velocidad = window.procesados / (elapsed / 60);
        const tiempoRestante = Math.floor((dataPares.length - window.procesados) / velocidad * 60);
        
        const tiempoTranscurrido = document.getElementById('tiempo-transcurrido');
        const tiempoRestanteEl = document.getElementById('tiempo-restante');
        const velocidadEl = document.getElementById('velocidad-procesamiento');
        
        if (tiempoTranscurrido) tiempoTranscurrido.textContent = `${Math.floor(elapsed/60)}:${(elapsed%60).toString().padStart(2,'0')}`;
        if (tiempoRestanteEl) tiempoRestanteEl.textContent = `${Math.floor(tiempoRestante/60)}:${(tiempoRestante%60).toString().padStart(2,'0')}`;
        if (velocidadEl) velocidadEl.textContent = `${Math.round(velocidad)} pares/min`;
      }
    }
    
    // Actualizar √≠ndice para el siguiente lote
    index = end;
    
    console.log(`‚úÖ Lote completado. √çndice actualizado a: ${index}, Total procesados: ${window.procesados}`);
    actualizarResumenEnlaces();
    
    // VERIFICAR SI HAY M√ÅS PARES PARA PROCESAR
if (index < dataPares.length && window.procesamientoActivo && !window.procesamientoCancelado && !procesamientoCompletado) {
  console.log(`üîÑ Continuando con siguiente lote...`);
  window.timeoutProcesamiento = setTimeout(() => {
    if (window.procesamientoActivo && !window.procesamientoCancelado && !procesamientoCompletado && index < dataPares.length) {
      procesarLote();
    } else {
      window.procesamientoActivo = false;
      window.procesamientoCompletado = true;
      window.procesamientoCancelado = true;
      if (window.timeoutProcesamiento) {
        clearTimeout(window.timeoutProcesamiento);
        window.timeoutProcesamiento = null;
      }
      for (let i = 1; i < 100000; i++) {
        clearTimeout(i);
        clearInterval(i);
      }
      completarProcesamiento();
    }
  }, 50);
} else {
  // Procesamiento completado - detener completamente
  console.log(`üéâ ¬°PROCESAMIENTO COMPLETADO! Total procesados: ${window.procesados}, Total omitidos: ${window.omitidos}`);
  window.procesamientoActivo = false;
  window.procesamientoCompletado = true;
  window.procesamientoCancelado = true;
  if (window.timeoutProcesamiento) {
    clearTimeout(window.timeoutProcesamiento);
    window.timeoutProcesamiento = null;
  }
  for (let i = 1; i < 100000; i++) {
    clearTimeout(i);
    clearInterval(i);
  }
  completarProcesamiento();
  return;
}
}



// Procesar par individual
async function procesarParIndividual(par) {
  // Simular trabajo de procesamiento
  const tiempoProcesamiento = Math.random() * 50 + 10;
  await delay(tiempoProcesamiento);
  
  // Simular √©xito/error ocasional
  if (Math.random() < 0.02) { // 2% de error
    throw new Error('Error de conexi√≥n');
  }
  
  return { ...par, procesado: true };
}

// Actualizar progreso
function actualizarProgreso(procesados, total, errores) {
  const porcentaje = Math.round((procesados / total) * 100);
  const restantes = total - procesados;
  
  // Actualizar valores principales
  document.getElementById('pares-procesados').textContent = procesados.toLocaleString();
  document.getElementById('pares-restantes').textContent = restantes.toLocaleString();
  document.getElementById('progreso-porcentaje').textContent = `${porcentaje}%`;
  document.getElementById('progreso-fill').style.width = `${porcentaje}%`;
  document.getElementById('errores-procesamiento').textContent = errores;
  
  // Actualizar estado
  if (porcentaje === 100) {
    document.getElementById('progreso-estado').textContent = '¬°Completado!';
  } else if (procesamientoPausado) {
    document.getElementById('progreso-estado').textContent = 'Pausado';
  } else {
    document.getElementById('progreso-estado').textContent = 'Procesando...';
  }
  
  // Actualizar progreso del lote
  const progresoLote = procesados % 100;
  const porcentajeLote = Math.round((progresoLote / 100) * 100);
  document.getElementById('lote-fill').style.width = `${porcentajeLote}%`;
}

// Iniciar actualizaciones en tiempo real
function iniciarActualizaciones() {
  intervaloActualizacion = setInterval(() => {
    if (tiempoInicio && procesamientoActivo) {
      actualizarTiempos();
      actualizarVelocidad();
    }
  }, 1000);
}

// Detener actualizaciones
function detenerActualizaciones() {
  if (intervaloActualizacion) {
    clearInterval(intervaloActualizacion);
    intervaloActualizacion = null;
  }
}

// Actualizar tiempos
function actualizarTiempos() {
  const ahora = Date.now();
  const transcurrido = ahora - tiempoInicio;
  
  // Tiempo transcurrido
  const minutosTrans = Math.floor(transcurrido / 60000);
  const segundosTrans = Math.floor((transcurrido % 60000) / 1000);
  document.getElementById('tiempo-transcurrido').textContent = 
    `${minutosTrans.toString().padStart(2, '0')}:${segundosTrans.toString().padStart(2, '0')}`;
  
  // Calcular tiempo restante
  const paresProcesados = parseInt(document.getElementById('pares-procesados').textContent.replace(/,/g, ''));
  const totalPares = parseInt(document.getElementById('total-pares').textContent.replace(/,/g, ''));
  
  if (paresProcesados > 0) {
    const tiempoPromedioPorPar = transcurrido / paresProcesados;
    const paresRestantes = totalPares - paresProcesados;
    const tiempoRestante = tiempoPromedioPorPar * paresRestantes;
    
    const minutosRest = Math.floor(tiempoRestante / 60000);
    const segundosRest = Math.floor((tiempoRestante % 60000) / 1000);
    document.getElementById('tiempo-restante').textContent = 
      `${minutosRest.toString().padStart(2, '0')}:${segundosRest.toString().padStart(2, '0')}`;
  }
}

// Actualizar velocidad
function actualizarVelocidad() {
  const paresProcesados = parseInt(document.getElementById('pares-procesados').textContent.replace(/,/g, ''));
  const transcurrido = (Date.now() - tiempoInicio) / 1000; // segundos
  
  if (transcurrido > 0) {
    const velocidad = Math.round(paresProcesados / transcurrido);
    document.getElementById('velocidad-procesamiento').textContent = `${velocidad} pares/s`;
  }
}

// Pausar procesamiento
function pausarProcesamiento() {
  if (procesamientoActivo && !procesamientoPausado) {
    procesamientoPausado = true;
    document.getElementById('btn-pausar-procesamiento').innerHTML = '<i class="fas fa-play"></i> Reanudar';
    agregarLog('Procesamiento pausado', 'warning');
  } else if (procesamientoActivo && procesamientoPausado) {
    procesamientoPausado = false;
    document.getElementById('btn-pausar-procesamiento').innerHTML = '<i class="fas fa-pause"></i> Pausar';
    agregarLog('Procesamiento reanudado', 'success');
  }
}

// Cancelar procesamiento
function cancelarProcesamiento() {
  procesamientoActivo = false;
  procesamientoPausado = false;
  detenerActualizaciones();
  if (window.timeoutProcesamiento) {
    clearTimeout(window.timeoutProcesamiento);
    window.timeoutProcesamiento = null;
  }
  agregarLog('Procesamiento cancelado por el usuario', 'error');
  mostrarBotonesIniciales();
}

// Completar procesamiento
function completarProcesamiento() {
  console.log('üöÄ Iniciando completarProcesamiento...');
  
  // DETENER EL PROCESAMIENTO INMEDIATAMENTE
  window.procesamientoActivo = false;
  window.procesamientoCancelado = true;
  window.intervaloResumen = null;
  if (window.intervaloResumen) {
    clearInterval(window.intervaloResumen);
    window.intervaloResumen = null;
    console.log('üõë Intervalo de resumen detenido');
  }
  
  console.log('üìä Total procesados:', window.procesados);
console.log('‚ùå Total omitidos:', window.omitidos);
console.log('‚ö†Ô∏è Total faltantes:', window.faltantes.length);
console.log(`üö´ Total pares no procesados: ${window.paresNoProcesados}`); // ‚úÖ CORRECTO  
  // Guardar enlaces seg√∫n configuraci√≥n (SOLO UNA VEZ)
  // ‚úÖ CORREGIR: Guardar TODOS los enlaces procesados
const todosLosEnlaces = window.filasDiferenteTransporte.concat(window.filasMismoTransporte);
localStorage.setItem('enlacesPtP', JSON.stringify(todosLosEnlaces));
console.log(`üíæ Enlaces guardados en enlacesPtP: ${todosLosEnlaces.length}`);
console.log(`ÔøΩÔøΩ Desglose: ${window.filasDiferenteTransporte.length} diferente transporte + ${window.filasMismoTransporte.length} mismo transporte`);
  
  // Mostrar mensaje de √©xito en el modal
  const progresoEstado = document.getElementById('progreso-estado');
  if (progresoEstado) {
    progresoEstado.innerHTML = `
      <div style="color: #10b981; font-weight: 700; text-align: center; padding: 20px;">
        <i class="fas fa-check-circle" style="font-size: 2rem; margin-bottom: 10px;"></i>
        <div>‚úÖ Procesamiento completado exitosamente</div>
        <div style="font-size: 0.9rem; margin-top: 8px; color: #6b7280;">
          ${window.procesados} enlaces procesados de ${dataPares.length} pares totales
          ${window.omitidos > 0 ? `<br>‚ùå Omitidos por IDs vac√≠os: ${window.omitidos}` : ''}
        </div>
      </div>
    `;
  }
  
  // Cerrar modal autom√°ticamente despu√©s de 3 segundos
  setTimeout(() => {
    console.log('üîí Cerrando modal...');
    if (document.getElementById('modal-progreso-masivo')) {
      document.getElementById('modal-progreso-masivo').remove();
    }
    
    // Mostrar tabla correspondiente
    if (window.permitirMismoTransporte) {
      mostrarPestana('mismoTransporte');
      if (typeof mostrarTablaMismoTransporte === 'function') {
        mostrarTablaMismoTransporte();
      }
    } else {
      mostrarPestana('enlaces');
      if (typeof cargarEnlacesDeStorage === 'function') {
        cargarEnlacesDeStorage();
      }
    }
    
    // Mostrar bot√≥n de descarga si hay faltantes
    if (window.faltantes && window.faltantes.length > 0) {
      const btnDescargar = document.getElementById('btnDescargarFaltantes');
      if (btnDescargar) {
        btnDescargar.style.display = 'inline-block';
        window.paresFaltantes = window.faltantes;
      }

    }
    
    console.log('‚úÖ Procesamiento finalizado completamente');
  }, 3000);
}

// Mostrar resumen final
function mostrarResumenFinal() {
  const paresProcesados = document.getElementById('pares-procesados').textContent;
  const errores = document.getElementById('errores-procesamiento').textContent;
  const tiempoTotal = document.getElementById('tiempo-transcurrido').textContent;
  
  const resumen = `
    <div class="resumen-final">
      <h3>ÔøΩÔøΩ ¬°Procesamiento Completado!</h3>
      <div class="resumen-stats">
        <div class="stat-item">
          <span class="stat-label">Total Procesado:</span>
          <span class="stat-value">${paresProcesados}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Errores:</span>
          <span class="stat-value">${errores}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Tiempo Total:</span>
          <span class="stat-value">${tiempoTotal}</span>
        </div>
      </div>
    </div>
  `;
  
  // Insertar resumen en el log
  const logContainer = document.getElementById('log-container');
  const resumenDiv = document.createElement('div');
  resumenDiv.innerHTML = resumen;
  logContainer.appendChild(resumenDiv);
  
  // Scroll al final
  logContainer.scrollTop = logContainer.scrollHeight;
}

// Agregar entrada al log
function agregarLog(mensaje, tipo = 'info') {
  const logContainer = document.getElementById('log-container');
  const ahora = new Date();
  const tiempo = ahora.toLocaleTimeString();
  
  const logItem = document.createElement('div');
  logItem.className = `log-item log-${tipo}`;
  logItem.innerHTML = `
    <span class="log-time">${tiempo}</span>
    <span class="log-message">${mensaje}</span>
  `;
  
  logContainer.appendChild(logItem);
  
  // Mantener solo los √∫ltimos 50 logs
  while (logContainer.children.length > 50) {
    logContainer.removeChild(logContainer.firstChild);
  }
  
  // Scroll al final
  logContainer.scrollTop = logContainer.scrollHeight;
}

// Funci√≥n de delay
function delay(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

// Bot√≥n para abrir el modal (agregar al dashboard)
function agregarBotonProcesamientoMasivo() {
  const boton = document.createElement('button');
  boton.className = 'btn btn-success btn-lg';
  boton.onclick = mostrarModalProgreso;
  
  // Agregar al dashboard
  const dashboard = document.querySelector('.microwave-feasibility-dashboard');
  if (dashboard) {
    dashboard.insertBefore(boton, dashboard.firstChild);
  }
}


document.addEventListener('DOMContentLoaded', function() {
  console.log(' DOMContentLoaded - Inicializando...');
  
  // ‚úÖ PRIMERO inicializar IndexedDB
  inicializarIndexedDB();
  
  // ‚úÖ DESPU√âS cargar enlaces inmediatamente
  cargarEnlacesDeStorage();
  actualizarContadorEnlaces();
  verificarEnlacesVacios();
  inicializarBotonMismoTransporte();
  
  // ‚úÖ AGREGAR EVENT LISTENERS PARA LOS BOTONES
  const btnProcesarPares = document.getElementById('btn-procesar-pares');
  const btnBorrarPares = document.getElementById('borrar-archivo-pares');
  
  if (btnProcesarPares) {
    btnProcesarPares.addEventListener('click', function() {
      console.log(' Procesando pares...');
      if (typeof window.procesarPares === 'function') {
        window.procesarPares();
      } else {
        console.error('La funci√≥n procesarPares no est√° disponible');
        alert('Error: La funci√≥n de procesamiento no est√° disponible. Por favor, recarga la p√°gina.');
      }
    });
  }
  
  if (btnBorrarPares) {
    btnBorrarPares.addEventListener('click', function() {
      console.log(' Borrando archivo de pares...');
      localStorage.removeItem('archivoParesInfo');
      localStorage.removeItem('enlacesPtP');
      document.getElementById('archivo-pares-cargado').style.display = 'none';
      document.getElementById('inputFilePairs').style.display = 'block';
      dataPares = [];
      console.log('‚úÖ Archivo de pares eliminado');
    });
  }
});



// ÔøΩÔøΩ FUNCI√ìN PARA LIMPIAR INDEXEDDB CORRUPTO
function limpiarIndexedDB() {
  console.log('Limpiando IndexedDB corrupto...');
  
  // Cerrar todas las conexiones existentes
  if (window.indexedDB) {
    // Eliminar la base de datos existente
    const deleteRequest = indexedDB.deleteDatabase('ArchivosExcelDB');
    
    deleteRequest.onsuccess = function() {
      console.log('Base de datos eliminada exitosamente');
      // Recargar la p√°gina para recrear la base de datos
      setTimeout(() => {
        location.reload();
      }, 1000);
    };
    
    deleteRequest.onerror = function() {
      console.log('Error al eliminar base de datos:', deleteRequest.error);
      // Forzar recarga de p√°gina
      location.reload();
    };
  } else {
    // Si no hay IndexedDB, solo recargar
    location.reload();
  }
}

// üî• FUNCI√ìN MEJORADA PARA CARGAR ARCHIVO DE PARES
function cargarArchivoParesDeStorage() {
  const archivoInfo = localStorage.getItem('archivoParesInfo');
  if (archivoInfo) {
    try {
      const info = JSON.parse(archivoInfo);
      
      // Intentar cargar desde IndexedDB
      cargarArchivoParesDeIndexedDB(info.nombre, function(arrayBuffer, infoGuardada) {
        if (arrayBuffer) {
          try {
            const data = new Uint8Array(arrayBuffer);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            dataPares = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            
            const contenedor = document.getElementById('archivo-pares-cargado');
            const nombreArchivo = document.getElementById('nombre-archivo-pares');
            const infoArchivo = document.getElementById('info-archivo-pares');
            
            if (contenedor && nombreArchivo && infoArchivo) {
              nombreArchivo.textContent = infoGuardada.nombre;
              infoArchivo.textContent = `${infoGuardada.filas} filas ‚Ä¢ ${(infoGuardada.tama√±o / 1024).toFixed(1)} KB ‚Ä¢ Cargado: ${new Date(infoGuardada.fechaCarga).toLocaleString()}`;
              contenedor.style.display = 'block';
              document.getElementById('inputFilePairs').style.display = 'none';
            }
            
            console.log('Archivo de pares cargado exitosamente desde IndexedDB');
          } catch (error) {
            console.error('Error al procesar archivo de pares:', error);
            // Si falla, limpiar IndexedDB
            limpiarIndexedDB();
          }
        } else {
          console.log('No se encontr√≥ archivo en IndexedDB, limpiando...');
          limpiarIndexedDB();
        }
      });
    } catch (error) {
      console.error('Error al cargar archivo de pares desde storage:', error);
      // Si falla, limpiar IndexedDB
      limpiarIndexedDB();
    }
  }
}

// üî• FUNCI√ìN MEJORADA PARA GUARDAR EN INDEXEDDB

function limpiarTodosLosIntervalos() {
  if (window.intervaloResumen) {
    clearInterval(window.intervaloResumen);
    window.intervaloResumen = null;
    console.log('üõë Intervalo de resumen detenido');
  }
  
  // Detener cualquier otro intervalo que pueda estar ejecut√°ndose
  for (let i = 1; i < 1000; i++) {
    clearInterval(i);
  }
  
  console.log('ÔøΩÔøΩ Todos los intervalos limpiados');
}
// ‚úÖ FUNCI√ìN PARA ABRIR STREET VIEW
function abrirStreetView(lat, lng) {
  console.log('üöÄ Abriendo Street View para:', lat, lng);
  
  const modal = document.getElementById('modalStreetView');
  if (modal) {
    modal.style.display = 'block';
    
    // Inicializar Street View despu√©s de mostrar el modal
    setTimeout(() => {
      inicializarStreetView(lat, lng, modal);
    }, 100);
    
    console.log('‚úÖ Modal de Street View abierto');
  } else {
    console.error('‚ùå No se encontr√≥ el modal de Street View');
  }
}

// ‚úÖ FUNCI√ìN PARA CERRAR STREET VIEW
function cerrarStreetView() {
  console.log('üö™ Cerrando Street View...');
  
  const modal = document.getElementById('modalStreetView');
  if (modal) {
    modal.style.display = 'none';
    
    // Limpiar Street View
    if (window.currentStreetView) {
      window.currentStreetView = null;
    }
    
    // Remover monito del mapa
    if (window.monitoStreetView) {
      window.monitoStreetView.remove();
      window.monitoStreetView = null;
      console.log('‚úÖ Monito removido del mapa');
    }
    
    console.log('‚úÖ Modal de Street View cerrado');
  }
}
// ‚úÖ FUNCI√ìN PARA AGREGAR MONITO AL MAPA PRINCIPAL
function agregarMonitoAlMapa() {
  console.log('üö∂‚Äç‚ôÇÔ∏è Agregando monito al mapa principal...');
  
  // Verificar que el mapa est√© disponible
  if (!window.mapaEnlaces) {
    console.error('‚ùå No se encontr√≥ el mapa principal');
    return;
  }
  
  // Coordenadas centrales de M√©xico (puedes cambiarlas)
  const latCentral = 23.6345;
  const lngCentral = -102.5528;
  
  // Remover monito anterior si existe
  if (window.monitoStreetView) {
    window.monitoStreetView.remove();
  }
  
  // Crear icono del monito
  const monitoIcon = L.divIcon({
    html: '<div class="monito-streetview">üö∂‚Äç‚ôÇÔ∏è</div>',
    className: 'monito-streetview-container',
    iconSize: [30, 30],
    iconAnchor: [15, 15]
  });
  
  // Crear el monito
  window.monitoStreetView = L.marker([latCentral, lngCentral], {
    icon: monitoIcon,
    draggable: true,
    title: 'Arrastra para abrir Street View',
    zIndexOffset: 1000
  }).addTo(window.mapaEnlaces);
  
  console.log('‚úÖ Monito agregado al mapa:', window.monitoStreetView);
  
  // ‚úÖ EVENTOS DEL MONITO
  window.monitoStreetView.on('dragstart', function(e) {
    console.log('üö∂‚Äç‚ôÇÔ∏è Iniciando arrastre del monito...');
    const element = this.getElement();
    if (element) element.style.opacity = '0.7';
  });
  
  window.monitoStreetView.on('drag', function(e) {
    const pos = e.latlng;
    console.log('ÔøΩÔøΩ‚Äç‚ôÇÔ∏è Arrastrando monito a:', pos.lat, pos.lng);
    mostrarCoordenadasTiempoReal(pos.lat, pos.lng);
  });
  
  window.monitoStreetView.on('dragend', function(e) {
    const newPos = e.target.getLatLng();
    console.log('ÔøΩÔøΩ‚Äç‚ôÇÔ∏è Monito movido a:', newPos.lat, newPos.lng);
    
    // ‚úÖ MOSTRAR NOTIFICACI√ìN
    mostrarNotificacion(`Monito movido a: ${newPos.lat.toFixed(6)}, ${newPos.lng.toFixed(6)}`);
    
    // ‚úÖ RESTAURAR OPACIDAD
    const element = this.getElement();
    if (element) element.style.opacity = '1';
    
    // ‚úÖ PREGUNTAR SI QUIERE ABRIR STREET VIEW
    if (confirm(`¬øQuieres abrir Street View en esta ubicaci√≥n?\nLat: ${newPos.lat.toFixed(6)}\nLng: ${newPos.lng.toFixed(6)}`)) {
      abrirStreetViewEnPosicion(newPos.lat, newPos.lng);
    }
  });
  
  // ‚úÖ EVENTO CLICK PARA ABRIR STREET VIEW
  window.monitoStreetView.on('click', function(e) {
    const pos = e.latlng;
    console.log('ÔøΩÔøΩ‚Äç‚ôÇÔ∏è Click en monito:', pos.lat, pos.lng);
    
    if (confirm(`¬øAbrir Street View en esta ubicaci√≥n?\nLat: ${pos.lat.toFixed(6)}\nLng: ${pos.lng.toFixed(6)}`)) {
      abrirStreetViewEnPosicion(pos.lat, pos.lng);
    }
  });
  
  // ‚úÖ HACER EL MONITO M√ÅS VISIBLE
  setTimeout(() => {
    if (window.monitoStreetView) {
      const element = window.monitoStreetView.getElement();
      if (element) {
        element.style.filter = 'drop-shadow(0 0 10px rgba(0,255,0,0.8))';
        console.log('‚úÖ Monito resaltado para mejor visibilidad');
      }
    }
  }, 100);
  
  return window.monitoStreetView;
}
// ‚úÖ FUNCI√ìN PARA ABRIR STREET VIEW EN POSICI√ìN
function abrirStreetViewEnPosicion(lat, lng) {
  console.log('üåç Abriendo Street View en:', lat, lng);
  
  // Crear modal temporal
  const modal = document.createElement('div');
  modal.className = 'modal-streetview-temp';
  modal.innerHTML = `
    <div class="modal-content">
      <div class="modal-header">
        <h3><i class="fas fa-street-view"></i> Street View</h3>
        <button class="close-btn" onclick="this.closest('.modal-streetview-temp').remove()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="streetview-panorama"></div>
    </div>
  `;
  
  // Agregar al body
  document.body.appendChild(modal);
  
  // Mostrar modal
  modal.style.display = 'block';
  
  // Inicializar Street View
  setTimeout(() => {
    inicializarStreetView(lat, lng, modal);
  }, 100);
}
// ‚úÖ FUNCI√ìN MEJORADA CON STREET VIEW
function activarMonitoEnMapa() {
  console.log('üöÄ Activando monito con Street View...');
  
  // Verificar que el mapa est√© disponible
  if (!window.mapaEnlaces) {
    console.error('‚ùå No se encontr√≥ el mapa principal');
    alert('‚ùå Error: No se encontr√≥ el mapa principal');
    return;
  }
  
  // Remover monito anterior si existe
  if (window.monitoStreetView) {
    console.log('Ô∏è Removiendo monito anterior...');
    window.monitoStreetView.remove();
    window.monitoStreetView = null;
  }
  
  // Coordenadas centrales de M√©xico (m√°s visibles)
  const latCentral = 19.4326;  // CDMX
  const lngCentral = -99.1332;
  
  console.log('üìç Creando monito en:', latCentral, lngCentral);
  
  // Crear icono del monito
  const monitoIcon = L.divIcon({
    html: '<div class="monito-streetview">üö∂‚Äç‚ôÇÔ∏è</div>',
    className: 'monito-streetview-container',
    iconSize: [40, 40],
    iconAnchor: [20, 20]
  });
  
  // Crear el monito
  window.monitoStreetView = L.marker([latCentral, lngCentral], {
    icon: monitoIcon,
    draggable: true,
    title: 'Arrastra para abrir Street View en esta ubicaci√≥n',
    zIndexOffset: 9999
  });
  
  // ‚úÖ AGREGAR AL MAPA
  window.monitoStreetView.addTo(window.mapaEnlaces);
  
  console.log('‚úÖ Monito agregado al mapa:', window.monitoStreetView);
  
  // ‚úÖ CENTRAR EL MAPA EN EL MONITO
  window.mapaEnlaces.setView([latCentral, lngCentral], 8);
  
  // ‚úÖ EVENTOS DEL MONITO
  window.monitoStreetView.on('dragstart', function(e) {
    console.log('üö∂‚Äç‚ôÇÔ∏è Iniciando arrastre del monito...');
    const element = this.getElement();
    if (element) {
      element.style.opacity = '0.7';
      element.style.transform = 'scale(1.2)';
    }
  });
  
  window.monitoStreetView.on('drag', function(e) {
    const pos = e.latlng;
    console.log('‚Äç‚ôÇÔ∏è Arrastrando monito a:', pos.lat, pos.lng);
    
    // ‚úÖ CAMBIAR COLOR A AZUL MIENTRAS SE ARRASTRA
    const element = this.getElement();
    if (element) {
      element.style.filter = 'hue-rotate(200deg) brightness(1.2)';
      element.style.transform = 'scale(1.1)';
    }
  });
  
  window.monitoStreetView.on('dragend', function(e) {
    const newPos = e.target.getLatLng();
    console.log('‚Äç‚ôÇÔ∏è Monito movido a:', newPos.lat, newPos.lng);
    
    // ‚úÖ RESTAURAR COLOR ORIGINAL
    const element = this.getElement();
    if (element) {
      element.style.filter = 'none';
      element.style.transform = 'scale(1)';
      element.style.opacity = '1';
    }
    
    // ‚úÖ ABRIR STREET VIEW AUTOM√ÅTICAMENTE
    mostrarNotificacion(`üåç Abriendo Street View en: ${newPos.lat.toFixed(6)}, ${newPos.lng.toFixed(6)}`);
    
    // ‚úÖ ABRIR STREET VIEW
    setTimeout(() => {
      abrirStreetViewCompleto(newPos.lat, newPos.lng);
    }, 500);
  });
  
  // ‚úÖ EVENTO CLICK PARA ABRIR STREET VIEW
  window.monitoStreetView.on('click', function(e) {
    const pos = e.latlng;
    console.log('‚Äç‚ôÇÔ∏è Click en monito:', pos.lat, pos.lng);
    
    // ‚úÖ ABRIR STREET VIEW AL HACER CLICK
    abrirStreetViewCompleto(pos.lat, pos.lng);
  });
  
  // ‚úÖ HACER EL MONITO VISIBLE
  setTimeout(() => {
    if (window.monitoStreetView) {
      const element = window.monitoStreetView.getElement();
      if (element) {
        element.style.filter = 'drop-shadow(0 0 15px rgba(0,255,0,0.8))';
        console.log('‚úÖ Monito resaltado para mejor visibilidad');
        
        mostrarNotificacion('üéâ ¬°Monito activado! Arrastra para abrir Street View');
      }
    }
  }, 100);
  
  return window.monitoStreetView;
}

// ‚úÖ FUNCI√ìN PARA QUITAR MONITO
function quitarMonitoDelMapa() {
  console.log('üö™ Quitando monito del mapa...');
  
  if (window.monitoStreetView) {
    window.monitoStreetView.remove();
    window.monitoStreetView = null;
    mostrarNotificacion('‚úÖ Monito removido del mapa');
  } else {
    alert('No hay monito activo en el mapa');
  }
}
// ‚úÖ FUNCI√ìN PARA VERIFICAR MONITO
function verificarMonito() {
  console.log('ÔøΩÔøΩ Verificando estado del monito...');
  
  if (window.monitoStreetView) {
    console.log('‚úÖ Monito existe:', window.monitoStreetView);
    
    // Verificar si est√° en el mapa
    const mapa = window.monitoStreetView._map;
    if (mapa) {
      console.log('‚úÖ Monito est√° en el mapa:', mapa);
      
      // Verificar posici√≥n
      const pos = window.monitoStreetView.getLatLng();
      console.log('üìç Posici√≥n del monito:', pos);
      
      // Verificar si es visible
      const element = window.monitoStreetView.getElement();
      if (element) {
        console.log('‚úÖ Elemento DOM del monito:', element);
        console.log('üëÅÔ∏è Visibilidad:', element.style.display, element.style.visibility, element.style.opacity);
        
        // Hacer el monito m√°s visible
        element.style.border = '3px solid red';
        element.style.backgroundColor = 'yellow';
        element.style.zIndex = '9999';
        
        alert(`Monito encontrado en posici√≥n: ${pos.lat}, ${pos.lng}\nElemento DOM: ${element.outerHTML}`);
      } else {
        console.error('‚ùå No se pudo obtener el elemento DOM del monito');
      }
    } else {
      console.error('‚ùå Monito NO est√° en el mapa');
    }
  } else {
    console.error('‚ùå No hay monito activo');
  }
}
// ‚úÖ FUNCI√ìN PARA ABRIR STREET VIEW COMPLETO
function abrirStreetViewCompleto(lat, lng) {
  console.log('üåç Abriendo Street View completo en:', lat, lng);
  
  // Crear modal grande de Street View
  const modal = document.createElement('div');
  modal.className = 'modal-streetview-completo';
  modal.innerHTML = `
    <div class="modal-content-streetview">
      <div class="modal-header-streetview">
        <h3><i class="fas fa-street-view"></i> Street View - Como Google Maps</h3>
        <button class="close-btn-streetview" onclick="cerrarStreetViewCompleto()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="streetview-container">
        <div class="streetview-panorama-completo"></div>
        <div class="streetview-controles">
          <button class="btn-control" onclick="moverEnStreetView('adelante')">
            <i class="fas fa-arrow-up"></i> Adelante
          </button>
          <button class="btn-control" onclick="moverEnStreetView('atras')">
            <i class="fas fa-arrow-down"></i> Atr√°s
          </button>
          <button class="btn-control" onclick="moverEnStreetView('izquierda')">
            <i class="fas fa-arrow-left"></i> Izquierda
          </button>
          <button class="btn-control" onclick="moverEnStreetView('derecha')">
            <i class="fas fa-arrow-right"></i> Derecha
          </button>
          <button class="btn-control" onclick="rotarEnStreetView('izquierda')">
            <i class="fas fa-undo"></i> Rotar Izq
          </button>
          <button class="btn-control" onclick="rotarEnStreetView('derecha')">
            <i class="fas fa-redo"></i> Rotar Der
          </button>
        </div>
      </div>
    </div>
  `;
  
  // Agregar al body
  document.body.appendChild(modal);
  
  // Mostrar modal
  modal.style.display = 'block';
  
  // Inicializar Street View
  setTimeout(() => {
    inicializarStreetViewCompleto(lat, lng, modal);
  }, 100);
}

// ‚úÖ FUNCI√ìN PARA CERRAR STREET VIEW
function cerrarStreetViewCompleto() {
  const modal = document.querySelector('.modal-streetview-completo');
  if (modal) {
    modal.remove();
    console.log('‚úÖ Street View cerrado');
  }
}
// ‚úÖ FUNCI√ìN PARA INICIALIZAR STREET VIEW COMPLETO
function inicializarStreetViewCompleto(lat, lng, modal) {
  const panoramaDiv = modal.querySelector('.streetview-panorama-completo');
  
  try {
    // Intentar usar Google Street View
    if (typeof google !== 'undefined' && google.maps) {
      const panorama = new google.maps.StreetViewPanorama(
        panoramaDiv,
        {
          position: { lat: lat, lng: lng },
          pov: {
            heading: 34,
            pitch: 10
          },
          zoom: 1,
          addressControl: true,
          showRoadLabels: true,
          enableCloseButton: false,
          // ‚úÖ HABILITAR ARRASTRE Y NAVEGACI√ìN
          motionTracking: true,
          motionTrackingControl: true,
          panControl: true,
          zoomControl: true,
          scrollwheel: true,
          draggable: true,
          clickToGo: true,
          autoRotate: false,
          autoRotateControl: true
        }
      );
      
      // Guardar referencia global
      window.currentStreetView = panorama;
      
      // ‚úÖ CREAR MONITO ARRASTRABLE EN EL MAPA PRINCIPAL
      console.log('‚úÖ Street View inicializado en:', lat, lng);
      
      console.log('‚úÖ Google Street View completo inicializado');
      
    } else {
      // Fallback: Mostrar mensaje de error
      panoramaDiv.innerHTML = `
        <div class="streetview-fallback">
          <i class="fas fa-map-marked-alt"></i>
          <h4>Street View no disponible</h4>
          <p>Esta ubicaci√≥n no tiene Street View disponible.</p>
          <p>Coordenadas: ${lat.toFixed(6)}, ${lng.toFixed(6)}</p>
          <div class="fallback-actions">
            <button class="btn btn-primary" onclick="abrirGoogleMaps(${lat}, ${lng})">
              <i class="fas fa-external-link-alt"></i> Abrir en Google Maps
            </button>
          </div>
        </div>
      `;
    }
  } catch (error) {
    console.error('‚ùå Error al inicializar Street View:', error);
    panoramaDiv.innerHTML = `
      <div class="streetview-error">
        <i class="fas fa-exclamation-triangle"></i>
        <h4>Error al cargar Street View</h4>
        <p>${error.message}</p>
        <p>Verifica que tengas una API key v√°lida de Google Maps</p>
      </div>
    `;
  }
}
// ‚úÖ FUNCIONES PARA MOVERSE EN STREET VIEW
function moverEnStreetView(direccion) {
  if (!window.currentStreetView) return;
  
  const panorama = window.currentStreetView;
  const pos = panorama.getPosition();
  const pov = panorama.getPov();
  let newLat = pos.lat();
  let newLng = pos.lng();
  
  const distancia = 0.0001; // Aproximadamente 10 metros
  
  switch(direccion) {
    case 'adelante':
      newLat += Math.cos(pov.heading * Math.PI / 180) * distancia;
      newLng += Math.sin(pov.heading * Math.PI / 180) * distancia;
      break;
    case 'atras':
      newLat -= Math.cos(pov.heading * Math.PI / 180) * distancia;
      newLng -= Math.sin(pov.heading * Math.PI / 180) * distancia;
      break;
    case 'izquierda':
      newLat += Math.cos((pov.heading - 90) * Math.PI / 180) * distancia;
      newLng += Math.sin((pov.heading - 90) * Math.PI / 180) * distancia;
      break;
    case 'derecha':
      newLat += Math.cos((pov.heading + 90) * Math.PI / 180) * distancia;
      newLng += Math.sin((pov.heading + 90) * Math.PI / 180) * distancia;
      break;
  }
  
  panorama.setPosition({ lat: newLat, lng: newLng });
  
  // ‚úÖ ACTUALIZAR MONITO EN EL MAPA PRINCIPAL
  if (window.monitoStreetView) {
    window.monitoStreetView.setLatLng([newLat, newLng]);
  }
}
function rotarEnStreetView(direccion) {
  if (!window.currentStreetView) return;
  
  const panorama = window.currentStreetView;
  const pov = panorama.getPov();
  const nuevoHeading = direccion === 'izquierda' ? pov.heading - 45 : pov.heading + 45;
  panorama.setPov({ heading: nuevoHeading, pitch: pov.pitch });
}

// ‚úÖ FUNCI√ìN CORREGIDA QUE LEE COLORES DEL MAPA + MANTIENE TU ESTRUCTURA
function exportarEnlacesFactiblesKMZ() {
  console.log('üó∫Ô∏è Exportando KMZ con colores reales del mapa...');
  
  // ‚úÖ BUSCAR EN TODAS LAS VARIABLES POSIBLES (MANTIENDO TU L√ìGICA)
  let datosEnlaces = null;
  let fuente = '';
  
  // Verificar m√∫ltiples fuentes de datos
  if (window.dataExcel && window.dataExcel.length > 0) {
    datosEnlaces = window.dataExcel;
    fuente = 'dataExcel global';
  } else if (typeof dataExcel !== 'undefined' && dataExcel && dataExcel.length > 0) {
    datosEnlaces = dataExcel;
    fuente = 'dataExcel local';
  } else if (window.enlaces && window.enlaces.length > 0) {
    datosEnlaces = window.enlaces;
    fuente = 'enlaces global';
  } else if (window.enlacesFactibles && window.enlacesFactibles.length > 0) {
    datosEnlaces = window.enlacesFactibles;
    fuente = 'enlacesFactibles global';
  } else if (window.enlacesNoFactibles && window.enlacesNoFactibles.length > 0) {
    datosEnlaces = window.enlacesNoFactibles;
    fuente = 'enlacesNoFactibles global';
  } else {
    // ‚úÖ INTENTAR RECONSTRUIR DESDE EL MAPA
    try {
      const marcadores = [];
      if (window.mapaEnlaces) {
        // Buscar marcadores en el mapa
        window.mapaEnlaces.eachLayer((layer) => {
          if (layer instanceof L.Marker) {
            const latlng = layer.getLatLng();
            const popup = layer.getPopup();
            if (popup && popup.getContent()) {
              marcadores.push({
                lat: latlng.lat,
                lng: latlng.lng,
                popup: popup.getContent()
              });
            }
          }
        });
        
        if (marcadores.length > 0) {
          datosEnlaces = marcadores;
          fuente = 'marcadores del mapa';
        }
      }
    } catch (e) {
      console.error('Error al extraer marcadores del mapa:', e);
    }
  }
  
  console.log('üîç Fuente de datos encontrada:', fuente);
  console.log('üìä Datos disponibles:', datosEnlaces);
  
  if (!datosEnlaces || datosEnlaces.length === 0) {
    // ‚úÖ INTENTAR RECONSTRUIR DESDE EL HTML DE LA TABLA
    try {
      const tabla = document.querySelector('#tabla tbody');
      if (tabla) {
        const filas = tabla.querySelectorAll('tr');
        const datosTabla = [];
        
        filas.forEach((fila, index) => {
          const celdas = fila.querySelectorAll('td');
          if (celdas.length > 0) {
            const filaData = Array.from(celdas).map(celda => celda.textContent.trim());
            datosTabla.push(filaData);
          }
        });
        
        if (datosTabla.length > 0) {
          datosEnlaces = datosTabla;
          fuente = 'tabla HTML';
          console.log('‚úÖ Datos extra√≠dos de la tabla HTML:', datosTabla);
        }
      }
    } catch (e) {
      console.error('Error al extraer datos de la tabla:', e);
    }
  }
  
  if (!datosEnlaces || datosEnlaces.length === 0) {
    alert(`‚ùå No hay datos de enlaces para exportar\n\nFuentes verificadas:\n- dataExcel: ${window.dataExcel ? 'S√ç' : 'NO'}\n- enlaces: ${window.enlaces ? 'S√ç' : 'NO'}\n- enlacesFactibles: ${window.enlacesFactibles ? 'S√ç' : 'NO'}\n- Tabla HTML: ${document.querySelector('#tabla') ? 'S√ç' : 'NO'}\n\nVerifica la consola para m√°s detalles.`);
    return;
  }
  
  console.log(`üìä Total de filas encontradas: ${datosEnlaces.length}`);
  
  // ‚úÖ FILTRAR ENLACES SEG√öN SU ESTADO REAL + OBTENER COLORES DEL MAPA
  const enlacesFactibles = [];
  const enlacesNoFactibles = [];
  
  for (let i = 0; i < datosEnlaces.length; i++) {
    const fila = datosEnlaces[i];
    
    if (fila && (Array.isArray(fila) || typeof fila === 'object')) {
      // ‚úÖ VERIFICAR ESTADO REAL DE FACTIBILIDAD
    // ‚úÖ VERIFICAR ESTADO REAL DE FACTIBILIDAD
let esFactible = false;

if (Array.isArray(fila)) {
  // ‚úÖ BUSCAR EN LA COLUMNA CORRECTA (COLUMNA 31 - √çNDICE 30)
  if (fila.length > 30) {
    const valorFactible = fila[30]?.toString().trim().toUpperCase() || '';
    
    // ‚úÖ DEBUG: Agregar logging detallado
    console.log(`üîç DEBUG Fila ${i}:`);
    console.log(`  - Valor original: "${fila[30]}"`);
    console.log(`  - Valor procesado: "${valorFactible}"`);
    console.log(`  - Incluye 'FACTIBLE': ${valorFactible.includes('FACTIBLE')}`);
    console.log(`  - Incluye 'NO FACTIBLE': ${valorFactible.includes('NO FACTIBLE')}`);
    
    // ‚úÖ CORRECCI√ìN: L√≥gica simplificada y m√°s robusta
    if (valorFactible === 'FACTIBLE' || valorFactible === 'S√ç' || valorFactible === 'SI' || valorFactible === 'YES' || valorFactible === 'TRUE' || valorFactible === '1') {
      esFactible = true;
      console.log(`  ‚úÖ Marcado como FACTIBLE`);
    } else if (valorFactible === 'NO FACTIBLE' || valorFactible === 'NO' || valorFactible === 'FALSE' || valorFactible === '0') {
      esFactible = false;
      console.log(`  ‚ùå Marcado como NO FACTIBLE`);
    } else {
      // Por defecto, si no se puede determinar, asumir que NO es factible
      esFactible = false;
      console.log(`  ‚ö†Ô∏è Valor no reconocido, marcado como NO FACTIBLE por defecto`);
    }
    
    console.log(`  - Resultado final: Factible: ${esFactible}`);
  } else {
    console.log(`‚ö†Ô∏è Fila ${i} no tiene suficientes columnas: ${fila.length}`);
    continue;
  }
}
      
      // ‚úÖ CREAR ENLACE CON TU ESTRUCTURA EXACTA + COLOR DEL MAPA
      let enlace;
      
      if (Array.isArray(fila)) {
        // ‚úÖ MANTENER TU ESTRUCTURA EXACTA + AGREGAR COLOR DEL MAPA
        enlace = {
          idA: fila[1] || `Sitio_${i}`,
          nombreA: fila[2] || 'Sin nombre',
          latA: parseFloat(fila[3]) || 0,
          lonA: parseFloat(fila[4]) || 0,
          idB: fila[7] || `Sitio_${i}_B`,
          nombreB: fila[8] || 'Sin nombre B',
          latB: parseFloat(fila[9]) || 0,
          lonB: parseFloat(fila[10]) || 0,
          distancia: fila[13] || 'N/A',
          tipoEnlace: fila[14] || 'N/A',
          factible: esFactible ? 'S√ç' : 'NO',  // ‚úÖ ESTADO REAL
          colorMapa: esFactible ? '#10b981' : '#ef4444'  // ‚úÖ COLOR SEG√öN FACTIBILIDAD
        };
      } else {
        // Si es objeto, mantener tu estructura
        enlace = {
          idA: fila.idA || fila.id_a || fila.ID_A || `Sitio_${i}`,
          nombreA: fila.nombreA || fila.nombre_a || fila.Nombre_A || 'Sin nombre',
          latA: parseFloat(fila.latA || fila.lat_a || fila.Lat_A) || 0,
          lonA: parseFloat(fila.lonA || fila.lon_a || fila.Lon_A) || 0,
          idB: fila.idB || fila.id_b || fila.ID_B || `Sitio_${i}_B`,
          nombreB: fila.nombreB || fila.nombre_b || fila.Nombre_B || 'Sin nombre B',
          latB: parseFloat(fila.latB || fila.lat_b || fila.Lat_B) || 0,
          lonB: parseFloat(fila.lonB || fila.lon_b || fila.Lon_B) || 0,
          distancia: fila.distancia || fila.Distancia || 'N/A',
          tipoEnlace: fila.tipoEnlace || fila.tipo_enlace || fila.Tipo_Enlace || 'N/A',
          factible: esFactible ? 'S√ç' : 'NO',  // ‚úÖ ESTADO REAL
          colorMapa: esFactible ? '#10b981' : '#ef4444'  // ‚úÖ COLOR SEG√öN FACTIBILIDAD
        };
      }
      
      // ‚úÖ AGREGAR A LA LISTA CORRESPONDIENTE
      if (esFactible) {
        enlacesFactibles.push(enlace);
        console.log(`‚úÖ Enlace FACTIBLE agregado:`, enlace);
      } else {
        enlacesNoFactibles.push(enlace);
        console.log(`‚ùå Enlace NO FACTIBLE agregado:`, enlace);
      }
    }
  }
  
  console.log(`üìä Total de enlaces factibles: ${enlacesFactibles.length}`);
  console.log(`üìä Total de enlaces no factibles: ${enlacesNoFactibles.length}`);
  console.log('üìã Lista de enlaces factibles:', enlacesFactibles);
  console.log('üìã Lista de enlaces no factibles:', enlacesNoFactibles);
  
  if (enlacesFactibles.length === 0 && enlacesNoFactibles.length === 0) {
    alert(`‚ùå No se encontraron enlaces para exportar\n\nTotal de filas procesadas: ${datosEnlaces.length}\nVerifica la consola para m√°s detalles.`);
    return;
  }
  
  // ‚úÖ CREAR ARCHIVO KMZ CON COLORES CORRECTOS + TU ESTRUCTURA
  const todosLosEnlaces = [...enlacesFactibles, ...enlacesNoFactibles];
  mostrarNotificacion(`Ô∏è Generando KMZ con ${enlacesFactibles.length} factibles y ${enlacesNoFactibles.length} no factibles...`);
  crearArchivoKMZConColoresReales(todosLosEnlaces);
}
// ‚úÖ FUNCI√ìN PARA VERIFICAR TODAS LAS VARIABLES
function verificarTodasLasVariables() {
  console.log('üîç VERIFICANDO TODAS LAS VARIABLES DISPONIBLES...');
  
  // Verificar variables globales
  const variablesGlobales = [
    'dataExcel', 'enlaces', 'enlacesFactibles', 'enlacesNoFactibles',
    'dataPares', 'enlacesMismoTransporte', 'paresFaltantes'
  ];
  
  variablesGlobales.forEach(varName => {
    const valor = window[varName];
    console.log(`üìä ${varName}:`, valor ? (Array.isArray(valor) ? `${valor.length} elementos` : valor) : 'NO DEFINIDA');
  });
  
  // Verificar mapa
  if (window.mapaEnlaces) {
    console.log('üó∫Ô∏è mapaEnlaces: S√ç disponible');
    let contadorMarcadores = 0;
    window.mapaEnlaces.eachLayer((layer) => {
      if (layer instanceof L.Marker) contadorMarcadores++;
    });
    console.log(`üìç Marcadores en el mapa: ${contadorMarcadores}`);
  } else {
    console.log('üó∫Ô∏è mapaEnlaces: NO disponible');
  }
  
  // Verificar tabla
  const tabla = document.querySelector('#tabla');
  if (tabla) {
    const filas = tabla.querySelectorAll('tbody tr');
    console.log(`üìã Tabla HTML: ${filas.length} filas encontradas`);
  } else {
    console.log('üìã Tabla HTML: NO encontrada');
  }
  
  // Verificar localStorage
  try {
    const keys = Object.keys(localStorage);
    const enlacesKeys = keys.filter(key => key.toLowerCase().includes('enlace'));
    console.log('üíæ localStorage - claves de enlaces:', enlacesKeys);
    
    enlacesKeys.forEach(key => {
      try {
        const valor = JSON.parse(localStorage.getItem(key));
        console.log(`ÔøΩÔøΩ ${key}:`, Array.isArray(valor) ? `${valor.length} elementos` : valor);
      } catch (e) {
        console.log(`üíæ ${key}:`, localStorage.getItem(key));
      }
    });
  } catch (e) {
    console.error('Error al leer localStorage:', e);
  }
}
// ‚úÖ FUNCI√ìN PARA DEBUGGEAR LA ESTRUCTURA DE DATOS
function debugEstructuraDatos() {
  console.log('üîç DEBUG: Estructura de datos Excel');
  
  if (!dataExcel || dataExcel.length === 0) {
    console.log('‚ùå No hay datos en dataExcel');
    return;
  }
  
  console.log('üìä Total de filas:', dataExcel.length);
  
  // Mostrar encabezados
  if (dataExcel[0]) {
    console.log('üìã Encabezados (primera fila):');
    dataExcel[0].forEach((columna, index) => {
      console.log(`  Columna ${index}: "${columna}"`);
    });
  }
  
  // Mostrar primera fila de datos
  if (dataExcel[1]) {
    console.log('üìã Primera fila de datos:');
    dataExcel[1].forEach((valor, index) => {
      console.log(`  Columna ${index}: "${valor}"`);
    });
  }
  
  // Buscar columnas que contengan "factible"
  console.log('üîç Buscando columnas con "factible":');
  for (let i = 0; i < dataExcel.length; i++) {
    const fila = dataExcel[i];
    if (fila) {
      for (let j = 0; j < fila.length; j++) {
        const valor = fila[j]?.toString().toLowerCase() || '';
        if (valor.includes('factible')) {
          console.log(`‚úÖ Fila ${i}, Columna ${j}: "${valor}"`);
        }
      }
    }
  }
}
// ‚úÖ FUNCI√ìN PARA CREAR KMZ CON COLORES + TU ESTRUCTURA
function crearArchivoKMZConColoresReales(enlaces) {
  const kmlContent = generarKMLConColoresReales(enlaces);
  
  // ‚úÖ CREAR ARCHIVO ZIP (KMZ)
  const zip = new JSZip();
  zip.file('doc.kml', kmlContent);
  
  zip.generateAsync({type: 'blob'}).then(function(content) {
    // ‚úÖ DESCARGAR ARCHIVO
    const url = window.URL.createObjectURL(content);
    const a = document.createElement('a');
    a.href = url;
    a.download = `enlaces_con_colores_reales_${new Date().toISOString().split('T')[0]}.kmz`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    
    const factibles = enlaces.filter(e => e.factible === 'S√ç').length;
    const noFactibles = enlaces.filter(e => e.factible === 'NO').length;
    
    mostrarNotificacion(`‚úÖ KMZ exportado con colores correctos: ${factibles} verdes, ${noFactibles} rojos`);
  });
}

// ‚úÖ FUNCI√ìN PARA GENERAR KML CON COLORES + TU ESTRUCTURA + MARCADORES
function generarKMLConColoresReales(enlaces) {
  let kml = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
<Document>
  <name>Enlaces con Colores Reales + Tu Estructura + Marcadores</name>
  <description>Enlaces exportados con tu estructura de datos, colores correctos y marcadores de sitios</description>
  
  <!-- Estilos para los marcadores de sitios -->
  <Style id="marcador-sitio">
    <IconStyle>
      <color>ff0000ff</color>  <!-- Azul para los sitios -->
      <scale>1.2</scale>
      <Icon>
        <href>http://maps.google.com/mapfiles/kml/paddle/red-circle.png</href>
      </Icon>
    </IconStyle>
    <LabelStyle>
      <color>ff000000</color>  <!-- Negro para el texto -->
      <scale>1.0</scale>
    </LabelStyle>
  </Style>
  
  <!-- Estilos para las l√≠neas de enlaces -->
  <Style id="estilo-verde">
    <LineStyle>
      <color>ff00ff00</color>  <!-- Verde s√≥lido -->
      <width>4</width>
    </LineStyle>
  </Style>
  
  <Style id="estilo-rojo">
    <LineStyle>
      <color>ff0000ff</color>  <!-- Rojo s√≥lido -->
      <width>4</width>
    </LineStyle>
  </Style>
  
  <!-- Marcadores de Sitios A -->
  <Folder>
    <name>üìç Sitios A (Origen)</name>
    <description>Marcadores de todos los sitios de origen</description>`;
  
  // Crear marcadores √∫nicos para Sitios A
  const sitiosAUnicos = new Map();
  enlaces.forEach(enlace => {
    const key = `${enlace.idA}-${enlace.latA}-${enlace.lonA}`;
    if (!sitiosAUnicos.has(key)) {
      sitiosAUnicos.set(key, enlace);
    }
  });
  
  sitiosAUnicos.forEach((enlace, key) => {
    kml += `
    <Placemark>
      <name>üìç ${enlace.nombreA}</name>
      <description>
        <![CDATA[
        <h3>Sitio A - Origen</h3>
        <p><strong>ID:</strong> ${enlace.idA}</p>
        <p><strong>Nombre:</strong> ${enlace.nombreA}</p>
        <p><strong>Coordenadas:</strong> ${enlace.latA}, ${enlace.lonA}</p>
        ]]>
      </description>
      <styleUrl>#marcador-sitio</styleUrl>
      <Point>
        <coordinates>${enlace.lonA},${enlace.latA}</coordinates>
      </Point>
    </Placemark>`;
  });
  
  kml += `
  </Folder>
  
  <!-- Marcadores de Sitios B -->
  <Folder>
    <name>üìç Sitios B (Destino)</name>
    <description>Marcadores de todos los sitios de destino</description>`;
  
  // Crear marcadores √∫nicos para Sitios B
  const sitiosBUnicos = new Map();
  enlaces.forEach(enlace => {
    const key = `${enlace.idB}-${enlace.latB}-${enlace.lonB}`;
    if (!sitiosBUnicos.has(key)) {
      sitiosBUnicos.set(key, enlace);
    }
  });
  
  sitiosBUnicos.forEach((enlace, key) => {
    kml += `
    <Placemark>
      <name>üìç ${enlace.nombreB}</name>
      <description>
        <![CDATA[
        <h3>Sitio B - Destino</h3>
        <p><strong>ID:</strong> ${enlace.idB}</p>
        <p><strong>Nombre:</strong> ${enlace.nombreB}</p>
        <p><strong>Coordenadas:</strong> ${enlace.latB}, ${enlace.lonB}</p>
        ]]>
      </description>
      <styleUrl>#marcador-sitio</styleUrl>
      <Point>
        <coordinates>${enlace.lonB},${enlace.latB}</coordinates>
      </Point>
    </Placemark>`;
  });
  
  kml += `
  </Folder>
  
  <!-- Enlaces Factibles (Verdes) -->
  <Folder>
    <name>üü¢ Enlaces Factibles (${enlaces.filter(e => e.factible === 'S√ç').length})</name>
    <description>Enlaces verdes que cumplen criterios de factibilidad</description>`;
  
  enlaces.filter(e => e.factible === 'S√ç').forEach((enlace, index) => {
    kml += `
    <Placemark>
      <name>‚úÖ ${enlace.nombreA} ‚Üí ${enlace.nombreB}</name>
      <description>
        <![CDATA[
        <h3>Enlace Factible (Verde)</h3>
        <p><strong>ID A:</strong> ${enlace.idA}</p>
        <p><strong>Nombre A:</strong> ${enlace.nombreA}</p>
        <p><strong>ID B:</strong> ${enlace.idB}</p>
        <p><strong>Nombre B:</strong> ${enlace.nombreB}</p>
        <p><strong>Distancia:</strong> ${enlace.distancia}</p>
        <p><strong>Tipo:</strong> ${enlace.tipoEnlace}</p>
        <p><strong>Estado:</strong> ${enlace.factible}</p>
        <p><strong>Color en el mapa:</strong> ${enlace.colorMapa}</p>
        <p><strong>Coordenadas A:</strong> ${enlace.latA}, ${enlace.lonA}</p>
        <p><strong>Coordenadas B:</strong> ${enlace.latB}, ${enlace.lonB}</p>
        ]]>
      </description>
      <styleUrl>#estilo-verde</styleUrl>
      <LineString>
        <coordinates>${enlace.lonA},${enlace.latA} ${enlace.lonB},${enlace.latB}</coordinates>
      </LineString>
    </Placemark>`;
  });
  
  kml += `
  </Folder>
  
  <!-- Enlaces No Factibles (Rojos) -->
  <Folder>
    <name>üî¥ Enlaces No Factibles (${enlaces.filter(e => e.factible === 'NO').length})</name>
    <description>Enlaces rojos que no cumplen criterios de factibilidad</description>`;
  
  enlaces.filter(e => e.factible === 'NO').forEach((enlace, index) => {
    kml += `
    <Placemark>
      <name>‚ùå ${enlace.nombreA} ‚Üí ${enlace.nombreB}</name>
      <description>
        <![CDATA[
        <h3>Enlace No Factible (Rojo)</h3>
        <p><strong>ID A:</strong> ${enlace.idA}</p>
        <p><strong>Nombre B:</strong> ${enlace.idB}</p>
        <p><strong>Nombre A:</strong> ${enlace.nombreA}</p>
        <p><strong>Nombre B:</strong> ${enlace.nombreB}</p>
        <p><strong>Distancia:</strong> ${enlace.distancia}</p>
        <p><strong>Tipo:</strong> ${enlace.tipoEnlace}</p>
        <p><strong>Estado:</strong> ${enlace.factible}</p>
        <p><strong>Color en el mapa:</strong> ${enlace.colorMapa}</p>
        <p><strong>Coordenadas A:</strong> ${enlace.latA}, ${enlace.lonA}</p>
        <p><strong>Coordenadas B:</strong> ${enlace.latB}, ${enlace.lonB}</p>
        ]]>
      </description>
      <styleUrl>#estilo-rojo</styleUrl>
      <LineString>
        <coordinates>${enlace.lonA},${enlace.latA} ${enlace.lonB},${enlace.latB}</coordinates>
      </LineString>
    </Placemark>`;
  });
  
  kml += `
  </Folder>
  
  <!-- Resumen con tu estructura -->
  <Placemark>
    <name>üìä Resumen de Exportaci√≥n</name>
    <description>
      <![CDATA[
      <h3>Resumen de Exportaci√≥n</h3>
      <p><strong>Total de enlaces:</strong> ${enlaces.length}</p>
      <p><strong>Enlaces factibles (verdes):</strong> ${enlaces.filter(e => e.factible === 'S√ç').length}</p>
      <p><strong>Enlaces no factibles (rojos):</strong> ${enlaces.filter(e => e.factible === 'NO').length}</p>
      <p><strong>Total de sitios √∫nicos:</strong> ${sitiosAUnicos.size + sitiosBUnicos.size}</p>
      <p><strong>Sitios A (origen):</strong> ${sitiosAUnicos.size}</p>
      <p><strong>Sitios B (destino):</strong> ${sitiosBUnicos.size}</p>
      <p><strong>Estructura respetada:</strong> S√ç - Se mantiene tu estructura de datos</p>
      <p><strong>Colores respetados:</strong> S√ç - Se exportaron con los colores correctos</p>
      <p><strong>Marcadores agregados:</strong> S√ç - Sitios A y B marcados individualmente</p>
      <p><strong>Fecha de exportaci√≥n:</strong> ${new Date().toLocaleString()}</p>
      ]]>
    </description>
    <Point>
      <coordinates>-102.5528,23.6345</coordinates>
    </Point>
  </Placemark>
</Document>
</kml>`;
  
  return kml;
}

// ‚úÖ FUNCI√ìN PARA CREAR ARCHIVO KMZ
function crearArchivoKMZ(enlaces) {
  try {
    // ‚úÖ CREAR CONTENIDO KML
    const kmlContent = generarContenidoKML(enlaces);
    
    // ‚úÖ CREAR ARCHIVO ZIP (KMZ)
    const zip = new JSZip();
    
    // Agregar archivo KML al ZIP
    zip.file("doc.kml", kmlContent);
    
    // ‚úÖ GENERAR Y DESCARGAR ARCHIVO KMZ
    zip.generateAsync({type: "blob"})
      .then(function(content) {
        const url = URL.createObjectURL(content);
        const a = document.createElement('a');
        a.href = url;
        a.download = `enlaces_factibles_${new Date().toISOString().split('T')[0]}.kmz`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        mostrarNotificacion(`‚úÖ KMZ exportado exitosamente: ${enlaces.length} enlaces factibles`);
        console.log('üéâ Archivo KMZ generado y descargado');
      })
      .catch(function(error) {
        console.error('‚ùå Error al generar KMZ:', error);
        alert('‚ùå Error al generar el archivo KMZ');
      });
      
  } catch (error) {
    console.error('‚ùå Error al crear KMZ:', error);
    alert('‚ùå Error al crear el archivo KMZ');
  }
}

// ‚úÖ FUNCI√ìN PARA GENERAR CONTENIDO KML
function generarContenidoKML(enlaces) {
  const fecha = new Date().toLocaleDateString('es-ES');
  const hora = new Date().toLocaleTimeString('es-ES');
  
  let kml = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
  <Document>
    <name>Enlaces Factibles - Fangio Telecom</name>
    <description>Enlaces punto a punto factibles exportados el ${fecha} a las ${hora}</description>
    
    <!-- Estilos para los marcadores -->
    <Style id="sitioA">
      <IconStyle>
        <Icon>
          <href>http://maps.google.com/mapfiles/kml/paddle/grn-circle.png</href>
        </Icon>
        <scale>1.2</scale>
      </IconStyle>
      <LabelStyle>
        <color>ff00ff00</color>
        <scale>0.8</scale>
      </LabelStyle>
    </Style>
    
    <Style id="sitioB">
      <IconStyle>
        <Icon>
          <href>http://maps.google.com/mapfiles/kml/paddle/red-circle.png</href>
        </Icon>
        <scale>1.2</scale>
      </IconStyle>
      <LabelStyle>
        <color>ff0000ff</color>
        <scale>0.8</scale>
      </LabelStyle>
    </Style>
    
    <Style id="lineaEnlace">
      <LineStyle>
        <color>ff00ff00</color>
        <width>3</width>
      </LineStyle>
    </Style>`;
  
  // ‚úÖ AGREGAR CADA ENLACE
  enlaces.forEach((enlace, index) => {
    const id = `enlace_${index + 1}`;
    
    // ‚úÖ SITIO A
    kml += `
    <Placemark id="${id}_A">
      <name>${enlace.nombreA} (${enlace.idA})</name>
      <description>
        <![CDATA[
        <h3>${enlace.nombreA}</h3>
        <p><strong>ID:</strong> ${enlace.idA}</p>
        <p><strong>Coordenadas:</strong> ${enlace.latA}, ${enlace.lonA}</p>
        <p><strong>Tipo:</strong> ${enlace.tipoEnlace}</p>
        <p><strong>Estado:</strong> <span style="color: green;">${enlace.factible}</span></p>
        ]]>
      </description>
      <styleUrl>#sitioA</styleUrl>
      <Point>
        <coordinates>${enlace.lonA},${enlace.latA},0</coordinates>
      </Point>
    </Placemark>`;
    
    // ‚úÖ SITIO B
    kml += `
    <Placemark id="${id}_B">
      <name>${enlace.nombreB} (${enlace.idB})</name>
      <description>
        <![CDATA[
        <h3>${enlace.nombreB}</h3>
        <p><strong>ID:</strong> ${enlace.idB}</p>
        <p><strong>Coordenadas:</strong> ${enlace.latB}, ${enlace.lonB}</p>
        <p><strong>Tipo:</strong> ${enlace.tipoEnlace}</p>
        <p><strong>Estado:</strong> <span style="color: green;">${enlace.factible}</span></p>
        ]]>
      </description>
      <styleUrl>#sitioB</styleUrl>
      <Point>
        <coordinates>${enlace.lonB},${enlace.latB},0</coordinates>
      </Point>
    </Placemark>`;
    
    // ‚úÖ L√çNEA DE ENLACE
    kml += `
    <Placemark id="${id}_linea">
      <name>Enlace: ${enlace.nombreA} ‚Üí ${enlace.nombreB}</name>
      <description>
        <![CDATA[
        <h3>Enlace Punto a Punto</h3>
        <p><strong>Desde:</strong> ${enlace.nombreA}</p>
        <p><strong>Hasta:</strong> ${enlace.nombreB}</p>
        <p><strong>Distancia:</strong> ${enlace.distancia}</p>
        <p><strong>Tipo:</strong> ${enlace.tipoEnlace}</p>
        <p><strong>Estado:</strong> <span style="color: green;">${enlace.factible}</span></p>
        ]]>
      </description>
      <styleUrl>#lineaEnlace</styleUrl>
      <LineString>
        <coordinates>${enlace.lonA},${enlace.latA},0 ${enlace.lonB},${enlace.latB},0</coordinates>
      </LineString>
    </Placemark>`;
  });
  
  kml += `
  </Document>
</kml>`;
  
  return kml;
}
// ‚úÖ SISTEMA COMPLETO DE COLORES POR TIPO DE ENLACE
function cambiarColorEnlacesCompleto() {
  console.log('üé® Aplicando sistema completo de colores por tipo de enlace...');
  
  if (!window.mapaEnlaces) {
    console.error('‚ùå No se encontr√≥ el mapa');
    return;
  }
  
  const estadisticas = {
    factibles: { verde: 0, azul: 0, morado: 0, naranja: 0 },
    noFactibles: { rojo: 0, gris: 0, marron: 0 },
    total: 0
  };
  
  // ‚úÖ RECORRER TODAS LAS CAPAS DEL MAPA
  window.mapaEnlaces.eachLayer((layer) => {
    if (layer instanceof L.Polyline) {
      const enlaceId = layer.enlaceId || layer._enlaceId;
      
      if (enlaceId) {
        // ‚úÖ OBTENER INFORMACI√ìN COMPLETA DEL ENLACE
        const infoEnlace = obtenerInformacionCompletaEnlace(enlaceId);
        
        // ‚úÖ APLICAR COLOR SEG√öN TIPO Y FACTIBILIDAD
        const estilo = determinarEstiloEnlace(infoEnlace);
        layer.setStyle(estilo);
        
        // ‚úÖ ACTUALIZAR POPUP CON INFORMACI√ìN COMPLETA
        const popupCompleto = crearPopupCompleto(infoEnlace);
        layer.bindPopup(popupCompleto);
        
        // ‚úÖ CONTAR ESTAD√çSTICAS
        actualizarEstadisticas(estadisticas, infoEnlace);
        
        console.log(`üé® Enlace ${enlaceId}: ${infoEnlace.tipoEnlace} - ${infoEnlace.factible ? 'FACTIBLE' : 'NO FACTIBLE'} - Color: ${estilo.color}`);
      }
    }
  });
  
  // ‚úÖ MOSTRAR ESTAD√çSTICAS
  mostrarEstadisticasColores(estadisticas);
  
  // ‚úÖ CREAR/ACTUALIZAR LEYENDA
  crearLeyendaColores();
  
  // ‚úÖ APLICAR FILTROS ACTIVOS
  aplicarFiltrosActivos();
  
  return estadisticas;
}

// ‚úÖ FUNCI√ìN PARA OBTENER INFORMACI√ìN COMPLETA DEL ENLACE
function obtenerInformacionCompletaEnlace(enlaceId) {
  let infoEnlace = {
    id: enlaceId,
    tipoEnlace: 'Desconocido',
    factible: false,
    distancia: 'N/A',
    sitioA: 'N/A',
    sitioB: 'N/A',
    razon: 'N/A'
  };
  
  // ‚úÖ BUSCAR EN M√öLTIPLES FUENTES
  if (window.dataExcel && window.dataExcel.length > 0) {
    for (let i = 1; i < window.dataExcel.length; i++) {
      const fila = window.dataExcel[i];
      if (fila && fila.length > 0) {
        const idEnlace = fila[0] || fila[1];
        if (idEnlace === enlaceId) {
          infoEnlace = {
            id: enlaceId,
            tipoEnlace: fila[9] || fila[13] || 'Desconocido',
            factible: verificarFactibilidad(fila),
            distancia: fila[8] || fila[12] || 'N/A',
            sitioA: fila[1] || fila[2] || 'N/A',
            sitioB: fila[5] || fila[8] || 'N/A',
            razon: obtenerRazonFactibilidad(fila)
          };
          break;
        }
      }
    }
  }
  
  return infoEnlace;
}

// ‚úÖ FUNCI√ìN PARA VERIFICAR FACTIBILIDAD
function verificarFactibilidad(fila) {
  for (let j = 0; j < fila.length; j++) {
    const valor = fila[j]?.toString().trim().toUpperCase() || '';
    if (valor.includes('S√ç') || valor.includes('SI') || valor.includes('YES') || valor.includes('FACTIBLE')) {
      return true;
    }
  }
  return false;
}

// ‚úÖ FUNCI√ìN PARA OBTENER RAZ√ìN DE FACTIBILIDAD
function obtenerRazonFactibilidad(fila) {
  // Buscar en columnas de razones o comentarios
  for (let j = 0; j < fila.length; j++) {
    const valor = fila[j]?.toString().trim() || '';
    if (valor.includes('raz√≥n') || valor.includes('comentario') || valor.includes('observaci√≥n')) {
      return valor;
    }
  }
  return 'Sin raz√≥n especificada';
}

// ‚úÖ FUNCI√ìN PARA DETERMINAR ESTILO DEL ENLACE
function determinarEstiloEnlace(infoEnlace) {
  const baseStyle = {
    weight: 4,
    opacity: 0.8,
    fillOpacity: 0.3
  };
  
  if (infoEnlace.factible) {
    // ‚úÖ ENLACES FACTIBLES - Diferentes colores por tipo
    switch (infoEnlace.tipoEnlace.toString().toLowerCase()) {
      case 'fibra':
      case 'fibra √≥ptica':
        return { ...baseStyle, color: '#00ff00', weight: 5 }; // Verde brillante
      
      case 'radio':
      case 'enlace radio':
        return { ...baseStyle, color: '#0080ff', weight: 4 }; // Azul
      
      case 'sat√©lite':
      case 'satelital':
        return { ...baseStyle, color: '#8000ff', weight: 4 }; // Morado
      
      case 'adquisici√≥n':
      case 'torres de adquisici√≥n':
        return { ...baseStyle, color: '#ff8000', weight: 4 }; // Naranja
      
      default:
        return { ...baseStyle, color: '#00ff00', weight: 4 }; // Verde por defecto
    }
  } else {
    // ‚úÖ ENLACES NO FACTIBLES - Diferentes colores por raz√≥n
    if (infoEnlace.razon.includes('distancia')) {
      return { ...baseStyle, color: '#ff0000', weight: 3 }; // Rojo
    } else if (infoEnlace.razon.includes('antena')) {
      return { ...baseStyle, color: '#808080', weight: 3 }; // Gris
    } else {
      return { ...baseStyle, color: '#8b4513', weight: 3 }; // Marr√≥n
    }
  }
}

// ‚úÖ FUNCI√ìN PARA CREAR POPUP COMPLETO
function crearPopupCompleto(infoEnlace) {
  const colorClase = infoEnlace.factible ? 'factible' : 'no-factible';
  const icono = infoEnlace.factible ? '‚úÖ' : '‚ùå';
  
  return `
    <div class="enlace-popup-completo ${colorClase}">
      <h4>${icono} ${infoEnlace.tipoEnlace}</h4>
      <div class="enlace-info">
        <p><strong>ID:</strong> ${infoEnlace.id}</p>
        <p><strong>Sitio A:</strong> ${infoEnlace.sitioA}</p>
        <p><strong>Sitio B:</strong> ${infoEnlace.sitioB}</p>
        <p><strong>Distancia:</strong> ${infoEnlace.distancia}</p>
        <p><strong>Estado:</strong> ${infoEnlace.factible ? 'FACTIBLE' : 'NO FACTIBLE'}</p>
        ${!infoEnlace.factible ? `<p><strong>Raz√≥n:</strong> ${infoEnlace.razon}</p>` : ''}
      </div>
      <div class="estado-enlace ${colorClase}">
        <strong>${infoEnlace.factible ? 'ENLACE FACTIBLE' : 'ENLACE NO FACTIBLE'}</strong>
      </div>
    </div>
  `;
}

// ‚úÖ FUNCI√ìN PARA ACTUALIZAR ESTAD√çSTICAS
function actualizarEstadisticas(estadisticas, infoEnlace) {
  estadisticas.total++;
  
  if (infoEnlace.factible) {
    switch (infoEnlace.tipoEnlace.toString().toLowerCase()) {
      case 'fibra':
      case 'fibra √≥ptica':
        estadisticas.factibles.verde++;
        break;
      case 'radio':
      case 'enlace radio':
        estadisticas.factibles.azul++;
        break;
      case 'sat√©lite':
      case 'satelital':
        estadisticas.factibles.morado++;
        break;
      case 'adquisici√≥n':
      case 'torres de adquisici√≥n':
        estadisticas.factibles.naranja++;
        break;
      default:
        estadisticas.factibles.verde++;
    }
  } else {
    if (infoEnlace.razon.includes('distancia')) {
      estadisticas.noFactibles.rojo++;
    } else if (infoEnlace.razon.includes('antena')) {
      estadisticas.noFactibles.gris++;
    } else {
      estadisticas.noFactibles.marron++;
    }
  }
}
// ‚úÖ FUNCI√ìN PARA CREAR LEYENDA VISUAL DE COLORES
function crearLeyendaColores() {
  // Remover leyenda anterior si existe
  const leyendaAnterior = document.querySelector('.leyenda-colores');
  if (leyendaAnterior) {
    leyendaAnterior.remove();
  }
  
  const leyenda = document.createElement('div');
  leyenda.className = 'leyenda-colores';
  leyenda.innerHTML = `
    <div class="leyenda-header">
      <h4><i class="fas fa-palette"></i> Leyenda de Colores</h4>
      <button class="leyenda-close" onclick="this.closest('.leyenda-colores').remove()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="leyenda-content">
      <div class="leyenda-section">
        <h5>üü¢ Enlaces Factibles</h5>
        <div class="leyenda-item">
          <div class="color-sample" style="background: #00ff00;"></div>
          <span>Fibra √ìptica</span>
        </div>
        <div class="leyenda-item">
          <div class="color-sample" style="background: #0080ff;"></div>
          <span>Radio</span>
        </div>
        <div class="leyenda-item">
          <div class="color-sample" style="background: #8000ff;"></div>
          <span>Sat√©lite</span>
        </div>
        <div class="leyenda-item">
          <div class="color-sample" style="background: #ff8000;"></div>
          <span>Adquisici√≥n</span>
        </div>
      </div>
      
      <div class="leyenda-section">
        <h5>üî¥ Enlaces No Factibles</h5>
        <div class="leyenda-item">
          <div class="color-sample" style="background: #ff0000;"></div>
          <span>Distancia Excesiva</span>
        </div>
        <div class="leyenda-item">
          <div class="color-sample" style="background: #808080;"></div>
          <span>Antena Incompatible</span>
        </div>
        <div class="leyenda-item">
          <div class="color-sample" style="background: #8b4513;"></div>
          <span>Otros Motivos</span>
        </div>
      </div>
    </div>
  `;
  
  document.body.appendChild(leyenda);
  console.log('‚úÖ Leyenda de colores creada');
}
// ‚úÖ FUNCI√ìN PARA MOSTRAR ESTAD√çSTICAS DE COLORES
function mostrarEstadisticasColores(estadisticas) {
  const totalFactibles = Object.values(estadisticas.factibles).reduce((a, b) => a + b, 0);
  const totalNoFactibles = Object.values(estadisticas.noFactibles).reduce((a, b) => a + b, 0);
  
  const mensaje = `
üé® ESTAD√çSTICAS DE COLORES:

üü¢ ENLACES FACTIBLES (${totalFactibles}):
  ‚Ä¢ Fibra √ìptica: ${estadisticas.factibles.verde}
  ‚Ä¢ Radio: ${estadisticas.factibles.azul}
  ‚Ä¢ Sat√©lite: ${estadisticas.factibles.morado}
  ‚Ä¢ Adquisici√≥n: ${estadisticas.factibles.naranja}

üî¥ ENLACES NO FACTIBLES (${totalNoFactibles}):
  ‚Ä¢ Distancia: ${estadisticas.noFactibles.rojo}
  ‚Ä¢ Antena: ${estadisticas.noFactibles.gris}
  ‚Ä¢ Otros: ${estadisticas.noFactibles.marron}

üìä TOTAL: ${estadisticas.total} enlaces
  `;
  
  console.log(mensaje);
  
  // Actualizar panel de estad√≠sticas si existe
  const panelEstadisticas = document.querySelector('.panel-estadisticas');
  if (panelEstadisticas) {
    const estadisticasHTML = `
      <div class="estadisticas-colores">
        <h4>üé® Estad√≠sticas por Color</h4>
        <div class="estadisticas-grid">
          <div class="estadistica-item verde">
            <span class="numero">${totalFactibles}</span>
            <span class="label">Factibles</span>
          </div>
          <div class="estadistica-item rojo">
            <span class="numero">${totalNoFactibles}</span>
            <span class="label">No Factibles</span>
          </div>
        </div>
      </div>
    `;
    
    const contenedorExistente = panelEstadisticas.querySelector('.estadisticas-colores');
    if (contenedorExistente) {
      contenedorExistente.innerHTML = estadisticasHTML;
    } else {
      panelEstadisticas.insertAdjacentHTML('beforeend', estadisticasHTML);
    }
  }
}
// ‚úÖ FUNCI√ìN PARA APLICAR FILTROS AVANZADOS
function aplicarFiltrosAvanzados() {
  const filtros = {
    factibles: document.getElementById('filtro-factibles')?.checked || false,
    noFactibles: document.getElementById('filtro-no-factibles')?.checked || false,
    fibra: document.getElementById('filtro-fibra')?.checked || false,
    radio: document.getElementById('filtro-radio')?.checked || false,
    satelite: document.getElementById('filtro-satelite')?.checked || false,
    adquisicion: document.getElementById('filtro-adquisicion')?.checked || false
  };
  
  console.log('üîç Aplicando filtros:', filtros);
  
  if (!window.mapaEnlaces) return;
  
  let enlacesVisibles = 0;
  let enlacesOcultos = 0;
  
  window.mapaEnlaces.eachLayer((layer) => {
    if (layer instanceof L.Polyline) {
      const enlaceId = layer.enlaceId || layer._enlaceId;
      
      if (enlaceId) {
        const infoEnlace = obtenerInformacionCompletaEnlace(enlaceId);
        const debeMostrar = evaluarFiltros(infoEnlace, filtros);
        
        if (debeMostrar) {
          layer.setStyle({ opacity: 0.8, weight: 4 });
          enlacesVisibles++;
        } else {
          layer.setStyle({ opacity: 0.1, weight: 1 });
          enlacesOcultos++;
        }
      }
    }
  });
  
  console.log(`ÔøΩÔøΩ Filtros aplicados: ${enlacesVisibles} visibles, ${enlacesOcultos} ocultos`);
  mostrarNotificacion(`ÔøΩÔøΩ Filtros aplicados: ${enlacesVisibles} enlaces visibles`);
}

// ‚úÖ FUNCI√ìN PARA EVALUAR FILTROS
function evaluarFiltros(infoEnlace, filtros) {
  // Si no hay filtros activos, mostrar todo
  if (!Object.values(filtros).some(f => f)) return true;
  
  // Evaluar filtros de factibilidad
  if (filtros.factibles && !infoEnlace.factible) return false;
  if (filtros.noFactibles && infoEnlace.factible) return false;
  
  // Evaluar filtros de tipo
  const tipoEnlace = infoEnlace.tipoEnlace.toString().toLowerCase();
  
  if (filtros.fibra && tipoEnlace.includes('fibra')) return true;
  if (filtros.radio && tipoEnlace.includes('radio')) return true;
  if (filtros.satelite && tipoEnlace.includes('sat√©lite')) return true;
  if (filtros.adquisicion && tipoEnlace.includes('adquisici√≥n')) return true;
  
  // Si hay filtros de tipo activos pero no coincide ninguno, ocultar
  if (filtros.fibra || filtros.radio || filtros.satelite || filtros.adquisicion) {
    return false;
  }
  
  return true;
}

function exportarKMZMismoTransporte() {
  console.log('üó∫Ô∏è Exportando KMZ solo para enlaces de mismo transporte FACTIBLES...');
  
  // ‚úÖ OBTENER ENLACES DE MISMO TRANSPORTE
  let enlacesMismoTransporte = [];
  
  // Verificar m√∫ltiples fuentes
  if (window.filasMismoTransporte && window.filasMismoTransporte.length > 0) {
    enlacesMismoTransporte = window.filasMismoTransporte;
    console.log('‚úÖ Encontrados en filasMismoTransporte:', enlacesMismoTransporte.length);
  } else if (window.enlacesMismoTransporte && window.enlacesMismoTransporte.length > 0) {
    enlacesMismoTransporte = window.enlacesMismoTransporte;
    console.log('‚úÖ Encontrados en enlacesMismoTransporte:', enlacesMismoTransporte.length);
  } else {
    // Intentar desde localStorage
    try {
      const enlacesGuardados = JSON.parse(localStorage.getItem('enlacesPtP') || '[]');
      enlacesMismoTransporte = enlacesGuardados.filter(enlace => {
        // Filtrar por tipo de transporte (columna 18 y 19)
        const transA = enlace[18]?.toString().toLowerCase() || '';
        const transB = enlace[19]?.toString().toLowerCase() || '';
        return transA && transB && transA === transB;
      });
      console.log('‚úÖ Encontrados en localStorage filtrados:', enlacesMismoTransporte.length);
    } catch (e) {
      console.error('Error al leer localStorage:', e);
    }
  }
  
  if (enlacesMismoTransporte.length === 0) {
    alert('‚ùå No hay enlaces de mismo transporte para exportar\n\nVerifica que:\n1. Hayas procesado pares con mismo transporte\n2. El bot√≥n "Permitir mismo transporte" est√© activado\n3. Haya enlaces en la tabla de mismo transporte');
    return;
  }
  
  console.log(`üìä Total de enlaces de mismo transporte: ${enlacesMismoTransporte.length}`);
  
  // ‚úÖ FILTRAR SOLO LOS FACTIBLES
  const enlacesFactibles = enlacesMismoTransporte.filter(fila => {
    const estadoFactible = fila[30]?.toString().trim().toUpperCase() || '';
    const esFactible = estadoFactible.includes('FACTIBLE') || 
                      estadoFactible === 'S√ç' || 
                      estadoFactible === 'SI' || 
                      estadoFactible === 'YES';
    
    console.log(`ÔøΩÔøΩ Enlace ${fila[0]}-${fila[6]}: Estado="${estadoFactible}" ‚Üí Factible: ${esFactible}`);
    return esFactible;
  });
  
  console.log(`üìä Enlaces de mismo transporte factibles: ${enlacesFactibles.length}`);
  
  if (enlacesFactibles.length === 0) {
    alert('‚ùå No hay enlaces de mismo transporte FACTIBLES para exportar\n\nTodos los enlaces de mismo transporte son NO factibles.');
    return;
  }
  
  // ‚úÖ CONVERTIR A FORMATO DE ENLACES (SOLO FACTIBLES)
  const enlacesFormateados = enlacesFactibles.map((fila, index) => ({
    idA: fila[0] || `Sitio_${index}`,
    nombreA: fila[1] || 'Sin nombre',
    latA: parseFloat(fila[2]) || 0,
    lonA: parseFloat(fila[3]) || 0,
    idB: fila[6] || `Sitio_${index}_B`,
    nombreB: fila[7] || 'Sin nombre B',
    latB: parseFloat(fila[8]) || 0,
    lonB: parseFloat(fila[9]) || 0,
    distancia: fila[12] || 'N/A',
    tipoEnlace: fila[13] || 'N/A',
    factible: 'S√ç', // ‚úÖ TODOS SON FACTIBLES (ya filtramos)
    colorMapa: '#10b981' // ‚úÖ TODOS VERDES (ya filtramos)
  }));
  
  // ‚úÖ EXPORTAR KMZ SOLO CON FACTIBLES
  mostrarNotificacion(`‚úÖ Generando KMZ con ${enlacesFormateados.length} enlaces de mismo transporte FACTIBLES...`);
  crearArchivoKMZConColoresReales(enlacesFormateados);
}
</script>
  <div class="footer">
    &copy; 2025 Fangio Telecom | Realizado por: Efren Alexis Hernandez Mendez | Tel: (55) 1234-5678
  </div>

  </div>
</div>
<!-- Modal de Street View -->
<div id="modalStreetView" class="modal-streetview">
  <div class="modal-content">
    <div class="modal-header">
      <h3><i class="fas fa-street-view"></i> Street View</h3>
      <button class="close-btn" onclick="cerrarStreetView()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="streetview-panorama"></div>
  </div>
</div>
</body>

</body>
</html>
           
