<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fangio Telecom - Gestor de Enlaces PtP con An√°lisis de Factibilidad</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link rel="icon" type="image/png" href="img/favicon-32x32-light.png" sizes="32x32">
  <link rel="icon" type="image/png" href="img/favicon-32x32-light.png" sizes="32x32" media="(prefers-color-scheme: light)">
  <link rel="icon" type="image/png" href="img/favicon-32x32-dark.png" sizes="32x32" media="(prefers-color-scheme: dark)">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <!-- ==================== FUNCIONES GLOBALES DE SCROLL ==================== -->
  <script>
  // Funci√≥n simple para scroll derecha
  window.scrollDerecha = function() {
      const tabla = document.getElementById('tabla');
      if (tabla) {
          // M√©todo 1: Intentar con la tabla
          tabla.style.overflowX = 'auto';
          tabla.style.width = 'max-content';
          tabla.scrollLeft += 500;
          console.log('‚û°Ô∏è Scroll derecha tabla - Posici√≥n:', tabla.scrollLeft);
          
          // M√©todo 2: Si no funciona, usar el contenedor padre
          if (tabla.scrollLeft === 0) {
              const contenedor = tabla.parentElement;
              if (contenedor) {
                  contenedor.style.overflowX = 'auto';
                  contenedor.scrollLeft += 500;
                  console.log('‚û°Ô∏è Scroll derecha contenedor - Posici√≥n:', contenedor.scrollLeft);
              }
          }
      }
  };
  
  // Funci√≥n simple para scroll izquierda
  window.scrollIzquierda = function() {
      const tabla = document.getElementById('tabla');
      if (tabla) {
          // M√©todo 1: Intentar con la tabla
          tabla.style.overflowX = 'auto';
          tabla.style.width = 'max-content';
          tabla.scrollLeft -= 500;
          console.log('‚¨ÖÔ∏è Scroll izquierda tabla - Posici√≥n:', tabla.scrollLeft);
          
          // M√©todo 2: Si no funciona, usar el contenedor padre
          if (tabla.scrollLeft === 0) {
              const contenedor = tabla.parentElement;
              if (contenedor) {
                  contenedor.style.overflowX = 'auto';
                  contenedor.scrollLeft -= 500;
                  console.log('‚¨ÖÔ∏è Scroll izquierda contenedor - Posici√≥n:', contenedor.scrollLeft);
              }
          }
      }
  };
  
  // Funci√≥n para ir al final
  window.irAlFinal = function() {
      const tabla = document.getElementById('tabla');
      if (tabla) {
          // M√©todo 1: Intentar con la tabla
          tabla.style.overflowX = 'auto';
          tabla.style.width = 'max-content';
          tabla.scrollLeft = tabla.scrollWidth;
          console.log('üéØ Yendo al final tabla - Posici√≥n:', tabla.scrollLeft);
          
          // M√©todo 2: Si no funciona, usar el contenedor padre
          if (tabla.scrollLeft === 0) {
              const contenedor = tabla.parentElement;
              if (contenedor) {
                  contenedor.style.overflowX = 'auto';
                  contenedor.scrollLeft = contenedor.scrollWidth;
                  console.log('üéØ Yendo al final contenedor - Posici√≥n:', contenedor.scrollLeft);
              }
          }
      }
  };
  
  // Funci√≥n para buscar y hacer scroll en cualquier contenedor
  window.scrollEnCualquierContenedor = function(direccion = 'derecha') {
      console.log('üîç Buscando contenedores para scroll...');
      
      // Buscar la tabla
      const tabla = document.getElementById('tabla');
      if (tabla) {
          console.log('üìä Tabla encontrada');
          console.log('  - scrollWidth:', tabla.scrollWidth);
          console.log('  - clientWidth:', tabla.clientWidth);
          console.log('  - ¬øPuede scroll?:', tabla.scrollWidth > tabla.clientWidth);
          
          // Forzar estilos para habilitar scroll
          tabla.style.overflowX = 'auto';
          tabla.style.width = 'max-content';
          tabla.style.minWidth = '100%';
          
          // Forzar rec√°lculo
          tabla.offsetHeight;
          
          console.log('  - Despu√©s de forzar estilos:');
          console.log('    - scrollWidth:', tabla.scrollWidth);
          console.log('    - clientWidth:', tabla.clientWidth);
          console.log('    - ¬øPuede scroll?:', tabla.scrollWidth > tabla.clientWidth);
          
          // Intentar scroll en la tabla primero
          if (tabla.scrollWidth > tabla.clientWidth) {
              console.log('‚úÖ Tabla puede hacer scroll');
              
              if (direccion === 'derecha') {
                  tabla.scrollLeft += 500;
                  console.log(`‚û°Ô∏è Scroll derecha en tabla - Posici√≥n:`, tabla.scrollLeft);
                  return true;
              } else if (direccion === 'izquierda') {
                  tabla.scrollLeft -= 500;
                  console.log(`‚¨ÖÔ∏è Scroll izquierda en tabla - Posici√≥n:`, tabla.scrollLeft);
                  return true;
              } else if (direccion === 'final') {
                  tabla.scrollLeft = tabla.scrollWidth;
                  console.log(`üéØ Scroll al final en tabla - Posici√≥n:`, tabla.scrollLeft);
                  return true;
              }
          }
      }
      
      // Buscar contenedores padres
      let contenedor = tabla?.parentElement;
      let nivel = 1;
      
      while (contenedor && nivel <= 5) {
          console.log(`üîç Contenedor nivel ${nivel}:`, contenedor.tagName, contenedor.className);
          console.log(`  - scrollWidth: ${contenedor.scrollWidth}, clientWidth: ${contenedor.clientWidth}`);
          
          // Forzar estilos en contenedores padres
          contenedor.style.overflowX = 'auto';
          
          if (contenedor.scrollWidth > contenedor.clientWidth) {
              console.log(`‚úÖ Contenedor nivel ${nivel} puede hacer scroll`);
              
              if (direccion === 'derecha') {
                  contenedor.scrollLeft += 500;
                  console.log(`‚û°Ô∏è Scroll derecha en contenedor nivel ${nivel} - Posici√≥n:`, contenedor.scrollLeft);
              } else if (direccion === 'izquierda') {
                  contenedor.scrollLeft -= 500;
                  console.log(`‚¨ÖÔ∏è Scroll izquierda en contenedor nivel ${nivel} - Posici√≥n:`, contenedor.scrollLeft);
              } else if (direccion === 'final') {
                  contenedor.scrollLeft = contenedor.scrollWidth;
                  console.log(`üéØ Scroll al final en contenedor nivel ${nivel} - Posici√≥n:`, contenedor.scrollLeft);
              }
              
              return true;
          }
          
          contenedor = contenedor.parentElement;
          nivel++;
      }
      
      console.log('‚ùå No se encontr√≥ ning√∫n contenedor con scroll horizontal');
      return false;
  };
  
  // ==================== FUNCIONES DE MAPA DEFINIDAS INMEDIATAMENTE ====================
  console.log('üöÄ Definindo funciones de mapa INMEDIATAMENTE...');
  
  // Funci√≥n simple para crear mapa b√°sico
  window.crearMapaBasico = function() {
    console.log('üó∫Ô∏è Creando mapa b√°sico...');
    
    try {
      // Verificar Leaflet
      if (typeof L === 'undefined') {
        console.error('‚ùå Leaflet no disponible');
        alert('‚ùå Leaflet no disponible');
        return;
      }
      
      // Verificar elemento del mapa
      const divMapa = document.getElementById('mapa-enlaces');
      if (!divMapa) {
        console.error('‚ùå Elemento mapa-enlaces no encontrado');
        alert('‚ùå Elemento del mapa no encontrado');
        return;
      }
      
      // Limpiar mapa existente
      if (window.mapaEnlaces) {
        window.mapaEnlaces.remove();
      }
      
      // Crear mapa simple
      const mapa = L.map('mapa-enlaces').setView([23.6345, -102.5528], 5.2);
      window.mapaEnlaces = mapa;
      
      // Agregar capa de tiles
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
      }).addTo(mapa);
      
      // Agregar marcador de prueba
      L.marker([23.6345, -102.5528]).addTo(mapa)
        .bindPopup('üß™ Mapa b√°sico funcionando')
        .openPopup();
      
      console.log('‚úÖ Mapa b√°sico creado exitosamente');
      alert('‚úÖ Mapa b√°sico creado exitosamente');
      
    } catch (error) {
      console.error('‚ùå Error al crear mapa b√°sico:', error);
      alert('‚ùå Error al crear mapa b√°sico: ' + error.message);
    }
  };
  
  // Funci√≥n para crear mapa con enlaces
  window.crearMapaConEnlaces = function() {
    console.log('üó∫Ô∏è Creando mapa con enlaces profesionales...');
    
    try {
      // Verificar Leaflet
      if (typeof L === 'undefined') {
        console.error('‚ùå Leaflet no disponible');
        alert('‚ùå Leaflet no disponible');
        return;
      }
      
      // Verificar elemento del mapa
      const divMapa = document.getElementById('mapa-enlaces');
      if (!divMapa) {
        console.error('‚ùå Elemento mapa-enlaces no encontrado');
        alert('‚ùå Elemento del mapa no encontrado');
        return;
      }
      
      // Limpiar mapa existente
      if (window.mapaEnlaces) {
        window.mapaEnlaces.remove();
      }
      
      // Crear mapa con estilo profesional
      const mapa = L.map('mapa-enlaces').setView([23.6345, -102.5528], 5.2);
      window.mapaEnlaces = mapa;
      
      // Agregar capa de tiles profesional
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors | Fangio Telecom',
        maxZoom: 18
      }).addTo(mapa);
      
      // Crear icono personalizado para torres
      const iconoTorre = L.divIcon({
        html: '<div style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); width: 20px; height: 20px; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); border: 2px solid #ffffff; box-shadow: 0 2px 8px rgba(0,0,0,0.3); position: relative;"><div style="position: absolute; top: -8px; left: 6px; color: white; font-size: 12px; font-weight: bold; transform: rotate(45deg);">üì°</div></div>',
        className: 'torre-icon',
        iconSize: [20, 20],
        iconAnchor: [10, 10]
      });
      
                // Agregar enlaces de la tabla
          const filas = document.querySelectorAll('#tabla tbody tr');
          console.log('üìã Procesando', filas.length, 'enlaces profesionales...');
          
          let enlacesAgregados = 0;
          let bounds = L.latLngBounds();
          
          filas.forEach((fila, index) => {
            const celdas = fila.querySelectorAll('td');
            const latA = parseFloat(celdas[3]?.textContent.replace(',', '.'));
            const lonA = parseFloat(celdas[4]?.textContent.replace(',', '.'));
            const latB = parseFloat(celdas[9]?.textContent.replace(',', '.'));
            const lonB = parseFloat(celdas[10]?.textContent.replace(',', '.'));
            
            if (!isNaN(latA) && !isNaN(lonA) && !isNaN(latB) && !isNaN(lonB)) {
              // Calcular distancia
              const distancia = calcularDistancia(latA, lonA, latB, lonB);
              
              // Buscar alturas correctas - L√≥gica mejorada
              let alturaA = null;
              let alturaB = null;
              
              // Usar las columnas espec√≠ficas donde est√°n las alturas (15 y 16)
              const alturaACelda = celdas[16]?.textContent?.trim();
              const alturaBCelda = celdas[17]?.textContent?.trim();
              
              if (alturaACelda && !isNaN(parseFloat(alturaACelda))) {
                alturaA = parseFloat(alturaACelda);
              }
              
              if (alturaBCelda && !isNaN(parseFloat(alturaBCelda))) {
                alturaB = parseFloat(alturaBCelda);
              }
              
              // Si no se encontraron alturas en las columnas espec√≠ficas, buscar en otras columnas
              if (!alturaA || !alturaB) {
                for (let i = 0; i < celdas.length; i++) {
                  const valor = celdas[i]?.textContent?.trim();
                  if (valor && !isNaN(parseFloat(valor.replace(',', '.')))) {
                    const altura = parseFloat(valor.replace(',', '.'));
                    // Verificar que sea una altura realista (entre 10 y 200 metros)
                    if (altura >= 10 && altura <= 200) {
                      // Verificar que no sea una coordenada (muchos decimales)
                      const esCoordenada = valor.includes('.') && valor.split('.')[1] && valor.split('.')[1].length > 4;
                      if (!esCoordenada) {
                        if (i < 6 && !alturaA) { // Columnas de la torre A
                          alturaA = altura;
                        } else if (i >= 6 && i < 12 && !alturaB) { // Columnas de la torre B
                          alturaB = altura;
                        }
                      }
                    }
                  }
                }
              }
              
              // Si no se encontraron alturas realistas, usar valores por defecto
              if (!alturaA) alturaA = 45; // Altura t√≠pica de torre
              if (!alturaB) alturaB = 45; // Altura t√≠pica de torre
              
              console.log(`üèóÔ∏è Enlace ${index + 1} - Alturas: Torre A: ${alturaA}m, Torre B: ${alturaB}m`);
              
              // Determinar color basado en factibilidad - L√≥gica mejorada
              const textoFactibilidad = celdas[30]?.textContent?.toLowerCase() || '';
              const estadoA = celdas[28]?.textContent?.toLowerCase() || '';
              const estadoB = celdas[29]?.textContent?.toLowerCase() || '';
              
              console.log(`üîç Analizando factibilidad para enlace ${index + 1}:`);
              console.log(`  - Factibilidad: "${textoFactibilidad}"`);
              console.log(`  - ESTADO A: "${estadoA}"`);
              console.log(`  - ESTADO B: "${estadoB}"`);
              
              // CORRECCI√ìN: Si ESTADO A es "no factible", usar ESTADO B
              let estadoACorregido = estadoA;
              if (estadoA === 'no factible' && estadoB && estadoB !== 'no factible') {
                estadoACorregido = estadoB;
                // Corregir tambi√©n en la tabla
                celdas[2].textContent = celdas[3].textContent;
                console.log(`‚úÖ Enlace ${index + 1} corregido en mapa: ESTADO A "No Factible" ‚Üí "${estadoB}"`);
              }
              
              // L√≥gica m√°s robusta para detectar factibilidad
              const esFactible = textoFactibilidad.includes('factible') || 
                                textoFactibilidad.includes('viable') || 
                                textoFactibilidad.includes('posible') ||
                                textoFactibilidad.includes('s√≠') ||
                                textoFactibilidad.includes('yes') ||
                                textoFactibilidad.includes('true') ||
                                textoFactibilidad.includes('1') ||
                                // Estados mexicanos son factibles por defecto
                                estadoACorregido.includes('baja california') ||
                                estadoACorregido.includes('sonora') ||
                                estadoACorregido.includes('chihuahua') ||
                                estadoACorregido.includes('coahuila') ||
                                estadoACorregido.includes('nuevo le√≥n') ||
                                estadoACorregido.includes('tamaulipas') ||
                                estadoACorregido.includes('sinaloa') ||
                                estadoACorregido.includes('durango') ||
                                estadoACorregido.includes('zacatecas') ||
                                estadoACorregido.includes('san luis potos√≠') ||
                                estadoACorregido.includes('jalisco') ||
                                estadoACorregido.includes('aguascalientes') ||
                                estadoACorregido.includes('guanajuato') ||
                                estadoACorregido.includes('quer√©taro') ||
                                estadoACorregido.includes('hidalgo') ||
                                estadoACorregido.includes('puebla') ||
                                estadoACorregido.includes('veracruz') ||
                                estadoACorregido.includes('tabasco') ||
                                estadoACorregido.includes('campeche') ||
                                estadoACorregido.includes('yucat√°n') ||
                                estadoACorregido.includes('quintana roo') ||
                                estadoACorregido.includes('chiapas') ||
                                estadoACorregido.includes('oaxaca') ||
                                estadoACorregido.includes('guerrero') ||
                                estadoACorregido.includes('morelos') ||
                                estadoACorregido.includes('m√©xico') ||
                                estadoACorregido.includes('michoac√°n') ||
                                estadoACorregido.includes('colima') ||
                                estadoACorregido.includes('nayarit') ||
                                estadoACorregido.includes('tlaxcala') ||
                                // Tambi√©n verificar en la columna de factibilidad
                                textoFactibilidad.includes('baja california') ||
                                textoFactibilidad.includes('sonora') ||
                                textoFactibilidad.includes('chihuahua') ||
                                textoFactibilidad.includes('coahuila') ||
                                textoFactibilidad.includes('nuevo le√≥n') ||
                                textoFactibilidad.includes('tamaulipas') ||
                                textoFactibilidad.includes('sinaloa') ||
                                textoFactibilidad.includes('durango') ||
                                textoFactibilidad.includes('zacatecas') ||
                                textoFactibilidad.includes('san luis potos√≠') ||
                                textoFactibilidad.includes('jalisco') ||
                                textoFactibilidad.includes('aguascalientes') ||
                                textoFactibilidad.includes('guanajuato') ||
                                textoFactibilidad.includes('quer√©taro') ||
                                textoFactibilidad.includes('hidalgo') ||
                                textoFactibilidad.includes('puebla') ||
                                textoFactibilidad.includes('veracruz') ||
                                textoFactibilidad.includes('tabasco') ||
                                textoFactibilidad.includes('campeche') ||
                                textoFactibilidad.includes('yucat√°n') ||
                                textoFactibilidad.includes('quintana roo') ||
                                textoFactibilidad.includes('chiapas') ||
                                textoFactibilidad.includes('oaxaca') ||
                                textoFactibilidad.includes('guerrero') ||
                                textoFactibilidad.includes('morelos') ||
                                textoFactibilidad.includes('m√©xico') ||
                                textoFactibilidad.includes('michoac√°n') ||
                                textoFactibilidad.includes('colima') ||
                                textoFactibilidad.includes('nayarit') ||
                                textoFactibilidad.includes('tlaxcala');
              
              // L√≥gica para detectar NO factible
              const esNoFactible = textoFactibilidad.includes('no factible') || 
                                  textoFactibilidad.includes('no viable') || 
                                  textoFactibilidad.includes('no posible') ||
                                  textoFactibilidad.includes('false') ||
                                  textoFactibilidad.includes('0');
              
                            // Determinar factibilidad final - L√ìGICA SIMPLIFICADA
              let factibilidadFinal;
              
              // Debug: mostrar informaci√≥n de factibilidad
              console.log(`üîç Enlace ${index + 1} - Debug factibilidad:`);
              console.log(`  - Texto original: "${textoFactibilidad}"`);
              console.log(`  - esFactible: ${esFactible}`);
              console.log(`  - esNoFactible: ${esNoFactible}`);
              
              // L√ìGICA MEJORADA: Reconocer valores espec√≠ficos de la tabla
              if (textoFactibilidad.includes('no factible') || 
                  textoFactibilidad.includes('no viable') || 
                  textoFactibilidad.includes('no posible') ||
                  textoFactibilidad.includes('false') ||
                  textoFactibilidad.includes('0')) {
                factibilidadFinal = false;
                console.log(`  - Caso: expl√≠citamente NO factible ‚Üí NO FACTIBLE`);
              } else if (textoFactibilidad.includes('factible') || 
                         textoFactibilidad.includes('s√≠') || 
                         textoFactibilidad.includes('yes') ||
                         textoFactibilidad.includes('true') ||
                         textoFactibilidad.includes('1')) {
                factibilidadFinal = true;
                console.log(`  - Caso: expl√≠citamente factible ‚Üí FACTIBLE`);
              } else {
                factibilidadFinal = true; // Por defecto factible
                console.log(`  - Caso: por defecto ‚Üí FACTIBLE`);
              }
              
              console.log(`‚úÖ Enlace ${index + 1} - Factibilidad final: ${factibilidadFinal ? 'FACTIBLE' : 'NO FACTIBLE'}`);
              
              const colorLinea = factibilidadFinal ? '#10b981' : '#ef4444';
              const grosorLinea = factibilidadFinal ? 4 : 3;
          
          // Crear l√≠nea del enlace con estilo profesional
          const poly = L.polyline([[latA, lonA], [latB, lonB]], {
            color: colorLinea,
            weight: grosorLinea,
            opacity: 0.8,
            dashArray: factibilidadFinal ? null : '10, 5'
          }).addTo(mapa);
          
          // Agregar popup a la l√≠nea
          const popupContenido = `
            <div style="min-width: 250px; font-family: 'Inter', sans-serif;">
              <h3 style="margin: 0 0 10px 0; color: #1f2937; border-bottom: 2px solid ${colorLinea}; padding-bottom: 5px;">
                üîó Enlace ${index + 1}
              </h3>
                              <div style="margin-bottom: 8px;">
                  <strong>üèóÔ∏è Torre A:</strong> ${celdas[2]?.textContent || 'N/A'}<br>
                  <strong>üìç Coordenadas:</strong> ${latA.toFixed(6)}, ${lonA.toFixed(6)}<br>
                  <strong>üìè Altura:</strong> ${alturaA} m
                </div>
                <div style="margin-bottom: 8px;">
                  <strong>üèóÔ∏è Torre B:</strong> ${celdas[8]?.textContent || 'N/A'}<br>
                  <strong>üìç Coordenadas:</strong> ${latB.toFixed(6)}, ${lonB.toFixed(6)}<br>
                  <strong>üìè Altura:</strong> ${alturaB} m
                </div>
                              <div style="margin-bottom: 8px;">
                  <strong>üìê Distancia:</strong> ${distancia.toFixed(2)} km<br>
                  <strong>üìä Estado:</strong> 
                  <span style="color: ${factibilidadFinal ? '#10b981' : '#ef4444'}; font-weight: bold;">
                    ${factibilidadFinal ? '‚úÖ FACTIBLE' : '‚ùå NO FACTIBLE'}
                  </span>
                  <br><small style="color: #6b7280; font-size: 10px;">Texto original: "${celdas[30]?.textContent || 'N/A'}"</small>
                </div>
              <button onclick="irAPerfilElevacionDesdeMapa('${celdas[2]?.textContent || ''}', '${celdas[8]?.textContent || ''}', ${latA}, ${lonA}, ${latB}, ${lonB}, ${alturaA}, ${alturaB})" 
                      style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px; margin-top: 5px;">
                üìä Ver Perfil de Elevaci√≥n
              </button>
            </div>
          `;
          
          poly.bindPopup(popupContenido);
          
          // Agregar marcadores de torres con iconos personalizados
          const marcadorA = L.marker([latA, lonA], { icon: iconoTorre }).addTo(mapa);
          const marcadorB = L.marker([latB, lonB], { icon: iconoTorre }).addTo(mapa);
          
                     // Popups para las torres
           const popupTorreA = `
             <div style="min-width: 200px; font-family: 'Inter', sans-serif;">
               <h3 style="margin: 0 0 8px 0; color: #1f2937;">üèóÔ∏è ${celdas[2]?.textContent || 'Torre A'}</h3>
               <div style="margin-bottom: 5px;">
                 <strong>üÜî ID:</strong> ${celdas[1]?.textContent || 'N/A'}<br>
                 <strong>üìç Lat:</strong> ${latA.toFixed(6)}<br>
                 <strong>üìç Lon:</strong> ${lonA.toFixed(6)}<br>
                 <strong>üìè Altura:</strong> ${alturaA} m
               </div>
               <div style="font-size: 11px; color: #6b7280; margin-top: 8px;">
                 üì° Estaci√≥n de Telecomunicaciones
               </div>
             </div>
           `;
           
           const popupTorreB = `
             <div style="min-width: 200px; font-family: 'Inter', sans-serif;">
               <h3 style="margin: 0 0 8px 0; color: #1f2937;">üèóÔ∏è ${celdas[8]?.textContent || 'Torre B'}</h3>
               <div style="margin-bottom: 5px;">
                 <strong>üÜî ID:</strong> ${celdas[7]?.textContent || 'N/A'}<br>
                 <strong>üìç Lat:</strong> ${latB.toFixed(6)}<br>
                 <strong>üìç Lon:</strong> ${lonB.toFixed(6)}<br>
                 <strong>üìè Altura:</strong> ${alturaB} m
               </div>
               <div style="font-size: 11px; color: #6b7280; margin-top: 8px;">
                 üì° Estaci√≥n de Telecomunicaciones
               </div>
             </div>
           `;
          
          marcadorA.bindPopup(popupTorreA);
          marcadorB.bindPopup(popupTorreB);
          
          // Agregar a bounds para centrar el mapa
          bounds.extend([latA, lonA]);
          bounds.extend([latB, lonB]);
          
          enlacesAgregados++;
          console.log(`‚úÖ Enlace ${index + 1} agregado: ${celdas[2]?.textContent} ‚Üí ${celdas[8]?.textContent} (${distancia.toFixed(2)} km)`);
        }
      });
      
      // Centrar mapa en los enlaces
      if (enlacesAgregados > 0) {
        mapa.fitBounds(bounds, { padding: [20, 20] });
      }
      
      // Agregar leyenda
      const leyenda = L.control({ position: 'bottomright' });
      leyenda.onAdd = function() {
        const div = L.DomUtil.create('div', 'info legend');
        div.style.backgroundColor = 'white';
        div.style.padding = '10px';
        div.style.borderRadius = '8px';
        div.style.boxShadow = '0 2px 10px rgba(0,0,0,0.1)';
        div.style.fontFamily = "'Inter', sans-serif";
        div.style.fontSize = '12px';
        div.innerHTML = `
          <h4 style="margin: 0 0 8px 0; color: #1f2937;">üó∫Ô∏è Leyenda</h4>
          <div style="margin-bottom: 5px;">
            <span style="display: inline-block; width: 20px; height: 20px; background: linear-gradient(135deg, #3b82f6, #1d4ed8); border-radius: 50% 50% 50% 0; transform: rotate(-45deg); border: 2px solid #ffffff; position: relative; margin-right: 8px;">
              <span style="position: absolute; top: -8px; left: 6px; color: white; font-size: 8px; transform: rotate(45deg);">üì°</span>
            </span>
            Torres de Telecomunicaciones
          </div>
          <div style="margin-bottom: 5px;">
            <span style="display: inline-block; width: 15px; height: 3px; background: #10b981; margin-right: 8px;"></span>
            Enlaces Factibles
          </div>
          <div style="margin-bottom: 5px;">
            <span style="display: inline-block; width: 15px; height: 3px; background: #ef4444; margin-right: 8px; border-top: 2px dashed #ef4444;"></span>
            Enlaces No Factibles
          </div>
          <div style="font-size: 10px; color: #6b7280; margin-top: 8px;">
            Total: ${enlacesAgregados} enlaces
          </div>
        `;
        return div;
      };
      leyenda.addTo(mapa);
      
      console.log('‚úÖ Mapa profesional con enlaces creado exitosamente');
      
      // CORRECCI√ìN AUTOM√ÅTICA: Corregir ESTADO A despu√©s de crear el mapa
      setTimeout(() => {
        console.log('üîß Aplicando correcci√≥n autom√°tica de ESTADO A despu√©s de crear mapa...');
        const filas = document.querySelectorAll('#tabla tbody tr');
        let corregidos = 0;
        
        filas.forEach((fila, index) => {
          const celdas = fila.querySelectorAll('td');
          const estadoA = celdas[2]?.textContent?.trim() || '';
          const estadoB = celdas[3]?.textContent?.trim() || '';
          
          if (estadoA === 'No Factible' && estadoB && estadoB !== 'No Factible') {
            celdas[2].textContent = estadoB;
            corregidos++;
            console.log(`‚úÖ Enlace ${index + 1} corregido autom√°ticamente: ESTADO A "No Factible" ‚Üí "${estadoB}"`);
          }
        });
        
        console.log(`‚úÖ Correcci√≥n autom√°tica completada: ${corregidos} enlaces corregidos`);
      }, 1000);
      
      alert(`‚úÖ Mapa profesional creado con ${enlacesAgregados} enlaces`);
      
    } catch (error) {
      console.error('‚ùå Error al crear mapa con enlaces:', error);
      alert('‚ùå Error al crear mapa con enlaces: ' + error.message);
    }
  };
  
  // Funci√≥n para calcular distancia entre dos puntos
  function calcularDistancia(lat1, lon1, lat2, lon2) {
    const R = 6371; // Radio de la Tierra en km
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }
  
  // Funci√≥n para diagnosticar factibilidad de enlaces
  window.diagnosticarFactibilidad = function() {
    console.log('üîç DIAGN√ìSTICO DE FACTIBILIDAD DE ENLACES');
    
    const filas = document.querySelectorAll('#tabla tbody tr');
    console.log(`üìã Analizando ${filas.length} enlaces...`);
    
    filas.forEach((fila, index) => {
      const celdas = fila.querySelectorAll('td');
      const textoFactibilidad = celdas[12]?.textContent || '';
      const textoLimpio = textoFactibilidad.toLowerCase().trim();
      
      console.log(`Enlace ${index + 1}:`);
      console.log(`  - ESTADO A: "${celdas[2]?.textContent}"`);
      console.log(`  - ESTADO B: "${celdas[3]?.textContent}"`);
      console.log(`  - Texto original: "${textoFactibilidad}"`);
      console.log(`  - Texto limpio: "${textoLimpio}"`);
      console.log(`  - ¬øContiene 'factible'?: ${textoLimpio.includes('factible')}`);
      console.log(`  - ¬øContiene 'viable'?: ${textoLimpio.includes('viable')}`);
      console.log(`  - ¬øContiene 's√≠'?: ${textoLimpio.includes('s√≠')}`);
      console.log(`  - ¬øContiene 'no factible'?: ${textoLimpio.includes('no factible')}`);
      console.log(`  - ¬øContiene 'no'?: ${textoLimpio.includes('no')}`);
      console.log(`  - ¬øEst√° vac√≠o?: ${textoLimpio === ''}`);
      
      // Aplicar la misma l√≥gica del mapa
      const esFactible = textoLimpio.includes('factible') || 
                        textoLimpio.includes('viable') || 
                        textoLimpio.includes('posible') ||
                        textoLimpio.includes('s√≠') ||
                        textoLimpio.includes('yes') ||
                        textoLimpio.includes('true') ||
                        textoLimpio.includes('1') ||
                        // Estados mexicanos son factibles por defecto
                        textoLimpio.includes('baja california') ||
                        textoLimpio.includes('sonora') ||
                        textoLimpio.includes('chihuahua') ||
                        textoLimpio.includes('coahuila') ||
                        textoLimpio.includes('nuevo le√≥n') ||
                        textoLimpio.includes('tamaulipas') ||
                        textoLimpio.includes('sinaloa') ||
                        textoLimpio.includes('durango') ||
                        textoLimpio.includes('zacatecas') ||
                        textoLimpio.includes('san luis potos√≠') ||
                        textoLimpio.includes('jalisco') ||
                        textoLimpio.includes('aguascalientes') ||
                        textoLimpio.includes('guanajuato') ||
                        textoLimpio.includes('quer√©taro') ||
                        textoLimpio.includes('hidalgo') ||
                        textoLimpio.includes('puebla') ||
                        textoLimpio.includes('veracruz') ||
                        textoLimpio.includes('tabasco') ||
                        textoLimpio.includes('campeche') ||
                        textoLimpio.includes('yucat√°n') ||
                        textoLimpio.includes('quintana roo') ||
                        textoLimpio.includes('chiapas') ||
                        textoLimpio.includes('oaxaca') ||
                        textoLimpio.includes('guerrero') ||
                        textoLimpio.includes('morelos') ||
                        textoLimpio.includes('m√©xico') ||
                        textoLimpio.includes('michoac√°n') ||
                        textoLimpio.includes('colima') ||
                        textoLimpio.includes('nayarit') ||
                        textoLimpio.includes('tlaxcala');
      
      // L√≥gica para detectar NO factible
      const esNoFactible = textoLimpio.includes('no factible') || 
                          textoLimpio.includes('no viable') || 
                          textoLimpio.includes('no posible') ||
                          textoLimpio.includes('no') ||
                          textoLimpio.includes('false') ||
                          textoLimpio.includes('0');
      
      // Determinar factibilidad final
      let factibilidadFinal;
      if (textoLimpio === '') {
        factibilidadFinal = true; // Por defecto factible si no hay texto
      } else if (esNoFactible) {
        factibilidadFinal = false; // Expl√≠citamente no factible
      } else if (esFactible) {
        factibilidadFinal = true; // Expl√≠citamente factible
      } else {
        factibilidadFinal = true; // Por defecto factible si no se especifica
      }
      
      console.log(`  - Resultado final: ${factibilidadFinal ? '‚úÖ FACTIBLE' : '‚ùå NO FACTIBLE'}`);
      console.log('---');
    });
    
    alert('üîç Diagn√≥stico completado. Revisa la consola para ver los detalles.');
  };
  
  // Funci√≥n para diagnosticar alturas de torres
  window.diagnosticarAlturas = function() {
    console.log('üèóÔ∏è DIAGN√ìSTICO DE ALTURAS DE TORRES');
    
    const filas = document.querySelectorAll('#tabla tbody tr');
    console.log(`üìã Analizando ${filas.length} enlaces...`);
    
    filas.forEach((fila, index) => {
      const celdas = fila.querySelectorAll('td');
      
      console.log(`Enlace ${index + 1}:`);
      console.log(`  - Torre A: ${celdas[16]?.textContent || 'N/A'}`);
      console.log(`  - Torre B: ${celdas[17]?.textContent || 'N/A'}`);
      
      // Mostrar todas las columnas con valores num√©ricos
      console.log('  - Valores num√©ricos encontrados:');
      for (let i = 0; i < celdas.length; i++) {
        const valor = celdas[i]?.textContent?.trim();
        if (valor && !isNaN(parseFloat(valor.replace(',', '.')))) {
          const numero = parseFloat(valor.replace(',', '.'));
          console.log(`    Columna ${i}: ${valor} (${numero})`);
          
          // Marcar si es una altura realista
          if (numero >= 10 && numero <= 200) {
            console.log(`    ‚úÖ Posible altura realista: ${numero}m en columna ${i}`);
          } else if (numero > 0 && numero < 10) {
            console.log(`    ‚ö†Ô∏è Posible altura en metros pero muy baja: ${numero}m en columna ${i}`);
          } else if (numero > 200) {
            console.log(`    ‚ö†Ô∏è Posible altura en metros pero muy alta: ${numero}m en columna ${i}`);
          }
        }
      }
      
      // Aplicar la misma l√≥gica del mapa
      let alturaA = null;
      let alturaB = null;
      
      for (let i = 0; i < celdas.length; i++) {
        const valor = celdas[i]?.textContent?.trim();
        if (valor && !isNaN(parseFloat(valor.replace(',', '.')))) {
          const altura = parseFloat(valor.replace(',', '.'));
          if (altura >= 10 && altura <= 200) {
            if (i < 6) {
              if (!alturaA) alturaA = altura;
            } else if (i >= 6 && i < 12) {
              if (!alturaB) alturaB = altura;
            }
          }
        }
      }
      
      if (!alturaA) alturaA = 45;
      if (!alturaB) alturaB = 45;
      
      console.log(`  - Alturas detectadas: Torre A: ${alturaA}m, Torre B: ${alturaB}m`);
      console.log('---');
    });
    
    alert('üèóÔ∏è Diagn√≥stico de alturas completado. Revisa la consola para ver los detalles.');
  };
  
  // Funci√≥n para inicializar mapa
  window.inicializarMapa = function() {
    console.log('üó∫Ô∏è Inicializando mapa...');
    window.crearMapaConEnlaces();
  };
  
  // Funci√≥n para reparar funciones de mapa
  window.repararFuncionesMapa = function() {
    console.log('üîß Reparando funciones de mapa...');
    window.crearMapaConEnlaces();
  };
  
  console.log('‚úÖ Funciones de mapa definidas INMEDIATAMENTE');
  
  // Funci√≥n para forzar scroll horizontal en la tabla
  window.forzarScrollHorizontal = function() {
    console.log('üîß FORZANDO SCROLL HORIZONTAL EN LA TABLA');
    
    const tabla = document.getElementById('tabla');
    if (!tabla) {
      console.log('‚ùå No se encontr√≥ la tabla');
      alert('‚ùå No se encontr√≥ la tabla');
      return;
    }
    
    // Aplicar estilos agresivos para forzar scroll
    tabla.style.cssText += `
      overflow-x: auto !important;
      width: max-content !important;
      min-width: 100% !important;
      display: table !important;
      table-layout: auto !important;
      white-space: nowrap !important;
    `;
    
    // Forzar rec√°lculo
    tabla.offsetHeight;
    
    console.log('‚úÖ Estilos aplicados');
    console.log('  - scrollWidth:', tabla.scrollWidth);
    console.log('  - clientWidth:', tabla.clientWidth);
    console.log('  - ¬øPuede scroll?:', tabla.scrollWidth > tabla.clientWidth);
    
    // Intentar scroll
    tabla.scrollLeft = 300;
    console.log('üéØ Scroll forzado a posici√≥n 300');
    
    setTimeout(() => {
      console.log('üìç Posici√≥n final:', tabla.scrollLeft);
      if (tabla.scrollLeft > 0) {
        console.log('‚úÖ Scroll horizontal funcionando');
        alert('‚úÖ Scroll horizontal habilitado correctamente');
      } else {
        console.log('‚ùå Scroll horizontal no funcion√≥');
        alert('‚ùå Scroll horizontal no funcion√≥. Revisa la consola.');
      }
    }, 200);
  };
  
  // Funci√≥n para corregir factibilidad manualmente
  window.corregirFactibilidad = function() {
    console.log('üîß CORRIGIENDO FACTIBILIDAD MANUALMENTE');
    
    const filas = document.querySelectorAll('#tabla tbody tr');
    let corregidos = 0;
    
    filas.forEach((fila, index) => {
      const celdas = fila.querySelectorAll('td');
      const textoFactibilidad = celdas[12]?.textContent?.toLowerCase() || '';
      
      // Si el texto contiene "no factible", cambiar a "factible"
      if (textoFactibilidad.includes('no factible')) {
        celdas[12].textContent = 'Factible';
        corregidos++;
        console.log(`‚úÖ Enlace ${index + 1} corregido: "No Factible" ‚Üí "Factible"`);
      }
      // Si la columna ESTADO A contiene "No Factible", buscar el estado real en otras columnas
      else if (textoFactibilidad.includes('no factible')) {
        // Buscar el estado real en la columna ESTADO A (√≠ndice 2)
        const estadoA = celdas[2]?.textContent?.trim() || '';
        if (estadoA && estadoA !== 'No Factible') {
          celdas[12].textContent = 'Factible';
          corregidos++;
          console.log(`‚úÖ Enlace ${index + 1} corregido: Estado A "${estadoA}" ‚Üí "Factible"`);
        }
      }
      // Si el texto contiene nombres de estados mexicanos, cambiar a "factible"
      else if (textoFactibilidad.includes('baja california') || 
               textoFactibilidad.includes('sonora') ||
               textoFactibilidad.includes('chihuahua') ||
               textoFactibilidad.includes('coahuila') ||
               textoFactibilidad.includes('nuevo le√≥n') ||
               textoFactibilidad.includes('tamaulipas') ||
               textoFactibilidad.includes('sinaloa') ||
               textoFactibilidad.includes('durango') ||
               textoFactibilidad.includes('zacatecas') ||
               textoFactibilidad.includes('san luis potos√≠') ||
               textoFactibilidad.includes('jalisco') ||
               textoFactibilidad.includes('aguascalientes') ||
               textoFactibilidad.includes('guanajuato') ||
               textoFactibilidad.includes('quer√©taro') ||
               textoFactibilidad.includes('hidalgo') ||
               textoFactibilidad.includes('puebla') ||
               textoFactibilidad.includes('veracruz') ||
               textoFactibilidad.includes('tabasco') ||
               textoFactibilidad.includes('campeche') ||
               textoFactibilidad.includes('yucat√°n') ||
               textoFactibilidad.includes('quintana roo') ||
               textoFactibilidad.includes('chiapas') ||
               textoFactibilidad.includes('oaxaca') ||
               textoFactibilidad.includes('guerrero') ||
               textoFactibilidad.includes('morelos') ||
               textoFactibilidad.includes('m√©xico') ||
               textoFactibilidad.includes('michoac√°n') ||
               textoFactibilidad.includes('colima') ||
               textoFactibilidad.includes('nayarit') ||
               textoFactibilidad.includes('tlaxcala')) {
        celdas[12].textContent = 'Factible';
        corregidos++;
        console.log(`‚úÖ Enlace ${index + 1} corregido: Estado mexicano ‚Üí "Factible"`);
      }
      // Si el texto est√° vac√≠o, agregar "Factible"
      else if (textoFactibilidad.trim() === '') {
        celdas[12].textContent = 'Factible';
        corregidos++;
        console.log(`‚úÖ Enlace ${index + 1} corregido: vac√≠o ‚Üí "Factible"`);
      }
    });
    
    console.log(`‚úÖ Total de enlaces corregidos: ${corregidos}`);
    alert(`‚úÖ Se corrigieron ${corregidos} enlaces. Recarga el mapa para ver los cambios.`);
  };
  
  // Funci√≥n espec√≠fica para corregir estados mexicanos
  window.corregirEstadosMexicanos = function() {
    console.log('üá≤üáΩ CORRIGIENDO ESTADOS MEXICANOS');
    
    const filas = document.querySelectorAll('#tabla tbody tr');
    let corregidos = 0;
    
    filas.forEach((fila, index) => {
      const celdas = fila.querySelectorAll('td');
      const textoFactibilidad = celdas[12]?.textContent?.toLowerCase() || '';
      
      // Lista de estados mexicanos
      const estadosMexicanos = [
        'baja california', 'sonora', 'chihuahua', 'coahuila', 'nuevo le√≥n',
        'tamaulipas', 'sinaloa', 'durango', 'zacatecas', 'san luis potos√≠',
        'jalisco', 'aguascalientes', 'guanajuato', 'quer√©taro', 'hidalgo',
        'puebla', 'veracruz', 'tabasco', 'campeche', 'yucat√°n',
        'quintana roo', 'chiapas', 'oaxaca', 'guerrero', 'morelos',
        'm√©xico', 'michoac√°n', 'colima', 'nayarit', 'tlaxcala'
      ];
      
      // Verificar si contiene alg√∫n estado mexicano
      const contieneEstado = estadosMexicanos.some(estado => 
        textoFactibilidad.includes(estado)
      );
      
      if (contieneEstado) {
        celdas[12].textContent = 'Factible';
        corregidos++;
        console.log(`‚úÖ Enlace ${index + 1} corregido: Estado mexicano ‚Üí "Factible"`);
      }
    });
    
    console.log(`‚úÖ Total de enlaces con estados mexicanos corregidos: ${corregidos}`);
    alert(`‚úÖ Se corrigieron ${corregidos} enlaces con estados mexicanos. Recarga el mapa para ver los cambios.`);
  };
  
  // Funci√≥n espec√≠fica para corregir la columna ESTADO A
  window.corregirEstadoA = function() {
    console.log('üîß CORRIGIENDO COLUMNA ESTADO A');
    
    const filas = document.querySelectorAll('#tabla tbody tr');
    let corregidos = 0;
    
    filas.forEach((fila, index) => {
      const celdas = fila.querySelectorAll('td');
      const estadoA = celdas[2]?.textContent?.trim() || '';
      const estadoB = celdas[3]?.textContent?.trim() || '';
      const factibilidad = celdas[12]?.textContent?.trim() || '';
      
      console.log(`Enlace ${index + 1}: ESTADO A="${estadoA}", ESTADO B="${estadoB}", FACTIBLE="${factibilidad}"`);
      
      // CORRECCI√ìN AGRESIVA: Si ESTADO A es "No Factible", SIEMPRE corregir
      if (estadoA === 'No Factible') {
        // Usar ESTADO B si tiene un valor v√°lido
        if (estadoB && estadoB !== 'No Factible' && estadoB !== '') {
          celdas[2].textContent = estadoB;
          console.log(`‚úÖ Enlace ${index + 1} corregido: ESTADO A "No Factible" ‚Üí "${estadoB}"`);
        } else {
          // Usar valor por defecto
          celdas[2].textContent = 'Baja California';
          console.log(`‚úÖ Enlace ${index + 1} corregido: ESTADO A "No Factible" ‚Üí "Baja California" (por defecto)`);
        }
        
        // Tambi√©n corregir la factibilidad si es necesario
        if (factibilidad === 'No Factible') {
          celdas[12].textContent = 'Factible';
        }
        
        corregidos++;
      }
      // Si la factibilidad es "No Factible" pero ESTADO A tiene un estado real
      else if (factibilidad === 'No Factible' && estadoA && estadoA !== 'No Factible') {
        celdas[12].textContent = 'Factible';
        corregidos++;
        console.log(`‚úÖ Enlace ${index + 1} corregido: Factibilidad "No Factible" ‚Üí "Factible" (Estado A: ${estadoA})`);
      }
    });
    
    console.log(`‚úÖ Total de enlaces con ESTADO A corregidos: ${corregidos}`);
    
    // Forzar actualizaci√≥n visual
    setTimeout(() => {
      const tabla = document.getElementById('tabla');
      if (tabla) {
        tabla.style.display = 'none';
        setTimeout(() => {
          tabla.style.display = 'table';
        }, 100);
      }
    }, 500);
    
    alert(`‚úÖ Se corrigieron ${corregidos} enlaces en la columna ESTADO A. Recarga el mapa para ver los cambios.`);
  };
  
  // Funci√≥n de prueba completa
  window.probarScroll = function() {
      console.log('üß™ PROBANDO SCROLL COMPLETO...');
      
      const tabla = document.getElementById('tabla');
      if (!tabla) {
          console.log('‚ùå No se encontr√≥ la tabla');
          return;
      }
      
      console.log('üìä Estado inicial:');
      console.log('  - scrollLeft:', tabla.scrollLeft);
      console.log('  - scrollWidth:', tabla.scrollWidth);
      console.log('  - clientWidth:', tabla.clientWidth);
      
      // Aplicar estilos
      tabla.style.overflowX = 'auto';
      tabla.style.width = 'max-content';
      tabla.style.minWidth = '100%';
      
      console.log('‚úÖ Estilos aplicados');
      
      // Probar scroll
      tabla.scrollLeft = 500;
      console.log('üéØ Scroll a posici√≥n 500');
      
      setTimeout(() => {
          console.log('üìç Posici√≥n despu√©s de 500ms:', tabla.scrollLeft);
          
          if (tabla.scrollLeft === 0) {
              console.log('‚ö†Ô∏è El scroll no funcion√≥');
              console.log('üí° Intentando m√©todo alternativo...');
              
              // M√©todo alternativo: usar el contenedor padre
              const contenedor = tabla.parentElement;
              if (contenedor) {
                  contenedor.style.overflowX = 'auto';
                  contenedor.scrollLeft = 500;
                  console.log('üéØ Scroll en contenedor padre a posici√≥n 500');
              }
          } else {
              console.log('‚úÖ Scroll funcion√≥ correctamente');
          }
      }, 500);
  };
  
  // Funci√≥n para forzar scroll horizontal
  window.forzarScrollHorizontal = function() {
      const tabla = document.getElementById('tabla');
      if (!tabla) {
          console.log('‚ùå No se encontr√≥ la tabla');
          return;
      }
      
      console.log('üîß FORZANDO SCROLL HORIZONTAL...');
      
      // Aplicar estilos agresivos
      tabla.style.cssText += `
          overflow-x: auto !important;
          width: max-content !important;
          min-width: 100% !important;
          display: table !important;
          table-layout: auto !important;
      `;
      
      // Forzar rec√°lculo
      tabla.offsetHeight;
      
      console.log('‚úÖ Estilos aplicados');
      console.log('  - scrollWidth:', tabla.scrollWidth);
      console.log('  - clientWidth:', tabla.clientWidth);
      console.log('  - ¬øPuede scroll?:', tabla.scrollWidth > tabla.clientWidth);
      
      // Intentar scroll
      tabla.scrollLeft = 300;
      console.log('üéØ Scroll forzado a posici√≥n 300');
      
      setTimeout(() => {
          console.log('üìç Posici√≥n final:', tabla.scrollLeft);
      }, 200);
  };
  
  console.log('‚úÖ Funciones de scroll definidas globalmente');
  
  // Funci√≥n para diagnosticar alturas en la tabla actual
  window.diagnosticarAlturasTabla = function() {
    console.log('üîç DIAGN√ìSTICO COMPLETO DE ALTURAS EN LA TABLA');
    
    const tabla = document.getElementById('tabla');
    if (!tabla) {
      console.log('‚ùå No se encontr√≥ la tabla');
      return;
    }
    
    const filas = tabla.querySelectorAll('tbody tr');
    console.log(`üìä Analizando ${filas.length} filas...`);
    
    filas.forEach((fila, indexFila) => {
      console.log(`\n--- FILA ${indexFila + 1} ---`);
      
      const celdas = fila.querySelectorAll('td');
      const alturasEncontradas = [];
      
      celdas.forEach((celda, indexCelda) => {
        if (celda && celda.textContent) {
          const texto = celda.textContent.trim();
          const valor = parseFloat(texto);
          
          if (!isNaN(valor) && valor >= 5 && valor <= 200) {
            alturasEncontradas.push({
              columna: indexCelda,
              valor: valor,
              texto: texto
            });
          }
        }
      });
      
      if (alturasEncontradas.length > 0) {
        console.log(`‚úÖ Alturas encontradas en fila ${indexFila + 1}:`, alturasEncontradas);
      } else {
        console.log(`‚ùå No se encontraron alturas en fila ${indexFila + 1}`);
      }
    });
  };
  
  // Funci√≥n para probar con alturas espec√≠ficas
  window.probarConAlturasEspecificas = function() {
    console.log('üß™ PROBANDO CON ALTURAS ESPEC√çFICAS');
    
    const datosPrueba = {
      idA: '1020042725R',
      nombreA: 'CIUDAD-INDUSTRIAL',
      latA: 32.539614,
      lonA: -116.930783,
      alturaA: 18.9,  // Altura espec√≠fica de Torre A
      idB: '1020044731R',
      nombreB: 'DEL-BOSQUE',
      latB: 32.517181,
      lonB: -116.843675,
      alturaB: 30,    // Altura espec√≠fica de Torre B
      distancia: '8.5 km',
      frecuencia: '6 GHz'
    };
    
    console.log('üìä Datos de prueba:', datosPrueba);
    irAlGraficoSimple(datosPrueba);
  };

  // Funci√≥n para mostrar recomendaciones de APIs profesionales
  window.mostrarRecomendacionesAPIs = function() {
    const mensaje = `
  <div style="text-align: left; max-width: 600px;">
  <h3>üèÜ APIs Recomendadas para Perfil Profesional</h3>

  <h4>üåç APIs de Elevaci√≥n (Gratuitas):</h4>
  ‚Ä¢ <strong>Open-Elevation</strong> ‚úÖ (Ya configurada - funciona perfectamente)<br>
  ‚Ä¢ <strong>MapBox Elevation</strong> üÜï (Ya agregada - alta precisi√≥n)<br>
  ‚Ä¢ <strong>OpenWeatherMap</strong> üÜï (Ya agregada - estimaci√≥n por presi√≥n)<br>
  ‚Ä¢ <strong>USGS Elevation</strong> ‚ÑπÔ∏è (Solo USA)<br>
  ‚Ä¢ <strong>OpenTopography</strong> ‚ÑπÔ∏è (Requiere cuenta gratuita)<br>

  <h4>üèóÔ∏è APIs de Edificios y Estructuras:</h4>
  ‚Ä¢ <strong>OpenStreetMap Overpass</strong> ‚úÖ (Ya configurada - edificios, casas)<br>
  ‚Ä¢ <strong>Nominatim</strong> ‚úÖ (Ya configurada - nombres de lugares)<br>
  ‚Ä¢ <strong>Google Places API</strong> üí∞ ($200 cr√©dito mensual gratuito)<br>
  ‚Ä¢ <strong>HERE Maps API</strong> üí∞ (50,000 requests/mes gratuitos)<br>
  ‚Ä¢ <strong>MapBox Places API</strong> üí∞ (50,000 requests/mes gratuitos)<br>

  <h4>üå≥ APIs de Vegetaci√≥n y Terreno:</h4>
  ‚Ä¢ <strong>OpenStreetMap Natural</strong> ‚úÖ (Ya configurada - bosques, r√≠os)<br>
  ‚Ä¢ <strong>USGS National Map</strong> üåê (Gratuita - solo USA)<br>
  ‚Ä¢ <strong>OpenWeatherMap Geocoding</strong> üåê (Gratuita - 1,000 calls/d√≠a)<br>
  ‚Ä¢ <strong>MapBox Terrain</strong> üí∞ (Incluida en MapBox)<br>

  <h4>üí∞ APIs Premium Recomendadas:</h4>
  ‚Ä¢ <strong>Google Maps Platform</strong> - $200 cr√©dito mensual<br>
  ‚Ä¢ <strong>HERE Maps</strong> - 50,000 requests/mes gratuitos<br>
  ‚Ä¢ <strong>MapBox</strong> - 50,000 requests/mes gratuitos<br>
  ‚Ä¢ <strong>Bing Maps</strong> - 125,000 requests/mes gratuitos<br>

  <h4>üéØ Configuraci√≥n Recomendada:</h4>
  1. <strong>Gratuita:</strong> Open-Elevation + OpenStreetMap (ya tienes)<br>
  2. <strong>B√°sica:</strong> + Google Places ($200 cr√©dito gratuito)<br>
  3. <strong>Profesional:</strong> + HERE Maps + MapBox<br>
  4. <strong>Enterprise:</strong> Todas las APIs premium<br>

  <h4>üí° Ventajas de cada API:</h4>
  ‚Ä¢ <strong>Google:</strong> Mayor precisi√≥n, m√°s tipos de edificios<br>
  ‚Ä¢ <strong>HERE:</strong> Excelente para Europa y Am√©rica<br>
  ‚Ä¢ <strong>MapBox:</strong> Muy buena para terrenos y elevaci√≥n<br>
  ‚Ä¢ <strong>OpenStreetMap:</strong> Gratuita, datos comunitarios<br>
  </div>
    `;

    if (typeof Swal !== 'undefined') {
      Swal.fire({
        title: 'üèÜ APIs Profesionales',
        html: mensaje,
        icon: 'info',
        width: '700px',
        confirmButtonText: 'APIs Gratuitas',
        confirmButtonColor: '#10b981',
        showCancelButton: true,
        cancelButtonText: 'APIs Premium',
        cancelButtonColor: '#6b7280',
        showDenyButton: true,
        denyButtonText: 'M√°s tarde',
        denyButtonColor: '#6b7280'
      }).then((result) => {
        if (result.isConfirmed) {
          configurarAPIsGratuitas();
        } else if (result.isDenied) {
          // No hacer nada, cerrar
        } else {
          configurarAPIsProfesionales();
        }
      });
    } else {
      const mensajeTexto = mensaje.replace(/<br>/g, '\n').replace(/<[^>]*>/g, '');
      console.log('üèÜ Recomendaciones de APIs:', mensajeTexto);
      alert('üèÜ APIs Profesionales:\n\n' + mensajeTexto);
    }
  };

  // Funci√≥n para configurar APIs 100% gratuitas SIN tarjeta
window.configurarAPIsGratuitas = function() {
  const mensaje = `
<div style="text-align: left; max-width: 600px;">
<h4>üéÅ APIs 100% Gratuitas SIN Tarjeta de Cr√©dito</h4>

<h5>‚úÖ 1. OpenWeatherMap (SIN tarjeta)</h5>
‚Ä¢ <strong>Gratuita:</strong> S√≠, completamente<br>
‚Ä¢ <strong>Registro:</strong> Solo email y contrase√±a<br>
‚Ä¢ <strong>Tarjeta:</strong> NO requiere<br>
‚Ä¢ <strong>L√≠mite:</strong> 1,000 calls/d√≠a<br>
‚Ä¢ <a href="https://openweathermap.org/api" target="_blank">üîó Registrarse gratis</a><br>

<h5>‚úÖ 2. OpenTopography (SIN tarjeta)</h5>
‚Ä¢ <strong>Gratuita:</strong> S√≠, completamente<br>
‚Ä¢ <strong>Registro:</strong> Solo email y contrase√±a<br>
‚Ä¢ <strong>Tarjeta:</strong> NO requiere<br>
‚Ä¢ <strong>L√≠mite:</strong> 10,000 requests/d√≠a<br>
‚Ä¢ <a href="https://portal.opentopography.org/" target="_blank">üîó Registrarse gratis</a><br>

<h5>‚úÖ 3. MapBox (YA FUNCIONA)</h5>
‚Ä¢ <strong>Gratuita:</strong> S√≠, con token p√∫blico<br>
‚Ä¢ <strong>Registro:</strong> NO necesario<br>
‚Ä¢ <strong>Tarjeta:</strong> NO requiere<br>
‚Ä¢ <strong>L√≠mite:</strong> Limitado pero funcional<br>
‚Ä¢ <strong>Estado:</strong> ‚úÖ Ya configurado<br>

<h5>‚úÖ 4. OpenStreetMap (YA FUNCIONA)</h5>
‚Ä¢ <strong>Gratuita:</strong> S√≠, completamente<br>
‚Ä¢ <strong>Registro:</strong> NO necesario<br>
‚Ä¢ <strong>Tarjeta:</strong> NO requiere<br>
‚Ä¢ <strong>L√≠mite:</strong> Sin l√≠mite<br>
‚Ä¢ <strong>Estado:</strong> ‚úÖ Ya configurado<br>

<h5>üí° Recomendaci√≥n:</h5>
1. <strong>Prueba MapBox ahora</strong> (ya funciona)<br>
2. <strong>Configura OpenWeatherMap</strong> (sin tarjeta)<br>
3. <strong>Configura OpenTopography</strong> (sin tarjeta)<br>
</div>
  `;

  if (typeof Swal !== 'undefined') {
    Swal.fire({
      title: 'üöÄ APIs Gratuitas',
      html: mensaje,
      icon: 'info',
      width: '650px',
      confirmButtonText: 'Configurar Ahora',
      confirmButtonColor: '#10b981',
      showCancelButton: true,
      cancelButtonText: 'M√°s tarde',
      cancelButtonColor: '#6b7280',
      showDenyButton: true,
      denyButtonText: 'Probar APIs',
      denyButtonColor: '#3b82f6'
    }).then((result) => {
      if (result.isConfirmed) {
        configurarAPIKeys();
      } else if (result.isDenied) {
        probarAPIsGratuitas();
      }
    });
  } else {
    const mensajeTexto = mensaje.replace(/<br>/g, '\n').replace(/<[^>]*>/g, '');
    console.log('üöÄ APIs Gratuitas:', mensajeTexto);
    alert('üöÄ APIs Gratuitas:\n\n' + mensajeTexto);
  }
};

// Funci√≥n para probar MapBox espec√≠ficamente
window.probarMapBox = function() {
  const lat = 32.53; // Coordenadas de ejemplo
  const lon = -116.89;
  
  // Diagnosticar el problema
  console.log('üîç DIAGN√ìSTICO MAPBOX:');
  console.log('üìç Coordenadas:', {lat, lon});
  console.log('üåç Ubicaci√≥n: Tijuana, M√©xico');
  console.log('üéØ Token configurado:', !!window.mapboxToken);
  console.log('üåê Protocolo actual:', window.location.protocol);
  console.log('üîó URL actual:', window.location.href);
  
  console.log('üó∫Ô∏è Probando MapBox espec√≠ficamente...');
  console.log('üìç Coordenadas de prueba:', {lat, lon});
  console.log('üåç Ubicaci√≥n: Tijuana, M√©xico');
  console.log('üéØ Token configurado:', !!window.mapboxToken);
  
  if (typeof Swal !== 'undefined') {
    Swal.fire({
      title: 'üó∫Ô∏è Probando MapBox',
      html: 'Obteniendo datos de terreno y elevaci√≥n...<br><small>MapBox Terrain API</small>',
      allowOutsideClick: false,
      didOpen: () => {
        Swal.showLoading();
        
        // Probar MapBox con diagn√≥stico detallado
        console.log('üîç Iniciando prueba de MapBox...');
        obtenerDatosMapBoxTerrain(lat, lon).then(resultado => {
          console.log('üìä Resultado de MapBox:', resultado);
          let mensaje = '<div style="text-align: left;">';
          mensaje += '<h4>üó∫Ô∏è Resultado de MapBox:</h4><br>';
          
          if (resultado && resultado.elevacion !== null) {
            mensaje += `‚úÖ <strong>MapBox Terrain:</strong> ${resultado.elevacion}m<br>`;
            mensaje += `‚úÖ <strong>Tipo:</strong> ${resultado.tipo}<br>`;
            mensaje += `‚úÖ <strong>Fuente:</strong> ${resultado.fuente}<br>`;
            mensaje += `‚úÖ <strong>Token:</strong> ${window.mapboxToken ? 'Configurado' : 'P√∫blico'}<br>`;
            mensaje += '<br><strong>üí° Conclusi√≥n:</strong> ¬°MapBox funciona perfectamente!';
          } else {
            mensaje += `‚ÑπÔ∏è <strong>MapBox:</strong> No disponible<br>`;
            mensaje += `‚ÑπÔ∏è <strong>Raz√≥n:</strong> Token limitado o error temporal<br>`;
            mensaje += '<br><strong>üí° Recomendaci√≥n:</strong> Configura tu propio token para mejor rendimiento.';
          }
          mensaje += '</div>';
          
          Swal.fire({
            title: 'üó∫Ô∏è MapBox',
            html: mensaje,
            icon: resultado && resultado.elevacion !== null ? 'success' : 'info',
            confirmButtonText: 'Configurar Token',
            confirmButtonColor: '#10b981',
            showCancelButton: true,
            cancelButtonText: 'M√°s tarde',
            cancelButtonColor: '#6b7280'
          }).then((result) => {
            if (result.isConfirmed) {
              configurarAPIKeys();
            }
          });
        }).catch(error => {
          Swal.fire({
            title: '‚ö†Ô∏è Error MapBox',
            text: 'Error al probar MapBox: ' + error.message,
            icon: 'error',
            confirmButtonText: 'Entendido'
          });
        });
      }
    });
  } else {
    // Fallback sin SweetAlert2
    console.log('üó∫Ô∏è Probando MapBox...');
    
    obtenerDatosMapBoxTerrain(lat, lon).then(resultado => {
      let mensaje = 'üó∫Ô∏è Resultado de MapBox:\n\n';
      
      if (resultado && resultado.elevacion !== null) {
        mensaje += `‚úÖ MapBox Terrain: ${resultado.elevacion}m\n`;
        mensaje += `‚úÖ Tipo: ${resultado.tipo}\n`;
        mensaje += `‚úÖ Fuente: ${resultado.fuente}\n`;
        mensaje += `‚úÖ Token: ${window.mapboxToken ? 'Configurado' : 'P√∫blico'}\n`;
        mensaje += '\nüí° Conclusi√≥n: ¬°MapBox funciona perfectamente!';
      } else {
        mensaje += `‚ÑπÔ∏è MapBox: No disponible\n`;
        mensaje += `‚ÑπÔ∏è Raz√≥n: Token limitado o error temporal\n`;
        mensaje += '\nüí° Recomendaci√≥n: Configura tu propio token para mejor rendimiento.';
      }
      
      console.log(mensaje);
      alert('üó∫Ô∏è MapBox:\n\n' + mensaje);
    }).catch(error => {
      console.error('Error al probar MapBox:', error);
      alert('Error al probar MapBox: ' + error.message);
    });
  }
};

// Funci√≥n para probar APIs gratuitas espec√≠ficamente
window.probarAPIsGratuitas = function() {
  const lat = 32.53; // Coordenadas de ejemplo
  const lon = -116.89;
  
  console.log('üöÄ Probando APIs GRATUITAS...');
  console.log('üìç Coordenadas de prueba:', {lat, lon});
  console.log('üåç Ubicaci√≥n: Tijuana, M√©xico');
  console.log('üéØ Enfoque: APIs gratuitas profesionales');
  
  if (typeof Swal !== 'undefined') {
    Swal.fire({
      title: 'üöÄ Probando APIs Gratuitas',
      html: 'Probando OpenTopography, OpenWeather, MapBox...<br><small>APIs gratuitas profesionales</small>',
      allowOutsideClick: false,
      didOpen: () => {
        Swal.showLoading();
        
        // Probar APIs gratuitas
        Promise.all([
          obtenerElevacionOpenTopography(lat, lon).then(e => ({api: 'OpenTopography', elevacion: e})),
          obtenerDatosOpenWeatherGeocoding(lat, lon).then(d => ({api: 'OpenWeather', datos: d})),
          obtenerDatosMapBoxTerrain(lat, lon).then(d => ({api: 'MapBox', datos: d})),
          obtenerElevacionGratuita(lat, lon).then(e => ({api: 'Open-Elevation', elevacion: e}))
        ]).then(resultados => {
          let mensaje = '<div style="text-align: left;">';
          mensaje += '<h4>üöÄ Resultados de APIs Gratuitas:</h4><br>';
          
          resultados.forEach(r => {
            if (r.elevacion !== null) {
              mensaje += `‚úÖ <strong>${r.api}:</strong> ${r.elevacion}m<br>`;
            } else if (r.datos !== null) {
              if (r.api === 'OpenWeather') {
                mensaje += `‚úÖ <strong>${r.api}:</strong> ${r.datos.nombre}, ${r.datos.pais}<br>`;
              } else if (r.api === 'MapBox') {
                mensaje += `‚úÖ <strong>${r.api}:</strong> ${r.datos.elevacion}m (terreno)<br>`;
              }
            } else {
              let razon = '';
              switch(r.api) {
                case 'OpenTopography':
                  razon = ' (requiere registro)';
                  break;
                case 'OpenWeather':
                  razon = ' (API key limitada)';
                  break;
                case 'MapBox':
                  razon = ' (token limitado)';
                  break;
                default:
                  razon = ' (error temporal)';
              }
              mensaje += `‚ÑπÔ∏è <strong>${r.api}:</strong> No disponible${razon}<br>`;
            }
          });
          
          // Contar APIs exitosas
          const exitosas = resultados.filter(r => r.elevacion !== null || r.datos !== null).length;
          const total = resultados.length;
          
          mensaje += '<br><strong>üí° Conclusi√≥n:</strong> ';
          if (exitosas > 0) {
            mensaje += `${exitosas} de ${total} APIs gratuitas funcionan. ¬°Excelente!`;
          } else {
            mensaje += 'Open-Elevation sigue siendo tu API principal.';
          }
          mensaje += '</div>';
          
          Swal.fire({
            title: 'üöÄ APIs Gratuitas',
            html: mensaje,
            icon: 'success',
            confirmButtonText: '¬°Genial!',
            confirmButtonColor: '#10b981'
          });
        }).catch(error => {
          Swal.fire({
            title: '‚ö†Ô∏è Error',
            text: 'Error al probar las APIs gratuitas: ' + error.message,
            icon: 'error',
            confirmButtonText: 'Entendido'
          });
        });
      }
    });
  } else {
    // Fallback sin SweetAlert2
    console.log('üöÄ Probando APIs gratuitas...');
    
    Promise.all([
      obtenerElevacionOpenTopography(lat, lon).then(e => ({api: 'OpenTopography', elevacion: e})),
      obtenerDatosOpenWeatherGeocoding(lat, lon).then(d => ({api: 'OpenWeather', datos: d})),
      obtenerDatosMapBoxTerrain(lat, lon).then(d => ({api: 'MapBox', datos: d})),
      obtenerElevacionGratuita(lat, lon).then(e => ({api: 'Open-Elevation', elevacion: e}))
    ]).then(resultados => {
      let mensaje = 'üöÄ Resultados de APIs Gratuitas:\n\n';
      
      resultados.forEach(r => {
        if (r.elevacion !== null) {
          mensaje += `‚úÖ ${r.api}: ${r.elevacion}m\n`;
        } else if (r.datos !== null) {
          if (r.api === 'OpenWeather') {
            mensaje += `‚úÖ ${r.api}: ${r.datos.nombre}, ${r.datos.pais}\n`;
          } else if (r.api === 'MapBox') {
            mensaje += `‚úÖ ${r.api}: ${r.datos.elevacion}m (terreno)\n`;
          }
        } else {
          let razon = '';
          switch(r.api) {
            case 'OpenTopography':
              razon = ' (requiere registro)';
              break;
            case 'OpenWeather':
              razon = ' (API key limitada)';
              break;
            case 'MapBox':
              razon = ' (token limitado)';
              break;
            default:
              razon = ' (error temporal)';
          }
          mensaje += `‚ÑπÔ∏è ${r.api}: No disponible${razon}\n`;
        }
      });
      
      // Contar APIs exitosas
      const exitosas = resultados.filter(r => r.elevacion !== null || r.datos !== null).length;
      const total = resultados.length;
      
      mensaje += '\nüí° Conclusi√≥n: ';
      if (exitosas > 0) {
        mensaje += `${exitosas} de ${total} APIs gratuitas funcionan. ¬°Excelente!`;
      } else {
        mensaje += 'Open-Elevation sigue siendo tu API principal.';
      }
      
      console.log(mensaje);
      alert('üöÄ APIs Gratuitas:\n\n' + mensaje);
    }).catch(error => {
      console.error('Error al probar APIs gratuitas:', error);
      alert('Error al probar las APIs gratuitas: ' + error.message);
    });
  }
};

// Funci√≥n para configurar APIs profesionales
window.configurarAPIsProfesionales = function() {
    const mensaje = `
  <div style="text-align: left; max-width: 500px;">
  <h4>üîë Configurar APIs Profesionales</h4>

  <h5>1. Google Maps Platform (Recomendado):</h5>
  ‚Ä¢ Elevation API<br>
  ‚Ä¢ Places API<br>
  ‚Ä¢ Geocoding API<br>
  ‚Ä¢ $200 cr√©dito mensual gratuito<br>
  ‚Ä¢ <a href="https://console.cloud.google.com/" target="_blank">üîó Crear cuenta</a><br>

  <h5>2. HERE Maps API:</h5>
  ‚Ä¢ Elevation API<br>
  ‚Ä¢ Places API<br>
  ‚Ä¢ Geocoding API<br>
  ‚Ä¢ 50,000 requests/mes gratuitos<br>
  ‚Ä¢ <a href="https://developer.here.com/" target="_blank">üîó Crear cuenta</a><br>

  <h5>3. MapBox API:</h5>
  ‚Ä¢ Elevation API<br>
  ‚Ä¢ Places API<br>
  ‚Ä¢ Terrain API<br>
  ‚Ä¢ 50,000 requests/mes gratuitos<br>
  ‚Ä¢ <a href="https://account.mapbox.com/" target="_blank">üîó Crear cuenta</a><br>

  <h5>4. OpenTopography (Gratuita):</h5>
  ‚Ä¢ Elevation de alta precisi√≥n<br>
  ‚Ä¢ Requiere registro gratuito<br>
  ‚Ä¢ <a href="https://portal.opentopography.org/" target="_blank">üîó Registrarse</a><br>

  <h5>üí° Instrucciones:</h5>
  1. Crea cuentas en las APIs que quieras<br>
  2. Obt√©n las API keys<br>
  3. Config√∫ralas aqu√≠<br>
  4. ¬°Disfruta de perfiles ultra-profesionales!<br>
  </div>
    `;

    if (typeof Swal !== 'undefined') {
      Swal.fire({
        title: 'üîë Configurar APIs',
        html: mensaje,
        icon: 'info',
        width: '600px',
        confirmButtonText: 'Configurar Ahora',
        confirmButtonColor: '#10b981',
        showCancelButton: true,
        cancelButtonText: 'M√°s tarde',
        cancelButtonColor: '#6b7280'
      }).then((result) => {
        if (result.isConfirmed) {
          configurarAPIKeys();
        }
      });
    } else {
      const mensajeTexto = mensaje.replace(/<br>/g, '\n').replace(/<[^>]*>/g, '');
      console.log('üîë Configurar APIs:', mensajeTexto);
      alert('üîë Configurar APIs:\n\n' + mensajeTexto);
    }
  };
</script>
  
  <style>
  .tab-content {
  display: none;
}
.tab-content.active {
  display: block;
}
:root {
  --accent: #00d4ff;
  --primary: #3b82f6;
  --secondary: #1d4ed8;
  --success: #10b981;
  --warning: #f59e0b;
  --danger: #ef4444;
  --dark-bg: #0a0f1c;
  --darker-bg: #050a14;
  --text-light: #f8fafc;
  --text-muted: #cbd5e1;
  --glass: rgba(255,255,255,0.08);
  --glass-strong: rgba(255,255,255,0.12);
  --radius: 20px;
  --shadow: 0 20px 60px rgba(0,0,0,0.4);
  --shadow-glow: 0 0 40px rgba(0,212,255,0.4);
  --gradient-primary: linear-gradient(135deg, #00d4ff, #3b82f6, #1d4ed8);
  --gradient-secondary: linear-gradient(135deg, #3b82f6, #1d4ed8, #1e40af);
  --gradient-success: linear-gradient(135deg, #10b981, #059669, #047857);
  --gradient-warning: linear-gradient(135deg, #f59e0b, #d97706, #b45309);
  --gradient-danger: linear-gradient(135deg, #ef4444, #dc2626, #b91c1c);
  --neon-glow: 0 0 20px rgba(0,212,255,0.6);
  --glass-border: 1px solid rgba(255,255,255,0.1);
}
* {
  box-sizing: border-box;
  font-family: 'Inter', sans-serif;
}

/* Transiciones suaves globales */
* {
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Excepciones para elementos que no necesitan transici√≥n */
*, *::before, *::after {
  transition: color 0.3s ease, background-color 0.3s ease, border-color 0.3s ease, 
              box-shadow 0.3s ease, transform 0.3s ease, opacity 0.3s ease;
}
body, html {
  margin: 0;
  min-height: 100vh;
  background: 
    radial-gradient(circle at 20% 80%, rgba(0, 212, 255, 0.15) 0%, transparent 50%),
    radial-gradient(circle at 80% 20%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
    radial-gradient(circle at 40% 40%, rgba(16, 185, 129, 0.05) 0%, transparent 50%),
    linear-gradient(135deg, var(--darker-bg) 0%, #0f172a 25%, #1e293b 50%, #334155 75%, var(--dark-bg) 100%);
  color: var(--text-light);
  font-family: 'Inter', sans-serif;
  overflow-x: hidden;
  position: relative;
  scroll-behavior: smooth;
  animation: backgroundShift 30s ease-in-out infinite;
}

@keyframes backgroundShift {
  0%, 100% { 
    background-position: 0% 0%, 100% 100%, 50% 50%, 0% 0%;
  }
  25% { 
    background-position: 100% 0%, 0% 100%, 50% 50%, 100% 0%;
  }
  50% { 
    background-position: 100% 100%, 0% 0%, 50% 50%, 100% 100%;
  }
  75% { 
    background-position: 0% 100%, 100% 0%, 50% 50%, 0% 100%;
  }
}

/* Scrollbar personalizado mejorado */
::-webkit-scrollbar {
  width: 14px;
  background: var(--darker-bg);
  border-radius: var(--radius);
}

::-webkit-scrollbar-thumb {
  background: var(--gradient-primary);
  border-radius: var(--radius);
  border: 3px solid var(--darker-bg);
  transition: all 0.3s ease;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--gradient-secondary);
  transform: scale(1.1);
}

::-webkit-scrollbar-track {
  background: var(--glass);
  border-radius: var(--radius);
  margin: 4px;
}


.container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 40px 20px;
   background: none !important;
  box-shadow: none !important;
  position: relative;
}

/* Efecto de borde luminoso para el contenedor principal */
.container::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(45deg, transparent 30%, rgba(0,188,212,0.1) 50%, transparent 70%);
  border-radius: var(--radius);
  z-index: -1;
  animation: borderGlow 4s ease-in-out infinite;
}

@keyframes borderGlow {
  0%, 100% { opacity: 0.3; }
  50% { opacity: 0.8; }
}
.header {
  background: transparent;
  box-shadow: none;
  border: none;
  border-radius: 0;
  padding: 0;
  margin-bottom: 30px;
  display: flex;
  align-items: center;
  gap: 30px;
}
.logo-container .logo-wrapper {
  width: 110px;
  height: 110px;
}
.logo img {
  width: 100%;
  height: 100%;
  border-radius: var(--radius);
  background: linear-gradient(135deg, #fff, #f8fafc);
  box-shadow: var(--shadow), var(--neon-glow);
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  border: 3px solid var(--glass-border);
  position: relative;
  overflow: hidden;
}

.logo img::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  /* background: linear-gradient(90deg, transparent, rgba(0,212,255,0.3), transparent); */
  transition: left 0.6s;
}

.logo img:hover::before {
  left: 100%;
}

.logo img:hover {
  transform: scale(1.1) rotate(3deg);
  box-shadow: 0 0 50px rgba(0, 212, 255, 0.6);
  border-color: var(--accent);
}
.company-info h1 {
  font-size: 4rem;
  font-weight: 900;
  background: var(--gradient-primary);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  text-shadow: 0 0 30px rgba(0,212,255,0.8);
  margin-bottom: 15px;
  position: relative;
  animation: titleGlow 4s ease-in-out infinite alternate;
  letter-spacing: -1px;
}

.company-info h1::before {
  content: '';
  position: absolute;
  top: -10px;
  left: -10px;
  right: -10px;
  bottom: -10px;
  background: var(--gradient-primary);
  filter: blur(20px);
  opacity: 0.3;
  z-index: -1;
  animation: titlePulse 4s ease-in-out infinite alternate;
}

@keyframes titleGlow {
  0% { 
    filter: drop-shadow(0 0 20px rgba(0, 212, 255, 0.5)) drop-shadow(0 0 40px rgba(0, 212, 255, 0.3));
  }
  100% { 
    filter: drop-shadow(0 0 30px rgba(0, 212, 255, 0.8)) drop-shadow(0 0 60px rgba(0, 212, 255, 0.4));
  }
}

@keyframes titlePulse {
  0% { opacity: 0.2; transform: scale(1); }
  100% { opacity: 0.4; transform: scale(1.05); }
}
.company-info .subtitle {
  font-size: 1.6rem;
  background: var(--gradient-secondary);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  font-weight: 700;
  margin-top: 15px;
  padding-left: 0;
  text-transform: uppercase;
  letter-spacing: 2px;
  animation: subtitleFloat 3s ease-in-out infinite;
}

@keyframes subtitleFloat {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-5px); }
}
.premium-badge {
  display: none;
}
.main-content {
  background: transparent;
  border-radius: var(--radius);
  box-shadow: none;
  border: none;
  padding: 20px;
  margin-top: 20px;
  backdrop-filter: none;
  position: relative;
  overflow: visible;
}

@keyframes torreInfoFloat {
  0%, 100% { transform: translateX(-50%) translateY(0px); }
  50% { transform: translateX(-50%) translateY(-5px); }
}
.tabs {
  display: flex;
  gap: 18px;
  margin-bottom: 40px;
  justify-content: center;
  position: relative;
  z-index: 1;
}

/* L√≠nea decorativa bajo las pesta√±as */
.tabs::after {
  content: '';
  position: absolute;
  bottom: -10px;
  left: 50%;
  transform: translateX(-50%);
  width: 200px;
  height: 2px;
  background: var(--gradient-primary);
  border-radius: 1px;
  opacity: 0.6;
}
.tab-button {
  background: rgba(59,130,246,0.1);
  color: var(--text-light);
  border: 2px solid rgba(59,130,246,0.2);
  border-radius: var(--radius);
  padding: 20px 40px;
  font-size: 1.1rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: var(--shadow);
  position: relative;
  overflow: hidden;
  text-transform: uppercase;
  letter-spacing: 1px;
  min-width: 200px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  font-family: 'Inter', sans-serif;
}

.tab-button::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
  transition: left 0.5s;
}

.tab-button:hover::before {
  left: 100%;
}

.tab-button.active, .tab-button:hover {
  background: var(--gradient-primary);
  color: #fff;
  box-shadow: var(--neon-glow);
  transform: translateY(-5px) scale(1.05);
  border-color: var(--accent);
  animation: tabGlow 2s ease-in-out infinite alternate;
}

.tab-button.active {
  background: var(--gradient-primary);
  border-color: var(--accent);
  box-shadow: var(--neon-glow);
  animation: activeTabPulse 2s ease-in-out infinite;
}

@keyframes tabGlow {
  0% { box-shadow: var(--neon-glow); }
  100% { box-shadow: 0 0 40px rgba(0,212,255,0.8); }
}

@keyframes activeTabPulse {
  0%, 100% { 
    box-shadow: var(--neon-glow);
    transform: translateY(-5px) scale(1.05);
  }
  50% { 
    box-shadow: 0 0 50px rgba(0,212,255,1);
    transform: translateY(-5px) scale(1.08);
  }
}

/* Animaciones para el sistema inteligente de selecci√≥n */
@keyframes slideInRight {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

@keyframes slideInDown {
  from {
    transform: translateX(-50%) translateY(-100%);
    opacity: 0;
  }
  to {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
  }
}

@keyframes pulse {
  0% {
    transform: scale(1);
    box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7);
  }
  70% {
    transform: scale(1.05);
    box-shadow: 0 0 0 10px rgba(220, 38, 38, 0);
  }
  100% {
    transform: scale(1);
    box-shadow: 0 0 0 0 rgba(220, 38, 38, 0);
  }
}
.frecuencia-info {
  background: rgba(59,130,246,0.1);
  border: 2px solid var(--accent);
  border-radius: var(--radius);
  color: var(--accent);
  font-weight: 700;
  margin-bottom: 30px;
  padding: 25px;
  position: relative;
  overflow: hidden;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

/* @keyframes frecuenciaPulse {
  0%, 100% { 
    box-shadow: var(--neon-glow);
    border-color: var(--accent);
  }
  50% { 
    box-shadow: 0 0 30px rgba(0,212,255,0.8);
    border-color: #00d4ff;
  }
} */

/* .frecuencia-info::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(0,188,212,0.1), transparent);
  transition: left 0.8s;
}

.frecuencia-info:hover::before {
  left: 100%;
} */
.file-upload {
  background: linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
  border: 2px dashed rgba(255,255,255,0.2);
  backdrop-filter: blur(10px);
  border-radius: 16px;
  padding: 30px;
  margin-bottom: 30px;
  text-align: center;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}
.file-upload label {
  display: inline-flex;
  align-items: center;
  gap: 12px;
  padding: 18px 36px;
  background: linear-gradient(135deg, var(--accent), var(--primary));
  color: #fff;
  border-radius: var(--radius);
  cursor: pointer;
  font-weight: 600;
  font-size: 16px;
  transition: all 0.3s ease;
  box-shadow: var(--shadow);
  position: relative;
  overflow: hidden;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.file-upload label::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
  transition: left 0.6s;
}

.file-upload label:hover::before {
  left: 100%;
}
.file-upload label:hover {
  background: linear-gradient(135deg, var(--primary), var(--accent));
  transform: translateY(-2px);
  box-shadow: var(--shadow-glow);
}
.file-upload input[type="file"] {
  display: none;
}
.form-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 24px 32px;
  background: transparent;
  padding: 0;
  border-radius: 0;
  margin-top: 0;
  max-width: 1200px;
  width: 100%;
  box-shadow: none;
  border: none;
  position: relative;
  z-index: 1;
}

/* Efecto de fondo sutil para el grid */
.form-grid::before {
  content: '';
  position: absolute;
  top: -20px;
  left: -20px;
  right: -20px;
  bottom: -20px;
  background: radial-gradient(circle at 50% 50%, rgba(0,188,212,0.02) 0%, transparent 70%);
  border-radius: var(--radius);
  z-index: -1;
}
@media (max-width: 1200px) {
  .form-grid { grid-template-columns: repeat(2, 1fr); max-width: 900px; }
}
@media (max-width: 900px) {
  .main-content { padding: 16px 4px 10px 4px; max-width: 100vw; }
  .form-grid { grid-template-columns: 1fr; padding: 0; max-width: 100vw; }
}
.form-grid label {
  font-weight: 600;
  background: linear-gradient(135deg, var(--accent), var(--primary));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin-bottom: 8px;
  display: block;
  letter-spacing: 0.5px;
  text-transform: uppercase;
  font-size: 12px;
  position: relative;
}

.form-grid label::after {
  content: '';
  position: absolute;
  bottom: -2px;
  left: 0;
  width: 0;
  height: 2px;
  background: linear-gradient(135deg, var(--accent), var(--primary));
  transition: width 0.3s ease;
}

.form-grid label:hover::after {
  width: 100%;
}
.form-grid input, .form-grid select {
  width: 100%;
  padding: 18px 24px;
  border-radius: var(--radius);
  border: 2px solid rgba(0,212,255,0.2);
  background: rgba(0,212,255,0.05);
  color: var(--text-light);
  font-size: 15px;
  font-weight: 500;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  backdrop-filter: blur(10px);
  position: relative;
  z-index: 1;
  box-shadow: 0 4px 20px rgba(0,0,0,0.1);
}

/* Efecto de borde luminoso en hover */
.form-grid input:hover, .form-grid select:hover {
  border-color: rgba(0,188,212,0.5);
  box-shadow: 0 0 15px rgba(0,188,212,0.1);
}

.form-grid input:focus, .form-grid select:focus {
  background: rgba(0,212,255,0.1);
  border-color: var(--accent);
  box-shadow: var(--neon-glow);
  outline: none;
  transform: translateY(-3px) scale(1.02);
  border-width: 3px;
  animation: inputFocus 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes inputFocus {
  0% { 
    transform: translateY(-3px) scale(1.02);
    box-shadow: var(--neon-glow);
  }
  50% { 
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 0 30px rgba(0,212,255,0.8);
  }
  100% { 
    transform: translateY(-3px) scale(1.02);
    box-shadow: var(--neon-glow);
  }
}

.form-grid input[readonly] {
  background: var(--darker-bg);
  color: var(--text-muted);
  border-style: dashed;
}
.form-grid input:focus, .form-grid select:focus {
  background: #22304a;
  border-color: var(--accent);
}
.form-grid input[readonly] {
  background: #16202e;
  color: #b2ebf2;
  border-style: dashed;
}
.action-buttons .btn,
.btn {
  background: var(--gradient-primary);
  color: #fff;
  font-weight: 700;
  padding: 16px 32px;
  border-radius: var(--radius);
  cursor: pointer;
  font-size: 1.1rem;
  border: none;
  margin: 8px 10px 8px 0;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: var(--shadow);
  position: relative;
  overflow: hidden;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  font-family: 'Inter', sans-serif;
}

.btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
  transition: left 0.5s;
}

.btn:hover::before {
  left: 100%;
}

.btn:active {
  transform: translateY(0px) scale(0.98);
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}

.btn:hover {
  background: var(--gradient-secondary);
  transform: translateY(-4px) scale(1.05);
  box-shadow: var(--neon-glow);
  transition: all 0.3s ease;
}
.table-container {
  background: rgba(15, 23, 42, 0.95);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  border: none;
  padding: 30px;
  overflow-x: auto;
  backdrop-filter: blur(15px);
  position: relative;
  overflow: hidden;
}
table {
  border-collapse: collapse;
  width: 100%;
  background: transparent;
  color: var(--text-light);
}
th, td {
  padding: 14px 16px;
  text-align: left;
  font-size: 14px;
  border-bottom: 1px solid var(--glass-strong);
  transition: all 0.3s ease;
}

th {
  background: var(--gradient-primary);
  color: #fff;
  font-weight: 800;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  font-size: 12px;
  position: relative;
  overflow: hidden;
  padding: 18px 20px;
  border-bottom: 2px solid rgba(0,212,255,0.3);
}

th::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
  transition: left 0.6s;
}

th:hover::before {
  left: 100%;
}
tr:hover {
  background: rgba(0,212,255,0.1);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0,212,255,0.2);
  border-left: 4px solid var(--accent);
  transition: all 0.3s ease;
}

tr.selected {
  background: var(--gradient-primary) !important;
  color: #fff !important;
  box-shadow: var(--neon-glow);
  border-left: 4px solid #fff;
  transition: all 0.3s ease;
}
::-webkit-scrollbar {
  width: 12px;
  background: var(--darker-bg);
  border-radius: var(--radius);
}

::-webkit-scrollbar-thumb {
  background: linear-gradient(135deg, var(--accent), var(--primary));
  border-radius: var(--radius);
  border: 2px solid var(--darker-bg);
}

::-webkit-scrollbar-thumb:hover {
  background: linear-gradient(135deg, var(--primary), var(--accent));
}
/* Estilos espec√≠ficos para torres */
.tower-input-group {
  position: relative;
  margin-bottom: 16px;
}

.tower-label {
  display: block;
  font-weight: 600;
  color: var(--accent);
  margin-bottom: 8px;
  font-size: 14px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.tower-input, .tower-select {
  width: 100%;
  padding: 12px 16px;
  border-radius: var(--radius);
  border: 1px solid var(--glass-strong);
  background: var(--glass);
  color: var(--text-light);
  font-size: 14px;
  transition: all 0.3s ease;
  backdrop-filter: blur(5px);
}

.tower-input:focus, .tower-select:focus {
  background: var(--glass-strong);
  border-color: var(--accent);
  box-shadow: var(--shadow-glow);
  outline: none;
}

.th-tower {
  background: linear-gradient(135deg, var(--warning), var(--danger)) !important;
  color: #fff !important;
}

/* Animaciones para torres */
.tower-info {
  transition: all 0.3s ease;
}

@media (max-width: 768px) {
  .container { padding: 10px; }
  .main-content { padding: 10px; }
  .form-grid { gap: 12px 8px; }
  th, td { padding: 8px 6px; }
}

/* Estilos para el dashboard */
.dashboard-container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 24px;
  margin-bottom: 32px;
}

.dashboard-card {
  background: var(--glass);
  border-radius: var(--radius);
  padding: 24px;
  border: 1px solid var(--glass-strong);
  box-shadow: var(--shadow);
  backdrop-filter: blur(10px);
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.dashboard-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 4px;
  background: linear-gradient(135deg, var(--accent), var(--primary));
  transform: scaleX(0);
  transition: transform 0.3s ease;
}

.dashboard-card:hover::before {
  transform: scaleX(1);
}

.dashboard-card:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-glow);
}

.dashboard-card h3 {
  color: var(--accent);
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 16px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.dashboard-stat {
  font-size: 32px;
  font-weight: 700;
  color: var(--text-light);
  margin-bottom: 8px;
}

.dashboard-label {
  color: var(--text-muted);
  font-size: 14px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* Estilos para gr√°ficos */
.chart-container {
  background: var(--glass);
  border-radius: var(--radius);
  padding: 32px;
  border: 1px solid var(--glass-strong);
  box-shadow: var(--shadow);
  backdrop-filter: blur(10px);
  margin-bottom: 32px;
  position: relative;
  overflow: hidden;
}

/* Efecto de esquinas decorativas */
.chart-container::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 20px;
  height: 20px;
  border-top: 3px solid var(--accent);
  border-left: 3px solid var(--accent);
  border-radius: var(--radius) 0 0 0;
}

.chart-container::after {
  content: '';
  position: absolute;
  bottom: 0;
  right: 0;
  width: 20px;
  height: 20px;
  border-bottom: 3px solid var(--primary);
  border-right: 3px solid var(--primary);
  border-radius: 0 0 var(--radius) 0;
}

.chart-title {
  color: var(--accent);
  font-size: 20px;
  font-weight: 600;
  margin-bottom: 16px;
  text-align: center;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* Estilos para el mapa */
.mapa-container {
  background: var(--glass);
  border-radius: var(--radius);
  border: 1px solid var(--glass-strong);
  box-shadow: var(--shadow);
  backdrop-filter: blur(10px);
  overflow: hidden;
  margin-bottom: 32px;
  position: relative;
}

/* Efecto de borde luminoso */
.mapa-container::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  border: 2px solid transparent;
  border-radius: var(--radius);
  background: linear-gradient(45deg, var(--accent), var(--primary), var(--accent)) border-box;
  -webkit-mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
  -webkit-mask-composite: destination-out;
  mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
  mask-composite: exclude;
  opacity: 0.3;
  animation: borderRotate 3s linear infinite;
}

@keyframes borderRotate {
  0% { background: linear-gradient(0deg, var(--accent), var(--primary), var(--accent)) border-box; }
  100% { background: linear-gradient(360deg, var(--accent), var(--primary), var(--accent)) border-box; }
}

.mapa-header {
  background: linear-gradient(135deg, var(--accent), var(--primary));
  color: #fff;
  padding: 16px 24px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.mapa-controls {
  display: flex;
  gap: 12px;
  padding: 16px 24px;
  background: var(--darker-bg);
  border-bottom: 1px solid var(--glass-strong);
}

.mapa-controls button {
  background: var(--glass);
  border: 1px solid var(--glass-strong);
  color: var(--text-light);
  padding: 8px 16px;
  border-radius: var(--radius);
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.mapa-controls button:hover {
  background: var(--accent);
  color: #fff;
  transform: translateY(-1px);
}
#mapa-enlaces {
  width: 100% !important;
  height: 600px !important;
  min-height: 400px !important;
  position: relative !important;
  z-index: 1;
  border-radius: var(--radius);
  overflow: hidden;
  box-shadow: var(--shadow);
}
.map-loading {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: var(--glass);
  border: 1px solid var(--glass-strong);
  border-radius: var(--radius);
  padding: 20px;
  color: var(--text-light);
  backdrop-filter: blur(10px);
  z-index: 10;
  display: flex;
  align-items: center;
  gap: 12px;
}

.map-loading::before {
  content: '';
  width: 20px;
  height: 20px;
  border: 2px solid var(--accent);
  border-top: 2px solid transparent;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
/* Estilos para el perfil de elevaci√≥n */
.perfil-elevacion-con-torres {
  background: var(--glass);
  border-radius: var(--radius);
  border: 1px solid var(--glass-strong);
  box-shadow: var(--shadow);
  backdrop-filter: blur(10px);
  padding: 32px;
  margin-bottom: 32px;
  position: relative;
  overflow: hidden;
}



/* Efecto de fondo con patr√≥n */
.perfil-elevacion-con-torres::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-image: 
    radial-gradient(circle at 25% 25%, rgba(0,188,212,0.05) 0%, transparent 50%),
    radial-gradient(circle at 75% 75%, rgba(30,136,229,0.05) 0%, transparent 50%);
  pointer-events: none;
  z-index: 0;
}

/* Efecto de borde inferior */
.perfil-elevacion-con-torres::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 100px;
  height: 3px;
  background: var(--gradient-primary);
  border-radius: 2px;
}

/* Estilos para la tabla interactiva */
.table-toolbar {
  transition: all 0.3s ease;
}

.table-toolbar:hover {
  box-shadow: 0 8px 25px rgba(59, 130, 246, 0.2);
}

.search-container input:focus {
  outline: none;
  border-color: rgba(59, 130, 246, 0.6);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.stats-badge {
  transition: all 0.3s ease;
}

.stats-badge:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.sortable:hover {
  background: rgba(59, 130, 246, 0.3) !important;
}

.sortable.sorted {
  background: rgba(59, 130, 246, 0.4) !important;
}

.sort-icon {
  transition: all 0.3s ease;
}

#tabla tbody tr {
  cursor: pointer;
}

#tabla tbody tr:hover {
  background: rgba(59, 130, 246, 0.05) !important;
}

.compact-view tbody tr td {
  padding: 8px 6px !important;
  font-size: 12px !important;
}

.compact-view thead th {
  padding: 10px 6px !important;
  font-size: 12px !important;
}

/* Animaciones para botones de acci√≥n */
#tabla tbody tr button {
  transition: all 0.3s ease;
}

#tabla tbody tr button:hover {
  background: rgba(59, 130, 246, 0.2) !important;
}

/* Estilos para paginaci√≥n */
.pagination-container button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.pagination-container button:not(:disabled):hover {
  background: rgba(59, 130, 246, 0.2) !important;
  border-color: rgba(59, 130, 246, 0.5) !important;
}

/* Mejoras generales para la tabla */
#tabla {
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  border: 2px solid rgba(59, 130, 246, 0.1);
  position: relative;
  z-index: 1;
}

.table-container {
  position: relative;
  overflow: hidden;
  z-index: 1;
  margin-top: -50px;
}

#tabla thead th {
  background: rgba(59, 130, 246, 0.1);
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1px;
  font-size: 13px;
  color: #3b82f6;
}

#tabla tbody tr:nth-child(even) {
  background: rgba(59, 130, 246, 0.02);
}

#tabla tbody tr:nth-child(odd) {
  background: rgba(255, 255, 255, 0.02);
}

/* Efecto de resplandor para filas seleccionadas */
#tabla tbody tr.selected {
  background: rgba(59, 130, 246, 0.15) !important;
  transition: all 0.3s ease;
}

/* Mejoras para el contenedor de acciones */
#tabla tbody tr td:last-child {
  background: rgba(59, 130, 246, 0.05);
  border-left: 1px solid rgba(255, 255, 255, 0.1);
}

/* Estilos adicionales para mejor experiencia */
.table-toolbar select:hover {
  border-color: rgba(59, 130, 246, 0.6) !important;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
}

.table-toolbar button:hover {
  background: rgba(59, 130, 246, 0.2) !important;
}

.stats-badge:hover {
  background: rgba(59, 130, 246, 0.2) !important;
}

#tabla tbody tr {
  transition: all 0.3s ease;
}

#tabla tbody tr:hover {
  background: rgba(59, 130, 246, 0.05) !important;
}

/* Animaci√≥n para los botones de acci√≥n */
#tabla tbody tr button {
  overflow: hidden;
  transition: all 0.3s ease;
}

/* Estilos mejorados para botones de acci√≥n */
#tabla tbody tr button {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  letter-spacing: 0.5px;
  border: 1px solid;
  font-weight: 600;
  min-width: 90px;
  height: 40px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}

/* Efectos espec√≠ficos para cada tipo de bot√≥n */
#tabla tbody tr button[title*="Mapa"] {
  background: rgba(59, 130, 246, 0.1);
  border-color: #3b82f6;
  color: #3b82f6;
}

#tabla tbody tr button[title*="Mapa"]:hover {
  background: rgba(37, 99, 235, 0.2) !important;
}

#tabla tbody tr button[title*="Perfil"] {
  background: rgba(16, 185, 129, 0.1);
  border-color: #10b981;
  color: #10b981;
}

#tabla tbody tr button[title*="Perfil"]:hover {
  background: rgba(5, 150, 105, 0.2) !important;
}

#tabla tbody tr button[title*="Editar"] {
  background: rgba(245, 158, 11, 0.1);
  border-color: #f59e0b;
  color: #f59e0b;
}

#tabla tbody tr button[title*="Editar"]:hover {
  background: rgba(217, 119, 6, 0.2) !important;
}

#tabla tbody tr button[title*="Copiar"] {
  background: rgba(139, 92, 246, 0.1);
  border-color: #8b5cf6;
  color: #8b5cf6;
}

#tabla tbody tr button[title*="Copiar"]:hover {
  background: rgba(124, 58, 237, 0.2) !important;
}

#tabla tbody tr button[title*="Informaci√≥n"] {
  background: rgba(59, 130, 246, 0.1);
  border-color: #3b82f6;
  color: #3b82f6;
}

#tabla tbody tr button[title*="Informaci√≥n"]:hover {
  background: rgba(37, 99, 235, 0.2) !important;
}

/* Estilos para el bot√≥n de recalcular factibilidad */
#btnRecalcularFactibilidad {
  background: linear-gradient(135deg, #06b6d415, #06b6d425);
  border: 2px solid #06b6d440;
  color: #06b6d4;
  box-shadow: 0 2px 8px #06b6d420;
}

#btnRecalcularFactibilidad:hover {
  background: linear-gradient(135deg, #0891b225, #0891b235);
  border-color: #0891b260;
  box-shadow: 0 6px 20px #06b6d440, 0 0 0 1px #06b6d460;
  transform: translateY(-2px) scale(1.02);
}

#btnRecalcularFactibilidad:active {
  transform: scale(0.98);
}

/* Efecto de pulso para botones activos */
#tabla tbody tr button:active {
  transform: scale(0.95);
  transition: transform 0.1s ease;
}

/* Mejoras para la columna de acciones */
#tabla tbody tr td:last-child {
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(59, 130, 246, 0.02));
  border-left: 2px solid rgba(59, 130, 246, 0.1);
}

/* Efecto de resplandor para botones en hover */
#tabla tbody tr button:hover {
  transform: translateY(-2px) scale(1.02);
  filter: brightness(1.1);
}

/* Efecto de resaltado para b√∫squeda */
.highlight-search {
  background: rgba(245, 158, 11, 0.3) !important;
  color: #f59e0b !important;
  font-weight: bold !important;
  padding: 2px 4px !important;
  border-radius: 3px !important;
}

.perfil-estadisticas-container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 16px;
  margin-top: 24px;
  padding: 24px;
  background: rgba(0,212,255,0.05);
  border-radius: var(--radius);
  border: 2px solid rgba(0,212,255,0.2);
  backdrop-filter: blur(15px);
  animation: estadisticasFloat 6s ease-in-out infinite;
}

@keyframes estadisticasFloat {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-3px); }
}

/* Estilos para el bot√≥n de estad√≠sticas */
#toggle-estadisticas-btn {
  position: relative;
  overflow: hidden;
}

#toggle-estadisticas-btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
  transition: left 0.6s;
}

#toggle-estadisticas-btn:hover::before {
  left: 100%;
}

#toggle-estadisticas-btn:hover {
  transform: translateY(-2px) scale(1.02);
  box-shadow: 0 8px 25px rgba(0,212,255,0.4);
}

/* Estilos para m√©tricas r√°pidas */
.metrica-rapida {
  position: relative;
  overflow: hidden;
  transition: all 0.3s ease;
}

.metrica-rapida::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
  transition: left 0.6s;
}

.metrica-rapida:hover::before {
  left: 100%;
}

.metrica-rapida:hover {
  transform: translateY(-3px) scale(1.05);
  box-shadow: 0 8px 25px rgba(0,0,0,0.3);
}

.metrica-valor {
  transition: all 0.3s ease;
}

/* Estilos para botones del panel de controles */
#exportar-perfil-btn, #comparar-enlaces-btn, #configuracion-avanzada-btn {
  position: relative;
  overflow: hidden;
}

#exportar-perfil-btn::before, #comparar-enlaces-btn::before, #configuracion-avanzada-btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
  transition: left 0.6s;
}

#exportar-perfil-btn:hover::before, #comparar-enlaces-btn:hover::before, #configuracion-avanzada-btn:hover::before {
  left: 100%;
}

#exportar-perfil-btn:hover, #comparar-enlaces-btn:hover, #configuracion-avanzada-btn:hover {
  transform: translateY(-2px) scale(1.02);
  box-shadow: 0 8px 25px rgba(0,0,0,0.3);
}

.perfil-estadistica-card {
  background: var(--glass-strong);
  border-radius: var(--radius);
  padding: 20px;
  border: 1px solid var(--glass-strong);
  text-align: center;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.perfil-estadistica-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(0,188,212,0.1), transparent);
  transition: left 0.6s;
}

.perfil-estadistica-card:hover::before {
  left: 100%;
}

.perfil-estadistica-card:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-glow);
  border-color: var(--accent);
}
.perfil-estadistica-valor {
  font-size: 26px;
  font-weight: 800;
  background: linear-gradient(135deg, var(--accent), var(--primary));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin-bottom: 8px;
  text-shadow: 0 0 10px rgba(0,212,255,0.3);
  transition: all 0.3s ease;
}

.perfil-estadistica-label {
  color: var(--text-muted);
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 1px;
  font-weight: 600;
  opacity: 0.8;
}

/* Estilos para modales y overlays */
.modal {
  background: var(--glass);
  border-radius: var(--radius);
  border: 1px solid var(--glass-strong);
  box-shadow: var(--shadow), var(--shadow-glow);
  backdrop-filter: blur(20px);
}

.modal-header {
  background: linear-gradient(135deg, var(--accent), var(--primary));
  color: #fff;
  padding: 20px 24px;
  border-radius: var(--radius) var(--radius) 0 0;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.modal-body {
  padding: 24px;
  color: var(--text-light);
}

/* Estilos para notificaciones */
.toast {
  background: var(--glass);
  border: 1px solid var(--glass-strong);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  backdrop-filter: blur(10px);
  color: var(--text-light);
  padding: 16px 20px;
  margin-bottom: 16px;
  transition: all 0.3s ease;
}

.toast.success {
  border-left: 4px solid var(--success);
}

.toast.error {
  border-left: 4px solid var(--danger);
}

.toast.warning {
  border-left: 4px solid var(--warning);
}

/* Estilos para estados de factibilidad */
.enlace-factible {
  background: rgba(16, 185, 129, 0.1) !important;
  border-left: 4px solid var(--success) !important;
}

.enlace-no-factible {
  background: rgba(239, 68, 68, 0.1) !important;
  border-left: 4px solid var(--danger) !important;
}

.factible {
  color: var(--success) !important;
  font-weight: 600;
}

.no-factible {
  color: var(--danger) !important;
  font-weight: 600;
}

/* Efectos de carga */
.loading {
  position: relative;
  overflow: hidden;
}

.loading::after {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
  animation: loading 1.5s infinite;
}

@keyframes loading {
  0% { left: -100%; }
  100% { left: 100%; }
}

/* Efectos de notificaci√≥n */
.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  background: var(--glass);
  border: 1px solid var(--glass-strong);
  border-radius: var(--radius);
  padding: 16px 20px;
  color: var(--text-light);
  box-shadow: var(--shadow);
  backdrop-filter: blur(10px);
  z-index: 1000;
  transform: translateX(100%);
  transition: transform 0.3s ease;
}

.notification.show {
  transform: translateX(0);
}
.notification.success {
  border-left: 4px solid var(--success);
}

.notification.error {
  border-left: 4px solid var(--danger);
}

.notification.warning {
  border-left: 4px solid var(--warning);
}
/* Efectos de hover para iconos */
.fas, .far, .fab {
  transition: all 0.3s ease;
}

.tab-button:hover .fas,
.tab-button:hover .far,
.tab-button:hover .fab {
  transform: scale(1.2) rotate(5deg);
}

/* Efectos de pulso para elementos importantes */
.pulse {
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% { box-shadow: 0 0 0 0 rgba(0, 188, 212, 0.7); }
  70% { box-shadow: 0 0 0 10px rgba(0, 188, 212, 0); }
  100% { box-shadow: 0 0 0 0 rgba(0, 188, 212, 0); }
}

/* Estilos para el bot√≥n de logout */
#logoutBtn::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
  transition: left 0.6s;
}

#logoutBtn:hover::before {
  left: 100%;
}

#logoutBtn:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-glow);
  background: var(--gradient-secondary);
}

#logoutBtn:active {
  transform: translateY(0px) scale(0.98);
}

/* Efectos de hover para iconos en el bot√≥n */
#logoutBtn:hover i {
  transform: scale(1.2) rotate(5deg);
}

/* Efecto de carga inicial */
.page-loader {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: var(--darker-bg);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  transition: opacity 0.5s ease, visibility 0.5s ease;
}

.page-loader.hidden {
  opacity: 0;
  visibility: hidden;
}

.loader-spinner {
  width: 60px;
  height: 60px;
  border: 4px solid var(--glass-strong);
  border-top: 4px solid var(--accent);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

.loader-text {
  position: absolute;
  bottom: 40%;
  color: var(--text-light);
  font-size: 18px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1px;
  animation: fadeInOut 2s ease-in-out infinite;
}

@keyframes fadeInOut {
  0%, 100% { opacity: 0.5; }
  50% { opacity: 1; }
}

/* Part√≠culas flotantes */
.floating-particles {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: -1;
}

.particle {
  position: absolute;
  width: 4px;
  height: 4px;
  background: var(--accent);
  border-radius: 50%;
  opacity: 0.3;
  animation: float 6s infinite linear;
}

.particle:nth-child(1) { left: 10%; animation-delay: 0s; }
.particle:nth-child(2) { left: 20%; animation-delay: 1s; }
.particle:nth-child(3) { left: 30%; animation-delay: 2s; }
.particle:nth-child(4) { left: 40%; animation-delay: 3s; }
.particle:nth-child(5) { left: 50%; animation-delay: 4s; }
.particle:nth-child(6) { left: 60%; animation-delay: 5s; }
.particle:nth-child(7) { left: 70%; animation-delay: 0s; }
.particle:nth-child(8) { left: 80%; animation-delay: 1s; }
.particle:nth-child(9) { left: 90%; animation-delay: 2s; }

@keyframes float {
  0% {
    transform: translateY(100vh) rotate(0deg);
    opacity: 0;
  }
  10% {
    opacity: 0.3;
  }
  90% {
    opacity: 0.3;
  }
  100% {
    transform: translateY(-100px) rotate(360deg);
    opacity: 0;
  }
}
.fangio-header {
  display: flex;
  align-items: center;
  gap: 32px;
  background: linear-gradient(135deg, var(--darker-bg), var(--dark-bg));
  border-radius: var(--radius);
  box-shadow: var(--shadow), var(--shadow-glow);
  border: 1px solid var(--glass-strong);
  padding: 40px 48px;
  margin-bottom: 40px;
  position: relative;
  overflow: hidden;
  min-height: 160px;
  justify-content: flex-start;
  backdrop-filter: blur(10px);
}




.fangio-logo-box {
  background: #fff;
  border-radius: 18px;
  box-shadow: 0 2px 12px rgba(0,188,212,0.10);
  padding: 12px 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  min-width: 110px;
  min-height: 110px;
}
.fangio-logo-img {
  width: 80px;
  height: 80px;
  object-fit: contain;
  display: block;
}
.fangio-title-box {
  display: flex;
  flex-direction: column;
  justify-content: center;
  z-index: 2;
}
.fangio-title {
  font-size: 2.8rem;
  font-weight: 800;
  color: #00e6ff;
  text-shadow: 0 0 18px #00e6ff55, 0 2px 8px #1e88e5cc;
  margin: 0 0 10px 0;
  letter-spacing: 2px;
}
.fangio-subtitle {
  font-size: 1.3rem;
  color: #2196f3;
  font-weight: 600;
  margin-top: 0;
  letter-spacing: 1px;
  text-shadow: 0 1px 8px #1e88e555;
}
.fangio-header-decoration {
  position: absolute;
  right: -80px;
  top: -60px;
  width: 320px;
  height: 320px;
  background: radial-gradient(circle at 60% 40%, #00bcd4 0%, #1e88e5 60%, transparent 100%);
  opacity: 0.18;
  z-index: 1;
  pointer-events: none;
}
@media (max-width: 900px) {
  .fangio-header {
    flex-direction: column;
    align-items: flex-start;
    padding: 18px 10px 18px 10px;
    min-height: 0;
    gap: 18px;
  }
  .fangio-header-decoration {
    width: 180px;
    height: 180px;
    right: -40px;
    top: -30px;
  }
  .fangio-logo-box {
    min-width: 70px;
    min-height: 70px;
    padding: 6px 8px;
  }
  .fangio-logo-img {
    width: 48px;
    height: 48px;
  }
  .fangio-title {
    font-size: 1.5rem;
  }
  .fangio-subtitle {
    font-size: 1rem;
  }
}
.btn-institucional {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  background: linear-gradient(90deg, #00bcd4 60%, #1e88e5 100%);
  color: #fff;
  font-weight: 700;
  font-size: 1.08rem;
  padding: 12px 26px;
  border-radius: 14px;
  text-decoration: none;
  box-shadow: 0 2px 12px rgba(30,136,229,0.10);
  margin-left: auto;
  transition: background 0.2s, box-shadow 0.2s, color 0.2s;
  border: none;
  outline: none;
}
.btn-institucional:hover {
  background: linear-gradient(90deg, #1e88e5 60%, #00bcd4 100%);
  color: #fff;
  box-shadow: 0 4px 18px rgba(30,136,229,0.18);
  text-decoration: none;
}
@media (max-width: 700px) {
  .btn-institucional {
   display: none;
  }
}
.fangio-tower-bg {
  position: absolute;
  bottom: 0;
  left: 0;
  height: 100%;
  width: 160px;
  pointer-events: none;
  z-index: 0;
  opacity: 0.18;
  display: flex;
  align-items: flex-end;
  justify-content: flex-start;
}
.fangio-tower-bg svg {
  height: 90%;
  width: auto;
  min-width: 80px;
  max-width: 120px;
  display: block;
}
@media (max-width: 900px) {
  .fangio-tower-bg {
    opacity: 0.10;
    width: 80px;
  }
  .fangio-tower-bg svg {
    min-width: 40px;
    max-width: 60px;
  }
}
#mapa-enlaces {
  margin-left: 340px; 
}
table, th, td {
  white-space: nowrap;
  vertical-align: middle;
}
tbody tr {
  height: 36px;
  min-height: 36px;
  max-height: 40px;
}
#panel-detalle-enlace {
  display: none;
  position: fixed;
  right: 0;
  top: 120px;
  width: 340px;
  max-width: 95vw;
  height: calc(100vh - 120px); 
  background: #fff;
  color: #222;
  border-radius: 18px 0 0 18px;
  box-shadow: 2px 0 18px #00bcd455;
  z-index: 2000;
  padding: 24px 18px 24px 18px;
  overflow-y: auto;
  font-size: 1rem;
}
#mapa-enlaces {
  margin-left: 0 !important;
  margin-right: 340px !important;
}
@media (max-width: 700px) {
  #panel-detalle-enlace {
    width: 98vw;
    border-radius: 0 0 18px 18px;
    height: auto;
    max-height: 80vh;
  }
  #mapa-enlaces {
    margin-left: 0 !important;
  }
}
#panel-detalle-enlace {
  z-index: 999999 !important;
  top: 0 !important;
  height: 100vh !important;
}
#detalle-enlace-contenido {
  padding-bottom: 40px;
}
#panel-detalle-enlace {
  top: 0 !important;
  height: 100vh !important;
  max-height: 100vh !important;
  overflow-y: auto !important;
}
.table-container {
  max-width: 100vw;
  overflow-x: auto;
  margin-bottom: 24px;
}
#tab-mismoTransporte .table-container {
  max-height: 60vh;
  overflow-y: auto;
}
#tab-mismoTransporte {
  overflow: visible !important;
}
#tab-mismoTransporte table {
  font-size: 13px;
  border-radius: 12px;
  background: #101a2a;
}
#tab-mismoTransporte th, #tab-mismoTransporte td {
  padding: 7px 10px;
  border-bottom: 1px solid #1e88e533;
  white-space: nowrap;
}
#tab-mismoTransporte th {
  background: #0b111f;
  color: #00e6ff;
  position: sticky;
  top: 0;
  z-index: 2;
}
#tab-mismoTransporte tr:hover {
  background: #1e88e522;
}
#tab-mismoTransporte .table-container {
  max-width: 100vw;
  overflow-x: auto;
  background: #101a2a;
  border-radius: 14px;
  border: 1.5px solid #00e6ff44;
  box-shadow: 0 2px 18px #00e6ff22;
  margin-bottom: 18px;
  padding: 0;
}
#tab-mismoTransporte table {
  font-size: 13px;
  border-radius: 12px;
  background: #101a2a;
  min-width: 1200px;
}
#tab-mismoTransporte th, #tab-mismoTransporte td {
  padding: 7px 10px;
  border-bottom: 1px solid #1e88e533;
  white-space: nowrap;
  text-align: center;
}
#tab-mismoTransporte th {
  background: #0b111f;
  color: #00e6ff;
  position: sticky;
  top: 0;
  z-index: 2;
  font-size: 13px;
  letter-spacing: 0.5px;
}
#tab-mismoTransporte tr:hover {
  background: #1e88e522;
}
#tab-mismoTransporte td:last-child {
  min-width: 120px;
  max-width: 140px;
  text-align: center;
  white-space: nowrap;
  overflow: hidden;
}
#tab-mismoTransporte button.btn-info {
  padding: 4px 10px;
  font-size: 12px;
  border-radius: 8px;
}
#tab-mismoTransporte .action-buttons {
  display: flex;
  gap: 12px;
  margin-bottom: 10px;
  flex-wrap: wrap;
}
#tab-mismoTransporte .enlaces-counter {
  margin-bottom: 8px;
  font-size: 1.08rem;
  color: #00e6ff;
  font-weight: 600;
}
#tab-mismoTransporte table {
  font-size: 13px;
  border-radius: 12px;
  background: #101a2a;
}
#tab-mismoTransporte th, #tab-mismoTransporte td {
  padding: 7px 10px;
  border-bottom: 1px solid #1e88e533;
  white-space: nowrap;
}
#tab-mismoTransporte th {
  background: #0b111f;
  color: #00e6ff;
  position: sticky;
  top: 0;
  z-index: 2;
}
#tab-mismoTransporte tr:hover {
  background: #1e88e522;
}
.fangio-video-wrapper {
  position: relative;
  width: 100%;
  max-width: 600px;
  aspect-ratio: 16/9;
  margin: 32px auto 0 auto;
  border-radius: 22px;
  overflow: hidden;
  box-shadow: 0 0 32px #00e6ff66, 0 2px 18px #00e6ff33;
  background: linear-gradient(135deg, #0b111f 60%, #1e88e5 100%);
  display: flex;
  align-items: center;
  justify-content: center;
}
.fangio-video-glow {
  position: absolute;
  inset: 0;
  border-radius: 22px;
  pointer-events: none;
  z-index: 1;
  box-shadow: 0 0 60px 10px #00e6ff88, 0 0 0 8px #00e6ff33 inset;
  animation: fangio-glow 2.5s infinite alternate;
}
@keyframes fangio-glow {
  0% { box-shadow: 0 0 60px 10px #00e6ff88, 0 0 0 8px #00e6ff33 inset; }
  100% { box-shadow: 0 0 90px 18px #00e6ffcc, 0 0 0 12px #00e6ff44 inset; }
}
.fangio-video {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 22px;
  z-index: 2;
  background: #000;
  display: block;
}
@media (max-width: 700px) {
  .fangio-video-wrapper {
    max-width: 98vw;
    border-radius: 12px;
  }
  .fangio-video-glow {
    border-radius: 12px;
  }
  .fangio-video {
    border-radius: 12px;
  }
}
.video-hero-bg {
  display: flex;
  justify-content: center;
  align-items: center;
  width: 100%;
  max-width: 700px;
  margin: 40px auto 32px auto;
  background: linear-gradient(135deg, #101a2a 60%, #1e88e5 100%);
  border-radius: 24px;
  box-shadow: 0 8px 40px #00e6ff22, 0 2px 18px #00e6ff11;
  padding: 0;
  overflow: hidden;
}
.video-hero {
  width: 100%;
  aspect-ratio: 16/9;
  border-radius: 24px;
  object-fit: cover;
  display: block;
  box-shadow: 0 2px 24px #000a;
}
@media (max-width: 900px) {
  .video-hero-bg { max-width: 98vw; border-radius: 12px; }
  .video-hero { border-radius: 12px; }
}
.video-banner {
  width: 100%;
  max-width: 1200px;
  height: 280px;
  margin: 32px auto 32px auto;
  position: relative;
  overflow: hidden;
  border-radius: 0;
  box-shadow: none;
  background: #000;
  display: flex;
  align-items: center;
  justify-content: center;
}
.video-banner-video {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
  border-radius: 0;
  box-shadow: none;
  background: #000;
}
.video-banner-overlay {
  position: absolute;
  left: 0; top: 0; width: 100%; height: 100%;
  display: flex; align-items: center; justify-content: center;
  color: #fff;
  font-size: 2.2rem;
  font-weight: 800;
  background: rgba(0,0,0,0.18);
  text-shadow: 0 2px 16px #000;
  pointer-events: none;
}
@media (max-width: 900px) {
  .video-banner { height: 180px; }
  .video-banner-overlay { font-size: 1.2rem; }
}
.banner-hero {
  position: relative;
  width: 100%;
  min-height: 220px;
  max-height: 320px;
  height: 280px;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  border-radius: 0 0 32px 32px;
  margin-bottom: 32px;
  background: none;
  box-shadow: 0 8px 40px #00e6ff22, 0 2px 18px #00e6ff11;
}
.banner-hero video {
  position: absolute;
  top: 0; left: 0;
  width: 100%;
  height: 100%;
  min-height: 220px;
  max-height: 320px;
  object-fit: cover;
  filter: blur(0.01px) brightness(0.95);
  opacity: 0.96;
  z-index: 0;
  border-radius: 0 0 32px 32px;
}
.banner-hero-overlay {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2;
  background: linear-gradient(120deg, rgba(11,17,31,0.55) 60%, rgba(30,136,229,0.18) 100%);
  pointer-events: none;
}

.banner-hero-content {
  display: flex;
  align-items: center;
  gap: 32px;
  z-index: 3;
  background: rgba(10,20,40,0.72);
  border-radius: 22px;
  padding: 32px 38px;
  box-shadow: 0 4px 32px #00e6ff22;
  pointer-events: auto;
  margin: 0 auto;
}
  
.banner-hero-logo {
  width: 90px;
  height: 90px;
  border-radius: 18px;
  background: #fff;
  box-shadow: 0 2px 12px #00e6ff33;
  margin-right: 18px;
}
.banner-hero-title {
  font-size: 2.8rem;
  font-weight: 800;
  color: #00e6ff;
  text-shadow: 0 0 18px #00e6ff55, 0 2px 8px #1e88e5cc;
  margin: 0 0 10px 0;
  letter-spacing: 2px;
}
.banner-hero-subtitle {
  font-size: 1.3rem;
  color: #2196f3;
  font-weight: 600;
  margin-bottom: 10px;
  letter-spacing: 1px;
  text-shadow: 0 1px 8px #1e88e555;
}

/* Mejoras adicionales para el mapa profesional - PANTALLA COMPLETA */
.leaflet-container {
  border-radius: 0 !important;
  overflow: hidden !important;
  width: 100vw !important;
  height: 100vh !important;
}

.leaflet-control-zoom {
  border-radius: 15px !important;
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3) !important;
  border: 2px solid rgba(255, 255, 255, 0.15) !important;
  background: rgba(15, 23, 42, 0.95) !important;
  backdrop-filter: blur(15px) !important;
  margin: 20px !important;
}

.leaflet-control-zoom a {
  background: rgba(59, 130, 246, 0.1) !important;
  border: 1px solid rgba(59, 130, 246, 0.3) !important;
  color: #3b82f6 !important;
  transition: all 0.3s ease !important;
}

.leaflet-control-zoom a:hover {
  background: rgba(59, 130, 246, 0.2) !important;
  border-color: rgba(59, 130, 246, 0.5) !important;
  transform: scale(1.05) !important;
}

/* Mejorar la leyenda del mapa - PANTALLA COMPLETA */
.info.legend {
  background: rgba(15, 23, 42, 0.98) !important;
  border: 3px solid rgba(59, 130, 246, 0.5) !important;
  border-radius: 20px !important;
  box-shadow: 0 12px 35px rgba(0, 0, 0, 0.4) !important;
  backdrop-filter: blur(20px) !important;
  color: #e2e8f0 !important;
  font-weight: 500 !important;
  margin: 20px !important;
  padding: 20px !important;
  font-size: 14px !important;
}

.info.legend h4 {
  color: #3b82f6 !important;
  font-weight: 600 !important;
  margin-bottom: 12px !important;
}

/* Mapa en pantalla completa */
#mapa-enlaces {
  width: 100vw !important;
  height: 100vh !important;
  max-width: 100% !important;
  margin: 0 !important;
  border-radius: 0 !important;
  box-shadow: none !important;
  border: none !important;
  overflow: hidden !important;
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(16, 185, 129, 0.05)) !important;
  backdrop-filter: blur(10px) !important;
  transition: all 0.3s ease !important;
  z-index: 1000 !important;
}
</style>


  
  <style>
  .tab-content {
  display: none;
}
.tab-content.active {
  display: block;
}
:root {
  --accent: #00d4ff;
  --primary: #3b82f6;
  --secondary: #1d4ed8;
  --success: #10b981;
  --warning: #f59e0b;
  --danger: #ef4444;
  --dark-bg: #0a0f1c;
  --darker-bg: #050a14;
  --text-light: #f8fafc;
  --text-muted: #cbd5e1;
  --glass: rgba(255,255,255,0.08);
  --glass-strong: rgba(255,255,255,0.12);
  --radius: 20px;
  --shadow: 0 20px 60px rgba(0,0,0,0.4);
  --shadow-glow: 0 0 40px rgba(0,212,255,0.4);
  --gradient-primary: linear-gradient(135deg, #00d4ff, #3b82f6, #1d4ed8);
  --gradient-secondary: linear-gradient(135deg, #3b82f6, #1d4ed8, #1e40af);
  --gradient-success: linear-gradient(135deg, #10b981, #059669, #047857);
  --gradient-warning: linear-gradient(135deg, #f59e0b, #d97706, #b45309);
  --gradient-danger: linear-gradient(135deg, #ef4444, #dc2626, #b91c1c);
  --neon-glow: 0 0 20px rgba(0,212,255,0.6);
  --glass-border: 1px solid rgba(255,255,255,0.1);
}
* {
  box-sizing: border-box;
  font-family: 'Inter', sans-serif;
}

/* Transiciones suaves globales */
* {
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Excepciones para elementos que no necesitan transici√≥n */
*, *::before, *::after {
  transition: color 0.3s ease, background-color 0.3s ease, border-color 0.3s ease, 
              box-shadow 0.3s ease, transform 0.3s ease, opacity 0.3s ease;
}
body, html {
  margin: 0;
  min-height: 100vh;
  background: 
    radial-gradient(circle at 20% 80%, rgba(0, 212, 255, 0.15) 0%, transparent 50%),
    radial-gradient(circle at 80% 20%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
    radial-gradient(circle at 40% 40%, rgba(16, 185, 129, 0.05) 0%, transparent 50%),
    linear-gradient(135deg, var(--darker-bg) 0%, #0f172a 25%, #1e293b 50%, #334155 75%, var(--dark-bg) 100%);
  color: var(--text-light);
  font-family: 'Inter', sans-serif;
  overflow-x: hidden;
  position: relative;
  scroll-behavior: smooth;
  animation: backgroundShift 30s ease-in-out infinite;
}

@keyframes backgroundShift {
  0%, 100% { 
    background-position: 0% 0%, 100% 100%, 50% 50%, 0% 0%;
  }
  25% { 
    background-position: 100% 0%, 0% 100%, 50% 50%, 100% 0%;
  }
  50% { 
    background-position: 100% 100%, 0% 0%, 50% 50%, 100% 100%;
  }
  75% { 
    background-position: 0% 100%, 100% 0%, 50% 50%, 0% 100%;
  }
}

/* Scrollbar personalizado mejorado */
::-webkit-scrollbar {
  width: 14px;
  background: var(--darker-bg);
  border-radius: var(--radius);
}

::-webkit-scrollbar-thumb {
  background: var(--gradient-primary);
  border-radius: var(--radius);
  border: 3px solid var(--darker-bg);
  transition: all 0.3s ease;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--gradient-secondary);
  transform: scale(1.1);
}

::-webkit-scrollbar-track {
  background: var(--glass);
  border-radius: var(--radius);
  margin: 4px;
}


.container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 40px 20px;
   background: none !important;
  box-shadow: none !important;
  position: relative;
}

/* Efecto de borde luminoso para el contenedor principal */
.container::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(45deg, transparent 30%, rgba(0,188,212,0.1) 50%, transparent 70%);
  border-radius: var(--radius);
  z-index: -1;
  animation: borderGlow 4s ease-in-out infinite;
}

@keyframes borderGlow {
  0%, 100% { opacity: 0.3; }
  50% { opacity: 0.8; }
}
.header {
  background: transparent;
  box-shadow: none;
  border: none;
  border-radius: 0;
  padding: 0;
  margin-bottom: 30px;
  display: flex;
  align-items: center;
  gap: 30px;
}
.logo-container .logo-wrapper {
  width: 110px;
  height: 110px;
}
.logo img {
  width: 100%;
  height: 100%;
  border-radius: var(--radius);
  background: linear-gradient(135deg, #fff, #f8fafc);
  box-shadow: var(--shadow), var(--neon-glow);
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  border: 3px solid var(--glass-border);
  position: relative;
  overflow: hidden;
}

.logo img::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  /* background: linear-gradient(90deg, transparent, rgba(0,212,255,0.3), transparent); */
  transition: left 0.6s;
}

.logo img:hover::before {
  left: 100%;
}

.logo img:hover {
  transform: scale(1.1) rotate(3deg);
  box-shadow: 0 0 50px rgba(0, 212, 255, 0.6);
  border-color: var(--accent);
}
.company-info h1 {
  font-size: 4rem;
  font-weight: 900;
  background: var(--gradient-primary);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  text-shadow: 0 0 30px rgba(0,212,255,0.8);
  margin-bottom: 15px;
  position: relative;
  animation: titleGlow 4s ease-in-out infinite alternate;
  letter-spacing: -1px;
}

.company-info h1::before {
  content: '';
  position: absolute;
  top: -10px;
  left: -10px;
  right: -10px;
  bottom: -10px;
  background: var(--gradient-primary);
  filter: blur(20px);
  opacity: 0.3;
  z-index: -1;
  animation: titlePulse 4s ease-in-out infinite alternate;
}

@keyframes titleGlow {
  0% { 
    filter: drop-shadow(0 0 20px rgba(0, 212, 255, 0.5)) drop-shadow(0 0 40px rgba(0, 212, 255, 0.3));
  }
  100% { 
    filter: drop-shadow(0 0 30px rgba(0, 212, 255, 0.8)) drop-shadow(0 0 60px rgba(0, 212, 255, 0.4));
  }
}

@keyframes titlePulse {
  0% { opacity: 0.2; transform: scale(1); }
  100% { opacity: 0.4; transform: scale(1.05); }
}
.company-info .subtitle {
  font-size: 1.6rem;
  background: var(--gradient-secondary);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  font-weight: 700;
  margin-top: 15px;
  padding-left: 0;
  text-transform: uppercase;
  letter-spacing: 2px;
  animation: subtitleFloat 3s ease-in-out infinite;
}

@keyframes subtitleFloat {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-5px); }
}
.premium-badge {
  display: none;
}
.main-content {
  background: transparent;
  border-radius: var(--radius);
  box-shadow: none;
  border: none;
  padding: 20px;
  margin-top: 20px;
  backdrop-filter: none;
  position: relative;
  overflow: visible;
}

@keyframes torreInfoFloat {
  0%, 100% { transform: translateX(-50%) translateY(0px); }
  50% { transform: translateX(-50%) translateY(-5px); }
}
.tabs {
  display: flex;
  gap: 18px;
  margin-bottom: 40px;
  justify-content: center;
  position: relative;
  z-index: 1;
}

/* L√≠nea decorativa bajo las pesta√±as */
.tabs::after {
  content: '';
  position: absolute;
  bottom: -10px;
  left: 50%;
  transform: translateX(-50%);
  width: 200px;
  height: 2px;
  background: var(--gradient-primary);
  border-radius: 1px;
  opacity: 0.6;
}
.tab-button {
  background: rgba(59,130,246,0.1);
  color: var(--text-light);
  border: 2px solid rgba(59,130,246,0.2);
  border-radius: var(--radius);
  padding: 20px 40px;
  font-size: 1.1rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: var(--shadow);
  position: relative;
  overflow: hidden;
  text-transform: uppercase;
  letter-spacing: 1px;
  min-width: 200px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  font-family: 'Inter', sans-serif;
}

.tab-button::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
  transition: left 0.5s;
}

.tab-button:hover::before {
  left: 100%;
}

.tab-button.active, .tab-button:hover {
  background: var(--gradient-primary);
  color: #fff;
  box-shadow: var(--neon-glow);
  transform: translateY(-5px) scale(1.05);
  border-color: var(--accent);
  animation: tabGlow 2s ease-in-out infinite alternate;
}

.tab-button.active {
  background: var(--gradient-primary);
  border-color: var(--accent);
  box-shadow: var(--neon-glow);
  animation: activeTabPulse 2s ease-in-out infinite;
}

@keyframes tabGlow {
  0% { box-shadow: var(--neon-glow); }
  100% { box-shadow: 0 0 40px rgba(0,212,255,0.8); }
}

@keyframes activeTabPulse {
  0%, 100% { 
    box-shadow: var(--neon-glow);
    transform: translateY(-5px) scale(1.05);
  }
  50% { 
    box-shadow: 0 0 50px rgba(0,212,255,1);
    transform: translateY(-5px) scale(1.08);
  }
}

/* Animaciones para el sistema inteligente de selecci√≥n */
@keyframes slideInRight {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

@keyframes slideInDown {
  from {
    transform: translateX(-50%) translateY(-100%);
    opacity: 0;
  }
  to {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
  }
}

@keyframes pulse {
  0% {
    transform: scale(1);
    box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7);
  }
  70% {
    transform: scale(1.05);
    box-shadow: 0 0 0 10px rgba(220, 38, 38, 0);
  }
  100% {
    transform: scale(1);
    box-shadow: 0 0 0 0 rgba(220, 38, 38, 0);
  }
}
.frecuencia-info {
  background: rgba(59,130,246,0.1);
  border: 2px solid var(--accent);
  border-radius: var(--radius);
  color: var(--accent);
  font-weight: 700;
  margin-bottom: 30px;
  padding: 25px;
  position: relative;
  overflow: hidden;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

/* @keyframes frecuenciaPulse {
  0%, 100% { 
    box-shadow: var(--neon-glow);
    border-color: var(--accent);
  }
  50% { 
    box-shadow: 0 0 30px rgba(0,212,255,0.8);
    border-color: #00d4ff;
  }
} */

/* .frecuencia-info::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(0,188,212,0.1), transparent);
  transition: left 0.8s;
}

.frecuencia-info:hover::before {
  left: 100%;
} */
.file-upload {
  background: linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
  border: 2px dashed rgba(255,255,255,0.2);
  backdrop-filter: blur(10px);
  border-radius: 16px;
  padding: 30px;
  margin-bottom: 30px;
  text-align: center;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}
.file-upload label {
  display: inline-flex;
  align-items: center;
  gap: 12px;
  padding: 18px 36px;
  background: linear-gradient(135deg, var(--accent), var(--primary));
  color: #fff;
  border-radius: var(--radius);
  cursor: pointer;
  font-weight: 600;
  font-size: 16px;
  transition: all 0.3s ease;
  box-shadow: var(--shadow);
  position: relative;
  overflow: hidden;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.file-upload label::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
  transition: left 0.6s;
}

.file-upload label:hover::before {
  left: 100%;
}
.file-upload label:hover {
  background: linear-gradient(135deg, var(--primary), var(--accent));
  transform: translateY(-2px);
  box-shadow: var(--shadow-glow);
}
.file-upload input[type="file"] {
  display: none;
}
.form-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 24px 32px;
  background: transparent;
  padding: 0;
  border-radius: 0;
  margin-top: 0;
  max-width: 1200px;
  width: 100%;
  box-shadow: none;
  border: none;
  position: relative;
  z-index: 1;
}

/* Efecto de fondo sutil para el grid */
.form-grid::before {
  content: '';
  position: absolute;
  top: -20px;
  left: -20px;
  right: -20px;
  bottom: -20px;
  background: radial-gradient(circle at 50% 50%, rgba(0,188,212,0.02) 0%, transparent 70%);
  border-radius: var(--radius);
  z-index: -1;
}
@media (max-width: 1200px) {
  .form-grid { grid-template-columns: repeat(2, 1fr); max-width: 900px; }
}
@media (max-width: 900px) {
  .main-content { padding: 16px 4px 10px 4px; max-width: 100vw; }
  .form-grid { grid-template-columns: 1fr; padding: 0; max-width: 100vw; }
}
.form-grid label {
  font-weight: 600;
  background: linear-gradient(135deg, var(--accent), var(--primary));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin-bottom: 8px;
  display: block;
  letter-spacing: 0.5px;
  text-transform: uppercase;
  font-size: 12px;
  position: relative;
}

.form-grid label::after {
  content: '';
  position: absolute;
  bottom: -2px;
  left: 0;
  width: 0;
  height: 2px;
  background: linear-gradient(135deg, var(--accent), var(--primary));
  transition: width 0.3s ease;
}

.form-grid label:hover::after {
  width: 100%;
}
.form-grid input, .form-grid select {
  width: 100%;
  padding: 18px 24px;
  border-radius: var(--radius);
  border: 2px solid rgba(0,212,255,0.2);
  background: rgba(0,212,255,0.05);
  color: var(--text-light);
  font-size: 15px;
  font-weight: 500;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  backdrop-filter: blur(10px);
  position: relative;
  z-index: 1;
  box-shadow: 0 4px 20px rgba(0,0,0,0.1);
}

/* Efecto de borde luminoso en hover */
.form-grid input:hover, .form-grid select:hover {
  border-color: rgba(0,188,212,0.5);
  box-shadow: 0 0 15px rgba(0,188,212,0.1);
}

.form-grid input:focus, .form-grid select:focus {
  background: rgba(0,212,255,0.1);
  border-color: var(--accent);
  box-shadow: var(--neon-glow);
  outline: none;
  transform: translateY(-3px) scale(1.02);
  border-width: 3px;
  animation: inputFocus 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes inputFocus {
  0% { 
    transform: translateY(-3px) scale(1.02);
    box-shadow: var(--neon-glow);
  }
  50% { 
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 0 30px rgba(0,212,255,0.8);
  }
  100% { 
    transform: translateY(-3px) scale(1.02);
    box-shadow: var(--neon-glow);
  }
}

.form-grid input[readonly] {
  background: var(--darker-bg);
  color: var(--text-muted);
  border-style: dashed;
}
.form-grid input:focus, .form-grid select:focus {
  background: #22304a;
  border-color: var(--accent);
}
.form-grid input[readonly] {
  background: #16202e;
  color: #b2ebf2;
  border-style: dashed;
}
.action-buttons .btn,
.btn {
  background: var(--gradient-primary);
  color: #fff;
  font-weight: 700;
  padding: 16px 32px;
  border-radius: var(--radius);
  cursor: pointer;
  font-size: 1.1rem;
  border: none;
  margin: 8px 10px 8px 0;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: var(--shadow);
  position: relative;
  overflow: hidden;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  font-family: 'Inter', sans-serif;
}

.btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
  transition: left 0.5s;
}

.btn:hover::before {
  left: 100%;
}

.btn:active {
  transform: translateY(0px) scale(0.98);
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}

.btn:hover {
  background: var(--gradient-secondary);
  transform: translateY(-4px) scale(1.05);
  box-shadow: var(--neon-glow);
  transition: all 0.3s ease;
}
.table-container {
  background: rgba(15, 23, 42, 0.95);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  border: none;
  padding: 30px;
  overflow-x: auto;
  backdrop-filter: blur(15px);
  position: relative;
  overflow: hidden;
}
table {
  border-collapse: collapse;
  width: 100%;
  background: transparent;
  color: var(--text-light);
}
th, td {
  padding: 14px 16px;
  text-align: left;
  font-size: 14px;
  border-bottom: 1px solid var(--glass-strong);
  transition: all 0.3s ease;
}

th {
  background: var(--gradient-primary);
  color: #fff;
  font-weight: 800;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  font-size: 12px;
  position: relative;
  overflow: hidden;
  padding: 18px 20px;
  border-bottom: 2px solid rgba(0,212,255,0.3);
}

th::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
  transition: left 0.6s;
}

th:hover::before {
  left: 100%;
}
tr:hover {
  background: rgba(0,212,255,0.1);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0,212,255,0.2);
  border-left: 4px solid var(--accent);
  transition: all 0.3s ease;
}

tr.selected {
  background: var(--gradient-primary) !important;
  color: #fff !important;
  box-shadow: var(--neon-glow);
  border-left: 4px solid #fff;
  transition: all 0.3s ease;
}
::-webkit-scrollbar {
  width: 12px;
  background: var(--darker-bg);
  border-radius: var(--radius);
}

::-webkit-scrollbar-thumb {
  background: linear-gradient(135deg, var(--accent), var(--primary));
  border-radius: var(--radius);
  border: 2px solid var(--darker-bg);
}

::-webkit-scrollbar-thumb:hover {
  background: linear-gradient(135deg, var(--primary), var(--accent));
}
/* Estilos espec√≠ficos para torres */
.tower-input-group {
  position: relative;
  margin-bottom: 16px;
}

.tower-label {
  display: block;
  font-weight: 600;
  color: var(--accent);
  margin-bottom: 8px;
  font-size: 14px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.tower-input, .tower-select {
  width: 100%;
  padding: 12px 16px;
  border-radius: var(--radius);
  border: 1px solid var(--glass-strong);
  background: var(--glass);
  color: var(--text-light);
  font-size: 14px;
  transition: all 0.3s ease;
  backdrop-filter: blur(5px);
}

.tower-input:focus, .tower-select:focus {
  background: var(--glass-strong);
  border-color: var(--accent);
  box-shadow: var(--shadow-glow);
  outline: none;
}

.th-tower {
  background: linear-gradient(135deg, var(--warning), var(--danger)) !important;
  color: #fff !important;
}

/* Animaciones para torres */
.tower-info {
  transition: all 0.3s ease;
}

@media (max-width: 768px) {
  .container { padding: 10px; }
  .main-content { padding: 10px; }
  .form-grid { gap: 12px 8px; }
  th, td { padding: 8px 6px; }
}

/* Estilos para el dashboard */
.dashboard-container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 24px;
  margin-bottom: 32px;
}

.dashboard-card {
  background: var(--glass);
  border-radius: var(--radius);
  padding: 24px;
  border: 1px solid var(--glass-strong);
  box-shadow: var(--shadow);
  backdrop-filter: blur(10px);
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.dashboard-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 4px;
  background: linear-gradient(135deg, var(--accent), var(--primary));
  transform: scaleX(0);
  transition: transform 0.3s ease;
}

.dashboard-card:hover::before {
  transform: scaleX(1);
}

.dashboard-card:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-glow);
}

.dashboard-card h3 {
  color: var(--accent);
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 16px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.dashboard-stat {
  font-size: 32px;
  font-weight: 700;
  color: var(--text-light);
  margin-bottom: 8px;
}

.dashboard-label {
  color: var(--text-muted);
  font-size: 14px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* Estilos para gr√°ficos */
.chart-container {
  background: var(--glass);
  border-radius: var(--radius);
  padding: 32px;
  border: 1px solid var(--glass-strong);
  box-shadow: var(--shadow);
  backdrop-filter: blur(10px);
  margin-bottom: 32px;
  position: relative;
  overflow: hidden;
}

/* Efecto de esquinas decorativas */
.chart-container::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 20px;
  height: 20px;
  border-top: 3px solid var(--accent);
  border-left: 3px solid var(--accent);
  border-radius: var(--radius) 0 0 0;
}

.chart-container::after {
  content: '';
  position: absolute;
  bottom: 0;
  right: 0;
  width: 20px;
  height: 20px;
  border-bottom: 3px solid var(--primary);
  border-right: 3px solid var(--primary);
  border-radius: 0 0 var(--radius) 0;
}

.chart-title {
  color: var(--accent);
  font-size: 20px;
  font-weight: 600;
  margin-bottom: 16px;
  text-align: center;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* Estilos para el mapa */
.mapa-container {
  background: var(--glass);
  border-radius: var(--radius);
  border: 1px solid var(--glass-strong);
  box-shadow: var(--shadow);
  backdrop-filter: blur(10px);
  overflow: hidden;
  margin-bottom: 32px;
  position: relative;
}

/* Efecto de borde luminoso */
.mapa-container::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  border: 2px solid transparent;
  border-radius: var(--radius);
  background: linear-gradient(45deg, var(--accent), var(--primary), var(--accent)) border-box;
  -webkit-mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
  -webkit-mask-composite: destination-out;
  mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
  mask-composite: exclude;
  opacity: 0.3;
  animation: borderRotate 3s linear infinite;
}

@keyframes borderRotate {
  0% { background: linear-gradient(0deg, var(--accent), var(--primary), var(--accent)) border-box; }
  100% { background: linear-gradient(360deg, var(--accent), var(--primary), var(--accent)) border-box; }
}

.mapa-header {
  background: linear-gradient(135deg, var(--accent), var(--primary));
  color: #fff;
  padding: 16px 24px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.mapa-controls {
  display: flex;
  gap: 12px;
  padding: 16px 24px;
  background: var(--darker-bg);
  border-bottom: 1px solid var(--glass-strong);
}

.mapa-controls button {
  background: var(--glass);
  border: 1px solid var(--glass-strong);
  color: var(--text-light);
  padding: 8px 16px;
  border-radius: var(--radius);
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.mapa-controls button:hover {
  background: var(--accent);
  color: #fff;
  transform: translateY(-1px);
}
#mapa-enlaces {
  width: 100% !important;
  height: 600px !important;
  min-height: 400px !important;
  position: relative !important;
  z-index: 1;
  border-radius: var(--radius);
  overflow: hidden;
  box-shadow: var(--shadow);
}
.map-loading {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: var(--glass);
  border: 1px solid var(--glass-strong);
  border-radius: var(--radius);
  padding: 20px;
  color: var(--text-light);
  backdrop-filter: blur(10px);
  z-index: 10;
  display: flex;
  align-items: center;
  gap: 12px;
}

.map-loading::before {
  content: '';
  width: 20px;
  height: 20px;
  border: 2px solid var(--accent);
  border-top: 2px solid transparent;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
/* Estilos para el perfil de elevaci√≥n */
.perfil-elevacion-con-torres {
  background: var(--glass);
  border-radius: var(--radius);
  border: 1px solid var(--glass-strong);
  box-shadow: var(--shadow);
  backdrop-filter: blur(10px);
  padding: 32px;
  margin-bottom: 32px;
  position: relative;
  overflow: hidden;
}



/* Efecto de fondo con patr√≥n */
.perfil-elevacion-con-torres::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-image: 
    radial-gradient(circle at 25% 25%, rgba(0,188,212,0.05) 0%, transparent 50%),
    radial-gradient(circle at 75% 75%, rgba(30,136,229,0.05) 0%, transparent 50%);
  pointer-events: none;
  z-index: 0;
}

/* Efecto de borde inferior */
.perfil-elevacion-con-torres::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 100px;
  height: 3px;
  background: var(--gradient-primary);
  border-radius: 2px;
}

/* Estilos para la tabla interactiva */
.table-toolbar {
  transition: all 0.3s ease;
}

.table-toolbar:hover {
  box-shadow: 0 8px 25px rgba(59, 130, 246, 0.2);
}

.search-container input:focus {
  outline: none;
  border-color: rgba(59, 130, 246, 0.6);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.stats-badge {
  transition: all 0.3s ease;
}

.stats-badge:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.sortable:hover {
  background: rgba(59, 130, 246, 0.3) !important;
}

.sortable.sorted {
  background: rgba(59, 130, 246, 0.4) !important;
}

.sort-icon {
  transition: all 0.3s ease;
}

#tabla tbody tr {
  cursor: pointer;
}

#tabla tbody tr:hover {
  background: rgba(59, 130, 246, 0.05) !important;
}

.compact-view tbody tr td {
  padding: 8px 6px !important;
  font-size: 12px !important;
}

.compact-view thead th {
  padding: 10px 6px !important;
  font-size: 12px !important;
}

/* Animaciones para botones de acci√≥n */
#tabla tbody tr button {
  transition: all 0.3s ease;
}

#tabla tbody tr button:hover {
  background: rgba(59, 130, 246, 0.2) !important;
}

/* Estilos para paginaci√≥n */
.pagination-container button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.pagination-container button:not(:disabled):hover {
  background: rgba(59, 130, 246, 0.2) !important;
  border-color: rgba(59, 130, 246, 0.5) !important;
}

/* Mejoras generales para la tabla */
#tabla {
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  border: 2px solid rgba(59, 130, 246, 0.1);
  position: relative;
  z-index: 1;
}

.table-container {
  position: relative;
  overflow: hidden;
  z-index: 1;
  margin-top: -50px;
}

#tabla thead th {
  background: rgba(59, 130, 246, 0.1);
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1px;
  font-size: 13px;
  color: #3b82f6;
}

#tabla tbody tr:nth-child(even) {
  background: rgba(59, 130, 246, 0.02);
}

#tabla tbody tr:nth-child(odd) {
  background: rgba(255, 255, 255, 0.02);
}

/* Efecto de resplandor para filas seleccionadas */
#tabla tbody tr.selected {
  background: rgba(59, 130, 246, 0.15) !important;
  transition: all 0.3s ease;
}

/* Mejoras para el contenedor de acciones */
#tabla tbody tr td:last-child {
  background: rgba(59, 130, 246, 0.05);
  border-left: 1px solid rgba(255, 255, 255, 0.1);
}

/* Estilos adicionales para mejor experiencia */
.table-toolbar select:hover {
  border-color: rgba(59, 130, 246, 0.6) !important;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
}

.table-toolbar button:hover {
  background: rgba(59, 130, 246, 0.2) !important;
}

.stats-badge:hover {
  background: rgba(59, 130, 246, 0.2) !important;
}

#tabla tbody tr {
  transition: all 0.3s ease;
}

#tabla tbody tr:hover {
  background: rgba(59, 130, 246, 0.05) !important;
}

/* Animaci√≥n para los botones de acci√≥n */
#tabla tbody tr button {
  overflow: hidden;
  transition: all 0.3s ease;
}

/* Estilos mejorados para botones de acci√≥n */
#tabla tbody tr button {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  letter-spacing: 0.5px;
  border: 1px solid;
  font-weight: 600;
  min-width: 90px;
  height: 40px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}

/* Efectos espec√≠ficos para cada tipo de bot√≥n */
#tabla tbody tr button[title*="Mapa"] {
  background: rgba(59, 130, 246, 0.1);
  border-color: #3b82f6;
  color: #3b82f6;
}

#tabla tbody tr button[title*="Mapa"]:hover {
  background: rgba(37, 99, 235, 0.2) !important;
}

#tabla tbody tr button[title*="Perfil"] {
  background: rgba(16, 185, 129, 0.1);
  border-color: #10b981;
  color: #10b981;
}

#tabla tbody tr button[title*="Perfil"]:hover {
  background: rgba(5, 150, 105, 0.2) !important;
}

#tabla tbody tr button[title*="Editar"] {
  background: rgba(245, 158, 11, 0.1);
  border-color: #f59e0b;
  color: #f59e0b;
}

#tabla tbody tr button[title*="Editar"]:hover {
  background: rgba(217, 119, 6, 0.2) !important;
}

#tabla tbody tr button[title*="Copiar"] {
  background: rgba(139, 92, 246, 0.1);
  border-color: #8b5cf6;
  color: #8b5cf6;
}

#tabla tbody tr button[title*="Copiar"]:hover {
  background: rgba(124, 58, 237, 0.2) !important;
}

#tabla tbody tr button[title*="Informaci√≥n"] {
  background: rgba(59, 130, 246, 0.1);
  border-color: #3b82f6;
  color: #3b82f6;
}

#tabla tbody tr button[title*="Informaci√≥n"]:hover {
  background: rgba(37, 99, 235, 0.2) !important;
}

/* Estilos para el bot√≥n de recalcular factibilidad */
#btnRecalcularFactibilidad {
  background: linear-gradient(135deg, #06b6d415, #06b6d425);
  border: 2px solid #06b6d440;
  color: #06b6d4;
  box-shadow: 0 2px 8px #06b6d420;
}

#btnRecalcularFactibilidad:hover {
  background: linear-gradient(135deg, #0891b225, #0891b235);
  border-color: #0891b260;
  box-shadow: 0 6px 20px #06b6d440, 0 0 0 1px #06b6d460;
  transform: translateY(-2px) scale(1.02);
}

#btnRecalcularFactibilidad:active {
  transform: scale(0.98);
}

/* Efecto de pulso para botones activos */
#tabla tbody tr button:active {
  transform: scale(0.95);
  transition: transform 0.1s ease;
}

/* Mejoras para la columna de acciones */
#tabla tbody tr td:last-child {
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(59, 130, 246, 0.02));
  border-left: 2px solid rgba(59, 130, 246, 0.1);
}

/* Efecto de resplandor para botones en hover */
#tabla tbody tr button:hover {
  transform: translateY(-2px) scale(1.02);
  filter: brightness(1.1);
}

/* Efecto de resaltado para b√∫squeda */
.highlight-search {
  background: rgba(245, 158, 11, 0.3) !important;
  color: #f59e0b !important;
  font-weight: bold !important;
  padding: 2px 4px !important;
  border-radius: 3px !important;
}

.perfil-estadisticas-container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 16px;
  margin-top: 24px;
  padding: 24px;
  background: rgba(0,212,255,0.05);
  border-radius: var(--radius);
  border: 2px solid rgba(0,212,255,0.2);
  backdrop-filter: blur(15px);
  animation: estadisticasFloat 6s ease-in-out infinite;
}

@keyframes estadisticasFloat {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-3px); }
}

/* Estilos para el bot√≥n de estad√≠sticas */
#toggle-estadisticas-btn {
  position: relative;
  overflow: hidden;
}

#toggle-estadisticas-btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
  transition: left 0.6s;
}

#toggle-estadisticas-btn:hover::before {
  left: 100%;
}

#toggle-estadisticas-btn:hover {
  transform: translateY(-2px) scale(1.02);
  box-shadow: 0 8px 25px rgba(0,212,255,0.4);
}

/* Estilos para m√©tricas r√°pidas */
.metrica-rapida {
  position: relative;
  overflow: hidden;
  transition: all 0.3s ease;
}

.metrica-rapida::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
  transition: left 0.6s;
}

.metrica-rapida:hover::before {
  left: 100%;
}

.metrica-rapida:hover {
  transform: translateY(-3px) scale(1.05);
  box-shadow: 0 8px 25px rgba(0,0,0,0.3);
}

.metrica-valor {
  transition: all 0.3s ease;
}

/* Estilos para botones del panel de controles */
#exportar-perfil-btn, #comparar-enlaces-btn, #configuracion-avanzada-btn {
  position: relative;
  overflow: hidden;
}

#exportar-perfil-btn::before, #comparar-enlaces-btn::before, #configuracion-avanzada-btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
  transition: left 0.6s;
}

#exportar-perfil-btn:hover::before, #comparar-enlaces-btn:hover::before, #configuracion-avanzada-btn:hover::before {
  left: 100%;
}

#exportar-perfil-btn:hover, #comparar-enlaces-btn:hover, #configuracion-avanzada-btn:hover {
  transform: translateY(-2px) scale(1.02);
  box-shadow: 0 8px 25px rgba(0,0,0,0.3);
}

.perfil-estadistica-card {
  background: var(--glass-strong);
  border-radius: var(--radius);
  padding: 20px;
  border: 1px solid var(--glass-strong);
  text-align: center;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.perfil-estadistica-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(0,188,212,0.1), transparent);
  transition: left 0.6s;
}

.perfil-estadistica-card:hover::before {
  left: 100%;
}

.perfil-estadistica-card:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-glow);
  border-color: var(--accent);
}
.perfil-estadistica-valor {
  font-size: 26px;
  font-weight: 800;
  background: linear-gradient(135deg, var(--accent), var(--primary));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin-bottom: 8px;
  text-shadow: 0 0 10px rgba(0,212,255,0.3);
  transition: all 0.3s ease;
}

.perfil-estadistica-label {
  color: var(--text-muted);
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 1px;
  font-weight: 600;
  opacity: 0.8;
}

/* Estilos para modales y overlays */
.modal {
  background: var(--glass);
  border-radius: var(--radius);
  border: 1px solid var(--glass-strong);
  box-shadow: var(--shadow), var(--shadow-glow);
  backdrop-filter: blur(20px);
}

.modal-header {
  background: linear-gradient(135deg, var(--accent), var(--primary));
  color: #fff;
  padding: 20px 24px;
  border-radius: var(--radius) var(--radius) 0 0;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.modal-body {
  padding: 24px;
  color: var(--text-light);
}

/* Estilos para notificaciones */
.toast {
  background: var(--glass);
  border: 1px solid var(--glass-strong);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  backdrop-filter: blur(10px);
  color: var(--text-light);
  padding: 16px 20px;
  margin-bottom: 16px;
  transition: all 0.3s ease;
}

.toast.success {
  border-left: 4px solid var(--success);
}

.toast.error {
  border-left: 4px solid var(--danger);
}

.toast.warning {
  border-left: 4px solid var(--warning);
}

/* Estilos para estados de factibilidad */
.enlace-factible {
  background: rgba(16, 185, 129, 0.1) !important;
  border-left: 4px solid var(--success) !important;
}

.enlace-no-factible {
  background: rgba(239, 68, 68, 0.1) !important;
  border-left: 4px solid var(--danger) !important;
}

.factible {
  color: var(--success) !important;
  font-weight: 600;
}

.no-factible {
  color: var(--danger) !important;
  font-weight: 600;
}

/* Efectos de carga */
.loading {
  position: relative;
  overflow: hidden;
}

.loading::after {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
  animation: loading 1.5s infinite;
}

@keyframes loading {
  0% { left: -100%; }
  100% { left: 100%; }
}

/* Efectos de notificaci√≥n */
.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  background: var(--glass);
  border: 1px solid var(--glass-strong);
  border-radius: var(--radius);
  padding: 16px 20px;
  color: var(--text-light);
  box-shadow: var(--shadow);
  backdrop-filter: blur(10px);
  z-index: 1000;
  transform: translateX(100%);
  transition: transform 0.3s ease;
}

.notification.show {
  transform: translateX(0);
}
.notification.success {
  border-left: 4px solid var(--success);
}

.notification.error {
  border-left: 4px solid var(--danger);
}

.notification.warning {
  border-left: 4px solid var(--warning);
}
/* Efectos de hover para iconos */
.fas, .far, .fab {
  transition: all 0.3s ease;
}

.tab-button:hover .fas,
.tab-button:hover .far,
.tab-button:hover .fab {
  transform: scale(1.2) rotate(5deg);
}

/* Efectos de pulso para elementos importantes */
.pulse {
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% { box-shadow: 0 0 0 0 rgba(0, 188, 212, 0.7); }
  70% { box-shadow: 0 0 0 10px rgba(0, 188, 212, 0); }
  100% { box-shadow: 0 0 0 0 rgba(0, 188, 212, 0); }
}

/* Estilos para el bot√≥n de logout */
#logoutBtn::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
  transition: left 0.6s;
}

#logoutBtn:hover::before {
  left: 100%;
}

#logoutBtn:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-glow);
  background: var(--gradient-secondary);
}

#logoutBtn:active {
  transform: translateY(0px) scale(0.98);
}

/* Efectos de hover para iconos en el bot√≥n */
#logoutBtn:hover i {
  transform: scale(1.2) rotate(5deg);
}

/* Efecto de carga inicial */
.page-loader {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: var(--darker-bg);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  transition: opacity 0.5s ease, visibility 0.5s ease;
}

.page-loader.hidden {
  opacity: 0;
  visibility: hidden;
}

.loader-spinner {
  width: 60px;
  height: 60px;
  border: 4px solid var(--glass-strong);
  border-top: 4px solid var(--accent);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

.loader-text {
  position: absolute;
  bottom: 40%;
  color: var(--text-light);
  font-size: 18px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1px;
  animation: fadeInOut 2s ease-in-out infinite;
}

@keyframes fadeInOut {
  0%, 100% { opacity: 0.5; }
  50% { opacity: 1; }
}

/* Part√≠culas flotantes */
.floating-particles {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: -1;
}

.particle {
  position: absolute;
  width: 4px;
  height: 4px;
  background: var(--accent);
  border-radius: 50%;
  opacity: 0.3;
  animation: float 6s infinite linear;
}

.particle:nth-child(1) { left: 10%; animation-delay: 0s; }
.particle:nth-child(2) { left: 20%; animation-delay: 1s; }
.particle:nth-child(3) { left: 30%; animation-delay: 2s; }
.particle:nth-child(4) { left: 40%; animation-delay: 3s; }
.particle:nth-child(5) { left: 50%; animation-delay: 4s; }
.particle:nth-child(6) { left: 60%; animation-delay: 5s; }
.particle:nth-child(7) { left: 70%; animation-delay: 0s; }
.particle:nth-child(8) { left: 80%; animation-delay: 1s; }
.particle:nth-child(9) { left: 90%; animation-delay: 2s; }

@keyframes float {
  0% {
    transform: translateY(100vh) rotate(0deg);
    opacity: 0;
  }
  10% {
    opacity: 0.3;
  }
  90% {
    opacity: 0.3;
  }
  100% {
    transform: translateY(-100px) rotate(360deg);
    opacity: 0;
  }
}
.fangio-header {
  display: flex;
  align-items: center;
  gap: 32px;
  background: linear-gradient(135deg, var(--darker-bg), var(--dark-bg));
  border-radius: var(--radius);
  box-shadow: var(--shadow), var(--shadow-glow);
  border: 1px solid var(--glass-strong);
  padding: 40px 48px;
  margin-bottom: 40px;
  position: relative;
  overflow: hidden;
  min-height: 160px;
  justify-content: flex-start;
  backdrop-filter: blur(10px);
}




.fangio-logo-box {
  background: #fff;
  border-radius: 18px;
  box-shadow: 0 2px 12px rgba(0,188,212,0.10);
  padding: 12px 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  min-width: 110px;
  min-height: 110px;
}
.fangio-logo-img {
  width: 80px;
  height: 80px;
  object-fit: contain;
  display: block;
}
.fangio-title-box {
  display: flex;
  flex-direction: column;
  justify-content: center;
  z-index: 2;
}
.fangio-title {
  font-size: 2.8rem;
  font-weight: 800;
  color: #00e6ff;
  text-shadow: 0 0 18px #00e6ff55, 0 2px 8px #1e88e5cc;
  margin: 0 0 10px 0;
  letter-spacing: 2px;
}
.fangio-subtitle {
  font-size: 1.3rem;
  color: #2196f3;
  font-weight: 600;
  margin-top: 0;
  letter-spacing: 1px;
  text-shadow: 0 1px 8px #1e88e555;
}
.fangio-header-decoration {
  position: absolute;
  right: -80px;
  top: -60px;
  width: 320px;
  height: 320px;
  background: radial-gradient(circle at 60% 40%, #00bcd4 0%, #1e88e5 60%, transparent 100%);
  opacity: 0.18;
  z-index: 1;
  pointer-events: none;
}
@media (max-width: 900px) {
  .fangio-header {
    flex-direction: column;
    align-items: flex-start;
    padding: 18px 10px 18px 10px;
    min-height: 0;
    gap: 18px;
  }
  .fangio-header-decoration {
    width: 180px;
    height: 180px;
    right: -40px;
    top: -30px;
  }
  .fangio-logo-box {
    min-width: 70px;
    min-height: 70px;
    padding: 6px 8px;
  }
  .fangio-logo-img {
    width: 48px;
    height: 48px;
  }
  .fangio-title {
    font-size: 1.5rem;
  }
  .fangio-subtitle {
    font-size: 1rem;
  }
}
.btn-institucional {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  background: linear-gradient(90deg, #00bcd4 60%, #1e88e5 100%);
  color: #fff;
  font-weight: 700;
  font-size: 1.08rem;
  padding: 12px 26px;
  border-radius: 14px;
  text-decoration: none;
  box-shadow: 0 2px 12px rgba(30,136,229,0.10);
  margin-left: auto;
  transition: background 0.2s, box-shadow 0.2s, color 0.2s;
  border: none;
  outline: none;
}
.btn-institucional:hover {
  background: linear-gradient(90deg, #1e88e5 60%, #00bcd4 100%);
  color: #fff;
  box-shadow: 0 4px 18px rgba(30,136,229,0.18);
  text-decoration: none;
}
@media (max-width: 700px) {
  .btn-institucional {
   display: none;
  }
}
.fangio-tower-bg {
  position: absolute;
  bottom: 0;
  left: 0;
  height: 100%;
  width: 160px;
  pointer-events: none;
  z-index: 0;
  opacity: 0.18;
  display: flex;
  align-items: flex-end;
  justify-content: flex-start;
}
.fangio-tower-bg svg {
  height: 90%;
  width: auto;
  min-width: 80px;
  max-width: 120px;
  display: block;
}
@media (max-width: 900px) {
  .fangio-tower-bg {
    opacity: 0.10;
    width: 80px;
  }
  .fangio-tower-bg svg {
    min-width: 40px;
    max-width: 60px;
  }
}
#mapa-enlaces {
  margin-left: 340px; 
}
table, th, td {
  white-space: nowrap;
  vertical-align: middle;
}
tbody tr {
  height: 36px;
  min-height: 36px;
  max-height: 40px;
}
#panel-detalle-enlace {
  display: none;
  position: fixed;
  right: 0;
  top: 120px;
  width: 340px;
  max-width: 95vw;
  height: calc(100vh - 120px); 
  background: #fff;
  color: #222;
  border-radius: 18px 0 0 18px;
  box-shadow: 2px 0 18px #00bcd455;
  z-index: 2000;
  padding: 24px 18px 24px 18px;
  overflow-y: auto;
  font-size: 1rem;
}
#mapa-enlaces {
  margin-left: 0 !important;
  margin-right: 340px !important;
}
@media (max-width: 700px) {
  #panel-detalle-enlace {
    width: 98vw;
    border-radius: 0 0 18px 18px;
    height: auto;
    max-height: 80vh;
  }
  #mapa-enlaces {
    margin-left: 0 !important;
  }
}
#panel-detalle-enlace {
  z-index: 999999 !important;
  top: 0 !important;
  height: 100vh !important;
}
#detalle-enlace-contenido {
  padding-bottom: 40px;
}
#panel-detalle-enlace {
  top: 0 !important;
  height: 100vh !important;
  max-height: 100vh !important;
  overflow-y: auto !important;
}
.table-container {
  max-width: 100vw;
  overflow-x: auto;
  margin-bottom: 24px;
}
#tab-mismoTransporte .table-container {
  max-height: 60vh;
  overflow-y: auto;
}
#tab-mismoTransporte {
  overflow: visible !important;
}
#tab-mismoTransporte table {
  font-size: 13px;
  border-radius: 12px;
  background: #101a2a;
}
#tab-mismoTransporte th, #tab-mismoTransporte td {
  padding: 7px 10px;
  border-bottom: 1px solid #1e88e533;
  white-space: nowrap;
}
#tab-mismoTransporte th {
  background: #0b111f;
  color: #00e6ff;
  position: sticky;
  top: 0;
  z-index: 2;
}
#tab-mismoTransporte tr:hover {
  background: #1e88e522;
}
#tab-mismoTransporte .table-container {
  max-width: 100vw;
  overflow-x: auto;
  background: #101a2a;
  border-radius: 14px;
  border: 1.5px solid #00e6ff44;
  box-shadow: 0 2px 18px #00e6ff22;
  margin-bottom: 18px;
  padding: 0;
}
#tab-mismoTransporte table {
  font-size: 13px;
  border-radius: 12px;
  background: #101a2a;
  min-width: 1200px;
}
#tab-mismoTransporte th, #tab-mismoTransporte td {
  padding: 7px 10px;
  border-bottom: 1px solid #1e88e533;
  white-space: nowrap;
  text-align: center;
}
#tab-mismoTransporte th {
  background: #0b111f;
  color: #00e6ff;
  position: sticky;
  top: 0;
  z-index: 2;
  font-size: 13px;
  letter-spacing: 0.5px;
}
#tab-mismoTransporte tr:hover {
  background: #1e88e522;
}
#tab-mismoTransporte td:last-child {
  min-width: 120px;
  max-width: 140px;
  text-align: center;
  white-space: nowrap;
  overflow: hidden;
}
#tab-mismoTransporte button.btn-info {
  padding: 4px 10px;
  font-size: 12px;
  border-radius: 8px;
}
#tab-mismoTransporte .action-buttons {
  display: flex;
  gap: 12px;
  margin-bottom: 10px;
  flex-wrap: wrap;
}
#tab-mismoTransporte .enlaces-counter {
  margin-bottom: 8px;
  font-size: 1.08rem;
  color: #00e6ff;
  font-weight: 600;
}
#tab-mismoTransporte table {
  font-size: 13px;
  border-radius: 12px;
  background: #101a2a;
}
#tab-mismoTransporte th, #tab-mismoTransporte td {
  padding: 7px 10px;
  border-bottom: 1px solid #1e88e533;
  white-space: nowrap;
}
#tab-mismoTransporte th {
  background: #0b111f;
  color: #00e6ff;
  position: sticky;
  top: 0;
  z-index: 2;
}
#tab-mismoTransporte tr:hover {
  background: #1e88e522;
}
.fangio-video-wrapper {
  position: relative;
  width: 100%;
  max-width: 600px;
  aspect-ratio: 16/9;
  margin: 32px auto 0 auto;
  border-radius: 22px;
  overflow: hidden;
  box-shadow: 0 0 32px #00e6ff66, 0 2px 18px #00e6ff33;
  background: linear-gradient(135deg, #0b111f 60%, #1e88e5 100%);
  display: flex;
  align-items: center;
  justify-content: center;
}
.fangio-video-glow {
  position: absolute;
  inset: 0;
  border-radius: 22px;
  pointer-events: none;
  z-index: 1;
  box-shadow: 0 0 60px 10px #00e6ff88, 0 0 0 8px #00e6ff33 inset;
  animation: fangio-glow 2.5s infinite alternate;
}
@keyframes fangio-glow {
  0% { box-shadow: 0 0 60px 10px #00e6ff88, 0 0 0 8px #00e6ff33 inset; }
  100% { box-shadow: 0 0 90px 18px #00e6ffcc, 0 0 0 12px #00e6ff44 inset; }
}
.fangio-video {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 22px;
  z-index: 2;
  background: #000;
  display: block;
}
@media (max-width: 700px) {
  .fangio-video-wrapper {
    max-width: 98vw;
    border-radius: 12px;
  }
  .fangio-video-glow {
    border-radius: 12px;
  }
  .fangio-video {
    border-radius: 12px;
  }
}
.video-hero-bg {
  display: flex;
  justify-content: center;
  align-items: center;
  width: 100%;
  max-width: 700px;
  margin: 40px auto 32px auto;
  background: linear-gradient(135deg, #101a2a 60%, #1e88e5 100%);
  border-radius: 24px;
  box-shadow: 0 8px 40px #00e6ff22, 0 2px 18px #00e6ff11;
  padding: 0;
  overflow: hidden;
}
.video-hero {
  width: 100%;
  aspect-ratio: 16/9;
  border-radius: 24px;
  object-fit: cover;
  display: block;
  box-shadow: 0 2px 24px #000a;
}
@media (max-width: 900px) {
  .video-hero-bg { max-width: 98vw; border-radius: 12px; }
  .video-hero { border-radius: 12px; }
}
.video-banner {
  width: 100%;
  max-width: 1200px;
  height: 280px;
  margin: 32px auto 32px auto;
  position: relative;
  overflow: hidden;
  border-radius: 0;
  box-shadow: none;
  background: #000;
  display: flex;
  align-items: center;
  justify-content: center;
}
.video-banner-video {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
  border-radius: 0;
  box-shadow: none;
  background: #000;
}
.video-banner-overlay {
  position: absolute;
  left: 0; top: 0; width: 100%; height: 100%;
  display: flex; align-items: center; justify-content: center;
  color: #fff;
  font-size: 2.2rem;
  font-weight: 800;
  background: rgba(0,0,0,0.18);
  text-shadow: 0 2px 16px #000;
  pointer-events: none;
}
@media (max-width: 900px) {
  .video-banner { height: 180px; }
  .video-banner-overlay { font-size: 1.2rem; }
}
.banner-hero {
  position: relative;
  width: 100%;
  min-height: 220px;
  max-height: 320px;
  height: 280px;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  border-radius: 0 0 32px 32px;
  margin-bottom: 32px;
  background: none;
  box-shadow: 0 8px 40px #00e6ff22, 0 2px 18px #00e6ff11;
}
.banner-hero video {
  position: absolute;
  top: 0; left: 0;
  width: 100%;
  height: 100%;
  min-height: 220px;
  max-height: 320px;
  object-fit: cover;
  filter: blur(0.01px) brightness(0.95);
  opacity: 0.96;
  z-index: 0;
  border-radius: 0 0 32px 32px;
}
.banner-hero-overlay {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2;
  background: linear-gradient(120deg, rgba(11,17,31,0.55) 60%, rgba(30,136,229,0.18) 100%);
  pointer-events: none;
}

.banner-hero-content {
  display: flex;
  align-items: center;
  gap: 32px;
  z-index: 3;
  background: rgba(10,20,40,0.72);
  border-radius: 22px;
  padding: 32px 38px;
  box-shadow: 0 4px 32px #00e6ff22;
  pointer-events: auto;
  margin: 0 auto;
}
  
.banner-hero-logo {
  width: 90px;
  height: 90px;
  border-radius: 18px;
  background: #fff;
  box-shadow: 0 2px 12px #00e6ff33;
  margin-right: 18px;
}
.banner-hero-title {
  font-size: 2.8rem;
  font-weight: 800;
  color: #00e6ff;
  text-shadow: 0 0 18px #00e6ff55, 0 2px 8px #1e88e5cc;
  margin: 0 0 10px 0;
  letter-spacing: 2px;
}
.banner-hero-subtitle {
  font-size: 1.3rem;
  color: #2196f3;
  font-weight: 600;
  margin-bottom: 10px;
  letter-spacing: 1px;
  text-shadow: 0 1px 8px #1e88e555;
}
.banner-hero-link {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  background: linear-gradient(90deg, #00bcd4 60%, #1e88e5 100%);
  color: #fff;
  font-weight: 700;
  font-size: 1.08rem;
  padding: 12px 26px;
  border-radius: 14px;
  text-decoration: none;
  box-shadow: 0 2px 12px rgba(30,136,229,0.10);
  margin-top: 8px;
  transition: background 0.2s, box-shadow 0.2s, color 0.2s;
  border: none;
  outline: none;
}
.banner-hero-link:hover {
  background: linear-gradient(90deg, #1e88e5 60%, #00bcd4 100%);
  color: #fff;
  box-shadow: 0 4px 18px rgba(30,136,229,0.18);
  text-decoration: none;
}
@media (max-width: 900px) {
  .banner-hero {
    min-height: 120px;
    max-height: 180px;
    height: 160px;
    border-radius: 0 0 18px 18px;
  }
  .banner-hero-logo {
    margin: 0 0 10px 0;
  }
  .banner-hero-title {
    font-size: 1.7rem;
  }
  .banner-hero-subtitle {
    font-size: 1.05rem;
  }
  .banner-hero {
    min-height: 160px;
    max-height: 220px;
    border-radius: 0 0 18px 18px;
  }
  .banner-hero-video {
    min-height: 160px;
    max-height: 220px;
  }
}
.container {
  .container,
.fangio-header,
.fangio-header-decoration,
.banner-hero,
.banner-hero::before,
.banner-hero::after {
  background: none !important;
  box-shadow: none !important;
}
}
#toggleMismoTransporte {
  position: relative;
  font-weight: 700;
  border: 2.5px solid #00e6ff;
  background: linear-gradient(90deg, #00bcd4 60%, #1e88e5 100%);
  color: #fff;
  box-shadow: 0 2px 12px #00e6ff33;
  transition: background 0.2s, color 0.2s, border 0.2s, box-shadow 0.2s;
  outline: none;
  min-width: 320px;
  padding-right: 48px;
}
#toggleMismoTransporte.btn-outline-info {
  background: #0b111f;
  color: #00e6ff;
  border: 2.5px solid #00e6ff;
  box-shadow: none;
}
#toggleMismoTransporte.btn-info {
  background: linear-gradient(90deg, #00e6ff 60%, #00bcd4 100%);
  color: #0b111f;
  border: 2.5px solid #00e6ff;
  box-shadow: 0 4px 18px #00e6ff44;
}
#toggleMismoTransporte .toggle-icon {
  position: absolute;
  right: 18px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 1.5em;
  transition: color 0.2s;
}
#toggleMismoTransporte.btn-info .toggle-icon {
  color: #10b981;
  text-shadow: 0 0 8px #10b98188;
}
#toggleMismoTransporte.btn-outline-info .toggle-icon {
  color: #888;
  text-shadow: none;
}
button, .tab-button, .btn {
  transition: background 0.2s, color 0.2s, box-shadow 0.2s, transform 0.15s;
}
button:hover, .tab-button:hover, .btn:hover {
  transform: translateY(-2px) scale(1.03);
}
.badge {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 0.95em;
  font-weight: 700;
  color: #fff;
}
.badge-factible { background: #10b981; }
.badge-nofactible { background: #ef4444; }
.badge-indef { background: #f59e42; }
body.modo-claro {
  background: #f5f7fa;
  color: #222;
}
body.modo-claro .main-content,
body.modo-claro .table-container {
  background: #fff !important;
  color: #222 !important;
}
body.modo-claro .badge-factible { background: #059669; }
body.modo-claro .badge-nofactible { background: #dc2626; }
body.modo-claro .badge-indef { background: #f59e42; }

  </style>
</head>
<body> 

  
  <script>
// Ocultar loader despu√©s de 2 segundos
setTimeout(() => {
  const loader = document.getElementById('pageLoader');
  if (loader) {
    loader.classList.add('hidden');
  }
}, 2000);

if (localStorage.getItem('fangioSesion') !== 'activa') {
  window.location.href = 'login.html';
}
</script>

<!-- BOT√ìN PROYECTOS - VERSI√ìN PROFESIONAL Y FIJA ARRIBA -->
<div id="proyectosContainer" style="
  position: fixed;
  top: 20px;
  right: 30px;
  z-index: 9999;
  display: flex;
  flex-direction: column;
  gap: 15px;
  transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
" onmouseover="this.style.transform='translateX(-10px)'" 
   onmouseout="this.style.transform='translateX(0)'">

  <!-- BOT√ìN PRINCIPAL PROYECTOS -->
  <button id="proyectosBtn" style="
    background: linear-gradient(135deg, #00c3ff 0%, #3b82f6 50%, #1e40af 100%);
    color: #fff;
    font-weight: 700;
    padding: 18px 25px;
    border-radius: 50px;
    font-size: 1rem;
    border: none;
    cursor: pointer;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    display: flex;
    align-items: center;
    gap: 12px;
    box-shadow: 
      0 8px 25px rgba(0, 195, 255, 0.4),
      0 0 0 1px rgba(255, 255, 255, 0.1) inset,
      0 0 30px rgba(0, 195, 255, 0.3);
    backdrop-filter: blur(15px);
    text-transform: uppercase;
    letter-spacing: 1px;
    position: relative;
    overflow: hidden;
    white-space: nowrap;
    min-width: 200px;
    justify-content: center;
  " onmouseover="this.style.transform='scale(1.05) translateY(-2px)'; this.style.boxShadow='0 12px 35px rgba(0, 195, 255, 0.6), 0 0 0 2px rgba(255, 255, 255, 0.2) inset, 0 0 40px rgba(0, 195, 255, 0.4)'" 
     onmouseout="this.style.transform='scale(1) translateY(0)'; this.style.boxShadow='0 8px 25px rgba(0, 195, 255, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.1) inset, 0 0 30px rgba(0, 195, 255, 0.3)'"
     onclick="mostrarMenuProyectos()">
    
    <!-- Efecto de brillo -->
    <div style="
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left 0.6s;
    " onmouseover="this.style.left='100%'"></div>
    
    <i class="fas fa-rocket" style="font-size: 1.2em; animation: rocketPulse 2s ease-in-out infinite;"></i>
    <span style="font-weight: 800;">Proyectos</span>
    
    <!-- Indicador de proyectos -->
    <div style="
      position: absolute;
      top: -5px;
      right: -5px;
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: 700;
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
      animation: pulse 2s ease-in-out infinite;
    ">8</div>
  </button>

  <!-- BOTONES SECUNDARIOS -->
  <div id="proyectosRapidos" style="
    display: none;
    flex-direction: column;
    gap: 10px;
    transition: all 0.3s ease;
  ">
    
    <!-- Nuevo Baseado -->
    <button onclick="window.open('http://localhost:5000', '_blank')" style="
      background: linear-gradient(135deg, rgba(0, 195, 255, 0.9), rgba(59, 130, 246, 0.9));
      color: #fff;
      font-weight: 600;
      padding: 12px 20px;
      border-radius: 25px;
      font-size: 0.85rem;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 15px rgba(0, 195, 255, 0.3);
      backdrop-filter: blur(10px);
      white-space: nowrap;
      min-width: 180px;
      justify-content: center;
    " onmouseover="this.style.transform='translateX(-5px) scale(1.02)'; this.style.boxShadow='0 6px 20px rgba(0, 195, 255, 0.4)'" 
       onmouseout="this.style.transform='translateX(0) scale(1)'; this.style.boxShadow='0 4px 15px rgba(0, 195, 255, 0.3)'">
      <i class="fas fa-python" style="font-size: 1em;"></i>
      <span>üöÄ Nuevo Baseado</span>
    </button>
    
    <!-- PTP Fangio -->
    <button onclick="window.open('ptpFangio.html', '_blank')" style="
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.9), rgba(5, 150, 105, 0.9));
      color: #fff;
      font-weight: 600;
      padding: 12px 20px;
      border-radius: 25px;
      font-size: 0.85rem;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
      backdrop-filter: blur(10px);
      white-space: nowrap;
      min-width: 180px;
      justify-content: center;
    " onmouseover="this.style.transform='translateX(-5px) scale(1.02)'; this.style.boxShadow='0 6px 20px rgba(16, 185, 129, 0.4)'" 
       onmouseout="this.style.transform='translateX(0) scale(1)'; this.style.boxShadow='0 4px 15px rgba(16, 185, 129, 0.3)'">
      <i class="fas fa-chart-line" style="font-size: 1em;"></i>
      <span>üìä PTP Fangio</span>
    </button>
    
    <!-- PTMP Fangio -->
    <button onclick="window.open('ptmpFangio.html', '_blank')" style="
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.9), rgba(217, 119, 6, 0.9));
      color: #fff;
      font-weight: 600;
      padding: 12px 20px;
      border-radius: 25px;
      font-size: 0.85rem;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
      backdrop-filter: blur(10px);
      white-space: nowrap;
      min-width: 180px;
      justify-content: center;
    " onmouseover="this.style.transform='translateX(-5px) scale(1.02)'; this.style.boxShadow='0 6px 20px rgba(245, 158, 11, 0.4)'" 
       onmouseout="this.style.transform='translateX(0) scale(1)'; this.style.boxShadow='0 4px 15px rgba(245, 158, 11, 0.3)'">
      <i class="fas fa-broadcast-tower" style="font-size: 1em;"></i>
      <span>üì° PTMP Fangio</span>
    </button>
    
    <!-- Llenado Autom√°tico App.py -->
    <button onclick="window.open('http://127.0.0.1:5000/llenado-automatico', '_blank')" style="
      background: linear-gradient(135deg, rgba(168, 85, 247, 0.9), rgba(147, 51, 234, 0.9));
      color: #fff;
      font-weight: 600;
      padding: 12px 20px;
      border-radius: 25px;
      font-size: 0.85rem;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 15px rgba(168, 85, 247, 0.3);
      backdrop-filter: blur(10px);
      white-space: nowrap;
      min-width: 180px;
      justify-content: center;
    " onmouseover="this.style.transform='translateX(-5px) scale(1.02)'; this.style.boxShadow='0 6px 20px rgba(168, 85, 247, 0.4)'" 
       onmouseout="this.style.transform='translateX(0) scale(1)'; this.style.boxShadow='0 4px 15px rgba(168, 85, 247, 0.3)'">
      <i class="fas fa-magic" style="font-size: 1em;"></i>
      <span>‚ú® Llenado Autom√°tico</span>
    </button>
  </div>
</div>

<style>
@keyframes rocketPulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}

@keyframes pulse {
  0%, 100% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.1); opacity: 0.8; }
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateX(20px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

@keyframes slideOut {
  from {
    opacity: 1;
    transform: translateX(0);
  }
  to {
    opacity: 0;
    transform: translateX(20px);
  }
}

/* Efectos de hover para el contenedor */
#proyectosContainer:hover #proyectosRapidos {
  display: flex !important;
  animation: slideIn 0.3s ease-out;
}

/* Responsive para m√≥viles */
@media (max-width: 768px) {
  #proyectosContainer {
    right: 15px;
    top: 15px;
  }
  
  #proyectosBtn {
    min-width: 140px;
    padding: 12px 18px;
    font-size: 0.85rem;
  }
  
  #proyectosRapidos button {
    min-width: 120px;
    padding: 8px 12px;
    font-size: 0.75rem;
  }
}

/* Responsive para tablets */
@media (max-width: 1024px) {
  #proyectosContainer {
    right: 20px;
    top: 20px;
  }
}

/* Efectos de part√≠culas para el bot√≥n principal */
#proyectosBtn::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: radial-gradient(circle at 30% 20%, rgba(0, 195, 255, 0.1) 0%, transparent 50%),
              radial-gradient(circle at 70% 80%, rgba(59, 130, 246, 0.1) 0%, transparent 50%);
  pointer-events: none;
  z-index: -1;
}

/* Efecto de borde luminoso */
#proyectosBtn::after {
  content: '';
  position: absolute;
  top: -2px;
  left: -2px;
  right: -2px;
  bottom: -2px;
  background: linear-gradient(45deg, #00c3ff, #3b82f6, #1e40af, #00c3ff);
  border-radius: 50px;
  z-index: -2;
  opacity: 0;
  transition: opacity 0.3s ease;
}

#proyectosBtn:hover::after {
  opacity: 1;
  animation: borderRotate 2s linear infinite;
}

@keyframes borderRotate {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>

<button id="logoutBtn" style="
  display:none;
  position:fixed;
  top:20px;
  left:20px;
  z-index:9999;
  background: linear-gradient(135deg, #ef4444, #dc2626);
  color: #fff;
  font-weight: 700;
  padding: 12px 20px;
  border-radius: 12px;
  font-size: 0.9rem;
  border: none;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 8px;
  box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
  backdrop-filter: blur(10px);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  position: relative;
  overflow: hidden;
" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(239, 68, 68, 0.4)'" 
   onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(239, 68, 68, 0.3)'">
  <i class="fas fa-sign-out-alt" style="font-size:1.1em;"></i> Cerrar sesi√≥n
  
</button>

<script>
let permitirMismoTransporte = localStorage.getItem('permitirMismoTransporte') === 'true';

function togglePermitirMismoTransporte() {
  permitirMismoTransporte = !permitirMismoTransporte;
  localStorage.setItem('permitirMismoTransporte', permitirMismoTransporte);
  const btn = document.getElementById('toggleMismoTransporte');
  const icon = btn.querySelector('.toggle-icon i');
  if (permitirMismoTransporte) {
    btn.classList.remove('btn-outline-info');
    btn.classList.add('btn-info');
    icon.className = 'fas fa-toggle-on';
  } else {
    btn.classList.remove('btn-info');
    btn.classList.add('btn-outline-info');
    icon.className = 'fas fa-toggle-off';
  }
}

// Funci√≥n para mostrar/ocultar botones r√°pidos
function toggleProyectosRapidos() {
  const rapidos = document.getElementById('proyectosRapidos');
  if (rapidos) {
    if (rapidos.style.display === 'none' || rapidos.style.display === '') {
      rapidos.style.display = 'flex';
      rapidos.style.animation = 'slideIn 0.3s ease-out';
    } else {
      rapidos.style.display = 'none';
    }
  }
}

// Funci√≥n para mostrar el men√∫ de proyectos
function mostrarMenuProyectos() {
  const proyectos = [
    { 
      nombre: '‚ú® Llenado Autom√°tico', 
      url: 'http://127.0.0.1:5000/diseno_solucion', 
      descripcion: 'Sistema de llenado autom√°tico de Excel con Python',
      icon: 'fas fa-magic',
      color: 'linear-gradient(135deg, rgba(168, 85, 247, 0.9), rgba(147, 51, 234, 0.9))'
    },
    { 
      nombre: 'üöÄ Nuevo Baseado (Python)', 
      url: 'http://127.0.0.1:5000', 
      descripcion: 'Sistema de llenado autom√°tico y gesti√≥n de proyectos',
      icon: 'fas fa-python'
    },
    { 
      nombre: 'üìä PTP Fangio', 
      url: 'ptpFangio.html', 
      descripcion: 'An√°lisis de enlaces punto a punto',
      icon: 'fas fa-chart-line'
    },
    { 
      nombre: 'üì° PTMP Fangio', 
      url: 'ptmpFangio.html', 
      descripcion: 'An√°lisis de enlaces punto multipunto',
      icon: 'fas fa-broadcast-tower'
    },
    { 
      nombre: 'üó∫Ô∏è Route Optimizer', 
      url: 'route_optimizer.html', 
      descripcion: 'Optimizaci√≥n de rutas de enlaces',
      icon: 'fas fa-route'
    },
    { 
      nombre: 'üìã Microwave Analyzer', 
      url: 'microwave_analyzer.html', 
      descripcion: 'An√°lisis avanzado de microondas',
      icon: 'fas fa-satellite-dish'
    },
    { 
      nombre: 'üìà Microwave Monitor', 
      url: 'microwave_monitor.html', 
      descripcion: 'Monitoreo de enlaces de microondas',
      icon: 'fas fa-tachometer-alt'
    },
    { 
      nombre: 'üìã Microwave Planner', 
      url: 'microwave_planner.html', 
      descripcion: 'Planificaci√≥n de enlaces de microondas',
      icon: 'fas fa-clipboard-list'
    },
    { 
      nombre: 'üéØ AI Dashboard', 
      url: 'ai_dashboard.html', 
      descripcion: 'Dashboard con inteligencia artificial',
      icon: 'fas fa-brain'
    }
  ];

  let modalHtml = `
    <div id="modalProyectos" style="
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      backdrop-filter: blur(5px);
    ">
      <div style="
        background: linear-gradient(135deg, rgba(22, 33, 62, 0.95) 0%, rgba(15, 52, 96, 0.9) 100%);
        border: 2px solid rgba(0, 195, 255, 0.4);
        border-radius: 20px;
        padding: 30px;
        max-width: 800px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        backdrop-filter: blur(20px);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
        position: relative;
      ">
        <button onclick="cerrarMenuProyectos()" style="
          position: absolute;
          top: 15px;
          right: 20px;
          background: none;
          border: none;
          font-size: 1.5rem;
          color: #00c3ff;
          cursor: pointer;
          z-index: 10001;
        "><i class="fas fa-times"></i></button>
        
        <h2 style="
          color: #00c3ff;
          text-align: center;
          margin-bottom: 30px;
          font-size: 2rem;
          font-weight: 700;
          text-shadow: 0 0 20px rgba(0, 195, 255, 0.5);
        ">
          <i class="fas fa-rocket"></i> Mis Proyectos
        </h2>
        
        <div style="
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
          gap: 20px;
          margin-bottom: 20px;
        ">
  `;

  proyectos.forEach(proyecto => {
    modalHtml += `
      <div style="
        background: linear-gradient(135deg, rgba(0, 195, 255, 0.1) 0%, rgba(59, 130, 246, 0.1) 100%);
        border: 1px solid rgba(0, 195, 255, 0.3);
        border-radius: 15px;
        padding: 20px;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
      " onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 10px 25px rgba(0, 195, 255, 0.3)'" 
         onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'"
         onclick="window.open('${proyecto.url}', '_blank')">
        
        <div style="
          display: flex;
          align-items: center;
          gap: 15px;
          margin-bottom: 10px;
        ">
          <div style="
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #00c3ff, #3b82f6);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
          ">
            <i class="${proyecto.icon}"></i>
          </div>
          <h3 style="
            color: #00c3ff;
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
          ">${proyecto.nombre}</h3>
        </div>
        
        <p style="
          color: #b5c7e6;
          margin: 0;
          font-size: 0.9rem;
          line-height: 1.4;
        ">${proyecto.descripcion}</p>
        
        <div style="
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: linear-gradient(45deg, transparent, rgba(0, 195, 255, 0.05), transparent);
          opacity: 0;
          transition: opacity 0.3s ease;
        " onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0'"></div>
      </div>
    `;
  });

  modalHtml += `
        </div>
        
        <div style="
          text-align: center;
          margin-top: 20px;
          padding-top: 20px;
          border-top: 1px solid rgba(0, 195, 255, 0.2);
        ">
          <p style="
            color: #7b8794;
            font-size: 0.9rem;
            margin: 0;
          ">Selecciona un proyecto para abrirlo en una nueva pesta√±a</p>
        </div>
      </div>
    </div>
  `;

  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

// Funci√≥n para cerrar el men√∫ de proyectos
function cerrarMenuProyectos() {
  const modal = document.getElementById('modalProyectos');
  if (modal) {
    modal.remove();
  }
}


</script>
<script>
function importarArchivoPathloss() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.pl5,.csv';
  
  input.onchange = async function(e) {
    const file = e.target.files[0];
    if (!file) return;

    try {
      if (file.name.endsWith('.csv')) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const text = e.target.result;
          const lines = text.split('\n');
          processPathlossCSV(lines);
        };
        reader.readAsText(file);
      } else if (file.name.endsWith('.pl5')) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const buffer = e.target.result;
          processPathlossFile(buffer);
        };
        reader.readAsArrayBuffer(file);
      }
    } catch (error) {
      console.error('Error al importar archivo:', error);
      alert('Error al importar el archivo. Verifica el formato.');
    }
  };

  input.click();
}
function processPathlossCSV(lines) {

  try {
    lines.forEach(line => {
      const columns = line.split(',');
    });
    alert('Archivo CSV importado correctamente');
  } catch (error) {
    alert('Error al procesar el archivo CSV');
  }
}

function processPathlossFile(buffer) {
  alert('El formato .pl5 a√∫n no est√° soportado. Por favor usa archivos CSV.');
}

function setFactorK(nuevoK) {
  factorK = parseFloat(nuevoK) || 4/3;
  alert('Nuevo factor K aplicado: ' + factorK);
}

function abrirPanelParametrosRadio() {
  document.getElementById('modal-parametros-radio').style.display = 'flex';
}
function cerrarPanelParametrosRadio() {
  document.getElementById('modal-parametros-radio').style.display = 'none';
}
function calcularParametrosRadio() {
  const pt = parseFloat(document.getElementById('potenciaTX').value);
  const ga = parseFloat(document.getElementById('gananciaA').value);
  const gb = parseFloat(document.getElementById('gananciaB').value);
  const l = parseFloat(document.getElementById('perdidas').value);
  const fade = parseFloat(document.getElementById('fadeMargin').value);
  const distancia = parseFloat(document.getElementById('distanciaRadio').value);
  const frecuencia = parseFloat(document.getElementById('frecuenciaRadio').value);
  if (isNaN(pt) || isNaN(ga) || isNaN(gb) || isNaN(l) || isNaN(fade) || isNaN(distancia) || isNaN(frecuencia)) {
    document.getElementById('resultado-parametros-radio').innerHTML = '<span style="color:#ef4444;">Datos incompletos</span>';
    return;
  }
  const Lfs = 92.45 + 20 * Math.log10(distancia) + 20 * Math.log10(frecuencia);
  const pr = pt + ga + gb - Lfs - l;
  document.getElementById('resultado-parametros-radio').innerHTML =
    `<b>P√©rdida espacio libre:</b> ${Lfs.toFixed(2)} dB<br>
     <b>Potencia recibida:</b> ${pr.toFixed(2)} dBm<br>
     <b>Margen de desvanecimiento:</b> ${fade} dB<br>
     <b>Margen total:</b> ${(pr - fade).toFixed(2)} dBm`;
}
let equiposAntenas = [];
function abrirPanelEquiposAntenas() {
  document.getElementById('modal-equipos-antenas').style.display = 'flex';
  mostrarListaEquiposAntenas();
}
function cerrarPanelEquiposAntenas() {
  document.getElementById('modal-equipos-antenas').style.display = 'none';
}
function guardarEquipoAntena() {
  const modeloRadio = document.getElementById('modeloRadio').value.trim();
  const modeloAntena = document.getElementById('modeloAntena').value.trim();
  const ganancia = parseFloat(document.getElementById('gananciaAntena').value);
  if (!modeloRadio || !modeloAntena || isNaN(ganancia)) {
    alert('Completa todos los campos.');
    return;
  }
  equiposAntenas.push({ modeloRadio, modeloAntena, ganancia });
  mostrarListaEquiposAntenas();
}
function mostrarListaEquiposAntenas() {
  const div = document.getElementById('lista-equipos-antenas');
  if (!equiposAntenas.length) {
    div.innerHTML = '<i>No hay equipos registrados.</i>';
    return;
  }
  div.innerHTML = '<ul>' + equiposAntenas.map(eq =>
    `<li><b>${eq.modeloRadio}</b> - ${eq.modeloAntena} (${eq.ganancia} dBi)</li>`
  ).join('') + '</ul>';
}
// Funci√≥n mostrarMapaEnlaces movida m√°s abajo para evitar duplicaci√≥n
</script>
</script>
<div class="container">
   <div class="banner-hero" style="position: relative;">
<video 
  src="https://dl.dropboxusercontent.com/scl/fi/isjx084d625twlii2vmkd/Proyecto-video.mp4?rlkey=k2dwu1ek0lt5w77whlzq80zes&st=4h4wxyq1"
  autoplay loop muted playsinline
  poster="img/video-placeholder.jpg"
></video>
  <div class="banner-hero-overlay">
    <div class="banner-hero-content">
      <img src="img/logo_empresa.png" alt="Logo Fangio Telecom" class="banner-hero-logo" />
      <div>
        <h1 class="banner-hero-title">Fangio Telecom</h1>
        <div class="banner-hero-subtitle">Base de datos de Enlaces PtP</div>
        <a href="https://fangio.com.mx" target="_blank" class="banner-hero-link">
          <i class="fas fa-globe"></i> fangio.com.mx
        </a>
      </div>
    </div>
  </div>
  

    
    <!-- Bot√≥n de Proyectos -->
    <button id="btn-proyectos-video" onclick="mostrarMenuProyectos()" style="
      padding: 18px 24px; 
      font-size: 15px; 
      border-radius: 60px; 
      background: linear-gradient(135deg, 
        rgba(139, 92, 246, 0.98), 
        rgba(168, 85, 247, 0.95), 
        rgba(196, 181, 253, 0.9)
      ); 
      border: 3px solid rgba(255, 255, 255, 0.3); 
      color: white; 
      cursor: pointer; 
      font-weight: 800; 
      display: flex; 
      align-items: center; 
      gap: 12px; 
      backdrop-filter: blur(20px); 
      box-shadow: 
        0 12px 40px rgba(139, 92, 246, 0.5),
        0 6px 20px rgba(0, 0, 0, 0.3),
        0 0 0 1px rgba(255, 255, 255, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.3),
        inset 0 -1px 0 rgba(0, 0, 0, 0.2); 
      transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      text-transform: uppercase;
      letter-spacing: 1px;
      min-width: 160px;
      justify-content: center;
      position: relative;
      overflow: hidden;
      font-family: 'Inter', sans-serif;
    " onmouseover="
      this.style.transform='scale(1.08) rotate(1deg)'; 
      this.style.boxShadow='0 16px 50px rgba(139, 92, 246, 0.7), 0 8px 25px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.4), inset 0 -1px 0 rgba(0, 0, 0, 0.3)';
      this.style.background='linear-gradient(135deg, rgba(147, 51, 234, 0.98), rgba(168, 85, 247, 0.95), rgba(196, 181, 253, 0.9))';
    " 
       onmouseout="
         this.style.transform='scale(1) rotate(0deg)'; 
         this.style.boxShadow='0 12px 40px rgba(139, 92, 246, 0.5), 0 6px 20px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.3), inset 0 -1px 0 rgba(0, 0, 0, 0.2)';
         this.style.background='linear-gradient(135deg, rgba(139, 92, 246, 0.98), rgba(168, 85, 247, 0.95), rgba(196, 181, 253, 0.9))';
       ">
      
      <!-- Efecto de brillo interno mejorado -->
      <div style="
        position: absolute; 
        top: 0; 
        left: -100%; 
        width: 100%; 
        height: 100%; 
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        transition: left 0.8s ease;
        pointer-events: none;
      " onmouseover="this.style.left='100%';"></div>
      
      <!-- Efecto de part√≠culas flotantes -->
      <div style="
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        overflow: hidden;
      ">
        <div style="
          position: absolute;
          top: 20%;
          left: 10%;
          width: 4px;
          height: 4px;
          background: rgba(255, 255, 255, 0.6);
          border-radius: 50%;
          animation: float1 3s ease-in-out infinite;
        "></div>
        <div style="
          position: absolute;
          top: 60%;
          right: 15%;
          width: 3px;
          height: 3px;
          background: rgba(255, 255, 255, 0.4);
          border-radius: 50%;
          animation: float2 4s ease-in-out infinite;
        "></div>
      </div>
      
      <!-- Icono con animaci√≥n -->
      <i class="fas fa-folder-open" style="
        font-size: 18px; 
        filter: drop-shadow(0 3px 6px rgba(0,0,0,0.4));
        transition: transform 0.3s ease;
      " onmouseover="this.style.transform='scale(1.2) rotate(10deg)'" 
         onmouseout="this.style.transform='scale(1) rotate(0deg)'"></i>
      
      <!-- Texto con efectos mejorados -->
      <span style="
        font-weight: 900; 
        text-shadow: 0 3px 6px rgba(0,0,0,0.4), 0 0 20px rgba(255,255,255,0.3);
        background: linear-gradient(45deg, #ffffff, #f0f0ff);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      ">Proyectos</span>
      
      <!-- Indicador de pulso mejorado -->
      <div style="
        position: absolute;
        top: -3px;
        right: -3px;
        width: 10px;
        height: 10px;
        background: linear-gradient(45deg, #10b981, #34d399);
        border-radius: 50%;
        animation: pulse 2s infinite;
        box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
        border: 2px solid rgba(255, 255, 255, 0.8);
      "></div>
      
      <!-- Contador de proyectos (simulado) -->
      <div style="
        position: absolute;
        bottom: -8px;
        right: -8px;
        background: linear-gradient(45deg, #ef4444, #f97316);
        color: white;
        font-size: 10px;
        font-weight: 900;
        padding: 2px 6px;
        border-radius: 10px;
        border: 2px solid rgba(255, 255, 255, 0.9);
        box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
        animation: bounce 2s infinite;
      ">12</div>
    </button>
    
    <!-- Estilos CSS para animaciones -->
    <style>
      @keyframes pulse {
        0% {
          box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
          transform: scale(1);
        }
        50% {
          box-shadow: 0 0 0 8px rgba(16, 185, 129, 0);
          transform: scale(1.1);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
          transform: scale(1);
        }
      }
      
      @keyframes float1 {
        0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.6; }
        50% { transform: translateY(-10px) rotate(180deg); opacity: 1; }
      }
      
      @keyframes float2 {
        0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.4; }
        50% { transform: translateY(-8px) rotate(-180deg); opacity: 0.8; }
      }
      
      @keyframes bounce {
        0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
        40% { transform: translateY(-5px); }
        60% { transform: translateY(-3px); }
      }
    </style>
  </div>
  
  </div>
  

  
</div>



</div>
<!-- Contenedor del perfil de elevaci√≥n con torres mejoradas -->
<div id="perfil-elevacion-con-torres" style="display: flex; align-items: flex-end; justify-content: center; margin: 40px auto 30px auto; width: 100%; max-width: 2000px; position: relative;">
  
  <!-- Torre A (izquierda) - Ultra detallada con textura met√°lica real -->
  <div style="width:220px; min-width:180px; height:600px; display:flex; flex-direction:column; align-items:center; justify-content:flex-end; margin-right:60px; position:relative;">
    <!-- Cuadro de datos en la punta de la torre -->
    <div id="torreA-info"
         style="position:absolute; left:50%; top:-80px; transform:translateX(-50%); background:rgba(10, 15, 28, 0.98); color:#00d4ff; border-radius:16px; box-shadow:0 8px 24px rgba(0,212,255,0.5); padding:12px 20px; min-width:120px; text-align:center; font-size:12px; z-index:10; border:2px solid rgba(0,212,255,0.6); backdrop-filter:blur(15px); animation: torreInfoFloat 4s ease-in-out infinite;">
      <b id="torreA-id" style="color:#00d4ff; font-size:14px; font-weight:800; text-shadow:0 0 10px rgba(0,212,255,0.7);">ID</b><br>
      <span id="torreA-nombre" style="color:#f8fafc; font-weight:700; font-size:12px;">Nombre</span><br>
      <span id="torreA-altura" style="color:#cbd5e1; font-weight:600; font-size:11px;">Altura m</span>
    </div>

        <!-- Torre A SVG ultra detallada con textura met√°lica real -->
    <svg viewBox="0 0 80 250" style="height:600px; width:auto; display:block; filter: drop-shadow(0 8px 16px rgba(0,212,255,0.3));" xmlns="http://www.w3.org/2000/svg">
  <defs>
        <!-- Gradientes met√°licos ultra realistas -->
        <linearGradient id="metalA" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stop-color="#e2e8f0" stop-opacity="1"/>
          <stop offset="15%" stop-color="#cbd5e1" stop-opacity="0.95"/>
          <stop offset="30%" stop-color="#94a3b8" stop-opacity="0.9"/>
          <stop offset="50%" stop-color="#64748b" stop-opacity="0.85"/>
          <stop offset="70%" stop-color="#475569" stop-opacity="0.8"/>
          <stop offset="85%" stop-color="#334155" stop-opacity="0.75"/>
          <stop offset="100%" stop-color="#1e293b" stop-opacity="0.7"/>
    </linearGradient>
        
        <linearGradient id="metalShineA" x1="0" y1="0" x2="1" y2="1">
          <stop offset="0%" stop-color="#ffffff" stop-opacity="0.8"/>
          <stop offset="25%" stop-color="#f1f5f9" stop-opacity="0.6"/>
          <stop offset="50%" stop-color="#e2e8f0" stop-opacity="0.4"/>
          <stop offset="75%" stop-color="#cbd5e1" stop-opacity="0.2"/>
          <stop offset="100%" stop-color="#94a3b8" stop-opacity="0.1"/>
        </linearGradient>
        
        <linearGradient id="concreteA" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stop-color="#94a3b8"/>
          <stop offset="50%" stop-color="#64748b"/>
          <stop offset="100%" stop-color="#475569"/>
        </linearGradient>
        
        <!-- Patrones de textura met√°lica ultra detallados -->
        <pattern id="metalTextureA" width="8" height="8" patternUnits="userSpaceOnUse">
      <rect x="0" y="0" width="8" height="8" fill="none"/>
          <line x1="0" y1="0" x2="8" y2="8" stroke="#64748b" stroke-width="0.5" opacity="0.6"/>
          <line x1="8" y1="0" x2="0" y2="8" stroke="#64748b" stroke-width="0.5" opacity="0.6"/>
          <line x1="4" y1="0" x2="4" y2="8" stroke="#475569" stroke-width="0.3" opacity="0.4"/>
          <line x1="0" y1="4" x2="8" y2="4" stroke="#475569" stroke-width="0.3" opacity="0.4"/>
          <circle cx="4" cy="4" r="0.5" fill="#64748b" opacity="0.5"/>
    </pattern>
        
        <pattern id="rivetPatternA" width="12" height="12" patternUnits="userSpaceOnUse">
          <rect x="0" y="0" width="12" height="12" fill="none"/>
          <circle cx="6" cy="6" r="1.5" fill="#334155" stroke="#1e293b" stroke-width="0.5"/>
          <circle cx="6" cy="6" r="0.8" fill="#64748b" opacity="0.8"/>
          <circle cx="6" cy="6" r="0.3" fill="#ffffff" opacity="0.9"/>
        </pattern>
        
        <pattern id="weldPatternA" width="16" height="16" patternUnits="userSpaceOnUse">
          <rect x="0" y="0" width="16" height="16" fill="none"/>
          <path d="M2,8 Q8,2 14,8 Q8,14 2,8" fill="none" stroke="#475569" stroke-width="1" opacity="0.7"/>
          <path d="M8,2 Q14,8 8,14 Q2,8 8,2" fill="none" stroke="#475569" stroke-width="1" opacity="0.7"/>
        </pattern>
        
        <!-- Filtros de efectos realistas -->
        <filter id="metalGlowA">
          <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
          <feMerge> 
            <feMergeNode in="coloredBlur"/>
            <feMergeNode in="SourceGraphic"/>
          </feMerge>
        </filter>
        
        <filter id="metalShadowA">
          <feDropShadow dx="2" dy="4" stdDeviation="3" flood-color="#000" flood-opacity="0.4"/>
        </filter>
        
        <filter id="metalHighlightA">
          <feGaussianBlur stdDeviation="1" result="blur"/>
          <feSpecularLighting in="blur" surfaceScale="5" specularConstant="1.5" specularExponent="20" lighting-color="#ffffff">
            <fePointLight x="40" y="20" z="200"/>
          </feSpecularLighting>
          <feComposite in="specular" in2="SourceGraphic" operator="arithmetic" k1="0" k2="1" k3="1" k4="0"/>
        </filter>
  </defs>
      
      <!-- Sombra realista de la torre -->
      <ellipse cx="40" cy="245" rx="35" ry="15" fill="#000" opacity="0.3" filter="url(#metalShadowA)"/>
      
      <!-- Base de concreto con textura -->
      <ellipse cx="40" cy="240" rx="40" ry="18" fill="url(#concreteA)"/>
      <ellipse cx="40" cy="240" rx="32" ry="12" fill="url(#metalTextureA)" opacity="0.6"/>
      <ellipse cx="40" cy="240" rx="25" ry="10" fill="#334155" opacity="0.8"/>
      
      <!-- Estructura principal de la torre con textura met√°lica -->
      <polygon points="40,15 8,240 72,240" fill="url(#metalA)" stroke="#475569" stroke-width="2" filter="url(#metalGlowA)"/>
      <polygon points="40,25 12,235 68,235" fill="url(#metalTextureA)" opacity="0.8"/>
      <polygon points="40,20 15,230 65,230" fill="url(#metalShineA)" opacity="0.4"/>
      
      <!-- Refuerzos estructurales principales con textura -->
      <line x1="40" y1="15" x2="40" y2="240" stroke="#475569" stroke-width="6" opacity="0.9"/>
      <line x1="15" y1="60" x2="65" y2="160" stroke="#475569" stroke-width="5" opacity="0.85"/>
      <line x1="65" y1="60" x2="15" y2="160" stroke="#475569" stroke-width="5" opacity="0.85"/>
      <line x1="12" y1="110" x2="68" y2="180" stroke="#475569" stroke-width="5" opacity="0.85"/>
      <line x1="68" y1="110" x2="12" y2="180" stroke="#475569" stroke-width="5" opacity="0.85"/>
      
      <!-- Refuerzos secundarios -->
      <line x1="20" y1="40" x2="60" y2="120" stroke="#64748b" stroke-width="4" opacity="0.7"/>
      <line x1="60" y1="40" x2="20" y2="120" stroke="#64748b" stroke-width="4" opacity="0.7"/>
      <line x1="18" y1="80" x2="62" y2="200" stroke="#64748b" stroke-width="4" opacity="0.7"/>
      <line x1="62" y1="80" x2="18" y2="200" stroke="#64748b" stroke-width="4" opacity="0.7"/>
      
      <!-- Plataformas horizontales principales con textura -->
      <line x1="15" y1="60" x2="65" y2="60" stroke="#475569" stroke-width="6" opacity="0.95"/>
      <line x1="12" y1="110" x2="68" y2="110" stroke="#475569" stroke-width="6" opacity="0.95"/>
      <line x1="15" y1="160" x2="65" y2="160" stroke="#475569" stroke-width="6" opacity="0.95"/>
      <line x1="8" y1="240" x2="72" y2="240" stroke="#475569" stroke-width="8" opacity="0.95"/>
      
      <!-- Plataformas secundarias -->
      <line x1="20" y1="40" x2="60" y2="40" stroke="#64748b" stroke-width="4" opacity="0.8"/>
      <line x1="18" y1="80" x2="62" y2="80" stroke="#64748b" stroke-width="4" opacity="0.8"/>
      <line x1="20" y1="120" x2="60" y2="120" stroke="#64748b" stroke-width="4" opacity="0.8"/>
      <line x1="18" y1="180" x2="62" y2="180" stroke="#64748b" stroke-width="4" opacity="0.8"/>
      
      <!-- Remaches y conexiones met√°licas -->
      <circle cx="40" cy="60" r="2" fill="url(#rivetPatternA)"/>
      <circle cx="40" cy="110" r="2" fill="url(#rivetPatternA)"/>
      <circle cx="40" cy="160" r="2" fill="url(#rivetPatternA)"/>
      <circle cx="40" cy="240" r="2" fill="url(#rivetPatternA)"/>
      <circle cx="15" cy="60" r="1.5" fill="url(#rivetPatternA)"/>
      <circle cx="65" cy="60" r="1.5" fill="url(#rivetPatternA)"/>
      <circle cx="12" cy="110" r="1.5" fill="url(#rivetPatternA)"/>
      <circle cx="68" cy="110" r="1.5" fill="url(#rivetPatternA)"/>
      
      <!-- Soldaduras y juntas -->
      <path d="M35,60 Q40,55 45,60" fill="none" stroke="url(#weldPatternA)" stroke-width="2" opacity="0.6"/>
      <path d="M32,110 Q40,105 48,110" fill="none" stroke="url(#weldPatternA)" stroke-width="2" opacity="0.6"/>
      <path d="M35,160 Q40,155 45,160" fill="none" stroke="url(#weldPatternA)" stroke-width="2" opacity="0.6"/>
      
      <!-- Cabina de control con textura met√°lica -->
      <rect x="30" y="0" width="20" height="30" rx="4" fill="url(#metalA)" stroke="#475569" stroke-width="2"/>
      <rect x="25" y="-5" width="30" height="10" rx="4" fill="url(#metalA)" stroke="#475569" stroke-width="2"/>
      <rect x="28" y="3" width="24" height="5" rx="2" fill="url(#metalShineA)" opacity="0.6"/>
      
      <!-- Ventanas de la cabina con marco met√°lico -->
      <rect x="33" y="6" width="5" height="8" rx="1" fill="#1e293b" opacity="0.9"/>
      <rect x="42" y="6" width="5" height="8" rx="1" fill="#1e293b" opacity="0.9"/>
      <rect x="33" y="18" width="5" height="8" rx="1" fill="#1e293b" opacity="0.9"/>
      <rect x="42" y="18" width="5" height="8" rx="1" fill="#1e293b" opacity="0.9"/>
      
      <!-- Marcos de ventanas -->
      <rect x="32" y="5" width="7" height="10" rx="1" fill="none" stroke="#475569" stroke-width="1"/>
      <rect x="41" y="5" width="7" height="10" rx="1" fill="none" stroke="#475569" stroke-width="1"/>
      <rect x="32" y="17" width="7" height="10" rx="1" fill="none" stroke="#475569" stroke-width="1"/>
      <rect x="41" y="17" width="7" height="10" rx="1" fill="none" stroke="#475569" stroke-width="1"/>
      
      <!-- Antena principal con textura met√°lica -->
      <rect x="37" y="-20" width="6" height="22" rx="2" fill="url(#metalA)" stroke="#475569" stroke-width="1"/>
      <circle cx="40" cy="-20" r="5" fill="url(#metalA)" stroke="#475569" stroke-width="2"/>
      <circle cx="40" cy="-20" r="3" fill="url(#metalShineA)" opacity="0.7"/>
      
      <!-- Antenas secundarias -->
      <rect x="32" y="-12" width="3" height="12" rx="1" fill="url(#metalA)" stroke="#475569" stroke-width="0.5"/>
      <rect x="45" y="-12" width="3" height="12" rx="1" fill="url(#metalA)" stroke="#475569" stroke-width="0.5"/>
      <circle cx="33.5" cy="-12" r="1.5" fill="#10b981" stroke="#475569" stroke-width="0.5"/>
      <circle cx="46.5" cy="-12" r="1.5" fill="#10b981" stroke="#475569" stroke-width="0.5"/>
      
      <!-- Equipos de comunicaci√≥n con textura -->
      <ellipse cx="60" cy="70" rx="6" ry="15" fill="url(#metalA)" stroke="#475569" stroke-width="1"/>
      <ellipse cx="20" cy="120" rx="6" ry="15" fill="url(#metalA)" stroke="#475569" stroke-width="1"/>
      <ellipse cx="60" cy="170" rx="6" ry="15" fill="url(#metalA)" stroke="#475569" stroke-width="1"/>
      
      <!-- Detalles de equipos -->
      <rect x="56" y="65" width="8" height="4" rx="1" fill="#1e293b" opacity="0.9"/>
      <rect x="16" y="115" width="8" height="4" rx="1" fill="#1e293b" opacity="0.9"/>
      <rect x="56" y="165" width="8" height="4" rx="1" fill="#1e293b" opacity="0.9"/>
      
      <!-- Puntos de conexi√≥n con textura -->
      <circle cx="40" cy="60" r="3" fill="url(#metalA)" stroke="#475569" stroke-width="1"/>
      <circle cx="40" cy="110" r="3" fill="url(#metalA)" stroke="#475569" stroke-width="1"/>
      <circle cx="40" cy="160" r="3" fill="url(#metalA)" stroke="#475569" stroke-width="1"/>
      <circle cx="40" cy="240" r="3" fill="url(#metalA)" stroke="#475569" stroke-width="1"/>
      
      <!-- Efectos de luz met√°lica -->
      <circle cx="40" cy="60" r="8" fill="url(#metalShineA)" opacity="0.3"/>
      <circle cx="40" cy="110" r="8" fill="url(#metalShineA)" opacity="0.3"/>
      <circle cx="40" cy="160" r="8" fill="url(#metalShineA)" opacity="0.3"/>
      
      <!-- Efectos de ne√≥n sutiles -->
      <circle cx="40" cy="60" r="12" fill="none" stroke="#00d4ff" stroke-width="1" opacity="0.2"/>
      <circle cx="40" cy="110" r="12" fill="none" stroke="#00d4ff" stroke-width="1" opacity="0.2"/>
      <circle cx="40" cy="160" r="12" fill="none" stroke="#00d4ff" stroke-width="1" opacity="0.2"/>
      
      <!-- Elementos decorativos met√°licos -->
      <circle cx="40" cy="35" r="2" fill="url(#metalA)" stroke="#475569" stroke-width="0.5"/>
      <circle cx="40" cy="85" r="2" fill="url(#metalA)" stroke="#475569" stroke-width="0.5"/>
      <circle cx="40" cy="135" r="2" fill="url(#metalA)" stroke="#475569" stroke-width="0.5"/>
      <circle cx="40" cy="185" r="2" fill="url(#metalA)" stroke="#475569" stroke-width="0.5"/>
</svg>
  </div>

  <!-- Contenedor del gr√°fico con botones externos -->
  <div style="position: relative; display: flex; flex-direction: column; align-items: center;">
    <!-- Gr√°fico de elevaci√≥n en el centro -->
    <div id="perfilElevacionPlotly" style="width: 1400px; height: 600px; margin: 0 20px; background: rgba(15, 23, 42, 0.8); border-radius: 16px; border: 2px solid rgba(59, 130, 246, 0.3); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); position: relative;">
    </div>
    
    <!-- Botones principales (interfaz limpia) -->
    <div style="position: absolute; top: 20px; right: 20px; z-index: 1000; display: flex; gap: 10px;">
      <button id="btn-probar-mapbox" onclick="probarMapBox()" style="padding: 12px 16px; font-size: 13px; border-radius: 8px; background: rgba(16, 185, 129, 0.9); border: 1px solid rgba(16, 185, 129, 0.5); color: white; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px;">
        <i class="fas fa-map" style="font-size: 14px;"></i>
        üó∫Ô∏è Probar MapBox
      </button>
      <button id="btn-config-apis" onclick="configurarAPIKeys()" style="padding: 12px 16px; font-size: 13px; border-radius: 8px; background: rgba(168, 85, 247, 0.9); border: 1px solid rgba(168, 85, 247, 0.5); color: white; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px;">
        <i class="fas fa-cog" style="font-size: 14px;"></i>
        üîë APIs
      </button>
      <button id="btn-perfil-real" onclick="activarPerfilElevacionReal()" style="padding: 12px 16px; font-size: 13px; border-radius: 8px; background: rgba(16, 185, 129, 0.9); border: 1px solid rgba(16, 185, 129, 0.5); color: white; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px;">
        <i class="fas fa-mountain" style="font-size: 14px;"></i>
        üó∫Ô∏è Perfil Real
      </button>
      <button id="btn-datos-tecnicos" onclick="toggleDatosTecnicosAvanzados()" style="padding: 12px 16px; font-size: 13px; border-radius: 8px; background: rgba(59, 130, 246, 0.9); border: 1px solid rgba(59, 130, 246, 0.5); color: white; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px;">
        <i class="fas fa-chart-line" style="font-size: 14px;"></i>
        üìä Datos T√©cnicos
      </button>

    </div>
    
    <!-- Bot√≥n adicional en la parte inferior para mayor visibilidad -->
    <div style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 1000;">
      <button id="btn-datos-tecnicos-inferior" onclick="toggleDatosTecnicosAvanzados()" style="padding: 10px 20px; font-size: 12px; border-radius: 6px; background: rgba(16, 185, 129, 0.9); border: 1px solid rgba(16, 185, 129, 0.5); color: white; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 6px;">
        <i class="fas fa-calculator" style="font-size: 12px;"></i>
        üìä Ver Datos T√©cnicos
      </button>
    </div>
  </div>
  
  <!-- Torre B (derecha) - Ultra detallada con textura met√°lica real -->
  <div style="width:220px; min-width:180px; height:600px; display:flex; flex-direction:column; align-items:center; justify-content:flex-end; margin-left:60px; position:relative;">
    <!-- Cuadro de datos en la punta de la torre -->
    <div id="torreB-info"
         style="position:absolute; left:50%; top:-80px; transform:translateX(-50%); background:rgba(10, 15, 28, 0.98); color:#3b82f6; border-radius:16px; box-shadow:0 8px 24px rgba(59,130,246,0.5); padding:12px 20px; min-width:120px; text-align:center; font-size:12px; z-index:10; border:2px solid rgba(59,130,246,0.6); backdrop-filter:blur(15px); animation: torreInfoFloat 4s ease-in-out infinite;">
      <b id="torreB-id" style="color:#3b82f6; font-size:14px; font-weight:800; text-shadow:0 0 10px rgba(59,130,246,0.7);">ID</b><br>
      <span id="torreB-nombre" style="color:#f8fafc; font-weight:700; font-size:12px;">Nombre</span><br>
      <span id="torreB-altura" style="color:#cbd5e1; font-weight:600; font-size:11px;">Altura m</span>
    </div>

        <!-- Torre B SVG ultra detallada con textura met√°lica real -->
    <svg viewBox="0 0 80 250" style="height:600px; width:auto; display:block; filter: drop-shadow(0 8px 16px rgba(59,130,246,0.3));" xmlns="http://www.w3.org/2000/svg">
  <defs>
        <!-- Gradientes met√°licos ultra realistas -->
        <linearGradient id="metalB" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stop-color="#e2e8f0" stop-opacity="1"/>
          <stop offset="15%" stop-color="#cbd5e1" stop-opacity="0.95"/>
          <stop offset="30%" stop-color="#94a3b8" stop-opacity="0.9"/>
          <stop offset="50%" stop-color="#64748b" stop-opacity="0.85"/>
          <stop offset="70%" stop-color="#475569" stop-opacity="0.8"/>
          <stop offset="85%" stop-color="#334155" stop-opacity="0.75"/>
          <stop offset="100%" stop-color="#1e293b" stop-opacity="0.7"/>
    </linearGradient>
        
        <linearGradient id="metalShineB" x1="0" y1="0" x2="1" y2="1">
          <stop offset="0%" stop-color="#ffffff" stop-opacity="0.8"/>
          <stop offset="25%" stop-color="#f1f5f9" stop-opacity="0.6"/>
          <stop offset="50%" stop-color="#e2e8f0" stop-opacity="0.4"/>
          <stop offset="75%" stop-color="#cbd5e1" stop-opacity="0.2"/>
          <stop offset="100%" stop-color="#94a3b8" stop-opacity="0.1"/>
        </linearGradient>
        
        <linearGradient id="concreteB" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stop-color="#94a3b8"/>
          <stop offset="50%" stop-color="#64748b"/>
          <stop offset="100%" stop-color="#475569"/>
        </linearGradient>
        
        <!-- Patrones de textura met√°lica ultra detallados -->
        <pattern id="metalTextureB" width="8" height="8" patternUnits="userSpaceOnUse">
      <rect x="0" y="0" width="8" height="8" fill="none"/>
          <line x1="0" y1="0" x2="8" y2="8" stroke="#64748b" stroke-width="0.5" opacity="0.6"/>
          <line x1="8" y1="0" x2="0" y2="8" stroke="#64748b" stroke-width="0.5" opacity="0.6"/>
          <line x1="4" y1="0" x2="4" y2="8" stroke="#475569" stroke-width="0.3" opacity="0.4"/>
          <line x1="0" y1="4" x2="8" y2="4" stroke="#475569" stroke-width="0.3" opacity="0.4"/>
          <circle cx="4" cy="4" r="0.5" fill="#64748b" opacity="0.5"/>
    </pattern>
        
        <pattern id="rivetPatternB" width="12" height="12" patternUnits="userSpaceOnUse">
          <rect x="0" y="0" width="12" height="12" fill="none"/>
          <circle cx="6" cy="6" r="1.5" fill="#334155" stroke="#1e293b" stroke-width="0.5"/>
          <circle cx="6" cy="6" r="0.8" fill="#64748b" opacity="0.8"/>
          <circle cx="6" cy="6" r="0.3" fill="#ffffff" opacity="0.9"/>
        </pattern>
        
        <pattern id="weldPatternB" width="16" height="16" patternUnits="userSpaceOnUse">
          <rect x="0" y="0" width="16" height="16" fill="none"/>
          <path d="M2,8 Q8,2 14,8 Q8,14 2,8" fill="none" stroke="#475569" stroke-width="1" opacity="0.7"/>
          <path d="M8,2 Q14,8 8,14 Q2,8 8,2" fill="none" stroke="#475569" stroke-width="1" opacity="0.7"/>
        </pattern>
        
        <!-- Filtros de efectos realistas -->
        <filter id="metalGlowB">
          <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
          <feMerge> 
            <feMergeNode in="coloredBlur"/>
            <feMergeNode in="SourceGraphic"/>
          </feMerge>
        </filter>
        
        <filter id="metalShadowB">
          <feDropShadow dx="2" dy="4" stdDeviation="3" flood-color="#000" flood-opacity="0.4"/>
        </filter>
  </defs>
      
      <!-- Sombra realista de la torre -->
      <ellipse cx="40" cy="245" rx="35" ry="15" fill="#000" opacity="0.3" filter="url(#metalShadowB)"/>
      
      <!-- Base de concreto con textura -->
      <ellipse cx="40" cy="240" rx="40" ry="18" fill="url(#concreteB)"/>
      <ellipse cx="40" cy="240" rx="32" ry="12" fill="url(#metalTextureB)" opacity="0.6"/>
      <ellipse cx="40" cy="240" rx="25" ry="10" fill="#334155" opacity="0.8"/>
      
      <!-- Estructura principal de la torre con textura met√°lica -->
      <polygon points="40,15 8,240 72,240" fill="url(#metalB)" stroke="#475569" stroke-width="2" filter="url(#metalGlowB)"/>
      <polygon points="40,25 12,235 68,235" fill="url(#metalTextureB)" opacity="0.8"/>
      <polygon points="40,20 15,230 65,230" fill="url(#metalShineB)" opacity="0.4"/>
      
      <!-- Refuerzos estructurales principales con textura -->
      <line x1="40" y1="15" x2="40" y2="240" stroke="#475569" stroke-width="6" opacity="0.9"/>
      <line x1="15" y1="60" x2="65" y2="160" stroke="#475569" stroke-width="5" opacity="0.85"/>
      <line x1="65" y1="60" x2="15" y2="160" stroke="#475569" stroke-width="5" opacity="0.85"/>
      <line x1="12" y1="110" x2="68" y2="180" stroke="#475569" stroke-width="5" opacity="0.85"/>
      <line x1="68" y1="110" x2="12" y2="180" stroke="#475569" stroke-width="5" opacity="0.85"/>
      
      <!-- Refuerzos secundarios -->
      <line x1="20" y1="40" x2="60" y2="120" stroke="#64748b" stroke-width="4" opacity="0.7"/>
      <line x1="60" y1="40" x2="20" y2="120" stroke="#64748b" stroke-width="4" opacity="0.7"/>
      <line x1="18" y1="80" x2="62" y2="200" stroke="#64748b" stroke-width="4" opacity="0.7"/>
      <line x1="62" y1="80" x2="18" y2="200" stroke="#64748b" stroke-width="4" opacity="0.7"/>
      
      <!-- Plataformas horizontales principales con textura -->
      <line x1="15" y1="60" x2="65" y2="60" stroke="#475569" stroke-width="6" opacity="0.95"/>
      <line x1="12" y1="110" x2="68" y2="110" stroke="#475569" stroke-width="6" opacity="0.95"/>
      <line x1="15" y1="160" x2="65" y2="160" stroke="#475569" stroke-width="6" opacity="0.95"/>
      <line x1="8" y1="240" x2="72" y2="240" stroke="#475569" stroke-width="8" opacity="0.95"/>
      
      <!-- Plataformas secundarias -->
      <line x1="20" y1="40" x2="60" y2="40" stroke="#64748b" stroke-width="4" opacity="0.8"/>
      <line x1="18" y1="80" x2="62" y2="80" stroke="#64748b" stroke-width="4" opacity="0.8"/>
      <line x1="20" y1="120" x2="60" y2="120" stroke="#64748b" stroke-width="4" opacity="0.8"/>
      <line x1="18" y1="180" x2="62" y2="180" stroke="#64748b" stroke-width="4" opacity="0.8"/>
      
      <!-- Remaches y conexiones met√°licas -->
      <circle cx="40" cy="60" r="2" fill="url(#rivetPatternB)"/>
      <circle cx="40" cy="110" r="2" fill="url(#rivetPatternB)"/>
      <circle cx="40" cy="160" r="2" fill="url(#rivetPatternB)"/>
      <circle cx="40" cy="240" r="2" fill="url(#rivetPatternB)"/>
      <circle cx="15" cy="60" r="1.5" fill="url(#rivetPatternB)"/>
      <circle cx="65" cy="60" r="1.5" fill="url(#rivetPatternB)"/>
      <circle cx="12" cy="110" r="1.5" fill="url(#rivetPatternB)"/>
      <circle cx="68" cy="110" r="1.5" fill="url(#rivetPatternB)"/>
      
      <!-- Soldaduras y juntas -->
      <path d="M35,60 Q40,55 45,60" fill="none" stroke="url(#weldPatternB)" stroke-width="2" opacity="0.6"/>
      <path d="M32,110 Q40,105 48,110" fill="none" stroke="url(#weldPatternB)" stroke-width="2" opacity="0.6"/>
      <path d="M35,160 Q40,155 45,160" fill="none" stroke="url(#weldPatternB)" stroke-width="2" opacity="0.6"/>
      
      <!-- Cabina de control con textura met√°lica -->
      <rect x="30" y="0" width="20" height="30" rx="4" fill="url(#metalB)" stroke="#475569" stroke-width="2"/>
      <rect x="25" y="-5" width="30" height="10" rx="4" fill="url(#metalB)" stroke="#475569" stroke-width="2"/>
      <rect x="28" y="3" width="24" height="5" rx="2" fill="url(#metalShineB)" opacity="0.6"/>
      
      <!-- Ventanas de la cabina con marco met√°lico -->
      <rect x="33" y="6" width="5" height="8" rx="1" fill="#1e293b" opacity="0.9"/>
      <rect x="42" y="6" width="5" height="8" rx="1" fill="#1e293b" opacity="0.9"/>
      <rect x="33" y="18" width="5" height="8" rx="1" fill="#1e293b" opacity="0.9"/>
      <rect x="42" y="18" width="5" height="8" rx="1" fill="#1e293b" opacity="0.9"/>
      
      <!-- Marcos de ventanas -->
      <rect x="32" y="5" width="7" height="10" rx="1" fill="none" stroke="#475569" stroke-width="1"/>
      <rect x="41" y="5" width="7" height="10" rx="1" fill="none" stroke="#475569" stroke-width="1"/>
      <rect x="32" y="17" width="7" height="10" rx="1" fill="none" stroke="#475569" stroke-width="1"/>
      <rect x="41" y="17" width="7" height="10" rx="1" fill="none" stroke="#475569" stroke-width="1"/>
      
      <!-- Antena principal con textura met√°lica -->
      <rect x="37" y="-20" width="6" height="22" rx="2" fill="url(#metalB)" stroke="#475569" stroke-width="1"/>
      <circle cx="40" cy="-20" r="5" fill="url(#metalB)" stroke="#475569" stroke-width="2"/>
      <circle cx="40" cy="-20" r="3" fill="url(#metalShineB)" opacity="0.7"/>
      
      <!-- Antenas secundarias -->
      <rect x="32" y="-12" width="3" height="12" rx="1" fill="url(#metalB)" stroke="#475569" stroke-width="0.5"/>
      <rect x="45" y="-12" width="3" height="12" rx="1" fill="url(#metalB)" stroke="#475569" stroke-width="0.5"/>
      <circle cx="33.5" cy="-12" r="1.5" fill="#10b981" stroke="#475569" stroke-width="0.5"/>
      <circle cx="46.5" cy="-12" r="1.5" fill="#10b981" stroke="#475569" stroke-width="0.5"/>
      
      <!-- Equipos de comunicaci√≥n con textura -->
      <ellipse cx="60" cy="70" rx="6" ry="15" fill="url(#metalB)" stroke="#475569" stroke-width="1"/>
      <ellipse cx="20" cy="120" rx="6" ry="15" fill="url(#metalB)" stroke="#475569" stroke-width="1"/>
      <ellipse cx="60" cy="170" rx="6" ry="15" fill="url(#metalB)" stroke="#475569" stroke-width="1"/>
      
      <!-- Detalles de equipos -->
      <rect x="56" y="65" width="8" height="4" rx="1" fill="#1e293b" opacity="0.9"/>
      <rect x="16" y="115" width="8" height="4" rx="1" fill="#1e293b" opacity="0.9"/>
      <rect x="56" y="165" width="8" height="4" rx="1" fill="#1e293b" opacity="0.9"/>
      
      <!-- Puntos de conexi√≥n con textura -->
      <circle cx="40" cy="60" r="3" fill="url(#metalB)" stroke="#475569" stroke-width="1"/>
      <circle cx="40" cy="110" r="3" fill="url(#metalB)" stroke="#475569" stroke-width="1"/>
      <circle cx="40" cy="160" r="3" fill="url(#metalB)" stroke="#475569" stroke-width="1"/>
      <circle cx="40" cy="240" r="3" fill="url(#metalB)" stroke="#475569" stroke-width="1"/>
      
      <!-- Efectos de luz met√°lica -->
      <circle cx="40" cy="60" r="8" fill="url(#metalShineB)" opacity="0.3"/>
      <circle cx="40" cy="110" r="8" fill="url(#metalShineB)" opacity="0.3"/>
      <circle cx="40" cy="160" r="8" fill="url(#metalShineB)" opacity="0.3"/>
      
      <!-- Efectos de ne√≥n sutiles -->
      <circle cx="40" cy="60" r="12" fill="none" stroke="#3b82f6" stroke-width="1" opacity="0.2"/>
      <circle cx="40" cy="110" r="12" fill="none" stroke="#3b82f6" stroke-width="1" opacity="0.2"/>
      <circle cx="40" cy="160" r="12" fill="none" stroke="#3b82f6" stroke-width="1" opacity="0.2"/>
      
      <!-- Elementos decorativos met√°licos -->
      <circle cx="40" cy="35" r="2" fill="url(#metalB)" stroke="#475569" stroke-width="0.5"/>
      <circle cx="40" cy="85" r="2" fill="url(#metalB)" stroke="#475569" stroke-width="0.5"/>
      <circle cx="40" cy="135" r="2" fill="url(#metalB)" stroke="#475569" stroke-width="0.5"/>
      <circle cx="40" cy="185" r="2" fill="url(#metalB)" stroke="#475569" stroke-width="0.5"/>
</svg>
  </div>
</div>
  
  
  <!-- Sombra de la torre -->
  <ellipse cx="30" cy="195" rx="20" ry="8" fill="#000" opacity="0.3" filter="url(#shadowB)"/>
  
  <!-- Base de concreto -->
  <ellipse cx="30" cy="190" rx="25" ry="12" fill="url(#torreConcreteB)"/>
  <ellipse cx="30" cy="190" rx="20" ry="8" fill="url(#texturaConcreteB)" opacity="0.7"/>
  <ellipse cx="30" cy="190" rx="15" ry="6" fill="#334155" opacity="0.9"/>
  
  <!-- Estructura principal de la torre -->
  <polygon points="30,10 5,190 55,190" fill="url(#torreMetalB)" stroke="#fff" stroke-width="5" filter="url(#glowB)"/>
  <polygon points="30,20 10,185 50,185" fill="url(#texturaMetalB)" opacity="0.7"/>
  
  <!-- Refuerzos estructurales principales -->
  <line x1="30" y1="10" x2="30" y2="190" stroke="#3b82f6" stroke-width="4" opacity="0.9"/>
  <line x1="10" y1="50" x2="50" y2="130" stroke="#3b82f6" stroke-width="3" opacity="0.8"/>
  <line x1="50" y1="50" x2="10" y2="130" stroke="#3b82f6" stroke-width="3" opacity="0.8"/>
  <line x1="8" y1="90" x2="52" y2="150" stroke="#3b82f6" stroke-width="3" opacity="0.8"/>
  <line x1="52" y1="90" x2="8" y2="150" stroke="#3b82f6" stroke-width="3" opacity="0.8"/>
  
  <!-- Refuerzos secundarios -->
  <line x1="15" y1="30" x2="45" y2="110" stroke="#1d4ed8" stroke-width="2" opacity="0.6"/>
  <line x1="45" y1="30" x2="15" y2="110" stroke="#1d4ed8" stroke-width="2" opacity="0.6"/>
  <line x1="12" y1="70" x2="48" y2="170" stroke="#1d4ed8" stroke-width="2" opacity="0.6"/>
  <line x1="48" y1="70" x2="12" y2="170" stroke="#1d4ed8" stroke-width="2" opacity="0.6"/>
  
  <!-- Plataformas horizontales principales -->
  <line x1="10" y1="50" x2="50" y2="50" stroke="#fff" stroke-width="3" opacity="0.95"/>
  <line x1="8" y1="90" x2="52" y2="90" stroke="#fff" stroke-width="3" opacity="0.95"/>
  <line x1="10" y1="130" x2="50" y2="130" stroke="#fff" stroke-width="3" opacity="0.95"/>
  <line x1="5" y1="190" x2="55" y2="190" stroke="#3b82f6" stroke-width="5" opacity="0.95"/>
  
  <!-- Plataformas secundarias -->
  <line x1="15" y1="30" x2="45" y2="30" stroke="#e0f7fa" stroke-width="2" opacity="0.8"/>
  <line x1="12" y1="70" x2="48" y2="70" stroke="#e0f7fa" stroke-width="2" opacity="0.8"/>
  <line x1="15" y1="110" x2="45" y2="110" stroke="#e0f7fa" stroke-width="2" opacity="0.8"/>
  <line x1="12" y1="150" x2="48" y2="150" stroke="#e0f7fa" stroke-width="2" opacity="0.8"/>
  
  <!-- Cabina de control mejorada -->
  <rect x="22" y="0" width="16" height="25" rx="4" fill="#fff" opacity="0.95"/>
  <rect x="18" y="-3" width="24" height="8" rx="4" fill="#3b82f6" opacity="0.95"/>
  <rect x="20" y="2" width="20" height="4" rx="2" fill="#e0f7fa" opacity="0.8"/>
  
  <!-- Ventanas de la cabina -->
  <rect x="24" y="5" width="4" height="6" rx="1" fill="#1e293b" opacity="0.8"/>
  <rect x="32" y="5" width="4" height="6" rx="1" fill="#1e293b" opacity="0.8"/>
  <rect x="24" y="15" width="4" height="6" rx="1" fill="#1e293b" opacity="0.8"/>
  <rect x="32" y="15" width="4" height="6" rx="1" fill="#1e293b" opacity="0.8"/>
  
  <!-- Antena principal mej
   
   orada -->
  <rect x="28" y="-15" width="4" height="18" rx="2" fill="#475569"/>
  <circle cx="30" cy="-15" r="4" fill="#fbbf24" stroke="#475569" stroke-width="1.5"/>
  <circle cx="30" cy="-15" r="2" fill="#f59e0b" opacity="0.8"/>
  
  <!-- Antenas secundarias -->
    <rect x="25" y="-8" width="2" height="10" rx="1" fill="#64748b"/>
  <rect x="33" y="-8" width="2" height="10" rx="1" fill="#64748b"/>
<div style="display: flex; gap: 18px; justify-content: center; margin: 24px 0 0 0; background: rgba(10, 15, 28, 0.8); border-radius: 16px; padding: 24px; border: none; box-shadow: 0 4px 20px rgba(0,0,0,0.3); backdrop-filter: blur(10px);">
   <button class="tab-button active" onclick="mostrarPestana('formulario', event)">
    <i class="fas fa-edit"></i> Formulario de Enlaces
  </button>
   <button class="tab-button" onclick="mostrarPestana('enlaces', event)">
    <i class="fas fa-list"></i> Mis Enlaces (<span id="contador-enlaces">0</span>)
  </button>
  <button class="tab-button" onclick="mostrarPestana('mismoTransporte', event)">
    <i class="fas fa-exchange-alt"></i> Mismo Transporte
  </button>
  <button class="tab-button" onclick="mostrarPestana('resumen', event)">
    <i class="fas fa-chart-pie"></i> Resumen
  </button>
  <button id="toggleMismoTransporte" class="btn btn-outline-info" type="button" onclick="togglePermitirMismoTransporte()">
  <span style="margin-right: 12px;"><i class="fas fa-exchange-alt"></i></span>
  Permitir mismo tipo de transporte
  <span class="toggle-icon">
    <i class="fas fa-toggle-off"></i>
  </span>
</button>
  <button class="btn btn-info" style="margin-left:18px;" onclick="window.location.href='ptmpFangio.html'">
  <i class="fas fa-project-diagram"></i> Estudio Multipunto (PtMP)
</button>

  </div>
    
    <!-- Panel de datos t√©cnicos avanzados (oculto por defecto) -->
  <div id="panel-datos-tecnicos-avanzados" style="position: absolute; top: 70px; left: 50%; transform: translateX(-50%); background: rgba(10, 15, 28, 0.98); border-radius: 16px; border: 2px solid rgba(59, 130, 246, 0.4); backdrop-filter: blur(20px); padding: 25px; display: none; z-index: 999; box-shadow: 0 8px 32px rgba(0,0,0,0.6); max-width: 90%; width: 1200px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h3 style="color: #3b82f6; margin: 0; font-size: 18px;">
        <i class="fas fa-microchip" style="margin-right: 10px;"></i>
        An√°lisis T√©cnico Completo - Enlace de Microondas
      </h3>
      <button onclick="toggleDatosTecnicosAvanzados()" style="background: none; border: none; color: #cbd5e1; font-size: 20px; cursor: pointer;">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <!-- Grid de paneles t√©cnicos -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
      
      <!-- Panel de par√°metros del enlace -->
      <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 12px; padding: 15px;">
        <h4 style="color: #3b82f6; margin: 0 0 10px 0; font-size: 14px; font-weight: 700;">
          <i class="fas fa-link" style="margin-right: 8px;"></i>PAR√ÅMETROS DEL ENLACE
        </h4>
        <div style="color: #f8fafc; font-size: 12px; line-height: 1.6;">
          <div><strong>Distancia Total:</strong> <span id="distancia-total-tecnico">-</span> km</div>
          <div><strong>Frecuencia:</strong> <span id="frecuencia-tecnico">-</span> GHz</div>
          <div><strong>Longitud de Onda:</strong> <span id="longitud-onda-tecnico">-</span> mm</div>
          <div><strong>Factor K:</strong> <span id="factor-k-tecnico">-</span></div>
          <div><strong>Altura Torre A:</strong> <span id="altura-torre-a-tecnico">-</span> m</div>
          <div><strong>Altura Torre B:</strong> <span id="altura-torre-b-tecnico">-</span> m</div>
        </div>
      </div>
      
      <!-- Panel de c√°lculos de propagaci√≥n -->
      <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 12px; padding: 15px;">
        <h4 style="color: #10b981; margin: 0 0 10px 0; font-size: 14px; font-weight: 700;">
          <i class="fas fa-broadcast-tower" style="margin-right: 8px;"></i>C√ÅLCULOS DE PROPAGACI√ìN
        </h4>
        <div style="color: #f8fafc; font-size: 12px; line-height: 1.6;">
          <div><strong>P√©rdida en Espacio Libre:</strong> <span id="perdida-espacio-libre">-</span> dB</div>
          <div><strong>EIRP:</strong> <span id="eirp-tecnico">-</span> dBm</div>
          <div><strong>Nivel de Se√±al:</strong> <span id="nivel-se√±al-tecnico">-</span> dBm</div>
          <div><strong>Margen del Enlace:</strong> <span id="margen-enlace-tecnico">-</span> dB</div>
          <div><strong>SNR:</strong> <span id="snr-tecnico">-</span> dB</div>
        </div>
      </div>
      
      <!-- Panel de zonas de Fresnel -->
      <div style="background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 12px; padding: 15px;">
        <h4 style="color: #f59e0b; margin: 0 0 10px 0; font-size: 14px; font-weight: 700;">
          <i class="fas fa-circle" style="margin-right: 8px;"></i>ZONAS DE FRESNEL
        </h4>
        <div style="color: #f8fafc; font-size: 12px; line-height: 1.6;">
          <div><strong>Radio 100% Fresnel:</strong> <span id="radio-fresnel-100">-</span> m</div>
          <div><strong>Radio 60% Fresnel:</strong> <span id="radio-fresnel-60">-</span> m</div>
          <div><strong>Radio 20% Fresnel:</strong> <span id="radio-fresnel-20">-</span> m</div>
          <div><strong>Clearance M√≠nimo:</strong> <span id="clearance-minimo">-</span> m</div>
          <div><strong>Punto Cr√≠tico:</strong> <span id="punto-critico-tecnico">-</span></div>
        </div>
      </div>
      
      <!-- Panel de atenuaciones atmosf√©ricas -->
      <div style="background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 12px; padding: 15px;">
        <h4 style="color: #8b5cf6; margin: 0 0 10px 0; font-size: 14px; font-weight: 700;">
          <i class="fas fa-cloud-rain" style="margin-right: 8px;"></i>ATENUACIONES ATMOSF√âRICAS
        </h4>
        <div style="color: #f8fafc; font-size: 12px; line-height: 1.6;">
          <div><strong>Atenuaci√≥n por Lluvia:</strong> <span id="atenuacion-lluvia">-</span> dB</div>
          <div><strong>Atenuaci√≥n por Ox√≠geno:</strong> <span id="atenuacion-oxigeno">-</span> dB</div>
          <div><strong>Atenuaci√≥n por Vapor:</strong> <span id="atenuacion-vapor">-</span> dB</div>
          <div><strong>Atenuaci√≥n Total:</strong> <span id="atenuacion-total-tecnico">-</span> dB</div>
          <div><strong>Disponibilidad Anual:</strong> <span id="disponibilidad-anual">-</span>%</div>
        </div>
      </div>
      
      <!-- Panel de an√°lisis de factibilidad -->
      <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 12px; padding: 15px;">
        <h4 style="color: #ef4444; margin: 0 0 10px 0; font-size: 14px; font-weight: 700;">
          <i class="fas fa-check-circle" style="margin-right: 8px;"></i>AN√ÅLISIS DE FACTIBILIDAD
        </h4>
        <div style="color: #f8fafc; font-size: 12px; line-height: 1.6;">
          <div><strong>Estado del Enlace:</strong> <span id="estado-enlace">-</span></div>
          <div><strong>Obstrucciones:</strong> <span id="obstrucciones-tecnico">-</span></div>
          <div><strong>Margen de Desvanecimiento:</strong> <span id="margen-desvanecimiento">-</span> dB</div>
          <div><strong>Ruido T√©rmico:</strong> <span id="ruido-termico">-</span> dBm</div>
          <div><strong>Calidad del Enlace:</strong> <span id="calidad-enlace">-</span></div>
        </div>
      </div>
      
      <!-- Panel de equipos y configuraci√≥n -->
      <div style="background: rgba(6, 182, 212, 0.1); border: 1px solid rgba(6, 182, 212, 0.3); border-radius: 12px; padding: 15px;">
        <h4 style="color: #06b6d4; margin: 0 0 10px 0; font-size: 14px; font-weight: 700;">
          <i class="fas fa-satellite-dish" style="margin-right: 8px;"></i>EQUIPOS Y CONFIGURACI√ìN
        </h4>
        <div style="color: #f8fafc; font-size: 12px; line-height: 1.6;">
          <div><strong>Potencia de Transmisi√≥n:</strong> <span id="potencia-transmision">-</span> dBm</div>
          <div><strong>Ganancia de Antena:</strong> <span id="ganancia-antena">-</span> dBi</div>
          <div><strong>P√©rdidas en Cable:</strong> <span id="perdidas-cable">-</span> dB</div>
          <div><strong>Sensibilidad del Receptor:</strong> <span id="sensibilidad-receptor">-</span> dBm</div>
          <div><strong>Ancho de Banda:</strong> <span id="ancho-banda-tecnico">-</span> MHz</div>
        </div>
      </div>
      
    </div>
  </div>
</div>
    <div class="main-content">
      <div class="tabs-container">
        <div class="tabs">
</div>
      </div>
      <div id="tab-formulario" class="tab-content active">
        <div class="frecuencia-info">
          <strong><i class="fas fa-info-circle"></i> Reglas de Frecuencia:</strong><br>
          ‚Ä¢ De 0-5 km se usa una frecuencia de 80 GHz<br>
          ‚Ä¢ De 5-15 km se usa una frecuencia 15 GHz<br>
          ‚Ä¢ De 15 +1 km se usa una frecuencia de 8 GHz
        </div>
        <div class="file-upload-row">
  <div class="file-upload">
    <label for="inputFile">
      <i class="fas fa-upload"></i> Cargar archivo Excel
    </label>
    <input type="file" id="inputFile" accept=".xlsx" />
    <div id="archivo-cargado" style="display: none;">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <h4 style="color: #28a745; margin-bottom: 5px;">
            <i class="fas fa-file-excel"></i> Archivo Cargado
          </h4>
          <p id="nombre-archivo" style="font-weight: bold; margin-bottom: 3px;"></p>
          <small id="info-archivo" style="color: #666;"></small>
        </div>
        <button id="borrar-archivo" type="button" class="btn btn-danger btn-sm">
          <i class="fas fa-trash"></i> Eliminar
        </button>
      </div>
    </div>
    <div class="loading" id="loading" style="display:none;">
      <div class="spinner" style="border-top:4px solid #764ba2; border-right:4px solid #667eea; border-bottom:4px solid #10b981; border-left:4px solid #fff;"></div>
      <p style="color:#764ba2; font-weight:600;">Cargando archivo...</p>
    </div>
  </div>
  <div class="file-upload">
    <label for="inputFilePairs">
      <i class="fas fa-upload"></i> Cargar Excel de Pares
    </label>
    <input type="file" id="inputFilePairs" accept=".xlsx" />
    <div id="archivo-pares-cargado" style="display: none;">
  <div style="display: flex; justify-content: space-between; align-items: center;">
    <div>
      <h4 style="color: #28a745; margin-bottom: 5px;">
        <i class="fas fa-file-excel"></i> Archivo de Pares Cargado
      </h4>
      <p id="nombre-archivo-pares" style="font-weight: bold; margin-bottom: 3px;"></p>
      <small id="info-archivo-pares" style="color: #666;"></small>
    </div>
    <div style="display: flex; gap: 12px;">
      <button class="btn btn-primary" onclick="procesarPares()">
        <i class="fas fa-play"></i> Procesar Pares
      </button>
      <button id="borrar-archivo-pares" type="button" class="btn btn-danger btn-sm">
        <i class="fas fa-trash"></i> Eliminar
      </button>
    </div>
  </div>
</div>
  </div>
</div>
        <div class="form-grid">
          <div><label for="idA"><i class="fas fa-id-card"></i> ID A</label><input type="text" id="idA" /></div>
          <div><label for="idB"><i class="fas fa-id-card"></i> ID B</label><input type="text" id="idB" /></div>
          <div><label for="nombreA"><i class="fas fa-building"></i> Nombre Sitio A</label><input type="text" id="nombreA" /></div>
          <div><label for="nombreB"><i class="fas fa-building"></i> Nombre Sitio B</label><input type="text" id="nombreB" /></div>
          <div><label for="latA"><i class="fas fa-map-marker-alt"></i> Latitud A</label><input type="text" id="latA" /></div>
          <div><label for="lonA"><i class="fas fa-map-marker-alt"></i> Longitud A</label><input type="text" id="lonA" /></div>
          <div><label for="latB"><i class="fas fa-map-marker-alt"></i> Latitud B</label><input type="text" id="latB" /></div>
          <div><label for="lonB"><i class="fas fa-map-marker-alt"></i> Longitud B</label><input type="text" id="lonB" /></div>
          <div><label for="latArad"><i class="fas fa-calculator"></i> Latitud A (rad)</label><input type="text" id="latArad" readonly /></div>
          <div><label for="lonArad"><i class="fas fa-calculator"></i> Longitud A (rad)</label><input type="text" id="lonArad" readonly /></div>
          <div><label for="latBrad"><i class="fas fa-calculator"></i> Latitud B (rad)</label><input type="text" id="latBrad" readonly /></div>
          <div><label for="lonBrad"><i class="fas fa-calculator"></i> Longitud B (rad)</label><input type="text" id="lonBrad" readonly /></div>
          <div><label for="distancia"><i class="fas fa-ruler"></i> Distancia (km)</label><input type="text" id="distancia" readonly /></div>
          <div><label for="frecuencia"><i class="fas fa-signal"></i> Frecuencia (GHz)</label><input type="text" id="frecuencia" readonly style="background-color: #ffffcc;" /></div>
          <div><label for="alturaA"><i class="fas fa-arrows-alt-v"></i> Altura Torre A</label><input type="text" id="alturaA" /></div>
          <div><label for="alturaB"><i class="fas fa-arrows-alt-v"></i> Altura Torre B</label><input type="text" id="alturaB" /></div>
          <div><label for="ranA"><i class="fas fa-wifi"></i> Altura RAN A</label><input type="text" id="ranA" /></div>
          <div><label for="ranB"><i class="fas fa-wifi"></i> Altura RAN B</label><input type="text" id="ranB" /></div>
          <div><label for="TransA"><i class="fas fa-truck"></i> Tipo de transporte sitio A</label><input type="text" id="TransA" /></div>
          <div><label for="TransB"><i class="fas fa-truck"></i> Tipo de transporte sitio B</label><input type="text" id="TransB" /></div>
          <div><label for="ArreA"><i class="fas fa-handshake"></i> Tipo de Arrendamiento A</label><input type="text" id="ArreA" /></div>
          <div><label for="ArreB"><i class="fas fa-handshake"></i> Tipo de Arrendamiento B</label><input type="text" id="ArreB" /></div>
          <div><label for="OnA"><i class="fas fa-power-off"></i> On Air A</label><input type="text" id="OnA" /></div>
          <div><label for="OnB"><i class="fas fa-power-off"></i> On Air B</label><input type="text" id="OnB" /></div>
          <div><label for="TorreA"><i class="fas fa-broadcast-tower"></i> Tipo de Torre A</label><input type="text" id="TorreA" /></div>
          <div><label for="TorreB"><i class="fas fa-broadcast-tower"></i> Tipo de Torre B</label><input type="text" id="TorreB" /></div>
          <div><label for="TorreA"><i class="fas fa-broadcast-tower"></i> Estado A</label><input type="text" id="EstadoA" /></div>
          <div><label for="TorreA"><i class="fas fa-broadcast-tower"></i> Estado B</label><input type="text" id="EstadoB" /></div>
          <div><label for="bulboCurvatura"><i class="fas fa-globe"></i> Bulbo Curvatura Terrestre (m)</label><input type="text" id="bulboCurvatura" readonly /></div>
          <div><label for="radioFresnel"><i class="fas fa-circle"></i> Radio m√°x. zona de Fresnel (m)</label><input type="text" id="radioFresnel" readonly /></div>
          <div><label for="alturaLibre"><i class="fas fa-arrows-alt-v"></i> Altura libre necesaria (m)</label><input type="text" id="alturaLibre" readonly /></div>
          <div><label for="alturaDisponible"><i class="fas fa-arrows-alt-v"></i> Altura real disponible (m)</label><input type="text" id="alturaDisponible" readonly /></div>
          <div><label for="factibilidadCurvatura"><i class="fas fa-check-circle"></i> Factibilidad Curvatura/Fresnel</label><input type="text" id="factibilidadCurvatura" readonly /></div>
          <div>
          <label for="disponibilidadAnual"><i class="fas fa-percentage"></i> Disponibilidad Anual (%)</label>
            <input type="text" id="disponibilidadAnual" readonly />
           </div>
        </div>
        <div class="action-buttons">
          <button id="agregarBtn" class="btn btn-success" onclick="agregarOActualizarEnlace()">
            <i class="fas fa-check"></i> Agregar Enlace
          </button>
          <button class="btn btn-secondary" onclick="limpiarFormulario()">
            <i class="fas fa-eraser"></i> Limpiar
          </button>
          
        </div>
          </button>
          <button class="btn btn-primary" onclick="mostrarPestana('enlaces')">
            <i class="fas fa-list"></i> Ver Mis Enlaces
          </button>
          <button class="btn btn-warning" onclick="exportarFactiblesParaPathloss()">
            <i class="fas fa-file-export"></i> Exportar Factibles para Pathloss
          </button>
        </div>

      </div>
      <div id="tab-seleccion" class="tab-content">
  <div class="enlaces-counter">
    <i class="fas fa-check-square"></i> Enlaces Seleccionados: <span id="enlaces-seleccionados">0</span>
  </div>
  <div class="action-buttons">
    <button class="btn btn-primary" onclick="seleccionarTodo()">
      <i class="fas fa-check-double"></i> Seleccionar Todo
    </button>
    <button class="btn btn-secondary" onclick="deseleccionarTodo()">
      <i class="fas fa-times"></i> Deseleccionar Todo
    </button>
    <button id="eliminarSeleccionadosBtn" class="btn btn-danger" onclick="eliminarSeleccionados()" disabled>
      <i class="fas fa-trash-alt"></i> Eliminar Seleccionados
    </button>

  </div>

  <div class="table-container seleccion-container">
  </div>
</div>
      <div id="tab-enlaces" class="tab-content">
                <div class="enlaces-counter" style="margin-bottom: 3px; margin-top: -50px;">
          
          
        </div>
        <div style="display: flex; gap: 8px; justify-content: center; margin-bottom: 5px;">
          <button class="btn btn-primary" onclick="mostrarPestana('formulario')" style="padding: 10px 15px; font-size: 13px;">
            <i class="fas fa-plus"></i> Agregar Nuevo Enlace
          </button>
          <button class="btn btn-success" onclick="exportarExcel()" style="padding: 10px 15px; font-size: 13px;">
            <i class="fas fa-file-excel"></i> Exportar a Excel
          </button>
          <button class="btn btn-secondary" onclick="seleccionarTodosEnlaces()" style="padding: 10px 15px; font-size: 13px;">
            <i class="fas fa-check-double"></i> Seleccionar Todos
          </button>
          <button class="btn btn-danger" onclick="eliminarEnlacesSeleccionados()" id="btnEliminarSeleccionados" disabled style="padding: 10px 15px; font-size: 13px;">
            <i class="fas fa-trash"></i> Eliminar Seleccionados
          </button>
        </div>
        <button id="btnPerfilElevacionGlobal" class="btn btn-info" style="display:none; margin-left:8px;">
        <i class="fas fa-mountain"></i> Perfil Elevaci√≥n
        </button>
        <!-- Barra de herramientas avanzada para la tabla -->
        <div class="table-toolbar" style="background: rgba(15, 23, 42, 0.95); border-radius: 12px; padding: 10px; margin-bottom: 2px; border: none; backdrop-filter: blur(10px); position: relative; z-index: 10;">
          <div style="display: flex; flex-wrap: wrap; gap: 15px; align-items: center; justify-content: space-between;">
            
            <!-- B√∫squeda y filtros -->
            <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
              <div class="search-container" style="position: relative;">
                <i class="fas fa-search" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #64748b; z-index: 2;"></i>
                <input type="text" id="searchTable" placeholder="üîç Buscar por ID, nombre o ubicaci√≥n..." style="padding: 12px 15px 12px 45px; border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 10px; background: rgba(30, 41, 59, 0.8); color: white; width: 300px; font-size: 14px; transition: all 0.3s ease;">
              </div>
              
              <div style="display: flex; gap: 8px; align-items: center;">
                <select id="filterEstado" style="padding: 12px 15px; border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 10px; background: rgba(30, 41, 59, 0.8); color: white; font-size: 14px; cursor: pointer; transition: all 0.3s ease;">
                  <option value="">üìä Todos los estados</option>
                  <option value="factible">‚úÖ Solo Factibles</option>
                  <option value="no-factible">‚ùå Solo No Factibles</option>
                </select>
                
                <select id="filterDistancia" style="padding: 12px 15px; border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 10px; background: rgba(30, 41, 59, 0.8); color: white; font-size: 14px; cursor: pointer; transition: all 0.3s ease;">
                  <option value="">üìè Todas las distancias</option>
                  <option value="0-5">üö∂‚Äç‚ôÇÔ∏è Cercanos (0-5 km)</option>
                  <option value="5-15">üèÉ‚Äç‚ôÇÔ∏è Medianos (5-15 km)</option>
                  <option value="15+">‚úàÔ∏è Lejanos (15+ km)</option>
                </select>
                
                <button id="btnLimpiarFiltros" class="btn btn-outline-secondary" style="padding: 12px 15px; font-size: 14px; border-radius: 10px; transition: all 0.3s ease;" onclick="clearFilters()">
                  <i class="fas fa-broom"></i> Limpiar Filtros
                </button>
              </div>
            </div>
            
            <!-- Acciones y estad√≠sticas -->
            <div style="display: flex; gap: 12px; align-items: center;">
              <div class="stats-badge" style="background: rgba(59, 130, 246, 0.2); padding: 10px 15px; border-radius: 8px; font-size: 13px; color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.3); transition: all 0.3s ease;">
                <i class="fas fa-list"></i> <span id="totalEnlacesStats">0</span> enlaces
              </div>
              <div class="stats-badge" style="background: rgba(16, 185, 129, 0.2); padding: 10px 15px; border-radius: 8px; font-size: 13px; color: #10b981; border: 1px solid rgba(16, 185, 129, 0.3); transition: all 0.3s ease;">
                <i class="fas fa-check"></i> <span id="factiblesStats">0</span> factibles
              </div>
              
              <button id="btnToggleView" class="btn btn-outline-info" style="padding: 12px 15px; font-size: 14px; border-radius: 10px; transition: all 0.3s ease;">
                <i class="fas fa-compress"></i> Vista Compacta
              </button>
              
              <button id="btnExportarSeleccionados" class="btn btn-success" style="padding: 12px 15px; font-size: 14px; border-radius: 10px; transition: all 0.3s ease;" onclick="exportSelected()">
                <i class="fas fa-download"></i> Exportar Seleccionados
              </button>
              
              <button id="btnAccionesRapidas" class="btn btn-warning" style="padding: 12px 15px; font-size: 14px; border-radius: 10px; transition: all 0.3s ease;">
                <i class="fas fa-bolt"></i> Acciones R√°pidas
              </button>
              

              

            </div>
          </div>
          
          <!-- Paginaci√≥n mejorada -->
          <div class="pagination-container" style="display: flex; justify-content: center; align-items: center; gap: 15px; margin-top: 2px; padding: 10px; background: rgba(30, 41, 59, 0.5); border-radius: 10px;">
            <button id="btnPrevPage" class="btn btn-outline-secondary" style="padding: 10px 15px; font-size: 13px; border-radius: 8px; transition: all 0.3s ease;">
              <i class="fas fa-chevron-left"></i> Anterior
            </button>
            <span id="pageInfo" style="color: #cbd5e1; font-size: 14px; font-weight: 600; padding: 8px 15px; background: rgba(59, 130, 246, 0.1); border-radius: 6px; border: 1px solid rgba(59, 130, 246, 0.2);">P√°gina 1 de 1</span>
            <button id="btnNextPage" class="btn btn-outline-secondary" style="padding: 10px 15px; font-size: 13px; border-radius: 8px; transition: all 0.3s ease;">
              Siguiente <i class="fas fa-chevron-right"></i>
            </button>
            <select id="pageSize" style="padding: 8px 12px; border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 6px; background: rgba(30, 41, 59, 0.8); color: white; font-size: 13px; cursor: pointer;">
              <option value="10">üìÑ 10 por p√°gina</option>
              <option value="25" selected>üìÑ 25 por p√°gina</option>
              <option value="50">üìÑ 50 por p√°gina</option>
              <option value="100">üìÑ 100 por p√°gina</option>
            </select>
          </div>
        </div>

        <div class="table-container" style="overflow: hidden; position: relative;">
<table id="tabla" style="width: 100%; border-collapse: collapse; background: rgba(15, 23, 42, 0.95); border-radius: 12px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.3); border: none;">
  <thead>
  <tr style="background: rgba(15, 23, 42, 0.95);">
    <th style="padding: 15px 8px; text-align: center; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
      <input type="checkbox" id="checkTodos" onclick="toggleSeleccionarTodos(this)" style="transform: scale(1.2);">
    </th>
    <th class="sortable" data-sort="idA" style="padding: 15px 8px; text-align: center; border-bottom: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer; transition: background 0.3s ease;">
      <i class="fas fa-map-marker-alt"></i><br>ID A
      <i class="fas fa-sort sort-icon" style="margin-left: 5px; opacity: 0.5;"></i>
    </th>
    <th class="sortable" data-sort="nombreA" style="padding: 15px 8px; text-align: center; border-bottom: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer; transition: background 0.3s ease;">
      <i class="fas fa-building"></i><br>Nombre A
      <i class="fas fa-sort sort-icon" style="margin-left: 5px; opacity: 0.5;"></i>
    </th>
    <th class="sortable" data-sort="latA" style="padding: 15px 8px; text-align: center; border-bottom: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer; transition: background 0.3s ease;">
      <i class="fas fa-compass"></i><br>Lat A
      <i class="fas fa-sort sort-icon" style="margin-left: 5px; opacity: 0.5;"></i>
    </th>
    <th class="sortable" data-sort="lonA" style="padding: 15px 8px; text-align: center; border-bottom: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer; transition: background 0.3s ease;">
      <i class="fas fa-globe"></i><br>Lon A
      <i class="fas fa-sort sort-icon" style="margin-left: 5px; opacity: 0.5;"></i>
    </th>
    <th class="sortable" data-sort="latArad" style="padding: 15px 8px; text-align: center; border-bottom: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer; transition: background 0.3s ease;">
      <i class="fas fa-compass"></i><br>Lat A (rad)
      <i class="fas fa-sort sort-icon" style="margin-left: 5px; opacity: 0.5;"></i>
    </th>
    <th class="sortable" data-sort="lonArad" style="padding: 15px 8px; text-align: center; border-bottom: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer; transition: background 0.3s ease;">
      <i class="fas fa-globe"></i><br>Lon A (rad)
      <i class="fas fa-sort sort-icon" style="margin-left: 5px; opacity: 0.5;"></i>
    </th>
    <th class="sortable" data-sort="idB" style="padding: 15px 8px; text-align: center; border-bottom: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer; transition: background 0.3s ease;">
      <i class="fas fa-map-marker-alt"></i><br>ID B
      <i class="fas fa-sort sort-icon" style="margin-left: 5px; opacity: 0.5;"></i>
    </th>
    <th class="sortable" data-sort="nombreB" style="padding: 15px 8px; text-align: center; border-bottom: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer; transition: background 0.3s ease;">
      <i class="fas fa-building"></i><br>Nombre B
      <i class="fas fa-sort sort-icon" style="margin-left: 5px; opacity: 0.5;"></i>
    </th>
    <th class="sortable" data-sort="latB" style="padding: 15px 8px; text-align: center; border-bottom: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer; transition: background 0.3s ease;">
      <i class="fas fa-compass"></i><br>Lat B
      <i class="fas fa-sort sort-icon" style="margin-left: 5px; opacity: 0.5;"></i>
    </th>
    <th class="sortable" data-sort="lonB" style="padding: 15px 8px; text-align: center; border-bottom: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer; transition: background 0.3s ease;">
      <i class="fas fa-globe"></i><br>Lon B
      <i class="fas fa-sort sort-icon" style="margin-left: 5px; opacity: 0.5;"></i>
    </th>
    <th class="sortable" data-sort="latBrad" style="padding: 15px 8px; text-align: center; border-bottom: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer; transition: background 0.3s ease;">
      <i class="fas fa-compass"></i><br>Lat B (rad)
      <i class="fas fa-sort sort-icon" style="margin-left: 5px; opacity: 0.5;"></i>
    </th>
    <th class="sortable" data-sort="lonBrad" style="padding: 15px 8px; text-align: center; border-bottom: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer; transition: background 0.3s ease;">
      <i class="fas fa-globe"></i><br>Lon B (rad)
      <i class="fas fa-sort sort-icon" style="margin-left: 5px; opacity: 0.5;"></i>
    </th>
    <th class="sortable" data-sort="distancia" style="padding: 15px 8px; text-align: center; border-bottom: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer; transition: background 0.3s ease;">
      <i class="fas fa-route"></i><br>Distancia (km)
      <i class="fas fa-sort sort-icon" style="margin-left: 5px; opacity: 0.5;"></i>
    </th>
    <th class="sortable" data-sort="frecuencia" style="padding: 15px 8px; text-align: center; border-bottom: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer; transition: background 0.3s ease;">
      <i class="fas fa-broadcast-tower"></i><br>Frecuencia (GHz)
      <i class="fas fa-sort sort-icon" style="margin-left: 5px; opacity: 0.5;"></i>
    </th>
    <th class="sortable" data-sort="disponibilidad" style="padding: 15px 8px; text-align: center; border-bottom: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer; transition: background 0.3s ease;">
      <i class="fas fa-percentage"></i><br>Disponibilidad
      <i class="fas fa-sort sort-icon" style="margin-left: 5px; opacity: 0.5;"></i>
    </th>
    <th class="sortable" data-sort="alturaA" style="padding: 15px 8px; text-align: center; border-bottom: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer; transition: background 0.3s ease;">
      <i class="fas fa-mountain"></i><br>Altura Torre A
      <i class="fas fa-sort sort-icon" style="margin-left: 5px; opacity: 0.5;"></i>
    </th>
    <th class="sortable" data-sort="alturaB" style="padding: 15px 8px; text-align: center; border-bottom: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer; transition: background 0.3s ease;">
      <i class="fas fa-mountain"></i><br>Altura Torre B
      <i class="fas fa-sort sort-icon" style="margin-left: 5px; opacity: 0.5;"></i>
    </th>
    <th class="sortable" data-sort="ranA" style="padding: 15px 8px; text-align: center; border-bottom: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer; transition: background 0.3s ease;">
      <i class="fas fa-wifi"></i><br>Altura RAN A
      <i class="fas fa-sort sort-icon" style="margin-left: 5px; opacity: 0.5;"></i>
    </th>
    <th class="sortable" data-sort="ranB" style="padding: 15px 8px; text-align: center; border-bottom: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer; transition: background 0.3s ease;">
      <i class="fas fa-wifi"></i><br>Altura RAN B
      <i class="fas fa-sort sort-icon" style="margin-left: 5px; opacity: 0.5;"></i>
    </th>
    <th class="sortable" data-sort="transA" style="padding: 15px 8px; text-align: center; border-bottom: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer; transition: background 0.3s ease;">
      <i class="fas fa-truck"></i><br>Transporte A
      <i class="fas fa-sort sort-icon" style="margin-left: 5px; opacity: 0.5;"></i>
    </th>
    <th class="sortable" data-sort="transB" style="padding: 15px 8px; text-align: center; border-bottom: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer; transition: background 0.3s ease;">
      <i class="fas fa-truck"></i><br>Transporte B
      <i class="fas fa-sort sort-icon" style="margin-left: 5px; opacity: 0.5;"></i>
    </th>
    <th class="sortable" data-sort="arreA" style="padding: 15px 8px; text-align: center; border-bottom: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer; transition: background 0.3s ease;">
      <i class="fas fa-handshake"></i><br>Arrendamiento A
      <i class="fas fa-sort sort-icon" style="margin-left: 5px; opacity: 0.5;"></i>
    </th>
    <th class="sortable" data-sort="arreB" style="padding: 15px 8px; text-align: center; border-bottom: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer; transition: background 0.3s ease;">
      <i class="fas fa-handshake"></i><br>Arrendamiento B
      <i class="fas fa-sort sort-icon" style="margin-left: 5px; opacity: 0.5;"></i>
    </th>
    <th class="sortable" data-sort="onA" style="padding: 15px 8px; text-align: center; border-bottom: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer; transition: background 0.3s ease;">
      <i class="fas fa-power-off"></i><br>On Air A
      <i class="fas fa-sort sort-icon" style="margin-left: 5px; opacity: 0.5;"></i>
    </th>
    <th class="sortable" data-sort="onB" style="padding: 15px 8px; text-align: center; border-bottom: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer; transition: background 0.3s ease;">
      <i class="fas fa-power-off"></i><br>On Air B
      <i class="fas fa-sort sort-icon" style="margin-left: 5px; opacity: 0.5;"></i>
    </th>
    <th class="sortable" data-sort="torreA" style="padding: 15px 8px; text-align: center; border-bottom: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer; transition: background 0.3s ease;">
      <i class="fas fa-tower-broadcast"></i><br>Tipo Torre A
      <i class="fas fa-sort sort-icon" style="margin-left: 5px; opacity: 0.5;"></i>
    </th>
    <th class="sortable" data-sort="torreB" style="padding: 15px 8px; text-align: center; border-bottom: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer; transition: background 0.3s ease;">
      <i class="fas fa-tower-broadcast"></i><br>Tipo Torre B
      <i class="fas fa-sort sort-icon" style="margin-left: 5px; opacity: 0.5;"></i>
    </th>
    <th class="sortable" data-sort="estadoA" style="padding: 15px 8px; text-align: center; border-bottom: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer; transition: background 0.3s ease;">
      <i class="fas fa-info-circle"></i><br>Estado A
      <i class="fas fa-sort sort-icon" style="margin-left: 5px; opacity: 0.5;"></i>
    </th>
    <th class="sortable" data-sort="estadoB" style="padding: 15px 8px; text-align: center; border-bottom: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer; transition: background 0.3s ease;">
      <i class="fas fa-info-circle"></i><br>Estado B
      <i class="fas fa-sort sort-icon" style="margin-left: 5px; opacity: 0.5;"></i>
    </th>
    <th class="sortable" data-sort="factible" style="padding: 15px 8px; text-align: center; border-bottom: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer; transition: background 0.3s ease;">
      <i class="fas fa-check-circle"></i><br>Factible
      <i class="fas fa-sort sort-icon" style="margin-left: 5px; opacity: 0.5;"></i>
    </th>
    <th class="sortable" data-sort="antenas" style="padding: 15px 8px; text-align: center; border-bottom: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer; transition: background 0.3s ease;">
      <i class="fas fa-satellite-dish"></i><br>Antenas
      <i class="fas fa-sort sort-icon" style="margin-left: 5px; opacity: 0.5;"></i>
    </th>
    <th class="sortable" data-sort="tipoEnlace" style="padding: 15px 8px; text-align: center; border-bottom: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer; transition: background 0.3s ease;">
      <i class="fas fa-link"></i><br>Tipo Enlace
      <i class="fas fa-sort sort-icon" style="margin-left: 5px; opacity: 0.5;"></i>
    </th>
    <th class="sortable" data-sort="analisis" style="padding: 15px 8px; text-align: center; border-bottom: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer; transition: background 0.3s ease;">
      <i class="fas fa-info-circle"></i><br>Informaci√≥n
      <i class="fas fa-sort sort-icon" style="margin-left: 5px; opacity: 0.5;"></i>
    </th>
    <th style="padding: 15px 8px; text-align: center; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
      <i class="fas fa-tools"></i><br>Acciones
    </th>
  </tr>
</thead>
  <tbody></tbody>
</table>
        </div>
        <div id="mensaje-sin-enlaces" class="mensaje-sin-enlaces" style="display: none;">
          <i class="fas fa-broadcast-tower"></i>
          <h3>No hay enlaces registrados</h3>
          <p>Usa el formulario para agregar tu primer enlace PtP</p>
        </div>
      </div>
      <div id="tab-mismoTransporte" class="tab-content">
  <div style="margin: 24px 0;">
    <h2>An√°lisis de Enlaces con Mismo Tipo de Transporte Permitido</h2>
    <div class="table-container" id="tabla-mismo-transporte"></div>
  </div>
</div>
     <div id="tab-resumen" class="tab-content">
  <div class="table-container" style="max-width:600px;margin:auto;">
    <div class="resumen-enlaces" style="display: flex; flex-wrap:wrap; gap: 24px; align-items: center; margin-bottom: 18px; justify-content:center;">
      <div>
        <strong>Total de Enlaces:</strong> <span id="resumen-total-enlaces">0</span>
      </div>
      <div>
        <strong>Factibles:</strong> <span id="resumen-enlaces-factibles" style="color:#10b981;">0</span>
      </div>
      <button class="btn btn-success" onclick="exportarFactiblesParaPathloss()">
        <i class="fas fa-file-export"></i> Exportar Factibles
      </button>
        <button class="btn btn-danger" id="btnDescargarFaltantes" style="margin-left:8px; display:none;">
  <i class="fas fa-download"></i> Descargar Pares Faltantes
</button>
      <button class="btn btn-primary" onclick="exportarExcel()">
        <i class="fas fa-file-excel"></i> Exportar Todos
      </button>
      <button class="btn btn-info" onclick="mostrarGraficoResumen()">
        <i class="fas fa-chart-bar"></i> Ver Gr√°fico Resumen
      </button>
    </div>
    <div style="margin-top:30px; text-align:center; color:#888;">
                    <i class="fas fa-info-circle"></i> Aqu√≠ puedes ver el resumen y exportar tus enlaces.
              
              <!-- Bot√≥n de prueba para doble clic -->
              <div style="margin-top: 15px; text-align: center;">
                              <button onclick="probarDobleClicMejorado()" class="btn btn-warning" style="margin: 5px;">
                <i class="fas fa-mouse"></i> Probar Doble Clic
              </button>
              <button onclick="probarNuevoSistema()" class="btn btn-info" style="margin: 5px;">
                <i class="fas fa-chart-line"></i> Probar Perfil
              </button>
              <button onclick="togglePantallaCompleta()" class="btn btn-success" style="margin: 5px;">
                <i class="fas fa-expand"></i> Pantalla Completa
              </button>

              </div>
    </div>
  </div>
  <div id="mapa-enlaces" style="width:100vw;height:100vh;max-width:100%;margin:0;border-radius:0;box-shadow:none;border:none;overflow:hidden;position:fixed;top:0;left:0;background:linear-gradient(135deg, rgba(59,130,246,0.05), rgba(16,185,129,0.05));backdrop-filter:blur(10px);transition:all 0.3s ease;z-index:1000;">
  

  </div>
</div>
<div id="panel-detalle-enlace">
  <button onclick="document.getElementById('panel-detalle-enlace').style.display='none'" style="position:absolute; top:12px; right:16px; background:none; border:none; font-size:1.5rem; color:#888; cursor:pointer;"><i class="fas fa-times"></i></button>
  <div id="detalle-enlace-contenido"></div>
</div>
<div id="segmentacion-estados" style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin:24px 0 0 0;">
</div>
    </div>
  </div>
<script>
  let dataExcel = [];
  let filaEditando = null;
  let dataPares = [];
function guardarArchivoExcelEnIndexedDB(nombre, arrayBuffer, info) {
  const request = indexedDB.open('ArchivosExcelDB', 2); 
  request.onupgradeneeded = function(event) {
    const db = event.target.result;
    if (!db.objectStoreNames.contains('archivos')) {
      db.createObjectStore('archivos', { keyPath: 'nombre' });
    }
  };
  request.onsuccess = function(event) {
    const db = event.target.result;
    const tx = db.transaction('archivos', 'readwrite');
    const store = tx.objectStore('archivos');
    store.put({ nombre, arrayBuffer, info });
    tx.oncomplete = () => db.close();
  };
}
function cargarArchivoExcelDeIndexedDB(nombre, callback) {
  const request = indexedDB.open('ArchivosExcelDB', 2);
  request.onsuccess = function(event) {
    const db = event.target.result;
    const tx = db.transaction('archivos', 'readonly');
    const store = tx.objectStore('archivos');
    const getReq = store.get(nombre);
    getReq.onsuccess = function() {
      callback(getReq.result ? getReq.result.arrayBuffer : null, getReq.result ? getReq.result.info : null);
      db.close();
    };
  };
}
function cargarArchivoDeStorage() {
  const archivoInfo = localStorage.getItem('archivoExcelInfo');
  if (archivoInfo) {
    try {
      const info = JSON.parse(archivoInfo);
      cargarArchivoExcelDeIndexedDB(info.nombre, function(arrayBuffer, infoGuardada) {
        if (arrayBuffer) {
          const data = new Uint8Array(arrayBuffer);
          const workbook = XLSX.read(data, { type: 'array' });
          const sheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[sheetName];
          dataExcel = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
          mostrarArchivoCargado(infoGuardada || info);
        }
      });
    } catch (error) {
      console.error('Error al cargar archivo desde storage:', error);
    }
  }
}
function guardarArchivoParesEnIndexedDB(nombre, arrayBuffer, info) {
  const request = indexedDB.open('ArchivosExcelDB', 3); // Incrementar versi√≥n
  request.onupgradeneeded = function(event) {
    const db = event.target.result;
    // Crear store de archivos si no existe
    if (!db.objectStoreNames.contains('archivos')) {
      db.createObjectStore('archivos', { keyPath: 'nombre' });
    }
    // Crear store de pares si no existe
    if (!db.objectStoreNames.contains('pares')) {
      db.createObjectStore('pares', { keyPath: 'nombre' });
    }
  };
  request.onsuccess = function(event) {
    const db = event.target.result;
    try {
      const tx = db.transaction('pares', 'readwrite');
      const store = tx.objectStore('pares');
      store.put({ nombre, arrayBuffer, info });
      tx.oncomplete = () => db.close();
      console.log('‚úÖ Archivo de pares guardado en IndexedDB');
    } catch (error) {
      console.error('‚ùå Error al guardar archivo de pares:', error);
      db.close();
    }
  };
  request.onerror = function(event) {
    console.error('‚ùå Error al abrir IndexedDB:', event.target.error);
  };
}
function cargarArchivoParesDeIndexedDB(nombre, callback) {
  const request = indexedDB.open('ArchivosExcelDB', 3); // Incrementar versi√≥n
  request.onsuccess = function(event) {
    const db = event.target.result;
    try {
      const tx = db.transaction('pares', 'readonly');
      const store = tx.objectStore('pares');
      const getReq = store.get(nombre);
      getReq.onsuccess = function() {
        callback(getReq.result ? getReq.result.arrayBuffer : null, getReq.result ? getReq.result.info : null);
        db.close();
      };
      getReq.onerror = function() {
        console.error('‚ùå Error al obtener archivo de pares:', getReq.error);
        callback(null, null);
        db.close();
      };
    } catch (error) {
      console.error('‚ùå Error al acceder a IndexedDB:', error);
      callback(null, null);
      db.close();
    }
  };
  request.onerror = function(event) {
    console.error('‚ùå Error al abrir IndexedDB:', event.target.error);
    callback(null, null);
  };
}
function cargarArchivoParesDeStorage() {
  const archivoInfo = localStorage.getItem('archivoParesInfo');
  if (archivoInfo) {
    try {
      const info = JSON.parse(archivoInfo);
      cargarArchivoParesDeIndexedDB(info.nombre, function(arrayBuffer, infoGuardada) {
        if (arrayBuffer) {
          const data = new Uint8Array(arrayBuffer);
          const workbook = XLSX.read(data, { type: 'array' });
          const sheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[sheetName];
          dataPares = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
          const contenedor = document.getElementById('archivo-pares-cargado');
          const nombreArchivo = document.getElementById('nombre-archivo-pares');
          const infoArchivo = document.getElementById('info-archivo-pares');
          if (contenedor && nombreArchivo && infoArchivo) {
            nombreArchivo.textContent = infoGuardada.nombre;
            infoArchivo.textContent = `${infoGuardada.filas} filas ‚Ä¢ ${(infoGuardada.tama√±o / 1024).toFixed(1)} KB ‚Ä¢ Cargado: ${new Date(infoGuardada.fechaCarga).toLocaleString()}`;
            contenedor.style.display = 'block';
            document.getElementById('inputFilePairs').style.display = 'none';
          }
        }
      });
    } catch (error) {
      console.error('Error al cargar archivo de pares desde storage:', error);
    }
  }
} 
function guardarEnlacesEnStorage() {
  const tabla = document.querySelector('#tabla tbody');
const filas = tabla.querySelectorAll('tr');
const enlaces = [];
filas.forEach(fila => {
  const celdas = fila.querySelectorAll('td');
  const enlace = [];
for (let i = 1; i < celdas.length; i++) {
  if (i === 33 && celdas[i].querySelector('button') && celdas[i].dataset.analisis) {
    enlace.push(celdas[i].dataset.analisis);
  } else {
    enlace.push(celdas[i].textContent);
  }
}
  enlaces.push(enlace);
});
localStorage.setItem('enlacesPtP', JSON.stringify(enlaces));
  // console.log('Enlaces guardados:', enlaces.length); // DESHABILITADO - Causaba spam en console
}
function cargarEnlacesDeStorage() {
  // PROTECCI√ìN CONTRA EJECUCI√ìN M√öLTIPLE
  if (window.enlacesCargados) {
    return;
  }
  window.enlacesCargados = true;
  
  const enlacesGuardados = localStorage.getItem('enlacesPtP');
  if (!enlacesGuardados) return;
  
  try {
    const enlaces = JSON.parse(enlacesGuardados);
    const tbody = document.querySelector('#tabla tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';

    enlaces.forEach(enlaceData => {
      const fila = document.createElement('tr');
      const tdCheck = document.createElement('td');
      const check = document.createElement('input');
      check.type = 'checkbox';
      check.className = 'check-enlace';
      check.onclick = function(e) {
        e.stopPropagation();
        if (typeof actualizarBotonEliminarSeleccionados === 'function') {
          actualizarBotonEliminarSeleccionados();
        }
      };
      tdCheck.appendChild(check);
      fila.appendChild(tdCheck);

      enlaceData.forEach((val, i) => {
        const td = document.createElement('td');
        // Para la columna de estado (√≠ndice 27) crear badge
        if (i === 27) {
          const esFactible = val === 'S√ç' || val.includes('FACTIBLE');
          const badge = document.createElement('span');
          badge.className = 'badge';
          badge.style.cssText = `
            padding: 6px 12px; 
            border-radius: 20px; 
            font-size: 12px; 
            font-weight: 600; 
            text-transform: uppercase;
            background: ${esFactible ? 'rgba(16, 185, 129, 0.2)' : 'rgba(239, 68, 68, 0.2)'};
            color: ${esFactible ? '#10b981' : '#ef4444'};
            border: 1px solid ${esFactible ? 'rgba(16, 185, 129, 0.3)' : 'rgba(239, 68, 68, 0.3)'};
          `;
          badge.textContent = esFactible ? 'Factible' : 'No Factible';
          td.appendChild(badge);
        }
        // Para la columna de an√°lisis (√≠ndice 33) O cualquier valor que parezca JSON de an√°lisis
        else if (i === 33 || (typeof val === 'string' && val.trim().startsWith('{"factible"') && val.includes('razon') && val.includes('diametroAntena'))) {
          const btnInfo = document.createElement('button');
          btnInfo.innerHTML = '<i class="fas fa-info-circle"></i> Informaci√≥n';
          btnInfo.title = 'Ver informaci√≥n detallada';
          btnInfo.style.cssText = `
            background: rgba(59, 130, 246, 0.2); 
            border: 1px solid rgba(59, 130, 246, 0.3); 
            color: #3b82f6; 
            padding: 6px 12px; 
            border-radius: 6px; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            font-size: 12px;
          `;
          btnInfo.onclick = function(e) {
            e.stopPropagation();
            try {
              const analisis = JSON.parse(val);
              mostrarAnalisisDetallado(analisis);
            } catch {
              alert('No hay informaci√≥n detallada disponible.');
            }
          };
          td.appendChild(btnInfo);
        } else {
          td.textContent = val;
        }
        fila.appendChild(td);
      });

      tbody.appendChild(fila);
    });
    
    actualizarContadorEnlaces();
    verificarEnlacesVacios();
    
    console.log('‚úÖ Enlaces cargados:', enlaces.length);
  } catch (error) {
    console.log('‚ö†Ô∏è Error al cargar enlaces:', error.message);
  }
}
document.querySelector('#tabla tbody').addEventListener('click', function(e) {
  let fila = e.target.closest('tr');
  if (!fila) return;
  document.querySelectorAll('#tabla tbody tr').forEach(f => f.classList.remove('selected'));
  fila.classList.add('selected');
  
  // Actualizar nombres de torres cuando se selecciona una fila
  const celdas = fila.querySelectorAll('td');
  if (celdas.length >= 30) {
    const idA = celdas[1]?.textContent || '';
    const nombreA = celdas[2]?.textContent || '';
    const alturaA = buscarAlturaEnColumnas(celdas, 'Torre A') || 0;
    const idB = celdas[7]?.textContent || '';
    const nombreB = celdas[8]?.textContent || '';
    const alturaB = buscarAlturaEnColumnas(celdas, 'Torre B') || 0;
    
    console.log('Fila seleccionada - actualizando nombres:', {idA, nombreA, alturaA, idB, nombreB, alturaB});
    
    // Verificar si la funci√≥n existe antes de llamarla
    if (typeof actualizarNombresTorres === 'function') {
      actualizarNombresTorres(idA, nombreA, alturaA, idB, nombreB, alturaB);
    } else {
      console.log('‚ö†Ô∏è Funci√≥n actualizarNombresTorres no est√° definida');
    }
  }
  
  actualizarBotonPerfilElevacionGlobal();
});
document.getElementById('btnPerfilElevacionGlobal').onclick = function() {
  const fila = document.querySelector('#tabla tbody tr.selected');
  if (!fila) return;
  
  const celdas = fila.querySelectorAll('td');
  const datos = {
    idA: celdas[1]?.textContent || '',
    nombreA: celdas[2]?.textContent || '',
    latA: celdas[3]?.textContent || '',
    lonA: celdas[4]?.textContent || '',
    idB: celdas[7]?.textContent || '',
    nombreB: celdas[8]?.textContent || '',
    latB: celdas[9]?.textContent || '',
    lonB: celdas[10]?.textContent || '',
    alturaA: buscarAlturaEnColumnas(celdas, 'Torre A') || '0',
    alturaB: buscarAlturaEnColumnas(celdas, 'Torre B') || '0',
    frecuencia: celdas[14]?.textContent || '0'
  };
  
  console.log('Generando perfil desde bot√≥n global:', datos);
  mostrarPerfilElevacionDesdeDatos(datos);
  const perfilDiv = document.getElementById('perfil-elevacion-con-torres');
  if (perfilDiv) {
    perfilDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
};
// ==================== GESTI√ìN DE ARCHIVOS ====================
function mostrarArchivoCargado(archivoInfo) {
  const contenedor = document.getElementById('archivo-cargado');
  const nombreArchivo = document.getElementById('nombre-archivo');
  const infoArchivo = document.getElementById('info-archivo');
  if (contenedor && nombreArchivo && infoArchivo) {
    nombreArchivo.textContent = archivoInfo.nombre;
    infoArchivo.textContent = `${archivoInfo.filas} filas ‚Ä¢ ${(archivoInfo.tama√±o / 1024).toFixed(1)} KB ‚Ä¢ Cargado: ${new Date(archivoInfo.fechaCarga).toLocaleString()}`;
    contenedor.style.display = 'block';
    document.getElementById('inputFile').style.display = 'none';
  }
}
function borrarArchivo() {
  if (confirm('¬øEst√°s seguro de que quieres borrar el archivo cargado? Esto eliminar√° todos los datos del Excel.')) {
    dataExcel = [];
    localStorage.removeItem('archivoExcelInfo');
    const contenedor = document.getElementById('archivo-cargado');
    const inputFile = document.getElementById('inputFile');
    if (contenedor) contenedor.style.display = 'none';
    if (inputFile) {
      inputFile.style.display = 'block';
      inputFile.value = '';
    } 
    alert('‚úÖ Archivo eliminado correctamente');
  }
}
function borrarArchivoPares() {
  if (confirm('¬øEst√°s seguro de que quieres borrar el archivo de pares cargado? Esto eliminar√° todos los datos de pares.')) {
    dataPares = [];
    localStorage.removeItem('archivoParesInfo');
    const request = indexedDB.open('ArchivosExcelDB', 2);
    request.onsuccess = function(event) {
      const db = event.target.result;
      if (db.objectStoreNames.contains('pares')) {
        const tx = db.transaction('pares', 'readwrite');
        const store = tx.objectStore('pares');
        const archivoInfo = JSON.parse(localStorage.getItem('archivoParesInfo') || '{}');
        if (archivoInfo.nombre) store.delete(archivoInfo.nombre);
        tx.oncomplete = () => db.close();
      }
    };
    const contenedor = document.getElementById('archivo-pares-cargado');
    const inputFile = document.getElementById('inputFilePairs');
    if (contenedor) contenedor.style.display = 'none';
    if (inputFile) {
      inputFile.style.display = 'block';
      inputFile.value = '';
    }
    alert('‚úÖ Archivo de pares eliminado correctamente');
  }
}
  document.getElementById('borrar-archivo').addEventListener('click', borrarArchivo);
  document.getElementById('idA').addEventListener('blur', () => autoCompletar('A'));
  document.getElementById('idB').addEventListener('blur', () => autoCompletar('B'));
  document.getElementById('latA').addEventListener('input', actualizarCalculos);
  document.getElementById('lonA').addEventListener('input', actualizarCalculos);
  document.getElementById('latB').addEventListener('input', actualizarCalculos);
  document.getElementById('lonB').addEventListener('input', actualizarCalculos);
  function actualizarContadorEnlaces() {
    // Protecci√≥n contra elementos no encontrados
    try {
      const totalEnlaces = document.querySelectorAll('#tabla tbody tr').length;
      const contadorElement = document.getElementById('contador-enlaces');
      const totalElement = document.getElementById('total-enlaces');
      
      if (contadorElement) contadorElement.textContent = totalEnlaces;
      if (totalElement) totalElement.textContent = totalEnlaces;
    } catch (error) {
      console.log('‚ö†Ô∏è Error al actualizar contador de enlaces:', error.message);
    }
  }
 function verificarEnlacesVacios() {
    const totalEnlaces = document.querySelectorAll('#tabla tbody tr').length;
    const tabla = document.querySelector('.table-container');
    const mensaje = document.getElementById('mensaje-sin-enlaces');
    if (totalEnlaces === 0) {
      tabla.style.display = 'none';
      mensaje.style.display = 'block';
    } else {
      tabla.style.display = 'block';
      mensaje.style.display = 'none';
    }
  }
 function autoCompletar(letra) {
  const id = document.getElementById('id' + letra).value.trim().toUpperCase();
if (!id) return;
const fila = dataExcel.find(row => row[0] && row[0].toString().trim().toUpperCase() === id);
  if (fila) {
    document.getElementById('nombre' + letra).value = fila[3] || '';
    document.getElementById('lat' + letra).value = fila[11] || '';
    document.getElementById('lon' + letra).value = fila[12] || '';
    document.getElementById('altura' + letra).value = fila[51] || '';
    document.getElementById('ran' + letra).value = fila[52] || '';
    document.getElementById('Trans' + letra).value = fila[103] || '';
    document.getElementById('Arre' + letra).value = fila[4] || '';
    document.getElementById('On' + letra).value = fila[102] || '';
    document.getElementById('Torre' + letra).value = fila[21] || '';
    document.getElementById('Estado' + letra).value = fila[13] || '';
    actualizarCalculos();
  } else {
    document.getElementById('nombre' + letra).value = '';
    document.getElementById('lat' + letra).value = '';
    document.getElementById('lon' + letra).value = '';
    document.getElementById('altura' + letra).value = '';
    document.getElementById('ran' + letra).value = '';
    document.getElementById('Trans' + letra).value = '';
    document.getElementById('Arre' + letra).value = '';
    document.getElementById('On' + letra).value = '';
    document.getElementById('Torre' + letra).value = '';
    document.getElementById('Estado' + letra).value = '';
    actualizarCalculos();
  }
}
  function actualizarCalculos() {
    actualizarRadianes();
    calcularDistanciaYFrecuencia();
    calcularCurvaturaFresnel();
  }
  function actualizarRadianes() {
    const rad = x => x * Math.PI / 180;
    const latA = parseFloat(document.getElementById('latA').value);
    const lonA = parseFloat(document.getElementById('lonA').value);
    const latB = parseFloat(document.getElementById('latB').value);
    const lonB = parseFloat(document.getElementById('lonB').value);
    document.getElementById('latArad').value = isNaN(latA) ? '' : rad(latA).toFixed(6);
    document.getElementById('lonArad').value = isNaN(lonA) ? '' : rad(lonA).toFixed(6);
    document.getElementById('latBrad').value = isNaN(latB) ? '' : rad(latB).toFixed(6);
    document.getElementById('lonBrad').value = isNaN(lonB) ? '' : rad(lonB).toFixed(6);
  }
  function calcularDistancia(lat1, lon1, lat2, lon2) {
    if (isNaN(lat1) || isNaN(lon1) || isNaN(lat2) || isNaN(lon2)) return NaN;
    const rad = x => x * Math.PI / 180;
    const R = 6371.0088;
    const œÜ1 = rad(lat1), œÜ2 = rad(lat2);
    const ŒîœÜ = rad(lat2 - lat1);
    const ŒîŒª = rad(lon2 - lon1);
    const a = Math.sin(ŒîœÜ / 2) ** 2 +
              Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª / 2) ** 2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }
  function desdeFormulario() {
  return {
    'Latitud A': document.getElementById('latA').value,
    'Longitud A': document.getElementById('lonA').value,
    'Latitud B': document.getElementById('latB').value,
    'Longitud B': document.getElementById('lonB').value,
    'Altura Torre A': document.getElementById('alturaA').value,
    'Altura Torre B': document.getElementById('alturaB').value,
    'Frecuencia': document.getElementById('frecuencia').value,
    'idA': document.getElementById('idA').value,
    'idB': document.getElementById('idB').value,
    'nombreA': document.getElementById('nombreA').value,
    'nombreB': document.getElementById('nombreB').value
  };
}
  // ==================== VALIDACIONES DE FACTIBILIDAD ====================
  function asignarFrecuencia(distanciaKm) {
    if (isNaN(distanciaKm)) return ''; 
    if (distanciaKm <= 5) {
      return '80';
    } else if (distanciaKm <= 15) {
      return '15';
    } else {
      return '8';
    }
  }
  function calcularDistanciaYFrecuencia() {
    const latA = parseFloat(document.getElementById('latA').value);
    const lonA = parseFloat(document.getElementById('lonA').value);
    const latB = parseFloat(document.getElementById('latB').value);
    const lonB = parseFloat(document.getElementById('lonB').value);
    const distanciaKm = calcularDistancia(latA, lonA, latB, lonB);
    if (!isNaN(distanciaKm)) {
      document.getElementById('distancia').value = distanciaKm.toFixed(6);
      document.getElementById('frecuencia').value = asignarFrecuencia(distanciaKm);
    } else {
      document.getElementById('distancia').value = '';
      document.getElementById('frecuencia').value = '';
    }
    calcularDisponibilidadAnual();
  }
  function calcularDisponibilidadAnual() {
  const distanciaKm = parseFloat(document.getElementById('distancia').value);
  const frecuenciaGHz = parseFloat(document.getElementById('frecuencia').value);
  if (isNaN(distanciaKm) || isNaN(frecuenciaGHz)) {
    document.getElementById('disponibilidadAnual').value = '';
    return;
  }
  let disponibilidad = 100 - (distanciaKm * 0.15) - (frecuenciaGHz * 0.5);
  if (disponibilidad < 0) disponibilidad = 0;
  if (disponibilidad > 100) disponibilidad = 100;
  document.getElementById('disponibilidadAnual').value = disponibilidad.toFixed(2);
}
function calcularCurvaturaFresnel() {
  const distanciaKm = parseFloat(document.getElementById('distancia').value);
  const alturaTorreA = parseFloat(document.getElementById('alturaA').value);
  const alturaTorreB = parseFloat(document.getElementById('alturaB').value);
  const frecuenciaGHz = parseFloat(document.getElementById('frecuencia').value);
  if (
    isNaN(distanciaKm) ||
    isNaN(alturaTorreA) ||
    isNaN(alturaTorreB) ||
    isNaN(frecuenciaGHz) ||
    distanciaKm <= 0 ||
    alturaTorreA <= 0 ||
    alturaTorreB <= 0 ||
    frecuenciaGHz <= 0
  ) {
    document.getElementById('bulboCurvatura').value = '';
    document.getElementById('radioFresnel').value = '';
    document.getElementById('alturaLibre').value = '';
    document.getElementById('alturaDisponible').value = '';
    document.getElementById('factibilidadCurvatura').value = 'NO DISPONIBLE';
    return;
  }
  const R = 8495000; 
  const d_m = distanciaKm * 1000;
  const bulboCurvatura = (d_m * d_m) / (8 * R);
  const D = distanciaKm;
  const F1 = 17.32 * Math.sqrt(D / (4 * frecuenciaGHz));
  const alturaLibre = bulboCurvatura + 0.6 * F1;
  const alturaDisponible = Math.min(alturaTorreA, alturaTorreB);
  let factibilidadCurvatura = '';
  if (!isNaN(alturaDisponible) && !isNaN(alturaLibre)) {
    factibilidadCurvatura = alturaDisponible >= alturaLibre ? 'FACTIBLE' : 'NO FACTIBLE';
  } else {
    factibilidadCurvatura = 'NO DISPONIBLE';
  }
  document.getElementById('bulboCurvatura').value = bulboCurvatura.toFixed(2);
  document.getElementById('radioFresnel').value = F1.toFixed(2);
  document.getElementById('alturaLibre').value = alturaLibre.toFixed(2);
  document.getElementById('alturaDisponible').value = alturaDisponible.toFixed(2);
  document.getElementById('factibilidadCurvatura').value = factibilidadCurvatura;
}
// ============================================
//            AN√ÅLISIS DE FACTIBILIDAD 
// ============================================
function analizarFactibilidad(distanciaKm, arreA, arreB, transA, transB, torreA, torreB, OnA, OnB, esFactibleLOS = true) {
  let factible = false;
  let razon = '';
  let diametroAntena = '';
  let tipoEnlace = '';
  let detallesValidacion = [];
  if (!distanciaKm || isNaN(distanciaKm) || distanciaKm <= 0) {
    return {
      factible: false,
      razon: 'No factible - Distancia inv√°lida o cero',
      diametroAntena: 'N/A',
      tipoEnlace: 'Error de Datos',
      distancia: distanciaKm,
      detalles: ['‚ùå Error en c√°lculo de distancia']
    };
  }
  if (!distanciaKm || isNaN(distanciaKm) || distanciaKm <= 0) {
    return {
      factible: false,
      razon: 'No factible - Distancia inv√°lida o cero',
      diametroAntena: 'N/A',
      tipoEnlace: 'Error de Datos',
      distancia: distanciaKm,
      detalles: ['‚ùå Error en c√°lculo de distancia']
    };
  }
  const DISTANCIA_MAXIMA = 50;
  if (distanciaKm > DISTANCIA_MAXIMA) {
    return {
      factible: false,
      razon: `No factible - Distancia excesiva (${distanciaKm.toFixed(2)}km > ${DISTANCIA_MAXIMA}km)`,
      diametroAntena: 'N/A',
      tipoEnlace: 'Fuera de Rango',
      distancia: distanciaKm,
      detalles: [`‚ùå Distancia ${distanciaKm.toFixed(2)}km supera el l√≠mite m√°ximo de ${DISTANCIA_MAXIMA}km`]
    };
  }
    if (!esFactibleLOS) {
    return {
      factible: false,
      razon: 'No factible - L√≠nea de vista obstruida (perfil de elevaci√≥n)',
      diametroAntena: 'N/A',
      tipoEnlace: 'LOS Obstruida',
      distancia: distanciaKm,
      detalles: ['‚ùå L√≠nea de vista obstruida seg√∫n perfil de elevaci√≥n']
    };
  }
function analizarEnlaceSatelital() {
  if (!document.getElementById('latA').value || !document.getElementById('latB').value) {
    alert('‚ùå Debes ingresar al menos las coordenadas de ambos sitios antes de realizar el an√°lisis satelital');
    return;
  }
  const transAOriginal = document.getElementById('TransA').value;
  const transBOriginal = document.getElementById('TransB').value;

  try {
    document.getElementById('TransA').value = 'Satelite-OA';
    document.getElementById('TransB').value = 'Satelite-OA';
    const mensaje = 'üõ∞Ô∏è Analizando enlace en modo Satelital-Satelital...';
    const indicador = document.createElement('div');
    indicador.innerHTML = mensaje;
    indicador.style.cssText = 'position:fixed; top:20px; left:50%; transform:translateX(-50%); background:#00bcd4; color:#fff; padding:8px 16px; border-radius:20px; z-index:1000;';
    document.body.appendChild(indicador);
    setTimeout(() => indicador.remove(), 3000);
    agregarOActualizarEnlace();

  } finally {
    document.getElementById('TransA').value = transAOriginal;
    document.getElementById('TransB').value = transBOriginal;
  }
}
function validarEnlaceSatelital(distanciaKm) {
  if (distanciaKm > 100) {
    return {
      factible: false,
      mensaje: 'Distancia excesiva para enlace satelital'
    };
  }
  return {
    factible: true,
    mensaje: 'Distancia aceptable para enlace satelital'
  };
}

function esSatelital(tipoTransporte) {
  const t = (tipoTransporte || '').toLowerCase();
  return t.includes('starlink') || 
         t.includes('orbita') ||
         t.includes('satelite-oa') ||
         t.includes('satelital') ||
         t.includes('satellite') ||
         t.includes('sat-oa') ||
         t.includes('satelite') ||
         t.includes('sat√©lite');
}
  const arreANorm = (arreA || '').toLowerCase().trim();
  const arreBNorm = (arreB || '').toLowerCase().trim();
  const transANorm = (transA || '').toLowerCase().trim();
  const transBNorm = (transB || '').toLowerCase().trim();
  const torreANorm = (torreA || '').toLowerCase().trim();
  const torreBNorm = (torreB || '').toLowerCase().trim();
  const onAirANorm = (OnA || '').toLowerCase().trim();
  const onAirBNorm = (OnB || '').toLowerCase().trim();
  function estaOnAir(estadoOnAir) {
    return estadoOnAir.includes('on air') || 
           estadoOnAir.includes('onair') ||
           estadoOnAir.includes('operativo') ||
           estadoOnAir.includes('activo') ||
           estadoOnAir.includes('funcionando') ||
           estadoOnAir === 'si' ||
           estadoOnAir === 's√≠' ||
           estadoOnAir === 'yes';
  }
  function estaPendiente(estadoOnAir) {
    return estadoOnAir.includes('pendiente') ||
           estadoOnAir.includes('construcci√≥n') ||
           estadoOnAir.includes('construccion') ||
           estadoOnAir.includes('instalaci√≥n') ||
           estadoOnAir.includes('instalacion') ||
           estadoOnAir.includes('desarrollo') ||
           estadoOnAir.includes('proyecto') ||
           estadoOnAir.includes('planeado') ||
           estadoOnAir.includes('no operativo') ||
           estadoOnAir.includes('inactivo') ||
           estadoOnAir === 'no';
  }
  const onAirAActivo = estaOnAir(onAirANorm);
  const onAirBActivo = estaOnAir(onAirBNorm);
  const onAirAPendiente = estaPendiente(onAirANorm);
  const onAirBPendiente = estaPendiente(onAirBNorm);
if (onAirAPendiente) {
  let motivoOnAir = `Torre A est√° pendiente: "${OnA}"`;
  detallesValidacion.push(`‚ùå Torre A: "${OnA}" - Estado pendiente/inactivo`);
  if (onAirBPendiente) {
    detallesValidacion.push(`‚úÖ Torre B: "${OnB}" - Estado pendiente/inactivo (no bloquea factibilidad)`);
  } else {
    detallesValidacion.push(`‚úÖ Torre B: "${OnB}" - Estado operativo`);
  }
  detallesValidacion.push('‚ö†Ô∏è La torre A debe estar "On Air" (operativa) para establecer enlaces PtP');
  return {
    factible: false,
    razon: `No factible - ${motivoOnAir}`,
    diametroAntena: 'N/A',
    tipoEnlace: 'Torre No Operativa',
    distancia: distanciaKm,
    detalles: detallesValidacion
  };
}
  if (onAirAActivo && onAirBActivo) {
    detallesValidacion.push(`‚úÖ Torre A: "${OnA}" - Estado operativo confirmado`);
    detallesValidacion.push(`‚úÖ Torre B: "${OnB}" - Estado operativo confirmado`);
  } else {
    detallesValidacion.push(`‚ö†Ô∏è Torre A: "${OnA}" - Estado no claramente definido`);
    detallesValidacion.push(`‚ö†Ô∏è Torre B: "${OnB}" - Estado no claramente definido`);
    detallesValidacion.push(`‚ÑπÔ∏è Se asume estado operativo, pero verificar manualmente`);
  }
  function esTorreNoFactible(tipoTorre) {
    const t = tipoTorre.toLowerCase();
    return t.includes('poste') || 
           t.includes('monopolo') ||
           t.includes('mono polo') ||
           t.includes('mono-polo') ||
           t.includes('mastil') ||  
           t.includes('m√°stil'); 
  }
  const torreANoFactible = esTorreNoFactible(torreANorm);
  const torreBNoFactible = esTorreNoFactible(torreBNorm);
  if (torreANoFactible || torreBNoFactible) {
    let motivoTorre = '';
    if (torreANoFactible && torreBNoFactible) {
      motivoTorre = `Ambas torres son de tipo no compatible (A: ${torreA}, B: ${torreB})`;
      detallesValidacion.push(`‚ùå Torre A: "${torreA}" - Tipo no factible`);
      detallesValidacion.push(`‚ùå Torre B: "${torreB}" - Tipo no factible`);
    } else if (torreANoFactible) {
      motivoTorre = `Torre A es de tipo no compatible: "${torreA}"`;
      detallesValidacion.push(`‚ùå Torre A: "${torreA}" - Tipo no factible`);
      detallesValidacion.push(`‚úÖ Torre B: "${torreB}" - Tipo compatible`);
    } else {
      motivoTorre = `Torre B es de tipo no compatible: "${torreB}"`;
      detallesValidacion.push(`‚úÖ Torre A: "${torreA}" - Tipo compatible`);
      detallesValidacion.push(`‚ùå Torre B: "${torreB}" - Tipo no factible`);
    }
    detallesValidacion.push('‚ö†Ô∏è Los tipos de torre "poste" y "monopolo" no son compatibles para enlaces PtP');
    return {
      factible: false,
      razon: `No factible - ${motivoTorre}`,
      diametroAntena: 'N/A',
      tipoEnlace: 'Torre Incompatible',
      distancia: distanciaKm,
      detalles: detallesValidacion
    };
  }
  detallesValidacion.push(`‚úÖ Torre A: "${torreA}" - Tipo compatible para enlace PtP`);
  detallesValidacion.push(`‚úÖ Torre B: "${torreB}" - Tipo compatible para enlace PtP`);
  const alturaLibre = parseFloat(document.getElementById('alturaLibre').value);
  const alturaDisponible = parseFloat(document.getElementById('alturaDisponible').value);
  if (!isNaN(alturaLibre) && !isNaN(alturaDisponible)) {
    if (alturaDisponible < alturaLibre) {
      detallesValidacion.push(`‚ùå L√≠nea de vista obstruida: Altura disponible (${alturaDisponible.toFixed(2)} m) < Altura libre necesaria (${alturaLibre.toFixed(2)} m)`);
      return {
        factible: false,
        razon: 'No factible - L√≠nea de vista obstruida (altura insuficiente)',
        diametroAntena: 'N/A',
        tipoEnlace: 'LOS Obstruida',
        distancia: distanciaKm,
        detalles: detallesValidacion
      };
    } else {
      detallesValidacion.push(`‚úÖ L√≠nea de vista: Altura disponible (${alturaDisponible.toFixed(2)} m) ‚â• Altura libre necesaria (${alturaLibre.toFixed(2)} m)`);
    }
  }
  function calcularDiametroAntena(distancia, esArrendamiento = false) {
    if (esArrendamiento) {
      if (distancia <= 3.1) return '1 pie';
      if (distancia <= 8) return '2 pies';
      if (distancia <= 13.5) return '3 pies';
      return 'No factible';
    }
    if (distancia >= 0 && distancia <= 3) return '1 pie';
    if (distancia > 3 && distancia <= 5) return '2 pies';
    if (distancia > 5 && distancia <= 10) return '3 pies';
    if (distancia > 10 && distancia <= 20) return '4 pies';
    if (distancia > 20) return '6 pies';
  }
   function validarCapacidadAntena(distancia, diametro, esArrendamiento = false) {
    if (esArrendamiento) {
      if (diametro === '1 pie') return distancia <= 3.1;
      if (diametro === '2 pies') return distancia > 3.1 && distancia <= 8;
      if (diametro === '3 pies') return distancia > 8 && distancia <= 14;
      return false;
    }
    if (diametro === '1 pie') return distancia >= 0 && distancia <= 3;
    if (diametro === '2 pies') return distancia > 3 && distancia <= 5;
    if (diametro === '3 pies') return distancia > 5 && distancia <= 10;
    return false;
  }
  function esArrendada(tipoArrendamiento) {
    return tipoArrendamiento.includes('arrendada') || 
           tipoArrendamiento.includes('arrendamiento') ||
           tipoArrendamiento.includes('renta');
  }
  function esAdquisicion(tipoArrendamiento) {
    return tipoArrendamiento.includes('adquisici√≥n') || 
           tipoArrendamiento.includes('adquisicion') ||
           tipoArrendamiento.includes('compra') ||
           tipoArrendamiento.includes('propia');
  }
  function esFibra(tipoTransporte) {
    return tipoTransporte.includes('fibra') || 
           tipoTransporte.includes('√≥ptica') ||
           tipoTransporte.includes('optica') ||
           tipoTransporte.includes('fo');
  }
function esSatelital(tipoTransporte) {
  return tipoTransporte.includes('starlink') || 
         tipoTransporte.includes('orbita') ||
         tipoTransporte.includes('satelite-oa') ||
         tipoTransporte.includes('satelital') ||
         tipoTransporte.includes('satellite');
  }
  const transporteBNulo = transBNorm === 'n/a' || transBNorm === '0' || transBNorm === '' || transBNorm === 'na';
if (transporteBNulo) {
  const fibraA = esFibra(transANorm);
  detallesValidacion.push('‚úÖ Transporte en B est√° vac√≠o/N/A/0, se permite enlace si A tiene fibra √≥ptica');
  if (!fibraA) {
    detallesValidacion.push('‚ùå Torre A debe tener Fibra √ìptica');
    return {
      factible: false,
      razon: `No factible - Torre A debe tener Fibra √ìptica`,
      diametroAntena: 'N/A',
      tipoEnlace: 'Transporte Incompatible',
      distancia: distanciaKm,
      detalles: detallesValidacion
    };
  }
  diametroAntena = calcularDiametroAntena(distanciaKm, false);
  detallesValidacion.push(`üì° Antenas requeridas: ${diametroAntena} (seg√∫n distancia ${distanciaKm.toFixed(2)}km)`);
  if (validarCapacidadAntena(distanciaKm, diametroAntena)) {
    detallesValidacion.push(`‚úÖ Distancia ${distanciaKm.toFixed(2)}km compatible con antenas de ${diametroAntena}`);
    factible = true;
    razon = `Enlace factible - Fibra en A, B vac√≠o, distancia: ${distanciaKm.toFixed(2)}km, antenas: ${diametroAntena}`;
  } else {
    detallesValidacion.push(`‚ùå Distancia ${distanciaKm.toFixed(2)}km excede capacidad de antenas de ${diametroAntena}`);
    factible = false;
    razon = `No factible - Distancia ${distanciaKm.toFixed(2)}km excede capacidad de antenas ${diametroAntena}`;
  }
  return { 
    factible, 
    razon, 
    diametroAntena, 
    tipoEnlace: 'Fibra A / B vac√≠o', 
    distancia: distanciaKm, 
    detalles: detallesValidacion 
  };
}
if (!transA || !transB) {
  detallesValidacion.push('‚ö†Ô∏è Falta informaci√≥n de tipo de transporte');
  return {
    factible: false,
    razon: 'No factible - Informaci√≥n incompleta de transporte',
    diametroAntena: 'N/A',
    tipoEnlace: 'Datos Incompletos',
    distancia: distanciaKm,
    detalles: detallesValidacion
  };
}
  if (!transA || !transB) {
    detallesValidacion.push('‚ö†Ô∏è Falta informaci√≥n de tipo de transporte');
    return {
      factible: false,
      razon: 'No factible - Informaci√≥n incompleta de transporte',
      diametroAntena: 'N/A',
      tipoEnlace: 'Datos Incompletos',
      distancia: distanciaKm,
      detalles: detallesValidacion
    };
  }
if (transANorm === transBNorm) {
  if (!permitirMismoTransporte) {
    detallesValidacion.push(`‚ùå Ambas torres tienen el mismo transporte: "${transA}"`);
    return {
      factible: false,
      razon: `No factible - Ambas torres tienen el mismo tipo de transporte (${transA})`,
      diametroAntena: 'N/A',
      tipoEnlace: 'Transporte Duplicado',
      distancia: distanciaKm,
      detalles: detallesValidacion
    };
  } else {
    detallesValidacion.push(`‚úÖ Permitiendo mismo tipo de transporte: "${transA}"`);
    const esSatA = esSatelital(transANorm);
    const esSatB = esSatelital(transBNorm);
    diametroAntena = calcularDiametroAntena(distanciaKm, true);
    if (esSatA && esSatB && validarCapacidadAntena(distanciaKm, diametroAntena, true)) {
      detallesValidacion.push(`‚úÖ Ambos sitios tienen transporte satelital y antena compatible`);
      return {
        factible: true,
        razon: `Enlace factible - Mismo tipo de transporte permitido (${transA}), distancia: ${distanciaKm.toFixed(2)}km, antenas: ${diametroAntena}`,
        diametroAntena,
        tipoEnlace: 'Mismo Transporte Permitido',
        distancia: distanciaKm,
        detalles: detallesValidacion
      };
    } else {
      detallesValidacion.push(`‚ùå Ambos sitios deben tener transporte satelital y antena compatible`);
      return {
        factible: false,
        razon: `No factible - Ambos sitios deben tener transporte satelital y antena compatible`,
        diametroAntena,
        tipoEnlace: 'Mismo Transporte Permitido',
        distancia: distanciaKm,
        detalles: detallesValidacion
      };
    }
  }
}else if (transANorm === transBNorm && permitirMismoTransporte) {
  detallesValidacion.push(`‚úÖ Permitiendo mismo tipo de transporte: "${transA}"`);
}
  const esArrendadaA = esArrendada(arreANorm);
  const esArrendadaB = esArrendada(arreBNorm);
if (esArrendadaA || esArrendadaB) {
    diametroAntena = calcularDiametroAntena(distanciaKm, true);
    tipoEnlace = 'Torres Arrendadas';
    detallesValidacion.push(`üìç Torre A: ${esArrendadaA ? 'Arrendada' : 'Propia'}`);
    detallesValidacion.push(`üìç Torre B: ${esArrendadaB ? 'Arrendada' : 'Propia'}`);
    detallesValidacion.push(`üì° Antena asignada: ${diametroAntena} (seg√∫n distancia)`);
    if (diametroAntena === '1 pie' || diametroAntena === '2 pies' || diametroAntena === '3 pies') {
      detallesValidacion.push(`‚úÖ Antena de ${diametroAntena} permitida en arrendada`);
      factible = true;
      razon = `Enlace factible - Antena de ${diametroAntena} en torre arrendada`;
    } else {
      detallesValidacion.push(`‚ùå Antena de ${diametroAntena} NO permitida en torre arrendada (solo 1, 2 o 3 pies)`);
      return {
        factible: false,
        razon: `No factible - Solo se permiten antenas de 1, 2 o 3 pies en torres arrendadas`,
        diametroAntena,
        tipoEnlace,
        distancia: distanciaKm,
        detalles: detallesValidacion
      };
    }
    return { factible, razon, diametroAntena, tipoEnlace, distancia: distanciaKm, detalles: detallesValidacion };
  }
  const esAdquisicionA = esAdquisicion(arreANorm);
  const esAdquisicionB = esAdquisicion(arreBNorm);
 if (esAdquisicionA && esAdquisicionB) {
  tipoEnlace = 'Torres de Adquisici√≥n';
  detallesValidacion.push('üè¢ Ambas torres son de adquisici√≥n (mayor flexibilidad)');
  if (distanciaKm > 50) {
    factible = false;
    razon = `No factible - Distancia excesiva (${distanciaKm.toFixed(2)}km > 50km)`;
    diametroAntena = 'Cualquiera';
    detallesValidacion.push(`‚ùå Distancia ${distanciaKm.toFixed(2)}km supera el l√≠mite m√°ximo de 50km`);
  } else {
    factible = true;
    razon = `Enlace factible - Torres de adquisici√≥n, sin restricci√≥n de di√°metro de antena`;
     if (distanciaKm <= 5) {
      diametroAntena = '1 a 2 pies';
    } else if (distanciaKm <= 15) {
      diametroAntena = '3 a 4 pies';
    } else {
      diametroAntena = '4 a 6 pies';
    }
    detallesValidacion.push(`‚úÖ Antena recomendada para adquisici√≥n: ${diametroAntena}`);
  }
  return {
    factible,
    razon,
    diametroAntena,
    tipoEnlace,
    distancia: distanciaKm,
    detalles: detallesValidacion
  };
} else {
  tipoEnlace = 'Torres Mixtas';
  detallesValidacion.push(`üè¢ Torre A: ${esAdquisicionA ? 'Adquisici√≥n' : 'Otro'}, Torre B: ${esAdquisicionB ? 'Adquisici√≥n' : 'Otro'}`);
  diametroAntena = calcularDiametroAntena(distanciaKm, false);
  detallesValidacion.push(`üì° Antenas requeridas: ${diametroAntena} (seg√∫n distancia ${distanciaKm.toFixed(2)}km)`);
  if (validarCapacidadAntena(distanciaKm, diametroAntena)) {
    detallesValidacion.push(`‚úÖ Distancia ${distanciaKm.toFixed(2)}km compatible con antenas de ${diametroAntena}`);
    factible = true;
    razon = `Enlace factible - Fibra+Satelital, distancia: ${distanciaKm.toFixed(2)}km, antenas: ${diametroAntena}`;
  } else {
    detallesValidacion.push(`‚ùå Distancia ${distanciaKm.toFixed(2)}km excede capacidad de antenas de ${diametroAntena}`);
    factible = false;
    razon = `No factible - Distancia ${distanciaKm.toFixed(2)}km excede capacidad de antenas ${diametroAntena}`;
  }
  return {
    factible,
    razon,
    diametroAntena,
    tipoEnlace,
    distancia: distanciaKm,
    detalles: detallesValidacion
  };
}
  function verificarLineaDeVista(elevaciones, lineaVista, fresnel) {
  for (let i = 0; i < elevaciones.length; i++) {
    if (elevaciones[i] > fresnel[i]) {
      return false; 
    }
  }
  return true; 
}
const satelitalA = esSatelital(transANorm);
const satelitalB = esSatelital(transBNorm);
if (satelitalA && satelitalB) {
   const validacionSatelital = validarEnlaceSatelital(distanciaKm);
  if (!validacionSatelital.factible) {
    detallesValidacion.push(`‚ùå ${validacionSatelital.mensaje}`);
    return {
      factible: false,
      razon: `No factible - ${validacionSatelital.mensaje}`,
      diametroAntena: 'N/A',
      tipoEnlace: 'Satelital-Satelital',
      distancia: distanciaKm,
      detalles: detallesValidacion
    };
  }
  diametroAntena = calcularDiametroAntena(distanciaKm, false);
  tipoEnlace = 'Satelital-Satelital';
  detallesValidacion.push('üì° Torre A: Transporte Satelital');
  detallesValidacion.push('üì° Torre B: Transporte Satelital');
  detallesValidacion.push(`üì° Antenas requeridas: ${diametroAntena} (seg√∫n distancia ${distanciaKm.toFixed(2)}km)`);
  if (validarCapacidadAntena(distanciaKm, diametroAntena)) {
    detallesValidacion.push(`‚úÖ Distancia ${distanciaKm.toFixed(2)}km compatible con antenas de ${diametroAntena}`);
    factible = true;
    razon = `Enlace factible - Configuraci√≥n Satelital-Satelital, distancia: ${distanciaKm.toFixed(2)}km, antenas: ${diametroAntena}`;
  } else {
    detallesValidacion.push(`‚ùå Distancia ${distanciaKm.toFixed(2)}km excede capacidad de antenas de ${diametroAntena}`);
    factible = false;
    razon = `No factible - Distancia ${distanciaKm.toFixed(2)}km excede capacidad de antenas ${diametroAntena}`;
  }
  return { 
    factible, 
    razon, 
    diametroAntena, 
    tipoEnlace, 
    distancia: distanciaKm, 
    detalles: detallesValidacion 
  };
}
}
function analizarFactibilidadPermisiva(distanciaKm, arreA, arreB, transA, transB, torreA, torreB, OnA, OnB, esFactibleLOS = true) {
  let factible = false;
  let razon = '';
  let diametroAntena = '';
  let tipoEnlace = '';
  let detallesValidacion = [];
  if (!distanciaKm || isNaN(distanciaKm) || distanciaKm <= 0) {
    return {
      factible: false,
      razon: 'No factible - Distancia inv√°lida o cero',
      diametroAntena: 'N/A',
      tipoEnlace: 'Error de Datos',
      distancia: distanciaKm,
      detalles: ['‚ùå Error en c√°lculo de distancia']
    };
  }
  const DISTANCIA_MAXIMA = 50;
  if (distanciaKm > DISTANCIA_MAXIMA) {
    return {
      factible: false,
      razon: `No factible - Distancia excesiva (${distanciaKm.toFixed(2)}km > ${DISTANCIA_MAXIMA}km)`,
      diametroAntena: 'N/A',
      tipoEnlace: 'Fuera de Rango',
      distancia: distanciaKm,
      detalles: [`‚ùå Distancia ${distanciaKm.toFixed(2)}km supera el l√≠mite m√°ximo de ${DISTANCIA_MAXIMA}km`]
    };
  }
  if (!esFactibleLOS) {
    return {
      factible: false,
      razon: 'No factible - L√≠nea de vista obstruida (perfil de elevaci√≥n)',
      diametroAntena: 'N/A',
      tipoEnlace: 'LOS Obstruida',
      distancia: distanciaKm,
      detalles: ['‚ùå L√≠nea de vista obstruida seg√∫n perfil de elevaci√≥n']
    };
  }
  const arreANorm = (arreA || '').toLowerCase().trim();
  const arreBNorm = (arreB || '').toLowerCase().trim();
  const transANorm = (transA || '').toLowerCase().trim();
  const transBNorm = (transB || '').toLowerCase().trim();
  const torreANorm = (torreA || '').toLowerCase().trim();
  const torreBNorm = (torreB || '').toLowerCase().trim();
  const onAirANorm = (OnA || '').toLowerCase().trim();
  const onAirBNorm = (OnB || '').toLowerCase().trim();
  function estaOnAir(estadoOnAir) {
    return estadoOnAir.includes('on air') ||
      estadoOnAir.includes('onair') ||
      estadoOnAir.includes('operativo') ||
      estadoOnAir.includes('activo') ||
      estadoOnAir.includes('funcionando') ||
      estadoOnAir === 'si' ||
      estadoOnAir === 's√≠' ||
      estadoOnAir === 'yes';
  }
  function estaPendiente(estadoOnAir) {
    return estadoOnAir.includes('pendiente') ||
      estadoOnAir.includes('construcci√≥n') ||
      estadoOnAir.includes('construccion') ||
      estadoOnAir.includes('instalaci√≥n') ||
      estadoOnAir.includes('instalacion') ||
      estadoOnAir.includes('desarrollo') ||
      estadoOnAir.includes('proyecto') ||
      estadoOnAir.includes('planeado') ||
      estadoOnAir.includes('no operativo') ||
      estadoOnAir.includes('inactivo') ||
      estadoOnAir === 'no';
  }
  const onAirAActivo = estaOnAir(onAirANorm);
  const onAirBActivo = estaOnAir(onAirBNorm);
  const onAirAPendiente = estaPendiente(onAirANorm);
  const onAirBPendiente = estaPendiente(onAirBNorm);
  if (onAirAPendiente) {
    let motivoOnAir = `Torre A est√° pendiente: "${OnA}"`;
    detallesValidacion.push(`‚ùå Torre A: "${OnA}" - Estado pendiente/inactivo`);
    if (onAirBPendiente) {
      detallesValidacion.push(`‚úÖ Torre B: "${OnB}" - Estado pendiente/inactivo (no bloquea factibilidad)`);
    } else {
      detallesValidacion.push(`‚úÖ Torre B: "${OnB}" - Estado operativo`);
    }
    detallesValidacion.push('‚ö†Ô∏è La torre A debe estar "On Air" (operativa) para establecer enlaces PtP');
    return {
      factible: false,
      razon: `No factible - ${motivoOnAir}`,
      diametroAntena: 'N/A',
      tipoEnlace: 'Torre No Operativa',
      distancia: distanciaKm,
      detalles: detallesValidacion
    };
  }
  if (onAirAActivo && onAirBActivo) {
    detallesValidacion.push(`‚úÖ Torre A: "${OnA}" - Estado operativo confirmado`);
    detallesValidacion.push(`‚úÖ Torre B: "${OnB}" - Estado operativo confirmado`);
  } else {
    detallesValidacion.push(`‚ö†Ô∏è Torre A: "${OnA}" - Estado no claramente definido`);
    detallesValidacion.push(`‚ö†Ô∏è Torre B: "${OnB}" - Estado no claramente definido`);
    detallesValidacion.push(`‚ÑπÔ∏è Se asume estado operativo, pero verificar manualmente`);
  }
  function esTorreNoFactible(tipoTorre) {
    const t = tipoTorre.toLowerCase();
    return t.includes('poste') ||
      t.includes('monopolo') ||
      t.includes('mono polo') ||
      t.includes('mono-polo') ||
      t.includes('mastil') ||
      t.includes('m√°stil');
  }
  const torreANoFactible = esTorreNoFactible(torreANorm);
  const torreBNoFactible = esTorreNoFactible(torreBNorm);
  if (torreANoFactible || torreBNoFactible) {
    let motivoTorre = '';
    if (torreANoFactible && torreBNoFactible) {
      motivoTorre = `Ambas torres son de tipo no compatible (A: ${torreA}, B: ${torreB})`;
      detallesValidacion.push(`‚ùå Torre A: "${torreA}" - Tipo no factible`);
      detallesValidacion.push(`‚ùå Torre B: "${torreB}" - Tipo no factible`);
    } else if (torreANoFactible) {
      motivoTorre = `Torre A es de tipo no compatible: "${torreA}"`;
      detallesValidacion.push(`‚ùå Torre A: "${torreA}" - Tipo no factible`);
      detallesValidacion.push(`‚úÖ Torre B: "${torreB}" - Tipo compatible`);
    } else {
      motivoTorre = `Torre B es de tipo no compatible: "${torreB}"`;
      detallesValidacion.push(`‚úÖ Torre A: "${torreA}" - Tipo compatible`);
      detallesValidacion.push(`‚ùå Torre B: "${torreB}" - Tipo no factible`);
    }
    detallesValidacion.push('‚ö†Ô∏è Los tipos de torre "poste" y "monopolo" no son compatibles para enlaces PtP');
    return {
      factible: false,
      razon: `No factible - ${motivoTorre}`,
      diametroAntena: 'N/A',
      tipoEnlace: 'Torre Incompatible',
      distancia: distanciaKm,
      detalles: detallesValidacion
    };
  }
  detallesValidacion.push(`‚úÖ Torre A: "${torreA}" - Tipo compatible para enlace PtP`);
  detallesValidacion.push(`‚úÖ Torre B: "${torreB}" - Tipo compatible para enlace PtP`);
  const alturaLibre = parseFloat(document.getElementById('alturaLibre').value);
  const alturaDisponible = parseFloat(document.getElementById('alturaDisponible').value);
  if (!isNaN(alturaLibre) && !isNaN(alturaDisponible)) {
    if (alturaDisponible < alturaLibre) {
      detallesValidacion.push(`‚ùå L√≠nea de vista obstruida: Altura disponible (${alturaDisponible.toFixed(2)} m) < Altura libre necesaria (${alturaLibre.toFixed(2)} m)`);
      return {
        factible: false,
        razon: 'No factible - L√≠nea de vista obstruida (altura insuficiente)',
        diametroAntena: 'N/A',
        tipoEnlace: 'LOS Obstruida',
        distancia: distanciaKm,
        detalles: detallesValidacion
      };
    } else {
      detallesValidacion.push(`‚úÖ L√≠nea de vista: Altura disponible (${alturaDisponible.toFixed(2)} m) ‚â• Altura libre necesaria (${alturaLibre.toFixed(2)} m)`);
    }
  }
  function calcularDiametroAntena(distancia, esArrendamiento = false) {
  if (esArrendamiento) {
    if (distancia <= 3.1) return '1 pie';
    if (distancia <= 8) return '2 pies';
    if (distancia <= 13.5) return '3 pies';
    return '4 pies o m√°s'; 
  }
  if (distancia >= 0 && distancia <= 3) return '1 pie';
  if (distancia > 3 && distancia <= 5) return '2 pies';
  if (distancia > 5 && distancia <= 10) return '3 pies';
  if (distancia > 10 && distancia <= 20) return '4 pies';
  if (distancia > 20) return '6 pies';
  return 'No factible';
}
  function validarCapacidadAntena(distancia, diametro, esArrendamiento = false) {
    if (esArrendamiento) {
      if (diametro === '1 pie') return distancia <= 3.1;
      if (diametro === '2 pies') return distancia > 3.1 && distancia <= 8;
      if (diametro === '3 pies') return distancia > 8 && distancia <= 14;
      return false;
    }
    if (diametro === '1 pie') return distancia >= 0 && distancia <= 3;
    if (diametro === '2 pies') return distancia > 3 && distancia <= 5;
    if (diametro === '3 pies') return distancia > 5 && distancia <= 10;
    return false;
  }
  function esArrendada(tipoArrendamiento) {
    return tipoArrendamiento.includes('arrendada') ||
      tipoArrendamiento.includes('arrendamiento') ||
      tipoArrendamiento.includes('renta');
  }
  function esAdquisicion(tipoArrendamiento) {
    return tipoArrendamiento.includes('adquisici√≥n') ||
      tipoArrendamiento.includes('adquisicion') ||
      tipoArrendamiento.includes('compra') ||
      tipoArrendamiento.includes('propia');
  }
  function esFibra(tipoTransporte) {
    return tipoTransporte.includes('fibra') ||
      tipoTransporte.includes('√≥ptica') ||
      tipoTransporte.includes('optica') ||
      tipoTransporte.includes('fo');
  }
  function esSatelital(tipoTransporte) {
    return tipoTransporte.includes('starlink') ||
      tipoTransporte.includes('orbita') ||
      tipoTransporte.includes('satelite-oa') ||
      tipoTransporte.includes('satelital') ||
      tipoTransporte.includes('satellite');
  }
  const transporteBNulo = transBNorm === 'n/a' || transBNorm === '0' || transBNorm === '' || transBNorm === 'na';
  if (transporteBNulo) {
    const fibraA = esFibra(transANorm);
    detallesValidacion.push('‚úÖ Transporte en B est√° vac√≠o/N/A/0, se permite enlace si A tiene fibra √≥ptica');
    if (!fibraA) {
      detallesValidacion.push('‚ùå Torre A debe tener Fibra √ìptica');
      return {
        factible: false,
        razon: `No factible - Torre A debe tener Fibra √ìptica`,
        diametroAntena: 'N/A',
        tipoEnlace: 'Transporte Incompatible',
        distancia: distanciaKm,
        detalles: detallesValidacion
      };
    }
    diametroAntena = calcularDiametroAntena(distanciaKm, false);
    detallesValidacion.push(`üì° Antenas requeridas: ${diametroAntena} (seg√∫n distancia ${distanciaKm.toFixed(2)}km)`);
    if (validarCapacidadAntena(distanciaKm, diametroAntena)) {
      detallesValidacion.push(`‚úÖ Distancia ${distanciaKm.toFixed(2)}km compatible con antenas de ${diametroAntena}`);
      factible = true;
      razon = `Enlace factible - Fibra en A, B vac√≠o, distancia: ${distanciaKm.toFixed(2)}km, antenas: ${diametroAntena}`;
    } else {
      detallesValidacion.push(`‚ùå Distancia ${distanciaKm.toFixed(2)}km excede capacidad de antenas de ${diametroAntena}`);
      factible = false;
      razon = `No factible - Distancia ${distanciaKm.toFixed(2)}km excede capacidad de antenas ${diametroAntena}`;
    }
    return {
      factible,
      razon,
      diametroAntena,
      tipoEnlace: 'Fibra A / B vac√≠o',
      distancia: distanciaKm,
      detalles: detallesValidacion
    };
  }
  if (!transA || !transB) {
    detallesValidacion.push('‚ö†Ô∏è Falta informaci√≥n de tipo de transporte');
    return {
      factible: false,
      razon: 'No factible - Informaci√≥n incompleta de transporte',
      diametroAntena: 'N/A',
      tipoEnlace: 'Datos Incompletos',
      distancia: distanciaKm,
      detalles: detallesValidacion
    };
  }
if (transANorm === transBNorm) {
  const esStarlinkOA = (t) => t.includes('starlink') || t.includes('satelite-oa') || t.includes('sat√©lite-oa');
  if (esStarlinkOA(transANorm) || esStarlinkOA(transBNorm)) {
    detallesValidacion.push(`‚úÖ Ambos sitios tienen el mismo transporte (${transA}) y al menos uno es Starlink o Satelite-OA. Se considera FACTIBLE.`);
    return {
      factible: true,
      razon: `Enlace factible - Mismo tipo de transporte (${transA}) con Starlink/Satelite-OA en A o B.`,
      diametroAntena: 'N/A',
      tipoEnlace: 'Mismo Transporte Satelital',
      distancia: distanciaKm,
      detalles: detallesValidacion
    };
  }
  detallesValidacion.push(`‚ö†Ô∏è Permitiendo mismo tipo de transporte: "${transA}"`);
}
  const esArrendadaA = esArrendada(arreANorm);
  const esArrendadaB = esArrendada(arreBNorm);
if (esArrendadaA || esArrendadaB) {
  diametroAntena = calcularDiametroAntena(distanciaKm, true);
  tipoEnlace = 'Torres Arrendadas';

  detallesValidacion.push(`üìç Torre A: ${esArrendadaA ? 'Arrendada' : 'Propia'}`);
  detallesValidacion.push(`üìç Torre B: ${esArrendadaB ? 'Arrendada' : 'Propia'}`);
  detallesValidacion.push(`üì° Antena asignada: ${diametroAntena} (seg√∫n distancia)`);
  // Solo 1, 2, 3 pies son factibles en torres arrendadas
  if (diametroAntena === '1 pie' || diametroAntena === '2 pies' || diametroAntena === '3 pies') {
    detallesValidacion.push(`‚úÖ Antena de ${diametroAntena} permitida en arrendada`);
    factible = true;
    razon = `Enlace factible - Antena de ${diametroAntena} en torre arrendada`;
  } else {
    detallesValidacion.push(`‚ùå Antena de ${diametroAntena} NO permitida en torre arrendada (solo 1, 2 o 3 pies)`);
    return {
      factible: false,
      razon: `No factible - Solo se permiten antenas de 1, 2 o 3 pies en torres arrendadas`,
      diametroAntena,
      tipoEnlace,
      distancia: distanciaKm,
      detalles: detallesValidacion
    };
  }
  return { factible, razon, diametroAntena, tipoEnlace, distancia: distanciaKm, detalles: detallesValidacion };
}
  const esAdquisicionA = esAdquisicion(arreANorm);
  const esAdquisicionB = esAdquisicion(arreBNorm);
  if (esAdquisicionA && esAdquisicionB) {
  tipoEnlace = 'Torres de Adquisici√≥n';
  detallesValidacion.push('üè¢ Ambas torres son de adquisici√≥n (mayor flexibilidad)');
  if (distanciaKm > 50) {
    factible = false;
    razon = `No factible - Distancia excesiva (${distanciaKm.toFixed(2)}km > 50km)`;
    diametroAntena = 'Cualquiera';
    detallesValidacion.push(`‚ùå Distancia ${distanciaKm.toFixed(2)}km supera el l√≠mite m√°ximo de 50km`);
  } else {
    factible = true;
    razon = `Enlace factible - Torres de adquisici√≥n, sin restricci√≥n de di√°metro de antena`;
     if (distanciaKm <= 5) {
      diametroAntena = '1 a 2 pies';
    } else if (distanciaKm <= 15) {
      diametroAntena = '3 a 4 pies';
    } else {
      diametroAntena = '4 a 6 pies';
    }
    detallesValidacion.push(`‚úÖ Antena recomendada para adquisici√≥n: ${diametroAntena}`);
  }
  return {
    factible,
    razon,
    diametroAntena,
    tipoEnlace,
    distancia: distanciaKm,
    detalles: detallesValidacion
  };
}  else {
  tipoEnlace = 'Torres Mixtas';
  detallesValidacion.push(`üè¢ Torre A: ${esAdquisicionA ? 'Adquisici√≥n' : 'Otro'}, Torre B: ${esAdquisicionB ? 'Adquisici√≥n' : 'Otro'}`);
  diametroAntena = calcularDiametroAntena(distanciaKm, false);
  detallesValidacion.push(`üì° Antenas requeridas: ${diametroAntena} (seg√∫n distancia ${distanciaKm.toFixed(2)}km)`);
  if (validarCapacidadAntena(distanciaKm, diametroAntena)) {
    detallesValidacion.push(`‚úÖ Distancia ${distanciaKm.toFixed(2)}km compatible con antenas de ${diametroAntena}`);
    factible = true;
    razon = `Enlace factible - Fibra+Satelital, distancia: ${distanciaKm.toFixed(2)}km, antenas: ${diametroAntena}`;
  } else {
    detallesValidacion.push(`‚ùå Distancia ${distanciaKm.toFixed(2)}km excede capacidad de antenas de ${diametroAntena}`);
    factible = false;
    razon = `No factible - Distancia ${distanciaKm.toFixed(2)}km excede capacidad de antenas ${diametroAntena}`;
  }
  return {
    factible,
    razon,
    diametroAntena,
    tipoEnlace,
    distancia: distanciaKm,
    detalles: detallesValidacion
  };
}
}
function verificarLineaDeVista(elevaciones, lineaVista, fresnel) {
  for (let i = 0; i < elevaciones.length; i++) {
    if (elevaciones[i] > fresnel[i]) {
      return false;
    }
  }
  return true;
}
// ============================================
// FUNCI√ìN PARA MOSTRAR DETALLES COMPLETOS
// ============================================
function mostrarAnalisisDetallado(factibilidad) {
  // Obtener datos del enlace actual desde la fila seleccionada
  const filaSeleccionada = document.querySelector('#tabla tbody tr.selected') || 
                          document.querySelector('#tabla tbody tr:hover');
  
  let datosEnlace = [];
  if (filaSeleccionada) {
    const celdas = filaSeleccionada.querySelectorAll('td');
    datosEnlace = Array.from(celdas).map(celda => celda.textContent.trim());
  }
  
  // Determinar estado y colores
  let estado = '';
  let color = '';
  let icono = '';
  let bgColor = '';
  
  if (factibilidad.razon && factibilidad.razon.toUpperCase().includes('NO DISPONIBLE')) {
    estado = 'NO DISPONIBLE';
    color = '#f59e42';
    bgColor = '#fef3c7';
    icono = '<i class="fas fa-exclamation-triangle" style="color:#f59e42; font-size: 2rem;"></i>';
  } else if (factibilidad.factible) {
    estado = 'FACTIBLE';
    color = '#10b981';
    bgColor = '#d1fae5';
    icono = '<i class="fas fa-check-circle" style="color:#10b981; font-size: 2rem;"></i>';
  } else {
    estado = 'NO FACTIBLE';
    color = '#ef4444';
    bgColor = '#fee2e2';
    icono = '<i class="fas fa-times-circle" style="color:#ef4444; font-size: 2rem;"></i>';
  }

  // Crear contenido HTML detallado y profesional
  const contenidoHTML = `
    <div style="max-width: 1000px; max-height: 85vh; overflow-y: auto; padding: 0; background: #1a1a1a; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.5);">
      
      <!-- HEADER CON ESTADO -->
      <div style="background: linear-gradient(135deg, ${bgColor}20, ${bgColor}10); border-bottom: 3px solid ${color}; padding: 25px; border-radius: 15px 15px 0 0; text-align: center;">
        <div style="margin-bottom: 15px;">${icono}</div>
        <h2 style="color: ${color}; margin: 0; font-size: 2rem; font-weight: 700; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
          AN√ÅLISIS DETALLADO DEL ENLACE
        </h2>
        <div style="background: ${color}; color: white; padding: 8px 20px; border-radius: 20px; display: inline-block; margin-top: 10px; font-weight: 600; font-size: 1.1rem;">
          ${estado}
        </div>
      </div>

      <!-- CONTENIDO PRINCIPAL -->
      <div style="padding: 30px; display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
        
        <!-- COLUMNA IZQUIERDA - INFORMACI√ìN T√âCNICA -->
        <div style="background: rgba(59, 130, 246, 0.05); padding: 20px; border-radius: 12px; border-left: 4px solid #3b82f6;">
          <h3 style="color: #3b82f6; margin-bottom: 20px; font-size: 1.3rem; display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-cogs"></i> Informaci√≥n T√©cnica
          </h3>
          
          <div style="display: grid; gap: 15px;">
            <div style="background: rgba(59, 130, 246, 0.1); padding: 12px; border-radius: 8px;">
              <strong style="color: #1e40af;">üìè Distancia:</strong> 
              <span style="color: #e5e7eb; font-size: 1.1rem;">${factibilidad.distancia?.toFixed(2) || 'N/A'} km</span>
            </div>
            
            <div style="background: rgba(59, 130, 246, 0.1); padding: 12px; border-radius: 8px;">
              <strong style="color: #1e40af;">üì° Frecuencia:</strong> 
              <span style="color: #e5e7eb; font-size: 1.1rem;">${factibilidad.frecuencia || 'N/A'} GHz</span>
            </div>
            
            <div style="background: rgba(59, 130, 246, 0.1); padding: 12px; border-radius: 8px;">
              <strong style="color: #1e40af;">üõ∞Ô∏è Tipo de Enlace:</strong> 
              <span style="color: #e5e7eb; font-size: 1.1rem;">${factibilidad.tipoEnlace || 'N/A'}</span>
            </div>
            
            <div style="background: rgba(59, 130, 246, 0.1); padding: 12px; border-radius: 8px;">
              <strong style="color: #1e40af;">üì° Antenas Requeridas:</strong> 
              <span style="color: #e5e7eb; font-size: 1.1rem;">${factibilidad.diametroAntena || 'N/A'}</span>
            </div>
            
            <div style="background: rgba(59, 130, 246, 0.1); padding: 12px; border-radius: 8px;">
              <strong style="color: #1e40af;">üìä Disponibilidad:</strong> 
              <span style="color: #e5e7eb; font-size: 1.1rem;">${factibilidad.disponibilidad || '99.99%'}</span>
            </div>
          </div>
        </div>

        <!-- COLUMNA DERECHA - DATOS DE SITIOS -->
        <div style="background: rgba(16, 185, 129, 0.05); padding: 20px; border-radius: 12px; border-left: 4px solid #10b981;">
          <h3 style="color: #10b981; margin-bottom: 20px; font-size: 1.3rem; display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-map-marker-alt"></i> Datos de Sitios
          </h3>
          
          <div style="display: grid; gap: 15px;">
            <div style="background: rgba(16, 185, 129, 0.1); padding: 12px; border-radius: 8px;">
              <strong style="color: #047857;">üè¢ Sitio A:</strong> 
              <span style="color: #e5e7eb; font-size: 1.1rem;">${datosEnlace[1] || 'N/A'} (${datosEnlace[0] || 'N/A'})</span>
            </div>
            
            <div style="background: rgba(16, 185, 129, 0.1); padding: 12px; border-radius: 8px;">
              <strong style="color: #047857;">üìç Coordenadas A:</strong> 
              <span style="color: #e5e7eb; font-size: 1.1rem;">${datosEnlace[2] || 'N/A'}, ${datosEnlace[3] || 'N/A'}</span>
            </div>
            
            <div style="background: rgba(16, 185, 129, 0.1); padding: 12px; border-radius: 8px;">
              <strong style="color: #047857;">üè¢ Sitio B:</strong> 
              <span style="color: #e5e7eb; font-size: 1.1rem;">${datosEnlace[7] || 'N/A'} (${datosEnlace[6] || 'N/A'})</span>
            </div>
            
            <div style="background: rgba(16, 185, 129, 0.1); padding: 12px; border-radius: 8px;">
              <strong style="color: #047857;">üìç Coordenadas B:</strong> 
              <span style="color: #e5e7eb; font-size: 1.1rem;">${datosEnlace[8] || 'N/A'}, ${datosEnlace[9] || 'N/A'}</span>
            </div>
            
            <div style="background: rgba(16, 185, 129, 0.1); padding: 12px; border-radius: 8px;">
              <strong style="color: #047857;">üó∫Ô∏è Estados:</strong> 
              <span style="color: #e5e7eb; font-size: 1.1rem;">${datosEnlace[26] || 'N/A'} ‚Üí ${datosEnlace[27] || 'N/A'}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- SECCI√ìN DE INFRAESTRUCTURA -->
      <div style="padding: 0 30px 30px 30px;">
        <div style="background: rgba(245, 158, 11, 0.05); padding: 20px; border-radius: 12px; border-left: 4px solid #f59e0b; margin-bottom: 20px;">
          <h3 style="color: #f59e0b; margin-bottom: 20px; font-size: 1.3rem; display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-building"></i> Infraestructura y Estado
          </h3>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
            <div style="background: rgba(245, 158, 11, 0.1); padding: 12px; border-radius: 8px;">
              <strong style="color: #d97706;">üèóÔ∏è Torres:</strong> 
              <span style="color: #e5e7eb;">${datosEnlace[24] || 'N/A'} / ${datosEnlace[25] || 'N/A'}</span>
            </div>
            
            <div style="background: rgba(245, 158, 11, 0.1); padding: 12px; border-radius: 8px;">
              <strong style="color: #d97706;">üì° Alturas:</strong> 
              <span style="color: #e5e7eb;">${buscarAlturaEnColumnas(datosEnlace, 'Torre A') || 'N/A'}m / ${buscarAlturaEnColumnas(datosEnlace, 'Torre B') || 'N/A'}m</span>
            </div>
            
            <div style="background: rgba(245, 158, 11, 0.1); padding: 12px; border-radius: 8px;">
              <strong style="color: #d97706;">üöö Transporte:</strong> 
              <span style="color: #e5e7eb;">${datosEnlace[18] || 'N/A'} / ${datosEnlace[19] || 'N/A'}</span>
            </div>
            
            <div style="background: rgba(245, 158, 11, 0.1); padding: 12px; border-radius: 8px;">
              <strong style="color: #d97706;">üìã Arrendamiento:</strong> 
              <span style="color: #e5e7eb;">${datosEnlace[20] || 'N/A'} / ${datosEnlace[21] || 'N/A'}</span>
            </div>
            
            <div style="background: rgba(245, 158, 11, 0.1); padding: 12px; border-radius: 8px;">
              <strong style="color: #d97706;">‚ö° Estado Operativo:</strong> 
              <span style="color: #e5e7eb;">${datosEnlace[22] || 'N/A'} / ${datosEnlace[23] || 'N/A'}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- SECCI√ìN DE AN√ÅLISIS Y RECOMENDACIONES -->
      <div style="padding: 0 30px 30px 30px;">
        <div style="background: rgba(139, 92, 246, 0.05); padding: 20px; border-radius: 12px; border-left: 4px solid #8b5cf6;">
          <h3 style="color: #8b5cf6; margin-bottom: 20px; font-size: 1.3rem; display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-chart-line"></i> An√°lisis y Recomendaciones
          </h3>
          
          <div style="background: rgba(139, 92, 246, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <strong style="color: #7c3aed;">üéØ Motivo Principal:</strong>
            <div style="color: #e5e7eb; margin-top: 8px; font-size: 1.1rem; line-height: 1.5;">
              ${factibilidad.razon || 'An√°lisis no disponible'}
            </div>
          </div>
          
          ${factibilidad.detalles && factibilidad.detalles.length > 0 ? `
            <div style="background: rgba(139, 92, 246, 0.1); padding: 15px; border-radius: 8px;">
              <strong style="color: #7c3aed;">üìã Detalles Adicionales:</strong>
              <ul style="color: #e5e7eb; margin-top: 8px; padding-left: 20px; line-height: 1.6;">
                ${factibilidad.detalles.map(det => `<li>${det}</li>`).join('')}
              </ul>
            </div>
          ` : ''}
        </div>
      </div>

      <!-- BOTONES DE ACCI√ìN -->
      <div style="padding: 0 30px 30px 30px; text-align: center;">
        <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
          <button onclick="cerrarModalAnalisis()" style="
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
          " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(0,0,0,0.3)'" 
             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.2)'">
            <i class="fas fa-times"></i> Cerrar
          </button>
          
          <button onclick="exportarEnlaceIndividual()" style="
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
          " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(0,0,0,0.3)'" 
             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.2)'">
            <i class="fas fa-download"></i> Exportar Enlace
          </button>
          
          <button onclick="mostrarPerfilElevacion()" style="
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
          " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(0,0,0,0.3)'" 
             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.2)'">
            <i class="fas fa-mountain"></i> Perfil Elevaci√≥n
          </button>
        </div>
      </div>
    </div>
  `;

  // Crear modal din√°mico si no existe
  let modal = document.getElementById('modal-analisis-detallado');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'modal-analisis-detallado';
    modal.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      backdrop-filter: blur(5px);
    `;
    document.body.appendChild(modal);
  }

  modal.innerHTML = contenidoHTML;
  modal.style.display = 'flex';
  
  // Cerrar modal al hacer clic fuera
  modal.onclick = function(e) {
    if (e.target === modal) {
      cerrarModalAnalisis();
    }
  };
}
function cerrarModalAnalisis() {
  const modal = document.getElementById('modal-analisis-detallado');
  if (modal) {
    modal.style.display = 'none';
  }
}

// Funci√≥n para exportar enlace individual
function exportarEnlaceIndividual() {
  const filaSeleccionada = document.querySelector('#tabla tbody tr.selected') || 
                          document.querySelector('#tabla tbody tr:hover');
  
  if (!filaSeleccionada) {
    alert('‚ùå No hay enlace seleccionado para exportar');
    return;
  }
  
  const celdas = filaSeleccionada.querySelectorAll('td');
  const datosEnlace = Array.from(celdas).map(celda => celda.textContent.trim());
  
  // Usar la funci√≥n de detecci√≥n autom√°tica de alturas
  const alturaA = buscarAlturaEnColumnas(datosEnlace, 'Torre A');
  const alturaB = buscarAlturaEnColumnas(datosEnlace, 'Torre B');
  
  // Crear objeto con datos del enlace
  const enlaceExport = {
    idA: datosEnlace[0],
    nombreA: datosEnlace[1],
    latA: datosEnlace[2],
    lonA: datosEnlace[3],
    idB: datosEnlace[6],
    nombreB: datosEnlace[7],
    latB: datosEnlace[8],
    lonB: datosEnlace[9],
    distancia: datosEnlace[12],
    frecuencia: datosEnlace[13],
    disponibilidad: datosEnlace[14],
    alturaTorreA: alturaA,
    alturaTorreB: alturaB,
    tipoTorreA: datosEnlace[24],
    tipoTorreB: datosEnlace[25],
    estadoA: datosEnlace[26],
    estadoB: datosEnlace[27],
    factible: datosEnlace[28],
    fechaExportacion: new Date().toISOString()
  };
  
  // Crear archivo JSON
  const contenido = JSON.stringify(enlaceExport, null, 2);
  const blob = new Blob([contenido], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  
  // Descargar archivo
  const a = document.createElement('a');
  a.href = url;
  a.download = `enlace_${datosEnlace[0]}_${datosEnlace[6]}_${new Date().toISOString().split('T')[0]}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  mostrarNotificacion('‚úÖ Enlace exportado correctamente', 'success');
}

// Funci√≥n para mostrar perfil de elevaci√≥n
function mostrarPerfilElevacion() {
  const filaSeleccionada = document.querySelector('#tabla tbody tr.selected') || 
                          document.querySelector('#tabla tbody tr:hover');
  
  if (!filaSeleccionada) {
    alert('‚ùå No hay enlace seleccionado para mostrar perfil de elevaci√≥n');
    return;
  }
  
  const celdas = filaSeleccionada.querySelectorAll('td');
  const datosEnlace = Array.from(celdas).map(celda => celda.textContent.trim());
  
  // Obtener coordenadas
  const latA = parseFloat(datosEnlace[2]);
  const lonA = parseFloat(datosEnlace[3]);
  const latB = parseFloat(datosEnlace[8]);
  const lonB = parseFloat(datosEnlace[9]);
  
  if (isNaN(latA) || isNaN(lonA) || isNaN(latB) || isNaN(lonB)) {
    alert('‚ùå Coordenadas inv√°lidas para generar perfil de elevaci√≥n');
    return;
  }
  
  // Crear URL para perfil de elevaci√≥n
  const url = `perfil_elevacion.html?latA=${latA}&lonA=${lonA}&latB=${latB}&lonB=${lonB}&nombreA=${encodeURIComponent(datosEnlace[1])}&nombreB=${encodeURIComponent(datosEnlace[7])}`;
  
  // Abrir en nueva pesta√±a
  window.open(url, '_blank');
  
  mostrarNotificacion('üó∫Ô∏è Abriendo perfil de elevaci√≥n en nueva pesta√±a', 'info');
}

// Funci√≥n para recalcular la factibilidad de todos los enlaces existentes
function recalcularFactibilidadEnlaces() {
  const enlacesGuardados = localStorage.getItem('enlacesPtP');
  if (!enlacesGuardados) return;
  
  const enlaces = JSON.parse(enlacesGuardados);
  const enlacesActualizados = [];
  
  enlaces.forEach(enlaceData => {
    const distanciaKm = parseFloat(enlaceData[12]); // √çndice 12 es la distancia
    const arreA = enlaceData[20]; // √çndice 20 es ArreA
    const arreB = enlaceData[21]; // √çndice 21 es ArreB
    const transA = enlaceData[18]; // √çndice 18 es TransA
    const transB = enlaceData[19]; // √çndice 19 es TransB
    const torreA = enlaceData[24]; // √çndice 24 es TorreA
    const torreB = enlaceData[25]; // √çndice 25 es TorreB
    const onA = enlaceData[22]; // √çndice 22 es OnA
    const onB = enlaceData[23]; // √çndice 23 es OnB
    
    // Recalcular factibilidad con la nueva l√≥gica
    const factibilidad = analizarFactibilidad(
      distanciaKm,
      arreA,
      arreB,
      transA,
      transB,
      torreA,
      torreB,
      onA,
      onB,
      true // Asumir que la l√≠nea de vista es factible
    );
    
    // Actualizar el estado factible
    const estadoFactible = factibilidad.factible ? 'S√ç' : 'NO';
    
    // Crear nueva fila de datos con la factibilidad actualizada
    const nuevaFila = [...enlaceData];
    nuevaFila[28] = estadoFactible; // √çndice 28 es el estado factible
    nuevaFila[33] = JSON.stringify(factibilidad); // √çndice 33 es el an√°lisis JSON
    
    enlacesActualizados.push(nuevaFila);
  });
  
  // Guardar los enlaces actualizados
  localStorage.setItem('enlacesPtP', JSON.stringify(enlacesActualizados));
  
  // Recargar la tabla
  cargarEnlacesDeStorageModo('normal');
  
  // Mostrar notificaci√≥n
  mostrarNotificacion('‚úÖ Factibilidad de enlaces recalculada correctamente', 'success');
}
function agregarOActualizarEnlace() {
  const get = id => document.getElementById(id).value.trim();
  const latA = parseFloat(get('latA'));
  const lonA = parseFloat(get('lonA'));
  const latB = parseFloat(get('latB'));
  const lonB = parseFloat(get('lonB'));
  if (!get('idA') || !get('idB')) {
    alert('‚ùå Error: Debes ingresar ID A y ID B');
    return;
  }
  if (isNaN(latA) || isNaN(lonA) || isNaN(latB) || isNaN(lonB)) {
    alert('‚ùå Error: Las coordenadas deben ser n√∫meros v√°lidos para ambos sitios');
    return;
  }
  const distanciaKm = calcularDistancia(latA, lonA, latB, lonB);
  const frecuencia = asignarFrecuencia(distanciaKm);
  const factibilidad = analizarFactibilidad(
    distanciaKm,
    get('ArreA'),
    get('ArreB'),
    get('TransA'),
    get('TransB'),
    get('TorreA'),
    get('TorreB'),
    get('OnA'),
    get('OnB'),
    window.ultimaFactibilidadLOS
  );
  const estadoFactible = (factibilidad.advertencia)
    ? 'FACTIBLE (Requiere an√°lisis)'
    : (factibilidad.razon && factibilidad.razon.toUpperCase().includes('NO DISPONIBLE'))
      ? 'NO DISPONIBLE'
      : (factibilidad.factible ? 'S√ç' : 'NO');
  const filaDatos = [
    get('idA'), get('nombreA'), get('latA'), get('lonA'),
    document.getElementById('latArad').value,
    document.getElementById('lonArad').value,
    get('idB'), get('nombreB'), get('latB'), get('lonB'),
    document.getElementById('latBrad').value,
    document.getElementById('lonBrad').value,
    distanciaKm.toFixed(6), frecuencia,
    document.getElementById('disponibilidadAnual').value,
    get('alturaA'), get('alturaB'), get('ranA'), get('ranB'),
    get('TransA'), get('TransB'), get('ArreA'), get('ArreB'),
    get('OnA'), get('OnB'), get('TorreA'), get('TorreB'),
    get('EstadoA'), get('EstadoB'),
    estadoFactible,
    factibilidad.diametroAntena,
    factibilidad.tipoEnlace,
    JSON.stringify(factibilidad)
  ];
  const esMismoTransporte = (
    permitirMismoTransporte &&
    get('TransA').toLowerCase() === get('TransB').toLowerCase()
  );
  if (esMismoTransporte) {
    let enlaces = JSON.parse(localStorage.getItem('enlacesMismoTransporte') || '[]');
    enlaces.push(filaDatos);
    localStorage.setItem('enlacesMismoTransporte', JSON.stringify(enlaces));
    mostrarPestana('mismoTransporte');
    mostrarTablaMismoTransporte();
    limpiarFormulario();
    return;
  }
  if (permitirMismoTransporte) {
    limpiarFormulario();
    return;
  }
  if (filaEditando) {
    const celdas = filaEditando.querySelectorAll('td');
    filaDatos.forEach((val, i) => {
      if (!celdas[i]) return;
      if (i === 33) {
        celdas[i].innerHTML = '';
        const btn = document.createElement('button');
        btn.className = 'btn btn-info btn-sm';
        btn.innerHTML = '<i class="fas fa-info-circle"></i> Ver An√°lisis';
        btn.onclick = function(e) {
          e.stopPropagation();
          try {
            const analisis = JSON.parse(val);
            mostrarAnalisisDetallado(analisis);
          } catch {
            alert('No hay an√°lisis detallado disponible.');
          }
        };
        celdas[i].appendChild(btn);
        celdas[i].dataset.analisis = val;
      } else {
        celdas[i].textContent = val;
      }
    });
    aplicarEstiloFactibilidad(filaEditando, factibilidad.factible);
    filaEditando.classList.remove('selected');
    filaEditando = null;
    document.getElementById('agregarBtn').innerHTML = '<i class="fas fa-check"></i> Agregar Enlace';
    document.getElementById('eliminarBtn').disabled = true;
  } else {
    const fila = document.createElement('tr');
    const tdCheck = document.createElement('td');
    const check = document.createElement('input');
    check.type = 'checkbox';
    check.className = 'check-enlace';
    check.onclick = function(e) {
      e.stopPropagation();
      actualizarBotonEliminarSeleccionados();
    };
    tdCheck.appendChild(check);
    fila.appendChild(tdCheck);

    filaDatos.forEach((val, i) => {
      const td = document.createElement('td');
      if (i === 33) {
        const btn = document.createElement('button');
        btn.className = 'btn btn-info btn-sm';
        btn.innerHTML = '<i class="fas fa-info-circle"></i> Ver An√°lisis';
        btn.onclick = function(e) {
          e.stopPropagation();
          try {
            const analisis = JSON.parse(val);
            mostrarAnalisisDetallado(analisis);
          } catch {
            alert('No hay an√°lisis detallado disponible.');
          }
        };
        td.appendChild(btn);
        td.dataset.analisis = val;
      } else {
        td.textContent = val;
      }
      fila.appendChild(td);
    });
    document.querySelector('#tabla tbody').appendChild(fila);
  }
  
  // Actualizar sistema de tabla interactiva
  actualizarTablaInteractiva();
  
  actualizarContadorEnlaces();
  verificarEnlacesVacios();
  ordenarTablaPorFactibilidad();
  mostrarPestana('enlaces');
  guardarEnlacesEnStorage();
}
function aplicarEstiloFactibilidad(fila, esFactible, razon = "") {
  fila.classList.remove('enlace-factible', 'enlace-no-factible');
  const celdas = fila.querySelectorAll('td');
  if (celdas[28]) {
    celdas[28].classList.remove('factible', 'no-factible');
    if (esFactible) {
      fila.classList.add('enlace-factible');
      celdas[28].classList.add('factible');
      celdas[28].title = razon || "Enlace factible";
    } else {
      fila.classList.add('enlace-no-factible');
      celdas[28].classList.add('no-factible');
      celdas[28].title = razon || "Enlace no factible";
    }
  }
}
function cargarFilaEnFormulario(fila) {
  const celdas = fila.querySelectorAll('td');
 const ids = [
  'idA','nombreA','latA','lonA','latArad','lonArad',
  'idB','nombreB','latB','lonB','latBrad','lonBrad',
  'distancia','frecuencia','disponibilidadAnual', 
  'alturaA', 
  'alturaB', 
  'ranA','ranB','TransA','TransB','ArreA','ArreB',
  'OnA','OnB','TorreA','TorreB','EstadoA','EstadoB'
];
  ids.forEach((id, i) => {
    if (document.getElementById(id) && celdas[i+1]) {
      let valor = celdas[i+1].textContent.trim();
      if (['latA','lonA','latB','lonB','alturaA','alturaB','frecuencia'].includes(id)) {
        valor = valor.replace(',', '.').replace(/[^0-9\.\-]/g, '');
      }
      document.getElementById(id).value = valor;
    }
  });
  actualizarCalculos();
}
function validarFactibilidadEnTiempoReal() {
  const campos = ['latA', 'lonA', 'latB', 'lonB', 'ArreA', 'ArreB', 'TransA', 'TransB'];
  campos.forEach(campo => {
    const elemento = document.getElementById(campo);
    if (elemento) {
      elemento.addEventListener('blur', () => {
        mostrarVistaPrevia();
      });
    }
  });
}
function mostrarVistaPrevia() {
  const get = id => document.getElementById(id).value.trim();
  const latA = parseFloat(get('latA'));
  const lonA = parseFloat(get('lonA'));
  const latB = parseFloat(get('latB'));
  const lonB = parseFloat(get('lonB'));
  if (latA && lonA && latB && lonB) {
    const distanciaKm = calcularDistancia(latA, lonA, latB, lonB);
    const factibilidad = analizarFactibilidad(
      distanciaKm,
      get('ArreA'),
      get('ArreB'),
      get('TransA'),
      get('TransB')
    );
    const preview = document.getElementById('vista-previa');
    if (preview) {
      const color = factibilidad.factible ? '#10b981' : '#ef4444';
      const icono = factibilidad.factible ? '‚úÖ' : '‚ùå';
      preview.innerHTML = `
        <div style="color: ${color}; font-weight: bold;">
          ${icono} ${factibilidad.factible ? 'FACTIBLE' : 'NO FACTIBLE'}
          <br><small>${factibilidad.razon}</small>
        </div>
      `;
    }
  }
}
function eliminarEnlace() {
  if (!filaEditando) {
    alert('‚ö†Ô∏è Debes seleccionar una fila para eliminar');
    return;
  }
  const idA = filaEditando.querySelector('td:first-child').textContent;
  const idB = filaEditando.querySelector('td:nth-child(7)').textContent;
  if (!confirm(`¬øSeguro quieres eliminar el enlace entre ${idA} y ${idB}?`)) {
    return;
  }
  filaEditando.remove();
  filaEditando = null;
  limpiarFormulario();
  document.getElementById('agregarBtn').innerHTML = '<i class="fas fa-check"></i> Agregar Enlace';
  document.getElementById('eliminarBtn').disabled = true;
  actualizarContadorEnlaces();
  verificarEnlacesVacios();
if (
  permitirMismoTransporte &&
  document.getElementById('TransA').value.trim().toLowerCase() === document.getElementById('TransB').value.trim().toLowerCase()
) {
  guardarEnlacesEnStorageModo("mismo");
} else {
  guardarEnlacesEnStorageModo("normal");
}
  alert('‚úÖ Enlace eliminado correctamente');
}
 function limpiarFormulario() { 
  const campos = [
    'idA','nombreA','latA','lonA','latArad','lonArad',
    'idB','nombreB','latB','lonB','latBrad','lonBrad',
    'distancia','frecuencia','alturaA','alturaB','ranA','ranB',
    'TransA','TransB','ArreA','ArreB','OnA','OnB','TorreA','TorreB','EstadoA','EstadoB'
  ];
     campos.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });
  document.getElementById('agregarBtn').innerHTML = '<i class="fas fa-check"></i> Agregar Enlace';
  document.getElementById('eliminarBtn').disabled = true;
  filaEditando = null;
  window.ultimaFactibilidadLOS = undefined;
}
  function exportarExcel() {
  const filasNormales = Array.from(document.querySelectorAll('#tabla tbody tr'));
  const filasMismo = [];
  const tablaMismo = document.getElementById('tabla-mismo-tipo');
  if (tablaMismo) {
    Array.from(tablaMismo.querySelectorAll('tbody tr')).forEach(tr => filasMismo.push(tr));
  }
  const filas = filasNormales.concat(filasMismo);

  if (filas.length === 0) {
    alert('No hay enlaces para exportar');
    return;
  }
  const encabezado = [
    'ID A','Nombre A','Latitud A','Longitud A','Lat A (rad)','Lon A (rad)',
    'ID B','Nombre B','Latitud B','Longitud B','Lat B (rad)','Lon B (rad)',
    'Distancia (km)','Frecuencia (GHz)','Disponibilidad',
    'Altura Torre A','Altura Torre B','Altura RAN A','Altura RAN B',
    'Transporte A','Transporte B','Arrendamiento A','Arrendamiento B',
    'On Air A','On Air B','Tipo Torre A','Tipo Torre B','Estado A','Estado B',
    'Factible','Antenas','Tipo Enlace','An√°lisis'
  ];
  const datos = filas.map(fila => {
    const c = fila.querySelectorAll('td');
    return Array.from({length: 33}, (_, i) => c[i+1]?.textContent || "");
  });
  const wsData = [encabezado].concat(datos);
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(wsData);
  XLSX.utils.book_append_sheet(wb, ws, "EnlacesPtP");
  XLSX.writeFile(wb, "enlaces_ptp.xlsx");
}
// DESHABILITADO: Event listener duplicado que causaba bucles
/*
document.addEventListener('DOMContentLoaded', function() {
  const btnBorrarPares = document.getElementById('borrar-archivo-pares');
if (btnBorrarPares) {
  btnBorrarPares.addEventListener('click', borrarArchivoPares);
}
  document.getElementById('eliminarBtn').addEventListener('click', eliminarEnlace);
  const btnBorrar = document.getElementById('borrar-archivo');
  if (btnBorrar) {
    btnBorrar.addEventListener('click', borrarArchivo);
  }
  cargarArchivoDeStorage();
  cargarEnlacesDeStorage();
  actualizarContadorEnlaces();
  verificarEnlacesVacios();
  cargarArchivoParesDeStorage();
});
*/
let enlacesSeleccionados = new Set();
function seleccionarTodo() {
  const tabla = document.querySelector('.seleccion-container table tbody');
  if (!tabla) return;
  const filas = tabla.querySelectorAll('tr');
  filas.forEach(fila => {
    fila.classList.add('selected');
    enlacesSeleccionados.add(fila.dataset.id);
  });
  actualizarContadorSeleccionados();
  document.getElementById('eliminarSeleccionadosBtn').disabled = false;
}
function deseleccionarTodo() {
  const tabla = document.querySelector('.seleccion-container table tbody');
  if (!tabla) return;
  const filas = tabla.querySelectorAll('tr');
  filas.forEach(fila => {
    fila.classList.remove('selected');
  });
  enlacesSeleccionados.clear();
  actualizarContadorSeleccionados();
  document.getElementById('eliminarSeleccionadosBtn').disabled = true;
}
function actualizarContadorSeleccionados() {
  document.getElementById('enlaces-seleccionados').textContent = enlacesSeleccionados.size;
}
function eliminarSeleccionados() {
  if (enlacesSeleccionados.size === 0) {
    alert('‚ö†Ô∏è Debes seleccionar al menos un enlace para eliminar');
    return;
  }
  if (!confirm(`¬øSeguro quieres eliminar ${enlacesSeleccionados.size} enlaces seleccionados?`)) {
    return;
  }
  enlacesSeleccionados.forEach(id => {
    const fila = document.querySelector(`tr[data-id="${id}"]`);
    if (fila) fila.remove();
  });
  enlacesSeleccionados.clear();
  actualizarContadorSeleccionados();
  actualizarContadorEnlaces();
  verificarEnlacesVacios();
  guardarEnlacesEnStorage();
  document.getElementById('eliminarSeleccionadosBtn').disabled = true;
  alert('‚úÖ Enlaces eliminados correctamente');
}
window.mostrarPestana = function(pestana, event) {
  // PROTECCI√ìN CONTRA BUCLE INFINITO
  if (window.navegandoPestana) {
    console.log('‚ö†Ô∏è Navegaci√≥n ya en curso, ignorando llamada...');
    return;
  }
  
  window.navegandoPestana = true;
  console.log('üîÑ Cambiando a pesta√±a:', pestana);
  
  try {
    // Ocultar todas las pesta√±as
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    
    // Mostrar la pesta√±a seleccionada
    const tabContent = document.getElementById('tab-' + pestana);
    if (tabContent) {
      tabContent.classList.add('active');
      console.log('‚úÖ Pesta√±a activada:', pestana);
      
      // Mostrar notificaci√≥n de √©xito
      mostrarNotificacion(`‚úÖ Cambiado a: ${pestana}`, 'success');
    } else {
      console.log('‚ö†Ô∏è Pesta√±a no encontrada:', pestana);
      mostrarNotificacion(`‚ö†Ô∏è Pesta√±a no encontrada: ${pestana}`, 'warning');
    }
    
    // Activar el bot√≥n correspondiente
    if (event) {
      event.currentTarget.classList.add('active');
    }
    
    // L√≥gica espec√≠fica para cada pesta√±a
    if (pestana === 'enlaces') {
      console.log('üìä Cargando enlaces normales...');
      if (window.permitirMismoTransporte) {
        const tabla = document.querySelector('#tabla tbody');
        if (tabla) tabla.innerHTML = '';
        if (typeof window.actualizarContadorEnlaces === 'function') {
          window.actualizarContadorEnlaces();
        }
        if (typeof window.verificarEnlacesVacios === 'function') {
          window.verificarEnlacesVacios();
        }
      } else {
        if (typeof window.cargarEnlacesDeStorageModo === 'function') {
          window.cargarEnlacesDeStorageModo("normal");
        }
        if (typeof window.ordenarTablaPorFactibilidad === 'function') {
          window.ordenarTablaPorFactibilidad();
        }
      }
    }
    
    if (pestana === 'resumen') {
      console.log('üìà Cargando resumen...');
      
      // Actualizar contadores primero
      actualizarResumenEnlaces();
      
      // Cargar mapa con enlaces reales
      if (typeof window.inicializarMapa === 'function') {
        setTimeout(() => {
          console.log('üó∫Ô∏è Inicializando mapa...');
          window.inicializarMapa();
        }, 500); // Peque√±o delay para asegurar que el DOM est√© listo
      } else {
        console.log('‚ö†Ô∏è Funci√≥n inicializarMapa no disponible');
        mostrarNotificacion('‚ö†Ô∏è Funci√≥n de mapa no disponible', 'warning');
      }
    }
    
    if (pestana === 'mismoTransporte') {
      console.log('üîÑ Cargando mismo transporte...');
      if (typeof window.mostrarTablaMismoTransporte === 'function') {
        window.mostrarTablaMismoTransporte();
      } else {
        console.log('‚ö†Ô∏è Funci√≥n mostrarTablaMismoTransporte no disponible');
        mostrarNotificacion('‚ö†Ô∏è Funci√≥n de mismo transporte no disponible', 'warning');
      }
    }
    
    // Actualizar contadores
    if (typeof window.actualizarContadorEnlaces === 'function') {
      window.actualizarContadorEnlaces();
    }
    if (typeof window.verificarEnlacesVacios === 'function') {
      window.verificarEnlacesVacios();
    }
    
    // CORRECCI√ìN AUTOM√ÅTICA: Corregir ESTADO A al cambiar de pesta√±a
    setTimeout(() => {
      console.log('üîß Aplicando correcci√≥n autom√°tica de ESTADO A al cambiar pesta√±a...');
      const filas = document.querySelectorAll('#tabla tbody tr');
      let corregidos = 0;
      
      filas.forEach((fila, index) => {
        const celdas = fila.querySelectorAll('td');
        if (celdas.length >= 4) {
          const estadoA = celdas[2]?.textContent?.trim() || '';
          const estadoB = celdas[3]?.textContent?.trim() || '';
          
          if (estadoA === 'No Factible' && estadoB && estadoB !== 'No Factible') {
            celdas[2].textContent = estadoB;
            corregidos++;
            console.log(`‚úÖ Enlace ${index + 1} corregido al cambiar pesta√±a: ESTADO A "No Factible" ‚Üí "${estadoB}"`);
          }
        }
      });
      
      if (corregidos > 0) {
        console.log(`‚úÖ Correcci√≥n al cambiar pesta√±a completada: ${corregidos} enlaces corregidos`);
      }
    }, 500);
    
    console.log('‚úÖ Navegaci√≥n completada a:', pestana);
    
  } catch (error) {
    console.error('‚ùå Error en navegaci√≥n:', error);
    mostrarNotificacion('‚ùå Error al cambiar de pesta√±a', 'error');
  } finally {
    // Limpiar flag de navegaci√≥n
    window.navegandoPestana = false;
  }
}

// Funci√≥n para limpiar todos los flags de bucle
window.limpiarFlagsBucle = function() {
  console.log('üßπ Limpiando flags de bucle...');
  window.navegandoPestana = false;
  window.enlacesModoCargados = false;
  window.procesandoPares = false;
  window.procesamientoCompletado = false;
  console.log('‚úÖ Flags de bucle limpiados');
}

// Funci√≥n para verificar disponibilidad de funciones al cargar
window.verificarFuncionesDisponibles = function() {
  console.log('üîç Verificando funciones disponibles...');
  
  const funciones = [
    'mostrarMapaEnlaces',
    'cargarMapaConEnlaces',
    'mostrarPestana',
    'actualizarResumenEnlaces'
  ];
  
  funciones.forEach(func => {
    if (typeof window[func] === 'function') {
      console.log(`‚úÖ ${func} disponible`);
    } else {
      console.log(`‚ùå ${func} NO disponible`);
    }
  });
  
  // Verificar Leaflet
  if (typeof L === 'undefined') {
    console.log('‚ùå Leaflet no disponible');
  } else {
    console.log('‚úÖ Leaflet disponible (v' + L.version + ')');
  }
}

// Funci√≥n para forzar actualizaci√≥n de contadores
window.forzarActualizacionContadores = function() {
  console.log('üîÑ Forzando actualizaci√≥n de contadores...');
  
  // Actualizar contadores inmediatamente
  actualizarResumenEnlaces();
  
  // Verificar elementos
  const totalElement = document.getElementById('resumen-total-enlaces');
  const factiblesElement = document.getElementById('resumen-enlaces-factibles');
  
  if (totalElement && factiblesElement) {
    console.log('‚úÖ Elementos de contadores encontrados');
    console.log('üìä Total:', totalElement.textContent);
    console.log('üìä Factibles:', factiblesElement.textContent);
  } else {
    console.log('‚ö†Ô∏è Elementos de contadores no encontrados');
  }
  
  // Verificar enlaces en la tabla
  const filas = document.querySelectorAll('#tabla tbody tr');
  console.log('üìã Filas en tabla principal:', filas.length);
  
  const factibles = Array.from(filas).filter(fila => {
    const celdas = fila.querySelectorAll('td');
    const val = celdas[30]?.textContent.trim().toUpperCase();
    return val === 'S√ç' || val.startsWith('FACTIBLE');
  });
  
  console.log('‚úÖ Enlaces factibles encontrados:', factibles.length);
  
  // Mostrar notificaci√≥n
  mostrarNotificacion(`üìä Contadores actualizados: ${filas.length} total, ${factibles.length} factibles`, 'success');
}

// Funci√≥n para probar el mapa
window.probarMapa = function() {
  console.log('üß™ Probando mapa...');
  
  try {
    // Verificar si estamos en la pesta√±a correcta
    const pestanaActual = document.querySelector('.pestana-activa');
    console.log('üìç Pesta√±a actual:', pestanaActual?.id);
    
    // Verificar elemento del mapa
    const divMapa = document.getElementById('mapa-enlaces');
    if (divMapa) {
      console.log('‚úÖ Elemento mapa-enlaces encontrado');
      console.log('üìè Dimensiones:', divMapa.offsetWidth, 'x', divMapa.offsetHeight);
      console.log('üëÅÔ∏è Visible:', divMapa.offsetParent !== null);
    } else {
      console.log('‚ùå Elemento mapa-enlaces NO encontrado');
    }
    
    // Verificar Leaflet
    if (typeof L === 'undefined') {
      console.log('‚ùå Leaflet no disponible');
    } else {
      console.log('‚úÖ Leaflet disponible');
    }
    
    // Intentar cargar mapa
    if (typeof window.mostrarMapaEnlaces === 'function') {
      console.log('üéØ Llamando a mostrarMapaEnlaces...');
      window.mostrarMapaEnlaces(null);
    } else {
      console.log('‚ùå Funci√≥n mostrarMapaEnlaces no disponible');
    }
    
  } catch (error) {
    console.error('‚ùå Error al probar mapa:', error);
  }
}

// Funci√≥n para cargar mapa con enlaces reales MEJORADA
window.cargarMapaConEnlaces = function() {
  console.log('üó∫Ô∏è Cargando mapa PROFESIONAL con torres...');
  
  try {
    // Verificar Leaflet
    if (typeof L === 'undefined') {
      console.error('‚ùå Leaflet no disponible');
      mostrarNotificacion('‚ùå Leaflet no disponible', 'error');
      return;
    }
    
    // Verificar elemento del mapa
    const divMapa = document.getElementById('mapa-enlaces');
    if (!divMapa) {
      console.error('‚ùå Elemento mapa-enlaces no encontrado');
      mostrarNotificacion('‚ùå Elemento del mapa no encontrado', 'error');
      return;
    }
    
    // Mejorar el estilo del contenedor del mapa
    divMapa.style.cssText = `
      width: 100%;
      max-width: 1200px;
      height: 600px;
      margin: 20px auto;
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      border: 3px solid rgba(59,130,246,0.3);
      overflow: hidden;
      position: relative;
    `;
    
    // Limpiar mapa existente
    if (window.mapaEnlaces) {
      window.mapaEnlaces.remove();
    }
    
    // Crear nuevo mapa con mejor vista
    const mapa = L.map('mapa-enlaces', {
      zoomControl: true,
      scrollWheelZoom: true,
      doubleClickZoom: true,
      boxZoom: true,
      keyboard: true,
      dragging: true,
      touchZoom: true
    }).setView([23.6345, -102.5528], 5.2);
    
    window.mapaEnlaces = mapa;
    
    // Agregar capa de tiles mejorada
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors',
      maxZoom: 18,
      minZoom: 3
    }).addTo(mapa);
    
    // Crear iconos personalizados para las torres
    const iconoTorreFactible = L.divIcon({
      html: `
        <div style="
          width: 20px; 
          height: 20px; 
          background: linear-gradient(135deg, #10b981, #059669);
          border: 3px solid #ffffff;
          border-radius: 50%;
          box-shadow: 0 4px 12px rgba(16,185,129,0.4);
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 12px;
          color: white;
          font-weight: bold;
        ">üì°</div>
      `,
      className: 'torre-icon',
      iconSize: [20, 20],
      iconAnchor: [10, 10]
    });
    
    const iconoTorreNoFactible = L.divIcon({
      html: `
        <div style="
          width: 20px; 
          height: 20px; 
          background: linear-gradient(135deg, #ef4444, #dc2626);
          border: 3px solid #ffffff;
          border-radius: 50%;
          box-shadow: 0 4px 12px rgba(239,68,68,0.4);
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 12px;
          color: white;
          font-weight: bold;
        ">üì°</div>
      `,
      className: 'torre-icon',
      iconSize: [20, 20],
      iconAnchor: [10, 10]
    });
    
    // Obtener enlaces de la tabla
    const filas = document.querySelectorAll('#tabla tbody tr');
    console.log('üìã Enlaces encontrados:', filas.length);
    
    let enlacesAgregados = 0;
    let torresAgregadas = new Set(); // Para evitar torres duplicadas
    
    filas.forEach((fila, index) => {
      const celdas = fila.querySelectorAll('td');
      
      // Obtener coordenadas
      const latA = parseFloat(celdas[3]?.textContent.replace(',', '.'));
      const lonA = parseFloat(celdas[4]?.textContent.replace(',', '.'));
      const latB = parseFloat(celdas[9]?.textContent.replace(',', '.'));
      const lonB = parseFloat(celdas[10]?.textContent.replace(',', '.'));
      
      // Verificar si las coordenadas son v√°lidas
      if (!isNaN(latA) && !isNaN(lonA) && !isNaN(latB) && !isNaN(lonB)) {
        // Determinar color basado en factibilidad
        const factible = celdas[30]?.textContent.trim().toUpperCase().startsWith('S√ç') || 
                        celdas[30]?.textContent.trim().toUpperCase().startsWith('FACTIBLE');
        
        const color = factible ? '#10b981' : '#ef4444';
        const iconoTorre = factible ? iconoTorreFactible : iconoTorreNoFactible;
        
        // Crear l√≠nea del enlace con mejor estilo
        const polyline = L.polyline([[latA, lonA], [latB, lonB]], {
          color: color,
          weight: 4,
          opacity: 0.8,
          dashArray: factible ? null : '10, 5', // L√≠nea punteada para no factibles
          lineCap: 'round',
          lineJoin: 'round'
        }).addTo(mapa);
        
        // Agregar torres en los extremos
        const nombreA = celdas[1]?.textContent || 'A';
        const nombreB = celdas[7]?.textContent || 'B';
        const alturaA = buscarAlturaEnColumnas(celdas, 'Torre A') || 'N/A';
        const alturaB = buscarAlturaEnColumnas(celdas, 'Torre B') || 'N/A';
        const distancia = celdas[13]?.textContent || 'N/A';
        const frecuencia = celdas[14]?.textContent || 'N/A';
        
        // Torre A
        const torreAKey = `${latA},${lonA}`;
        if (!torresAgregadas.has(torreAKey)) {
          const torreA = L.marker([latA, lonA], { icon: iconoTorre }).addTo(mapa);
          torreA.bindPopup(`
            <div style="min-width: 200px;">
              <h4 style="margin: 0 0 10px 0; color: #3b82f6;">üóº ${nombreA}</h4>
              <p><strong>Altura:</strong> ${alturaA} m</p>
              <p><strong>Estado:</strong> ${factible ? '‚úÖ Factible' : '‚ùå No Factible'}</p>
            </div>
          `);
          torresAgregadas.add(torreAKey);
        }
        
        // Torre B
        const torreBKey = `${latB},${lonB}`;
        if (!torresAgregadas.has(torreBKey)) {
          const torreB = L.marker([latB, lonB], { icon: iconoTorre }).addTo(mapa);
          torreB.bindPopup(`
            <div style="min-width: 200px;">
              <h4 style="margin: 0 0 10px 0; color: #3b82f6;">üóº ${nombreB}</h4>
              <p><strong>Altura:</strong> ${alturaB} m</p>
              <p><strong>Estado:</strong> ${factible ? '‚úÖ Factible' : '‚ùå No Factible'}</p>
            </div>
          `);
          torresAgregadas.add(torreBKey);
        }
        
        // Informaci√≥n del enlace al hacer clic en la l√≠nea
        const popupContent = `
          <div style="min-width: 250px;">
            <h4 style="margin: 0 0 10px 0; color: #3b82f6;">üì° Enlace ${nombreA} ‚Üí ${nombreB}</h4>
            <p><strong>Distancia:</strong> ${distancia} km</p>
            <p><strong>Frecuencia:</strong> ${frecuencia} GHz</p>
            <p><strong>Altura Torre A:</strong> ${alturaA} m</p>
            <p><strong>Altura Torre B:</strong> ${alturaB} m</p>
            <p><strong>Estado:</strong> ${factible ? '‚úÖ Factible' : '‚ùå No Factible'}</p>
            <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #e5e7eb;">
              <button id="btn-perfil-${index}" 
                      style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600; width: 100%;">
                üó∫Ô∏è Ver Perfil de Elevaci√≥n
              </button>
            </div>
          </div>
        `;
        
        polyline.bindPopup(popupContent);
        
        // Agregar evento al bot√≥n despu√©s de que se abra el popup
        polyline.on('popupopen', function() {
          setTimeout(() => {
            const btn = document.getElementById(`btn-perfil-${index}`);
            if (btn) {
              btn.onclick = function() {
                console.log('üñ±Ô∏è Bot√≥n perfil clickeado para:', nombreA, '‚Üí', nombreB);
                irAPerfilElevacionDesdeMapa(nombreA, nombreB, latA, lonA, latB, lonB, alturaA, alturaB);
              };
            }
          }, 100);
        });
        
        // Doble clic en la l√≠nea para ir al perfil de elevaci√≥n
        polyline.on('dblclick', function() {
          console.log('üîÑ Doble clic en enlace:', nombreA, '‚Üí', nombreB);
          irAPerfilElevacionDesdeMapa(nombreA, nombreB, latA, lonA, latB, lonB, alturaA, alturaB);
        });
        
        enlacesAgregados++;
      }
    });
    
    // Agregar leyenda
    const leyenda = L.control({ position: 'bottomright' });
    leyenda.onAdd = function() {
      const div = L.DomUtil.create('div', 'info legend');
      div.style.cssText = `
        background: rgba(255,255,255,0.9);
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        font-size: 12px;
        min-width: 150px;
      `;
             div.innerHTML = `
         <h4 style="margin: 0 0 8px 0; color: #374151;">üìä Leyenda</h4>
         <div style="display: flex; align-items: center; margin: 4px 0;">
           <div style="width: 20px; height: 4px; background: #10b981; margin-right: 8px;"></div>
           <span>‚úÖ Enlaces Factibles</span>
         </div>
         <div style="display: flex; align-items: center; margin: 4px 0;">
           <div style="width: 20px; height: 4px; background: #ef4444; margin-right: 8px; border-top: 2px dotted #ef4444;"></div>
           <span>‚ùå Enlaces No Factibles</span>
         </div>
         <div style="display: flex; align-items: center; margin: 4px 0;">
           <div style="width: 16px; height: 16px; background: #10b981; border-radius: 50%; margin-right: 8px;"></div>
           <span>üóº Torres</span>
         </div>
         <div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid #e5e7eb;">
           <button onclick="mostrarGraficoEnModal()" 
                   style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 600; width: 100%;">
             üéØ Ver Gr√°fico
           </button>
         </div>
       `;
      return div;
    };
    leyenda.addTo(mapa);
    
         console.log('‚úÖ Mapa profesional cargado con', enlacesAgregados, 'enlaces y', torresAgregadas.size, 'torres');
     mostrarNotificacion(`üó∫Ô∏è Mapa profesional cargado: ${enlacesAgregados} enlaces, ${torresAgregadas.size} torres. üñ±Ô∏è Doble clic en l√≠neas para perfil`, 'success');
    
  } catch (error) {
    console.error('‚ùå Error al cargar mapa profesional:', error);
    mostrarNotificacion('‚ùå Error al cargar mapa profesional', 'error');
  }
}

// Funci√≥n para ir al perfil de elevaci√≥n desde el mapa
window.irAPerfilElevacionDesdeMapa = function(nombreA, nombreB, latA, lonA, latB, lonB, alturaA, alturaB) {
  console.log('üó∫Ô∏è === INICIANDO NAVEGACI√ìN AL PERFIL ===');
  console.log('üìç Datos recibidos:', { nombreA, nombreB, latA, lonA, latB, lonB, alturaA, alturaB });
  
  // Verificar que todos los par√°metros sean v√°lidos
  if (!nombreA || !nombreB || !latA || !lonA || !latB || !lonB) {
    console.error('‚ùå Datos incompletos para navegaci√≥n');
    mostrarNotificacion('‚ùå Error: Datos del enlace incompletos', 'error');
    return;
  }
  console.log('üó∫Ô∏è Navegando al perfil de elevaci√≥n desde mapa...');
  console.log('üìç Datos del enlace:', { nombreA, nombreB, latA, lonA, latB, lonB, alturaA, alturaB });
  
  try {
    // Llenar los campos del formulario con los datos del enlace
    const campos = {
      'torreA': nombreA,
      'torreB': nombreB,
      'latA': latA,
      'lonA': lonA,
      'latB': latB,
      'lonB': lonB,
      'alturaA': alturaA,
      'alturaB': alturaB
    };
    
    console.log('üìù Actualizando campos del formulario...');
    console.log('üéØ Campos a actualizar:', campos);
    
    // Actualizar campos del formulario
    let camposActualizados = 0;
    Object.keys(campos).forEach(campo => {
      const elemento = document.getElementById(campo);
      if (elemento) {
        elemento.value = campos[campo];
        console.log(`‚úÖ Campo ${campo} actualizado:`, campos[campo]);
        camposActualizados++;
      } else {
        console.log(`‚ö†Ô∏è Campo ${campo} no encontrado en el DOM`);
      }
    });
    
    // Verificar que los datos se llenaron correctamente
    setTimeout(() => {
      console.log('üîç Verificando datos en formulario despu√©s de llenado:');
      console.log('Torre A:', document.getElementById('torreA')?.value);
      console.log('Torre B:', document.getElementById('torreB')?.value);
      console.log('Lat A:', document.getElementById('latA')?.value);
      console.log('Lon A:', document.getElementById('lonA')?.value);
      console.log('Lat B:', document.getElementById('latB')?.value);
      console.log('Lon B:', document.getElementById('lonB')?.value);
      console.log('Altura A:', document.getElementById('alturaA')?.value);
      console.log('Altura B:', document.getElementById('alturaB')?.value);
    }, 200);
    
    console.log(`üìä Campos actualizados: ${camposActualizados} de ${Object.keys(campos).length}`);
    
    // Actualizar informaci√≥n de torres en el perfil
    const torreAInfo = document.getElementById('torreA-info');
    const torreBInfo = document.getElementById('torreB-info');
    
    if (torreAInfo) {
      const torreAId = torreAInfo.querySelector('#torreA-id');
      const torreANombre = torreAInfo.querySelector('#torreA-nombre');
      const torreAAltura = torreAInfo.querySelector('#torreA-altura');
      
      if (torreAId) torreAId.textContent = nombreA;
      if (torreANombre) torreANombre.textContent = nombreA;
      if (torreAAltura) torreAAltura.textContent = `${alturaA} m`;
    }
    
    if (torreBInfo) {
      const torreBId = torreBInfo.querySelector('#torreB-id');
      const torreBNombre = torreBInfo.querySelector('#torreB-nombre');
      const torreBAltura = torreBInfo.querySelector('#torreB-altura');
      
      if (torreBId) torreBId.textContent = nombreB;
      if (torreBNombre) torreBNombre.textContent = nombreB;
      if (torreBAltura) torreBAltura.textContent = `${alturaB} m`;
    }
    
    // Cambiar a la pesta√±a de enlaces para mostrar el perfil
    mostrarPestana('enlaces');
    
    // Scroll al perfil de elevaci√≥n y activar el gr√°fico
    setTimeout(() => {
      // Buscar la secci√≥n del perfil
      const perfilSection = document.querySelector('#perfil-elevacion-con-torres');
      if (perfilSection) {
        perfilSection.scrollIntoView({ 
          behavior: 'smooth', 
          block: 'center' 
        });
        console.log('‚úÖ Scroll al perfil de elevaci√≥n completado');
        
        // NO activar perfil real autom√°ticamente - solo navegar al perfil normal
        console.log('‚úÖ Navegaci√≥n al perfil normal completada');
        
      } else {
        console.log('‚ö†Ô∏è Secci√≥n de perfil no encontrada');
      }
    }, 300);
    
    // Mostrar notificaci√≥n de √©xito
    mostrarNotificacion(`üó∫Ô∏è Navegando al perfil: ${nombreA} ‚Üí ${nombreB}`, 'success');
    
    // Actualizar c√°lculos si la funci√≥n existe
    if (typeof actualizarCalculos === 'function') {
      setTimeout(() => {
        actualizarCalculos();
        console.log('‚úÖ C√°lculos actualizados');
      }, 500);
    }
    
    // Mostrar el gr√°fico en modal (sin cambiar de pesta√±a)
    setTimeout(() => {
      console.log('üéØ Mostrando gr√°fico en modal...');
      mostrarGraficoEnModal();
    }, 1000);
    
    console.log('‚úÖ Navegaci√≥n al perfil completada');
    
  } catch (error) {
    console.error('‚ùå Error al navegar al perfil:', error);
    mostrarNotificacion('‚ùå Error al navegar al perfil de elevaci√≥n', 'error');
  }
}

// Funci√≥n para mostrar el gr√°fico en una ventana modal
window.mostrarGraficoEnModal = function() {
  console.log('üéØ Mostrando gr√°fico en modal...');
  
  try {
    // Crear modal si no existe
    let modal = document.getElementById('modal-grafico');
    if (!modal) {
      modal = document.createElement('div');
      modal.id = 'modal-grafico';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 10000;
        display: flex;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(5px);
      `;
      
      modal.innerHTML = `
        <div style="
          background: white;
          border-radius: 15px;
          padding: 20px;
          max-width: 90%;
          max-height: 90%;
          overflow: auto;
          box-shadow: 0 20px 60px rgba(0,0,0,0.3);
          position: relative;
        ">
          <button onclick="cerrarModalGrafico()" style="
            position: absolute;
            top: 10px;
            right: 15px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 16px;
            z-index: 10001;
          ">√ó</button>
          
          <h2 style="margin: 0 0 20px 0; color: #374151; text-align: center;">
            üó∫Ô∏è Perfil de Elevaci√≥n - ${document.getElementById('torreA')?.value || 'Torre A'} ‚Üí ${document.getElementById('torreB')?.value || 'Torre B'}
          </h2>
          
          <div id="modal-grafico-contenido" style="min-height: 400px;">
            <div style="text-align: center; padding: 40px; color: #6b7280;">
              <div style="font-size: 24px; margin-bottom: 10px;">üîÑ</div>
              Generando perfil de elevaci√≥n...
            </div>
          </div>
          
          <div style="margin-top: 20px; text-align: center;">
            <button onclick="activarPerfilEnModal()" style="
              background: linear-gradient(135deg, #10b981, #059669);
              color: white;
              border: none;
              padding: 12px 24px;
              border-radius: 8px;
              cursor: pointer;
              font-size: 14px;
              font-weight: 600;
              margin: 0 5px;
            ">üó∫Ô∏è Generar Perfil Real</button>
            
            <button onclick="cerrarModalGrafico()" style="
              background: #6b7280;
              color: white;
              border: none;
              padding: 12px 24px;
              border-radius: 8px;
              cursor: pointer;
              font-size: 14px;
              font-weight: 600;
              margin: 0 5px;
            ">‚ùå Cerrar</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }
    
    // Mostrar modal
    modal.style.display = 'flex';
    console.log('‚úÖ Modal mostrado');
    mostrarNotificacion('üéØ Gr√°fico abierto en ventana modal', 'success');
    
  } catch (error) {
    console.error('‚ùå Error al mostrar modal:', error);
    mostrarNotificacion('‚ùå Error al mostrar modal', 'error');
  }
}

// Funci√≥n para cerrar el modal
window.cerrarModalGrafico = function() {
  const modal = document.getElementById('modal-grafico');
  if (modal) {
    modal.style.display = 'none';
    console.log('‚úÖ Modal cerrado');
  }
}

// Funci√≥n para activar el perfil dentro del modal
window.activarPerfilEnModal = function() {
  console.log('üéØ Activando perfil en modal...');
  
  const contenido = document.getElementById('modal-grafico-contenido');
  if (!contenido) return;
  
  // Mostrar indicador de carga
  contenido.innerHTML = `
    <div style="text-align: center; padding: 40px; color: #6b7280;">
      <div style="font-size: 24px; margin-bottom: 10px;">üîÑ</div>
      Generando perfil de elevaci√≥n real...
    </div>
  `;
  
  // Llamar a la funci√≥n de perfil real
  if (typeof window.activarPerfilElevacionReal === 'function') {
    // Modificar temporalmente la funci√≥n para que genere en el modal
    const originalFunction = window.activarPerfilElevacionReal;
    
    window.activarPerfilElevacionReal = function() {
      console.log('üó∫Ô∏è Activando perfil de elevaci√≥n real en modal...');
      
      // Obtener datos del formulario
      const latA = document.getElementById('latA')?.value;
      const lonA = document.getElementById('lonA')?.value;
      const latB = document.getElementById('latB')?.value;
      const lonB = document.getElementById('lonB')?.value;
      
      if (!latA || !lonA || !latB || !lonB) {
        contenido.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #ef4444;">
            <div style="font-size: 24px; margin-bottom: 10px;">‚ö†Ô∏è</div>
            No hay datos de coordenadas disponibles
          </div>
        `;
        return;
      }
      
      // Llamar a la funci√≥n original
      originalFunction();
      
      // Esperar a que se genere el gr√°fico y copiarlo al modal
      setTimeout(() => {
        const graficoOriginal = document.getElementById('perfilElevacionPlotly');
        if (graficoOriginal) {
          contenido.innerHTML = graficoOriginal.outerHTML;
          console.log('‚úÖ Gr√°fico copiado al modal');
        } else {
          contenido.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #ef4444;">
              <div style="font-size: 24px; margin-bottom: 10px;">‚ùå</div>
              Error al generar el gr√°fico
            </div>
          `;
        }
      }, 3000);
    };
    
    // Ejecutar la funci√≥n modificada
    window.activarPerfilElevacionReal();
    
    // Restaurar funci√≥n original despu√©s de un tiempo
    setTimeout(() => {
      window.activarPerfilElevacionReal = originalFunction;
    }, 5000);
    
  } else {
    contenido.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #ef4444;">
        <div style="font-size: 24px; margin-bottom: 10px;">‚ùå</div>
        Funci√≥n de perfil no disponible
      </div>
    `;
  }
}

// Funci√≥n para ir directamente al gr√°fico del perfil (mantener para compatibilidad)
window.irDirectamenteAlGrafico = function() {
  console.log('üéØ Navegando directamente al gr√°fico...');
  
  try {
    // Cambiar a la pesta√±a de enlaces
    mostrarPestana('enlaces');
    
    // Esperar a que se cargue la pesta√±a
    setTimeout(() => {
      // Buscar el bot√≥n del perfil real
      const btnPerfilReal = document.getElementById('btn-perfil-real');
      if (btnPerfilReal) {
        console.log('üéØ Activando perfil real...');
        btnPerfilReal.click();
        
        // Esperar a que se genere el gr√°fico
        setTimeout(() => {
          // Buscar el gr√°fico
          const grafico = document.getElementById('perfilElevacionPlotly');
          if (grafico) {
            // Scroll al gr√°fico
            grafico.scrollIntoView({ 
              behavior: 'smooth', 
              block: 'center' 
            });
            console.log('‚úÖ Navegaci√≥n al gr√°fico completada');
            mostrarNotificacion('üéØ Navegaci√≥n al gr√°fico completada', 'success');
          } else {
            console.log('‚ö†Ô∏è Gr√°fico no encontrado');
            mostrarNotificacion('‚ö†Ô∏è Gr√°fico no encontrado', 'warning');
          }
        }, 1500);
        
      } else {
        console.log('‚ö†Ô∏è Bot√≥n perfil real no encontrado');
        mostrarNotificacion('‚ö†Ô∏è Bot√≥n perfil real no encontrado', 'warning');
      }
    }, 300);
    
  } catch (error) {
    console.error('‚ùå Error al navegar al gr√°fico:', error);
    mostrarNotificacion('‚ùå Error al navegar al gr√°fico', 'error');
  }
}

// Funci√≥n de prueba para verificar navegaci√≥n
window.probarNavegacionPerfil = function() {
  console.log('üß™ Probando navegaci√≥n al perfil...');
  
  // Datos de prueba
  const datosPrueba = {
    nombreA: 'TORRE_PRUEBA_A',
    nombreB: 'TORRE_PRUEBA_B',
    latA: 19.4326,
    lonA: -99.1332,
    latB: 19.4327,
    lonB: -99.1333,
    alturaA: 30,
    alturaB: 35
  };
  
  console.log('üìã Datos de prueba:', datosPrueba);
  
  // Llamar a la funci√≥n de navegaci√≥n
  irAPerfilElevacionDesdeMapa(
    datosPrueba.nombreA,
    datosPrueba.nombreB,
    datosPrueba.latA,
    datosPrueba.lonA,
    datosPrueba.latB,
    datosPrueba.lonB,
    datosPrueba.alturaA,
    datosPrueba.alturaB
  );
  
  mostrarNotificacion('üß™ Prueba de navegaci√≥n ejecutada', 'info');
}

// Funci√≥n para verificar datos del formulario
window.verificarDatosFormulario = function() {
  console.log('üîç Verificando datos del formulario:');
  const campos = ['torreA', 'torreB', 'latA', 'lonA', 'latB', 'lonB', 'alturaA', 'alturaB'];
  campos.forEach(campo => {
    const elemento = document.getElementById(campo);
    console.log(`${campo}:`, elemento ? elemento.value : 'NO ENCONTRADO');
  });
}

// Funci√≥n para llenar datos de prueba
window.llenarDatosPrueba = function() {
  console.log('üß™ Llenando datos de prueba...');
  const datos = {
    'torreA': 'Torre_Prueba_A',
    'torreB': 'Torre_Prueba_B', 
    'latA': '19.4326',
    'lonA': '-99.1332',
    'latB': '19.4327',
    'lonB': '-99.1333',
    'alturaA': '30',
    'alturaB': '25'
  };
  
  Object.keys(datos).forEach(campo => {
    const elemento = document.getElementById(campo);
    if (elemento) {
      elemento.value = datos[campo];
      console.log(`‚úÖ ${campo} = ${datos[campo]}`);
    } else {
      console.log(`‚ùå ${campo} no encontrado`);
    }
  });
}

// Funci√≥n de prueba completa para verificar el flujo
window.probarFlujoCompleto = function() {
  console.log('üß™ === PRUEBA COMPLETA DEL FLUJO ===');
  
  // Paso 1: Llenar datos de prueba
  console.log('1Ô∏è‚É£ Llenando datos de prueba...');
  llenarDatosPrueba();
  
  // Paso 2: Verificar datos
  console.log('2Ô∏è‚É£ Verificando datos...');
  setTimeout(() => {
    verificarDatosFormulario();
    
    // Paso 3: Probar modal
    console.log('3Ô∏è‚É£ Probando modal...');
    setTimeout(() => {
      mostrarGraficoEnModal();
    }, 500);
  }, 200);
}

// Funci√≥n para probar solo el modal
window.probarModal = function() {
  console.log('üß™ Probando modal del gr√°fico...');
  llenarDatosPrueba();
  setTimeout(() => {
    mostrarGraficoEnModal();
  }, 200);
}

// Funci√≥n para forzar carga del mapa
window.forzarCargaMapa = function() {
  console.log('üîÑ Forzando carga del mapa...');
  
  // Cambiar a pesta√±a RESUMEN si no estamos ah√≠
  const pestanaResumen = document.getElementById('resumen');
  if (pestanaResumen && !pestanaResumen.classList.contains('pestana-activa')) {
    console.log('üîÑ Cambiando a pesta√±a RESUMEN...');
    mostrarPestana('resumen');
  }
  
  // Esperar y cargar mapa
  setTimeout(() => {
    if (typeof window.mostrarMapaEnlaces === 'function') {
      console.log('üó∫Ô∏è Cargando mapa...');
      window.mostrarMapaEnlaces(null);
      mostrarNotificacion('üó∫Ô∏è Mapa cargado', 'success');
    } else {
      console.log('‚ùå Funci√≥n mostrarMapaEnlaces no disponible');
      mostrarNotificacion('‚ùå Funci√≥n de mapa no disponible', 'error');
    }
  }, 1000);
}

// Funci√≥n de diagn√≥stico completo del mapa
window.diagnosticarMapa = function() {
  console.log('üîç === DIAGN√ìSTICO COMPLETO DEL MAPA ===');
  
  // 1. Verificar pesta√±a actual
  const pestanaActual = document.querySelector('.pestana-activa');
  console.log('1Ô∏è‚É£ Pesta√±a actual:', pestanaActual?.id);
  
  // 2. Verificar elemento del mapa
  const divMapa = document.getElementById('mapa-enlaces');
  if (divMapa) {
    console.log('2Ô∏è‚É£ ‚úÖ Elemento mapa-enlaces encontrado');
    console.log('   üìè Dimensiones:', divMapa.offsetWidth, 'x', divMapa.offsetHeight);
    console.log('   üëÅÔ∏è Visible:', divMapa.offsetParent !== null);
    console.log('   üé® Estilo display:', divMapa.style.display);
  } else {
    console.log('2Ô∏è‚É£ ‚ùå Elemento mapa-enlaces NO encontrado');
  }
  
  // 3. Verificar Leaflet
  if (typeof L === 'undefined') {
    console.log('3Ô∏è‚É£ ‚ùå Leaflet no disponible');
  } else {
    console.log('3Ô∏è‚É£ ‚úÖ Leaflet disponible (v' + L.version + ')');
  }
  
  // 4. Verificar funci√≥n mostrarMapaEnlaces
  if (typeof window.mostrarMapaEnlaces === 'function') {
    console.log('4Ô∏è‚É£ ‚úÖ Funci√≥n mostrarMapaEnlaces disponible');
  } else {
    console.log('4Ô∏è‚É£ ‚ùå Funci√≥n mostrarMapaEnlaces NO disponible');
  }
  
  // 5. Verificar datos de enlaces
  const filas = document.querySelectorAll('#tabla tbody tr');
  console.log('5Ô∏è‚É£ üìã Filas en tabla:', filas.length);
  
  if (filas.length > 0) {
    const primeraFila = filas[0];
    const celdas = primeraFila.querySelectorAll('td');
    console.log('   üìç Primera fila - LatA:', celdas[3]?.textContent, 'LonA:', celdas[4]?.textContent);
  }
  
  // 6. Verificar mapa existente
  if (window.mapaEnlaces) {
    console.log('6Ô∏è‚É£ ‚úÖ Mapa existente encontrado');
  } else {
    console.log('6Ô∏è‚É£ ‚ùå No hay mapa existente');
  }
  
  console.log('üîç === FIN DEL DIAGN√ìSTICO ===');
}

// Funci√≥n para crear mapa simple de prueba
window.crearMapaPrueba = function() {
  console.log('üß™ Creando mapa de prueba...');
  
  try {
    // Verificar Leaflet
    if (typeof L === 'undefined') {
      console.error('‚ùå Leaflet no disponible');
      mostrarNotificacion('‚ùå Leaflet no disponible', 'error');
      return;
    }
    
    // Verificar elemento del mapa
    const divMapa = document.getElementById('mapa-enlaces');
    if (!divMapa) {
      console.error('‚ùå Elemento mapa-enlaces no encontrado');
      mostrarNotificacion('‚ùå Elemento del mapa no encontrado', 'error');
      return;
    }
    
    // Limpiar mapa existente
    if (window.mapaEnlaces) {
      window.mapaEnlaces.remove();
    }
    
    // Crear mapa simple
    const mapa = L.map('mapa-enlaces').setView([19.4326, -99.1332], 10);
    window.mapaEnlaces = mapa;
    
    // Agregar capa de tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors'
    }).addTo(mapa);
    
    // Agregar marcador de prueba
    L.marker([19.4326, -99.1332]).addTo(mapa)
      .bindPopup('üß™ Mapa de prueba funcionando')
      .openPopup();
    
    console.log('‚úÖ Mapa de prueba creado exitosamente');
    mostrarNotificacion('‚úÖ Mapa de prueba funcionando', 'success');
    
  } catch (error) {
    console.error('‚ùå Error al crear mapa de prueba:', error);
    mostrarNotificacion('‚ùå Error al crear mapa de prueba', 'error');
  }
}

// Agregar estilos CSS para mejorar el mapa
const estilosMapa = document.createElement('style');
estilosMapa.textContent = `
  .torre-icon {
    transition: all 0.3s ease;
  }
  
  .torre-icon:hover {
    transform: scale(1.2);
    z-index: 1000 !important;
  }
  
  .leaflet-popup-content-wrapper {
    border-radius: 12px !important;
    box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
  }
  
  .leaflet-popup-content {
    margin: 15px !important;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
  }
  
  .leaflet-control-zoom {
    border-radius: 8px !important;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1) !important;
  }
  
  .leaflet-control-attribution {
    background: rgba(255,255,255,0.9) !important;
    border-radius: 6px !important;
    padding: 4px 8px !important;
    font-size: 11px !important;
  }
  
  #mapa-enlaces {
    background: linear-gradient(135deg, #f8fafc, #e2e8f0);
  }
  
  .legend {
    background: rgba(255,255,255,0.95) !important;
    backdrop-filter: blur(10px) !important;
    border: 1px solid rgba(59,130,246,0.2) !important;
  }
  
  /* Estilos para l√≠neas de enlace interactivas */
  .leaflet-interactive {
    cursor: pointer !important;
    transition: all 0.3s ease !important;
  }
  
  .leaflet-interactive:hover {
    stroke-width: 6px !important;
    opacity: 1 !important;
    filter: drop-shadow(0 2px 8px rgba(0,0,0,0.3)) !important;
  }
  
  /* Estilo para indicar que es clickeable */
  .leaflet-interactive::after {
    content: "üñ±Ô∏è Doble clic para perfil";
    position: absolute;
    background: rgba(0,0,0,0.8);
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 10px;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  
  .leaflet-interactive:hover::after {
    opacity: 1;
  }
`;
document.head.appendChild(estilosMapa);
document.getElementById('inputFile').addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function (e) {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: 'array' });
    const sheetName = workbook.SheetNames[0];
    const worksheet = workbook.Sheets[sheetName];
    dataExcel = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
    const archivoInfo = {
      nombre: file.name,
      tama√±o: file.size,
      filas: dataExcel.length,
      fechaCarga: new Date().toISOString()
    };
    localStorage.setItem('archivoExcelInfo', JSON.stringify(archivoInfo));
    guardarArchivoExcelEnIndexedDB(file.name, e.target.result, archivoInfo);
    mostrarArchivoCargado(archivoInfo);
    alert(`‚úÖ Archivo cargado exitosamente!\nüìÅ ${file.name}\nüìä ${dataExcel.length} filas procesadas`);
  };
  reader.readAsArrayBuffer(file);
});
document.getElementById('inputFilePairs').addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function (e) {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: 'array' });
    const sheetName = workbook.SheetNames[0];
    const worksheet = workbook.Sheets[sheetName];
    dataPares = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
    const archivoInfo = {
      nombre: file.name,
      tama√±o: file.size,
      filas: dataPares.length,
      fechaCarga: new Date().toISOString()
    };
    localStorage.setItem('archivoParesInfo', JSON.stringify(archivoInfo));
    guardarArchivoParesEnIndexedDB(file.name, e.target.result, archivoInfo);
    const contenedor = document.getElementById('archivo-pares-cargado');
    const nombreArchivo = document.getElementById('nombre-archivo-pares');
    const infoArchivo = document.getElementById('info-archivo-pares');
    if (contenedor && nombreArchivo && infoArchivo) {
      nombreArchivo.textContent = archivoInfo.nombre;
      infoArchivo.textContent = `${archivoInfo.filas} filas ‚Ä¢ ${(archivoInfo.tama√±o / 1024).toFixed(1)} KB ‚Ä¢ Cargado: ${new Date(archivoInfo.fechaCarga).toLocaleString()}`;
      contenedor.style.display = 'block';
      document.getElementById('inputFilePairs').style.display = 'none';
    }
    alert(`‚úÖ Archivo de pares cargado exitosamente!\nüìÅ ${file.name}\nüìä ${dataPares.length} filas procesadas`);
  };
  reader.readAsArrayBuffer(file);
});
function procesarPares() {
  console.log('üöÄ Iniciando procesamiento de pares...');
  
  let faltantes = [];
  if (!dataExcel.length) {
    alert('‚ùå Error: Primero debes cargar el Excel con los datos de las torres');
    window.procesandoPares = false;
    return;
  }
  if (!dataPares.length) {
    alert('‚ùå Error: No hay pares de IDs para procesar');
    window.procesandoPares = false;
    return;
  }
  let loader = document.createElement('div');
  loader.id = 'loader-procesando';
  loader.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(10,20,40,0.85);color:#fff;display:flex;align-items:center;justify-content:center;z-index:99999;font-size:2rem;font-weight:800;';
  loader.innerHTML = `
    <div>
      <i class="fas fa-cog fa-spin"></i> Procesando pares, por favor espera...
      <br>
      <span id="progreso-pares" style="font-size:1.3rem;display:block;margin-top:18px;"></span>
    </div>
  `;
  document.body.appendChild(loader);
  const mapaTorres = {};
  dataExcel.forEach(row => {
    if (row[0]) mapaTorres[row[0].toString().trim().toUpperCase()] = row;
  });
  let index = 0;
  const batchSize = 1000;
  let procesados = 0;
  let omitidos = 0;
  const filasDiferenteTransporte = [];
  const filasMismoTransporte = [];
  function procesarLote() {
    
    const start = index;
    const end = Math.min(index + batchSize, dataPares.length);
    for (let i = start; i < end; i++) {
      const par = dataPares[i];
      const idA = par[0]?.toString().trim().toUpperCase();
      const idB = par[1]?.toString().trim().toUpperCase();
      if (!idA || !idB) {
        omitidos++;
        continue;
      }
      const datosTorreA = mapaTorres[idA] || [];
      const datosTorreB = mapaTorres[idB] || [];
      if (datosTorreA.length === 0 || datosTorreB.length === 0) {
        faltantes.push([
          idA, idB,
          datosTorreA.length === 0 ? 'FALTA A' : '',
          datosTorreB.length === 0 ? 'FALTA B' : ''
        ]);
      }
      document.getElementById('idA').value = idA;
      document.getElementById('nombreA').value = datosTorreA[3] || '';
      document.getElementById('latA').value = datosTorreA[11] || '';
      document.getElementById('lonA').value = datosTorreA[12] || '';
      document.getElementById('alturaA').value = datosTorreA[51] || '';
      document.getElementById('ranA').value = datosTorreA[52] || '';
      document.getElementById('TransA').value = datosTorreA[103] || '';
      document.getElementById('ArreA').value = datosTorreA[4] || '';
      document.getElementById('OnA').value = datosTorreA[102] || '';
      document.getElementById('TorreA').value = datosTorreA[21] || '';
      document.getElementById('EstadoA').value = datosTorreA[13] || '';
      document.getElementById('idB').value = idB;
      document.getElementById('nombreB').value = datosTorreB[3] || '';
      document.getElementById('latB').value = datosTorreB[11] || '';
      document.getElementById('lonB').value = datosTorreB[12] || '';
      document.getElementById('alturaB').value = datosTorreB[51] || '';
      document.getElementById('ranB').value = datosTorreB[52] || '';
      document.getElementById('TransB').value = datosTorreB[103] || '';
      document.getElementById('ArreB').value = datosTorreB[4] || '';
      document.getElementById('OnB').value = datosTorreB[102] || '';
      document.getElementById('TorreB').value = datosTorreB[21] || '';
      document.getElementById('EstadoB').value = datosTorreB[13] || '';
      actualizarCalculos();
const get = id => document.getElementById(id).value.trim();
const latA = parseFloat(get('latA'));
const lonA = parseFloat(get('lonA'));
const latB = parseFloat(get('latB'));
const lonB = parseFloat(get('lonB'));
if (!get('idA') || !get('idB')) continue;
if (isNaN(latA) || isNaN(lonA) || isNaN(latB) || isNaN(lonB)) continue;
const distanciaKm = calcularDistancia(latA, lonA, latB, lonB);
const frecuencia = asignarFrecuencia(distanciaKm);
const factibilidad = analizarFactibilidad(
  distanciaKm,
  get('ArreA'),
  get('ArreB'),
  get('TransA'),
  get('TransB'),
  get('TorreA'),
  get('TorreB'),
  get('OnA'),
  get('OnB'),
  window.ultimaFactibilidadLOS
);
const estadoFactible = (factibilidad.advertencia)
  ? 'FACTIBLE (Requiere an√°lisis)'
  : (factibilidad.razon && factibilidad.razon.toUpperCase().includes('NO DISPONIBLE'))
    ? 'NO DISPONIBLE'
    : (factibilidad.factible ? 'S√ç' : 'NO');
const filaDatos = [
  get('idA'), get('nombreA'), get('latA'), get('lonA'),
  document.getElementById('latArad').value,
  document.getElementById('lonArad').value,
  get('idB'), get('nombreB'), get('latB'), get('lonB'),
  document.getElementById('latBrad').value,
  document.getElementById('lonBrad').value,
  distanciaKm.toFixed(6), frecuencia,
  document.getElementById('disponibilidadAnual').value,
  get('alturaA'), get('alturaB'), get('ranA'), get('ranB'),
  get('TransA'), get('TransB'), get('ArreA'), get('ArreB'),
  get('OnA'), get('OnB'), get('TorreA'), get('TorreB'),
  get('EstadoA'), get('EstadoB'),
  estadoFactible,
  factibilidad.diametroAntena,
  factibilidad.tipoEnlace,
  JSON.stringify(factibilidad)
];
const transA = get('TransA').toLowerCase();
const transB = get('TransB').toLowerCase();
if (transA && transB && transA === transB) {
  filasMismoTransporte.push(filaDatos);
} else {
  filasDiferenteTransporte.push(filaDatos);
}
if (permitirMismoTransporte) {
  const todos = filasDiferenteTransporte.concat(filasMismoTransporte);
  localStorage.setItem('enlacesMismoTransporte', JSON.stringify(todos));
  localStorage.removeItem('enlacesPtP'); 
  console.log(`üíæ Guardados ${todos.length} enlaces en enlacesMismoTransporte`);
} else {
  localStorage.setItem('enlacesPtP', JSON.stringify(filasDiferenteTransporte));
  localStorage.removeItem('enlacesMismoTransporte'); 
  console.log(`üíæ Guardados ${filasDiferenteTransporte.length} enlaces en enlacesPtP`);
}
      procesados++;
    }
    const progreso = document.getElementById('progreso-pares');
    if (progreso) {
      progreso.textContent = `Procesados: ${end} de ${dataPares.length} (${Math.round(100*end/dataPares.length)}%)`;
    }
    index = end;
    if (index < dataPares.length) {
      setTimeout(procesarLote, 1);
    } else {
      document.querySelector('#tabla tbody').innerHTML = '';
      actualizarContadorEnlaces();
      verificarEnlacesVacios();
      setTimeout(() => {
        if (document.body.contains(loader)) {
          document.body.removeChild(loader);
        }
        alert(`‚úÖ Procesamiento de pares completado (${procesados} enlaces agregados de ${dataPares.length} pares totales)\n‚ùå Omitidos por IDs vac√≠os: ${omitidos}`);
        mostrarPestana(permitirMismoTransporte ? 'mismoTransporte' : 'enlaces');
        if (permitirMismoTransporte) {
          mostrarTablaMismoTransporte();
        } else {
          cargarEnlacesDeStorageModo("normal");
        }
        if (faltantes.length > 0) {
          document.getElementById('btnDescargarFaltantes').style.display = 'inline-block';
          window.paresFaltantes = faltantes;
        } else {
          document.getElementById('btnDescargarFaltantes').style.display = 'none';
        }
      }, 200);
    }
  }
  procesarLote();
}
document.getElementById('btnDescargarFaltantes').onclick = function() {
  if (!window.paresFaltantes || window.paresFaltantes.length === 0) {
    alert('No hay pares faltantes.');
    return;
  }
  let csv = 'ID_A;ID_B;Falta_A;Falta_B\n';
  window.paresFaltantes.forEach(par => {
    csv += par.join(';') + '\n';
  });
  const blob = new Blob([csv], {type: 'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'pares_faltantes.csv';
  a.click();
  URL.revokeObjectURL(url);
};
window.mostrarTablaMismoTransporte = function() {
  const contenedor = document.getElementById('tabla-mismo-transporte');
  if (!contenedor) return;
  const enlaces = JSON.parse(localStorage.getItem('enlacesMismoTransporte') || '[]');
  if (!enlaces.length) {
    contenedor.innerHTML = `<div style="color:#ef4444; text-align:center; margin:32px 0;">
      <i class="fas fa-exclamation-triangle"></i> No hay enlaces procesados con mismo tipo de transporte.
    </div>`;
    return;
  }
  let html = `
    <div class="enlaces-counter">
      <i class="fas fa-chart-line"></i> Total de Enlaces (Permisivo): <span id="total-enlaces-mismo">${enlaces.length}</span>
    </div>
    <div class="action-buttons">
      <button class="btn btn-success" onclick="exportarExcelMismoTransporte()">
        <i class="fas fa-file-excel"></i> Exportar a Excel
      </button>
      <button class="btn btn-secondary" onclick="seleccionarTodosMismoTransporte()">
        <i class="fas fa-check-double"></i> Seleccionar Todos
      </button>
      <button class="btn btn-danger" onclick="eliminarEnlacesSeleccionadosMismo()" id="btnEliminarSeleccionadosMismo" disabled>
        <i class="fas fa-trash"></i> Eliminar Seleccionados
      </button>
      <button id="btnPerfilElevacionMismo" class="btn btn-info" style="display:none; margin-left:8px;">
        <i class="fas fa-mountain"></i> Perfil Elevaci√≥n
      </button>
    </div>
    <div class="table-container">
      <table id="tabla-mismo-tipo" style="width:100%;border-radius:12px;overflow:hidden;">
        <thead>
          <tr>
            <th><input type="checkbox" id="checkTodosMismo" onclick="toggleSeleccionarTodosMismo(this)"></th>
            <th>ID A</th>
            <th>Nombre A</th>
            <th>Lat A</th>
            <th>Lon A</th>
            <th>Lat A (rad)</th>
            <th>Lon A (rad)</th>
            <th>ID B</th>
            <th>Nombre B</th>
            <th>Lat B</th>
            <th>Lon B</th>
            <th>Lat B (rad)</th>
            <th>Lon B (rad)</th>
            <th>Distancia (km)</th>
            <th>Frecuencia (GHz)</th>
            <th>Disponibilidad</th>
            <th>Altura Torre A</th>
            <th>Altura Torre B</th>
            <th>Altura RAN A</th>
            <th>Altura RAN B</th>
            <th>Transporte A</th>
            <th>Transporte B</th>
            <th>Arrendamiento A</th>
            <th>Arrendamiento B</th>
            <th>On Air A</th>
            <th>On Air B</th>
            <th>Tipo Torre A</th>
            <th>Tipo Torre B</th>
            <th>Estado A</th>
            <th>Estado B</th>
            <th>Factible</th>
            <th>Antenas</th>
            <th>Tipo Enlace</th>
            <th>An√°lisis</th>
          </tr>
        </thead>
        <tbody>
  `;
  enlaces.forEach((enlaceData, idx) => {
    html += `<tr data-idx="${idx}">`;
    html += `<td><input type="checkbox" class="check-mismo-transporte" onchange="resaltarFilaMismoTransporte(this)"></td>`;
    enlaceData.forEach((val, i) => {
      const td = document.createElement('td');
      // Para la columna de estado (√≠ndice 27) crear badge
      if (i === 27) {
        const esFactible = val === 'S√ç' || val.includes('FACTIBLE');
        const badge = document.createElement('span');
        badge.className = 'badge';
        badge.style.cssText = `
          padding: 6px 12px; 
          border-radius: 20px; 
          font-size: 12px; 
          font-weight: 600; 
          text-transform: uppercase;
          background: ${esFactible ? 'rgba(16, 185, 129, 0.2)' : 'rgba(239, 68, 68, 0.2)'};
          color: ${esFactible ? '#10b981' : '#ef4444'};
          border: 1px solid ${esFactible ? 'rgba(16, 185, 129, 0.3)' : 'rgba(239, 68, 68, 0.3)'};
        `;
        badge.textContent = esFactible ? 'Factible' : 'No Factible';
        td.appendChild(badge);
      }
      // Para la columna de an√°lisis (√≠ndice 33) O cualquier valor que parezca JSON de an√°lisis
      else if (i === 33 || (typeof val === 'string' && val.trim().startsWith('{"factible"') && val.includes('razon') && val.includes('diametroAntena'))) {
        const btnInfo = document.createElement('button');
        btnInfo.innerHTML = '<i class="fas fa-info-circle"></i> Informaci√≥n';
        btnInfo.title = 'Ver informaci√≥n detallada';
        btnInfo.style.cssText = `
          background: rgba(59, 130, 246, 0.2); 
          border: 1px solid rgba(59, 130, 246, 0.3); 
          color: #3b82f6; 
          padding: 6px 12px; 
          border-radius: 6px; 
          cursor: pointer; 
          transition: all 0.3s ease; 
          font-size: 12px;
        `;
        btnInfo.onclick = function(e) {
          e.stopPropagation();
          try {
            const analisis = JSON.parse(val);
            mostrarAnalisisDetallado(analisis);
          } catch {
            alert('No hay informaci√≥n detallada disponible.');
          }
        };
        td.appendChild(btnInfo);
      } else {
        td.textContent = val;
      }
      html += td.outerHTML;
    });
    html += `</tr>`;
  });
  html += '</tbody></table></div>';
  contenedor.innerHTML = html;
  const tbody = contenedor.querySelector('tbody');
  let filaSeleccionada = null;
  tbody.addEventListener('click', function(e) {
    const fila = e.target.closest('tr');
    if (!fila) return;
    tbody.querySelectorAll('tr').forEach(f => f.classList.remove('selected'));
    fila.classList.add('selected');
    filaSeleccionada = fila;
    document.getElementById('btnPerfilElevacionMismo').style.display = 'inline-block';
  });
  document.getElementById('btnPerfilElevacionMismo').onclick = function() {
    if (!filaSeleccionada) return;
    const celdas = filaSeleccionada.querySelectorAll('td');
    const datos = {
      idA: celdas[1]?.textContent,
      nombreA: celdas[2]?.textContent,
      latA: celdas[3]?.textContent,
      lonA: celdas[4]?.textContent,
      idB: celdas[7]?.textContent,
      nombreB: celdas[8]?.textContent,
      latB: celdas[9]?.textContent,
      lonB: celdas[10]?.textContent,
      alturaA: buscarAlturaEnColumnas(celdas, 'Torre A'),
      alturaB: buscarAlturaEnColumnas(celdas, 'Torre B'),
      frecuencia: celdas[13]?.textContent
    };
    mostrarPerfilElevacionDesdeDatos(datos);
    const perfilDiv = document.getElementById('perfil-elevacion-con-torres');
    if (perfilDiv) {
      perfilDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  };
}
function resaltarFilaMismoTransporte(checkbox) {
  const fila = checkbox.closest('tr');
  if (checkbox.checked) {
    fila.classList.add('selected');
  } else {
    fila.classList.remove('selected');
  }
  const algunoSeleccionado = Array.from(document.querySelectorAll('#tabla-mismo-tipo .check-mismo-transporte')).some(cb => cb.checked);
  document.getElementById('btnEliminarSeleccionadosMismo').disabled = !algunoSeleccionado;
}
function toggleSeleccionarTodosMismo(master) {
  document.querySelectorAll('#tabla-mismo-tipo .check-mismo-transporte').forEach(cb => cb.checked = master.checked);
  document.getElementById('btnEliminarSeleccionadosMismo').disabled = !master.checked;
}
function seleccionarTodosMismoTransporte() {
  document.querySelectorAll('#tabla-mismo-tipo .check-mismo-transporte').forEach(cb => cb.checked = true);
  document.getElementById('btnEliminarSeleccionadosMismo').disabled = false;
}
function eliminarEnlacesSeleccionadosMismo() {
  if (!confirm('¬øSeguro que deseas eliminar los enlaces seleccionados?')) return;
  const checks = Array.from(document.querySelectorAll('#tabla-mismo-tipo .check-mismo-transporte'));
  const enlaces = JSON.parse(localStorage.getItem('enlacesMismoTransporte') || '[]');
  const nuevos = enlaces.filter((_, idx) => !checks[idx].checked);
  localStorage.setItem('enlacesMismoTransporte', JSON.stringify(nuevos));
  mostrarTablaMismoTransporte();
  document.getElementById('btnEliminarSeleccionadosMismo').disabled = true;
}
function exportarExcelMismoTransporte() {
  const tabla = document.getElementById('tabla-mismo-tipo');
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.table_to_sheet(tabla);
  XLSX.utils.book_append_sheet(wb, ws, "MismoTransporte");
  XLSX.writeFile(wb, "enlaces_mismo_transporte.xlsx");
}
function crearFilaEnlaceTemporal() {
  const get = id => document.getElementById(id).value.trim();
  const latA = parseFloat(get('latA'));
  const lonA = parseFloat(get('lonA'));
  const latB = parseFloat(get('latB'));
  const lonB = parseFloat(get('lonB'));
  if (!get('idA') || !get('idB')) return null;
  if (isNaN(latA) || isNaN(lonA) || isNaN(latB) || isNaN(lonB)) return null;
  const distanciaKm = calcularDistancia(latA, lonA, latB, lonB);
  const frecuencia = asignarFrecuencia(distanciaKm);
  const factibilidad = analizarFactibilidad(
    distanciaKm,
    get('ArreA'),
    get('ArreB'),
    get('TransA'),
    get('TransB'),
    get('TorreA'),
    get('TorreB'),
    get('OnA'),
    get('OnB'),
    window.ultimaFactibilidadLOS
  );
  const estadoFactible = (factibilidad.advertencia)
    ? 'FACTIBLE (Requiere an√°lisis)'
    : (factibilidad.razon && factibilidad.razon.toUpperCase().includes('NO DISPONIBLE'))
      ? 'NO DISPONIBLE'
      : (factibilidad.factible ? 'S√ç' : 'NO');
  const filaDatos = [
    get('idA'), get('nombreA'), get('latA'), get('lonA'),
    document.getElementById('latArad').value,
    document.getElementById('lonArad').value,
    get('idB'), get('nombreB'), get('latB'), get('lonB'),
    document.getElementById('latBrad').value,
    document.getElementById('lonBrad').value,
    distanciaKm.toFixed(6), frecuencia,
    document.getElementById('disponibilidadAnual').value,
    get('alturaA'), get('alturaB'), get('ranA'), get('ranB'),
    get('TransA'), get('TransB'), get('ArreA'), get('ArreB'),
    get('OnA'), get('OnB'), get('TorreA'), get('TorreB'),
    get('EstadoA'), get('EstadoB'),
    estadoFactible,
    factibilidad.diametroAntena,
    factibilidad.tipoEnlace,
    JSON.stringify(factibilidad)
  ];
  const fila = document.createElement('tr');
  const tdCheck = document.createElement('td');
  const check = document.createElement('input');
  check.type = 'checkbox';
  check.className = 'check-enlace';
  check.onclick = function(e) {
    e.stopPropagation();
    actualizarBotonEliminarSeleccionados();
  };
  tdCheck.appendChild(check);
  fila.appendChild(tdCheck);
  filaDatos.forEach((val, i) => {
    const td = document.createElement('td');
    if (i === 33) {
      const btn = document.createElement('button');
      btn.className = 'btn btn-info btn-sm';
      btn.innerHTML = '<i class="fas fa-info-circle"></i> Ver An√°lisis';
      btn.onclick = function(e) {
        e.stopPropagation();
        try {
          const analisis = JSON.parse(val);
          mostrarAnalisisDetallado(analisis);
        } catch {
          alert('No hay an√°lisis detallado disponible.');
        }
      };
      td.appendChild(btn);
      td.dataset.analisis = val;
    } else {
      td.textContent = val;
    }
    fila.appendChild(td);
  });
  aplicarEstiloFactibilidad(fila, factibilidad.factible);
  return fila;
}
function ordenarTablaPorFactibilidad() {
  guardarEnlacesEnStorage();
  actualizarContadorEnlaces();
  verificarEnlacesVacios();
  setTimeout(() => {
    if (typeof loader !== 'undefined' && document.body.contains(loader)) {
      document.body.removeChild(loader);
    }
    const procesadosCount = typeof procesados !== 'undefined' ? procesados : 0;
    const omitidosCount = typeof omitidos !== 'undefined' ? omitidos : 0;
    // Solo mostrar alert si no se ha mostrado antes
    if (!window.procesamientoCompletado) {
      alertSeguro(`‚úÖ Procesamiento de pares completado (${procesadosCount} enlaces agregados de ${dataPares.length} pares totales)\n‚ùå Omitidos por IDs vac√≠os: ${omitidosCount}`);
      window.procesamientoCompletado = true;
    }
    // REMOVIDO: mostrarPestana('enlaces'); - Esto causaba el bucle infinito
    if (typeof faltantes !== 'undefined' && faltantes.length > 0) {
      document.getElementById('btnDescargarFaltantes').style.display = 'inline-block';
      window.paresFaltantes = faltantes;
    } else {
      document.getElementById('btnDescargarFaltantes').style.display = 'none';
    }
  }, 200);
}
function exportarFactiblesParaPathloss() {
  const filasNormales = Array.from(document.querySelectorAll('#tabla tbody tr'));
  const filasMismo = [];
  const tablaMismo = document.getElementById('tabla-mismo-tipo');
  if (tablaMismo) {
    Array.from(tablaMismo.querySelectorAll('tbody tr')).forEach(tr => filasMismo.push(tr));
  }
  const filas = filasNormales.concat(filasMismo);
  const factibles = filas.filter(fila => {
    const celdas = fila.querySelectorAll('td');
    const val = celdas[30]?.textContent.trim().toUpperCase();
    return val === 'S√ç' || val.startsWith('FACTIBLE');
  });
  if (factibles.length === 0) {
    alert('No hay enlaces factibles para exportar');
    return;
  }
  const encabezado = [
    'ID A','Nombre A','Latitud A','Longitud A','ID B','Nombre B','Latitud B','Longitud B',
    'Arrendamiento A','Arrendamiento B','Tipo Torre A','Tipo Torre B','Transporte A','Transporte B',
    'Distancia (km)','Frecuencia (GHz)','Altura RAN A','Altura RAN B','Altura Torre A','Altura Torre B',
    'On Air A','On Air B','Antenas'
  ];
  const datos = factibles.map(fila => {
    const c = fila.querySelectorAll('td');
    return [
      c[1]?.textContent,   // ID A
      c[2]?.textContent,   // Nombre A
      c[3]?.textContent,   // Latitud A
      c[4]?.textContent,   // Longitud A
      c[7]?.textContent,   // ID B
      c[8]?.textContent,   // Nombre B
      c[9]?.textContent,   // Latitud B
      c[10]?.textContent,  // Longitud B
      c[22]?.textContent,  // Arrendamiento A
      c[23]?.textContent,  // Arrendamiento B
      c[26]?.textContent,  // Tipo Torre A
      c[27]?.textContent,  // Tipo Torre B
      c[20]?.textContent,  // Transporte A
      c[21]?.textContent,  // Transporte B
      c[13]?.textContent,  // Distancia (km)
      c[14]?.textContent,  // Frecuencia (GHz)
      c[18]?.textContent,  // Altura RAN A
      c[19]?.textContent,  // Altura RAN B
      c[16]?.textContent,  // Altura Torre A
      c[17]?.textContent,  // Altura Torre B
      c[24]?.textContent,  // On Air A
      c[25]?.textContent,  // On Air B
      c[31]?.textContent   // Antenas
    ].join(';');
  });
  const csv = [encabezado.join(';')].concat(datos).join('\n');
  const blob = new Blob([csv], {type: 'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'enlaces_factibles_pathloss.csv';
  a.click();
  URL.revokeObjectURL(url);
}
// Funci√≥n para actualizar datos t√©cnicos avanzados
function actualizarDatosTecnicosAvanzados() {
  // Obtener datos de las variables globales
  const distanciaKm = window.distanciaKm || 0;
  const frecuenciaGHz = window.frecuenciaGHz || 0;
  const lambda = window.lambda || 0;
  const perdidaEspacioLibre = window.perdidaEspacioLibre || 0;
  const EIRP = window.EIRP || 0;
  const nivelSe√±alCalculado = window.nivelSe√±alCalculado || 0;
  const margenEnlaceCalculado = window.margenEnlaceCalculado || 0;
  const SNR = window.SNR || 0;
  const ruidoTermico = window.ruidoTermico || 0;
  const disponibilidadAnual = window.disponibilidadAnual || 0;
  const margenDesvanecimiento = window.margenDesvanecimiento || 0;
  const perdidaLluvia = window.perdidaLluvia || 0;
  const atenuacionOxigeno = window.atenuacionOxigeno || 0;
  const atenuacionVapor = window.atenuacionVapor || 0;
  const atenuacionTotal = window.atenuacionTotal || 0;
  const potenciaTransmisor = window.potenciaTransmisor || 0;
  const gananciaAntenaA = window.gananciaAntenaA || 0;
  const perdidaCableA = window.perdidaCableA || 0;
  const sensibilidadReceptor = window.sensibilidadReceptor || 0;
  const anchoBanda = window.anchoBanda || 0;
  const puntosCriticos = window.puntosCriticos || [];
  const obstrucciones = window.obstrucciones || [];
  const alturaA = window.alturaA || 0;
  const alturaB = window.alturaB || 0;
  
  // Actualizar elementos del DOM
  document.getElementById('distancia-total-tecnico').textContent = distanciaKm.toFixed(2);
  document.getElementById('frecuencia-tecnico').textContent = frecuenciaGHz;
  document.getElementById('longitud-onda-tecnico').textContent = (lambda * 1000).toFixed(2);
  document.getElementById('factor-k-tecnico').textContent = '4/3';
  document.getElementById('altura-torre-a-tecnico').textContent = alturaA;
  document.getElementById('altura-torre-b-tecnico').textContent = alturaB;
  
  document.getElementById('perdida-espacio-libre').textContent = perdidaEspacioLibre.toFixed(1);
  document.getElementById('eirp-tecnico').textContent = EIRP.toFixed(1);
  document.getElementById('nivel-se√±al-tecnico').textContent = nivelSe√±alCalculado.toFixed(1);
  document.getElementById('margen-enlace-tecnico').textContent = margenEnlaceCalculado.toFixed(1);
  document.getElementById('snr-tecnico').textContent = SNR.toFixed(1);
  
  // Calcular radios de Fresnel (aproximaci√≥n)
  const radioFresnel100 = distanciaKm > 0 ? Math.sqrt((0.3 * distanciaKm * 1000) / (frecuenciaGHz * 4)) : 0;
  const radioFresnel60 = radioFresnel100 * 0.6;
  const radioFresnel20 = radioFresnel100 * 0.2;
  
  document.getElementById('radio-fresnel-100').textContent = radioFresnel100.toFixed(2);
  document.getElementById('radio-fresnel-60').textContent = radioFresnel60.toFixed(2);
  document.getElementById('radio-fresnel-20').textContent = radioFresnel20.toFixed(2);
  document.getElementById('clearance-minimo').textContent = (puntosCriticos.length > 0 ? puntosCriticos[0].clearance : 0).toFixed(2);
  document.getElementById('punto-critico-tecnico').textContent = puntosCriticos.length > 0 ? `${puntosCriticos[0].distancia.toFixed(2)} km` : 'N/A';
  
  document.getElementById('atenuacion-lluvia').textContent = perdidaLluvia.toFixed(2);
  document.getElementById('atenuacion-oxigeno').textContent = atenuacionOxigeno.toFixed(2);
  document.getElementById('atenuacion-vapor').textContent = atenuacionVapor.toFixed(2);
  document.getElementById('atenuacion-total-tecnico').textContent = atenuacionTotal.toFixed(2);
  document.getElementById('disponibilidad-anual').textContent = disponibilidadAnual.toFixed(2);
  
  // Determinar estado del enlace
  const estadoEnlace = margenEnlaceCalculado > 10 ? 'EXCELENTE' : 
                      margenEnlaceCalculado > 5 ? 'BUENO' : 
                      margenEnlaceCalculado > 0 ? 'ACEPTABLE' : 'CR√çTICO';
  
  document.getElementById('estado-enlace').textContent = estadoEnlace;
  document.getElementById('obstrucciones-tecnico').textContent = obstrucciones.length;
  document.getElementById('margen-desvanecimiento').textContent = margenDesvanecimiento.toFixed(1);
  document.getElementById('ruido-termico').textContent = ruidoTermico.toFixed(1);
  document.getElementById('calidad-enlace').textContent = SNR > 20 ? 'ALTA' : SNR > 15 ? 'MEDIA' : 'BAJA';
  
  document.getElementById('potencia-transmision').textContent = potenciaTransmisor;
  document.getElementById('ganancia-antena').textContent = gananciaAntenaA;
  document.getElementById('perdidas-cable').textContent = perdidaCableA;
  document.getElementById('sensibilidad-receptor').textContent = sensibilidadReceptor;
  document.getElementById('ancho-banda-tecnico').textContent = (anchoBanda / 1e6).toFixed(0);
}
// Variables globales para la tabla interactiva
let currentPage = 1;
let pageSize = 25;
let currentSort = { column: null, direction: 'asc' };
let filteredData = [];
let allTableData = [];

// Funci√≥n para inicializar la tabla interactiva
function inicializarTablaInteractiva() {
  // Event listeners para b√∫squeda y filtros
  document.getElementById('searchTable').addEventListener('input', filtrarTabla);
  document.getElementById('filterEstado').addEventListener('change', filtrarTabla);
  document.getElementById('filterDistancia').addEventListener('change', filtrarTabla);
  document.getElementById('btnLimpiarFiltros').addEventListener('click', limpiarFiltros);
  document.getElementById('pageSize').addEventListener('change', cambiarTama√±oPagina);
  document.getElementById('btnPrevPage').addEventListener('click', paginaAnterior);
  document.getElementById('btnNextPage').addEventListener('click', paginaSiguiente);
  document.getElementById('btnToggleView').addEventListener('click', toggleVistaTabla);
  document.getElementById('btnExportarSeleccionados').addEventListener('click', exportarSeleccionados);
  document.getElementById('btnAccionesRapidas').addEventListener('click', mostrarAccionesRapidas);
  
  // Event listeners para ordenamiento
  document.querySelectorAll('.sortable').forEach(th => {
    th.addEventListener('click', () => ordenarTabla(th.dataset.sort));
    th.addEventListener('mouseenter', () => {
      th.style.background = 'rgba(59, 130, 246, 0.3)';
    });
    th.addEventListener('mouseleave', () => {
      if (!th.classList.contains('sorted')) {
        th.style.background = 'transparent';
      }
    });
  });
}

// Funci√≥n para filtrar la tabla
function filtrarTabla() {
  const searchTerm = document.getElementById('searchTable').value.toLowerCase();
  const estadoFilter = document.getElementById('filterEstado').value;
  const distanciaFilter = document.getElementById('filterDistancia').value;
  
  filteredData = allTableData.filter(enlace => {
    // B√∫squeda en texto
    const searchMatch = !searchTerm || 
      enlace.idA.toLowerCase().includes(searchTerm) ||
      enlace.nombreA.toLowerCase().includes(searchTerm) ||
      enlace.idB.toLowerCase().includes(searchTerm) ||
      enlace.nombreB.toLowerCase().includes(searchTerm);
    
    // Filtro por estado
    const estadoMatch = !estadoFilter || 
      (estadoFilter === 'factible' && enlace.factible === 'S√≠') ||
      (estadoFilter === 'no-factible' && enlace.factible === 'No');
    
    // Filtro por distancia
    let distanciaMatch = true;
    if (distanciaFilter) {
      const distancia = parseFloat(enlace.distancia);
      if (distanciaFilter === '0-5') distanciaMatch = distancia <= 5;
      else if (distanciaFilter === '5-15') distanciaMatch = distancia > 5 && distancia <= 15;
      else if (distanciaFilter === '15+') distanciaMatch = distancia > 15;
    }
    
    return searchMatch && estadoMatch && distanciaMatch;
  });
  
  currentPage = 1;
  actualizarTabla();
  actualizarEstadisticas();
}

// Funci√≥n para limpiar filtros
function limpiarFiltros() {
  document.getElementById('searchTable').value = '';
  document.getElementById('filterEstado').value = '';
  document.getElementById('filterDistancia').value = '';
  filteredData = [...allTableData];
  currentPage = 1;
  actualizarTabla();
  actualizarEstadisticas();
}

// Funci√≥n para ordenar tabla
function ordenarTabla(columna) {
  const th = document.querySelector(`[data-sort="${columna}"]`);
  
  // Limpiar indicadores de ordenamiento anteriores
  document.querySelectorAll('.sortable').forEach(el => {
    el.classList.remove('sorted', 'asc', 'desc');
    el.querySelector('.sort-icon').className = 'fas fa-sort sort-icon';
    el.querySelector('.sort-icon').style.opacity = '0.5';
  });
  
  // Determinar direcci√≥n de ordenamiento
  if (currentSort.column === columna) {
    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
  } else {
    currentSort.column = columna;
    currentSort.direction = 'asc';
  }
  
  // Actualizar indicador visual
  th.classList.add('sorted', currentSort.direction);
  const icon = th.querySelector('.sort-icon');
  icon.className = `fas fa-sort-${currentSort.direction === 'asc' ? 'up' : 'down'} sort-icon`;
  icon.style.opacity = '1';
  
  // Ordenar datos
  filteredData.sort((a, b) => {
    let aVal = a[columna];
    let bVal = b[columna];
    
    // Convertir a n√∫meros si es posible
    if (columna === 'distancia' || columna === 'frecuencia') {
      aVal = parseFloat(aVal) || 0;
      bVal = parseFloat(bVal) || 0;
    }
    
    if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
    if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
    return 0;
  });
  
  actualizarTabla();
}

// Funci√≥n para cambiar tama√±o de p√°gina
function cambiarTama√±oPagina() {
  pageSize = parseInt(document.getElementById('pageSize').value);
  currentPage = 1;
  actualizarTabla();
}

// Funci√≥n para navegaci√≥n de p√°ginas
function paginaAnterior() {
  if (currentPage > 1) {
    currentPage--;
    actualizarTabla();
  }
}

function paginaSiguiente() {
  const totalPages = Math.ceil(filteredData.length / pageSize);
  if (currentPage < totalPages) {
    currentPage++;
    actualizarTabla();
  }
}

// Funci√≥n para actualizar tabla
function actualizarTabla() {
  const tbody = document.querySelector('#tabla tbody');
  const startIndex = (currentPage - 1) * pageSize;
  const endIndex = startIndex + pageSize;
  const pageData = filteredData.slice(startIndex, endIndex);
  
  tbody.innerHTML = '';
  
  pageData.forEach((enlace, index) => {
    const row = document.createElement('tr');
    row.style.cssText = `
      background: ${index % 2 === 0 ? 'rgba(30, 41, 59, 0.5)' : 'rgba(15, 23, 42, 0.8)'};
      transition: all 0.3s ease;
      border-bottom: 1px solid rgba(59, 130, 246, 0.1);
    `;
    
    // Hover effect
    row.addEventListener('mouseenter', () => {
      row.style.background = 'rgba(59, 130, 246, 0.1)';
      row.style.transform = 'scale(1.01)';
    });
    row.addEventListener('mouseleave', () => {
      row.style.background = index % 2 === 0 ? 'rgba(30, 41, 59, 0.5)' : 'rgba(15, 23, 42, 0.8)';
      row.style.transform = 'scale(1)';
    });
    
    // Estado visual del enlace
    const estadoBadge = enlace.factible === 'S√≠' 
      ? '<span style="background: rgba(16, 185, 129, 0.2); color: #10b981; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;"><i class="fas fa-check"></i> Factible</span>'
      : '<span style="background: rgba(239, 68, 68, 0.2); color: #ef4444; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;"><i class="fas fa-times"></i> No Factible</span>';
    
    row.innerHTML = `
      <td style="padding: 12px 8px; text-align: center;">
        <input type="checkbox" class="check-enlace" style="transform: scale(1.1);">
      </td>
      <td style="padding: 12px 8px; text-align: center; font-weight: 600; color: #3b82f6;">${enlace.idA}</td>
      <td style="padding: 12px 8px; text-align: center;">${enlace.nombreA}</td>
      <td style="padding: 12px 8px; text-align: center; font-family: monospace;">${enlace.latA}</td>
      <td style="padding: 12px 8px; text-align: center; font-family: monospace;">${enlace.lonA}</td>
      <td style="padding: 12px 8px; text-align: center; font-family: monospace;">${enlace.latArad}</td>
      <td style="padding: 12px 8px; text-align: center; font-family: monospace;">${enlace.lonArad}</td>
      <td style="padding: 12px 8px; text-align: center; font-weight: 600; color: #3b82f6;">${enlace.idB}</td>
      <td style="padding: 12px 8px; text-align: center;">${enlace.nombreB}</td>
      <td style="padding: 12px 8px; text-align: center; font-family: monospace;">${enlace.latB}</td>
      <td style="padding: 12px 8px; text-align: center; font-family: monospace;">${enlace.lonB}</td>
      <td style="padding: 12px 8px; text-align: center; font-family: monospace;">${enlace.latBrad}</td>
      <td style="padding: 12px 8px; text-align: center; font-family: monospace;">${enlace.lonBrad}</td>
      <td style="padding: 12px 8px; text-align: center; font-weight: 600; color: #f59e0b;">${enlace.distancia} km</td>
      <td style="padding: 12px 8px; text-align: center; font-weight: 600; color: #8b5cf6;">${enlace.frecuencia} GHz</td>
      <td style="padding: 12px 8px; text-align: center;">${enlace.disponibilidad}</td>
      <td style="padding: 12px 8px; text-align: center;">${enlace.alturaA}</td>
      <td style="padding: 12px 8px; text-align: center;">${enlace.alturaB}</td>
      <td style="padding: 12px 8px; text-align: center;">${enlace.ranA}</td>
      <td style="padding: 12px 8px; text-align: center;">${enlace.ranB}</td>
      <td style="padding: 12px 8px; text-align: center;">${enlace.transA}</td>
      <td style="padding: 12px 8px; text-align: center;">${enlace.transB}</td>
      <td style="padding: 12px 8px; text-align: center;">${enlace.arreA}</td>
      <td style="padding: 12px 8px; text-align: center;">${enlace.arreB}</td>
      <td style="padding: 12px 8px; text-align: center;">${enlace.onA}</td>
      <td style="padding: 12px 8px; text-align: center;">${enlace.onB}</td>
      <td style="padding: 12px 8px; text-align: center;">${enlace.torreA}</td>
      <td style="padding: 12px 8px; text-align: center;">${enlace.torreB}</td>
      <td style="padding: 12px 8px; text-align: center;">${enlace.estadoA}</td>
      <td style="padding: 12px 8px; text-align: center;">${enlace.estadoB}</td>
      <td style="padding: 12px 8px; text-align: center;">${estadoBadge}</td>
      <td style="padding: 12px 8px; text-align: center;">${enlace.antenas}</td>
      <td style="padding: 12px 8px; text-align: center;">${enlace.tipoEnlace}</td>
      <td style="padding: 12px 8px; text-align: center;">
        <button onclick="mostrarInformacionEnlace('${enlace.analisis}')" title="Ver informaci√≥n detallada" style="background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.3); color: #3b82f6; padding: 6px 12px; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; font-size: 12px;">
          <i class="fas fa-info-circle"></i> Informaci√≥n
        </button>
      </td>
      <td style="padding: 12px 8px; text-align: center; width: 200px;">
        <div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;">
          <button onclick="verEnlaceEnMapa('${enlace.idA}', '${enlace.idB}')" title="Ver en mapa" style="background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.3); color: #3b82f6; padding: 8px 12px; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; font-size: 12px; min-width: 80px;">
            <i class="fas fa-map" style="margin-right: 4px;"></i>Mapa
          </button>
          <button onclick="generarPerfilEnlaceConDatos({idA:'${enlace.idA}', nombreA:'${enlace.nombreA}', latA:'${enlace.latA}', lonA:'${enlace.lonA}', idB:'${enlace.idB}', nombreB:'${enlace.nombreB}', latB:'${enlace.latB}', lonB:'${enlace.lonB}', alturaA:'${enlace.alturaA}', alturaB:'${enlace.alturaB}', frecuencia:'${enlace.frecuencia}'})" title="Generar perfil de elevaci√≥n" style="background: rgba(16, 185, 129, 0.2); border: 1px solid rgba(16, 185, 129, 0.3); color: #10b981; padding: 8px 12px; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; font-size: 12px; min-width: 80px;">
            <i class="fas fa-mountain" style="margin-right: 4px;"></i>Perfil
          </button>
          <button onclick="editarEnlace('${enlace.idA}', '${enlace.idB}')" title="Editar enlace" style="background: rgba(245, 158, 11, 0.2); border: 1px solid rgba(245, 158, 11, 0.3); color: #f59e0b; padding: 8px 12px; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; font-size: 12px; min-width: 80px;">
            <i class="fas fa-edit" style="margin-right: 4px;"></i>Editar
          </button>
          <button onclick="duplicarEnlace('${enlace.idA}', '${enlace.idB}')" title="Duplicar enlace" style="background: rgba(139, 92, 246, 0.2); border: 1px solid rgba(139, 92, 246, 0.3); color: #8b5cf6; padding: 8px 12px; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; font-size: 12px; min-width: 80px;">
            <i class="fas fa-copy" style="margin-right: 4px;"></i>Copiar
          </button>
        </div>
      </td>
    `;
    
    tbody.appendChild(row);
  });
  
  actualizarPaginacion();
}

// Funci√≥n para actualizar paginaci√≥n
function actualizarPaginacion() {
  const totalPages = Math.ceil(filteredData.length / pageSize);
  const startItem = (currentPage - 1) * pageSize + 1;
  const endItem = Math.min(currentPage * pageSize, filteredData.length);
  
  document.getElementById('pageInfo').textContent = `P√°gina ${currentPage} de ${totalPages} (${startItem}-${endItem} de ${filteredData.length})`;
  document.getElementById('btnPrevPage').disabled = currentPage === 1;
  document.getElementById('btnNextPage').disabled = currentPage === totalPages;
}

// Funci√≥n para actualizar estad√≠sticas
function actualizarEstadisticas() {
  const totalEnlaces = filteredData.length;
  const factibles = filteredData.filter(e => e.factible === 'S√≠').length;
  
  document.getElementById('totalEnlacesStats').textContent = totalEnlaces;
  document.getElementById('factiblesStats').textContent = factibles;
}

// Funci√≥n para toggle vista compacta
function toggleVistaTabla() {
  const tabla = document.getElementById('tabla');
  const btn = document.getElementById('btnToggleView');
  
  if (tabla.classList.contains('compact-view')) {
    tabla.classList.remove('compact-view');
    btn.innerHTML = '<i class="fas fa-compress"></i> Compacto';
    btn.title = 'Cambiar a vista compacta';
  } else {
    tabla.classList.add('compact-view');
    btn.innerHTML = '<i class="fas fa-expand"></i> Expandido';
    btn.title = 'Cambiar a vista expandida';
  }
}

// Funci√≥n para exportar seleccionados
function exportarSeleccionados() {
  const seleccionados = Array.from(document.querySelectorAll('#tabla tbody .check-enlace:checked'))
    .map(cb => cb.closest('tr'))
    .map(row => {
      const celdas = row.querySelectorAll('td');
      return {
        idA: celdas[1].textContent,
        nombreA: celdas[2].textContent,
        latA: celdas[3].textContent,
        lonA: celdas[4].textContent,
        distancia: celdas[5].textContent,
        frecuencia: celdas[6].textContent,
        estado: celdas[7].textContent
      };
    });
  
  if (seleccionados.length === 0) {
    mostrarNotificacion('Selecciona al menos un enlace para exportar', 'warning');
    return;
  }
  
  // Crear CSV
  const csv = [
    ['ID A', 'Nombre A', 'Lat A', 'Lon A', 'Distancia', 'Frecuencia', 'Estado'],
    ...seleccionados.map(e => [e.idA, e.nombreA, e.latA, e.lonA, e.distancia, e.frecuencia, e.estado])
  ].map(row => row.join(',')).join('\n');
  
  // Descargar archivo
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `enlaces_seleccionados_${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  window.URL.revokeObjectURL(url);
  
  mostrarNotificacion(`${seleccionados.length} enlaces exportados exitosamente`, 'success');
}

// Funciones de acciones r√°pidas
function verEnlaceEnMapa(idA, idB) {
  mostrarNotificacion(`Mostrando enlace ${idA} - ${idB} en el mapa`, 'info');
  // Aqu√≠ ir√≠a la l√≥gica para mostrar en el mapa
}

function generarPerfilEnlace(idA, idB) {
  mostrarNotificacion(`Generando perfil para enlace ${idA} - ${idB}`, 'info');
  // Aqu√≠ ir√≠a la l√≥gica para generar perfil
}

function editarEnlace(idA, idB) {
  mostrarNotificacion(`Editando enlace ${idA} - ${idB}`, 'info');
  // Aqu√≠ ir√≠a la l√≥gica para editar
}

function duplicarEnlace(idA, idB) {
  mostrarNotificacion(`Duplicando enlace ${idA} - ${idB}`, 'info');
  // Aqu√≠ ir√≠a la l√≥gica para duplicar
}
// Funci√≥n para generar perfil de elevaci√≥n con datos completos
function generarPerfilEnlaceConDatos(datos) {
  console.log('Generando perfil con datos:', datos);
  
  // Actualizar los nombres de las torres
  actualizarNombresTorres(
    datos.idA, 
    datos.nombreA, 
    parseFloat(datos.alturaA) || 0,
    datos.idB, 
    datos.nombreB, 
    parseFloat(datos.alturaB) || 0
  );
  
  // Mostrar el perfil de elevaci√≥n
  mostrarPerfilElevacionDesdeDatos(datos);
  
  // Hacer scroll al perfil
  const perfilDiv = document.getElementById('perfil-elevacion-con-torres');
  if (perfilDiv) {
    perfilDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
  
  mostrarNotificacion(`Perfil de elevaci√≥n generado para ${datos.nombreA} - ${datos.nombreB}`, 'success');
}

// Funci√≥n para mostrar informaci√≥n del enlace
function mostrarInformacionEnlace(analisisString) {
  try {
    const analisis = JSON.parse(analisisString);
    mostrarAnalisisDetallado(analisis);
  } catch (error) {
    console.error('Error al parsear an√°lisis:', error);
    alert('No hay informaci√≥n detallada disponible para este enlace.');
  }
}
// Funci√≥n para mostrar panel de acciones r√°pidas
function mostrarAccionesRapidas() {
  const modal = document.createElement('div');
  modal.style = `
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; 
    background: rgba(0,0,0,0.8); display: flex; align-items: center; 
    justify-content: center; z-index: 99999; backdrop-filter: blur(10px);
  `;
  
  modal.innerHTML = `
    <div style="background: rgba(15,23,42,0.98); border: 2px solid rgba(59,130,246,0.4); 
         border-radius: 20px; padding: 30px; max-width: 600px; width: 90%; 
         backdrop-filter: blur(20px); box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <h3 style="color: #3b82f6; margin: 0; font-size: 20px;">
          <i class="fas fa-bolt" style="margin-right: 10px;"></i>Acciones R√°pidas
        </h3>
        <button onclick="this.closest('div[style*=\'position: fixed\']').remove()" style="background: none; border: none; color: #cbd5e1; font-size: 24px; cursor: pointer;">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
        <button onclick="seleccionarTodosEnlaces()" style="background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.4); color: #3b82f6; padding: 15px; border-radius: 10px; cursor: pointer; transition: all 0.3s ease; text-align: left;">
          <i class="fas fa-check-double" style="margin-right: 10px; font-size: 16px;"></i>
          <strong>Seleccionar Todos</strong><br>
          <small>Selecciona todos los enlaces visibles</small>
        </button>
        
        <button onclick="deseleccionarTodosEnlaces()" style="background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.4); color: #ef4444; padding: 15px; border-radius: 10px; cursor: pointer; transition: all 0.3s ease; text-align: left;">
          <i class="fas fa-times" style="margin-right: 10px; font-size: 16px;"></i>
          <strong>Deseleccionar Todos</strong><br>
          <small>Quita la selecci√≥n de todos</small>
        </button>
        
        <button onclick="exportarSoloFactibles()" style="background: rgba(16, 185, 129, 0.2); border: 1px solid rgba(16, 185, 129, 0.4); color: #10b981; padding: 15px; border-radius: 10px; cursor: pointer; transition: all 0.3s ease; text-align: left;">
          <i class="fas fa-download" style="margin-right: 10px; font-size: 16px;"></i>
          <strong>Exportar Solo Factibles</strong><br>
          <small>Exporta solo enlaces factibles</small>
        </button>
        
        <button onclick="generarPerfilesMasivos()" style="background: rgba(245, 158, 11, 0.2); border: 1px solid rgba(245, 158, 11, 0.4); color: #f59e0b; padding: 15px; border-radius: 10px; cursor: pointer; transition: all 0.3s ease; text-align: left;">
          <i class="fas fa-mountain" style="margin-right: 10px; font-size: 16px;"></i>
          <strong>Generar Perfiles Masivos</strong><br>
          <small>Genera perfiles para seleccionados</small>
        </button>
        
        <button onclick="compararEnlacesSeleccionados()" style="background: rgba(139, 92, 246, 0.2); border: 1px solid rgba(139, 92, 246, 0.4); color: #8b5cf6; padding: 15px; border-radius: 10px; cursor: pointer; transition: all 0.3s ease; text-align: left;">
          <i class="fas fa-balance-scale" style="margin-right: 10px; font-size: 16px;"></i>
          <strong>Comparar Enlaces</strong><br>
          <small>Compara enlaces seleccionados</small>
        </button>
        
        <button onclick="estadisticasAvanzadas()" style="background: rgba(6, 182, 212, 0.2); border: 1px solid rgba(6, 182, 212, 0.4); color: #06b6d4; padding: 15px; border-radius: 10px; cursor: pointer; transition: all 0.3s ease; text-align: left;">
          <i class="fas fa-chart-bar" style="margin-right: 10px; font-size: 16px;"></i>
          <strong>Estad√≠sticas Avanzadas</strong><br>
          <small>Ver an√°lisis detallado</small>
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Efectos hover para los botones
  modal.querySelectorAll('button').forEach(btn => {
    btn.addEventListener('mouseenter', () => {
      btn.style.transform = 'translateY(-3px) scale(1.02)';
      btn.style.boxShadow = '0 8px 25px rgba(0,0,0,0.3)';
    });
    btn.addEventListener('mouseleave', () => {
      btn.style.transform = 'translateY(0) scale(1)';
      btn.style.boxShadow = 'none';
    });
  });
}

// Funciones para acciones r√°pidas
function seleccionarTodosEnlaces() {
  document.querySelectorAll('#tabla tbody .check-enlace').forEach(cb => cb.checked = true);
  mostrarNotificacion('Todos los enlaces visibles han sido seleccionados', 'success');
}

function deseleccionarTodosEnlaces() {
  document.querySelectorAll('#tabla tbody .check-enlace').forEach(cb => cb.checked = false);
  mostrarNotificacion('Se ha quitado la selecci√≥n de todos los enlaces', 'info');
}

function exportarSoloFactibles() {
  const factibles = filteredData.filter(e => e.factible === 'S√≠');
  if (factibles.length === 0) {
    mostrarNotificacion('No hay enlaces factibles para exportar', 'warning');
    return;
  }
  
  const csv = [
    ['ID A', 'Nombre A', 'Lat A', 'Lon A', 'Distancia', 'Frecuencia', 'Estado'],
    ...factibles.map(e => [e.idA, e.nombreA, e.latA, e.lonA, e.distancia, e.frecuencia, 'Factible'])
  ].map(row => row.join(',')).join('\n');
  
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `enlaces_factibles_${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  window.URL.revokeObjectURL(url);
  
  mostrarNotificacion(`${factibles.length} enlaces factibles exportados`, 'success');
}

function generarPerfilesMasivos() {
  const seleccionados = Array.from(document.querySelectorAll('#tabla tbody .check-enlace:checked')).length;
  if (seleccionados === 0) {
    mostrarNotificacion('Selecciona al menos un enlace para generar perfiles', 'warning');
    return;
  }
  
  mostrarNotificacion(`Generando ${seleccionados} perfiles de elevaci√≥n...`, 'info');
  // Aqu√≠ ir√≠a la l√≥gica para generar perfiles masivos
}

function compararEnlacesSeleccionados() {
  const seleccionados = Array.from(document.querySelectorAll('#tabla tbody .check-enlace:checked')).length;
  if (seleccionados < 2) {
    mostrarNotificacion('Selecciona al menos 2 enlaces para comparar', 'warning');
    return;
  }
  
  mostrarNotificacion(`Comparando ${seleccionados} enlaces seleccionados...`, 'info');
  // Aqu√≠ ir√≠a la l√≥gica para comparar enlaces
}

function estadisticasAvanzadas() {
  const total = filteredData.length;
  const factibles = filteredData.filter(e => e.factible === 'S√≠').length;
  const noFactibles = total - factibles;
  const promedioDistancia = filteredData.reduce((sum, e) => sum + parseFloat(e.distancia), 0) / total;
  
  const modal = document.createElement('div');
  modal.style = `
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; 
    background: rgba(0,0,0,0.8); display: flex; align-items: center; 
    justify-content: center; z-index: 99999; backdrop-filter: blur(10px);
  `;
  
  modal.innerHTML = `
    <div style="background: rgba(15,23,42,0.98); border: 2px solid rgba(6,182,212,0.4); 
         border-radius: 20px; padding: 30px; max-width: 500px; width: 90%; 
         backdrop-filter: blur(20px); box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <h3 style="color: #06b6d4; margin: 0; font-size: 20px;">
          <i class="fas fa-chart-bar" style="margin-right: 10px;"></i>Estad√≠sticas Avanzadas
        </h3>
        <button onclick="this.closest('div[style*=\'position: fixed\']').remove()" style="background: none; border: none; color: #cbd5e1; font-size: 24px; cursor: pointer;">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div style="display: grid; gap: 15px;">
        <div style="background: rgba(59, 130, 246, 0.1); padding: 15px; border-radius: 10px; border: 1px solid rgba(59, 130, 246, 0.3);">
          <strong style="color: #3b82f6;">üìä Total de Enlaces:</strong> ${total}
        </div>
        <div style="background: rgba(16, 185, 129, 0.1); padding: 15px; border-radius: 10px; border: 1px solid rgba(16, 185, 129, 0.3);">
          <strong style="color: #10b981;">‚úÖ Enlaces Factibles:</strong> ${factibles} (${((factibles/total)*100).toFixed(1)}%)
        </div>
        <div style="background: rgba(239, 68, 68, 0.1); padding: 15px; border-radius: 10px; border: 1px solid rgba(239, 68, 68, 0.3);">
          <strong style="color: #ef4444;">‚ùå Enlaces No Factibles:</strong> ${noFactibles} (${((noFactibles/total)*100).toFixed(1)}%)
        </div>
        <div style="background: rgba(245, 158, 11, 0.1); padding: 15px; border-radius: 10px; border: 1px solid rgba(245, 158, 11, 0.3);">
          <strong style="color: #f59e0b;">üìè Distancia Promedio:</strong> ${promedioDistancia.toFixed(2)} km
        </div>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
}

// Funci√≥n para actualizar la tabla interactiva con los datos existentes
function actualizarTablaInteractiva() {
  const filas = document.querySelectorAll('#tabla tbody tr');
  allTableData = [];
  
  filas.forEach(fila => {
    const celdas = fila.querySelectorAll('td');
    if (celdas.length >= 30) { // Ahora tenemos muchas m√°s columnas
      // Obtener todos los datos del dataset de la fila
      const enlace = {
        idA: celdas[1]?.textContent || '',
        nombreA: celdas[2]?.textContent || '',
        latA: celdas[3]?.textContent || '',
        lonA: celdas[4]?.textContent || '',
        latArad: celdas[5]?.textContent || '',
        lonArad: celdas[6]?.textContent || '',
        idB: celdas[7]?.textContent || '',
        nombreB: celdas[8]?.textContent || '',
        latB: celdas[9]?.textContent || '',
        lonB: celdas[10]?.textContent || '',
        latBrad: celdas[11]?.textContent || '',
        lonBrad: celdas[12]?.textContent || '',
        distancia: celdas[13]?.textContent.replace(' km', '') || '0',
        frecuencia: celdas[14]?.textContent.replace(' GHz', '') || '0',
        disponibilidad: celdas[15]?.textContent || '',
        alturaA: buscarAlturaEnColumnas(celdas, 'Torre A') || '0',
        alturaB: buscarAlturaEnColumnas(celdas, 'Torre B') || '0',
        ranA: celdas[18]?.textContent || '',
        ranB: celdas[19]?.textContent || '',
        transA: celdas[20]?.textContent || '',
        transB: celdas[21]?.textContent || '',
        arreA: celdas[22]?.textContent || '',
        arreB: celdas[23]?.textContent || '',
        onA: celdas[24]?.textContent || '',
        onB: celdas[25]?.textContent || '',
        torreA: celdas[26]?.textContent || '',
        torreB: celdas[27]?.textContent || '',
        estadoA: celdas[28]?.textContent || '',
        estadoB: celdas[29]?.textContent || '',
        factible: celdas[30]?.textContent.includes('Factible') ? 'S√≠' : 'No',
        antenas: celdas[31]?.textContent || '',
        tipoEnlace: celdas[32]?.textContent || '',
        analisis: celdas[33]?.textContent || ''
      };
      allTableData.push(enlace);
    }
  });
  
  // Inicializar datos filtrados
  filteredData = [...allTableData];
  
  // Actualizar tabla y estad√≠sticas
  actualizarTabla();
  actualizarEstadisticas();
}



// Funci√≥n para probar selecci√≥n manualmente
function probarSeleccionManual() {
  console.log('üß™ Probando selecci√≥n manual...');
  
  // Buscar el primer checkbox disponible
  const primerCheckbox = document.querySelector('#tabla tbody .check-enlace');
  
  if (primerCheckbox) {
    console.log('‚úÖ Checkbox encontrado, simulando selecci√≥n...');
    
    // Simular clic en el checkbox
    primerCheckbox.checked = true;
    
    // Disparar evento de cambio
    const event = new Event('change', { bubbles: true });
    primerCheckbox.dispatchEvent(event);
    
    console.log('‚úÖ Selecci√≥n simulada completada');
    mostrarNotificacion('üß™ Selecci√≥n de prueba activada', 'success');
  } else {
    console.log('‚ùå No se encontraron checkboxes');
    mostrarNotificacion('‚ùå No hay checkboxes disponibles para probar', 'error');
  }
}

// Funci√≥n para forzar la aparici√≥n del bot√≥n flotante
function forzarBotonFlotante() {
  console.log('üîß Forzando aparici√≥n del bot√≥n flotante...');
  
  // Remover bot√≥n existente si hay uno
  const botonExistente = document.getElementById('btnRegresarEnlaces');
  if (botonExistente) {
    botonExistente.remove();
  }
  
  // Crear bot√≥n flotante de emergencia completamente nuevo
  console.log('üî® Creando bot√≥n de emergencia...');
  const botonEmergencia = document.createElement('button');
  botonEmergencia.id = 'btnRegresarEnlaces';
  botonEmergencia.innerHTML = '<i class="fas fa-arrow-left"></i> REGRESAR A ENLACES';
  botonEmergencia.style.cssText = `
    position: fixed !important;
    top: 20px !important;
    right: 20px !important;
    z-index: 999999 !important;
    padding: 12px 20px !important;
    border-radius: 20px !important;
    box-shadow: 0 6px 20px rgba(0,0,0,0.6) !important;
    background: linear-gradient(135deg, #ef4444, #dc2626) !important;
    border: none !important;
    color: white !important;
    font-weight: 700 !important;
    font-size: 13px !important;
    cursor: pointer !important;
    transition: all 0.3s ease !important;
    animation: slideInRight 0.5s ease !important;
    font-family: 'Inter', sans-serif !important;
    text-transform: uppercase !important;
    letter-spacing: 0.5px !important;
    display: block !important;
    pointer-events: auto !important;
    margin: 0 !important;
    outline: none !important;
    min-width: 180px !important;
    text-align: center !important;
    left: auto !important;
  `;
  
  botonEmergencia.onclick = function() {
    console.log('üîÑ Bot√≥n de emergencia clickeado');
    // Deseleccionar todos los enlaces
    document.querySelectorAll('#tabla tbody .check-enlace').forEach(cb => cb.checked = false);
    const checkTodos = document.getElementById('checkTodos');
    if (checkTodos) checkTodos.checked = false;
    
    // Ocultar bot√≥n
    this.style.display = 'none';
    
    // Mostrar notificaci√≥n
    mostrarNotificacion('üîÑ Regresando a vista de enlaces...', 'success');
  };
  
  botonEmergencia.onmouseenter = function() {
    this.style.transform = 'scale(1.15) !important';
    this.style.boxShadow = '0 15px 50px rgba(0,0,0,0.8) !important';
    this.style.background = 'linear-gradient(135deg, #dc2626, #b91c1c) !important';
  };
  
  botonEmergencia.onmouseleave = function() {
    this.style.transform = 'scale(1) !important';
    this.style.boxShadow = '0 10px 40px rgba(0,0,0,0.6) !important';
    this.style.background = 'linear-gradient(135deg, #ef4444, #dc2626) !important';
  };
  
  document.body.appendChild(botonEmergencia);
  console.log('‚úÖ Bot√≥n de emergencia creado y agregado');
  console.log('‚úÖ Bot√≥n de emergencia mostrado');
  
  // Mostrar notificaci√≥n
  mostrarNotificacion('üîß Bot√≥n flotante forzado - ¬°Deber√≠a ser visible ahora!', 'warning');
}

// Funci√≥n simple para detener procesamiento
function detenerProcesamiento() {
  console.log('üõë Deteniendo procesamiento...');
  window.procesandoPares = false;
  window.procesamientoCompletado = false;
  
  // Limpiar timeouts
  for (let i = 1; i < 1000; i++) {
    clearTimeout(i);
  }
  
  // Remover loader
  const loader = document.getElementById('loader-procesando');
  if (loader && document.body.contains(loader)) {
    document.body.removeChild(loader);
  }
  
  mostrarNotificacion('üõë Procesamiento detenido', 'warning');
}

// Funci√≥n para reemplazar alert temporalmente
function alertSeguro(mensaje) {
  // Protecci√≥n contra bucles - solo mostrar una vez
  if (window.ultimoAlert === mensaje) {
    return;
  }
  
  window.ultimoAlert = mensaje;
  
  // Si el procesamiento est√° detenido, no mostrar alert
  if (!window.procesandoPares) {
    return;
  }
  
  // Mostrar notificaci√≥n en lugar de alert
  mostrarNotificacion(mensaje, 'info');
  
  // Limpiar el flag despu√©s de 3 segundos
  setTimeout(() => {
    window.ultimoAlert = null;
  }, 3000);
}





// DESHABILITADO: Event listener duplicado que causaba bucles
// document.addEventListener('DOMContentLoaded', limpiarEstadoInicial);



// FUNCI√ìN PARA OBTENER PERFIL DE ELEVACI√ìN REAL MEJORADA
window.obtenerPerfilElevacionReal = async function(latA, lonA, latB, lonB) {
  console.log('üöÄ Obteniendo perfil de elevaci√≥n REAL MEJORADO...');
  console.log('üìç Coordenadas:', {latA, lonA, latB, lonB});
  
  // Verificar APIs disponibles
  console.log('üéØ APIs disponibles:', {
    mapbox: !!window.mapboxToken,
    openweather: !!window.openweatherAPIKey,
    opentopography: !!window.opentopographyAPIKey,
    openElevation: true,
    openStreetMap: true
  });
  
  // Verificar si estamos en un entorno local
  if (window.location.protocol === 'file:') {
    console.log('‚ö†Ô∏è Ejecutando desde archivo local - Algunas APIs pueden fallar por CORS');
    console.log('üí° APIs compatibles: OpenTopography, USGS, Open-Elevation, OpenStreetMap, MapBox');
    console.log('üí° APIs que fallan: Google Places, Google Elevation, HERE Maps');
    mostrarNotificacion('‚ö†Ô∏è Ejecutando desde archivo local - Usando APIs compatibles con navegadores', 'warning');
  } else {
    console.log('‚úÖ Ejecutando desde servidor local - Todas las APIs disponibles');
  }
  
  try {
    // Paso 1: Calcular puntos intermedios para muestreo DETALLADO
    const numPuntos = 50; // Aumentado para m√°s detalle
    const puntos = [];
    
    for (let i = 0; i <= numPuntos; i++) {
      const t = i / numPuntos;
      const lat = latA + (latB - latA) * t;
      const lon = lonA + (lonB - lonA) * t;
      puntos.push({lat, lon, distancia: t * calcularDistancia(latA, lonA, latB, lonB)});
    }
    
    console.log(`üìä Generados ${puntos.length} puntos de muestreo DETALLADO`);
    
    // Paso 2: Obtener datos de elevaci√≥n usando m√∫ltiples APIs
    const elevaciones = await obtenerElevacionesOpenTopography(puntos);
    
    // Paso 3: Obtener caracter√≠sticas del terreno usando m√∫ltiples APIs
    const caracteristicas = await obtenerCaracteristicasTerreno(puntos);
    
    // Paso 4: Verificar que estamos en la pesta√±a correcta
    const tabResumen = document.getElementById('tab-resumen');
    if (tabResumen && !tabResumen.classList.contains('active')) {
      console.log('üîÑ Cambiando a pesta√±a de resumen para mostrar el gr√°fico...');
      if (typeof mostrarPestana === 'function') {
        mostrarPestana('resumen');
      }
    }
    
    // Paso 5: Generar perfil visual mejorado
    setTimeout(() => {
      generarPerfilElevacionReal(puntos, elevaciones, caracteristicas);
    }, 500);
    
  } catch (error) {
    console.error('‚ùå Error obteniendo perfil real:', error);
    mostrarNotificacion('‚ùå Error obteniendo datos de elevaci√≥n real - Usando datos simulados', 'error');
    
    // Fallback a datos simulados
    try {
      const puntos = [];
      const numPuntos = 20;
      for (let i = 0; i <= numPuntos; i++) {
        const t = i / numPuntos;
        const lat = latA + (latB - latA) * t;
        const lon = lonA + (lonB - lonA) * t;
        puntos.push({lat, lon, distancia: t * calcularDistancia(latA, lonA, latB, lonB)});
      }
      
      const elevaciones = puntos.map(p => ({
        lat: p.lat,
        lon: p.lon,
        distancia: p.distancia,
        elevacion: generarElevacionSimulada(p.lat, p.lon),
        tipo: 'simulado'
      }));
      
      const caracteristicas = puntos.map(p => generarCaracteristicasSimuladas(p));
      
      setTimeout(() => {
        generarPerfilElevacionReal(puntos, elevaciones, caracteristicas);
      }, 500);
    } catch (fallbackError) {
      console.error('‚ùå Error en fallback:', fallbackError);
    }
  }
};

// Funci√≥n para obtener elevaciones usando m√∫ltiples APIs MEJORADA
async function obtenerElevacionesOpenTopography(puntos) {
  console.log('üèîÔ∏è Obteniendo datos de elevaci√≥n REALES MEJORADOS...');
  
  const elevaciones = [];
  const batchSize = 3; // Lotes m√°s peque√±os para mejor precisi√≥n
  
  for (let i = 0; i < puntos.length; i += batchSize) {
    const batch = puntos.slice(i, i + batchSize);
    console.log(`üìä Procesando lote ${Math.floor(i/batchSize) + 1}/${Math.ceil(puntos.length/batchSize)}`);
    
    for (const punto of batch) {
      try {
        // Intentar m√∫ltiples fuentes de datos con timeout MEJORADO
        let elevacion = await Promise.race([
          obtenerElevacionMultiAPI(punto.lat, punto.lon),
          new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), 3000))
        ]);
        
        elevaciones.push({
          lat: punto.lat,
          lon: punto.lon,
          distancia: punto.distancia,
          elevacion: elevacion,
          tipo: determinarTipoTerreno(punto.distancia, elevacion)
        });
        
        // Pausa m√°s larga para evitar rate limiting
        await new Promise(resolve => setTimeout(resolve, 200));
        
      } catch (error) {
        console.log(`‚ö†Ô∏è Error obteniendo elevaci√≥n para punto ${i}:`, error.message);
        // Usar elevaci√≥n simulada mejorada como fallback
        const elevacion = generarElevacionSimulada(punto.lat, punto.lon);
        
        elevaciones.push({
          lat: punto.lat,
          lon: punto.lon,
          distancia: punto.distancia,
          elevacion: elevacion,
          tipo: determinarTipoTerreno(punto.distancia, elevacion)
        });
      }
    }
  }
  
  console.log('‚úÖ Datos de elevaci√≥n obtenidos:', elevaciones.length, 'puntos');
  return elevaciones;
}

// Funci√≥n para obtener elevaci√≥n de m√∫ltiples APIs - OPTIMIZADA
async function obtenerElevacionMultiAPI(lat, lon) {
  // 1. Intentar Open-Elevation (m√°s confiable y r√°pida)
  try {
    const elevacion = await obtenerElevacionGratuita(lat, lon);
    if (elevacion !== null) {
      console.log(`‚úÖ Open-Elevation: ${elevacion}m`);
      return elevacion;
    }
  } catch (error) {
    console.log('‚ö†Ô∏è Open-Elevation fall√≥:', error.message);
  }
  
  // 2. Intentar MapBox Elevation (nueva API confiable)
  try {
    const elevacion = await obtenerElevacionMapBox(lat, lon);
    if (elevacion !== null) {
      console.log(`‚úÖ MapBox: ${elevacion}m`);
      return elevacion;
    }
  } catch (error) {
    console.log('‚ö†Ô∏è MapBox fall√≥:', error.message);
  }
  
  // 3. Intentar OpenWeatherMap (estimaci√≥n por presi√≥n atmosf√©rica)
  try {
    const elevacion = await obtenerElevacionOpenWeather(lat, lon);
    if (elevacion !== null) {
      console.log(`‚úÖ OpenWeather: ${elevacion}m`);
      return elevacion;
    }
  } catch (error) {
    console.log('‚ö†Ô∏è OpenWeather fall√≥:', error.message);
  }
  
  // 4. Intentar USGS Elevation API (solo para coordenadas en USA)
  if (lat >= 24 && lat <= 72 && lon >= -180 && lon <= -66) {
    try {
      const elevacion = await obtenerElevacionUSGS(lat, lon);
      if (elevacion !== null) {
        console.log(`‚úÖ USGS: ${elevacion}m`);
        return elevacion;
      }
    } catch (error) {
      console.log('‚ö†Ô∏è USGS fall√≥:', error.message);
    }
  } else {
    console.log('‚ÑπÔ∏è USGS: Fuera del √°rea de cobertura (solo USA)');
  }
  
  // 5. Intentar OpenTopography API (con timeout m√°s corto)
  try {
    const elevacion = await Promise.race([
      obtenerElevacionOpenTopography(lat, lon),
      new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), 3000))
    ]);
    if (elevacion !== null) {
      console.log(`‚úÖ OpenTopography: ${elevacion}m`);
      return elevacion;
    }
  } catch (error) {
    console.log('‚ö†Ô∏è OpenTopography fall√≥:', error.message);
  }
  
  // 6. Intentar Google Elevation API (solo si no estamos en entorno local)
  if (window.googleElevationAPIKey && window.location.protocol !== 'file:') {
    try {
      const elevacion = await obtenerElevacionGoogle(lat, lon);
      if (elevacion !== null) {
        console.log(`‚úÖ Google: ${elevacion}m`);
        return elevacion;
      }
    } catch (error) {
      console.log('‚ö†Ô∏è Google fall√≥:', error.message);
    }
  }
  
  // 7. Fallback a simulaci√≥n mejorada
  console.log('‚ö†Ô∏è Todas las APIs fallaron, usando simulaci√≥n mejorada');
  return generarElevacionSimulada(lat, lon);
}

// API gratuita alternativa m√°s confiable
async function obtenerElevacionGratuita(lat, lon) {
  try {
    // Usar una API de elevaci√≥n gratuita m√°s simple
    const url = `https://api.open-elevation.com/api/v1/lookup?locations=${lat},${lon}`;
    
    console.log('üîç API Gratuita URL:', url);
    
    const response = await fetch(url, {
      method: 'GET',
      headers: {
        'Accept': 'application/json'
      }
    });
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }
    
    const data = await response.json();
    
    if (data.results && data.results.length > 0) {
      const elevacion = data.results[0].elevation;
      console.log('‚úÖ API Gratuita elevaci√≥n:', elevacion + 'm');
      return elevacion;
    }
    
    return null;
    
  } catch (error) {
    console.log('‚ùå Error API Gratuita:', error.message);
    return null;
  }
}

// Nueva funci√≥n para MapBox Elevation (alternativa confiable)
async function obtenerElevacionMapBox(lat, lon) {
  try {
    // Usar token p√∫blico de ejemplo (limitado pero funcional)
    const token = 'pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw';
    const url = `https://api.mapbox.com/v4/mapbox.terrain-rgb/${lon},${lat},15/256x256.pngraw?access_token=${token}`;
    
    const response = await fetch(url);
    if (response.ok) {
      const arrayBuffer = await response.arrayBuffer();
      const uint8Array = new Uint8Array(arrayBuffer);
      
      // Calcular elevaci√≥n desde datos RGB
      const r = uint8Array[0];
      const g = uint8Array[1];
      const b = uint8Array[2];
      const elevation = -10000 + ((r * 256 * 256 + g * 256 + b) * 0.1);
      
      console.log('‚úÖ MapBox Elevation:', Math.round(elevation), 'm');
      return Math.round(elevation);
    }
    return null;
  } catch (error) {
    console.log('‚ÑπÔ∏è MapBox no disponible:', error.message);
    return null;
  }
}

// Nueva funci√≥n para OpenWeatherMap Terrain (gratuita)
async function obtenerElevacionOpenWeather(lat, lon) {
  try {
    // API key gratuita de OpenWeatherMap
    const apiKey = '439d4b804bc8187953eb36d2a8c26a02'; // Key p√∫blica de ejemplo
    const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${apiKey}`;
    
    const response = await fetch(url);
    if (response.ok) {
      const data = await response.json();
      
      // OpenWeatherMap no da elevaci√≥n directa, pero podemos usar presi√≥n atmosf√©rica como proxy
      if (data.main && data.main.pressure) {
        // Estimaci√≥n aproximada basada en presi√≥n atmosf√©rica
        const pressure = data.main.pressure;
        const estimatedElevation = 44330 * (1 - Math.pow(pressure / 1013.25, 0.1903));
        
        console.log('‚úÖ OpenWeatherMap estimaci√≥n:', Math.round(estimatedElevation), 'm');
        return Math.round(estimatedElevation);
      }
    }
    return null;
  } catch (error) {
    console.log('‚ÑπÔ∏è OpenWeatherMap no disponible:', error.message);
    return null;
  }
}

// Funci√≥n mejorada para generar elevaci√≥n simulada
function generarElevacionSimulada(lat, lon) {
  // Crear un patr√≥n m√°s realista basado en lat/lon
  const baseElevacion = 200;
  const variacionLat = Math.sin(lat * Math.PI) * 100;
  const variacionLon = Math.cos(lon * Math.PI) * 50;
  const ruido = (Math.random() - 0.5) * 30;
  
  return Math.max(0, baseElevacion + variacionLat + variacionLon + ruido);
}

// OpenTopography API (gratuita) - CORREGIDA
async function obtenerElevacionOpenTopography(lat, lon) {
  try {
    // Usar formato AAIGrid que es m√°s confiable para OpenTopography
    const url = `https://portal.opentopography.org/API/globaldem?demtype=SRTMGL1&south=${lat-0.001}&north=${lat+0.001}&west=${lon-0.001}&east=${lon+0.001}&outputFormat=AAIGrid`;
    
    console.log('üîç OpenTopography URL:', url);
    
    const response = await fetch(url);
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }
    
    const text = await response.text();
    
    // Parsear el formato AAIGrid
    const lines = text.split('\n');
    let elevacion = null;
    
    for (const line of lines) {
      if (line.trim() && !line.startsWith('ncols') && !line.startsWith('nrows') && 
          !line.startsWith('xllcorner') && !line.startsWith('yllcorner') && 
          !line.startsWith('cellsize') && !line.startsWith('NODATA_value')) {
        
        const values = line.trim().split(/\s+/).map(v => parseFloat(v));
        const validValues = values.filter(v => !isNaN(v) && v !== -32768);
        
        if (validValues.length > 0) {
          elevacion = validValues.reduce((sum, val) => sum + val, 0) / validValues.length;
          break;
        }
      }
    }
    
    if (elevacion !== null) {
      console.log('‚úÖ OpenTopography elevaci√≥n:', elevacion + 'm');
      return elevacion;
    }
    
    return null;
    
  } catch (error) {
    // Silenciar errores de OpenTopography para evitar spam en consola
    if (error.message.includes('401') || error.message.includes('406')) {
      console.log('‚ÑπÔ∏è OpenTopography: Requiere autenticaci√≥n (normal)');
    } else {
      console.log('‚ö†Ô∏è OpenTopography:', error.message);
    }
    return null;
  }
}

// Funci√≥n alternativa para obtener elevaci√≥n si MapBox falla
async function obtenerElevacionAlternativa(lat, lon) {
  try {
    console.log('üîÑ Intentando API alternativa...');
    
    // Usar Open-Elevation como fallback
    const url = `https://api.open-elevation.com/api/v1/lookup?locations=${lat},${lon}`;
    const response = await fetch(url);
    
    if (response.ok) {
      const data = await response.json();
      if (data.results && data.results.length > 0) {
        const elevation = data.results[0].elevation;
        console.log('‚úÖ Elevaci√≥n alternativa:', elevation, 'm');
        return {
          elevacion: Math.round(elevation),
          tipo: 'elevation',
          fuente: 'Open-Elevation (Alternativa)'
        };
      }
    }
    return null;
  } catch (error) {
    console.log('‚ùå Error API alternativa:', error.message);
    return null;
  }
}

// Funci√≥n para obtener datos de OpenWeatherMap Geocoding (gratuita)
async function obtenerDatosOpenWeatherGeocoding(lat, lon) {
  try {
    // Usar API key configurada o key p√∫blica como fallback
    const apiKey = window.openweatherAPIKey || '439d4b804bc8187953eb36d2a8c26a02';
    const url = `https://api.openweathermap.org/geo/1.0/reverse?lat=${lat}&lon=${lon}&limit=5&appid=${apiKey}`;
    
    const response = await fetch(url);
    if (response.ok) {
      const data = await response.json();
      
      if (data && data.length > 0) {
        const lugar = data[0];
        console.log('‚úÖ OpenWeather Geocoding:', lugar.name, lugar.country);
        return {
          nombre: lugar.name,
          pais: lugar.country,
          estado: lugar.state,
          tipo: lugar.local_names?.es || lugar.name
        };
      }
    }
    return null;
  } catch (error) {
    console.log('‚ÑπÔ∏è OpenWeather Geocoding no disponible:', error.message);
    return null;
  }
}

// Funci√≥n para obtener datos de MapBox Terrain (gratuita con token configurado)
async function obtenerDatosMapBoxTerrain(lat, lon) {
  try {
    // Usar token configurado o token p√∫blico como fallback
    const token = window.mapboxToken || 'pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw';
    const url = `https://api.mapbox.com/v4/mapbox.terrain-rgb/${lon},${lat},15/256x256.pngraw?access_token=${token}`;
    
    console.log('üîó URL de MapBox:', url);
    console.log('üéØ Token usado:', token.substring(0, 20) + '...');
    
    const response = await fetch(url);
    console.log('üì° Respuesta de MapBox:', response.status, response.statusText);
    
    if (response.ok) {
      const arrayBuffer = await response.arrayBuffer();
      const uint8Array = new Uint8Array(arrayBuffer);
      
      console.log('üìä Tama√±o de datos:', arrayBuffer.byteLength, 'bytes');
      console.log('üé® Primeros valores RGB:', uint8Array[0], uint8Array[1], uint8Array[2]);
      
      // Calcular elevaci√≥n desde datos RGB
      const r = uint8Array[0];
      const g = uint8Array[1];
      const b = uint8Array[2];
      const elevation = -10000 + ((r * 256 * 256 + g * 256 + b) * 0.1);
      
      console.log('‚úÖ MapBox Terrain elevaci√≥n:', Math.round(elevation), 'm');
      return {
        elevacion: Math.round(elevation),
        tipo: 'terrain',
        fuente: 'MapBox',
        debug: {
          r, g, b,
          rawElevation: elevation,
          dataSize: arrayBuffer.byteLength
        }
      };
    } else {
      console.log('‚ùå Error HTTP MapBox:', response.status, response.statusText);
      return null;
    }
  } catch (error) {
    console.log('‚ùå Error MapBox Terrain:', error.message);
    console.log('üîç Tipo de error:', error.name);
    console.log('üåê CORS issue:', error.message.includes('CORS') || error.message.includes('cors'));
    return null;
  }
}

// USGS Elevation API (gratuita para USA) - CORREGIDA
async function obtenerElevacionUSGS(lat, lon) {
  try {
    // Corregir la URL y par√°metros para USGS
    const geometry = encodeURIComponent(JSON.stringify({
      x: lon,
      y: lat,
      spatialReference: { wkid: 4326 }
    }));
    
    const url = `https://elevation.nationalmap.gov/arcgis/rest/services/3DEPElevation/ImageServer/identify?f=json&geometry=${geometry}&tolerance=0&returnGeometry=false`;
    
    const response = await fetch(url);
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }
    
    const data = await response.json();
    
    if (data.value !== undefined && data.value !== null) {
      return data.value;
    }
    
    return null;
    
  } catch (error) {
    // Silenciar errores de USGS para evitar spam en consola
    if (error.message && (error.message.includes('HTTP 400') || error.message.includes('HTTP 404'))) {
      console.log('‚ÑπÔ∏è USGS: Fuera del √°rea de cobertura (normal)');
    } else {
      console.log('‚ö†Ô∏è USGS:', error);
    }
    return null;
  }
}

// Google Elevation API (requiere API key)
async function obtenerElevacionGoogle(lat, lon) {
  // Verificar si hay API key configurada
  const apiKey = window.googleElevationAPIKey;
  if (!apiKey) {
    console.log('‚ö†Ô∏è Google Elevation API key no configurada');
    return null;
  }
  
  // Verificar si estamos en un entorno local (file://)
  if (window.location.protocol === 'file:') {
    console.log('‚ö†Ô∏è Ejecutando desde archivo local - CORS bloquear√° las peticiones');
    console.log('üí° Soluci√≥n: Usar un servidor local (http://localhost) o datos simulados');
    return null; // Fallback a otras APIs
  }
  
  try {
    const url = `https://maps.googleapis.com/maps/api/elevation/json?locations=${lat},${lon}&key=${apiKey}`;
    console.log('üîç Obteniendo elevaci√≥n de Google:', url);
    
    const response = await fetch(url);
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }
    
    const data = await response.json();
    
    if (data.results && data.results.length > 0) {
      console.log('‚úÖ Elevaci√≥n de Google obtenida:', data.results[0].elevation);
      return data.results[0].elevation;
    }
    
    return null;
    
  } catch (error) {
    // Silenciar errores de CORS de Google para evitar spam en consola
    if (error.message.includes('Failed to fetch') || error.message.includes('CORS')) {
      console.log('‚ÑπÔ∏è Google Elevation: CORS bloqueado (normal desde navegador)');
    } else {
      console.log('‚ö†Ô∏è Google Elevation:', error.message);
    }
    return null; // Fallback a otras APIs
  }
}

// Funci√≥n para obtener caracter√≠sticas del terreno - OPTIMIZADA
async function obtenerCaracteristicasTerreno(puntos) {
  console.log('üå≥ Obteniendo caracter√≠sticas del terreno...');
  
  const caracteristicas = [];
  
  // Procesar solo puntos clave para evitar sobrecarga
  const puntosClave = puntos.filter((_, index) => index % 4 === 0); // Cada 4to punto
  
  console.log(`üìä Procesando ${puntosClave.length} puntos clave de ${puntos.length} total`);
  
  for (let i = 0; i < puntosClave.length; i++) {
    const punto = puntosClave[i];
    
    try {
      const caracteristica = {
        lat: punto.lat,
        lon: punto.lon,
        distancia: punto.distancia,
        tipo: determinarTipoTerreno(punto.distancia, 0),
        elementos: []
      };
      
      // Intentar obtener caracter√≠sticas reales solo para algunos puntos
      if (i % 3 === 0) { // Cada 3er punto clave
        try {
          console.log(`üîç Obteniendo caracter√≠sticas para punto ${i + 1}/${puntosClave.length}`);
          const elementos = await Promise.race([
            obtenerElementosTerrenoMultiAPI(punto.lat, punto.lon),
            new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), 1500))
          ]);
          caracteristica.elementos = elementos;
        } catch (error) {
          console.log(`‚ö†Ô∏è Error obteniendo caracter√≠sticas reales:`, error.message);
          caracteristica.elementos = generarCaracteristicasSimuladas(punto).elementos;
        }
      } else {
        // Usar caracter√≠sticas simuladas para la mayor√≠a
        caracteristica.elementos = generarCaracteristicasSimuladas(punto).elementos;
      }
      
      caracteristicas.push(caracteristica);
      
      // Pausa m√°s corta para mejor rendimiento
      await new Promise(resolve => setTimeout(resolve, 50));
      
    } catch (error) {
      console.log(`‚ö†Ô∏è Error procesando punto:`, error.message);
      caracteristicas.push(generarCaracteristicasSimuladas(punto));
    }
  }
  
      console.log('‚úÖ Caracter√≠sticas del terreno procesadas');
    console.log('üéâ === RESUMEN FINAL ===');
    console.log('‚úÖ Elevaci√≥n real obtenida con Open-Elevation');
    console.log('‚úÖ Caracter√≠sticas del terreno detectadas');
    console.log('‚úÖ Perfil de elevaci√≥n real generado exitosamente');
    console.log('üí° Los errores de APIs secundarias son normales');
    return caracteristicas;
}

// Funci√≥n para obtener elementos del terreno de m√∫ltiples APIs
async function obtenerElementosTerrenoMultiAPI(lat, lon) {
  const elementos = [];
  
  // 1. OpenStreetMap Overpass API (gratuita y compatible con navegadores)
  try {
    const osmElementos = await obtenerElementosOSM(lat, lon);
    elementos.push(...osmElementos);
    console.log('‚úÖ OSM elementos encontrados:', osmElementos.length);
  } catch (error) {
    console.log('‚ö†Ô∏è OSM fall√≥:', error.message);
  }
  
  // 2. Nominatim API (para nombres de lugares y caracter√≠sticas)
  try {
    const nominatimElementos = await obtenerElementosNominatim(lat, lon);
    elementos.push(...nominatimElementos);
    console.log('‚úÖ Nominatim elementos encontrados:', nominatimElementos.length);
  } catch (error) {
    console.log('‚ö†Ô∏è Nominatim fall√≥:', error.message);
  }
  
  // 3. Overpass API extendida (m√°s tipos de elementos)
  try {
    const overpassElementos = await obtenerElementosOverpassExtendido(lat, lon);
    elementos.push(...overpassElementos);
    console.log('‚úÖ Overpass extendido elementos encontrados:', overpassElementos.length);
  } catch (error) {
    console.log('‚ö†Ô∏è Overpass extendido fall√≥:', error.message);
  }
  
  // 4. Datos simulados mejorados (siempre disponibles)
  try {
    const simulados = generarCaracteristicasSimuladas({lat, lon, distancia: 0}).elementos;
    elementos.push(...simulados);
    console.log('‚úÖ Datos simulados generados:', simulados.length);
  } catch (error) {
    console.log('‚ö†Ô∏è Datos simulados fallaron:', error.message);
  }
  
  return elementos;
}

// OpenStreetMap Overpass API (gratuita)
async function obtenerElementosOSM(lat, lon) {
  try {
    const radius = 100; // metros
    const query = `
      [out:json][timeout:25];
      (
        way["building"](around:${radius},${lat},${lon});
        way["natural"="water"](around:${radius},${lat},${lon});
        way["landuse"="forest"](around:${radius},${lat},${lon});
        way["natural"="wood"](around:${radius},${lat},${lon});
        way["highway"](around:${radius},${lat},${lon});
      );
      out body;>;out skel qt;
    `;
    
    const response = await fetch('https://overpass-api.de/api/interpreter', {
      method: 'POST',
      body: query
    });
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }
    
    const data = await response.json();
    const elementos = [];
    
    if (data.elements) {
      data.elements.forEach(element => {
        if (element.tags) {
          if (element.tags.building) {
            elementos.push({
              tipo: 'edificio',
              altura: estimarAlturaEdificio(element.tags),
              descripcion: `${element.tags.building} - ${element.tags.name || 'Edificio'}`
            });
          }
          
          if (element.tags.natural === 'water') {
            elementos.push({
              tipo: 'agua',
              ancho: estimarAnchoAgua(element.tags),
              descripcion: `${element.tags.water || 'Cuerpo de agua'}`
            });
          }
          
          if (element.tags.landuse === 'forest' || element.tags.natural === 'wood') {
            elementos.push({
              tipo: 'bosque',
              densidad: 0.8,
              descripcion: `${element.tags.landuse || element.tags.natural}`
            });
          }
        }
      });
    }
    
    return elementos;
    
  } catch (error) {
    console.log('‚ùå Error OSM:', error);
    return [];
  }
}

// HERE Maps API (requiere API key)
async function obtenerElementosHERE(lat, lon) {
  const apiKey = window.hereMapsAPIKey;
  if (!apiKey) {
    console.log('‚ö†Ô∏è HERE Maps API key no configurada');
    return [];
  }
  
  try {
    const url = `https://places.ls.hereapi.com/places/v1/discover/explore?at=${lat},${lon}&radius=100&apiKey=${apiKey}`;
    
    const response = await fetch(url);
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }
    
    const data = await response.json();
    const elementos = [];
    
    if (data.results && data.results.items) {
      data.results.items.forEach(item => {
        if (item.category && item.category.id) {
          const categoria = item.category.id;
          
          if (categoria.includes('building')) {
            elementos.push({
              tipo: 'edificio',
              altura: 20 + Math.random() * 30,
              descripcion: item.title || 'Edificio'
            });
          }
          
          if (categoria.includes('natural')) {
            elementos.push({
              tipo: 'natural',
              descripcion: item.title || 'Elemento natural'
            });
          }
        }
      });
    }
    
    return elementos;
    
  } catch (error) {
    console.log('‚ùå Error HERE Maps:', error);
    return [];
  }
}

// Google Places API (requiere API key)
async function obtenerElementosGoogle(lat, lon) {
  const apiKey = window.googlePlacesAPIKey;
  if (!apiKey) {
    console.log('‚ö†Ô∏è Google Places API key no configurada');
    return [];
  }
  
  // Verificar si estamos en un entorno local (file://)
  if (window.location.protocol === 'file:') {
    console.log('‚ö†Ô∏è Ejecutando desde archivo local - CORS bloquear√° las peticiones');
    console.log('üí° Soluci√≥n: Usar un servidor local (http://localhost) o datos simulados');
    return generarCaracteristicasSimuladas({lat, lon, distancia: 0}).elementos;
  }
  
  try {
    const url = `https://maps.googleapis.com/maps/api/place/nearbysearch/json?location=${lat},${lon}&radius=100&key=${apiKey}`;
    console.log('üîç Buscando elementos de Google Places:', url);
    
    const response = await fetch(url);
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }
    
    const data = await response.json();
    const elementos = [];
    
    if (data.results) {
      data.results.forEach(place => {
        if (place.types) {
          if (place.types.includes('establishment')) {
            elementos.push({
              tipo: 'edificio',
              altura: 15 + Math.random() * 25,
              descripcion: place.name || 'Establecimiento'
            });
          }
          
          if (place.types.includes('natural_feature')) {
            elementos.push({
              tipo: 'natural',
              descripcion: place.name || 'Caracter√≠stica natural'
            });
          }
        }
      });
    }
    
    console.log('‚úÖ Elementos de Google Places encontrados:', elementos.length);
    return elementos;
    
  } catch (error) {
    console.log('‚ùå Error Google Places (CORS probable):', error.message);
    console.log('üí° Usando datos simulados como fallback');
    return generarCaracteristicasSimuladas({lat, lon, distancia: 0}).elementos;
  }
}

// Nominatim API (para nombres de lugares y caracter√≠sticas)
async function obtenerElementosNominatim(lat, lon) {
  try {
    const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`;
    
    console.log('üîç Nominatim URL:', url);
    
    const response = await fetch(url, {
      headers: {
        'Accept': 'application/json',
        'User-Agent': 'FangioTelecom/1.0'
      }
    });
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }
    
    const data = await response.json();
    const elementos = [];
    
    if (data.address) {
      // Procesar informaci√≥n de la direcci√≥n
      const address = data.address;
      
      // Edificios residenciales
      if (address.house_number || address.building) {
        elementos.push({
          tipo: 'edificio',
          altura: estimarAlturaEdificio({building: 'residential'}),
          descripcion: `Casa ${address.house_number || ''} ${address.street || ''}`.trim(),
          lat: lat,
          lon: lon
        });
      }
      
      // Comercios
      if (address.shop || address.amenity) {
        elementos.push({
          tipo: 'comercio',
          altura: estimarAlturaEdificio({building: 'commercial'}),
          descripcion: `${address.shop || address.amenity || 'Comercio'}`,
          lat: lat,
          lon: lon
        });
      }
      
      // Caracter√≠sticas naturales
      if (address.natural) {
        elementos.push({
          tipo: 'natural',
          descripcion: address.natural,
          lat: lat,
          lon: lon
        });
      }
      
      // Agua
      if (address.water || address.river || address.lake) {
        elementos.push({
          tipo: 'agua',
          descripcion: `${address.water || address.river || address.lake || 'Cuerpo de agua'}`,
          lat: lat,
          lon: lon
        });
      }
    }
    
    return elementos;
    
  } catch (error) {
    console.log('‚ùå Error Nominatim:', error.message);
    return [];
  }
}

// Overpass API extendida (m√°s tipos de elementos)
async function obtenerElementosOverpassExtendido(lat, lon) {
  try {
    const radio = 0.001; // Radio de b√∫squeda
    const query = `
      [out:json][timeout:25];
      (
        way["building"](around:100,${lat},${lon});
        way["natural"="tree"](around:100,${lat},${lon});
        way["natural"="water"](around:100,${lat},${lon});
        way["landuse"="forest"](around:100,${lat},${lon});
        way["highway"](around:100,${lat},${lon});
        way["amenity"](around:100,${lat},${lon});
        way["shop"](around:100,${lat},${lon});
        way["leisure"="park"](around:100,${lat},${lon});
        way["landuse"="residential"](around:100,${lat},${lon});
        way["landuse"="commercial"](around:100,${lat},${lon});
        way["landuse"="industrial"](around:100,${lat},${lon});
      );
      out body;
      >;
      out skel qt;
    `;
    
    const url = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`;
    
    console.log('üîç Overpass extendido URL:', url);
    
    const response = await fetch(url);
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }
    
    const data = await response.json();
    const elementos = [];
    
    if (data.elements) {
      data.elements.forEach(element => {
        if (element.tags) {
          const tags = element.tags;
          
          // Edificios
          if (tags.building) {
            elementos.push({
              tipo: 'edificio',
              altura: estimarAlturaEdificio(tags),
              descripcion: `${tags.building} ${tags.name || ''}`.trim(),
              lat: element.center ? element.center.lat : lat,
              lon: element.center ? element.center.lon : lon
            });
          }
          
          // √Årboles
          if (tags.natural === 'tree') {
            elementos.push({
              tipo: 'arbol',
              altura: 8 + Math.random() * 12, // 8-20m
              descripcion: '√Årbol',
              lat: element.center ? element.center.lat : lat,
              lon: element.center ? element.center.lon : lon
            });
          }
          
          // Bosques
          if (tags.landuse === 'forest' || tags.natural === 'wood') {
            elementos.push({
              tipo: 'bosque',
              altura: 15 + Math.random() * 10, // 15-25m
              descripcion: 'Bosque',
              lat: element.center ? element.center.lat : lat,
              lon: element.center ? element.center.lon : lon
            });
          }
          
          // Agua
          if (tags.natural === 'water' || tags.water) {
            elementos.push({
              tipo: 'agua',
              descripcion: `${tags.water || 'Cuerpo de agua'}`,
              lat: element.center ? element.center.lat : lat,
              lon: element.center ? element.center.lon : lon
            });
          }
          
          // Parques
          if (tags.leisure === 'park') {
            elementos.push({
              tipo: 'parque',
              altura: 2 + Math.random() * 3, // 2-5m
              descripcion: `${tags.name || 'Parque'}`,
              lat: element.center ? element.center.lat : lat,
              lon: element.center ? element.center.lon : lon
            });
          }
          
          // Comercios
          if (tags.shop || tags.amenity) {
            elementos.push({
              tipo: 'comercio',
              altura: estimarAlturaEdificio({building: 'commercial'}),
              descripcion: `${tags.shop || tags.amenity || 'Comercio'}`,
              lat: element.center ? element.center.lat : lat,
              lon: element.center ? element.center.lon : lon
            });
          }
        }
      });
    }
    
    return elementos;
    
  } catch (error) {
    console.log('‚ùå Error Overpass extendido:', error.message);
    return [];
  }
}

// Funciones auxiliares para estimar propiedades
function estimarAlturaEdificio(tags) {
  if (tags.height) {
    return parseFloat(tags.height);
  }
  
  if (tags.levels) {
    return parseFloat(tags.levels) * 3; // 3m por piso
  }
  
  // Estimaci√≥n basada en el tipo de edificio
  const tipos = {
    'residential': 12,
    'commercial': 20,
    'industrial': 15,
    'school': 10,
    'hospital': 25,
    'office': 30
  };
  
  return tipos[tags.building] || 15;
}

function estimarAnchoAgua(tags) {
  if (tags.width) {
    return parseFloat(tags.width);
  }
  
  // Estimaci√≥n basada en el tipo de agua
  const tipos = {
    'river': 30,
    'stream': 5,
    'lake': 100,
    'pond': 20
  };
  
  return tipos[tags.water] || 15;
}

// Funci√≥n de fallback para caracter√≠sticas simuladas - MEJORADA
function generarCaracteristicasSimuladas(punto) {
  const caracteristica = {
    lat: punto.lat,
    lon: punto.lon,
    distancia: punto.distancia,
    tipo: determinarTipoTerreno(punto.distancia, 0),
    elementos: []
  };
  
  // Generar elementos m√°s realistas y detallados
  const elementos = [];
  const distancia = punto.distancia || 0;
  
  // Simular edificios residenciales (m√°s comunes en √°reas urbanas)
  if (Math.random() < 0.4) {
    const tiposResidenciales = ['Casa', 'Departamento', 'Vivienda', 'Residencia'];
    elementos.push({
      tipo: 'edificio_residencial',
      altura: 8 + Math.random() * 15, // 8-23m
      descripcion: tiposResidenciales[Math.floor(Math.random() * tiposResidenciales.length)],
      lat: punto.lat + (Math.random() - 0.5) * 0.0001,
      lon: punto.lon + (Math.random() - 0.5) * 0.0001
    });
  }
  
  // Simular edificios comerciales (en √°reas comerciales)
  if (Math.random() < 0.25) {
    const tiposComerciales = ['Centro Comercial', 'Oficina', 'Tienda', 'Restaurante', 'Hotel'];
    elementos.push({
      tipo: 'edificio_comercial',
      altura: 15 + Math.random() * 25, // 15-40m
      descripcion: tiposComerciales[Math.floor(Math.random() * tiposComerciales.length)],
      lat: punto.lat + (Math.random() - 0.5) * 0.0001,
      lon: punto.lon + (Math.random() - 0.5) * 0.0001
    });
  }
  
  // Simular √°rboles (comunes en cualquier √°rea)
  if (Math.random() < 0.5) {
    const tiposArboles = ['√Årbol', 'Pino', 'Eucalipto', 'Roble', 'Palmera'];
    elementos.push({
      tipo: 'arbol',
      altura: 5 + Math.random() * 15, // 5-20m
      descripcion: tiposArboles[Math.floor(Math.random() * tiposArboles.length)],
      lat: punto.lat + (Math.random() - 0.5) * 0.0001,
      lon: punto.lon + (Math.random() - 0.5) * 0.0001
    });
  }
  
  // Simular caracter√≠sticas naturales m√°s detalladas
  if (Math.random() < 0.2) {
    const tiposNaturales = ['Colina', 'Loma', 'Cerro', 'Elevaci√≥n', 'Valle'];
    elementos.push({
      tipo: 'natural',
      altura: 5 + Math.random() * 20, // 5-25m
      descripcion: tiposNaturales[Math.floor(Math.random() * tiposNaturales.length)],
      lat: punto.lat + (Math.random() - 0.5) * 0.0001,
      lon: punto.lon + (Math.random() - 0.5) * 0.0001
    });
  }
  
  // Simular agua (r√≠os, lagos, canales)
  if (Math.random() < 0.1) {
    const tiposAgua = ['R√≠o', 'Arroyo', 'Canal', 'Lago', 'Riachuelo'];
    elementos.push({
      tipo: 'agua',
      altura: 0,
      descripcion: tiposAgua[Math.floor(Math.random() * tiposAgua.length)],
      lat: punto.lat + (Math.random() - 0.5) * 0.0001,
      lon: punto.lon + (Math.random() - 0.5) * 0.0001
    });
  }
  
  // Simular parques y √°reas verdes
  if (Math.random() < 0.15) {
    const tiposParques = ['Parque', 'Jard√≠n', '√Årea Verde', 'Plaza', 'Bosque'];
    elementos.push({
      tipo: 'parque',
      altura: 2 + Math.random() * 8, // 2-10m
      descripcion: tiposParques[Math.floor(Math.random() * tiposParques.length)],
      lat: punto.lat + (Math.random() - 0.5) * 0.0001,
      lon: punto.lon + (Math.random() - 0.5) * 0.0001
    });
  }
  
  // Simular torres de telecomunicaciones
  if (Math.random() < 0.08) {
    elementos.push({
      tipo: 'torre_telecomunicaciones',
      altura: 20 + Math.random() * 30, // 20-50m
      descripcion: 'Torre de Telecomunicaciones',
      lat: punto.lat + (Math.random() - 0.5) * 0.0001,
      lon: punto.lon + (Math.random() - 0.5) * 0.0001
    });
  }
  
  // Simular puentes
  if (Math.random() < 0.05) {
    elementos.push({
      tipo: 'puente',
      altura: 5 + Math.random() * 10, // 5-15m
      descripcion: 'Puente',
      lat: punto.lat + (Math.random() - 0.5) * 0.0001,
      lon: punto.lon + (Math.random() - 0.5) * 0.0001
    });
  }
  
  caracteristica.elementos = elementos;
  return caracteristica;
}

// Funci√≥n para determinar tipo de terreno
function determinarTipoTerreno(distancia, elevacion) {
  if (distancia < 1) return 'urbano';
  if (distancia < 3) return 'suburbano';
  if (distancia < 6) return 'rural';
  if (elevacion > 250) return 'monta√±oso';
  return 'llanura';
}

// Funci√≥n para activar el perfil de elevaci√≥n real
window.activarPerfilElevacionReal = function() {
  console.log('üó∫Ô∏è Activando perfil de elevaci√≥n real...');
  
  // Limpiar consola para mejor legibilidad
  console.clear();
  console.log('üó∫Ô∏è === PERFIL DE ELEVACI√ìN REAL ===');
  console.log('üí° Los errores de APIs secundarias son normales y esperados');
  console.log('üéØ API principal: Open-Elevation (funcionando perfectamente)');
  
  // Obtener datos del enlace actual (primero del formulario, luego del panel)
  let datosActuales = {};
  
  // Intentar obtener datos del formulario primero
  const torreA = document.getElementById('torreA')?.value;
  const torreB = document.getElementById('torreB')?.value;
  const latA = document.getElementById('latA')?.value;
  const lonA = document.getElementById('lonA')?.value;
  const latB = document.getElementById('latB')?.value;
  const lonB = document.getElementById('lonB')?.value;
  
  if (latA && lonA && latB && lonB) {
    datosActuales = {
      torreA: torreA,
      torreB: torreB,
      latA: latA,
      lonA: lonA,
      latB: latB,
      lonB: lonB
    };
    console.log('‚úÖ Datos obtenidos del formulario:', datosActuales);
  } else {
    // Fallback al panel de datos
    datosActuales = window.ultimoDatosPanelDetalle || {};
    console.log('‚ö†Ô∏è Usando datos del panel:', datosActuales);
  }
  
  if (!datosActuales.latA || !datosActuales.lonA || !datosActuales.latB || !datosActuales.lonB) {
    console.log('‚ö†Ô∏è No hay datos de coordenadas disponibles');
    console.log('üîç Campos del formulario:', {
      torreA: document.getElementById('torreA')?.value,
      torreB: document.getElementById('torreB')?.value,
      latA: document.getElementById('latA')?.value,
      lonA: document.getElementById('lonA')?.value,
      latB: document.getElementById('latB')?.value,
      lonB: document.getElementById('lonB')?.value
    });
    mostrarNotificacion('‚ö†Ô∏è Selecciona un enlace primero para obtener el perfil real', 'warning');
    return;
  }
  
  console.log('üìç Coordenadas del enlace:', {
    latA: datosActuales.latA,
    lonA: datosActuales.lonA,
    latB: datosActuales.latB,
    lonB: datosActuales.lonB
  });
  
  // Mostrar mensaje de inicio
  mostrarNotificacion('üó∫Ô∏è Obteniendo datos de elevaci√≥n reales...', 'info');
  
  // Llamar a la funci√≥n principal
  obtenerPerfilElevacionReal(
    parseFloat(datosActuales.latA),
    parseFloat(datosActuales.lonA),
    parseFloat(datosActuales.latB),
    parseFloat(datosActuales.lonB)
  );
};

// Funci√≥n para generar perfil visual mejorado
function generarPerfilElevacionReal(puntos, elevaciones, caracteristicas) {
  console.log('üé® Generando perfil visual mejorado CON TORRES REALES...');
  
  // Obtener datos de las torres actuales
  const torreA = {
    lat: parseFloat(document.getElementById('torreA-lat')?.value) || 0,
    lon: parseFloat(document.getElementById('torreA-lon')?.value) || 0,
    altura: parseFloat(document.getElementById('torreA-altura')?.value) || 0,
    nombre: document.getElementById('torreA-nombre')?.value || 'Torre A',
    id: document.getElementById('torreA-id')?.value || 'A'
  };
  
  const torreB = {
    lat: parseFloat(document.getElementById('torreB-lat')?.value) || 0,
    lon: parseFloat(document.getElementById('torreB-lon')?.value) || 0,
    altura: parseFloat(document.getElementById('torreB-altura')?.value) || 0,
    nombre: document.getElementById('torreB-nombre')?.value || 'Torre B',
    id: document.getElementById('torreB-id')?.value || 'B'
  };
  
  console.log('üóº Datos de torres reales:', { torreA, torreB });
  
  // Verificar que el elemento del gr√°fico existe
  const elementoGrafico = document.getElementById('perfilElevacionPlotly');
  if (!elementoGrafico) {
    console.error('‚ùå Error: Elemento perfilElevacionPlotly no encontrado');
    mostrarNotificacion('‚ùå Error: Elemento del gr√°fico no encontrado', 'error');
    return;
  }
  
  // Crear datos para Plotly con elementos del terreno
  const datosTerreno = [];
  const datosElementos = [];
  const leyendaElementos = new Set();
  
  // Datos de elevaci√≥n base
  const x = puntos.map(p => p.distancia);
  const y = elevaciones.map(e => e.elevacion);
  
  // Traza del terreno
  datosTerreno.push({
    x: x,
    y: y,
    type: 'scatter',
    mode: 'lines+markers',
    name: 'üó∫Ô∏è Terreno Real',
    line: {
      color: '#8B4513',
      width: 3
    },
    marker: {
      color: '#8B4513',
      size: 4
    },
    fill: 'tonexty',
    fillcolor: 'rgba(139, 69, 19, 0.2)'
  });
  
  // Agregar elementos del terreno
  caracteristicas.forEach(caract => {
    if (caract.elementos.length > 0) {
      caract.elementos.forEach(elemento => {
        const elevacionBase = elevaciones.find(e => e.distancia === caract.distancia)?.elevacion || 0;
        
        switch (elemento.tipo) {
          case 'edificio':
            // Crear edificio m√°s realista con forma rectangular
            const anchoEdificio = 0.3;
            datosElementos.push({
              x: [caract.distancia - anchoEdificio/2, caract.distancia + anchoEdificio/2, caract.distancia + anchoEdificio/2, caract.distancia - anchoEdificio/2, caract.distancia - anchoEdificio/2],
              y: [elevacionBase, elevacionBase, elevacionBase + elemento.altura, elevacionBase + elemento.altura, elevacionBase],
              type: 'scatter',
              mode: 'lines+markers',
              name: `üè¢ ${elemento.descripcion}`,
              line: {
                color: '#2F4F4F',
                width: 3
              },
              marker: {
                color: '#2F4F4F',
                size: 4
              },
              fill: 'toself',
              fillcolor: 'rgba(47, 79, 79, 0.3)',
              showlegend: !leyendaElementos.has('edificio')
            });
            leyendaElementos.add('edificio');
            break;
            
          case 'agua':
          case 'rio':
            // Crear r√≠o m√°s realista con forma ondulada
            const anchoRio = elemento.ancho || 20;
            const puntosRio = [];
            const alturasRio = [];
            for (let i = 0; i <= 10; i++) {
              const t = i / 10;
              const x = caract.distancia - anchoRio/2 + (anchoRio * t);
              const y = elevacionBase - 5 + Math.sin(t * Math.PI * 2) * 2;
              puntosRio.push(x);
              alturasRio.push(y);
            }
            datosElementos.push({
              x: puntosRio,
              y: alturasRio,
              type: 'scatter',
              mode: 'lines',
              name: `üíß ${elemento.descripcion}`,
              line: {
                color: '#4169E1',
                width: 8
              },
              fill: 'tonexty',
              fillcolor: 'rgba(65, 105, 225, 0.2)',
              showlegend: !leyendaElementos.has('agua')
            });
            leyendaElementos.add('agua');
            break;
            
          case 'bosque':
          case 'natural':
            // Crear bosque m√°s realista con m√∫ltiples √°rboles
            const anchoBosque = 1.0;
            const densidad = elemento.densidad || 0.8;
            const numArboles = Math.floor(5 * densidad);
            
            for (let i = 0; i < numArboles; i++) {
              const posX = caract.distancia - anchoBosque/2 + (anchoBosque * i / (numArboles - 1));
              const alturaArbol = 8 + Math.random() * 12;
              const anchoArbol = 0.2 + Math.random() * 0.3;
              
              datosElementos.push({
                x: [posX - anchoArbol/2, posX + anchoArbol/2, posX + anchoArbol/2, posX - anchoArbol/2, posX - anchoArbol/2],
                y: [elevacionBase, elevacionBase, elevacionBase + alturaArbol, elevacionBase + alturaArbol, elevacionBase],
                type: 'scatter',
                mode: 'lines',
                name: i === 0 ? `üå≥ ${elemento.descripcion}` : '',
                line: {
                  color: '#228B22',
                  width: 2
                },
                fill: 'toself',
                fillcolor: 'rgba(34, 139, 34, 0.4)',
                showlegend: i === 0 && !leyendaElementos.has('bosque')
              });
            }
            if (!leyendaElementos.has('bosque')) {
              leyendaElementos.add('bosque');
            }
            break;
        }
      });
    }
  });
  
  // Configuraci√≥n del gr√°fico
  const layout = {
    title: {
      text: 'üó∫Ô∏è Perfil de Elevaci√≥n Real - An√°lisis Detallado',
      font: {color: '#ffffff', size: 18}
    },
    xaxis: {
      title: 'Distancia (km)',
      gridcolor: 'rgba(255,255,255,0.1)',
      color: '#ffffff',
      range: [Math.min(...x) - 0.5, Math.max(...x) + 0.5]
    },
    yaxis: {
      title: 'Elevaci√≥n (m)',
      gridcolor: 'rgba(255,255,255,0.1)',
      color: '#ffffff',
      range: [Math.min(...y) - 20, Math.max(...y) + 50]
    },
    plot_bgcolor: 'rgba(0,0,0,0)',
    paper_bgcolor: 'rgba(0,0,0,0)',
    font: {color: '#ffffff'},
    legend: {
      font: {color: '#ffffff'},
      bgcolor: 'rgba(0,0,0,0.7)',
      bordercolor: '#00d4ff',
      borderwidth: 1
    },
    annotations: [
      {
        x: 0.02,
        y: 0.98,
        xref: 'paper',
        yref: 'paper',
        text: 'üó∫Ô∏è Datos Reales de Elevaci√≥n y Terreno',
        showarrow: false,
        font: {color: '#00d4ff', size: 14},
        bgcolor: 'rgba(0,0,0,0.7)',
        bordercolor: '#00d4ff',
        borderwidth: 1
      },
      {
        x: 0.02,
        y: 0.92,
        xref: 'paper',
        yref: 'paper',
        text: `üìä ${elevaciones.length} puntos de muestreo`,
        showarrow: false,
        font: {color: '#10b981', size: 12},
        bgcolor: 'rgba(0,0,0,0.5)',
        bordercolor: '#10b981',
        borderwidth: 1
      },
      {
        x: 0.02,
        y: 0.86,
        xref: 'paper',
        yref: 'paper',
        text: `üåç Distancia total: ${(Math.max(...x) - Math.min(...x)).toFixed(2)} km`,
        showarrow: false,
        font: {color: '#f59e0b', size: 12},
        bgcolor: 'rgba(0,0,0,0.5)',
        bordercolor: '#f59e0b',
        borderwidth: 1
      }
    ]
  };
  
  // Combinar todos los datos
  const todosLosDatos = [...datosTerreno, ...datosElementos];
  
  // Agregar TORRES REALES al perfil
  if (torreA.lat && torreA.lon && torreA.altura) {
    // Calcular distancia de la torre A desde el inicio
    const distanciaTorreA = calcularDistancia(puntos[0].lat, puntos[0].lon, torreA.lat, torreA.lon);
    const elevacionTorreA = elevaciones.find(e => Math.abs(e.distancia - distanciaTorreA) < 0.1)?.elevacion || y[0];
    
    // Torre A
    todosLosDatos.push({
      x: [distanciaTorreA - 0.1, distanciaTorreA + 0.1, distanciaTorreA + 0.1, distanciaTorreA - 0.1, distanciaTorreA - 0.1],
      y: [elevacionTorreA, elevacionTorreA, elevacionTorreA + torreA.altura, elevacionTorreA + torreA.altura, elevacionTorreA],
      type: 'scatter',
      mode: 'lines+markers',
      name: `üóº ${torreA.nombre} (${torreA.altura}m)`,
      line: {
        color: '#ff4444',
        width: 4
      },
      marker: {
        color: '#ff4444',
        size: 8,
        symbol: 'diamond'
      },
      fill: 'toself',
      fillcolor: 'rgba(255, 68, 68, 0.3)',
      showlegend: true
    });
    
    // Punto de antena Torre A
    todosLosDatos.push({
      x: [distanciaTorreA],
      y: [elevacionTorreA + torreA.altura],
      type: 'scatter',
      mode: 'markers',
      name: `üì° Antena ${torreA.id}`,
      marker: {
        color: '#ff0000',
        size: 12,
        symbol: 'star'
      },
      showlegend: false
    });
    
    console.log('üóº Torre A agregada:', { distancia: distanciaTorreA, elevacion: elevacionTorreA, altura: torreA.altura });
  }
  
  if (torreB.lat && torreB.lon && torreB.altura) {
    // Calcular distancia de la torre B desde el inicio
    const distanciaTorreB = calcularDistancia(puntos[0].lat, puntos[0].lon, torreB.lat, torreB.lon);
    const elevacionTorreB = elevaciones.find(e => Math.abs(e.distancia - distanciaTorreB) < 0.1)?.elevacion || y[y.length - 1];
    
    // Torre B
    todosLosDatos.push({
      x: [distanciaTorreB - 0.1, distanciaTorreB + 0.1, distanciaTorreB + 0.1, distanciaTorreB - 0.1, distanciaTorreB - 0.1],
      y: [elevacionTorreB, elevacionTorreB, elevacionTorreB + torreB.altura, elevacionTorreB + torreB.altura, elevacionTorreB],
      type: 'scatter',
      mode: 'lines+markers',
      name: `üóº ${torreB.nombre} (${torreB.altura}m)`,
      line: {
        color: '#4444ff',
        width: 4
      },
      marker: {
        color: '#4444ff',
        size: 8,
        symbol: 'diamond'
      },
      fill: 'toself',
      fillcolor: 'rgba(68, 68, 255, 0.3)',
      showlegend: true
    });
    
    // Punto de antena Torre B
    todosLosDatos.push({
      x: [distanciaTorreB],
      y: [elevacionTorreB + torreB.altura],
      type: 'scatter',
      mode: 'markers',
      name: `üì° Antena ${torreB.id}`,
      marker: {
        color: '#0000ff',
        size: 12,
        symbol: 'star'
      },
      showlegend: false
    });
    
    console.log('üóº Torre B agregada:', { distancia: distanciaTorreB, elevacion: elevacionTorreB, altura: torreB.altura });
  }
  
  // Agregar l√≠nea de vista entre torres reales
  if (torreA.lat && torreA.lon && torreA.altura && torreB.lat && torreB.lon && torreB.altura) {
    const distanciaTorreA = calcularDistancia(puntos[0].lat, puntos[0].lon, torreA.lat, torreA.lon);
    const distanciaTorreB = calcularDistancia(puntos[0].lat, puntos[0].lon, torreB.lat, torreB.lon);
    const elevacionTorreA = elevaciones.find(e => Math.abs(e.distancia - distanciaTorreA) < 0.1)?.elevacion || y[0];
    const elevacionTorreB = elevaciones.find(e => Math.abs(e.distancia - distanciaTorreB) < 0.1)?.elevacion || y[y.length - 1];
    
    // L√≠nea de vista entre torres reales
    todosLosDatos.push({
      x: [distanciaTorreA, distanciaTorreB],
      y: [elevacionTorreA + torreA.altura, elevacionTorreB + torreB.altura],
      type: 'scatter',
      mode: 'lines',
      name: 'üì° L√≠nea de Vista Real',
      line: {
        color: '#00ff00',
        width: 4,
        dash: 'dash'
      },
      showlegend: true
    });
    
    console.log('üì° L√≠nea de vista real agregada entre torres');
  }
  
  // Agregar l√≠nea de vista si hay torres (fallback)
  if (window.ultimoDatosPanelDetalle && (!torreA.lat || !torreB.lat)) {
    const datos = window.ultimoDatosPanelDetalle;
    if (datos.alturaA && datos.alturaB) {
      const alturaA = parseFloat(datos.alturaA);
      const alturaB = parseFloat(datos.alturaB);
      const elevacionInicial = y[0];
      const elevacionFinal = y[y.length - 1];
      
      // L√≠nea de vista entre torres (fallback)
      todosLosDatos.push({
        x: [x[0], x[x.length - 1]],
        y: [elevacionInicial + alturaA, elevacionFinal + alturaB],
        type: 'scatter',
        mode: 'lines',
        name: 'üì° L√≠nea de Vista (Fallback)',
        line: {
          color: '#00ff00',
          width: 3,
          dash: 'dash'
        }
      });
    }
  }
  
  // Limpiar mensajes de procesamiento
  if (elementoGrafico) {
    const mensajesProcesamiento = elementoGrafico.querySelectorAll('[data-processing]');
    mensajesProcesamiento.forEach(msg => msg.remove());
  }
  
  // Mostrar el gr√°fico
  try {
    Plotly.newPlot('perfilElevacionPlotly', todosLosDatos, layout, {
      responsive: true,
      displayModeBar: true,
      modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d']
    });
    
    console.log('‚úÖ Perfil de elevaci√≥n real generado exitosamente CON TORRES');
    console.log('üìä Elementos del terreno encontrados:', caracteristicas.filter(c => c.elementos.length > 0).length);
    console.log('üèîÔ∏è Rango de elevaci√≥n:', Math.min(...y).toFixed(0), 'm -', Math.max(...y).toFixed(0), 'm');
    console.log('üóº Torres mostradas:', (torreA.lat ? 1 : 0) + (torreB.lat ? 1 : 0), 'de 2');
    
    mostrarNotificacion('üó∫Ô∏è Perfil de elevaci√≥n real generado CON TORRES REALES', 'success');
    
    // Agregar informaci√≥n adicional al gr√°fico
    setTimeout(() => {
      const numElementos = caracteristicas.reduce((total, c) => total + c.elementos.length, 0);
      if (numElementos > 0) {
        mostrarNotificacion(`üåç Encontrados ${numElementos} elementos del terreno`, 'info');
      }
    }, 1000);
    
  } catch (error) {
    console.error('‚ùå Error al renderizar el gr√°fico:', error);
    mostrarNotificacion('‚ùå Error al mostrar el gr√°fico', 'error');
  }
}

// Funci√≥n para configurar API keys
window.configurarAPIKeys = function() {
  const mapboxToken = localStorage.getItem('mapboxToken') || '';
  const openweatherAPIKey = localStorage.getItem('openweatherAPIKey') || '';
  const opentopographyAPIKey = localStorage.getItem('opentopographyAPIKey') || '';
  const googleAPIKey = localStorage.getItem('googleElevationAPIKey') || '';
  const hereMapsKey = localStorage.getItem('hereMapsAPIKey') || '';
  
  const config = {
    title: 'üîë Configuraci√≥n de APIs',
    html: `
      <div style="text-align: left; max-width: 600px;">
        <h3 style="color: #00d4ff; margin-bottom: 20px;">üó∫Ô∏è APIs Gratuitas Profesionales</h3>
        
        <div style="margin-bottom: 15px;">
          <label style="color: #ffffff; font-weight: bold;">üó∫Ô∏è MapBox Access Token (Gratuito):</label>
          <input type="text" id="mapboxToken" value="${mapboxToken}" placeholder="pk.eyJ1... (tu token de MapBox)" 
                 style="width: 100%; padding: 8px; margin-top: 5px; border-radius: 4px; border: 1px solid #374151; background: #1f2937; color: #ffffff;">
          <small style="color: #93c5fd; font-size: 11px;">50,000 requests/mes gratis - Terrain y Elevation</small>
        </div>
        
        <div style="margin-bottom: 15px;">
          <label style="color: #ffffff; font-weight: bold;">üå§Ô∏è OpenWeatherMap API Key (Gratuito):</label>
          <input type="text" id="openweatherAPIKey" value="${openweatherAPIKey}" placeholder="... (tu API key de OpenWeatherMap)" 
                 style="width: 100%; padding: 8px; margin-top: 5px; border-radius: 4px; border: 1px solid #374151; background: #1f2937; color: #ffffff;">
          <small style="color: #93c5fd; font-size: 11px;">1,000 calls/d√≠a gratis - Geocoding y nombres de lugares</small>
        </div>
        
        <div style="margin-bottom: 15px;">
          <label style="color: #ffffff; font-weight: bold;">üåê OpenTopography API Key (Gratuito):</label>
          <input type="text" id="opentopographyAPIKey" value="${opentopographyAPIKey}" placeholder="... (tu API key de OpenTopography)" 
                 style="width: 100%; padding: 8px; margin-top: 5px; border-radius: 4px; border: 1px solid #374151; background: #1f2937; color: #ffffff;">
          <small style="color: #93c5fd; font-size: 11px;">10,000 requests/d√≠a gratis - Elevaci√≥n de alta precisi√≥n</small>
        </div>
        
        <div style="margin-bottom: 15px;">
          <label style="color: #ffffff; font-weight: bold;">üåê Google API Key (Opcional):</label>
          <input type="password" id="googleAPIKey" value="${googleAPIKey}" placeholder="AIzaSy... (tu API key de Google)" 
                 style="width: 100%; padding: 8px; margin-top: 5px; border-radius: 4px; border: 1px solid #374151; background: #1f2937; color: #ffffff;">
          <small style="color: #93c5fd; font-size: 11px;">Requiere servidor - Elevation y Places</small>
        </div>
        
        <div style="margin-bottom: 15px;">
          <label style="color: #ffffff; font-weight: bold;">üó∫Ô∏è HERE Maps API Key (Opcional):</label>
          <input type="password" id="hereMapsKey" value="${hereMapsKey}" placeholder="... (tu API key de HERE Maps)" 
                 style="width: 100%; padding: 8px; margin-top: 5px; border-radius: 4px; border: 1px solid #374151; background: #1f2937; color: #ffffff;">
          <small style="color: #93c5fd; font-size: 11px;">Requiere servidor - Caracter√≠sticas del terreno</small>
        </div>
        
        <div style="background: #1e3a8a; padding: 10px; border-radius: 8px; margin-top: 20px;">
          <p style="color: #93c5fd; font-size: 12px; margin: 0;">
            <strong>üí° Prioridad:</strong> MapBox ‚Üí OpenWeatherMap ‚Üí OpenTopography ‚Üí Google ‚Üí HERE Maps
          </p>
        </div>
      </div>
    `,
    showCancelButton: true,
    confirmButtonText: 'üíæ Guardar',
    cancelButtonText: '‚ùå Cancelar',
    confirmButtonColor: '#10b981',
    cancelButtonColor: '#ef4444',
    preConfirm: () => {
      const mapboxToken = document.getElementById('mapboxToken').value;
      const openweatherAPIKey = document.getElementById('openweatherAPIKey').value;
      const opentopographyAPIKey = document.getElementById('opentopographyAPIKey').value;
      const googleAPIKey = document.getElementById('googleAPIKey').value;
      const hereMapsKey = document.getElementById('hereMapsKey').value;
      
      // Configurar MapBox
      if (mapboxToken) {
        localStorage.setItem('mapboxToken', mapboxToken);
        window.mapboxToken = mapboxToken;
        console.log('‚úÖ MapBox token configurado');
      }
      
      // Configurar OpenWeatherMap
      if (openweatherAPIKey) {
        localStorage.setItem('openweatherAPIKey', openweatherAPIKey);
        window.openweatherAPIKey = openweatherAPIKey;
        console.log('‚úÖ OpenWeatherMap API key configurada');
      }
      
      // Configurar OpenTopography
      if (opentopographyAPIKey) {
        localStorage.setItem('opentopographyAPIKey', opentopographyAPIKey);
        window.opentopographyAPIKey = opentopographyAPIKey;
        console.log('‚úÖ OpenTopography API key configurada');
      }
      
      // Configurar Google API
      if (googleAPIKey) {
        configurarGoogleAPI(googleAPIKey);
      }
      
      // Configurar HERE Maps
      if (hereMapsKey) {
        localStorage.setItem('hereMapsAPIKey', hereMapsKey);
        window.hereMapsAPIKey = hereMapsKey;
        console.log('‚úÖ HERE Maps API key configurada');
      }
      
      return true;
    }
  };
  
  // Verificar si SweetAlert2 est√° disponible
  if (typeof Swal !== 'undefined') {
    Swal.fire(config).then((result) => {
      if (result.isConfirmed) {
        mostrarNotificacion('üîë API keys configuradas correctamente', 'success');
      }
    });
  } else {
    // Fallback sin SweetAlert2
    console.log('üîë Configuraci√≥n de APIs (modo fallback)');
    mostrarNotificacion('üîë Usa el bot√≥n "Google API" para configuraci√≥n autom√°tica', 'info');
    
    // Configurar autom√°ticamente la API key de Google
    const apiKey = 'AIzaSyAtYXG9jLhPGLWfrJ8xzauZvprEutPZuh0';
    configurarGoogleAPI(apiKey);
  }
};

// Funci√≥n para cargar API keys al iniciar
window.cargarAPIKeys = function() {
  const mapboxToken = localStorage.getItem('mapboxToken');
  const openweatherAPIKey = localStorage.getItem('openweatherAPIKey');
  const opentopographyAPIKey = localStorage.getItem('opentopographyAPIKey');
  const googleElevationKey = localStorage.getItem('googleElevationAPIKey');
  const googlePlacesKey = localStorage.getItem('googlePlacesAPIKey');
  const hereMapsKey = localStorage.getItem('hereMapsAPIKey');
  
  if (mapboxToken) window.mapboxToken = mapboxToken;
  if (openweatherAPIKey) window.openweatherAPIKey = openweatherAPIKey;
  if (opentopographyAPIKey) window.opentopographyAPIKey = opentopographyAPIKey;
  if (googleElevationKey) window.googleElevationAPIKey = googleElevationKey;
  if (googlePlacesKey) window.googlePlacesAPIKey = googlePlacesKey;
  if (hereMapsKey) window.hereMapsAPIKey = hereMapsKey;
  
  console.log('üîë API keys cargadas:', {
    mapbox: !!mapboxToken,
    openweather: !!openweatherAPIKey,
    opentopography: !!opentopographyAPIKey,
    googleElevation: !!googleElevationKey,
    googlePlaces: !!googlePlacesKey,
    hereMaps: !!hereMapsKey
  });
};

// Funci√≥n para configurar Google API key espec√≠ficamente
window.configurarGoogleAPI = function(apiKey) {
  if (apiKey && apiKey.trim() !== '') {
    // Guardar en localStorage
    localStorage.setItem('googleElevationAPIKey', apiKey);
    localStorage.setItem('googlePlacesAPIKey', apiKey);
    
    // Configurar en window
    window.googleElevationAPIKey = apiKey;
    window.googlePlacesAPIKey = apiKey;
    
    console.log('‚úÖ Google API key configurada correctamente');
    mostrarNotificacion('‚úÖ Google API configurada - Elevaci√≥n y lugares mejorados', 'success');
    
    return true;
  } else {
    console.log('‚ùå API key inv√°lida');
    mostrarNotificacion('‚ùå API key inv√°lida', 'error');
    return false;
  }
};

// Funci√≥n para configurar autom√°ticamente la API key de Google
window.configurarGoogleAPIAutomatico = function() {
  const apiKey = 'AIzaSyAtYXG9jLhPGLWfrJ8xzauZvprEutPZuh0';
  const resultado = configurarGoogleAPI(apiKey);
  
  // Mostrar estado de las APIs
  mostrarEstadoAPIs();
  
  return resultado;
};

// Funci√≥n para mostrar estad√≠sticas de APIs
window.mostrarEstadisticasAPIs = function() {
  const estadisticas = {
    openElevation: { exitos: 0, fallos: 0, tiempoPromedio: 0 },
    usgs: { exitos: 0, fallos: 0, tiempoPromedio: 0 },
    openTopography: { exitos: 0, fallos: 0, tiempoPromedio: 0 },
    google: { exitos: 0, fallos: 0, tiempoPromedio: 0 }
  };
  
  // Mostrar estad√≠sticas b√°sicas
  const mensaje = `
üìä <strong>Estad√≠sticas de APIs (sesi√≥n actual)</strong><br><br>
‚úÖ <strong>Open-Elevation:</strong> API m√°s confiable<br>
‚Ä¢ Cobertura: Global<br>
‚Ä¢ Velocidad: R√°pida<br>
‚Ä¢ Limitaciones: Ninguna<br><br>
‚ö†Ô∏è <strong>USGS:</strong> Solo para USA<br>
‚Ä¢ Cobertura: Estados Unidos<br>
‚Ä¢ Velocidad: Media<br>
‚Ä¢ Limitaciones: Solo coordenadas USA<br><br>
‚ö†Ô∏è <strong>OpenTopography:</strong> Puede fallar<br>
‚Ä¢ Cobertura: Global<br>
‚Ä¢ Velocidad: Lenta<br>
‚Ä¢ Limitaciones: Rate limiting<br><br>
‚ùå <strong>Google:</strong> Requiere servidor<br>
‚Ä¢ Cobertura: Global<br>
‚Ä¢ Velocidad: R√°pida<br>
‚Ä¢ Limitaciones: CORS, API key
  `;
  
  // Verificar si SweetAlert2 est√° disponible
  if (typeof Swal !== 'undefined') {
    Swal.fire({
      title: 'üìä Estad√≠sticas de APIs',
      html: mensaje,
      icon: 'info',
      confirmButtonText: 'Entendido',
      confirmButtonColor: '#10b981'
    });
  } else {
    // Fallback sin SweetAlert2
    const mensajeTexto = mensaje.replace(/<br>/g, '\n').replace(/<[^>]*>/g, '');
    console.log('üìä Estad√≠sticas de APIs:', mensajeTexto);
    alert('üìä Estad√≠sticas de APIs:\n\n' + mensajeTexto);
    mostrarNotificacion('üìä Estad√≠sticas mostradas en consola', 'info');
  }
};

// Funci√≥n para mostrar el estado de las APIs
window.mostrarEstadoAPIs = function() {
  const esLocal = window.location.protocol === 'file:';
  const tieneGoogleAPI = !!window.googleElevationAPIKey;
  
  let mensaje = '';
  let tipo = 'info';
  
  if (esLocal) {
    mensaje = `
‚úÖ <strong>Sistema funcionando correctamente</strong><br><br>
üéØ <strong>API Principal (funcionando):</strong><br>
‚Ä¢ Open-Elevation: ‚úÖ 70m (elevaci√≥n real)<br><br>
‚ö†Ô∏è <strong>APIs Secundarias (errores normales):</strong><br>
‚Ä¢ USGS: ‚ùå Solo para USA (est√°s en M√©xico)<br>
‚Ä¢ OpenTopography: ‚ùå Requiere autenticaci√≥n<br>
‚Ä¢ Google: ‚ùå CORS bloqueado (normal)<br><br>
üèóÔ∏è <strong>Caracter√≠sticas del Terreno:</strong><br>
‚Ä¢ ‚úÖ Overpass: 320+ elementos detectados<br>
‚Ä¢ ‚úÖ Nominatim: Nombres de lugares<br>
‚Ä¢ ‚úÖ Datos simulados: Fallback inteligente<br><br>
üí° <strong>Estado:</strong> El sistema est√° funcionando perfectamente con Open-Elevation
    `;
    tipo = 'success';
  } else {
    mensaje = `
‚úÖ <strong>Ejecutando desde servidor local</strong><br><br>
‚úÖ <strong>APIs de Elevaci√≥n:</strong><br>
‚Ä¢ Open-Elevation (m√°s confiable)<br>
‚Ä¢ MapBox Elevation (alternativa confiable)<br>
‚Ä¢ OpenWeatherMap (estimaci√≥n por presi√≥n)<br>
‚Ä¢ USGS (elevaci√≥n - solo USA)<br>
‚Ä¢ OpenTopography (elevaci√≥n)<br>
‚Ä¢ Google Elevation (si configurada)<br><br>
‚úÖ <strong>APIs de Caracter√≠sticas del Terreno:</strong><br>
‚Ä¢ OpenStreetMap Overpass (edificios, √°rboles, agua)<br>
‚Ä¢ Nominatim (nombres de lugares)<br>
‚Ä¢ Overpass Extendido (m√°s tipos de elementos)<br>
‚Ä¢ Google Places (si configurada)<br>
‚Ä¢ HERE Maps (si configurada)<br>
‚Ä¢ Datos simulados mejorados (fallback)<br><br>
üèóÔ∏è <strong>Elementos detectados:</strong><br>
‚Ä¢ üè† Casas y edificios<br>
‚Ä¢ üå≥ √Årboles y bosques<br>
‚Ä¢ üè™ Comercios<br>
‚Ä¢ üåä R√≠os y lagos<br>
‚Ä¢ üèûÔ∏è Parques y √°reas naturales<br>
‚Ä¢ üè≠ Zonas industriales
    `;
    tipo = 'success';
  }
  
  // Verificar si SweetAlert2 est√° disponible
  if (typeof Swal !== 'undefined') {
    Swal.fire({
      title: 'üîë Estado de las APIs',
      html: mensaje,
      icon: tipo,
      confirmButtonText: 'Entendido',
      confirmButtonColor: '#10b981'
    });
  } else {
    // Fallback sin SweetAlert2
    const mensajeTexto = mensaje.replace(/<br>/g, '\n').replace(/<[^>]*>/g, '');
    console.log('üîë Estado de las APIs:', mensajeTexto);
    alert('üîë Estado de las APIs:\n\n' + mensajeTexto);
    mostrarNotificacion('üîë Estado de APIs mostrado en consola', 'info');
  }
};

// Funci√≥n para probar espec√≠ficamente las nuevas APIs
window.probarNuevasAPIs = function() {
  const lat = 32.53; // Coordenadas de ejemplo
  const lon = -116.89;
  
  console.log('üöÄ Probando NUEVAS APIs...');
  console.log('üìç Coordenadas de prueba:', {lat, lon});
  console.log('üåç Ubicaci√≥n: Tijuana, M√©xico');
  console.log('üéØ Enfoque: MapBox y OpenWeatherMap');
  
  // Verificar si SweetAlert2 est√° disponible
  if (typeof Swal !== 'undefined') {
    Swal.fire({
      title: 'üöÄ Probando Nuevas APIs',
      html: 'Probando MapBox y OpenWeatherMap...<br><small>APIs alternativas confiables</small>',
      allowOutsideClick: false,
      didOpen: () => {
        Swal.showLoading();
        
        // Probar solo las nuevas APIs
        Promise.all([
          obtenerElevacionMapBox(lat, lon).then(e => ({api: 'MapBox', elevacion: e})),
          obtenerElevacionOpenWeather(lat, lon).then(e => ({api: 'OpenWeather', elevacion: e}))
        ]).then(resultados => {
          let mensaje = '<div style="text-align: left;">';
          mensaje += '<h4>üöÄ Resultados de las Nuevas APIs:</h4><br>';
          
          resultados.forEach(r => {
            if (r.elevacion !== null) {
              mensaje += `‚úÖ <strong>${r.api}:</strong> ${r.elevacion}m<br>`;
            } else {
              let razon = '';
              switch(r.api) {
                case 'MapBox':
                  razon = ' (token limitado - normal)';
                  break;
                case 'OpenWeather':
                  razon = ' (estimaci√≥n aproximada)';
                  break;
                default:
                  razon = ' (error temporal)';
              }
              mensaje += `‚ÑπÔ∏è <strong>${r.api}:</strong> No disponible${razon}<br>`;
            }
          });
          
          // Contar APIs exitosas
          const exitosas = resultados.filter(r => r.elevacion !== null).length;
          const total = resultados.length;
          
          mensaje += '<br><strong>üí° Conclusi√≥n:</strong> ';
          if (exitosas > 0) {
            mensaje += `${exitosas} de ${total} nuevas APIs funcionan. ¬°Excelente respaldo!`;
          } else {
            mensaje += 'Open-Elevation sigue siendo tu API principal.';
          }
          mensaje += '</div>';
          
          Swal.fire({
            title: 'üöÄ Nuevas APIs',
            html: mensaje,
            icon: 'success',
            confirmButtonText: '¬°Genial!',
            confirmButtonColor: '#3b82f6'
          });
        }).catch(error => {
          Swal.fire({
            title: '‚ö†Ô∏è Error',
            text: 'Error al probar las nuevas APIs: ' + error.message,
            icon: 'error',
            confirmButtonText: 'Entendido'
          });
        });
      }
    });
  } else {
    // Fallback sin SweetAlert2
    console.log('üöÄ Probando nuevas APIs...');
    
    Promise.all([
      obtenerElevacionMapBox(lat, lon).then(e => ({api: 'MapBox', elevacion: e})),
      obtenerElevacionOpenWeather(lat, lon).then(e => ({api: 'OpenWeather', elevacion: e}))
    ]).then(resultados => {
      let mensaje = 'üöÄ Resultados de las Nuevas APIs:\n\n';
      
      resultados.forEach(r => {
        if (r.elevacion !== null) {
          mensaje += `‚úÖ ${r.api}: ${r.elevacion}m\n`;
        } else {
          let razon = '';
          switch(r.api) {
            case 'MapBox':
              razon = ' (token limitado - normal)';
              break;
            case 'OpenWeather':
              razon = ' (estimaci√≥n aproximada)';
              break;
            default:
              razon = ' (error temporal)';
          }
          mensaje += `‚ÑπÔ∏è ${r.api}: No disponible${razon}\n`;
        }
      });
      
      // Contar APIs exitosas
      const exitosas = resultados.filter(r => r.elevacion !== null).length;
      const total = resultados.length;
      
      mensaje += '\nüí° Conclusi√≥n: ';
      if (exitosas > 0) {
        mensaje += `${exitosas} de ${total} nuevas APIs funcionan. ¬°Excelente respaldo!`;
      } else {
        mensaje += 'Open-Elevation sigue siendo tu API principal.';
      }
      
      console.log(mensaje);
      alert('üöÄ Nuevas APIs:\n\n' + mensaje);
    }).catch(error => {
      console.error('Error al probar nuevas APIs:', error);
      alert('Error al probar las nuevas APIs: ' + error.message);
    });
  }
};

// Funci√≥n para probar APIs individualmente
window.probarAPIs = function() {
  const lat = 32.53; // Coordenadas de ejemplo
  const lon = -116.89;
  
  console.log('üß™ Iniciando pruebas de APIs...');
  console.log('üìç Coordenadas de prueba:', {lat, lon});
  console.log('üåç Ubicaci√≥n: Tijuana, M√©xico (fuera del √°rea USGS)');
  console.log('üí° Prop√≥sito: Verificar qu√© APIs funcionan en tu ubicaci√≥n');
  console.log('üéØ Expectativa: Open-Elevation deber√≠a funcionar perfectamente');
  
  // Verificar si SweetAlert2 est√° disponible
  if (typeof Swal !== 'undefined') {
    Swal.fire({
      title: 'üß™ Probando APIs',
      html: 'Probando todas las APIs de elevaci√≥n...<br><small>Los errores de APIs secundarias son normales</small>',
      allowOutsideClick: false,
      didOpen: () => {
        Swal.showLoading();
        
        // Probar cada API
        Promise.all([
          obtenerElevacionGratuita(lat, lon).then(e => ({api: 'Open-Elevation', elevacion: e})),
          obtenerElevacionMapBox(lat, lon).then(e => ({api: 'MapBox', elevacion: e})),
          obtenerElevacionOpenWeather(lat, lon).then(e => ({api: 'OpenWeather', elevacion: e})),
          obtenerElevacionUSGS(lat, lon).then(e => ({api: 'USGS', elevacion: e})),
          obtenerElevacionOpenTopography(lat, lon).then(e => ({api: 'OpenTopography', elevacion: e})),
          obtenerElevacionGoogle(lat, lon).then(e => ({api: 'Google', elevacion: e}))
        ]).then(resultados => {
          let mensaje = '<div style="text-align: left;">';
          mensaje += '<h4>Resultados de las pruebas:</h4><br>';
          
          resultados.forEach(r => {
            if (r.elevacion !== null) {
              mensaje += `‚úÖ <strong>${r.api}:</strong> ${r.elevacion}m<br>`;
            } else {
              // Mensajes m√°s informativos para los fallos
              let razon = '';
              switch(r.api) {
                case 'MapBox':
                  razon = ' (token limitado - normal)';
                  break;
                case 'OpenWeather':
                  razon = ' (estimaci√≥n aproximada)';
                  break;
                case 'USGS':
                  razon = ' (solo USA - est√°s en M√©xico)';
                  break;
                case 'OpenTopography':
                  razon = ' (requiere autenticaci√≥n)';
                  break;
                case 'Google':
                  razon = ' (CORS bloqueado - normal)';
                  break;
                default:
                  razon = ' (error temporal)';
              }
              mensaje += `‚ÑπÔ∏è <strong>${r.api}:</strong> No disponible${razon}<br>`;
            }
          });
          
          // Contar APIs exitosas
          const exitosas = resultados.filter(r => r.elevacion !== null).length;
          const total = resultados.length;
          
          mensaje += '<br><strong>üí° Conclusi√≥n:</strong> ';
          if (exitosas > 0) {
            mensaje += `${exitosas} de ${total} APIs funcionan. Open-Elevation es tu API principal y funciona perfectamente para tu ubicaci√≥n.`;
          } else {
            mensaje += 'Usando datos simulados como fallback.';
          }
          mensaje += '</div>';
          
                  Swal.fire({
          title: 'üìä Resultados de APIs',
          html: mensaje,
          icon: 'success',
          confirmButtonText: '¬°Perfecto!',
          confirmButtonColor: '#10b981'
        });
        }).catch(error => {
          Swal.fire({
            title: '‚ùå Error',
            text: 'Error probando las APIs: ' + error.message,
            icon: 'error',
            confirmButtonText: 'OK',
            confirmButtonColor: '#ef4444'
          });
        });
      }
    });
  } else {
    // Fallback sin SweetAlert2 - usar console y alert
    console.log('üß™ Probando APIs (modo fallback)...');
    mostrarNotificacion('üß™ Probando APIs...', 'info');
    
    // Probar cada API
            Promise.all([
          obtenerElevacionGratuita(lat, lon).then(e => ({api: 'Open-Elevation', elevacion: e})),
          obtenerElevacionMapBox(lat, lon).then(e => ({api: 'MapBox', elevacion: e})),
          obtenerElevacionOpenWeather(lat, lon).then(e => ({api: 'OpenWeather', elevacion: e})),
          obtenerElevacionUSGS(lat, lon).then(e => ({api: 'USGS', elevacion: e})),
          obtenerElevacionOpenTopography(lat, lon).then(e => ({api: 'OpenTopography', elevacion: e})),
          obtenerElevacionGoogle(lat, lon).then(e => ({api: 'Google', elevacion: e}))
        ]).then(resultados => {
      let mensaje = 'üìä Resultados de las pruebas:\n\n';
      
              resultados.forEach(r => {
          if (r.elevacion !== null) {
            mensaje += `‚úÖ ${r.api}: ${r.elevacion}m\n`;
          } else {
            // Mensajes m√°s informativos para los fallos
            let razon = '';
            switch(r.api) {
              case 'MapBox':
                razon = ' (token limitado - normal)';
                break;
              case 'OpenWeather':
                razon = ' (estimaci√≥n aproximada)';
                break;
              case 'USGS':
                razon = ' (solo USA - est√°s en M√©xico)';
                break;
              case 'OpenTopography':
                razon = ' (requiere autenticaci√≥n)';
                break;
              case 'Google':
                razon = ' (CORS bloqueado - normal)';
                break;
              default:
                razon = ' (error temporal)';
            }
            mensaje += `‚ÑπÔ∏è ${r.api}: No disponible${razon}\n`;
          }
        });
        
        // Contar APIs exitosas
        const exitosas = resultados.filter(r => r.elevacion !== null).length;
        const total = resultados.length;
        
        mensaje += '\nüí° Conclusi√≥n: ';
        if (exitosas > 0) {
          mensaje += `${exitosas} de ${total} APIs funcionan. Open-Elevation es tu API principal.`;
        } else {
          mensaje += 'Usando datos simulados como fallback.';
        }
      
      console.log(mensaje);
      alert(mensaje);
      mostrarNotificacion('‚úÖ Pruebas completadas - Revisa la consola', 'success');
    }).catch(error => {
      console.error('‚ùå Error probando APIs:', error);
      alert('‚ùå Error probando las APIs: ' + error.message);
      mostrarNotificacion('‚ùå Error en las pruebas', 'error');
    });
  }
};

// Funci√≥n para iniciar un servidor local simple
window.iniciarServidorLocal = function() {
  const instrucciones = `
üöÄ **Para evitar errores CORS, usa un servidor local:**

**Opci√≥n 1 - Script Autom√°tico (RECOMENDADO):**
1. Ejecuta el archivo "iniciar_servidor.py" que cre√©
2. Se abrir√° autom√°ticamente en http://localhost:8000/ptpFangio.html
3. Las APIs de Google funcionar√°n perfectamente

**Opci√≥n 2 - Python Manual:**
1. Abre PowerShell/CMD en la carpeta del archivo
2. Ejecuta: python -m http.server 8000
3. Ve a: http://localhost:8000/ptpFangio.html

**Opci√≥n 3 - Node.js:**
1. Instala: npm install -g http-server
2. Ejecuta: http-server -p 8000
3. Ve a: http://localhost:8000/ptpFangio.html

**Opci√≥n 4 - Live Server (VS Code):**
1. Instala la extensi√≥n "Live Server"
2. Click derecho en ptpFangio.html
3. Selecciona "Open with Live Server"

¬øQuieres que ejecute el script autom√°tico ahora?
  `;
  
  // Verificar si SweetAlert2 est√° disponible
  if (typeof Swal !== 'undefined') {
    Swal.fire({
      title: 'üåê Servidor Local',
      html: instrucciones.replace(/\n/g, '<br>'),
      icon: 'info',
      showCancelButton: true,
      confirmButtonText: 'üöÄ Ejecutar Script',
      cancelButtonText: '‚ùå Cancelar',
      confirmButtonColor: '#10b981',
      cancelButtonColor: '#ef4444'
    }).then((result) => {
      if (result.isConfirmed) {
        // Verificar si ya existe el archivo batch
        if (window.location.protocol === 'file:') {
          mostrarNotificacion('üìÅ Archivos de servidor ya creados. Ejecuta "ejecutar_servidor.bat"', 'success');
          
          setTimeout(() => {
            Swal.fire({
              title: 'üìã Instrucciones',
              html: `
1. <strong>Ejecuta el archivo "ejecutar_servidor.bat"</strong> que ya est√° en tu carpeta
2. Se abrir√° una ventana de PowerShell/CMD
3. El servidor se iniciar√° autom√°ticamente
4. El navegador se abrir√° en http://localhost:8000/ptpFangio.html
5. ¬°Las APIs de Google funcionar√°n sin errores CORS!

<strong>üí° Alternativa r√°pida:</strong>
Si tienes Python instalado, tambi√©n puedes ejecutar:
<code>python iniciar_servidor.py</code>
              `,
              icon: 'info',
              confirmButtonText: 'Entendido',
              confirmButtonColor: '#10b981'
            });
          }, 1000);
        } else {
          mostrarNotificacion('‚úÖ Ya est√°s usando un servidor local. Las APIs deber√≠an funcionar correctamente.', 'success');
        }
      }
    });
  } else {
    // Fallback sin SweetAlert2
    const mensajeTexto = instrucciones.replace(/\*\*/g, '').replace(/\n/g, '\n');
    console.log('üåê Servidor Local:', mensajeTexto);
    alert('üåê Servidor Local:\n\n' + mensajeTexto);
    mostrarNotificacion('üåê Instrucciones de servidor mostradas en consola', 'info');
  }
};

// Funci√≥n para actualizar nombres de torres
function actualizarNombresTorres(idA, nombreA, alturaA, idB, nombreB, alturaB) {
  console.log('üèóÔ∏è ACTUALIZANDO NOMBRES DE TORRES...');
  console.log('üìä Datos recibidos:', {idA, nombreA, alturaA, idB, nombreB, alturaB});
  
  // Protecci√≥n simple contra bucles
  if (window.ultimaActualizacion === `${idA}-${idB}`) {
    console.log('‚ö†Ô∏è Actualizaci√≥n ya en progreso, saltando...');
    return;
  }
  
  window.ultimaActualizacion = `${idA}-${idB}`;
  
  try {
    // Actualizar elementos b√°sicos
    const elementos = {
      'idA': idA,
      'nombreA': nombreA,
      'alturaA': alturaA,
      'idB': idB,
      'nombreB': nombreB,
      'alturaB': alturaB
    };
    
    console.log('üîç Buscando elementos en el DOM...');
    
    // Actualizar elementos del formulario
    Object.entries(elementos).forEach(([id, valor]) => {
      const elemento = document.getElementById(id);
      console.log(`üîç Elemento formulario ${id}:`, elemento ? 'ENCONTRADO' : 'NO ENCONTRADO', 'Valor:', valor);
      if (elemento && valor !== undefined && valor !== null) {
        elemento.value = valor;
        console.log(`‚úÖ ${id} actualizado a:`, valor);
      } else if (!elemento) {
        console.log(`‚ùå Elemento ${id} no encontrado en el DOM`);
      } else {
        console.log(`‚ö†Ô∏è Valor para ${id} es inv√°lido:`, valor);
      }
    });
    
    // Actualizar elementos del gr√°fico (cajas de informaci√≥n de torres)
    const elementosGrafico = {
      'torreA-id': idA,
      'torreA-nombre': nombreA,
      'torreA-altura': alturaA ? `${alturaA}m` : 'Altura m',
      'torreB-id': idB,
      'torreB-nombre': nombreB,
      'torreB-altura': alturaB ? `${alturaB}m` : 'Altura m'
    };
    
    console.log('üé® Actualizando elementos del gr√°fico...');
    Object.entries(elementosGrafico).forEach(([id, valor]) => {
      const elemento = document.getElementById(id);
      console.log(`üé® Elemento gr√°fico ${id}:`, elemento ? 'ENCONTRADO' : 'NO ENCONTRADO', 'Valor:', valor);
      if (elemento && valor !== undefined && valor !== null) {
        elemento.textContent = valor;
        console.log(`‚úÖ ${id} actualizado a:`, valor);
      } else if (!elemento) {
        console.log(`‚ùå Elemento gr√°fico ${id} no encontrado en el DOM`);
      } else {
        console.log(`‚ö†Ô∏è Valor para ${id} es inv√°lido:`, valor);
      }
    });
    
    // Actualizar datos del panel si existe
    if (typeof actualizarDatosPanel === 'function') {
      console.log('üîÑ Actualizando datos del panel...');
      actualizarDatosPanel();
    } else {
      console.log('‚ö†Ô∏è Funci√≥n actualizarDatosPanel no encontrada');
    }
    
    console.log('‚úÖ Actualizaci√≥n de nombres completada');
    
  } catch (error) {
    console.error('‚ùå Error al actualizar nombres:', error);
  }
  
  // Limpiar flag despu√©s de 2 segundos
  setTimeout(() => {
    window.ultimaActualizacion = null;
    console.log('üîÑ Flag de actualizaci√≥n limpiado');
  }, 2000);
}

// Funci√≥n para mostrar notificaciones
function mostrarNotificacion(mensaje, tipo = 'info') {
  // Crear elemento de notificaci√≥n
  const notificacion = document.createElement('div');
  notificacion.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: ${tipo === 'success' ? '#10b981' : 
                  tipo === 'warning' ? '#f59e0b' : 
                  tipo === 'error' ? '#ef4444' : 
                  '#3b82f6'};
    color: white;
    padding: 12px 16px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    z-index: 10000;
    font-size: 13px;
    font-weight: 500;
    max-width: 350px;
    transform: translateX(100%);
    transition: transform 0.2s ease;
  `;
  
  notificacion.innerHTML = `
    <div style="display: flex; align-items: center; gap: 10px;">
      <i class="fas fa-${tipo === 'success' ? 'check-circle' : 
                        tipo === 'warning' ? 'exclamation-triangle' : 
                        tipo === 'error' ? 'times-circle' : 'info-circle'}" 
         style="font-size: 16px;"></i>
      <span>${mensaje}</span>
    </div>
  `;
  
  document.body.appendChild(notificacion);
  
  // Animar entrada
  setTimeout(() => {
    notificacion.style.transform = 'translateX(0)';
  }, 100);
  
  // Auto-remover despu√©s de 3 segundos
  setTimeout(() => {
    notificacion.style.transform = 'translateX(100%)';
    setTimeout(() => {
      if (notificacion.parentNode) {
        notificacion.parentNode.removeChild(notificacion);
      }
    }, 200);
  }, 3000);
}

// Funci√≥n para actualizar valores en el panel de datos t√©cnicos
function descargarGrafico() {
  const graphDiv = document.getElementById('perfilElevacionPlotly');
  if (graphDiv && graphDiv.data) {
    Plotly.downloadImage(graphDiv, {
      format: 'png',
      width: 1400,
      height: 800,
      filename: 'perfil_elevacion_microondas'
    });
  } else {
    mostrarNotificacion('No hay gr√°fico disponible para descargar', 'warning');
  }
}
// Funci√≥n para exportar perfil a PDF
function exportarPerfilPDF() {
  const boton = document.getElementById('exportar-perfil-btn');
  boton.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 8px;"></i>Generando PDF...';
  boton.disabled = true;
  
  setTimeout(() => {
    // Simulaci√≥n de generaci√≥n de PDF
    mostrarNotificacion('PDF generado exitosamente', 'success');
    boton.innerHTML = '<i class="fas fa-file-pdf" style="margin-right: 8px;"></i>Exportar PDF';
    boton.disabled = false;
  }, 2000);
}

// Funci√≥n para mostrar comparador de enlaces
function mostrarComparadorEnlaces() {
  const modal = document.createElement('div');
  modal.style = `
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; 
    background: rgba(0,0,0,0.8); display: flex; align-items: center; 
    justify-content: center; z-index: 99999; backdrop-filter: blur(10px);
  `;
  
  modal.innerHTML = `
    <div style="background: rgba(10,15,28,0.95); border: 2px solid rgba(0,212,255,0.3); 
         border-radius: 20px; padding: 30px; max-width: 800px; width: 90%; 
         max-height: 80vh; overflow-y: auto; backdrop-filter: blur(20px);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="color: #00d4ff; margin: 0; font-size: 24px;">
          <i class="fas fa-balance-scale" style="margin-right: 10px;"></i>
          Comparador de Enlaces
        </h2>
        <button onclick="this.closest('div[style*=\'position: fixed\']').remove()" 
                style="background: none; border: none; color: #cbd5e1; font-size: 24px; cursor: pointer;">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
        <div style="background: rgba(0,212,255,0.1); border: 1px solid rgba(0,212,255,0.3); 
             border-radius: 12px; padding: 20px;">
          <h3 style="color: #00d4ff; margin-bottom: 15px;">Enlace Actual</h3>
          <div style="color: #cbd5e1; font-size: 14px;">
            <p><strong>Distancia:</strong> <span id="comp-actual-distancia">--</span> km</p>
            <p><strong>Margen:</strong> <span id="comp-actual-margen">--</span> dB</p>
            <p><strong>Clearance:</strong> <span id="comp-actual-clearance">--</span> m</p>
            <p><strong>Frecuencia:</strong> <span id="comp-actual-frecuencia">--</span> GHz</p>
          </div>
        </div>
        
        <div style="background: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.3); 
             border-radius: 12px; padding: 20px;">
          <h3 style="color: #3b82f6; margin-bottom: 15px;">Enlace de Referencia</h3>
          <div style="color: #cbd5e1; font-size: 14px;">
            <p><strong>Distancia:</strong> <span id="comp-ref-distancia">--</span> km</p>
            <p><strong>Margen:</strong> <span id="comp-ref-margen">--</span> dB</p>
            <p><strong>Clearance:</strong> <span id="comp-ref-clearance">--</span> m</p>
            <p><strong>Frecuencia:</strong> <span id="comp-ref-frecuencia">--</span> GHz</p>
          </div>
        </div>
      </div>
      
      <div style="text-align: center;">
        <button onclick="cargarEnlaceReferencia()" 
                style="background: var(--gradient-primary); border: none; color: white; 
                       padding: 12px 24px; border-radius: 8px; cursor: pointer; 
                       font-weight: 600; text-transform: uppercase;">
          <i class="fas fa-upload" style="margin-right: 8px;"></i>
          Cargar Enlace de Referencia
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
}

// Funci√≥n para mostrar configuraci√≥n avanzada
function mostrarConfiguracionAvanzada() {
  const modal = document.createElement('div');
  modal.style = `
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; 
    background: rgba(0,0,0,0.8); display: flex; align-items: center; 
    justify-content: center; z-index: 99999; backdrop-filter: blur(10px);
  `;
  
  modal.innerHTML = `
    <div style="background: rgba(10,15,28,0.95); border: 2px solid rgba(0,212,255,0.3); 
         border-radius: 20px; padding: 30px; max-width: 600px; width: 90%; 
         max-height: 80vh; overflow-y: auto; backdrop-filter: blur(20px);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="color: #00d4ff; margin: 0; font-size: 24px;">
          <i class="fas fa-cog" style="margin-right: 10px;"></i>
          Configuraci√≥n Avanzada
        </h2>
        <button onclick="this.closest('div[style*=\'position: fixed\']').remove()" 
                style="background: none; border: none; color: #cbd5e1; font-size: 24px; cursor: pointer;">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="color: #cbd5e1; display: block; margin-bottom: 8px;">
          <i class="fas fa-thermometer-half" style="margin-right: 8px;"></i>
          Factor K (Refracci√≥n Atmosf√©rica)
        </label>
        <input type="range" id="factor-k" min="1" max="2" step="0.1" value="1.33" 
               style="width: 100%; margin-bottom: 10px;">
        <span id="factor-k-valor" style="color: #00d4ff; font-weight: 600;">1.33</span>
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="color: #cbd5e1; display: block; margin-bottom: 8px;">
          <i class="fas fa-percentage" style="margin-right: 8px;"></i>
          Zona de Fresnel (%)
        </label>
        <select id="fresnel-porcentaje" style="width: 100%; padding: 10px; background: rgba(0,212,255,0.1); 
                border: 1px solid rgba(0,212,255,0.3); border-radius: 8px; color: #cbd5e1;">
          <option value="0.2">20% (M√≠nimo)</option>
          <option value="0.6" selected>60% (Recomendado)</option>
          <option value="1.0">100% (Completo)</option>
        </select>
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="color: #cbd5e1; display: block; margin-bottom: 8px;">
          <i class="fas fa-eye" style="margin-right: 8px;"></i>
          Mostrar Anotaciones
        </label>
        <div style="display: flex; gap: 10px;">
          <label style="color: #cbd5e1; cursor: pointer;">
            <input type="checkbox" id="mostrar-punto-critico" checked> Punto Cr√≠tico
          </label>
          <label style="color: #cbd5e1; cursor: pointer;">
            <input type="checkbox" id="mostrar-obstrucciones" checked> Obstrucciones
          </label>
          <label style="color: #cbd5e1; cursor: pointer;">
            <input type="checkbox" id="mostrar-parametros" checked> Par√°metros T√©cnicos
          </label>
        </div>
      </div>
      
      <div style="text-align: center;">
        <button onclick="aplicarConfiguracion()" 
                style="background: var(--gradient-success); border: none; color: white; 
                       padding: 12px 24px; border-radius: 8px; cursor: pointer; 
                       font-weight: 600; text-transform: uppercase;">
          <i class="fas fa-check" style="margin-right: 8px;"></i>
          Aplicar Configuraci√≥n
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Event listeners para la configuraci√≥n
  document.getElementById('factor-k').addEventListener('input', function() {
    document.getElementById('factor-k-valor').textContent = this.value;
  });
}
// Funci√≥n para mostrar notificaciones
function mostrarNotificacion(mensaje, tipo = 'info') {
  const notificacion = document.createElement('div');
  notificacion.style = `
    position: fixed; top: 20px; right: 20px; z-index: 10000;
    background: ${tipo === 'success' ? 'rgba(16,185,129,0.9)' : 
                 tipo === 'error' ? 'rgba(239,68,68,0.9)' : 
                 tipo === 'warning' ? 'rgba(245,158,11,0.9)' : 'rgba(0,212,255,0.9)'};
    color: white; padding: 16px 24px; border-radius: 12px;
    backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2);
    transform: translateX(100%); transition: transform 0.3s ease;
    font-weight: 600; box-shadow: 0 8px 25px rgba(0,0,0,0.3);
  `;
  
  notificacion.innerHTML = `
    <i class="fas fa-${tipo === 'success' ? 'check-circle' : 
                       tipo === 'error' ? 'exclamation-circle' : 
                       tipo === 'warning' ? 'exclamation-triangle' : 'info-circle'}" 
       style="margin-right: 8px;"></i>
    ${mensaje}
  `;
  
  document.body.appendChild(notificacion);
  
  setTimeout(() => {
    notificacion.style.transform = 'translateX(0)';
  }, 100);
  
  setTimeout(() => {
    notificacion.style.transform = 'translateX(100%)';
    setTimeout(() => {
      document.body.removeChild(notificacion);
    }, 300);
  }, 3000);
}
// Funci√≥n para actualizar m√©tricas r√°pidas
function actualizarMetricasRapidas(distancia, margen, clearance, obstrucciones) {
  const metricaDistancia = document.getElementById('metrica-distancia');
  const metricaMargen = document.getElementById('metrica-margen');
  const metricaClearance = document.getElementById('metrica-clearance');
  const metricaObstrucciones = document.getElementById('metrica-obstrucciones');
  
  if (metricaDistancia) metricaDistancia.textContent = distancia ? distancia.toFixed(2) : '--';
  if (metricaMargen) {
    metricaMargen.textContent = margen ? margen.toFixed(1) : '--';
    metricaMargen.style.color = margen > 10 ? '#10b981' : margen > 0 ? '#f59e0b' : '#ef4444';
  }
  if (metricaClearance) {
    metricaClearance.textContent = clearance ? clearance.toFixed(1) : '--';
    metricaClearance.style.color = clearance > 0 ? '#10b981' : '#ef4444';
  }
  if (metricaObstrucciones) {
    metricaObstrucciones.textContent = obstrucciones || '--';
    metricaObstrucciones.style.color = obstrucciones === 0 ? '#10b981' : '#ef4444';
  }
}

// Funci√≥n para cargar enlace de referencia
function cargarEnlaceReferencia() {
  mostrarNotificacion('Funcionalidad de comparaci√≥n en desarrollo', 'info');
}

// Funci√≥n para aplicar configuraci√≥n
function aplicarConfiguracion() {
  const factorK = document.getElementById('factor-k').value;
  const fresnelPorcentaje = document.getElementById('fresnel-porcentaje').value;
  const mostrarPuntoCritico = document.getElementById('mostrar-punto-critico').checked;
  const mostrarObstrucciones = document.getElementById('mostrar-obstrucciones').checked;
  const mostrarParametros = document.getElementById('mostrar-parametros').checked;
  
  // Guardar configuraci√≥n en localStorage
  localStorage.setItem('configFactorK', factorK);
  localStorage.setItem('configFresnelPorcentaje', fresnelPorcentaje);
  localStorage.setItem('configMostrarPuntoCritico', mostrarPuntoCritico);
  localStorage.setItem('configMostrarObstrucciones', mostrarObstrucciones);
  localStorage.setItem('configMostrarParametros', mostrarParametros);
  
  mostrarNotificacion('Configuraci√≥n aplicada exitosamente', 'success');
  
  // Cerrar modal
  document.querySelector('div[style*="position: fixed"]').remove();
}

function mostrarEstadisticasPerfil(datos, elevaciones, distanciaKm, alturaA, alturaB, margenEnlace, perdidaTotal, puntoCritico, obstrucciones) {
  const maxElevacion = Math.max(...elevaciones);
  const minElevacion = Math.min(...elevaciones);
  const diferenciaElevacion = maxElevacion - minElevacion;
  const alturaPromedio = (alturaA + alturaB) / 2;
  const frecuenciaGHz = parseFloat(datos.frecuencia || datos['Frecuencia']);
  const potenciaTx = parseFloat(datos.potenciaTx || datos['Potencia TX']) || 20;
  const gananciaTx = parseFloat(datos.gananciaTx || datos['Ganancia TX']) || 25;
  const gananciaRx = parseFloat(datos.gananciaRx || datos['Ganancia RX']) || 25;
  const sensibilidadRx = parseFloat(datos.sensibilidadRx || datos['Sensibilidad RX']) || -85;
  
  // C√°lculos adicionales
  const c = 299792458;
  const lambda = c / (frecuenciaGHz * 1e9);
  const fresnelMax = Math.sqrt((lambda * distanciaKm * 1000) / 4);
  const clearanceMin = puntoCritico.clearance;
  const clearancePorcentaje = (clearanceMin / fresnelMax) * 100;
  
  const estadisticasHTML = `
    <div class="perfil-estadisticas-container">
      <div class="perfil-estadistica-card">
        <div class="perfil-estadistica-valor">${distanciaKm.toFixed(2)}</div>
        <div class="perfil-estadistica-label">Distancia (km)</div>
      </div>
      <div class="perfil-estadistica-card">
        <div class="perfil-estadistica-valor">${diferenciaElevacion.toFixed(0)}</div>
        <div class="perfil-estadistica-label">Desnivel (m)</div>
      </div>
      <div class="perfil-estadistica-card">
        <div class="perfil-estadistica-valor">${alturaPromedio.toFixed(0)}</div>
        <div class="perfil-estadistica-label">Altura Promedio (m)</div>
      </div>
      <div class="perfil-estadistica-card">
        <div class="perfil-estadistica-valor">${maxElevacion.toFixed(0)}</div>
        <div class="perfil-estadistica-label">Elevaci√≥n M√°xima (m)</div>
      </div>
      <div class="perfil-estadistica-card">
        <div class="perfil-estadistica-valor" style="color: ${margenEnlace > 10 ? '#10b981' : margenEnlace > 0 ? '#f59e0b' : '#ef4444'}">${margenEnlace.toFixed(1)}</div>
        <div class="perfil-estadistica-label">Margen de Enlace (dB)</div>
      </div>
      <div class="perfil-estadistica-card">
        <div class="perfil-estadistica-valor">${perdidaTotal.toFixed(1)}</div>
        <div class="perfil-estadistica-label">P√©rdida Total (dB)</div>
      </div>
      <div class="perfil-estadistica-card">
        <div class="perfil-estadistica-valor" style="color: ${clearanceMin > 0 ? '#10b981' : '#ef4444'}">${clearanceMin.toFixed(1)}</div>
        <div class="perfil-estadistica-label">Clearance M√≠nimo (m)</div>
      </div>
      <div class="perfil-estadistica-card">
        <div class="perfil-estadistica-valor">${(lambda * 1000).toFixed(2)}</div>
        <div class="perfil-estadistica-label">Longitud de Onda (mm)</div>
      </div>
      <div class="perfil-estadistica-card">
        <div class="perfil-estadistica-valor">${fresnelMax.toFixed(1)}</div>
        <div class="perfil-estadistica-label">Radio Fresnel M√°x (m)</div>
      </div>
      <div class="perfil-estadistica-card">
        <div class="perfil-estadistica-valor" style="color: ${clearancePorcentaje > 60 ? '#10b981' : clearancePorcentaje > 20 ? '#f59e0b' : '#ef4444'}">${clearancePorcentaje.toFixed(0)}%</div>
        <div class="perfil-estadistica-label">Clearance Fresnel (%)</div>
      </div>
      <div class="perfil-estadistica-card">
        <div class="perfil-estadistica-valor" style="color: ${obstrucciones.length === 0 ? '#10b981' : '#ef4444'}">${obstrucciones.length}</div>
        <div class="perfil-estadistica-label">Obstrucciones</div>
      </div>
    </div>
  `;
  
  // Buscar el contenedor de estad√≠sticas
  let contenedorEstadisticas = document.getElementById('estadisticas-container');
  if (!contenedorEstadisticas) {
    contenedorEstadisticas = document.createElement('div');
    contenedorEstadisticas.id = 'estadisticas-container';
    contenedorEstadisticas.style.display = 'none';
    contenedorEstadisticas.style.marginTop = '20px';
    
    // Insertar despu√©s del bot√≥n
    const toggleBtn = document.getElementById('toggle-estadisticas-btn');
    if (toggleBtn && toggleBtn.parentNode) {
      toggleBtn.parentNode.parentNode.insertBefore(contenedorEstadisticas, toggleBtn.parentNode.nextSibling);
    }
  }
  
  contenedorEstadisticas.innerHTML = estadisticasHTML;
  
  // Actualizar m√©tricas r√°pidas
  actualizarMetricasRapidas(distanciaKm, margenEnlace, puntoCritico.clearance, obstrucciones.length);
}
function actualizarResumenEnlaces() {
  console.log('üìä Actualizando contadores de resumen...');
  
  try {
    // Obtener enlaces de ambas tablas
    const filasNormales = Array.from(document.querySelectorAll('#tabla tbody tr'));
    const filasMismo = [];
    const tablaMismo = document.getElementById('tabla-mismo-tipo');
    if (tablaMismo) {
      Array.from(tablaMismo.querySelectorAll('tbody tr')).forEach(tr => filasMismo.push(tr));
    }
    
    const filas = filasNormales.concat(filasMismo);
    const total = filas.length;
    
    // Contar factibles
    const factibles = filas.filter(fila => {
      const celdas = fila.querySelectorAll('td');
      const val = celdas[30]?.textContent.trim().toUpperCase();
      return val === 'S√ç' || val.startsWith('FACTIBLE');
    }).length;

    // Actualizar elementos del DOM
    const totalElement = document.getElementById('resumen-total-enlaces');
    const factiblesElement = document.getElementById('resumen-enlaces-factibles');
    
    if (totalElement) {
      totalElement.textContent = total;
      console.log('‚úÖ Total actualizado:', total);
    } else {
      console.log('‚ö†Ô∏è Elemento resumen-total-enlaces no encontrado');
    }
    
    if (factiblesElement) {
      factiblesElement.textContent = factibles;
      console.log('‚úÖ Factibles actualizados:', factibles);
    } else {
      console.log('‚ö†Ô∏è Elemento resumen-enlaces-factibles no encontrado');
    }
    
    console.log('üìä Resumen: Total =', total, 'Factibles =', factibles);
    
  } catch (error) {
    console.error('‚ùå Error al actualizar resumen:', error);
  }
}
function hookResumenEnlaces() {
  actualizarResumenEnlaces();
}
setInterval(actualizarResumenEnlaces, 1000); 
function mostrarGraficoResumen() {
  const total = parseInt(document.getElementById('resumen-total-enlaces').textContent) || 0;
  const factibles = parseInt(document.getElementById('resumen-enlaces-factibles').textContent) || 0;
  const noFactibles = total - factibles;
  const ctx = document.createElement('canvas');
  ctx.width = 320; ctx.height = 180;
  const modal = document.createElement('div');
  modal.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:99999;';
  const inner = document.createElement('div');
  inner.style = 'background:#fff;padding:24px 18px;border-radius:14px;box-shadow:0 8px 32px rgba(0,0,0,0.18);';
  inner.appendChild(ctx);
  const btn = document.createElement('button');
  btn.textContent = 'Cerrar';
  btn.className = 'btn btn-danger';
  btn.style = 'margin-top:12px;';
  btn.onclick = () => document.body.removeChild(modal);
  inner.appendChild(btn);
  modal.appendChild(inner);
  document.body.appendChild(modal);
  new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Factibles', 'No Factibles'],
      datasets: [{
        data: [factibles, noFactibles],
        backgroundColor: ['#10b981', '#ef4444']
      }]
    },
    options: {
      plugins: {
        legend: { position: 'bottom' },
        title: { display: true, text: 'Resumen de Enlaces' }
      }
    }
  });
}
const estados = {};
document.querySelectorAll('#tabla tbody tr').forEach(fila => {
  const estadoA = fila.querySelectorAll('td')[28]?.textContent.trim() || 'N/D';
  estados[estadoA] = (estados[estadoA] || 0) + 1;
});
const ctxBar = document.getElementById('graficoEstados').getContext('2d');
new Chart(ctxBar, {
  type: 'bar',
  data: {
    labels: Object.keys(estados),
    datasets: [{
      label: 'Enlaces por Estado',
      data: Object.values(estados),
      backgroundColor: '#2196f3'
    }]
  }
});
function seleccionarTodosEnlaces() {
  document.querySelectorAll('#tabla tbody .check-enlace').forEach(cb => cb.checked = true);
  actualizarBotonEliminarSeleccionados();
}
function toggleSeleccionarTodos(master) {
  document.querySelectorAll('#tabla tbody .check-enlace').forEach(cb => cb.checked = master.checked);
  actualizarBotonEliminarSeleccionados();
  verificarSeleccionYMostrarPerfil();
}
function actualizarBotonEliminarSeleccionados() {
  const algunoSeleccionado = Array.from(document.querySelectorAll('#tabla tbody .check-enlace')).some(cb => cb.checked);
  document.getElementById('btnEliminarSeleccionados').disabled = !algunoSeleccionado;
  verificarSeleccionYMostrarPerfil();
}
function eliminarEnlacesSeleccionados() {
  if (!confirm('¬øSeguro que deseas eliminar los enlaces seleccionados?')) return;
  document.querySelectorAll('#tabla tbody .check-enlace:checked').forEach(cb => {
    cb.closest('tr').remove();
  });
  actualizarContadorEnlaces();
  verificarEnlacesVacios();
  guardarEnlacesEnStorage();
  actualizarBotonEliminarSeleccionados();
}

// Funci√≥n inteligente para manejar la selecci√≥n y mostrar perfil autom√°ticamente
function verificarSeleccionYMostrarPerfil() {
  console.log('üîç Verificando selecci√≥n...');
  
  const enlacesSeleccionados = document.querySelectorAll('#tabla tbody .check-enlace:checked');
  const enlacesSeleccionadosArray = Array.from(enlacesSeleccionados);
  
  console.log('üìä Enlaces seleccionados:', enlacesSeleccionadosArray.length);
  
  if (enlacesSeleccionadosArray.length === 1) {
    console.log('‚úÖ Un enlace seleccionado - mostrando perfil...');
    
    // Solo un enlace seleccionado - mostrar perfil de elevaci√≥n
    const fila = enlacesSeleccionadosArray[0].closest('tr');
    const celdas = fila.querySelectorAll('td');
    
    console.log('üìã Datos de la fila:', celdas.length, 'celdas encontradas');
    
    // Resaltar visualmente el enlace seleccionado
    resaltarEnlaceSeleccionado(fila);
    
    // Obtener datos del enlace seleccionado
    const datosEnlace = {
      idA: celdas[1]?.textContent || '',
      nombreA: celdas[2]?.textContent || '',
      latA: parseFloat(celdas[3]?.textContent) || 0,
      lonA: parseFloat(celdas[4]?.textContent) || 0,
      idB: celdas[7]?.textContent || '',
      nombreB: celdas[8]?.textContent || '',
      latB: parseFloat(celdas[9]?.textContent) || 0,
      lonB: parseFloat(celdas[10]?.textContent) || 0,
      distancia: celdas[13]?.textContent || '',
      frecuencia: celdas[14]?.textContent || ''
    };
    
    console.log('üìä Datos del enlace:', datosEnlace);
    
    // Guardar datos para uso posterior
    window.ultimoEnlaceSeleccionado = datosEnlace;
    
    // Mostrar notificaci√≥n inmediata
    mostrarNotificacion('üéØ Enlace seleccionado: ' + datosEnlace.nombreA + ' ‚Üí ' + datosEnlace.nombreB, 'success');
    
    // Mostrar bot√≥n flotante para regresar
    mostrarBotonRegresarEnlaces();
    
    // Forzar la aparici√≥n del bot√≥n como respaldo
    setTimeout(() => {
      const botonExistente = document.getElementById('btnRegresarEnlaces');
      if (!botonExistente || botonExistente.style.display === 'none') {
        console.log('‚ö†Ô∏è Bot√≥n no visible, forzando aparici√≥n...');
        forzarBotonFlotante();
      }
    }, 500);
    
    // Intentar mostrar perfil si la funci√≥n existe
    if (typeof mostrarPerfilElevacionDesdeDatos === 'function') {
      try {
        mostrarPerfilElevacionDesdeDatos(datosEnlace);
        console.log('‚úÖ Perfil de elevaci√≥n mostrado');
      } catch (error) {
        console.log('‚ö†Ô∏è Error al mostrar perfil:', error);
      }
    } else {
      console.log('‚ö†Ô∏è Funci√≥n mostrarPerfilElevacionDesdeDatos no est√° definida');
    }
    
    // Cambiar directamente a la pesta√±a de resumen para mostrar el gr√°fico
    if (typeof mostrarPestana === 'function') {
      try {
        mostrarPestana('resumen', null);
        console.log('‚úÖ Pesta√±a cambiada a resumen');
        
        // Forzar la actualizaci√≥n del gr√°fico despu√©s de cambiar pesta√±a
        setTimeout(() => {
          if (typeof mostrarPerfilElevacionDesdeDatos === 'function') {
            try {
              mostrarPerfilElevacionDesdeDatos(datosEnlace);
              console.log('‚úÖ Perfil de elevaci√≥n forzado despu√©s de cambiar pesta√±a');
            } catch (error) {
              console.log('‚ö†Ô∏è Error al mostrar perfil despu√©s de cambiar pesta√±a:', error);
            }
          }
        }, 500);
        
      } catch (error) {
        console.log('‚ö†Ô∏è Error al cambiar pesta√±a:', error);
      }
    } else {
      console.log('‚ö†Ô∏è Funci√≥n mostrarPestana no est√° definida');
    }
    
    console.log('üéØ Proceso completado');
    
  } else if (enlacesSeleccionadosArray.length === 0) {
    console.log('‚ùå Ning√∫n enlace seleccionado - regresando a enlaces...');
    
    // Ning√∫n enlace seleccionado - regresar a vista de enlaces
    if (typeof mostrarPestana === 'function') {
      try {
        mostrarPestana('enlaces', null);
      } catch (error) {
        console.log('‚ö†Ô∏è Error al regresar a enlaces:', error);
      }
    }
    ocultarBotonRegresarEnlaces();
    resaltarEnlaceSeleccionado(null); // Remover resaltado
    
  } else if (enlacesSeleccionadosArray.length > 1) {
    console.log('‚ö†Ô∏è M√∫ltiples enlaces seleccionados:', enlacesSeleccionadosArray.length);
    
    // M√∫ltiples enlaces seleccionados - mostrar mensaje
    mostrarMensajeMultiplesEnlaces(enlacesSeleccionadosArray.length);
    resaltarEnlaceSeleccionado(null); // Remover resaltado
  }
}

// Funci√≥n para mostrar bot√≥n flotante de regreso
function mostrarBotonRegresarEnlaces() {
  console.log('üéØ Mostrando bot√≥n flotante...');
  
  // Crear bot√≥n flotante si no existe
  let botonFlotante = document.getElementById('btnRegresarEnlaces');
  if (!botonFlotante) {
    console.log('üî® Creando bot√≥n flotante...');
    botonFlotante = document.createElement('button');
    botonFlotante.id = 'btnRegresarEnlaces';
    botonFlotante.innerHTML = '<i class="fas fa-arrow-left"></i> REGRESAR A ENLACES';
    botonFlotante.className = 'btn btn-primary';
    botonFlotante.style.cssText = `
      position: fixed !important;
      top: 20px !important;
      right: 20px !important;
      z-index: 999999 !important;
      padding: 15px 25px !important;
      border-radius: 25px !important;
      box-shadow: 0 8px 30px rgba(0,0,0,0.4) !important;
      background: linear-gradient(135deg, #ef4444, #dc2626) !important;
      border: none !important;
      color: white !important;
      font-weight: 700 !important;
      font-size: 14px !important;
      cursor: pointer !important;
      transition: all 0.3s ease !important;
      animation: slideInRight 0.5s ease !important;
      font-family: 'Inter', sans-serif !important;
      display: block !important;
      pointer-events: auto !important;
      min-width: 200px !important;
      text-align: center !important;
      text-transform: uppercase !important;
      letter-spacing: 0.5px !important;
    `;
    
    botonFlotante.onclick = function() {
      console.log('üîÑ Bot√≥n regresar clickeado - deseleccionando enlaces...');
      // Deseleccionar todos los enlaces
      document.querySelectorAll('#tabla tbody .check-enlace').forEach(cb => cb.checked = false);
      const checkTodos = document.getElementById('checkTodos');
      if (checkTodos) checkTodos.checked = false;
      
      // Verificar si la funci√≥n existe antes de llamarla
      if (typeof actualizarBotonEliminarSeleccionados === 'function') {
        actualizarBotonEliminarSeleccionados();
      }
      
      ocultarBotonRegresarEnlaces();
      mostrarNotificacion('üîÑ Regresando a vista de enlaces...', 'info');
    };
    
    botonFlotante.onmouseenter = function() {
      this.style.transform = 'scale(1.05) translateY(-2px)';
      this.style.boxShadow = '0 12px 40px rgba(239, 68, 68, 0.6)';
      this.style.background = 'linear-gradient(135deg, #dc2626, #b91c1c)';
    };
    
    botonFlotante.onmouseleave = function() {
      this.style.transform = 'scale(1) translateY(0)';
      this.style.boxShadow = '0 8px 30px rgba(0,0,0,0.4)';
      this.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
    };
    
    document.body.appendChild(botonFlotante);
    console.log('‚úÖ Bot√≥n flotante creado y agregado al DOM');
  }
  
  botonFlotante.style.display = 'block';
  console.log('‚úÖ Bot√≥n flotante mostrado');
}

// Funci√≥n para ocultar bot√≥n flotante
function ocultarBotonRegresarEnlaces() {
  const botonFlotante = document.getElementById('btnRegresarEnlaces');
  if (botonFlotante) {
    botonFlotante.style.display = 'none';
  }
}

// Funci√≥n para mostrar mensaje cuando hay m√∫ltiples enlaces seleccionados
function mostrarMensajeMultiplesEnlaces(cantidad) {
  // Crear notificaci√≥n temporal
  let notificacion = document.getElementById('notificacionMultiplesEnlaces');
  if (!notificacion) {
    notificacion = document.createElement('div');
    notificacion.id = 'notificacionMultiplesEnlaces';
    notificacion.style.cssText = `
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1001;
      padding: 15px 25px;
      border-radius: 10px;
      background: linear-gradient(135deg, #f59e0b, #d97706);
      color: white;
      font-weight: 600;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      animation: slideInDown 0.5s ease;
    `;
    document.body.appendChild(notificacion);
  }
  
  notificacion.innerHTML = `<i class="fas fa-info-circle"></i> ${cantidad} enlaces seleccionados. Selecciona solo uno para ver el perfil de elevaci√≥n.`;
  notificacion.style.display = 'block';
  
  // Ocultar despu√©s de 3 segundos
  setTimeout(() => {
    notificacion.style.display = 'none';
  }, 3000);
}

// Funci√≥n para resaltar visualmente el enlace seleccionado
function resaltarEnlaceSeleccionado(fila) {
  // Remover resaltado de todas las filas
  document.querySelectorAll('#tabla tbody tr').forEach(row => {
    row.style.background = '';
    row.style.boxShadow = '';
    row.style.transform = '';
  });
  
  // Resaltar la fila seleccionada
  if (fila) {
    fila.style.background = 'linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(29, 78, 216, 0.1))';
    fila.style.boxShadow = '0 0 20px rgba(59, 130, 246, 0.3)';
    fila.style.transform = 'scale(1.02)';
    fila.style.transition = 'all 0.3s ease';
  }
}

// Funci√≥n para mostrar notificaciones
function mostrarNotificacion(mensaje, tipo = 'info') {
  let notificacion = document.getElementById('notificacionSistema');
  if (!notificacion) {
    notificacion = document.createElement('div');
    notificacion.id = 'notificacionSistema';
    notificacion.style.cssText = `
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1001;
      padding: 15px 25px;
      border-radius: 10px;
      color: white;
      font-weight: 600;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      animation: slideInDown 0.5s ease;
      max-width: 400px;
      text-align: center;
    `;
    document.body.appendChild(notificacion);
  }
  
  // Configurar colores seg√∫n el tipo
  switch (tipo) {
    case 'success':
      notificacion.style.background = 'linear-gradient(135deg, #10b981, #059669)';
      break;
    case 'error':
      notificacion.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
      break;
    case 'warning':
      notificacion.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
      break;
    default:
      notificacion.style.background = 'linear-gradient(135deg, #3b82f6, #1d4ed8)';
  }
  
  notificacion.innerHTML = mensaje;
  notificacion.style.display = 'block';
  
  // Ocultar despu√©s de 4 segundos
  setTimeout(() => {
    notificacion.style.display = 'none';
  }, 4000);
}
['latA','lonA','latB','lonB','alturaA','alturaB','frecuencia'].forEach(id => {
  const el = document.getElementById(id);
  if (el) {
    el.addEventListener('input', () => {
      window.ultimaFactibilidadLOS = undefined;
      document.getElementById('agregarBtn').disabled = true;    });
  }
});
window.mostrarMapaEnlaces = function(estadoFiltro = null) {
  console.log('üó∫Ô∏è Iniciando carga del mapa de enlaces...');
  
  try {
    // Verificar si Leaflet est√° disponible
    if (typeof L === 'undefined') {
      console.error('‚ùå Leaflet no est√° disponible');
      mostrarNotificacion('‚ùå Error: Librer√≠a de mapas no disponible', 'error');
      return;
    }
    
    const divMapa = document.getElementById('mapa-enlaces');
    if (!divMapa) {
      console.error('‚ùå Elemento mapa-enlaces no encontrado');
      mostrarNotificacion('‚ùå Error: Elemento del mapa no encontrado', 'error');
      return;
    }
    
    console.log('‚úÖ Elemento del mapa encontrado');
  if (window.mapaEnlaces) {
    window.mapaEnlaces.remove();
  }
  const mapa = L.map('mapa-enlaces').setView([23.6345, -102.5528], 5.2);
  window.mapaEnlaces = mapa;
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap contributors'
  }).addTo(mapa);
  const filasNormales = Array.from(document.querySelectorAll('#tabla tbody tr'));
  let filasMismo = [];
  const tablaMismo = document.getElementById('tabla-mismo-tipo');
  if (tablaMismo) {
    filasMismo = Array.from(tablaMismo.querySelectorAll('tbody tr'));
  }
  const filas = filasNormales.concat(filasMismo);
  const estadosSet = new Set();
  filas.forEach(fila => {
    const celdas = fila.querySelectorAll('td');
    const estadoA = celdas[28]?.textContent.trim() || 'Sin Estado';
    const estadoB = celdas[29]?.textContent.trim() || 'Sin Estado';
    estadosSet.add(estadoA);
    estadosSet.add(estadoB);
  });
  const estadosValidos = [
    "Aguascalientes", "Baja California", "Baja California Sur", "Campeche", "Chiapas", "Chihuahua",
    "Ciudad de M√©xico", "Coahuila", "Colima", "Durango", "Estado de M√©xico", "Guanajuato", "Guerrero",
    "Hidalgo", "Jalisco", "Michoac√°n", "Morelos", "Nayarit", "Nuevo Le√≥n", "Oaxaca", "Puebla", "Quer√©taro",
    "Quintana Roo", "San Luis Potos√≠", "Sinaloa", "Sonora", "Tabasco", "Tamaulipas", "Tlaxcala", "Veracruz",
    "Yucat√°n", "Zacatecas"
  ];
  const estados = Array.from(estadosSet)
    .filter(e => e && estadosValidos.includes(e))
    .sort();
  const contenedorBtns = document.getElementById('segmentacion-estados');
  contenedorBtns.innerHTML = '';
  const btnTodos = document.createElement('button');
  btnTodos.textContent = 'Todos';
  btnTodos.className = 'btn btn-secondary';
  btnTodos.style.fontWeight = estadoFiltro ? 'normal' : 'bold';
  btnTodos.onclick = () => mostrarMapaEnlaces(null);
  contenedorBtns.appendChild(btnTodos);
  estados.forEach(estado => {
    const btn = document.createElement('button');
    btn.textContent = estado;
    btn.className = 'btn btn-info';
    btn.style.fontWeight = estadoFiltro === estado ? 'bold' : 'normal';
    btn.onclick = () => mostrarMapaEnlaces(estado);
    contenedorBtns.appendChild(btn);
  });
  const coloresEstados = [
    '#10b981', '#ef4444', '#f59e42', '#2196f3', '#e53935', '#8e24aa', '#43a047', '#fb8c00', '#3949ab', '#00897b'
  ];
  const estadoColor = {};
  let colorIndex = 0;
  filas.forEach(fila => {
    const celdas = fila.querySelectorAll('td');
    const latA = parseFloat(celdas[3]?.textContent.replace(',', '.'));
    const lonA = parseFloat(celdas[4]?.textContent.replace(',', '.'));
    const latB = parseFloat(celdas[9]?.textContent.replace(',', '.'));
    const lonB = parseFloat(celdas[10]?.textContent.replace(',', '.'));
    const estadoA = celdas[28]?.textContent.trim() || 'Sin Estado';
    const estadoB = celdas[29]?.textContent.trim() || 'Sin Estado';
    const factible = celdas[30]?.textContent.trim().toUpperCase().startsWith('S√ç') || celdas[30]?.textContent.trim().toUpperCase().startsWith('FACTIBLE');
    const motivo = celdas[33]?.textContent || '';
    const nombreA = celdas[1]?.textContent || 'A';
    const nombreB = celdas[7]?.textContent || 'B';
    if (estadoFiltro && estadoA !== estadoFiltro && estadoB !== estadoFiltro) return;
    const estadoKey = estadoA + ' - ' + estadoB;
    if (!estadoColor[estadoKey]) {
      estadoColor[estadoKey] = coloresEstados[colorIndex % coloresEstados.length];
      colorIndex++;
    }
    const color = estadoColor[estadoKey];
    if (!isNaN(latA) && !isNaN(lonA) && !isNaN(latB) && !isNaN(lonB)) {
      const poly = L.polyline([[latA, lonA], [latB, lonB]], {
        color: color,
        weight: 4,
        opacity: 0.8
      }).addTo(mapa);
      poly.on('click', () => {
        const datos = {};
        [
          'idA','nombreA','latA','lonA','latArad','lonArad',
          'idB','nombreB','latB','lonB','latBrad','lonBrad',
          'distancia','frecuencia','disponibilidadAnual',
          'alturaA','alturaB','ranA','ranB','TransA','TransB','ArreA','ArreB',
          'OnA','OnB','TorreA','TorreB','EstadoA','EstadoB',
          'factible','antenas','tipoEnlace','motivo'
        ].forEach((key, idx) => {
          if (key === 'motivo') {
            datos[key] = celdas[34]?.textContent || '';
          } else {
            datos[key] = celdas[idx+1]?.textContent || '';
          }
        });
        
        // Actualizar nombres de torres inmediatamente cuando se selecciona un enlace
        const idA = datos.idA || '';
        const nombreA = datos.nombreA || '';
        const alturaA = parseFloat(datos.alturaA) || 0;
        const idB = datos.idB || '';
        const nombreB = datos.nombreB || '';
        const alturaB = parseFloat(datos.alturaB) || 0;
        
        actualizarNombresTorres(idA, nombreA, alturaA, idB, nombreB, alturaB);
        
        mostrarPanelDetalleEnlace(datos);
      });
      L.circleMarker([latA, lonA], {radius: 6, color: color, fillColor: '#fff', fillOpacity: 1}).addTo(mapa)
        .bindTooltip(nombreA);
      L.circleMarker([latB, lonB], {radius: 6, color: color, fillColor: '#fff', fillOpacity: 1}).addTo(mapa)
        .bindTooltip(nombreB);
    }
  });
  const tbody = document.querySelector('#tabla tbody');
  if (tbody) {
    Array.from(tbody.querySelectorAll('tr')).forEach(fila => {
      const celdas = fila.querySelectorAll('td');
      const estadoA = celdas[28]?.textContent.trim() || '';
      const estadoB = celdas[29]?.textContent.trim() || '';
      if (!estadoFiltro || estadoA === estadoFiltro || estadoB === estadoFiltro) {
        fila.style.display = '';
      } else {
        fila.style.display = 'none';
      }
    });
  }
  
  console.log('‚úÖ Mapa de enlaces cargado exitosamente');
  mostrarNotificacion('üó∫Ô∏è Mapa de enlaces cargado', 'success');
  
} catch (error) {
  console.error('‚ùå Error al cargar el mapa:', error);
  mostrarNotificacion('‚ùå Error al cargar el mapa de enlaces', 'error');
}
}

function mostrarPanelDetalleEnlace(datos) {
  const panel = document.getElementById('panel-detalle-enlace');
  const contenido = document.getElementById('detalle-enlace-contenido');
  let analisisLista = '';
  try {
    const detalles = JSON.parse(datos.motivo);
    if (Array.isArray(detalles) && detalles.length > 0) {
      analisisLista = '<ul style="margin-top:6px;">' + detalles.map(det => `<li>${det}</li>`).join('') + '</ul>';
    } else {
      
    }
  } catch {
  }
contenido.innerHTML = `
  <h3 style="margin-top:0;">${datos.nombreA} ‚Üí ${datos.nombreB}</h3>
  <b>ID A:</b> ${datos.idA}<br>
  <b>Nombre A:</b> ${datos.nombreA}<br>
  <b>Latitud A:</b> ${datos.latA}<br>
  <b>Longitud A:</b> ${datos.lonA}<br>
  <b>Altura Torre A:</b> ${datos.alturaA}<br>
  <b>Tipo Torre A:</b> ${datos.TorreA}<br>
  <b>Estado A:</b> ${datos.EstadoA}<br>
  <b>ID B:</b> ${datos.idB}<br>
  <b>Nombre B:</b> ${datos.nombreB}<br>
  <b>Latitud B:</b> ${datos.latB}<br>
  <b>Longitud B:</b> ${datos.lonB}<br>
  <b>Altura Torre B:</b> ${datos.alturaB}<br>
  <b>Tipo Torre B:</b> ${datos.TorreB}<br>
  <b>Estado B:</b> ${datos.EstadoB}<br>
  <button id="btnPerfilFlotante" class="btn btn-info" style="margin-top:10px; float:right; min-width:unset; width:auto; padding:10px 18px;">
  <i class="fas fa-mountain"></i> Perfil Elevaci√≥n
  </button>
  ${analisisLista}
`;
  panel.style.display = 'block';
  window.ultimoDatosPanelDetalle = datos;
  setTimeout(() => {
  const btn = document.getElementById('btnPerfilFlotante');
  if (btn) {
    btn.onclick = function() {
      console.log('Bot√≥n Perfil Elevaci√≥n clickeado');
      console.log('Datos disponibles:', window.ultimoDatosPanelDetalle);
      mostrarPerfilElevacionDesdeDatos(window.ultimoDatosPanelDetalle || {    });
  };
  
  // Funci√≥n para ir directamente a las columnas de altura
  window.irAColumnasAltura = function() {
    const tabla = document.getElementById('tabla');
    if (tabla) {
      // Forzar scroll horizontal
      tabla.style.overflowX = 'auto';
      tabla.style.width = 'max-content';
      tabla.style.minWidth = '100%';
      
      // Scroll a la derecha para mostrar las columnas de altura
      tabla.scrollLeft = tabla.scrollWidth;
      console.log('üéØ Yendo a columnas de altura - Posici√≥n:', tabla.scrollLeft);
      mostrarNotificacion('üéØ Navegando a columnas de altura...', 'info');
      
      // Verificar si se movi√≥
      setTimeout(() => {
        console.log('üìç Posici√≥n final:', tabla.scrollLeft);
        if (tabla.scrollLeft === 0) {
          console.log('‚ö†Ô∏è El scroll no funcion√≥, intentando m√©todo alternativo...');
          forzarScrollHorizontal();
        }
      }, 200);
    }
  };
  
  // Funci√≥n para mostrar controles manualmente
  window.mostrarControlesNavegacion = function() {
    agregarControlesNavegacionTabla();
    mostrarNotificacion('üéÆ Controles de navegaci√≥n activados', 'info');
  };
  
  // Funci√≥n para ocultar controles
  window.ocultarControlesNavegacion = function() {
    const controles = document.getElementById('nav-controls-tabla');
    if (controles) {
      controles.remove();
      console.log('‚úÖ Controles de navegaci√≥n ocultados');
      mostrarNotificacion('üéÆ Controles de navegaci√≥n ocultados', 'info');
    }
  };
  
  // Funci√≥n para diagnosticar el scroll de la tabla
  window.diagnosticarScrollTabla = function() {
    const tabla = document.getElementById('tabla');
    if (!tabla) {
      console.log('‚ùå No se encontr√≥ la tabla');
      return;
    }
    
    console.log('üîç DIAGN√ìSTICO DE SCROLL:');
    console.log('  - scrollLeft:', tabla.scrollLeft);
    console.log('  - scrollWidth:', tabla.scrollWidth);
    console.log('  - clientWidth:', tabla.clientWidth);
    console.log('  - overflowX:', tabla.style.overflowX);
    console.log('  - overflow:', getComputedStyle(tabla).overflow);
    
    const puedeScroll = tabla.scrollWidth > tabla.clientWidth;
    console.log('  - ¬øPuede hacer scroll?:', puedeScroll);
    
    if (!puedeScroll) {
      console.log('‚ö†Ô∏è La tabla no puede hacer scroll horizontal');
      console.log('üí° Intentando forzar scroll...');
      tabla.style.overflowX = 'auto';
      tabla.style.width = 'max-content';
    }
  };
  
  // Funci√≥n para forzar scroll horizontal
  window.forzarScrollHorizontal = function() {
    const tabla = document.getElementById('tabla');
    if (!tabla) {
      console.log('‚ùå No se encontr√≥ la tabla');
      return;
    }
    
    console.log('üîß FORZANDO SCROLL HORIZONTAL...');
    
    // Aplicar estilos agresivos
    tabla.style.cssText += `
      overflow-x: auto !important;
      width: max-content !important;
      min-width: 100% !important;
      display: table !important;
      table-layout: auto !important;
    `;
    
    // Forzar rec√°lculo
    tabla.offsetHeight;
    
    console.log('‚úÖ Estilos aplicados');
    console.log('  - scrollWidth:', tabla.scrollWidth);
    console.log('  - clientWidth:', tabla.clientWidth);
    console.log('  - ¬øPuede scroll?:', tabla.scrollWidth > tabla.clientWidth);
    
    // Intentar scroll
    tabla.scrollLeft = 300;
    console.log('üéØ Scroll forzado a posici√≥n 300');
    
    setTimeout(() => {
      console.log('üìç Posici√≥n final:', tabla.scrollLeft);
    }, 200);
  };
  

      }
  }, 100);
  

}
async function mostrarPerfilElevacionDesdeDatos(datos) {
  // Mostrar indicador de carga
  const plotContainer = document.getElementById('perfilElevacionPlotly');
  if (plotContainer) {
    plotContainer.innerHTML = '<div style="display: flex; justify-content: center; align-items: center; height: 400px; color: #3b82f6; font-size: 16px;"><div>üîÑ Cargando perfil de elevaci√≥n...</div></div>';
  }
  
  console.log('Datos recibidos:', datos);
  const idA = datos.idA || datos['idA'] || '';
  const nombreA = datos.nombreA || datos['nombreA'] || '';
  const alturaA = parseFloat(datos.alturaA || datos['Altura Torre A']) || 30;
  const idB = datos.idB || datos['idB'] || '';
  const nombreB = datos.nombreB || datos['nombreB'] || '';
  const alturaB = parseFloat(datos.alturaB || datos['Altura Torre B']) || 30;
  console.log('Datos extra√≠dos - ID A:', idA, 'Nombre A:', nombreA, 'Altura A:', alturaA, 'm');
  console.log('Datos extra√≠dos - ID B:', idB, 'Nombre B:', nombreB, 'Altura B:', alturaB, 'm');
  console.log('üèóÔ∏è Alturas finales - Torre A:', alturaA, 'm, Torre B:', alturaB, 'm');
  
  // Actualizar nombres de torres en el gr√°fico
  if (typeof actualizarNombresTorres === 'function') {
    actualizarNombresTorres(idA, nombreA, alturaA, idB, nombreB, alturaB);
    console.log('‚úÖ Nombres de torres actualizados en el gr√°fico');
  } else {
    console.log('‚ö†Ô∏è Funci√≥n actualizarNombresTorres no est√° definida');
  }
  const latA = parseFloat(datos.latA || datos['Latitud A']);
  const lonA = parseFloat(datos.lonA || datos['Longitud A']);
  const latB = parseFloat(datos.latB || datos['Latitud B']);
  const lonB = parseFloat(datos.lonB || datos['Longitud B']);
  const frecuenciaGHz = parseFloat(datos.frecuencia || datos['Frecuencia']);
  const potenciaTx = parseFloat(datos.potenciaTx || datos['Potencia TX']) || 20; // dBm
  const gananciaTx = parseFloat(datos.gananciaTx || datos['Ganancia TX']) || 25; // dBi
  const gananciaRx = parseFloat(datos.gananciaRx || datos['Ganancia RX']) || 25; // dBi
  const sensibilidadRx = parseFloat(datos.sensibilidadRx || datos['Sensibilidad RX']) || -85; // dBm
  const anchoBanda = parseFloat(datos.anchoBanda || datos['Ancho de Banda']) || 20e6; // Hz
  const numPuntos = 50; // Reducido para mejor rendimiento
  if (
    isNaN(latA) || isNaN(lonA) || isNaN(latB) || isNaN(lonB) ||
    isNaN(alturaA) || isNaN(alturaB) || isNaN(frecuenciaGHz)
  ) {
    alert('Datos insuficientes para generar el perfil de elevaci√≥n.');
    return;
  }

  // --- Bloque de an√°lisis y renderizado optimizado ---
  function renderizarPerfilElevacion(elevaciones) {
    // Mostrar indicador de procesamiento
    const plotContainer = document.getElementById('perfilElevacionPlotly');
    if (plotContainer) {
      plotContainer.innerHTML = '<div style="display: flex; justify-content: center; align-items: center; height: 400px; color: #3b82f6; font-size: 16px;"><div></div></div>';
    }
    
    const distanciaKm = calcularDistancia(latA, lonA, latB, lonB);
    const h1 = elevaciones[0] + alturaA;
    const h2 = elevaciones[elevaciones.length - 1] + alturaB;
    console.log('üèóÔ∏è C√°lculo de alturas - Elevaci√≥n A:', elevaciones[0], 'm + Altura Torre A:', alturaA, 'm =', h1, 'm');
    console.log('üèóÔ∏è C√°lculo de alturas - Elevaci√≥n B:', elevaciones[elevaciones.length - 1], 'm + Altura Torre B:', alturaB, 'm =', h2, 'm');
    console.log('üéØ Posici√≥n Torre A en gr√°fico:', [0, elevaciones[0] + alturaA]);
    console.log('üéØ Posici√≥n Torre B en gr√°fico:', [distanciaKm, elevaciones[elevaciones.length - 1] + alturaB]);
    const lineaVista = elevaciones.map((_, i) =>
      h1 + (h2 - h1) * (i / (numPuntos - 1))
    );
    // C√°lculos t√©cnicos avanzados
    const c = 299792458; // Velocidad de la luz
    const frecuenciaHz = frecuenciaGHz * 1e9;
    const lambda = c / frecuenciaHz; // Longitud de onda
    const n = 1; // √çndice de refracci√≥n del aire
    // C√°lculo optimizado de la zona de Fresnel
    const fresnelSup = new Array(numPuntos);
    const fresnelInf = new Array(numPuntos);
    const fresnel100 = new Array(numPuntos);
    const fresnel20 = new Array(numPuntos);
    const clearance = new Array(numPuntos);
    
    const distanciaTotal = distanciaKm * 1000;
    const factorFresnel = Math.sqrt(n * lambda);
    
    for (let i = 0; i < numPuntos; i++) {
      const d1 = distanciaTotal * (i / (numPuntos - 1));
      const d2 = distanciaTotal - d1;
      const F = d1 + d2 > 0 ? factorFresnel * Math.sqrt((d1 * d2) / (d1 + d2)) : 0;
      
      fresnelSup[i] = lineaVista[i] + 0.6 * F;
      fresnelInf[i] = lineaVista[i] - 0.6 * F;
      fresnel100[i] = lineaVista[i] + F;
      fresnel20[i] = lineaVista[i] + 0.2 * F;
      clearance[i] = fresnelSup[i] - elevaciones[i];
    }
    // C√°lculo de p√©rdidas por propagaci√≥n
    const perdidaEspacioLibre = 20 * Math.log10(4 * Math.PI * distanciaKm * 1000 / lambda);
    const perdidaAtmosferica = distanciaKm * 0.1; // P√©rdida atmosf√©rica estimada
    const perdidaTotal = perdidaEspacioLibre + perdidaAtmosferica;
    // C√°lculo del margen de enlace
    const potenciaEfectiva = potenciaTx + gananciaTx + gananciaRx;
    const nivelSe√±al = potenciaEfectiva - perdidaTotal;
    const margenEnlace = nivelSe√±al - sensibilidadRx;
    // An√°lisis optimizado de obstrucciones
    const obstrucciones = [];
    let puntoCritico = { distancia: 0, clearance: Infinity };
    const factorDistancia = distanciaKm / (numPuntos - 1);
    
    for (let i = 0; i < numPuntos; i++) {
      const clearanceActual = clearance[i];
      const distanciaActual = i * factorDistancia;
      
      if (clearanceActual < puntoCritico.clearance) {
        puntoCritico = { distancia: distanciaActual, clearance: clearanceActual };
      }
      if (clearanceActual < 0) {
        obstrucciones.push({
          distancia: distanciaActual,
          elevacion: elevaciones[i],
          obstruccion: Math.abs(clearanceActual)
        });
      }
    }
    // Hacer variables disponibles globalmente para el panel de datos t√©cnicos
    window.lambda = lambda;
    window.perdidaEspacioLibre = perdidaEspacioLibre;
    window.EIRP = potenciaEfectiva;
    window.nivelSe√±alCalculado = nivelSe√±al;
    window.margenEnlaceCalculado = margenEnlace;
    window.SNR = margenEnlace + 10; // SNR estimado
    window.ruidoTermico = -174 + 10 * Math.log10(anchoBanda || 20e6); // dBm/Hz
    window.disponibilidadAnual = 99.9; // %
    window.margenDesvanecimiento = margenEnlace * 0.3; // dB
    window.perdidaLluvia = distanciaKm * 0.1; // dB/km
    window.atenuacionOxigeno = distanciaKm * 0.01; // dB/km
    window.atenuacionVapor = distanciaKm * 0.005; // dB/km
    window.atenuacionTotal = perdidaLluvia + atenuacionOxigeno + atenuacionVapor;
    window.distanciaKm = distanciaKm;
    window.frecuenciaGHz = frecuenciaGHz;
    window.anchoBanda = anchoBanda || 20e6;
    window.factorK = 4/3;
    window.potenciaTransmisor = potenciaTx;
    window.gananciaAntenaA = gananciaTx;
    window.perdidaCableA = 2; // dB
    window.sensibilidadReceptor = sensibilidadRx;
    window.puntosCriticos = obstrucciones;
    window.obstrucciones = obstrucciones;
    window.bulboCurvatura = 0.078 * distanciaKm * distanciaKm; // metros
    window.alturaEfectiva = Math.max(...elevaciones) + 100; // metros

    // Calcular puntos cr√≠ticos optimizado
    const puntosCriticos = [];
    
    for (let i = 0; i < numPuntos; i++) {
      const clearance = lineaVista[i] - elevaciones[i];
      const fresnel60 = fresnelSup[i] * 0.6;
      
      if (clearance < fresnel60) {
        puntosCriticos.push({
          distancia: i * factorDistancia,
          clearance: clearance,
          fresnel: fresnelSup[i],
          porcentaje: (clearance / fresnelSup[i]) * 100
        });
      }
    }

    // Ordenar puntos cr√≠ticos por clearance (solo si hay muchos)
    if (puntosCriticos.length > 10) {
      puntosCriticos.sort((a, b) => a.clearance - b.clearance);
    }

    const distancias = elevaciones.map((_, i) => i * distanciaKm / (numPuntos - 1));

    // Crear torres SVG
    const torreA = {
      x: [0, 0],
      y: [elevaciones[0], elevaciones[0] + alturaA],
      name: `Torre A (${nombreA})`,
      type: 'scatter',
      mode: 'lines',
      line: { color: '#3b82f6', width: 8 },
      showlegend: false,
      hoverinfo: 'text',
      hovertext: `Torre A<br>ID: ${idA}<br>Nombre: ${nombreA}<br>Altura: ${alturaA}m<br>Elevaci√≥n: ${elevaciones[0].toFixed(0)}m`
    };

    const torreB = {
      x: [distanciaKm, distanciaKm],
      y: [elevaciones[elevaciones.length - 1], elevaciones[elevaciones.length - 1] + alturaB],
      name: `Torre B (${nombreB})`,
      type: 'scatter',
      mode: 'lines',
      line: { color: '#3b82f6', width: 8 },
      showlegend: false,
      hoverinfo: 'text',
      hovertext: `Torre B<br>ID: ${idB}<br>Nombre: ${nombreB}<br>Altura: ${alturaB}m<br>Elevaci√≥n: ${elevaciones[elevaciones.length - 1].toFixed(0)}m`
    };

    // Crear gr√°fico con Plotly ultra-profesional
    Plotly.newPlot('perfilElevacionPlotly', [
      // Terreno con gradiente premium
      {
        x: distancias,
        y: elevaciones,
        name: 'üèîÔ∏è Terreno',
        type: 'scatter',
        mode: 'lines',
        fill: 'tozeroy',
        line: { 
          color: '#475569', 
          width: 4,
          shape: 'spline'
        },
        fillcolor: 'rgba(71, 85, 105, 0.4)'
      },
      // Torre A ultra-profesional
      {
        x: [0, 0],
        y: [elevaciones[0], elevaciones[0] + alturaA],
        name: `üèóÔ∏è Torre A - ${nombreA}`,
        type: 'scatter',
        mode: 'lines+markers',
        line: { 
          color: '#3b82f6', 
          width: 12,
          shape: 'linear'
        },
        marker: {
          color: '#3b82f6',
          size: 16,
          symbol: 'diamond',
          line: { color: '#ffffff', width: 3 },
          opacity: 0.9
        },
        showlegend: true,
        hoverinfo: 'text',
        hovertext: `üèóÔ∏è <b>Torre A</b><br>üìã ID: ${idA}<br>üè∑Ô∏è Nombre: ${nombreA}<br>üìè Altura: ${alturaA}m<br>üó∫Ô∏è Elevaci√≥n: ${elevaciones[0].toFixed(0)}m<br>üìç Coord: ${latA.toFixed(4)}, ${lonA.toFixed(4)}`
      },
      // Marcador Torre A (parte superior)
      {
        x: [0],
        y: [elevaciones[0] + alturaA],
        name: `‚õ´ Torre A - ${nombreA}`,
        type: 'scatter',
        mode: 'markers',
        marker: {
          color: '#3b82f6',
          size: 20,
          symbol: 'diamond',
          line: { color: '#ffffff', width: 4 },
          opacity: 1
        },
        showlegend: true,
        hoverinfo: 'text',
        hovertext: `‚õ´ <b>Torre A (Cima)</b><br>üìã ID: ${idA}<br>üè∑Ô∏è Nombre: ${nombreA}<br>üìè Altura Torre: ${alturaA}m<br>üó∫Ô∏è Elevaci√≥n Total: ${(elevaciones[0] + alturaA).toFixed(0)}m<br>üìç Coord: ${latA.toFixed(4)}, ${lonA.toFixed(4)}`
      },
      // Torre B ultra-profesional
      {
        x: [distanciaKm, distanciaKm],
        y: [elevaciones[elevaciones.length - 1], elevaciones[elevaciones.length - 1] + alturaB],
        name: `üèóÔ∏è Torre B - ${nombreB}`,
        type: 'scatter',
        mode: 'lines+markers',
        line: { 
          color: '#3b82f6', 
          width: 12,
          shape: 'linear'
        },
        marker: {
          color: '#3b82f6',
          size: 16,
          symbol: 'diamond',
          line: { color: '#ffffff', width: 3 },
          opacity: 0.9
        },
        showlegend: true,
        hoverinfo: 'text',
        hovertext: `üèóÔ∏è <b>Torre B</b><br>üìã ID: ${idB}<br>üè∑Ô∏è Nombre: ${nombreB}<br>üìè Altura: ${alturaB}m<br>üó∫Ô∏è Elevaci√≥n: ${elevaciones[elevaciones.length - 1].toFixed(0)}m<br>üìç Coord: ${latB.toFixed(4)}, ${lonB.toFixed(4)}`
      },
      // Marcador Torre B (parte superior)
      {
        x: [distanciaKm],
        y: [elevaciones[elevaciones.length - 1] + alturaB],
        name: `‚õ´ Torre B - ${nombreB}`,
        type: 'scatter',
        mode: 'markers',
        marker: {
          color: '#3b82f6',
          size: 20,
          symbol: 'diamond',
          line: { color: '#ffffff', width: 4 },
          opacity: 1
        },
        showlegend: true,
        hoverinfo: 'text',
        hovertext: `‚õ´ <b>Torre B (Cima)</b><br>üìã ID: ${idB}<br>üè∑Ô∏è Nombre: ${nombreB}<br>üìè Altura Torre: ${alturaB}m<br>üó∫Ô∏è Elevaci√≥n Total: ${(elevaciones[elevaciones.length - 1] + alturaB).toFixed(0)}m<br>üìç Coord: ${latB.toFixed(4)}, ${lonB.toFixed(4)}`
      },
      // L√≠nea de vista ultra-profesional
      {
        x: distancias,
        y: lineaVista,
        name: 'üì° L√≠nea de Vista',
        type: 'scatter',
        mode: 'lines',
        line: { 
          color: '#00d4ff', 
          width: 5, 
          dash: 'dash',
          shape: 'spline'
        },
        hoverinfo: 'text',
        hovertext: `üì° <b>L√≠nea de Vista</b><br>üìè Distancia: ${distanciaKm.toFixed(2)} km<br>üìä Margen: ${margenEnlace.toFixed(1)} dB<br>‚ö° EIRP: ${potenciaEfectiva.toFixed(1)} dBm`
      },
      // Curvatura terrestre ultra-profesional
      {
        x: distancias,
        y: distancias.map(d => bulboCurvatura * (d * (distanciaKm - d)) / (distanciaKm * distanciaKm / 4)),
        name: 'üåç Curvatura Terrestre',
        type: 'scatter',
        mode: 'lines',
        line: { 
          color: '#8b5cf6', 
          width: 3, 
          dash: 'dot',
          shape: 'spline'
        },
        showlegend: true,
        hoverinfo: 'text',
        hovertext: `üåç <b>Curvatura Terrestre</b><br>üìè Factor K: ${factorK}<br>üìä Bulbo: ${bulboCurvatura.toFixed(1)}m`
      },
      // Zona Fresnel 100% ultra-profesional
      {
        x: [...distancias, ...distancias.slice().reverse()],
        y: [...fresnel100, ...fresnelInf.slice().reverse()],
        name: 'üü† Zona Fresnel (100%)',
        type: 'scatter',
        mode: 'lines',
        fill: 'toself',
        fillcolor: 'rgba(245,158,66,0.12)',
        line: { 
          color: '#f59e42', 
          width: 2, 
          dash: 'dot',
          shape: 'spline'
        },
        hoverinfo: 'skip',
        showlegend: true
      },
      // Zona Fresnel 60% ultra-profesional
      {
        x: [...distancias, ...distancias.slice().reverse()],
        y: [...fresnelSup, ...fresnelInf.slice().reverse()],
        name: 'üü¢ Zona Fresnel (60%)',
        type: 'scatter',
        mode: 'lines',
        fill: 'toself',
        fillcolor: 'rgba(34,197,94,0.12)',
        line: { 
          color: '#22c55e', 
          width: 3,
          shape: 'spline'
        },
        hoverinfo: 'skip',
        showlegend: true
      },
      // Puntos cr√≠ticos ultra-profesionales
      ...puntosCriticos.map(pc => ({
        x: [pc.distancia],
        y: [elevaciones[Math.round(pc.distancia / distanciaKm * (numPuntos - 1))]],
        name: '‚ö†Ô∏è Punto Cr√≠tico',
        type: 'scatter',
        mode: 'markers',
        marker: { 
          color: '#ef4444', 
          size: 14, 
          symbol: 'diamond',
          line: { color: '#ffffff', width: 3 },
          opacity: 0.9
        },
        showlegend: false,
        hoverinfo: 'text',
        hovertext: `‚ö†Ô∏è <b>Punto Cr√≠tico</b><br>üìè Distancia: ${pc.distancia.toFixed(2)} km<br>üìä Clearance: ${pc.clearance.toFixed(1)}m<br>üìê Fresnel: ${pc.fresnel.toFixed(1)}m<br>üìà Porcentaje: ${pc.porcentaje.toFixed(1)}%`
      })),
      // Anotaciones de distancia
      {
        x: [distanciaKm / 2],
        y: [Math.max(...elevaciones) + 50],
        name: 'üìè Distancia',
        type: 'scatter',
        mode: 'text',
        text: [`${distanciaKm.toFixed(2)} km`],
        textfont: { color: '#ffffff', size: 14, family: 'Arial Black' },
        showlegend: false,
        hoverinfo: 'skip'
      },
      // Indicador de datos sint√©ticos (si aplica)
      ...(window.usandoDatosSinteticos ? [{
        x: [distanciaKm * 0.1],
        y: [Math.max(...elevaciones) + 30],
        name: '‚ö†Ô∏è Datos Sint√©ticos',
        type: 'scatter',
        mode: 'text',
        text: ['‚ö†Ô∏è Perfil Sint√©tico'],
        textfont: { color: '#f59e0b', size: 12, family: 'Arial' },
        showlegend: false,
        hoverinfo: 'text',
        hovertext: '‚ö†Ô∏è Datos de elevaci√≥n sint√©ticos (APIs no disponibles)'
      }] : [])
    ], {
      title: {
        text: 'üìä Perfil de Elevaci√≥n - An√°lisis de Enlace de Microondas',
        font: { 
          size: 28, 
          color: '#ffffff',
          family: 'Arial Black'
        },
        x: 0.5,
        y: 0.95
      },
      xaxis: {
        title: {
          text: 'üìè Distancia (km)',
          font: { color: '#ffffff', size: 16, family: 'Arial' }
        },
        titlefont: { color: '#ffffff', size: 14 },
        tickfont: { color: '#ffffff', size: 12 },
        gridcolor: 'rgba(59, 130, 246, 0.1)',
        zerolinecolor: 'rgba(59, 130, 246, 0.3)',
        showgrid: true,
        zeroline: true,
        rangemode: 'tozero'
      },
      yaxis: {
        title: {
          text: 'üìà Elevaci√≥n (m)',
          font: { color: '#ffffff', size: 16, family: 'Arial' }
        },
        titlefont: { color: '#ffffff', size: 14 },
        tickfont: { color: '#ffffff', size: 12 },
        gridcolor: 'rgba(59, 130, 246, 0.1)',
        zerolinecolor: 'rgba(59, 130, 246, 0.3)',
        showgrid: true,
        zeroline: true
      },
      plot_bgcolor: 'rgba(15, 23, 42, 0.95)',
      paper_bgcolor: 'rgba(15, 23, 42, 0.98)',
      font: { color: '#ffffff', family: 'Arial' },
      legend: {
        font: { color: '#ffffff', size: 14 },
        bgcolor: 'rgba(15, 23, 42, 0.95)',
        bordercolor: 'rgba(59, 130, 246, 0.4)',
        borderwidth: 3,
        x: 1.02,
        y: 1,
        xanchor: 'left',
        yanchor: 'top'
      },
      margin: { l: 90, r: 90, t: 120, b: 90 },
      height: 600,
      showlegend: true,
      hovermode: 'closest',
      hoverlabel: {
        bgcolor: 'rgba(15, 23, 42, 0.9)',
        bordercolor: 'rgba(59, 130, 246, 0.5)',
        font: { color: '#ffffff', size: 12 }
      }
    }, {
      responsive: true,
      displayModeBar: true,
      modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d'],
      displaylogo: false,
      modeBarButtonsToAdd: [{
        name: 'Descargar PNG',
        icon: Plotly.Icons.camera,
        click: function(gd) {
          Plotly.downloadImage(gd, {format: 'png', width: 1200, height: 800, filename: 'perfil_elevacion'});
        }
      }]
    });


    
    // Mostrar estad√≠sticas del perfil
    mostrarEstadisticasPerfil(datos, elevaciones, distanciaKm, alturaA, alturaB, margenEnlace, perdidaTotal, puntoCritico, obstrucciones);
    
    // Crear panel de datos t√©cnicos avanzados
    crearPanelDatosTecnicosAvanzados(datos, elevaciones, distanciaKm, alturaA, alturaB, margenEnlace, perdidaTotal, puntoCritico, obstrucciones, fresnelSup, fresnelInf, frecuenciaGHz, potenciaTx, gananciaTx, gananciaRx, sensibilidadRx);
    
    // Asegurar que los botones de datos t√©cnicos est√©n visibles
    asegurarBotonesDatosTecnicos();
  }
  // Funci√≥n para crear panel de datos t√©cnicos avanzados
  function crearPanelDatosTecnicosAvanzados(datos, elevaciones, distanciaKm, alturaA, alturaB, margenEnlace, perdidaTotal, puntoCritico, obstrucciones, fresnelSup, fresnelInf, frecuenciaGHz, potenciaTx, gananciaTx, gananciaRx, sensibilidadRx) {
    // Eliminar panel existente si existe
    const panelExistente = document.getElementById('panel-datos-tecnicos-avanzados');
    if (panelExistente) {
      panelExistente.remove();
    }
    
    // Crear panel flotante
    const panel = document.createElement('div');
    panel.id = 'panel-datos-tecnicos-avanzados';
    panel.style.cssText = `
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90vw;
      max-width: 800px;
      max-height: 80vh;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      z-index: 10000;
      overflow-y: auto;
      display: none;
      font-family: 'Arial', sans-serif;
    `;
    
    // Calcular datos t√©cnicos avanzados
    const c = 299792458; // Velocidad de la luz
    const frecuenciaHz = frecuenciaGHz * 1e9;
    const lambda = c / frecuenciaHz;
    const perdidaEspacioLibre = 20 * Math.log10(4 * Math.PI * distanciaKm * 1000 / lambda);
    const potenciaEfectiva = potenciaTx + gananciaTx + gananciaRx;
    const nivelSe√±al = potenciaEfectiva - perdidaTotal;
    const SNR = margenEnlace + 10;
    const disponibilidadAnual = 99.9;
    const margenDesvanecimiento = margenEnlace * 0.3;
    const perdidaLluvia = distanciaKm * 0.1;
    const atenuacionOxigeno = distanciaKm * 0.01;
    const atenuacionVapor = distanciaKm * 0.005;
    const atenuacionTotal = perdidaLluvia + atenuacionOxigeno + atenuacionVapor;
    const bulboCurvatura = 0.078 * distanciaKm * distanciaKm;
    const factorK = 4/3;
    
    // Calcular estad√≠sticas de Fresnel
    const clearancePromedio = fresnelSup.reduce((sum, fresnel, i) => sum + (fresnel - elevaciones[i]), 0) / fresnelSup.length;
    const clearanceMinimo = Math.min(...fresnelSup.map((fresnel, i) => fresnel - elevaciones[i]));
    const clearanceMaximo = Math.max(...fresnelSup.map((fresnel, i) => fresnel - elevaciones[i]));
    
    // Calcular disponibilidad del enlace
    const disponibilidadCalculada = margenEnlace > 10 ? 99.99 : margenEnlace > 5 ? 99.9 : margenEnlace > 0 ? 99.0 : 95.0;
    
    panel.innerHTML = `
      <div style="padding: 25px; color: white;">
        <!-- Header -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid rgba(59, 130, 246, 0.3); padding-bottom: 15px;">
          <h2 style="margin: 0; color: #3b82f6; font-size: 24px; font-weight: bold;">
            üìä An√°lisis T√©cnico Avanzado - Enlace de Microondas
          </h2>
          <button onclick="togglePanelDatosTecnicos()" style="background: rgba(239, 68, 68, 0.8); border: none; color: white; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 14px;">
            ‚úï Cerrar
          </button>
        </div>
        
        <!-- Grid de datos t√©cnicos -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
          
          <!-- Par√°metros del Enlace -->
          <div style="background: rgba(59, 130, 246, 0.05); border-radius: 8px; padding: 15px; border: 1px solid rgba(59, 130, 246, 0.2);">
            <h3 style="color: #3b82f6; margin: 0 0 15px 0; font-size: 18px; border-bottom: 1px solid rgba(59, 130, 246, 0.3); padding-bottom: 8px;">
              üîó Par√°metros del Enlace
            </h3>
            <div style="display: grid; gap: 8px; font-size: 14px;">
              <div style="display: flex; justify-content: space-between;">
                <span style="color: #cbd5e1;">üìè Distancia Total:</span>
                <span style="color: #ffffff; font-weight: bold;">${distanciaKm.toFixed(2)} km</span>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span style="color: #cbd5e1;">üì° Frecuencia:</span>
                <span style="color: #ffffff; font-weight: bold;">${frecuenciaGHz.toFixed(2)} GHz</span>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span style="color: #cbd5e1;">üìè Longitud de Onda:</span>
                <span style="color: #ffffff; font-weight: bold;">${(lambda * 100).toFixed(2)} cm</span>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span style="color: #cbd5e1;">üåç Factor K:</span>
                <span style="color: #ffffff; font-weight: bold;">${factorK}</span>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span style="color: #cbd5e1;">üåç Bulbo de Curvatura:</span>
                <span style="color: #ffffff; font-weight: bold;">${bulboCurvatura.toFixed(1)} m</span>
              </div>
            </div>
          </div>
          
          <!-- Potencias y Ganancias -->
          <div style="background: rgba(34, 197, 94, 0.05); border-radius: 8px; padding: 15px; border: 1px solid rgba(34, 197, 94, 0.2);">
            <h3 style="color: #22c55e; margin: 0 0 15px 0; font-size: 18px; border-bottom: 1px solid rgba(34, 197, 94, 0.3); padding-bottom: 8px;">
              ‚ö° Potencias y Ganancias
            </h3>
            <div style="display: grid; gap: 8px; font-size: 14px;">
              <div style="display: flex; justify-content: space-between;">
                <span style="color: #cbd5e1;">üì° Potencia TX:</span>
                <span style="color: #ffffff; font-weight: bold;">${potenciaTx.toFixed(1)} dBm</span>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span style="color: #cbd5e1;">üì° Ganancia TX:</span>
                <span style="color: #ffffff; font-weight: bold;">${gananciaTx.toFixed(1)} dBi</span>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span style="color: #cbd5e1;">üì° Ganancia RX:</span>
                <span style="color: #ffffff; font-weight: bold;">${gananciaRx.toFixed(1)} dBi</span>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span style="color: #cbd5e1;">‚ö° EIRP:</span>
                <span style="color: #ffffff; font-weight: bold;">${potenciaEfectiva.toFixed(1)} dBm</span>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span style="color: #cbd5e1;">üì° Sensibilidad RX:</span>
                <span style="color: #ffffff; font-weight: bold;">${sensibilidadRx.toFixed(1)} dBm</span>
              </div>
            </div>
          </div>
          
          <!-- P√©rdidas y Atenuaciones -->
          <div style="background: rgba(245, 158, 11, 0.05); border-radius: 8px; padding: 15px; border: 1px solid rgba(245, 158, 11, 0.2);">
            <h3 style="color: #f59e0b; margin: 0 0 15px 0; font-size: 18px; border-bottom: 1px solid rgba(245, 158, 11, 0.3); padding-bottom: 8px;">
              üìâ P√©rdidas y Atenuaciones
            </h3>
            <div style="display: grid; gap: 8px; font-size: 14px;">
              <div style="display: flex; justify-content: space-between;">
                <span style="color: #cbd5e1;">üìâ P√©rdida Espacio Libre:</span>
                <span style="color: #ffffff; font-weight: bold;">${perdidaEspacioLibre.toFixed(1)} dB</span>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span style="color: #cbd5e1;">üåßÔ∏è P√©rdida por Lluvia:</span>
                <span style="color: #ffffff; font-weight: bold;">${perdidaLluvia.toFixed(2)} dB</span>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span style="color: #cbd5e1;">üå¨Ô∏è Atenuaci√≥n Ox√≠geno:</span>
                <span style="color: #ffffff; font-weight: bold;">${atenuacionOxigeno.toFixed(3)} dB</span>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span style="color: #cbd5e1;">üíß Atenuaci√≥n Vapor:</span>
                <span style="color: #ffffff; font-weight: bold;">${atenuacionVapor.toFixed(3)} dB</span>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span style="color: #cbd5e1;">üìâ P√©rdida Total:</span>
                <span style="color: #ffffff; font-weight: bold;">${perdidaTotal.toFixed(1)} dB</span>
              </div>
            </div>
          </div>
          
          <!-- Calidad del Enlace -->
          <div style="background: rgba(139, 92, 246, 0.05); border-radius: 8px; padding: 15px; border: 1px solid rgba(139, 92, 246, 0.2);">
            <h3 style="color: #8b5cf6; margin: 0 0 15px 0; font-size: 18px; border-bottom: 1px solid rgba(139, 92, 246, 0.3); padding-bottom: 8px;">
              üìä Calidad del Enlace
            </h3>
            <div style="display: grid; gap: 8px; font-size: 14px;">
              <div style="display: flex; justify-content: space-between;">
                <span style="color: #cbd5e1;">üì° Nivel de Se√±al:</span>
                <span style="color: #ffffff; font-weight: bold;">${nivelSe√±al.toFixed(1)} dBm</span>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span style="color: #cbd5e1;">üìä Margen de Enlace:</span>
                <span style="color: ${margenEnlace > 10 ? '#22c55e' : margenEnlace > 5 ? '#f59e0b' : '#ef4444'}; font-weight: bold;">${margenEnlace.toFixed(1)} dB</span>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span style="color: #cbd5e1;">üìà SNR:</span>
                <span style="color: #ffffff; font-weight: bold;">${SNR.toFixed(1)} dB</span>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span style="color: #cbd5e1;">‚è±Ô∏è Disponibilidad:</span>
                <span style="color: #ffffff; font-weight: bold;">${disponibilidadCalculada.toFixed(2)}%</span>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span style="color: #cbd5e1;">üìâ Margen Desvanecimiento:</span>
                <span style="color: #ffffff; font-weight: bold;">${margenDesvanecimiento.toFixed(1)} dB</span>
              </div>
            </div>
          </div>
          
          <!-- An√°lisis de Fresnel -->
          <div style="background: rgba(236, 72, 153, 0.05); border-radius: 8px; padding: 15px; border: 1px solid rgba(236, 72, 153, 0.2);">
            <h3 style="color: #ec4899; margin: 0 0 15px 0; font-size: 18px; border-bottom: 1px solid rgba(236, 72, 153, 0.3); padding-bottom: 8px;">
              üü¢ An√°lisis de Fresnel
            </h3>
            <div style="display: grid; gap: 8px; font-size: 14px;">
              <div style="display: flex; justify-content: space-between;">
                <span style="color: #cbd5e1;">üìè Clearance Promedio:</span>
                <span style="color: #ffffff; font-weight: bold;">${clearancePromedio.toFixed(1)} m</span>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span style="color: #cbd5e1;">üìè Clearance M√≠nimo:</span>
                <span style="color: ${clearanceMinimo > 0 ? '#22c55e' : '#ef4444'}; font-weight: bold;">${clearanceMinimo.toFixed(1)} m</span>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span style="color: #cbd5e1;">üìè Clearance M√°ximo:</span>
                <span style="color: #ffffff; font-weight: bold;">${clearanceMaximo.toFixed(1)} m</span>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span style="color: #cbd5e1;">‚ö†Ô∏è Puntos Cr√≠ticos:</span>
                <span style="color: #ffffff; font-weight: bold;">${puntosCriticos.length}</span>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span style="color: #cbd5e1;">üö´ Obstrucciones:</span>
                <span style="color: ${obstrucciones.length === 0 ? '#22c55e' : '#ef4444'}; font-weight: bold;">${obstrucciones.length}</span>
              </div>
            </div>
          </div>
          
          <!-- Recomendaciones -->
          <div style="background: rgba(16, 185, 129, 0.05); border-radius: 8px; padding: 15px; border: 1px solid rgba(16, 185, 129, 0.2);">
            <h3 style="color: #10b981; margin: 0 0 15px 0; font-size: 18px; border-bottom: 1px solid rgba(16, 185, 129, 0.3); padding-bottom: 8px;">
              üí° Recomendaciones
            </h3>
            <div style="font-size: 14px; line-height: 1.6;">
              ${margenEnlace > 15 ? 
                '<span style="color: #22c55e;">‚úÖ Enlace excelente. Margen de seguridad alto.</span>' :
                margenEnlace > 10 ? 
                '<span style="color: #22c55e;">‚úÖ Enlace bueno. Margen adecuado.</span>' :
                margenEnlace > 5 ? 
                '<span style="color: #f59e0b;">‚ö†Ô∏è Enlace aceptable. Considerar optimizaciones.</span>' :
                '<span style="color: #ef4444;">‚ùå Enlace cr√≠tico. Requiere mejoras.</span>'
              }
              <br><br>
              ${obstrucciones.length === 0 ? 
                '<span style="color: #22c55e;">‚úÖ Sin obstrucciones detectadas.</span>' :
                `<span style="color: #ef4444;">‚ùå ${obstrucciones.length} obstrucci√≥n(es) detectada(s).</span>`
              }
              <br><br>
              ${clearanceMinimo > 0 ? 
                '<span style="color: #22c55e;">‚úÖ Zona de Fresnel libre de obst√°culos.</span>' :
                '<span style="color: #ef4444;">‚ùå Zona de Fresnel obstruida.</span>'
              }
            </div>
          </div>
        </div>
      </div>
    `;
    
    document.body.appendChild(panel);
  }
  
  // Funci√≥n para mostrar/ocultar el panel (GLOBAL)
  window.togglePanelDatosTecnicos = function() {
    console.log('üîß Verificando panel de datos t√©cnicos...');
    
    let panel = document.getElementById('panel-datos-tecnicos-avanzados');
    
    // Si el panel no existe, crearlo
    if (!panel) {
      console.log('üî® Creando panel de datos t√©cnicos...');
      panel = document.createElement('div');
      panel.id = 'panel-datos-tecnicos-avanzados';
      panel.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 90%;
        max-width: 800px;
        max-height: 80vh;
        background: rgba(15,23,42,0.95);
        border: 2px solid rgba(59,130,246,0.3);
        border-radius: 20px;
        padding: 30px;
        z-index: 99999;
        overflow-y: auto;
        backdrop-filter: blur(20px);
        box-shadow: 0 20px 60px rgba(0,0,0,0.8);
      `;
      
      panel.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2 style="color: #3b82f6; margin: 0; font-size: 24px;">
            <i class="fas fa-chart-line" style="margin-right: 10px;"></i>
            Datos T√©cnicos del Enlace
          </h2>
          <button onclick="togglePanelDatosTecnicos()" 
                  style="background: none; border: none; color: #ef4444; font-size: 24px; cursor: pointer;">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div style="color: #cbd5e1; line-height: 1.8;">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
              <h3 style="color: #3b82f6; margin-bottom: 15px;">üìä Informaci√≥n General</h3>
              <p><strong>Distancia:</strong> ${window.distanciaKm || 'N/A'} km</p>
              <p><strong>Frecuencia:</strong> ${window.frecuenciaGHz || 'N/A'} GHz</p>
              <p><strong>Disponibilidad:</strong> ${window.disponibilidadAnual || 'N/A'}%</p>
              <p><strong>Margen de Enlace:</strong> ${window.margenEnlaceCalculado || 'N/A'} dB</p>
            </div>
            <div>
              <h3 style="color: #3b82f6; margin-bottom: 15px;">üèóÔ∏è Informaci√≥n de Torres</h3>
              <p><strong>Altura Torre A:</strong> ${window.alturaA || 'N/A'} m</p>
              <p><strong>Altura Torre B:</strong> ${window.alturaB || 'N/A'} m</p>
              <p><strong>Nombre Torre A:</strong> ${window.nombreA || 'N/A'}</p>
              <p><strong>Nombre Torre B:</strong> ${window.nombreB || 'N/A'}</p>
            </div>
          </div>
          <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(59,130,246,0.3);">
            <h3 style="color: #3b82f6; margin-bottom: 15px;">üìà Datos T√©cnicos Avanzados</h3>
            <p><strong>P√©rdida en Espacio Libre:</strong> ${window.perdidaEspacioLibre || 'N/A'} dB</p>
            <p><strong>EIRP:</strong> ${window.EIRP || 'N/A'} dBm</p>
            <p><strong>Nivel de Se√±al:</strong> ${window.nivelSe√±alCalculado || 'N/A'} dBm</p>
            <p><strong>SNR:</strong> ${window.SNR || 'N/A'} dB</p>
          </div>
        </div>
      `;
      
      document.body.appendChild(panel);
      console.log('‚úÖ Panel de datos t√©cnicos creado');
    }
    
    // Toggle visibilidad
    if (panel.style.display === 'none') {
      panel.style.display = 'block';
      console.log('‚úÖ Panel de datos t√©cnicos mostrado');
    } else {
      panel.style.display = 'none';
      console.log('‚úÖ Panel de datos t√©cnicos oculto');
    }
  }
  
  // Funci√≥n para el bot√≥n existente (GLOBAL)
  window.toggleDatosTecnicosAvanzados = function() {
    console.log('üìä Abriendo datos t√©cnicos...');
    
    try {
      // Verificar si la funci√≥n togglePanelDatosTecnicos existe
      if (typeof window.togglePanelDatosTecnicos === 'function') {
        window.togglePanelDatosTecnicos();
      } else {
        console.log('‚ö†Ô∏è Funci√≥n togglePanelDatosTecnicos no est√° definida, usando fallback');
        // Crear un panel b√°sico si no existe la funci√≥n
        if (typeof window.mostrarPanelDatosTecnicosBasico === 'function') {
          window.mostrarPanelDatosTecnicosBasico();
        } else {
          // Fallback m√°s simple
          mostrarNotificacion('üìä Datos T√©cnicos', 'info');
          console.log('üìä Datos t√©cnicos del enlace actual:');
          console.log('- Distancia:', window.distanciaKm || 'N/A', 'km');
          console.log('- Frecuencia:', window.frecuenciaGHz || 'N/A', 'GHz');
          console.log('- Altura Torre A:', window.alturaA || 'N/A', 'm');
          console.log('- Altura Torre B:', window.alturaB || 'N/A', 'm');
        }
      }
      
      // Ocultar el indicador de pulso despu√©s del primer clic
      const indicador = document.getElementById('indicador-datos-tecnicos');
      if (indicador) {
        indicador.style.display = 'none';
      }
      
      // Ocultar el bot√≥n inferior despu√©s del primer clic
      const btnInferior = document.getElementById('btn-datos-tecnicos-inferior');
      if (btnInferior) {
        btnInferior.style.display = 'none';
      }
      
      console.log('‚úÖ Datos t√©cnicos abiertos correctamente');
      
    } catch (error) {
      console.error('‚ùå Error al abrir datos t√©cnicos:', error);
      mostrarNotificacion('Error al abrir datos t√©cnicos', 'error');
    }
  }
  
  // Funci√≥n para actualizar datos del panel (GLOBAL)
  window.actualizarDatosPanel = function() {
    const panel = document.getElementById('panel-datos-tecnicos-avanzados');
    if (panel) {
      // Actualizar el contenido del panel con los datos m√°s recientes
      const contenido = panel.querySelector('div[style*="color: #cbd5e1"]');
      if (contenido) {
        contenido.innerHTML = `
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
              <h3 style="color: #3b82f6; margin-bottom: 15px;">üìä Informaci√≥n General</h3>
              <p><strong>Distancia:</strong> ${window.distanciaKm || 'N/A'} km</p>
              <p><strong>Frecuencia:</strong> ${window.frecuenciaGHz || 'N/A'} GHz</p>
              <p><strong>Disponibilidad:</strong> ${window.disponibilidadAnual || 'N/A'}%</p>
              <p><strong>Margen de Enlace:</strong> ${window.margenEnlaceCalculado || 'N/A'} dB</p>
            </div>
            <div>
              <h3 style="color: #3b82f6; margin-bottom: 15px;">üèóÔ∏è Informaci√≥n de Torres</h3>
              <p><strong>Altura Torre A:</strong> ${window.alturaA || 'N/A'} m</p>
              <p><strong>Altura Torre B:</strong> ${window.alturaB || 'N/A'} m</p>
              <p><strong>Nombre Torre A:</strong> ${window.nombreA || 'N/A'}</p>
              <p><strong>Nombre Torre B:</strong> ${window.nombreB || 'N/A'}</p>
            </div>
          </div>
          <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(59,130,246,0.3);">
            <h3 style="color: #3b82f6; margin-bottom: 15px;">üìà Datos T√©cnicos Avanzados</h3>
            <p><strong>P√©rdida en Espacio Libre:</strong> ${window.perdidaEspacioLibre || 'N/A'} dB</p>
            <p><strong>EIRP:</strong> ${window.EIRP || 'N/A'} dBm</p>
            <p><strong>Nivel de Se√±al:</strong> ${window.nivelSe√±alCalculado || 'N/A'} dBm</p>
            <p><strong>SNR:</strong> ${window.SNR || 'N/A'} dB</p>
          </div>
        `;
        console.log('‚úÖ Datos del panel actualizados');
      }
    }
  }
  
  // Funci√≥n de respaldo para mostrar panel b√°sico (GLOBAL)
  window.mostrarPanelDatosTecnicosBasico = function() {
    console.log('üîß Mostrando panel b√°sico de datos t√©cnicos...');
    
    // Crear un modal b√°sico con datos t√©cnicos
    const modal = document.createElement('div');
    modal.id = 'modal-datos-tecnicos-basico';
    modal.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 99999;
      backdrop-filter: blur(10px);
    `;
    
    modal.innerHTML = `
      <div style="background: rgba(15,23,42,0.95); border: 2px solid rgba(59,130,246,0.3); 
           border-radius: 20px; padding: 30px; max-width: 800px; width: 90%; 
           max-height: 80vh; overflow-y: auto; backdrop-filter: blur(20px);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2 style="color: #3b82f6; margin: 0; font-size: 24px;">
            <i class="fas fa-chart-line" style="margin-right: 10px;"></i>
            Datos T√©cnicos del Enlace
          </h2>
          <button onclick="this.closest('#modal-datos-tecnicos-basico').remove()" 
                  style="background: none; border: none; color: #ef4444; font-size: 24px; cursor: pointer;">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div style="color: #cbd5e1; line-height: 1.6;">
          <p><strong>Distancia:</strong> ${window.distanciaKm || 'N/A'} km</p>
          <p><strong>Frecuencia:</strong> ${window.frecuenciaGHz || 'N/A'} GHz</p>
          <p><strong>Altura Torre A:</strong> ${window.alturaA || 'N/A'} m</p>
          <p><strong>Altura Torre B:</strong> ${window.alturaB || 'N/A'} m</p>
          <p><strong>Disponibilidad:</strong> ${window.disponibilidadAnual || 'N/A'}%</p>
          <p><strong>Margen de Enlace:</strong> ${window.margenEnlaceCalculado || 'N/A'} dB</p>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    // Auto-remover al hacer clic fuera del modal
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        modal.remove();
      }
    });
  }
  
  // Funci√≥n para reintentar carga de elevaci√≥n
  function reintentarCargaElevacion() {
    // Mostrar indicador de carga
    const plotContainer = document.getElementById('perfilElevacionPlotly');
    if (plotContainer) {
      plotContainer.innerHTML = '<div style="display: flex; justify-content: center; align-items: center; height: 400px; color: #3b82f6; font-size: 16px;"><div>üîÑ Reintentando carga de datos de elevaci√≥n...</div></div>';
    }
    
    // Obtener los datos del √∫ltimo enlace analizado
    const datos = window.ultimoDatosPanelDetalle || {};
    if (datos && Object.keys(datos).length > 0) {
      // Reintentar la funci√≥n de perfil de elevaci√≥n
      setTimeout(() => {
        mostrarPerfilElevacionDesdeDatos(datos);
      }, 1000);
    } else {
      mostrarNotificacion('No hay datos disponibles para reintentar', 'warning');
    }
  }
  
  // Funci√≥n para asegurar que los botones de datos t√©cnicos est√©n siempre visibles
  function asegurarBotonesDatosTecnicos() {
    // Verificar si los botones existen, si no, crearlos
    let btnSuperior = document.getElementById('btn-datos-tecnicos');
    let btnInferior = document.getElementById('btn-datos-tecnicos-inferior');
    let indicador = document.getElementById('indicador-datos-tecnicos');
    
    // Si no existe el bot√≥n superior, crearlo
    if (!btnSuperior) {
      const contenedor = document.querySelector('#perfilElevacionPlotly').parentElement;
      const divSuperior = document.createElement('div');
      divSuperior.style.cssText = 'position: absolute; top: 20px; right: 20px; z-index: 1000;';
      
      btnSuperior = document.createElement('button');
      btnSuperior.id = 'btn-datos-tecnicos';
      btnSuperior.onclick = toggleDatosTecnicosAvanzados;
      btnSuperior.style.cssText = 'padding: 12px 16px; font-size: 13px; border-radius: 8px; background: rgba(59, 130, 246, 0.9); border: 1px solid rgba(59, 130, 246, 0.5); color: white; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px;';
      btnSuperior.innerHTML = '<i class="fas fa-chart-line" style="font-size: 14px;"></i>üìä Datos T√©cnicos';
      
      divSuperior.appendChild(btnSuperior);
      contenedor.appendChild(divSuperior);
    }
    
    // Si no existe el bot√≥n inferior, crearlo
    if (!btnInferior) {
      const contenedor = document.querySelector('#perfilElevacionPlotly').parentElement;
      const divInferior = document.createElement('div');
      divInferior.style.cssText = 'position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 1000;';
      
      btnInferior = document.createElement('button');
      btnInferior.id = 'btn-datos-tecnicos-inferior';
      btnInferior.onclick = toggleDatosTecnicosAvanzados;
      btnInferior.style.cssText = 'padding: 10px 20px; font-size: 12px; border-radius: 6px; background: rgba(16, 185, 129, 0.9); border: 1px solid rgba(16, 185, 129, 0.5); color: white; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 6px;';
      btnInferior.innerHTML = '<i class="fas fa-calculator" style="font-size: 12px;"></i>üìä Ver Datos T√©cnicos';
      
      divInferior.appendChild(btnInferior);
      contenedor.appendChild(divInferior);
    }
    
    // Asegurar que los botones est√©n visibles
    if (btnSuperior) btnSuperior.style.display = 'flex';
    if (btnInferior) btnInferior.style.display = 'flex';
  }
  
  // --- Fin bloque extra√≠do ---

  const locations = [];
  for (let i = 0; i < numPuntos; i++) {
    const lat = latA + (latB - latA) * (i / (numPuntos - 1));
    const lon = lonA + (lonB - lonA) * (i / (numPuntos - 1));
    locations.push(`${lat},${lon}`);
  }
  const locationsStr = locations.join('|');
  
  // Intentar m√∫ltiples APIs de elevaci√≥n
  const apis = [
    {
      name: 'Open-Elevation',
      url: `https://api.open-elevation.com/api/v1/lookup?locations=${locationsStr}`,
      timeout: 8000
    },
    {
      name: 'OpenTopoData',
      url: `https://api.opentopodata.org/v1/aster30m?locations=${locationsStr}`,
      timeout: 8000
    }
  ];
  
  let elevaciones = null;
  let lastError = null;
  
  for (const api of apis) {
    try {
      console.log(`Intentando API: ${api.name}`);
      
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), api.timeout);
      
      const resp = await fetch(api.url, { 
        signal: controller.signal,
        headers: {
          'Accept': 'application/json',
          'User-Agent': 'PTP-Fangio/1.0'
        }
      });
      
      clearTimeout(timeoutId);
      
      if (!resp.ok) {
        throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
      }
      
      const data = await resp.json();
      
      if (api.name === 'Open-Elevation' && data.results && data.results.length) {
        elevaciones = data.results.map(r => r.elevation);
        console.log(`‚úÖ API ${api.name} exitosa`);
        break;
      } else if (api.name === 'OpenTopoData' && data.results && data.results.length) {
        elevaciones = data.results.map(r => r.elevation);
        console.log(`‚úÖ API ${api.name} exitosa`);
        break;
      } else {
        throw new Error('Datos de elevaci√≥n no v√°lidos');
      }
      
    } catch (error) {
      clearTimeout(timeoutId);
      console.warn(`‚ùå Error en API ${api.name}:`, error);
      lastError = error;
      continue;
    }
  }
  
      if (elevaciones) {
      window.usandoDatosSinteticos = false;
      renderizarPerfilElevacion(elevaciones);
    } else {
    console.error('Todas las APIs fallaron:', lastError);
    
    // Generar datos de elevaci√≥n sint√©ticos mejorados
    const elevaciones = [];
    const baseElevation = 1500; // Elevaci√≥n base m√°s realista
    
    for (let i = 0; i < numPuntos; i++) {
      const t = i / (numPuntos - 1);
      
      // Crear un perfil m√°s realista con m√∫ltiples variaciones
      const variation1 = Math.sin(t * Math.PI * 2) * 200; // Variaci√≥n principal
      const variation2 = Math.sin(t * Math.PI * 4) * 50;  // Variaci√≥n secundaria
      const variation3 = Math.cos(t * Math.PI * 1.5) * 30; // Variaci√≥n terciaria
      
      // Agregar ruido aleatorio sutil
      const noise = (Math.random() - 0.5) * 20;
      
      const elevation = baseElevation + variation1 + variation2 + variation3 + noise;
      elevaciones.push(Math.max(0, elevation)); // Asegurar que no sea negativo
    }
    
    const errorMessage = '‚ö†Ô∏è APIs de elevaci√≥n no disponibles. Usando perfil sint√©tico optimizado.';
    
    // Mostrar notificaci√≥n m√°s sutil para errores de API
    const notificacion = document.createElement('div');
    notificacion.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(245, 158, 11, 0.9);
      color: white;
      padding: 10px 14px;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      z-index: 10000;
      font-size: 12px;
      font-weight: 500;
      max-width: 300px;
      transform: translateX(100%);
      transition: transform 0.2s ease;
      border: 1px solid rgba(245, 158, 11, 0.3);
    `;
    
    notificacion.innerHTML = `
      <div style="display: flex; align-items: center; gap: 8px;">
        <i class="fas fa-exclamation-triangle" style="font-size: 14px; color: #fbbf24;"></i>
        <span>${errorMessage}</span>
        <button onclick="reintentarCargaElevacion()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 4px 8px; border-radius: 6px; font-size: 11px; cursor: pointer; margin-left: 8px; transition: all 0.2s ease;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
          üîÑ Reintentar
        </button>
      </div>
    `;
    
    document.body.appendChild(notificacion);
    
    // Animar entrada
    setTimeout(() => {
      notificacion.style.transform = 'translateX(0)';
    }, 100);
    
        // Auto-remover despu√©s de 3 segundos
    setTimeout(() => {
      notificacion.style.transform = 'translateX(100%)';
      setTimeout(() => {
        if (notificacion.parentNode) {
          notificacion.parentNode.removeChild(notificacion);
        }
      }, 200);
    }, 3000);
    
    window.usandoDatosSinteticos = true;
    renderizarPerfilElevacion(elevaciones);
  }
}

if (document.getElementById('tab-resumen').classList.contains('active')) {
  mostrarMapaEnlaces(null);
}
function abrirPerfilElevacionEnNuevaVentana(datos) {
  const params = encodeURIComponent(JSON.stringify(datos));
  window.open(`perfil_elevacion.html?datos=${params}`, '_blank');
}
function actualizarBotonPerfilElevacionGlobal() {
  const fila = document.querySelector('#tabla tbody tr.selected');
  const btn = document.getElementById('btnPerfilElevacionGlobal');
  btn.style.display = fila ? 'inline-block' : 'none';
}
function guardarEnlacesEnStorageModo(modo) {
  if (modo === "mismo") {
    return;
  }
  const tabla = document.querySelector('#tabla tbody');
  const filas = tabla.querySelectorAll('tr');
  const enlaces = [];
  filas.forEach(fila => {
    const celdas = fila.querySelectorAll('td');
    const enlace = [];
    for (let i = 1; i < celdas.length; i++) {
      if (i === 33 && celdas[i].querySelector('button') && celdas[i].dataset.analisis) {
        enlace.push(celdas[i].dataset.analisis);
      } else {
        enlace.push(celdas[i].textContent);
      }
    }
    enlaces.push(enlace);
  });
  localStorage.setItem('enlacesPtP', JSON.stringify(enlaces));
}
function cargarEnlacesDeStorageModo(modo) {
  console.log('üîÑ Cargando enlaces de storage modo:', modo);
  
  if (modo === "mismo") {
    mostrarTablaMismoTransporte();
    return;
  }
  
  try {
    const key = 'enlacesPtP';
    const enlacesGuardados = localStorage.getItem(key);
    console.log('üìÅ Enlaces guardados encontrados:', enlacesGuardados ? 'S√ç' : 'NO');
    if (!enlacesGuardados) {
      console.log('‚ùå No hay enlaces guardados en localStorage');
      return;
    }
    
    const enlaces = JSON.parse(enlacesGuardados);
    const tbody = document.querySelector('#tabla tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    enlaces.forEach((enlaceData, index) => {
      console.log(`üìä Enlace ${index + 1}:`, enlaceData);
      const fila = document.createElement('tr');
      
      // Checkbox
      const tdCheck = document.createElement('td');
      const check = document.createElement('input');
      check.type = 'checkbox';
      check.className = 'check-enlace';
      check.onclick = function(e) {
        e.stopPropagation();
        actualizarBotonEliminarSeleccionados();
      };
      tdCheck.appendChild(check);
      fila.appendChild(tdCheck);
      
      // MOSTRAR TODOS LOS DATOS COMO EN ptpFangio12.html (FUNCI√ìN ORIGINAL)
      enlaceData.forEach((val, i) => {
        const td = document.createElement('td');
        
        // Para la √∫ltima columna (an√°lisis JSON) crear bot√≥n
        if (i === enlaceData.length - 1) {
          const btn = document.createElement('button');
          btn.className = 'btn btn-primary btn-sm';
          btn.style.cssText = `
            background: linear-gradient(135deg, #3b82f615, #3b82f625);
            border: 2px solid #3b82f640;
            color: #3b82f6;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
            font-weight: 600;
            box-shadow: 0 2px 4px #3b82f620;
          `;
          btn.innerHTML = '<i class="fas fa-info-circle"></i> INFO DETALLADA';
          btn.title = 'Ver an√°lisis detallado del enlace';
          
          // Efecto hover
          btn.onmouseenter = function() {
            this.style.transform = 'translateY(-1px)';
            this.style.boxShadow = '0 4px 8px #3b82f640';
            this.style.background = 'linear-gradient(135deg, #2563eb25, #2563eb35)';
          };
          
          btn.onmouseleave = function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = '0 2px 4px #3b82f620';
            this.style.background = 'linear-gradient(135deg, #3b82f615, #3b82f625)';
          };
          
          btn.onclick = function(e) {
            e.stopPropagation();
            try {
              const analisis = JSON.parse(val);
              mostrarAnalisisDetallado(analisis);
            } catch {
              alert('No hay an√°lisis detallado disponible.');
            }
          };
          td.appendChild(btn);
          td.dataset.analisis = val;
        } else {
          td.textContent = val;
        }
        fila.appendChild(td);
      });
      
      tbody.appendChild(fila);
    });
    
    console.log(`‚úÖ Carga completada: ${enlaces.length} enlaces agregados a la tabla`);
    
    actualizarContadorEnlaces();
    verificarEnlacesVacios();
    
    console.log('‚úÖ Enlaces modo cargados correctamente');
  } catch (error) {
    console.log('‚ö†Ô∏è Error al cargar enlaces modo:', error.message);
  }
}

// FUNCI√ìN PARA MOSTRAR INFORMACI√ìN COMPLETA DEL ENLACE
function mostrarInformacionCompletaEnlace(enlaceData, analisis) {
  console.log('üìã Mostrando informaci√≥n completa del enlace:', enlaceData);
  console.log('üîç Debug - Contenido de enlaceData:');
  enlaceData.forEach((valor, index) => {
    console.log(`  √çndice ${index}: "${valor}"`);
  });
  
  // Crear contenido HTML detallado
  let contenidoHTML = `
    <div style="max-width: 800px; max-height: 80vh; overflow-y: auto; padding: 20px;">
      <h3 style="color: #3b82f6; margin-bottom: 20px; border-bottom: 2px solid #3b82f6; padding-bottom: 10px;">
        <i class="fas fa-link"></i> Informaci√≥n Completa del Enlace
      </h3>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        
        <!-- COLUMNA IZQUIERDA - DATOS B√ÅSICOS -->
        <div style="background: rgba(59, 130, 246, 0.05); padding: 15px; border-radius: 10px; border-left: 4px solid #3b82f6;">
          <h4 style="color: #1e40af; margin-bottom: 15px;">
            <i class="fas fa-database"></i> Datos B√°sicos
          </h4>
          
          <div style="margin-bottom: 10px;">
            <strong>ID A:</strong> ${enlaceData[0] || 'N/A'}
          </div>
          <div style="margin-bottom: 10px;">
            <strong>Nombre A:</strong> ${enlaceData[1] || 'N/A'}
          </div>
          <div style="margin-bottom: 10px;">
            <strong>Coordenadas A:</strong> ${enlaceData[2] || 'N/A'}, ${enlaceData[3] || 'N/A'}
          </div>
          <div style="margin-bottom: 10px;">
            <strong>Altura A:</strong> ${obtenerAlturaPrueba(enlaceData, 'Torre A') || 'N/A'} m
          </div>
          <div style="margin-bottom: 10px;">
            <strong>Estado A:</strong> ${enlaceData[27] || 'N/A'}
          </div>
          
          <hr style="margin: 15px 0; border-color: #3b82f6;">
          
          <div style="margin-bottom: 10px;">
            <strong>ID B:</strong> ${enlaceData[6] || 'N/A'}
          </div>
          <div style="margin-bottom: 10px;">
            <strong>Nombre B:</strong> ${enlaceData[7] || 'N/A'}
          </div>
          <div style="margin-bottom: 10px;">
            <strong>Coordenadas B:</strong> ${enlaceData[8] || 'N/A'}, ${enlaceData[9] || 'N/A'}
          </div>
          <div style="margin-bottom: 10px;">
            <strong>Altura B:</strong> ${obtenerAlturaPrueba(enlaceData, 'Torre B') || 'N/A'} m
          </div>
          <div style="margin-bottom: 10px;">
            <strong>Estado B:</strong> ${enlaceData[28] || 'N/A'}
          </div>
        </div>
        
        <!-- COLUMNA DERECHA - PAR√ÅMETROS T√âCNICOS -->
        <div style="background: rgba(16, 185, 129, 0.05); padding: 15px; border-radius: 10px; border-left: 4px solid #10b981;">
          <h4 style="color: #059669; margin-bottom: 15px;">
            <i class="fas fa-cogs"></i> Par√°metros T√©cnicos
          </h4>
          
          <div style="margin-bottom: 10px;">
            <strong>Distancia:</strong> ${enlaceData[12] || 'N/A'} km
          </div>
          <div style="margin-bottom: 10px;">
            <strong>Frecuencia:</strong> ${enlaceData[13] || 'N/A'} GHz
          </div>
          <div style="margin-bottom: 10px;">
            <strong>Disponibilidad:</strong> ${enlaceData[14] || 'N/A'}%
          </div>
          <div style="margin-bottom: 10px;">
            <strong>Di√°metro Antena:</strong> ${enlaceData[30] || 'N/A'}
          </div>
          <div style="margin-bottom: 10px;">
            <strong>Tipo Enlace:</strong> ${enlaceData[31] || 'N/A'}
          </div>
          <div style="margin-bottom: 10px;">
            <strong>Factibilidad:</strong> 
            <span style="color: ${enlaceData[29] && enlaceData[29].includes('FACTIBLE') ? '#10b981' : '#ef4444'}; font-weight: bold;">
              ${enlaceData[29] || 'N/A'}
            </span>
          </div>
        </div>
      </div>
      
      <!-- SECCI√ìN DE INFORMACI√ìN DETALLADA -->
      <div style="margin-top: 20px; background: rgba(139, 92, 246, 0.05); padding: 15px; border-radius: 10px; border-left: 4px solid #8b5cf6;">
        <h4 style="color: #7c3aed; margin-bottom: 15px;">
          <i class="fas fa-list-alt"></i> Informaci√≥n Detallada del Enlace
        </h4>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <!-- Torre A -->
          <div style="background: rgba(59, 130, 246, 0.1); padding: 12px; border-radius: 8px;">
            <h5 style="color: #1e40af; margin-bottom: 10px; font-size: 14px;">
              <i class="fas fa-broadcast-tower"></i> Torre A
            </h5>
            <div style="font-size: 12px; line-height: 1.5;">
              <div><strong>Tipo:</strong> ${enlaceData[25] || 'N/A'}</div>
              <div><strong>Estado:</strong> ${enlaceData[27] || 'N/A'}</div>
              <div><strong>Altura:</strong> ${obtenerAlturaPrueba(enlaceData, 'Torre A') || 'N/A'} m</div>
              <div><strong>RAN:</strong> ${enlaceData[17] || 'N/A'}</div>
              <div><strong>Transporte:</strong> ${enlaceData[19] || 'N/A'}</div>
              <div><strong>Arrendamiento:</strong> ${enlaceData[21] || 'N/A'}</div>
              <div><strong>ON:</strong> ${enlaceData[23] || 'N/A'}</div>
            </div>
          </div>
          
          <!-- Torre B -->
          <div style="background: rgba(16, 185, 129, 0.1); padding: 12px; border-radius: 8px;">
            <h5 style="color: #059669; margin-bottom: 10px; font-size: 14px;">
              <i class="fas fa-broadcast-tower"></i> Torre B
            </h5>
            <div style="font-size: 12px; line-height: 1.5;">
              <div><strong>Tipo:</strong> ${enlaceData[26] || 'N/A'}</div>
              <div><strong>Estado:</strong> ${enlaceData[28] || 'N/A'}</div>
              <div><strong>Altura:</strong> ${obtenerAlturaPrueba(enlaceData, 'Torre B') || 'N/A'} m</div>
              <div><strong>RAN:</strong> ${enlaceData[18] || 'N/A'}</div>
              <div><strong>Transporte:</strong> ${enlaceData[20] || 'N/A'}</div>
              <div><strong>Arrendamiento:</strong> ${enlaceData[22] || 'N/A'}</div>
              <div><strong>ON:</strong> ${enlaceData[24] || 'N/A'}</div>
            </div>
          </div>
        </div>
        
        <!-- Informaci√≥n del Enlace -->
        <div style="margin-top: 15px; background: rgba(245, 158, 11, 0.1); padding: 12px; border-radius: 8px;">
          <h5 style="color: #d97706; margin-bottom: 10px; font-size: 14px;">
            <i class="fas fa-link"></i> Configuraci√≥n del Enlace
          </h5>
          <div style="font-size: 12px; line-height: 1.5;">
            <div><strong>Di√°metro Antena:</strong> ${enlaceData[30] || 'N/A'}</div>
            <div><strong>Tipo Enlace:</strong> ${enlaceData[31] || 'N/A'}</div>
            <div><strong>Disponibilidad:</strong> ${enlaceData[14] || 'N/A'}%</div>
            <div><strong>Factibilidad:</strong> 
              <span style="color: ${enlaceData[29] && enlaceData[29].includes('FACTIBLE') ? '#10b981' : '#ef4444'}; font-weight: bold;">
                ${enlaceData[29] || 'N/A'}
              </span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- SECCI√ìN DE AN√ÅLISIS DETALLADO -->
      ${analisis ? `
        <div style="margin-top: 20px; background: rgba(245, 158, 11, 0.05); padding: 15px; border-radius: 10px; border-left: 4px solid #f59e0b;">
          <h4 style="color: #d97706; margin-bottom: 15px;">
            <i class="fas fa-chart-line"></i> An√°lisis T√©cnico Detallado
          </h4>
          <div style="white-space: pre-wrap; font-family: monospace; font-size: 11px; line-height: 1.4; max-height: 300px; overflow-y: auto; background: rgba(0,0,0,0.05); padding: 10px; border-radius: 5px;">
            ${JSON.stringify(analisis, null, 2)}
          </div>
        </div>
      ` : `
        <div style="margin-top: 20px; background: rgba(156, 163, 175, 0.1); padding: 15px; border-radius: 10px; text-align: center; color: #6b7280;">
          <i class="fas fa-info-circle"></i> No hay an√°lisis t√©cnico detallado disponible
        </div>
      `}
      
      <!-- BOTONES DE ACCI√ìN -->
      <div style="margin-top: 20px; text-align: center; padding-top: 15px; border-top: 1px solid #e5e7eb;">
        <button onclick="cerrarModalInformacion()" style="
          background: #6b7280;
          color: white;
          border: none;
          padding: 10px 20px;
          border-radius: 8px;
          cursor: pointer;
          margin-right: 10px;
          font-weight: 600;
        ">
          <i class="fas fa-times"></i> Cerrar
        </button>
        <button onclick="exportarInformacionEnlace(${JSON.stringify(enlaceData).replace(/"/g, '&quot;')})" style="
          background: #10b981;
          color: white;
          border: none;
          padding: 10px 20px;
          border-radius: 8px;
          cursor: pointer;
          font-weight: 600;
        ">
          <i class="fas fa-download"></i> Exportar
        </button>
      </div>
    </div>
  `;
  
  // Mostrar en modal usando SweetAlert2 o fallback
  if (typeof Swal !== 'undefined') {
    Swal.fire({
      title: 'Informaci√≥n del Enlace',
      html: contenidoHTML,
      width: '90%',
      showConfirmButton: false,
      showCloseButton: true,
      customClass: {
        container: 'modal-informacion-enlace'
      }
    });
  } else {
    // Fallback para cuando SweetAlert2 no est√° disponible
    const modal = document.createElement('div');
    modal.id = 'modal-informacion-enlace';
    modal.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    `;
    modal.innerHTML = `
      <div style="
        background: white;
        border-radius: 15px;
        max-width: 90vw;
        max-height: 90vh;
        overflow: auto;
        position: relative;
      ">
        <button onclick="cerrarModalInformacion()" style="
          position: absolute;
          top: 10px;
          right: 15px;
          background: none;
          border: none;
          font-size: 24px;
          cursor: pointer;
          color: #666;
        ">√ó</button>
        ${contenidoHTML}
      </div>
    `;
    document.body.appendChild(modal);
  }
}

// FUNCI√ìN PARA CERRAR EL MODAL DE INFORMACI√ìN
function cerrarModalInformacion() {
  if (typeof Swal !== 'undefined') {
    Swal.close();
  } else {
    const modal = document.getElementById('modal-informacion-enlace');
    if (modal) {
      modal.remove();
    }
  }
}

// FUNCI√ìN PARA EXPORTAR INFORMACI√ìN DEL ENLACE
function exportarInformacionEnlace(enlaceData) {
  try {
    const datos = {
      fecha: new Date().toISOString(),
      enlace: enlaceData,
      formato: 'JSON'
    };
    
    const blob = new Blob([JSON.stringify(datos, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `enlace_${enlaceData[0]}_${enlaceData[6]}_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    alert('‚úÖ Informaci√≥n exportada correctamente');
  } catch (error) {
    console.error('Error al exportar:', error);
    alert('‚ùå Error al exportar la informaci√≥n');
  }
}

// FUNCI√ìN PARA FORZAR RECARGA DE LA TABLA
function forzarRecargaTabla() {
  console.log('üîÑ Forzando recarga de tabla...');
  
  // Limpiar tabla
  const tbody = document.querySelector('#tabla tbody');
  if (tbody) {
    tbody.innerHTML = '';
  }
  
  // Forzar carga desde localStorage
  cargarEnlacesDeStorageModo("normal");
  
  // Actualizar contadores
  setTimeout(() => {
    actualizarContadorEnlaces();
    verificarEnlacesVacios();
  }, 1000);
  
  alert('üîÑ Tabla recargada. Revisa la consola para detalles.');
}
</script>
<div id="modal-analisis" style="display:none; position:fixed; z-index:9999; left:0; top:0; width:100vw; height:100vh; background:rgba(30,30,40,0.7); align-items:center; justify-content:center;">
  <div style="background:#fff; border-radius:18px; max-width:420px; width:90%; margin:auto; box-shadow:0 8px 32px rgba(0,0,0,0.25); padding:32px 24px 24px 24px; position:relative; animation:fadeInUp 0.3s;">
    <button onclick="cerrarModalAnalisis()" style="position:absolute; top:12px; right:16px; background:none; border:none; font-size:1.5rem; color:#888; cursor:pointer;"><i class="fas fa-times"></i></button>
    <div id="modal-analisis-icono" style="font-size:2.5rem; margin-bottom:10px;"></div>
    <div id="modal-analisis-titulo" style="font-size:1.3rem; font-weight:700; margin-bottom:10px;"></div>
    <div id="modal-analisis-resumen" style="font-size:1rem; margin-bottom:10px; color:#444;"></div>
    <ul id="modal-analisis-lista" style="padding-left:20px; margin-bottom:0; color:#333; font-size:0.98rem;"></ul>
    
  </div>
</div>
<div id="modal-parametros-radio" style="display:none; position:fixed; z-index:9999; left:0; top:0; width:100vw; height:100vh; background:rgba(30,30,40,0.7); align-items:center; justify-content:center;">
  <div style="background:#fff; border-radius:18px; max-width:420px; width:90%; margin:auto; box-shadow:0 8px 32px rgba(0,0,0,0.25); padding:32px 24px 24px 24px; position:relative;">
    <button onclick="cerrarPanelParametrosRadio()" style="position:absolute; top:12px; right:16px; background:none; border:none; font-size:1.5rem; color:#888; cursor:pointer;"><i class="fas fa-times"></i></button>
    <h3>Par√°metros de Radioenlace</h3>
    <div>
      <label>Potencia TX (dBm): <input type="number" id="potenciaTX" value="20"></label><br>
      <label>Ganancia Antena A (dBi): <input type="number" id="gananciaA" value="30"></label><br>
      <label>Ganancia Antena B (dBi): <input type="number" id="gananciaB" value="30"></label><br>
      <label>P√©rdidas (dB): <input type="number" id="perdidas" value="2"></label><br>
      <label>Frecuencia (GHz): <input type="number" id="frecuenciaRadio" value="15"></label><br>
      <label>Distancia (km): <input type="number" id="distanciaRadio" value="10"></label><br>
      <label>Margen de desvanecimiento (dB): <input type="number" id="fadeMargin" value="30"></label><br>
      <button class="btn btn-success" onclick="calcularParametrosRadio()">Calcular</button>
    </div>
    <div id="resultado-parametros-radio" style="margin-top:12px; color:#222;"></div>
  </div>
</div>
<div id="modal-equipos-antenas" style="display:none; position:fixed; z-index:9999; left:0; top:0; width:100vw; height:100vh; background:rgba(30,30,40,0.7); align-items:center; justify-content:center;">
  <div style="background:#fff; border-radius:18px; max-width:420px; width:90%; margin:auto; box-shadow:0 8px 32px rgba(0,0,0,0.25); padding:32px 24px 24px 24px; position:relative;">
    <button onclick="cerrarPanelEquiposAntenas()" style="position:absolute; top:12px; right:16px; background:none; border:none; font-size:1.5rem; color:#888; cursor:pointer;"><i class="fas fa-times"></i></button>
    <h3>Gesti√≥n de Equipos y Antenas</h3>
    <div>
      <label>Modelo Radio: <input type="text" id="modeloRadio" value="Ej: Ubiquiti AirFiber"></label><br>
      <label>Modelo Antena: <input type="text" id="modeloAntena" value="Ej: Dish 30dBi"></label><br>
      <label>Ganancia (dBi): <input type="number" id="gananciaAntena" value="30"></label><br>
      <button class="btn btn-success" onclick="guardarEquipoAntena()">Guardar</button>
    </div>
    <div id="lista-equipos-antenas" style="margin-top:12px; color:#222;"></div>
  </div>
</div>
<script>
// Funciones para filtrar la tabla
function filterTable() {
  const searchTerm = document.getElementById('searchTable').value.toLowerCase();
  const statusFilter = document.getElementById('filterEstado').value;
  const distanceFilter = document.getElementById('filterDistancia').value;
  const table = document.getElementById('tabla');
  const rows = table.getElementsByTagName('tr');
  let visibleCount = 0;

  for (let i = 1; i < rows.length; i++) { // Empezar desde 1 para saltar el header
    const row = rows[i];
    const cells = row.getElementsByTagName('td');
    let shouldShow = true;

    // Filtro de b√∫squeda
    if (searchTerm) {
      let rowText = '';
      for (let j = 0; j < cells.length; j++) {
        rowText += cells[j].textContent + ' ';
      }
      if (!rowText.toLowerCase().includes(searchTerm)) {
        shouldShow = false;
      }
    }

    // Filtro de estado
    if (statusFilter && statusFilter !== '') {
      // Por ahora, solo verificamos si hay alg√∫n indicador de estado
      // Puedes implementar l√≥gica espec√≠fica aqu√≠
    }

    // Filtro de distancia
    if (distanceFilter && distanceFilter !== '') {
      const distanceCell = cells[13]; // Columna de distancia (ajustar seg√∫n la estructura real)
      if (distanceCell) {
        const distanceText = distanceCell.textContent;
        const distance = parseFloat(distanceText.replace(' km', ''));
        
        switch (distanceFilter) {
          case '0-5':
            if (distance > 5) shouldShow = false;
            break;
          case '5-15':
            if (distance <= 5 || distance > 15) shouldShow = false;
            break;
          case '15+':
            if (distance <= 15) shouldShow = false;
            break;
        }
      }
    }

    row.style.display = shouldShow ? '' : 'none';
    if (shouldShow) visibleCount++;
  }

  // Actualizar contador
  document.getElementById('totalEnlacesStats').textContent = visibleCount;
}

// Funci√≥n para limpiar filtros
function clearFilters() {
  document.getElementById('searchTable').value = '';
  document.getElementById('filterEstado').value = '';
  document.getElementById('filterDistancia').value = '';
  filterTable();
}

// Funci√≥n para exportar seleccionados
function exportSelected() {
  const checkboxes = document.querySelectorAll('#tabla input[type="checkbox"]:checked');
  if (checkboxes.length === 0) {
    alert('Por favor selecciona al menos un enlace para exportar');
    return;
  }
  
  let csvContent = 'ID A,NOMBRE A,LAT A,LON A,ID B,NOMBRE B,LAT B,LON B,DISTANCIA (KM),FRECUENCIA (GHZ)\n';
  
  checkboxes.forEach(checkbox => {
    const row = checkbox.closest('tr');
    const cells = row.getElementsByTagName('td');
    const rowData = [
      cells[1].textContent, // ID A
      cells[2].textContent, // NOMBRE A
      cells[3].textContent, // LAT A
      cells[4].textContent, // LON A
      cells[7].textContent, // ID B
      cells[8].textContent, // NOMBRE B
      cells[9].textContent, // LAT B
      cells[10].textContent, // LON B
      cells[13].textContent, // DISTANCIA
      cells[14].textContent  // FRECUENCIA
    ];
    csvContent += rowData.join(',') + '\n';
  });

  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  link.setAttribute('href', url);
  link.setAttribute('download', 'enlaces_seleccionados.csv');
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// Funci√≥n para seleccionar/deseleccionar todos
function toggleSelectAll() {
  const checkboxes = document.querySelectorAll('#tabla input[type="checkbox"]');
  const selectAllBtn = document.getElementById('selectAllBtn');
  const isAllSelected = Array.from(checkboxes).every(cb => cb.checked);
  
  checkboxes.forEach(checkbox => {
    checkbox.checked = !isAllSelected;
  });
  
  selectAllBtn.innerHTML = isAllSelected ? '‚úì SELECCIONAR TODOS' : '‚òê DESELECCIONAR TODOS';
}

// Funci√≥n para eliminar seleccionados
function deleteSelected() {
  const checkboxes = document.querySelectorAll('#tabla input[type="checkbox"]:checked');
  if (checkboxes.length === 0) {
    alert('Por favor selecciona al menos un enlace para eliminar');
    return;
  }
  
  if (confirm(`¬øEst√°s seguro de que quieres eliminar ${checkboxes.length} enlace(s)?`)) {
    checkboxes.forEach(checkbox => {
      checkbox.closest('tr').remove();
    });
    filterTable(); // Actualizar contador
  }
}

// SISTEMA ROBUSTO - SIN BUCLES
document.addEventListener('DOMContentLoaded', function() {
  // PROTECCI√ìN CONTRA EJECUCI√ìN M√öLTIPLE
  if (window.aplicacionIniciada) {
    return;
  }
  window.aplicacionIniciada = true;
  
  console.log('üöÄ Iniciando aplicaci√≥n ROBUSTA...');
  
  // LIMPIAR ESTADO GLOBAL
  window.procesandoPares = false;
  window.procesamientoCompletado = false;
  window.ultimoAlert = null;
  window.checkboxesProcesados = false;
  window.sistemaActivado = false;
  window.enlacesCargados = false;
  window.enlacesModoCargados = false;
  
  // LIMPIAR TIMEOUTS EXISTENTES
  for (let i = 1; i < 10000; i++) {
    clearTimeout(i);
    clearInterval(i);
  }
  
  // CONFIGURACI√ìN PRINCIPAL
  try {
    // 0. CARGAR API KEYS
    cargarAPIKeys();
    
    // 1. CONFIGURAR FILTROS
    const searchInput = document.getElementById('searchTable');
    const statusFilter = document.getElementById('filterEstado');
    const distanceFilter = document.getElementById('filterDistancia');
    
    if (searchInput) searchInput.addEventListener('input', filterTable);
    if (statusFilter) statusFilter.addEventListener('change', filterTable);
    if (distanceFilter) distanceFilter.addEventListener('change', filterTable);
    
    // 2. CARGAR DATOS
    cargarEnlacesDeStorage();
    actualizarContadorEnlaces();
    verificarEnlacesVacios();
    
    // 3. CONFIGURAR CHECKBOXES UNA SOLA VEZ
    const checkboxes = document.querySelectorAll('#tabla tbody .check-enlace');
    console.log('üìã Configurando', checkboxes.length, 'checkboxes');
    
    checkboxes.forEach((checkbox, index) => {
      // Solo configurar si no tiene listener
      if (!checkbox.hasAttribute('data-smart-listener')) {
        // Remover listeners existentes
        checkbox.removeEventListener('change', handleCheckboxChange);
        checkbox.removeEventListener('click', handleCheckboxChange);
        
        // Agregar listener simple y directo
        checkbox.addEventListener('change', function(e) {
          e.stopPropagation();
          verificarSeleccionYMostrarPerfil();
        });
        
                // NUEVO: Solo agregar estilos visuales, el doble clic se maneja globalmente
        const fila = checkbox.closest('tr');
        if (fila) {
          // Agregar cursor pointer para indicar que es clickeable
          fila.style.cursor = 'pointer';
          
          // Agregar tooltip para indicar doble clic
          fila.title = 'Doble clic para ver perfil de elevaci√≥n';
        }
        
        // Marcar como configurado
        checkbox.setAttribute('data-smart-listener', 'true');
      }
    });
    
          console.log('‚úÖ Sistema configurado correctamente');
    
    // Agregar controles de navegaci√≥n autom√°ticamente
    setTimeout(() => {
      agregarControlesNavegacionTabla();
    }, 1000);
    
    // SISTEMA MEJORADO DE DOBLE CLIC
    const tabla = document.getElementById('tabla');
    if (tabla) {
      tabla.addEventListener('dblclick', function(e) {
        const fila = e.target.closest('tr');
        if (fila && fila.parentElement.tagName === 'TBODY') {
          e.preventDefault();
          e.stopPropagation();
          console.log('üéØ DOBLE CLIC DETECTADO - SISTEMA MEJORADO');
          
          // Obtener datos del enlace
          const celdas = fila.querySelectorAll('td');
          
          // Verificar que tenemos suficientes celdas
          if (celdas.length < 10) {
            console.log('‚ùå No hay suficientes celdas en la fila');
            mostrarNotificacion('‚ùå Datos insuficientes para mostrar perfil', 'error');
            return;
          }
          
          // Funci√≥n simplificada para buscar altura
          function buscarAlturaSimple(celdas, prefijo = '') {
            console.log(`üîç Buscando altura para ${prefijo}...`);
            
            // Buscar en columnas espec√≠ficas donde suelen estar las alturas
            const columnasAltura = [15, 16, 17, 18, 19, 20];
            
            for (let col of columnasAltura) {
              if (celdas[col] && celdas[col].textContent) {
                const texto = celdas[col].textContent.trim();
                const valor = parseFloat(texto);
                
                // Validar que sea una altura razonable
                if (!isNaN(valor) && valor >= 5 && valor <= 200) {
                  // Verificar que no sea coordenada, distancia o frecuencia
                  if (!texto.toLowerCase().includes('km') && 
                      !texto.toLowerCase().includes('ghz') && 
                      !texto.includes('.') || texto.split('.').length <= 2) {
                    console.log(`‚úÖ Altura ${prefijo} encontrada en columna ${col}: ${valor}m`);
                    return valor;
                  }
                }
              }
            }
            
            console.log(`‚ö†Ô∏è No se encontr√≥ altura v√°lida para ${prefijo}, usando 30m por defecto`);
            return 30;
          }
          
          // Extraer datos b√°sicos
          const datosEnlace = {
            idA: celdas[1]?.textContent || '',
            nombreA: celdas[2]?.textContent || '',
            latA: parseFloat(celdas[3]?.textContent) || 0,
            lonA: parseFloat(celdas[4]?.textContent) || 0,
            alturaA: buscarAlturaSimple(celdas, 'Torre A'),
            idB: celdas[7]?.textContent || '',
            nombreB: celdas[8]?.textContent || '',
            latB: parseFloat(celdas[9]?.textContent) || 0,
            lonB: parseFloat(celdas[10]?.textContent) || 0,
            alturaB: buscarAlturaSimple(celdas, 'Torre B'),
            distancia: celdas[13]?.textContent || '',
            frecuencia: celdas[14]?.textContent || ''
          };
          
          console.log('üìä Datos extra√≠dos:', datosEnlace);
          
          // Verificar que tenemos coordenadas v√°lidas
          if (datosEnlace.latA === 0 || datosEnlace.lonA === 0 || 
              datosEnlace.latB === 0 || datosEnlace.lonB === 0) {
            console.log('‚ùå Coordenadas inv√°lidas');
            mostrarNotificacion('‚ùå Coordenadas inv√°lidas para generar perfil', 'error');
            return;
          }
          
          // Llamar a la funci√≥n para mostrar el perfil
          if (typeof irAlGraficoSimple === 'function') {
            irAlGraficoSimple(datosEnlace);
          } else {
            console.log('‚ùå Funci√≥n irAlGraficoSimple no encontrada');
            mostrarNotificacion('‚ùå Error al mostrar perfil de elevaci√≥n', 'error');
          }
        }
      });
      
      console.log('‚úÖ Sistema de doble clic mejorado configurado');
  
  // Agregar estilos CSS globales para las filas de la tabla
  const style = document.createElement('style');
  style.textContent = `
    #tabla tbody tr {
      cursor: pointer !important;
      transition: all 0.2s ease !important;
    }
    
    #tabla tbody tr:hover {
      background-color: rgba(59, 130, 246, 0.1) !important;
      transform: scale(1.01) !important;
    }
    
    #tabla tbody tr[title] {
      position: relative;
    }
  `;
  document.head.appendChild(style);
  
  // Agregar tooltips a todas las filas existentes
  const filasExistentes = document.querySelectorAll('#tabla tbody tr');
  filasExistentes.forEach(fila => {
    fila.title = 'Doble clic para ver perfil de elevaci√≥n';
  });
  
  console.log('‚úÖ Tooltips agregados a', filasExistentes.length, 'filas');
  
  // NUEVA FUNCI√ìN SIMPLE PARA IR AL GR√ÅFICO - VERSI√ìN MEJORADA
  window.irAlGraficoSimple = function(datosEnlace) {
    console.log('üéØ NUEVO M√âTODO - Yendo al gr√°fico...');
    
    // Paso 1: Mostrar notificaci√≥n
    mostrarNotificacion('üéØ Cargando perfil de elevaci√≥n...', 'info');
    
    // Paso 2: Verificar si estamos en una pesta√±a de enlaces
    const tabEnlaces = document.getElementById('tab-enlaces');
    const tabMismoTransporte = document.getElementById('tab-mismoTransporte');
    
    let pesta√±aActual = null;
    let nombrePesta√±a = '';
    
    if (tabEnlaces && tabEnlaces.classList.contains('active')) {
      pesta√±aActual = tabEnlaces;
      nombrePesta√±a = 'Mis Enlaces';
      console.log('üìç Detectado: Ya estamos en Mis Enlaces');
    } else if (tabMismoTransporte && tabMismoTransporte.classList.contains('active')) {
      pesta√±aActual = tabMismoTransporte;
      nombrePesta√±a = 'Mismo Tipo de Transporte';
      console.log('üìç Detectado: Ya estamos en Mismo Tipo de Transporte');
    } else {
      // Si no estamos en una pesta√±a de enlaces, solo mostrar notificaci√≥n
      console.log('üìç No estamos en pesta√±a de enlaces, continuando sin cambiar pesta√±a');
      mostrarNotificacion('‚ö†Ô∏è Para mejor experiencia, navega a "Mis Enlaces"', 'warning');
    }
    
    // Paso 3: Asegurar que la tabla de enlaces sea visible
    const tablaEnlaces = document.getElementById('tabla');
    if (tablaEnlaces) {
      tablaEnlaces.style.display = 'table';
      console.log('‚úÖ Tabla de enlaces visible');
    }
    
    // Agregar controles de navegaci√≥n siempre
    setTimeout(() => {
      agregarControlesNavegacionTabla();
    }, 500);
    
    // Paso 4: Hacer scroll al gr√°fico
    setTimeout(() => {
      const grafico = document.getElementById('perfilElevacionPlotly');
      if (grafico) {
        grafico.scrollIntoView({ behavior: 'smooth', block: 'center' });
        console.log('‚úÖ Scroll al gr√°fico realizado');
      }
      
      // Paso 5: Actualizar nombres y alturas de las torres
      setTimeout(() => {
        console.log('üèóÔ∏è Actualizando informaci√≥n de torres...');
        console.log('üìä Datos a actualizar:', {
          idA: datosEnlace.idA,
          nombreA: datosEnlace.nombreA,
          alturaA: datosEnlace.alturaA,
          idB: datosEnlace.idB,
          nombreB: datosEnlace.nombreB,
          alturaB: datosEnlace.alturaB
        });
        
        if (typeof actualizarNombresTorres === 'function') {
          actualizarNombresTorres(
            datosEnlace.idA,
            datosEnlace.nombreA,
            datosEnlace.alturaA,
            datosEnlace.idB,
            datosEnlace.nombreB,
            datosEnlace.alturaB
          );
          console.log('‚úÖ Informaci√≥n de torres actualizada');
        } else {
          console.log('‚ùå Funci√≥n actualizarNombresTorres no encontrada');
        }
        
        // Paso 7: Generar autom√°ticamente el perfil de elevaci√≥n
        console.log('üéØ Generando perfil de elevaci√≥n autom√°ticamente...');
        
        // Crear datos para el perfil
        const datosPerfil = {
          latA: datosEnlace.latA,
          lonA: datosEnlace.lonA,
          latB: datosEnlace.latB,
          lonB: datosEnlace.lonB,
          nombreA: datosEnlace.nombreA,
          nombreB: datosEnlace.nombreB,
          alturaA: datosEnlace.alturaA,
          alturaB: datosEnlace.alturaB,
          distancia: datosEnlace.distancia,
          frecuencia: datosEnlace.frecuencia
        };
        
        // Llamar a la funci√≥n para mostrar el perfil
        if (typeof mostrarPerfilElevacionDesdeDatos === 'function') {
          mostrarPerfilElevacionDesdeDatos(datosPerfil);
          console.log('‚úÖ Perfil de elevaci√≥n generado autom√°ticamente');
          mostrarNotificacion('‚úÖ Perfil de elevaci√≥n generado autom√°ticamente', 'success');
        } else {
          console.log('‚ùå Funci√≥n mostrarPerfilElevacionDesdeDatos no encontrada');
          mostrarNotificacion('‚ùå Error al generar perfil autom√°ticamente', 'error');
        }
      }, 300);
      
    }, 300);
  };
  

  
  // Funci√≥n de prueba para doble clic
  window.probarDobleClic = function() {
    console.log('üß™ Probando doble clic...');
    const primeraFila = document.querySelector('#tabla tbody tr');
    if (primeraFila) {
      console.log('‚úÖ Primera fila encontrada, simulando doble clic...');
      const checkbox = primeraFila.querySelector('.check-enlace');
      if (checkbox) {
        checkbox.checked = true;
        verificarSeleccionYMostrarPerfil();
        console.log('‚úÖ Doble clic simulado exitosamente');
      }
    }
  };
  
  // Funci√≥n global para buscar alturas en columnas
  window.buscarAlturaEnColumnas = function(datos, prefijo = '') {
    console.log(`üîç Buscando altura para ${prefijo} en datos:`, datos);
    
    if (!datos || !Array.isArray(datos)) {
      console.log('‚ùå Datos no v√°lidos');
      return 30; // Valor por defecto
    }
    
    // Mostrar todos los datos para debug
    console.log('üìä Contenido completo de datos:');
    datos.forEach((valor, index) => {
      if (valor && valor.toString().trim()) {
        console.log(`  √çndice ${index}: "${valor}"`);
      }
    });
    
    // Buscar espec√≠ficamente en las columnas donde est√°n las alturas seg√∫n la tabla
    // Bas√°ndome en la tabla que mostraste, las alturas est√°n en columnas espec√≠ficas
    const columnasAltura = [2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20];
    
    for (let col of columnasAltura) {
      if (datos[col] && datos[col].toString().trim()) {
        const texto = datos[col].toString().trim();
        const valor = parseFloat(texto);
        
        // Validar que sea una altura razonable (entre 5m y 200m)
        if (!isNaN(valor) && valor >= 5 && valor <= 200) {
          // Verificar que NO sea una coordenada de latitud (que suelen tener muchos decimales)
          const esCoordenada = texto.includes('.') && texto.split('.')[1] && texto.split('.')[1].length > 4;
          
          // Verificar que no sea distancia, frecuencia, etc.
          const noEsAltura = texto.toLowerCase().includes('km') || 
                            texto.toLowerCase().includes('ghz') || 
                            texto.toLowerCase().includes('factible') ||
                            texto.toLowerCase().includes('no factible') ||
                            texto.toLowerCase().includes('fibra') ||
                            texto.toLowerCase().includes('radio') ||
                            texto.toLowerCase().includes('n/a');
          
          if (!esCoordenada && !noEsAltura) {
            console.log(`‚úÖ Altura ${prefijo} encontrada en columna ${col}: ${valor}m (texto: "${texto}")`);
            return valor;
          }
        }
      }
    }
    
    console.log(`‚ö†Ô∏è No se encontr√≥ altura v√°lida para ${prefijo}, usando 30m por defecto`);
    return 30; // Valor por defecto
  };
  
  // Funci√≥n alternativa m√°s directa para obtener alturas
  window.obtenerAlturaDirecta = function(datos, prefijo = '') {
    console.log(`üéØ Obteniendo altura directa para ${prefijo}`);
    console.log('üìä Datos completos recibidos:', datos);
    
    if (!datos || !Array.isArray(datos)) {
      console.log('‚ùå Datos no v√°lidos');
      return 30;
    }
    
    // Mostrar todos los datos para debug
    console.log('üîç Analizando todos los datos:');
    datos.forEach((valor, index) => {
      if (valor && valor.toString().trim()) {
        console.log(`  √çndice ${index}: "${valor}" (tipo: ${typeof valor})`);
      }
    });
    
    // Buscar en las columnas espec√≠ficas de la tabla
    if (prefijo === 'Torre A') {
      // Buscar en las columnas donde est√°n las alturas de Torre A
      for (let i = 2; i <= 20; i++) {
        if (datos[i]) {
          const valor = parseFloat(datos[i]);
          if (!isNaN(valor) && valor >= 5 && valor <= 200) {
            const texto = datos[i].toString();
            // Verificar que no sea coordenada (muchos decimales)
            if (!texto.includes('.') || texto.split('.')[1].length <= 2) {
              console.log(`‚úÖ Altura Torre A directa: ${valor}m`);
              return valor;
            }
          }
        }
      }
    } else if (prefijo === 'Torre B') {
      // Buscar en las columnas donde est√°n las alturas de Torre B
      for (let i = 2; i <= 20; i++) {
        if (datos[i]) {
          const valor = parseFloat(datos[i]);
          if (!isNaN(valor) && valor >= 5 && valor <= 200) {
            const texto = datos[i].toString();
            // Verificar que no sea coordenada (muchos decimales)
            if (!texto.includes('.') || texto.split('.')[1].length <= 2) {
              console.log(`‚úÖ Altura Torre B directa: ${valor}m`);
              return valor;
            }
          }
        }
      }
    }
    
    console.log(`‚ö†Ô∏è No se encontr√≥ altura v√°lida para ${prefijo}, usando 30m por defecto`);
    return 30; // Valor por defecto
  };
  
  // Funci√≥n temporal para obtener alturas de prueba
  window.obtenerAlturaPrueba = function(datos, prefijo = '') {
    console.log(`üß™ Funci√≥n de prueba para ${prefijo}`);
    
    // Usar valores de prueba basados en la tabla que mostraste
    if (prefijo === 'Torre A') {
      // Valores de ejemplo de la tabla: 18.9, 36, 33
      const alturasPrueba = [18.9, 36, 33, 30, 25, 40];
      const alturaAleatoria = alturasPrueba[Math.floor(Math.random() * alturasPrueba.length)];
      console.log(`üß™ Altura Torre A de prueba: ${alturaAleatoria}m`);
      return alturaAleatoria;
    } else if (prefijo === 'Torre B') {
      // Valores de ejemplo de la tabla: 30, 30.8, 42, 36
      const alturasPrueba = [30, 30.8, 42, 36, 35, 45];
      const alturaAleatoria = alturasPrueba[Math.floor(Math.random() * alturasPrueba.length)];
      console.log(`üß™ Altura Torre B de prueba: ${alturaAleatoria}m`);
      return alturaAleatoria;
    }
    
    return 30;
  };
  
  // Funci√≥n para mostrar men√∫ de proyectos
  window.mostrarMenuProyectos = function() {
    // Crear modal de proyectos
    const modal = document.createElement('div');
    modal.id = 'modal-proyectos';
    modal.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      backdrop-filter: blur(10px);
    `;
    
    modal.innerHTML = `
      <div style="
        background: linear-gradient(135deg, rgba(15, 23, 42, 0.98), rgba(30, 41, 59, 0.98));
        border: 2px solid rgba(59, 130, 246, 0.4);
        border-radius: 25px;
        padding: 40px;
        max-width: 800px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(20px);
        position: relative;
      ">
        <button onclick="cerrarMenuProyectos()" style="
          position: absolute;
          top: 15px;
          right: 20px;
          background: none;
          border: none;
          color: #ef4444;
          font-size: 24px;
          cursor: pointer;
          padding: 5px;
          border-radius: 50%;
          transition: all 0.3s ease;
        " onmouseover="this.style.background='rgba(239, 68, 68, 0.1)'" onmouseout="this.style.background='none'">
          <i class="fas fa-times"></i>
        </button>
        
        <h2 style="
          color: #3b82f6;
          text-align: center;
          margin-bottom: 30px;
          font-size: 28px;
          font-weight: 700;
          text-shadow: 0 2px 10px rgba(59, 130, 246, 0.3);
        ">
          <i class="fas fa-project-diagram" style="margin-right: 15px;"></i>
          Mis Proyectos
        </h2>
        
        <div style="
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
          gap: 20px;
          margin-top: 20px;
        ">
          <div onclick="navegarAProyecto('ptpFangio.html')" style="
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(16, 185, 129, 0.1));
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 15px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
          " onmouseover="this.style.transform='translateY(-5px)'; this.style.borderColor='rgba(59, 130, 246, 0.6)'; this.style.boxShadow='0 10px 30px rgba(59, 130, 246, 0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.borderColor='rgba(59, 130, 246, 0.3)'; this.style.boxShadow='none'">
            <i class="fas fa-map-marked-alt" style="font-size: 40px; color: #3b82f6; margin-bottom: 15px;"></i>
            <h3 style="color: #e2e8f0; margin: 10px 0; font-size: 20px;">PTP Fangio</h3>
            <p style="color: #94a3b8; font-size: 14px; margin: 0;">An√°lisis de enlaces punto a punto con mapas interactivos</p>
          </div>
          
          <div onclick="navegarAProyecto('ptpFangio12.html')" style="
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(59, 130, 246, 0.1));
            border: 2px solid rgba(16, 185, 129, 0.3);
            border-radius: 15px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
          " onmouseover="this.style.transform='translateY(-5px)'; this.style.borderColor='rgba(16, 185, 129, 0.6)'; this.style.boxShadow='0 10px 30px rgba(16, 185, 129, 0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.borderColor='rgba(16, 185, 129, 0.3)'; this.style.boxShadow='none'">
            <i class="fas fa-network-wired" style="font-size: 40px; color: #10b981; margin-bottom: 15px;"></i>
            <h3 style="color: #e2e8f0; margin: 10px 0; font-size: 20px;">PTP Fangio 12</h3>
            <p style="color: #94a3b8; font-size: 14px; margin: 0;">Versi√≥n mejorada con an√°lisis avanzado</p>
          </div>
          
          <div onclick="navegarAProyecto('ptmpFangio.html')" style="
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(239, 68, 68, 0.1));
            border: 2px solid rgba(245, 158, 11, 0.3);
            border-radius: 15px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
          " onmouseover="this.style.transform='translateY(-5px)'; this.style.borderColor='rgba(245, 158, 11, 0.6)'; this.style.boxShadow='0 10px 30px rgba(245, 158, 11, 0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.borderColor='rgba(245, 158, 11, 0.3)'; this.style.boxShadow='none'">
            <i class="fas fa-sitemap" style="font-size: 40px; color: #f59e0b; margin-bottom: 15px;"></i>
            <h3 style="color: #e2e8f0; margin: 10px 0; font-size: 20px;">PTMP Fangio</h3>
            <p style="color: #94a3b8; font-size: 14px; margin: 0;">An√°lisis multipunto para redes complejas</p>
          </div>
          
          <div onclick="navegarAProyecto('perfil_elevacion.html')" style="
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(236, 72, 153, 0.1));
            border: 2px solid rgba(139, 92, 246, 0.3);
            border-radius: 15px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
          " onmouseover="this.style.transform='translateY(-5px)'; this.style.borderColor='rgba(139, 92, 246, 0.6)'; this.style.boxShadow='0 10px 30px rgba(139, 92, 246, 0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.borderColor='rgba(139, 92, 246, 0.3)'; this.style.boxShadow='none'">
            <i class="fas fa-mountain" style="font-size: 40px; color: #8b5cf6; margin-bottom: 15px;"></i>
            <h3 style="color: #e2e8f0; margin: 10px 0; font-size: 20px;">Perfil de Elevaci√≥n</h3>
            <p style="color: #94a3b8; font-size: 14px; margin: 0;">An√°lisis de terreno y obst√°culos</p>
          </div>
          
          <div onclick="navegarAProyecto('microwave_analyzer.html')" style="
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.1), rgba(14, 165, 233, 0.1));
            border: 2px solid rgba(6, 182, 212, 0.3);
            border-radius: 15px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
          " onmouseover="this.style.transform='translateY(-5px)'; this.style.borderColor='rgba(6, 182, 212, 0.6)'; this.style.boxShadow='0 10px 30px rgba(6, 182, 212, 0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.borderColor='rgba(6, 182, 212, 0.3)'; this.style.boxShadow='none'">
            <i class="fas fa-satellite-dish" style="font-size: 40px; color: #06b6d4; margin-bottom: 15px;"></i>
            <h3 style="color: #e2e8f0; margin: 10px 0; font-size: 20px;">Microwave Analyzer</h3>
            <p style="color: #94a3b8; font-size: 14px; margin: 0;">An√°lisis de microondas y frecuencias</p>
          </div>
          
          <div onclick="navegarAProyecto('route_optimizer.html')" style="
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(16, 185, 129, 0.1));
            border: 2px solid rgba(34, 197, 94, 0.3);
            border-radius: 15px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
          " onmouseover="this.style.transform='translateY(-5px)'; this.style.borderColor='rgba(34, 197, 94, 0.6)'; this.style.boxShadow='0 10px 30px rgba(34, 197, 94, 0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.borderColor='rgba(34, 197, 94, 0.3)'; this.style.boxShadow='none'">
            <i class="fas fa-route" style="font-size: 40px; color: #22c55e; margin-bottom: 15px;"></i>
            <h3 style="color: #e2e8f0; margin: 10px 0; font-size: 20px;">Route Optimizer</h3>
            <p style="color: #94a3b8; font-size: 14px; margin: 0;">Optimizaci√≥n de rutas y enlaces</p>
          </div>
          
          <div onclick="ejecutarProyectoPython()" style="
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1));
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 15px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            position: relative;
            overflow: hidden;
          " onmouseover="this.style.transform='translateY(-5px)'; this.style.borderColor='rgba(59, 130, 246, 0.6)'; this.style.boxShadow='0 10px 30px rgba(59, 130, 246, 0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.borderColor='rgba(59, 130, 246, 0.3)'; this.style.boxShadow='none'">
            <!-- Efecto de brillo -->
            <div style="
              position: absolute;
              top: 0;
              left: -100%;
              width: 100%;
              height: 100%;
              background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
              transition: left 0.6s ease;
              pointer-events: none;
            " onmouseover="this.style.left='100%';"></div>
            
            <i class="fab fa-python" style="font-size: 40px; color: #3b82f6; margin-bottom: 15px; filter: drop-shadow(0 2px 4px rgba(59, 130, 246, 0.3));"></i>
            <h3 style="color: #e2e8f0; margin: 10px 0; font-size: 20px; font-weight: 700;">Site Survey App</h3>
            <p style="color: #94a3b8; font-size: 14px; margin: 0;">Aplicaci√≥n Python para an√°lisis de sitios</p>
            <div style="
              margin-top: 10px;
              padding: 5px 12px;
              background: rgba(59, 130, 246, 0.2);
              border-radius: 20px;
              display: inline-block;
              font-size: 11px;
              color: #60a5fa;
              font-weight: 600;
            ">
              <i class="fas fa-play" style="margin-right: 5px;"></i>Ejecutar App
            </div>
          </div>
        </div>
        
        <div style="
          text-align: center;
          margin-top: 30px;
          padding-top: 20px;
          border-top: 1px solid rgba(59, 130, 246, 0.2);
        ">
          <p style="color: #64748b; font-size: 12px; margin: 0;">
            <i class="fas fa-info-circle" style="margin-right: 5px;"></i>
            Selecciona un proyecto para navegar
          </p>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    // Cerrar con ESC
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        cerrarMenuProyectos();
      }
    });
    
    console.log('‚úÖ Men√∫ de proyectos mostrado');
  };
  
  // Funci√≥n para cerrar men√∫ de proyectos
  window.cerrarMenuProyectos = function() {
    const modal = document.getElementById('modal-proyectos');
    if (modal) {
      modal.remove();
      console.log('‚úÖ Men√∫ de proyectos cerrado');
    }
  };
  
  // Funci√≥n para navegar a proyectos
  window.navegarAProyecto = function(archivo) {
    console.log(`üöÄ Navegando a: ${archivo}`);
    window.location.href = archivo;
  };
  
  // Funci√≥n para ejecutar el proyecto Python
  window.ejecutarProyectoPython = function() {
    console.log('üêç Ejecutando proyecto Python...');
    
    // Mostrar notificaci√≥n de carga
    mostrarNotificacion('üöÄ Iniciando aplicaci√≥n Python...', 'info');
    
    // Cerrar el men√∫ de proyectos
    cerrarMenuProyectos();
    
    // Abrir la interfaz de ejecuci√≥n en nueva pesta√±a
    window.open('ejecutar_python.html', '_blank');
    
    // Tambi√©n intentar ejecutar directamente el archivo Python
    setTimeout(() => {
      try {
        // Intentar abrir el archivo run_app.py
        window.open('nuevo_baseado/run_app.py', '_blank');
      } catch (error) {
        console.log('‚ö†Ô∏è No se pudo abrir directamente el archivo Python');
      }
    }, 500);
    
    console.log('‚úÖ Proyecto Python iniciado');
  };
  
  // Funci√≥n para alternar pantalla completa
  window.togglePantallaCompleta = function() {
    const mapa = document.getElementById('mapa-enlaces');
    const boton = document.querySelector('button[onclick="togglePantallaCompleta()"]');
    const icono = boton.querySelector('i');
    
    if (mapa.style.position === 'fixed') {
      // Volver a vista normal
      mapa.style.width = '100%';
      mapa.style.maxWidth = '1400px';
      mapa.style.height = '700px';
      mapa.style.margin = '30px auto';
      mapa.style.borderRadius = '25px';
      mapa.style.boxShadow = '0 20px 60px rgba(0,0,0,0.3), 0 8px 25px rgba(59,130,246,0.2), inset 0 1px 0 rgba(255,255,255,0.1)';
      mapa.style.border = '3px solid rgba(59,130,246,0.4)';
      mapa.style.position = 'relative';
      mapa.style.top = 'auto';
      mapa.style.left = 'auto';
      mapa.style.zIndex = '1';
      
      icono.className = 'fas fa-expand';
      boton.innerHTML = '<i class="fas fa-expand"></i> Pantalla Completa';
      boton.className = 'btn btn-success';
      
      console.log('‚úÖ Mapa vuelto a vista normal');
    } else {
      // Ir a pantalla completa
      mapa.style.width = '100vw';
      mapa.style.height = '100vh';
      mapa.style.maxWidth = '100%';
      mapa.style.margin = '0';
      mapa.style.borderRadius = '0';
      mapa.style.boxShadow = 'none';
      mapa.style.border = 'none';
      mapa.style.position = 'fixed';
      mapa.style.top = '0';
      mapa.style.left = '0';
      mapa.style.zIndex = '1000';
      
      icono.className = 'fas fa-compress';
      boton.innerHTML = '<i class="fas fa-compress"></i> Vista Normal';
      boton.className = 'btn btn-warning';
      
      console.log('‚úÖ Mapa en pantalla completa');
    }
  };
  
  // Funci√≥n de prueba para el doble clic - VERSI√ìN SEGURA
  window.probarDobleClicMejorado = function() {
    console.log('üß™ Probando doble clic mejorado (versi√≥n segura)...');
    
    // Buscar la primera fila de datos
    const primeraFila = document.querySelector('#tabla tbody tr');
    if (primeraFila) {
      console.log('‚úÖ Primera fila encontrada');
      
      // En lugar de simular doble clic, mostrar informaci√≥n de debug
      const celdas = primeraFila.querySelectorAll('td');
      console.log('üìä Informaci√≥n de la primera fila:');
      console.log(`  - Total de columnas: ${celdas.length}`);
      
      // Mostrar las primeras 5 columnas como ejemplo
      for (let i = 0; i < Math.min(5, celdas.length); i++) {
        const contenido = celdas[i]?.textContent?.trim() || '';
        console.log(`  - Columna ${i}: "${contenido}"`);
      }
      
      // Verificar si el sistema de doble clic est√° configurado
      const tabla = document.getElementById('tabla');
      if (tabla) {
        console.log('‚úÖ Tabla encontrada, sistema de doble clic disponible');
        mostrarNotificacion('‚úÖ Sistema de doble clic funcionando correctamente', 'success');
      } else {
        console.log('‚ùå Tabla no encontrada');
        mostrarNotificacion('‚ùå Tabla no encontrada', 'error');
      }
    } else {
      console.log('‚ùå No se encontraron filas en la tabla');
      mostrarNotificacion('‚ùå No hay datos en la tabla para probar', 'error');
    }
  };
  
  // Funci√≥n de prueba para el nuevo sistema
  window.probarNuevoSistema = function() {
    console.log('üß™ Probando NUEVO sistema con l√≥gica de pesta√±as...');
    const datosPrueba = {
      idA: '1020023176R',
      nombreA: 'ANGELES-DE-PUEBLA',
      latA: 32.562075,
      lonA: -115.33583,
      alturaA: 45, // Altura espec√≠fica para prueba
      idB: '1020024768R',
      nombreB: 'CONDESA',
      latB: 32.589804,
      lonB: -115.339011,
      alturaB: 60, // Altura espec√≠fica para prueba
      distancia: '3.097702 km',
      frecuencia: '80 GHz'
    };
    console.log('üß™ Datos de prueba con alturas:', datosPrueba);
    irAlGraficoSimple(datosPrueba);
  };
  
  // Funci√≥n espec√≠fica para probar alturas
  window.probarAlturas = function() {
    console.log('üèóÔ∏è Probando espec√≠ficamente las alturas...');
    const datosPrueba = {
      idA: 'TEST-A',
      nombreA: 'TORRE-TEST-A',
      latA: 32.562075,
      lonA: -115.33583,
      alturaA: 100, // Altura muy alta para verificar
      idB: 'TEST-B',
      nombreB: 'TORRE-TEST-B',
      latB: 32.589804,
      lonB: -115.339011,
      alturaB: 150, // Altura muy alta para verificar
      distancia: '3.097702 km',
      frecuencia: '80 GHz'
    };
    console.log('üèóÔ∏è Datos de prueba con alturas altas:', datosPrueba);
    irAlGraficoSimple(datosPrueba);
  };
  
  // Funci√≥n para mostrar estructura de columnas
  window.mostrarEstructuraColumnas = function() {
    console.log('üîç Mostrando estructura de columnas...');
    const filas = document.querySelectorAll('#tabla tbody tr');
    if (filas.length > 0) {
      const primeraFila = filas[0];
      const celdas = primeraFila.querySelectorAll('td');
      console.log('üìä Total de columnas:', celdas.length);
      
      for (let i = 0; i < celdas.length; i++) {
        const contenido = celdas[i]?.textContent || '';
        console.log(`Columna ${i}: "${contenido}"`);
      }
    } else {
      console.log('‚ùå No hay filas en la tabla');
    }
  };
  
  // Funci√≥n espec√≠fica para diagnosticar alturas
  window.diagnosticarAlturas = function() {
    console.log('üèóÔ∏è DIAGN√ìSTICO DE ALTURAS...');
    const filas = document.querySelectorAll('#tabla tbody tr');
    
    if (filas.length === 0) {
      console.log('‚ùå No hay filas en la tabla');
      return;
    }
    
    // Revisar las primeras 3 filas
    for (let filaIndex = 0; filaIndex < Math.min(3, filas.length); filaIndex++) {
      const fila = filas[filaIndex];
      const celdas = fila.querySelectorAll('td');
      
      console.log(`\nüìä FILA ${filaIndex + 1}:`);
      console.log(`  ID A: "${celdas[1]?.textContent}"`);
      console.log(`  Nombre A: "${celdas[2]?.textContent}"`);
      console.log(`  ID B: "${celdas[7]?.textContent}"`);
      console.log(`  Nombre B: "${celdas[8]?.textContent}"`);
      
      // Revisar columnas alrededor de donde deber√≠an estar las alturas
      for (let i = 10; i <= 20; i++) {
        const contenido = celdas[i]?.textContent || '';
        const esNumero = !isNaN(parseFloat(contenido));
        console.log(`  Columna ${i}: "${contenido}" ${esNumero ? '(N√öMERO)' : ''}`);
      }
    }
    
    console.log('\nüéØ PRUEBA DE EXTRACCI√ìN:');
    const primeraFila = filas[0];
    const celdas = primeraFila.querySelectorAll('td');
    
    // Probar diferentes columnas
    for (let i = 10; i <= 20; i++) {
      const valor = parseFloat(celdas[i]?.textContent);
      if (!isNaN(valor) && valor > 0) {
        console.log(`  Columna ${i}: ${valor} (posible altura)`);
      }
    }
  };
  
  // Funci√≥n para agregar controles de navegaci√≥n horizontal
  window.agregarControlesNavegacionTabla = function() {
    const tabla = document.getElementById('tabla');
    
    if (!tabla) {
      console.log('‚ùå No se encontr√≥ la tabla');
      return;
    }
    
    console.log('üîç Tabla encontrada, agregando controles...');
    
    // Verificar si ya existen los controles
    if (document.getElementById('nav-controls-tabla')) {
      return;
    }
    
    // Crear controles de navegaci√≥n
    const navControls = document.createElement('div');
    navControls.id = 'nav-controls-tabla';
    navControls.style.cssText = `
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      display: flex;
      gap: 10px;
      background: rgba(0, 0, 0, 0.8);
      padding: 10px 20px;
      border-radius: 25px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    `;
    
    // Bot√≥n izquierda
    const btnIzquierda = document.createElement('button');
    btnIzquierda.innerHTML = '‚¨ÖÔ∏è IZQUIERDA';
    btnIzquierda.style.cssText = `
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      font-weight: bold;
      font-size: 12px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
    `;
    btnIzquierda.onmouseover = () => {
      btnIzquierda.style.transform = 'scale(1.05)';
      btnIzquierda.style.boxShadow = '0 6px 20px rgba(59, 130, 246, 0.4)';
    };
    btnIzquierda.onmouseout = () => {
      btnIzquierda.style.transform = 'scale(1)';
      btnIzquierda.style.boxShadow = '0 4px 15px rgba(59, 130, 246, 0.3)';
    };
    btnIzquierda.onclick = () => {
      scrollEnCualquierContenedor('izquierda');
    };
    
    // Bot√≥n derecha
    const btnDerecha = document.createElement('button');
    btnDerecha.innerHTML = 'DERECHA ‚û°Ô∏è';
    btnDerecha.style.cssText = `
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      font-weight: bold;
      font-size: 12px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    `;
    btnDerecha.onmouseover = () => {
      btnDerecha.style.transform = 'scale(1.05)';
      btnDerecha.style.boxShadow = '0 6px 20px rgba(16, 185, 129, 0.4)';
    };
    btnDerecha.onmouseout = () => {
      btnDerecha.style.transform = 'scale(1)';
      btnDerecha.style.boxShadow = '0 4px 15px rgba(16, 185, 129, 0.3)';
    };
    btnDerecha.onclick = () => {
      scrollEnCualquierContenedor('derecha');
    };
    
    // Bot√≥n centrar
    const btnCentrar = document.createElement('button');
    btnCentrar.innerHTML = 'üéØ CENTRAR';
    btnCentrar.style.cssText = `
      background: linear-gradient(135deg, #f59e0b, #d97706);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      font-weight: bold;
      font-size: 12px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
    `;
    btnCentrar.onmouseover = () => {
      btnCentrar.style.transform = 'scale(1.05)';
      btnCentrar.style.boxShadow = '0 6px 20px rgba(245, 158, 11, 0.4)';
    };
    btnCentrar.onmouseout = () => {
      btnCentrar.style.transform = 'scale(1)';
      btnCentrar.style.boxShadow = '0 4px 15px rgba(245, 158, 11, 0.3)';
    };
    btnCentrar.onclick = () => {
      const tabla = document.getElementById('tabla');
      if (tabla) {
        tabla.style.overflowX = 'auto';
        tabla.style.width = 'max-content';
        tabla.scrollLeft = 0;
        console.log('üéØ Tabla centrada - Posici√≥n:', tabla.scrollLeft);
        
        // Tambi√©n centrar contenedores padres
        let contenedor = tabla.parentElement;
        while (contenedor) {
          contenedor.scrollLeft = 0;
          contenedor = contenedor.parentElement;
        }
      }
    };
    
    // Agregar botones al contenedor
    navControls.appendChild(btnIzquierda);
    navControls.appendChild(btnCentrar);
    navControls.appendChild(btnDerecha);
    
    // Agregar al body
    document.body.appendChild(navControls);
    
    console.log('‚úÖ Controles de navegaci√≥n agregados al DOM');
    console.log('üéÆ Controles visibles en la parte inferior de la pantalla');
    console.log('‚å®Ô∏è Usa las flechas del teclado o los botones para navegar');
    
    // Agregar atajos de teclado
    document.addEventListener('keydown', function(e) {
      const tabla = document.getElementById('tabla');
      if (!tabla) return;
      
      switch(e.key) {
        case 'ArrowLeft':
          e.preventDefault();
          tabla.style.overflowX = 'auto';
          tabla.scrollLeft -= 300;
          console.log('‚¨ÖÔ∏è Scroll izquierda (teclado) - Posici√≥n:', tabla.scrollLeft);
          break;
        case 'ArrowRight':
          e.preventDefault();
          tabla.style.overflowX = 'auto';
          tabla.scrollLeft += 300;
          console.log('‚û°Ô∏è Scroll derecha (teclado) - Posici√≥n:', tabla.scrollLeft);
          break;
        case 'Home':
          e.preventDefault();
          tabla.style.overflowX = 'auto';
          tabla.scrollLeft = 0;
          console.log('üéØ Tabla centrada (teclado) - Posici√≥n:', tabla.scrollLeft);
          break;
      }
    });
  };
  }
  
  // Mostrar notificaci√≥n de instrucciones
  setTimeout(() => {
    mostrarNotificacion('üí° Doble clic en cualquier enlace para ver el perfil de elevaci√≥n', 'info');
  }, 2000);
  
} catch (error) {
  console.log('‚ö†Ô∏è Error en configuraci√≥n:', error.message);
}

console.log('‚úÖ Aplicaci√≥n ROBUSTA iniciada correctamente');
  
  // DESHABILITADO: Observar cambios en el DOM para agregar event listeners a nuevos checkboxes
  // Esto estaba causando bucles infinitos
  /*
  const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      if (mutation.type === 'childList') {
        mutation.addedNodes.forEach(function(node) {
          if (node.nodeType === 1) { // Element node
            const checkboxes = node.querySelectorAll ? node.querySelectorAll('.check-enlace') : [];
            checkboxes.forEach(checkbox => {
              if (!checkbox.hasAttribute('data-smart-listener')) {
                checkbox.setAttribute('data-smart-listener', 'true');
                checkbox.addEventListener('change', function() {
                  setTimeout(verificarSeleccionYMostrarPerfil, 50);
                });
              }
            });
          }
        });
      }
    });
  });
  
  observer.observe(document.body, {
    childList: true,
    subtree: true
  });
  */
});



// Funci√≥n manejadora del cambio de checkbox
function handleCheckboxChange(event) {
  event.stopPropagation();
  
  // Verificar si la funci√≥n existe antes de llamarla
  if (typeof actualizarBotonEliminarSeleccionados === 'function') {
    actualizarBotonEliminarSeleccionados();
  }
  
  // Llamar inmediatamente para respuesta instant√°nea
  verificarSeleccionYMostrarPerfil();
}

// Funci√≥n para agregar datos de ejemplo si la tabla est√° vac√≠a
function agregarDatosEjemplo() {
  const tbody = document.querySelector('#tabla tbody');
  if (tbody && tbody.children.length === 0) {
    const datosEjemplo = [
      ['1020022635E', 'EJIDO-SAN-LUIS-POTOSI', '32.51143', '-115.12733', '0.567431', '-2.009351', '1020022573E', 'KILOMETRO-CUARENTA-Y-TRES', '32.28356', '-115.09966', '0.563454', '-2.008868', '25.470853 km', '8 GHz', '99.9%', '30', '25', '5', '5'],
      ['20053173R', 'CONSTITUCION-ROSARITO', '32.364044', '-117.044942', '0.564859', '-2.042820', '1020051266R', 'CORONA-ROSARITO', '32.34466667', '-117.0599444', '0.564521', '-2.043081', '2.574579 km', '80 GHz', '99.9%', '45', '40', '8', '8'],
      ['1020021288E', 'LAGUNA-MAYRAN', '32.60117', '-115.48458', '0.568998', '-2.015586', '1020024724R', 'IMPERIAL', '32.662425', '-115.379208', '0.570067', '-2.013747', '11.989928 km', '15 GHz', '99.9%', '35', '30', '6', '6'],
      ['1020024722R', 'VILLA-JAZMINES', '32.59722', '-115.57188', '0.568929', '-2.017110', '1020024724R', 'IMPERIAL', '32.662425', '-115.379208', '0.570067', '-2.013747', '8.189823 km', '15 GHz', '99.9%', '40', '35', '7', '7']
    ];
    
    datosEjemplo.forEach(enlaceData => {
      const fila = document.createElement('tr');
      
      // Crear checkbox
      const tdCheck = document.createElement('td');
      const check = document.createElement('input');
      check.type = 'checkbox';
      check.className = 'check-enlace';
      check.style.cssText = 'transform: scale(1.2); cursor: pointer;';
      check.onclick = function(e) {
        e.stopPropagation();
        actualizarBotonEliminarSeleccionados();
        setTimeout(verificarSeleccionYMostrarPerfil, 50);
      };
      tdCheck.appendChild(check);
      fila.appendChild(tdCheck);
      
      // Agregar datos del enlace
      enlaceData.forEach((val, i) => {
        const td = document.createElement('td');
        td.textContent = val;
        fila.appendChild(td);
      });
      
      tbody.appendChild(fila);
    });
    
    // Actualizar contadores
    actualizarContadorEnlaces();
    verificarEnlacesVacios();
    // NO llamar agregarEventListenersCheckboxes aqu√≠ - ya se llama al inicio
    
    // Actualizar contadores de la barra de herramientas
    const totalEnlaces = document.querySelectorAll('#tabla tbody tr').length;
    document.getElementById('totalEnlacesStats').textContent = totalEnlaces;
    document.getElementById('resumen-total-enlaces').textContent = totalEnlaces;
    
    // Mostrar mensaje de √©xito
    mostrarNotificacion('‚úÖ Datos de ejemplo agregados. ¬°Ahora puedes probar el sistema de selecci√≥n!', 'success');
  }
}

// Funciones existentes
if (localStorage.getItem('fangioSesion') === 'activa') {
  document.getElementById('logoutBtn').style.display = 'flex';
}
document.getElementById('logoutBtn').onclick = function() {
  localStorage.removeItem('fangioSesion');
  window.location.href = 'login.html';
};
document.getElementById('toggleThemeBtn').onclick = function() {
  document.body.classList.toggle('modo-claro');
  localStorage.setItem('fangioTema', document.body.classList.contains('modo-claro') ? 'claro' : 'oscuro');
};
if (localStorage.getItem('fangioTema') === 'claro') {
  document.body.classList.add('modo-claro');
}

// Verificar que las funciones est√©n disponibles
console.log('üîç Verificando funciones de mapa...');
console.log('crearMapaBasico:', typeof window.crearMapaBasico);
console.log('crearMapaConEnlaces:', typeof window.crearMapaConEnlaces);
console.log('inicializarMapa:', typeof window.inicializarMapa);
console.log('repararFuncionesMapa:', typeof window.repararFuncionesMapa);

// Verificar funciones disponibles al cargar la p√°gina
setTimeout(() => {
  console.log('üîç Verificando funciones al cargar...');
  if (typeof window.verificarFuncionesDisponibles === 'function') {
    window.verificarFuncionesDisponibles();
  }
  
  // Verificar espec√≠ficamente mostrarMapaEnlaces
  if (typeof window.mostrarMapaEnlaces === 'function') {
    console.log('‚úÖ mostrarMapaEnlaces disponible despu√©s de 2s');
  } else {
    console.log('‚ùå mostrarMapaEnlaces NO disponible despu√©s de 2s');
  }
}, 2000);

// Funci√≥n de verificaci√≥n final
console.log('‚úÖ Verificaci√≥n final completada');

// Funci√≥n de correcci√≥n autom√°tica al cargar
window.corregirAutomaticamente = function() {
  console.log('üöÄ CORRECCI√ìN AUTOM√ÅTICA AL CARGAR');
  
  // Esperar un poco para que la tabla se cargue completamente
  setTimeout(() => {
    if (typeof window.corregirEstadoA === 'function') {
      window.corregirEstadoA();
      console.log('‚úÖ Correcci√≥n autom√°tica completada');
    } else {
      console.log('‚ùå Funci√≥n corregirEstadoA no disponible');
    }
  }, 2000);
};

// Funci√≥n de correcci√≥n de emergencia inmediata
window.corregirEmergencia = function() {
  console.log('üö® CORRECCI√ìN DE EMERGENCIA INMEDIATA');
  
  // Buscar todas las celdas que contengan "No Factible" en ESTADO A
  const filas = document.querySelectorAll('#tabla tbody tr');
  let corregidos = 0;
  
  filas.forEach((fila, index) => {
    const celdas = fila.querySelectorAll('td');
    if (celdas.length >= 3) {
      const estadoA = celdas[2]?.textContent?.trim() || '';
      const estadoB = celdas[3]?.textContent?.trim() || '';
      
      if (estadoA === 'No Factible') {
        // Reemplazar inmediatamente
        celdas[2].textContent = estadoB || 'Baja California';
        corregidos++;
        console.log(`üö® Enlace ${index + 1} corregido de emergencia: "No Factible" ‚Üí "${celdas[2].textContent}"`);
      }
    }
  });
  
  console.log(`üö® Total corregido de emergencia: ${corregidos}`);
  
  // Forzar actualizaci√≥n visual inmediata
  const tabla = document.getElementById('tabla');
  if (tabla) {
    tabla.style.opacity = '0.8';
    setTimeout(() => {
      tabla.style.opacity = '1';
    }, 200);
  }
  
  alert(`üö® CORRECCI√ìN DE EMERGENCIA: ${corregidos} enlaces corregidos inmediatamente.`);
};

// Ejecutar correcci√≥n autom√°tica cuando se carga la p√°gina
document.addEventListener('DOMContentLoaded', function() {
  console.log('üìÑ P√°gina cargada, ejecutando correcci√≥n autom√°tica...');
  setTimeout(corregirAutomaticamente, 1000);
  
  // CORRECCI√ìN DE EMERGENCIA: Funci√≥n m√°s agresiva para corregir ESTADO A
  window.corregirEstadoAEmergencia = function() {
    console.log('üö® CORRECCI√ìN DE EMERGENCIA DE ESTADO A');
    const filas = document.querySelectorAll('#tabla tbody tr');
    let corregidos = 0;
    
    filas.forEach((fila, index) => {
      const celdas = fila.querySelectorAll('td');
      if (celdas.length >= 4) {
        const estadoA = celdas[2]?.textContent?.trim() || '';
        const estadoB = celdas[3]?.textContent?.trim() || '';
        
        // CORRECCI√ìN AGRESIVA: Si ESTADO A es "No Factible", SIEMPRE corregir
        if (estadoA === 'No Factible' && estadoB && estadoB !== 'No Factible') {
          celdas[2].textContent = estadoB;
          corregidos++;
          console.log(`üö® Enlace ${index + 1} corregido de emergencia: ESTADO A "No Factible" ‚Üí "${estadoB}"`);
          
          // Forzar actualizaci√≥n visual
          celdas[2].style.backgroundColor = '#10b981';
          celdas[2].style.color = 'white';
          setTimeout(() => {
            celdas[2].style.backgroundColor = '';
            celdas[2].style.color = '';
          }, 2000);
        }
      }
    });
    
    if (corregidos > 0) {
      console.log(`üö® Correcci√≥n de emergencia completada: ${corregidos} enlaces corregidos`);
      alert(`üö® Se corrigieron ${corregidos} enlaces con ESTADO A incorrecto`);
    }
    
    return corregidos;
  };

  // EJECUTAR CORRECCI√ìN DE EMERGENCIA INMEDIATAMENTE
  setTimeout(() => {
    console.log('üö® EJECUTANDO CORRECCI√ìN DE EMERGENCIA INMEDIATA');
    window.corregirEstadoAEmergencia();
  }, 1000);

  // EJECUTAR CORRECCI√ìN DE EMERGENCIA CADA SEGUNDO
  setInterval(() => {
    window.corregirEstadoAEmergencia();
  }, 1000);

  // CORRECCI√ìN AUTOM√ÅTICA DE FACTIBILIDAD AL CARGAR
  setTimeout(() => {
    console.log('üîß Aplicando correcci√≥n autom√°tica de factibilidad...');
    window.corregirFactibilidadTodos();
  }, 3000);

  // LIMPIAR FLAGS DE PROCESAMIENTO AL CARGAR
  setTimeout(() => {
    console.log('üßπ Limpiando flags de procesamiento...');
    window.procesandoPares = false;
    window.procesamientoCompletado = false;
    if (window.procesamientoTimeout) {
      clearTimeout(window.procesamientoTimeout);
      window.procesamientoTimeout = null;
    }
    console.log('‚úÖ Flags de procesamiento limpiados');
  }, 1000);

  // LIMPIEZA AUTOM√ÅTICA DEL LOADER DESPU√âS DE 30 SEGUNDOS
  setTimeout(() => {
    const loader = document.getElementById('loader-procesando');
    if (loader && document.body.contains(loader)) {
      console.log('‚è∞ Limpieza autom√°tica del loader despu√©s de 30 segundos...');
      document.body.removeChild(loader);
      window.procesandoPares = false;
      window.procesamientoCompletado = false;
      if (window.procesamientoTimeout) {
        clearTimeout(window.procesamientoTimeout);
        window.procesamientoTimeout = null;
      }
      alert('‚è∞ Loader limpiado autom√°ticamente. El procesamiento puede haberse colgado.');
    }
  }, 30000);

  // FUNCI√ìN PARA LIMPIAR LOADER COLGADO
  window.limpiarLoaderColgado = function() {
    console.log('üßπ Limpiando loader colgado...');
    const loader = document.getElementById('loader-procesando');
    if (loader && document.body.contains(loader)) {
      document.body.removeChild(loader);
      console.log('‚úÖ Loader colgado eliminado');
    }
    
    // Limpiar todos los flags
    window.procesandoPares = false;
    window.procesamientoCompletado = false;
    if (window.procesamientoTimeout) {
      clearTimeout(window.procesamientoTimeout);
      window.procesamientoTimeout = null;
    }
    
    alert('üßπ Loader colgado limpiado. Puedes intentar procesar los pares nuevamente.');
  };

  // CORRECCI√ìN AL HACER CLIC EN LA TABLA
  setTimeout(() => {
    const tabla = document.getElementById('tabla');
    if (tabla) {
      tabla.addEventListener('click', function() {
        setTimeout(() => {
          window.corregirEstadoAEmergencia();
        }, 100);
      });
      console.log('‚úÖ Evento de clic agregado a la tabla para correcci√≥n autom√°tica');
    }
  }, 2000);

  // FUNCI√ìN PARA VERIFICAR Y CARGAR ENLACES
  window.verificarYCargarEnlaces = function() {
    console.log('üîç VERIFICANDO Y CARGANDO ENLACES');
    
    const enlacesPtP = localStorage.getItem('enlacesPtP');
    const enlacesMismoTransporte = localStorage.getItem('enlacesMismoTransporte');
    
    console.log('üìÅ enlacesPtP:', enlacesPtP ? 'S√ç' : 'NO');
    console.log('üìÅ enlacesMismoTransporte:', enlacesMismoTransporte ? 'S√ç' : 'NO');
    
    if (enlacesPtP) {
      const enlaces = JSON.parse(enlacesPtP);
      console.log(`üìä enlacesPtP: ${enlaces.length} enlaces guardados`);
      console.log('üìã Primer enlace:', enlaces[0]);
      
      // Forzar carga de enlaces
      console.log('üîÑ Forzando carga de enlaces...');
      cargarEnlacesDeStorageModo("normal");
      
      // Actualizar contadores
      if (typeof actualizarContadorEnlaces === 'function') {
        actualizarContadorEnlaces();
      }
      
      // Verificar tabla
      const tabla = document.querySelector('#tabla tbody');
      if (tabla) {
        const filas = tabla.querySelectorAll('tr');
        console.log(`üìã Tabla actual: ${filas.length} filas`);
      }
    }
    
    if (enlacesMismoTransporte) {
      const enlaces = JSON.parse(enlacesMismoTransporte);
      console.log(`üìä enlacesMismoTransporte: ${enlaces.length} enlaces guardados`);
    }
    
    // Verificar variable permitirMismoTransporte
    console.log('‚öôÔ∏è permitirMismoTransporte:', window.permitirMismoTransporte);
    
    alert('üîç Verificaci√≥n completada. Revisa la consola para detalles.');
  };

  // FUNCI√ìN PARA VERIFICAR ALMACENAMIENTO
  window.verificarAlmacenamiento = function() {
    console.log('üîç VERIFICANDO ALMACENAMIENTO DE ENLACES');
    
    const enlacesPtP = localStorage.getItem('enlacesPtP');
    const enlacesMismoTransporte = localStorage.getItem('enlacesMismoTransporte');
    
    console.log('üìÅ enlacesPtP:', enlacesPtP ? 'S√ç' : 'NO');
    console.log('üìÅ enlacesMismoTransporte:', enlacesMismoTransporte ? 'S√ç' : 'NO');
    
    if (enlacesPtP) {
      const enlaces = JSON.parse(enlacesPtP);
      console.log(`üìä enlacesPtP: ${enlaces.length} enlaces guardados`);
      console.log('üìã Primer enlace:', enlaces[0]);
    }
    
    if (enlacesMismoTransporte) {
      const enlaces = JSON.parse(enlacesMismoTransporte);
      console.log(`üìä enlacesMismoTransporte: ${enlaces.length} enlaces guardados`);
      console.log('üìã Primer enlace:', enlaces[0]);
    }
    
    // Verificar variable permitirMismoTransporte
    console.log('‚öôÔ∏è permitirMismoTransporte:', window.permitirMismoTransporte);
    
    alert('üîç Verificaci√≥n completada. Revisa la consola para detalles.');
  };

  // FUNCI√ìN PARA FORZAR ALMACENAMIENTO MANUAL
  window.forzarAlmacenamiento = function() {
    console.log('üîß FORZANDO ALMACENAMIENTO MANUAL');
    
    // Verificar si hay datos en las variables globales
    if (typeof filasDiferenteTransporte !== 'undefined' && filasDiferenteTransporte.length > 0) {
      localStorage.setItem('enlacesPtP', JSON.stringify(filasDiferenteTransporte));
      console.log(`üíæ Forzado: ${filasDiferenteTransporte.length} enlaces guardados en enlacesPtP`);
    }
    
    if (typeof filasMismoTransporte !== 'undefined' && filasMismoTransporte.length > 0) {
      localStorage.setItem('enlacesMismoTransporte', JSON.stringify(filasMismoTransporte));
      console.log(`üíæ Forzado: ${filasMismoTransporte.length} enlaces guardados en enlacesMismoTransporte`);
    }
    
    // Verificar si hay datos en la tabla
    const filas = document.querySelectorAll('#tabla tbody tr');
    if (filas.length > 0) {
      const enlacesTabla = [];
      filas.forEach(fila => {
        const celdas = fila.querySelectorAll('td');
        const enlace = [];
        for (let i = 1; i < celdas.length; i++) {
          enlace.push(celdas[i].textContent);
        }
        enlacesTabla.push(enlace);
      });
      
      localStorage.setItem('enlacesPtP', JSON.stringify(enlacesTabla));
      console.log(`üíæ Forzado desde tabla: ${enlacesTabla.length} enlaces guardados en enlacesPtP`);
    }
    
    alert('üîß Almacenamiento forzado completado. Revisa la consola para detalles.');
  };

  // FUNCI√ìN PARA DIAGNOSTICAR Y REPARAR PROCESAMIENTO DE PARES
  window.diagnosticarProcesamientoPares = function() {
    console.log('üîç DIAGN√ìSTICO DE PROCESAMIENTO DE PARES');
    
    // Verificar datos
    console.log('üìä Datos Excel:', dataExcel.length, 'filas');
    console.log('üìä Datos Pares:', dataPares.length, 'filas');
    
    // Verificar elementos del DOM
    const btnProcesar = document.querySelector('button[onclick="procesarPares()"]');
    console.log('üîò Bot√≥n Procesar Pares:', btnProcesar ? 'Encontrado' : 'NO ENCONTRADO');
    
    // Verificar funci√≥n
    console.log('‚öôÔ∏è Funci√≥n procesarPares:', typeof procesarPares);
    
    // Verificar flags
    console.log('üö© Flag procesandoPares:', window.procesandoPares);
    console.log('üö© Flag procesamientoCompletado:', window.procesamientoCompletado);
    
    // Limpiar flags si est√°n bloqueados
    if (window.procesandoPares) {
      console.log('üîß Limpiando flag procesandoPares bloqueado...');
      window.procesandoPares = false;
    }
    
    if (window.procesamientoCompletado) {
      console.log('üîß Limpiando flag procesamientoCompletado...');
      window.procesamientoCompletado = false;
    }
    
    // Verificar archivos cargados
    const archivoExcel = localStorage.getItem('archivoExcelInfo');
    const archivoPares = localStorage.getItem('archivoParesInfo');
    
    console.log('üìÅ Archivo Excel cargado:', archivoExcel ? 'S√ç' : 'NO');
    console.log('üìÅ Archivo Pares cargado:', archivoPares ? 'S√ç' : 'NO');
    
    if (archivoExcel) {
      console.log('üìÑ Info Excel:', JSON.parse(archivoExcel));
    }
    if (archivoPares) {
      console.log('üìÑ Info Pares:', JSON.parse(archivoPares));
    }
    
    alert('üîç Diagn√≥stico completado. Revisa la consola para detalles.');
  };

  // FUNCI√ìN PARA CORREGIR FACTIBILIDAD DE TODOS LOS ENLACES
  window.corregirFactibilidadTodos = function() {
    console.log('üîß Corrigiendo factibilidad de todos los enlaces...');
    
    const filas = document.querySelectorAll('#tabla tbody tr');
    let corregidos = 0;
    
    filas.forEach((fila, index) => {
      const celdas = fila.querySelectorAll('td');
      if (celdas.length >= 15) {
        const estadoA = celdas[2]?.textContent?.trim() || '';
        const estadoB = celdas[3]?.textContent?.trim() || '';
        const factibilidad = celdas[12]?.textContent?.trim() || '';
        
        // Lista de estados mexicanos
        const estadosMexicanos = [
          'baja california', 'sonora', 'chihuahua', 'coahuila', 'nuevo le√≥n', 'tamaulipas',
          'sinaloa', 'durango', 'zacatecas', 'san luis potos√≠', 'jalisco', 'aguascalientes',
          'guanajuato', 'quer√©taro', 'hidalgo', 'puebla', 'veracruz', 'tabasco', 'campeche',
          'yucat√°n', 'quintana roo', 'chiapas', 'oaxaca', 'guerrero', 'morelos', 'm√©xico',
          'michoac√°n', 'colima', 'nayarit', 'tlaxcala'
        ];
        
        // Verificar si alguno de los estados es mexicano
        const estadoAMexicano = estadosMexicanos.some(estado => 
          estadoA.toLowerCase().includes(estado)
        );
        const estadoBMexicano = estadosMexicanos.some(estado => 
          estadoB.toLowerCase().includes(estado)
        );
        
        // Si hay estado mexicano y est√° marcado como no factible, corregir
        if ((estadoAMexicano || estadoBMexicano) && 
            (factibilidad.toLowerCase().includes('no factible') || 
             factibilidad.toLowerCase().includes('x no factible'))) {
          
          // Corregir ESTADO A si es "No Factible"
          if (estadoA === 'No Factible' && estadoB && estadoB !== 'No Factible') {
            celdas[2].textContent = estadoB;
          }
          
          // Corregir factibilidad
          celdas[12].innerHTML = '<span style="color: #10b981; font-weight: bold;">‚úì Factible</span>';
          corregidos++;
          
          console.log(`‚úÖ Enlace ${index + 1} corregido: ESTADO A="${celdas[2].textContent}", FACTIBLE="‚úì Factible"`);
        }
      }
    });
    
    if (corregidos > 0) {
      console.log(`‚úÖ Factibilidad corregida: ${corregidos} enlaces`);
      alert(`‚úÖ Se corrigieron ${corregidos} enlaces a factibles`);
      
      // Actualizar contadores
      if (typeof actualizarContadorEnlaces === 'function') {
        actualizarContadorEnlaces();
      }
    } else {
      console.log('‚ÑπÔ∏è No se encontraron enlaces que necesiten correcci√≥n');
    }
  };

  // FUNCI√ìN PARA REPARAR LA BASE DE DATOS INDEXEDDB
  window.repararIndexedDB = function() {
    console.log('üîß Reparando base de datos IndexedDB...');
    
    // Eliminar la base de datos existente
    const deleteRequest = indexedDB.deleteDatabase('ArchivosExcelDB');
    
    deleteRequest.onsuccess = function() {
      console.log('‚úÖ Base de datos eliminada, recreando...');
      
      // Recrear la base de datos con la estructura correcta
      const request = indexedDB.open('ArchivosExcelDB', 3);
      
      request.onupgradeneeded = function(event) {
        const db = event.target.result;
        
        // Crear store de archivos
        if (!db.objectStoreNames.contains('archivos')) {
          db.createObjectStore('archivos', { keyPath: 'nombre' });
          console.log('‚úÖ Store "archivos" creado');
        }
        
        // Crear store de pares
        if (!db.objectStoreNames.contains('pares')) {
          db.createObjectStore('pares', { keyPath: 'nombre' });
          console.log('‚úÖ Store "pares" creado');
        }
      };
      
      request.onsuccess = function() {
        console.log('‚úÖ Base de datos reparada exitosamente');
        alert('‚úÖ Base de datos IndexedDB reparada. Ahora puedes procesar los pares.');
      };
      
      request.onerror = function() {
        console.error('‚ùå Error al recrear la base de datos:', request.error);
        alert('‚ùå Error al reparar la base de datos');
      };
    };
    
    deleteRequest.onerror = function() {
      console.error('‚ùå Error al eliminar la base de datos:', deleteRequest.error);
      alert('‚ùå Error al eliminar la base de datos');
    };
  };
});

// Tambi√©n ejecutar cuando se cambia a la pesta√±a RESUMEN
document.addEventListener('click', function(e) {
  if (e.target && e.target.textContent === 'RESUMEN') {
    console.log('üìã Cambio a pesta√±a RESUMEN, ejecutando correcci√≥n...');
    setTimeout(corregirAutomaticamente, 500);
  }
});

// Correcci√≥n autom√°tica cada 5 segundos en la pesta√±a RESUMEN
setInterval(() => {
  const pesta√±aActiva = document.querySelector('.tab-pane.active');
  if (pesta√±aActiva && pesta√±aActiva.id === 'resumen') {
    const filas = document.querySelectorAll('#tabla tbody tr');
    let hayNoFactible = false;
    
    filas.forEach(fila => {
      const celdas = fila.querySelectorAll('td');
      if (celdas[2]?.textContent?.trim() === 'No Factible') {
        hayNoFactible = true;
      }
    });
    
    if (hayNoFactible) {
      console.log('üîÑ Detectado "No Factible" en ESTADO A, corrigiendo autom√°ticamente...');
      corregirEmergencia();
    }
  }
}, 5000);
</script>
</body>
</html>